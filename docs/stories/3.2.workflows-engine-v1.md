# Story 3.2: Motor de reglas v1 (workflows por org/proyecto)

## Status: Draft

## Story
**As an** org admin (and project admin),
**I want** to define workflow rules that react to task/card changes,
**so that** the system can automatically create follow-up tasks from templates.

## Acceptance Criteria
1. **Rules exist**: A `Workflow` (container) and `Rule` exist; rules can be scoped to org or to a project.
2. **Triggers supported**: A rule can trigger on:
   - Task state changes (available/claimed/completed)
   - Card (ficha) state changes (pendiente/en_curso/cerrada)
   - Task field changes: type/capability/priority
3. **Action supported**: The only action is: create one or more tasks from a template into the pool (`available`).
4. **Idempotency**: The same rule is applied at most once per origin resource (task/card) to prevent loops.
5. **User-triggered only**: Events not caused by a user do not trigger rules.
6. **Authz**: Org admins can manage org-scoped workflows; project admins can manage project-scoped workflows.
7. **Instrumentation DoD**: The system records, per rule:
   - `rule_evaluated`, `rule_applied`, `rule_suppressed` (with reason)
   - Counters and a minimal admin view to inspect them.

## Tasks / Subtasks
- [ ] Define data model:
  - [ ] Workflow (org_id, project_id?, name, description, active)
  - [ ] Rule (workflow_id, resource_type, trigger_spec, active, goal)
  - [ ] Template/Action (task type, name template, description template)
- [ ] Define event schema for engine inputs (task/card changes) (AC: 2, 5)
- [ ] Implement evaluation pipeline (AC: 2, 3)
  - [ ] Determine execution model (sync in request vs async worker queue) and document
- [ ] Implement idempotency keying (rule_id + origin_type + origin_id) (AC: 4)
- [ ] Implement instrumentation (AC: 7)
  - [ ] Persist events/counters and expose admin query endpoints
- [ ] Tests:
  - [ ] Determinism: same event yields same outcomes
  - [ ] Idempotency and suppression reasons
  - [ ] “User-triggered only” enforcement

## Dev Notes
⚠️ **Planning stub / example**: This story is not fully refined.

- Product concept described in the historical notes you provided: rules trigger on state changes and create tasks from templates with variable substitution.
- This repo currently has tasks and planned cards (Story 3.1). Sprint 3 is where the first cut should appear, with metrics from day 1.

## Testing
- Server: `make test`
- Client: `apps/client: gleam test`

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-14 | 0.1 | Planning stub created | po |

## Dev Agent Record

## QA Results
