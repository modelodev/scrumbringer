# Story 3.2: Motor de reglas v1 (workflows por org/proyecto)

## Status: Complete

## Story
**As an** org admin (or project admin),
**I want** to define workflow rules that react to task/card state changes,
**so that** the system can automatically create follow-up tasks from templates, reflecting the organization's processes.

## Acceptance Criteria

1. **Workflow entity**: A `Workflow` exists with fields `{ id, org_id, project_id?, name (unique per scope), description, active, created_by, created_at }`.
2. **Rule entity**: A `Rule` exists with fields `{ id, workflow_id, name, goal, resource_type, task_type_id?, to_state, active, created_at }`.
3. **TaskTemplate entity**: A `TaskTemplate` exists with fields `{ id, org_id, project_id?, name, description, type_id, priority, created_by, created_at }`. Templates are reusable across rules (N:M).
4. **Triggers supported**: Rules trigger on any state change of Task or Card, including creation:
   - Task: `nullâ†’available` (created), `availableâ†’claimed`, `claimedâ†’completed`, `claimedâ†’available` (released)
   - Card: `nullâ†’pendiente` (created), `pendienteâ†’en_curso`, `en_cursoâ†’cerrada`, state changes from task updates
5. **Conditions**: Rules can filter by `task_type_id` when `resource_type = Task`.
6. **Actions**: When a rule fires, it creates one or more tasks from associated templates with variable substitution.
7. **Variables supported**: `{{father}}`, `{{from_state}}`, `{{to_state}}`, `{{project}}`, `{{user}}` in template name/description.
8. **Idempotency**: A rule fires at most once per origin resource (task/card). Tracked via `rule_executions` table.
9. **User-triggered only**: State changes not caused by a user (e.g., stale session cleanup) do not trigger rules.
10. **Activation cascade**: Activating/deactivating a workflow activates/deactivates all its rules.
11. **Authz**: Org admins manage org-scoped workflows/templates; project admins manage project-scoped ones.
12. **Admin UI minimal**: CRUD for Workflows, Rules, and TaskTemplates in Admin section.
13. **Logging**: Rule evaluations are logged with outcome (`evaluated`, `applied`, `suppressed`) and reason for metrics in Story 3.3.

## Tasks / Subtasks

- [x] Task 1: DB schema for workflows, rules, templates (AC: 1, 2, 3, 8)
  - [x] Create migration `db/migrations/20260118XXXXXX_create_workflows.sql`
    - [x] Table `workflows`
    - [x] Table `rules`
    - [x] Table `task_templates`
    - [x] Join table `rule_templates` (N:M)
    - [x] Table `rule_executions` (idempotency + logging)
  - [x] Run `make squirrel` to generate types

- [x] Task 2: Server - TaskTemplate CRUD (AC: 3, 11)
  - [x] Create `apps/server/src/scrumbringer_server/http/task_templates.gleam`
  - [x] Create `apps/server/src/scrumbringer_server/services/task_templates_db.gleam`
  - [x] Endpoints:
    - [x] `GET /api/v1/task-templates` (org-scoped) / `GET /api/v1/projects/:id/task-templates` (project-scoped)
    - [x] `POST /api/v1/task-templates` / `POST /api/v1/projects/:id/task-templates`
    - [x] `PATCH /api/v1/task-templates/:id`
    - [x] `DELETE /api/v1/task-templates/:id`

- [x] Task 3: Server - Workflow CRUD (AC: 1, 10, 11)
  - [x] Create `apps/server/src/scrumbringer_server/http/workflows.gleam`
  - [x] Create `apps/server/src/scrumbringer_server/services/workflows_db.gleam`
  - [x] Endpoints:
    - [x] `GET /api/v1/workflows` / `GET /api/v1/projects/:id/workflows`
    - [x] `POST /api/v1/workflows` / `POST /api/v1/projects/:id/workflows`
    - [x] `PATCH /api/v1/workflows/:id` (including activate/deactivate)
    - [x] `DELETE /api/v1/workflows/:id`
  - [x] Implement activation cascade to rules

- [x] Task 4: Server - Rule CRUD (AC: 2, 5, 6, 11)
  - [x] Create `apps/server/src/scrumbringer_server/http/rules.gleam`
  - [x] Create `apps/server/src/scrumbringer_server/services/rules_db.gleam`
  - [x] Endpoints:
    - [x] `GET /api/v1/workflows/:workflow_id/rules`
    - [x] `POST /api/v1/workflows/:workflow_id/rules`
    - [x] `PATCH /api/v1/rules/:id`
    - [x] `DELETE /api/v1/rules/:id`
    - [x] `POST /api/v1/rules/:id/templates` (attach template)
    - [x] `DELETE /api/v1/rules/:id/templates/:template_id` (detach template)

- [x] Task 5: Server - Rules engine core (AC: 4, 6, 7, 8, 9, 13)
  - [x] Create `apps/server/src/scrumbringer_server/services/rules_engine.gleam`
  - [x] Implement `evaluate_rules(event: StateChangeEvent) -> List(RuleResult)`
  - [x] Implement `execute_rule(rule, event) -> Result(List(Task), Error)`
  - [x] Implement variable substitution in templates
  - [x] Implement idempotency check via `rule_executions`
  - [x] Implement logging of evaluation outcomes

- [x] Task 6: Server - Integration with task/card state changes (AC: 4, 9)
  - [x] Modify `apps/server/src/scrumbringer_server/services/workflows/handlers.gleam`:
    - [x] After claim/release/complete/create, call `rules_engine.evaluate_rules`
  - [x] After task changes that affect card state, evaluate rules
  - [x] Ensure `user_triggered` flag is passed (skip if false)

- [x] Task 7: Client - Admin UI for workflows (AC: 12)
  - [x] Create `apps/client/src/scrumbringer_client/features/admin/workflows.gleam`
  - [x] Integrated rules and task templates in workflows.gleam (simpler architecture)
  - [x] Add tabs/sections in Admin UI (Workflows and TaskTemplates sections)
  - [x] Implement:
    - [x] Workflow list with active toggle
    - [x] Rule list per workflow
    - [x] TaskTemplate list with CRUD
  - [x] Add i18n keys

- [x] Task 8: Tests (AC: all)
  - [x] Server tests: `apps/server/test/rules_engine_test.gleam`
  - [x] Client tests: `apps/client/test/workflows_decode_test.gleam`

## Dev Notes

### Source Tree (relevante para esta story)

```
apps/
â”œâ”€â”€ client/
â”‚   â”œâ”€â”€ src/scrumbringer_client/
â”‚   â”‚   â”œâ”€â”€ api.gleam                          # MODIFY: workflow/rule/template endpoints
â”‚   â”‚   â”œâ”€â”€ features/admin/
â”‚   â”‚   â”‚   â”œâ”€â”€ admin.gleam                    # MODIFY: add Workflows tab
â”‚   â”‚   â”‚   â”œâ”€â”€ workflows.gleam                # NEW: Workflow CRUD UI
â”‚   â”‚   â”‚   â”œâ”€â”€ rules.gleam                    # NEW: Rule CRUD UI
â”‚   â”‚   â”‚   â””â”€â”€ task_templates.gleam           # NEW: Template CRUD UI
â”‚   â”‚   â””â”€â”€ i18n/
â”‚   â”‚       â”œâ”€â”€ text.gleam                     # MODIFY: add Workflow* keys
â”‚   â”‚       â”œâ”€â”€ es.gleam                       # MODIFY
â”‚   â”‚       â””â”€â”€ en.gleam                       # MODIFY
â”‚   â””â”€â”€ test/
â”‚       â””â”€â”€ workflows_decode_test.gleam        # NEW
â”œâ”€â”€ server/
â”‚   â”œâ”€â”€ src/scrumbringer_server/
â”‚   â”‚   â”œâ”€â”€ scrumbringer_server.gleam          # MODIFY: register routes
â”‚   â”‚   â”œâ”€â”€ http/
â”‚   â”‚   â”‚   â”œâ”€â”€ workflows.gleam                # NEW
â”‚   â”‚   â”‚   â”œâ”€â”€ rules.gleam                    # NEW
â”‚   â”‚   â”‚   â”œâ”€â”€ task_templates.gleam           # NEW
â”‚   â”‚   â”‚   â”œâ”€â”€ tasks.gleam                    # MODIFY: call rules engine
â”‚   â”‚   â”‚   â””â”€â”€ cards.gleam                    # MODIFY: call rules engine
â”‚   â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”‚   â”œâ”€â”€ workflows_db.gleam             # NEW
â”‚   â”‚   â”‚   â”œâ”€â”€ rules_db.gleam                 # NEW
â”‚   â”‚   â”‚   â”œâ”€â”€ task_templates_db.gleam        # NEW
â”‚   â”‚   â”‚   â””â”€â”€ rules_engine.gleam             # NEW: core engine logic
â”‚   â”‚   â””â”€â”€ sql/
â”‚   â”‚       â”œâ”€â”€ workflows_*.sql                # NEW
â”‚   â”‚       â”œâ”€â”€ rules_*.sql                    # NEW
â”‚   â”‚       â”œâ”€â”€ task_templates_*.sql           # NEW
â”‚   â”‚       â””â”€â”€ rule_executions_*.sql          # NEW
â”‚   â””â”€â”€ test/
â”‚       â””â”€â”€ rules_engine_test.gleam            # NEW
â””â”€â”€ db/
    â””â”€â”€ migrations/
        â””â”€â”€ 20260118XXXXXX_create_workflows.sql # NEW
```

### Data Model

```sql
-- Workflow: container of rules
CREATE TABLE workflows (
    id BIGSERIAL PRIMARY KEY,
    org_id BIGINT NOT NULL REFERENCES organizations(id),
    project_id BIGINT REFERENCES projects(id),  -- NULL = org-scoped
    name TEXT NOT NULL,
    description TEXT,
    active BOOLEAN NOT NULL DEFAULT false,
    created_by BIGINT NOT NULL REFERENCES users(id),
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    UNIQUE(org_id, project_id, name)  -- name unique per scope
);

CREATE INDEX idx_workflows_org ON workflows(org_id);
CREATE INDEX idx_workflows_project ON workflows(project_id);

-- Rule: trigger definition
CREATE TABLE rules (
    id BIGSERIAL PRIMARY KEY,
    workflow_id BIGINT NOT NULL REFERENCES workflows(id) ON DELETE CASCADE,
    name TEXT NOT NULL,
    goal TEXT,  -- objectives for future dashboard
    resource_type TEXT NOT NULL CHECK (resource_type IN ('task', 'card')),
    task_type_id BIGINT REFERENCES task_types(id),  -- filter when resource_type = 'task'
    to_state TEXT NOT NULL,  -- target state that triggers the rule
    active BOOLEAN NOT NULL DEFAULT true,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_rules_workflow ON rules(workflow_id);
CREATE INDEX idx_rules_active ON rules(active) WHERE active = true;

-- TaskTemplate: reusable task blueprint
CREATE TABLE task_templates (
    id BIGSERIAL PRIMARY KEY,
    org_id BIGINT NOT NULL REFERENCES organizations(id),
    project_id BIGINT REFERENCES projects(id),  -- NULL = org-scoped
    name TEXT NOT NULL,  -- supports variables
    description TEXT,     -- supports variables
    type_id BIGINT NOT NULL REFERENCES task_types(id),
    priority INT NOT NULL DEFAULT 3 CHECK (priority BETWEEN 1 AND 5),
    created_by BIGINT NOT NULL REFERENCES users(id),
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_task_templates_org ON task_templates(org_id);
CREATE INDEX idx_task_templates_project ON task_templates(project_id);

-- N:M join table: Rule <-> TaskTemplate
CREATE TABLE rule_templates (
    rule_id BIGINT NOT NULL REFERENCES rules(id) ON DELETE CASCADE,
    template_id BIGINT NOT NULL REFERENCES task_templates(id) ON DELETE CASCADE,
    execution_order INT NOT NULL DEFAULT 0,
    PRIMARY KEY (rule_id, template_id)
);

-- Rule executions: idempotency + logging
CREATE TABLE rule_executions (
    id BIGSERIAL PRIMARY KEY,
    rule_id BIGINT NOT NULL REFERENCES rules(id) ON DELETE CASCADE,
    origin_type TEXT NOT NULL,  -- 'task' | 'card'
    origin_id BIGINT NOT NULL,
    outcome TEXT NOT NULL,  -- 'applied' | 'suppressed'
    suppression_reason TEXT,  -- 'idempotent' | 'not_matching' | 'not_user_triggered' | 'inactive'
    user_id BIGINT REFERENCES users(id),  -- who triggered
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    UNIQUE(rule_id, origin_type, origin_id)  -- idempotency key
);

CREATE INDEX idx_rule_executions_rule ON rule_executions(rule_id);
CREATE INDEX idx_rule_executions_origin ON rule_executions(origin_type, origin_id);
```

**Relaciones:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  workflows   â”‚â”€â”€â”€â”€â”€â”€â–ºâ”‚    rules     â”‚â—„â”€â”€â”€â”€â”€â–ºâ”‚rule_templatesâ”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  1:N  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  N:M  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ id           â”‚       â”‚ id           â”‚       â”‚ rule_id      â”‚
â”‚ org_id       â”‚       â”‚ workflow_id  â”‚       â”‚ template_id  â”‚
â”‚ project_id?  â”‚       â”‚ name         â”‚       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ name         â”‚       â”‚ goal         â”‚              â”‚
â”‚ active       â”‚       â”‚ resource_typeâ”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ task_type_id?â”‚              â–¼
                       â”‚ to_state     â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚ active       â”‚       â”‚task_templatesâ”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
                              â”‚               â”‚ id           â”‚
                              â–¼               â”‚ name         â”‚
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚ description  â”‚
                       â”‚rule_executions       â”‚ type_id      â”‚
                       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚       â”‚ priority     â”‚
                       â”‚ rule_id      â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ origin_type  â”‚
                       â”‚ origin_id    â”‚
                       â”‚ outcome      â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Rules Engine Logic

**StateChangeEvent:**

```gleam
pub type StateChangeEvent {
  StateChangeEvent(
    resource_type: ResourceType,  // Task | Card
    resource_id: Int,
    from_state: Option(String),   // None if created
    to_state: String,
    project_id: Int,
    user_id: Int,
    user_triggered: Bool,
    task_type_id: Option(Int),    // Only for tasks
  )
}

pub type ResourceType {
  Task
  Card
}
```

**Evaluation flow:**

```gleam
pub fn evaluate_rules(db, event: StateChangeEvent) -> List(RuleResult) {
  // 1. Skip if not user-triggered
  case event.user_triggered {
    False -> []
    True -> {
      // 2. Find matching active rules
      let rules = find_matching_rules(db, event)

      // 3. Evaluate each rule
      list.map(rules, fn(rule) {
        evaluate_single_rule(db, rule, event)
      })
    }
  }
}

fn evaluate_single_rule(db, rule: Rule, event: StateChangeEvent) -> RuleResult {
  // Check idempotency
  case already_executed(db, rule.id, event.resource_type, event.resource_id) {
    True -> RuleResult(rule.id, Suppressed("idempotent"))
    False -> {
      // Execute: create tasks from templates
      let templates = get_rule_templates(db, rule.id)
      let tasks = list.map(templates, fn(t) {
        create_task_from_template(db, t, event)
      })

      // Log execution
      log_execution(db, rule.id, event, Applied)

      RuleResult(rule.id, Applied(tasks))
    }
  }
}
```

**Variable substitution:**

```gleam
pub fn substitute_variables(text: String, event: StateChangeEvent) -> String {
  text
  |> string.replace("{{father}}", format_father_link(event))
  |> string.replace("{{from_state}}", event.from_state |> option.unwrap("(created)"))
  |> string.replace("{{to_state}}", event.to_state)
  |> string.replace("{{project}}", get_project_name(event.project_id))
  |> string.replace("{{user}}", get_user_name(event.user_id))
}

fn format_father_link(event: StateChangeEvent) -> String {
  case event.resource_type {
    Task -> "[Task #" <> int.to_string(event.resource_id) <> "](/tasks/" <> int.to_string(event.resource_id) <> ")"
    Card -> "[Card #" <> int.to_string(event.resource_id) <> "](/cards/" <> int.to_string(event.resource_id) <> ")"
  }
}
```

### API Contract

**Endpoints:**

| Method | Path | Auth | Description |
|--------|------|------|-------------|
| GET | `/api/v1/workflows` | Org Admin | List org-scoped workflows |
| GET | `/api/v1/projects/:id/workflows` | Project Admin | List project-scoped workflows |
| POST | `/api/v1/workflows` | Org Admin | Create org-scoped workflow |
| POST | `/api/v1/projects/:id/workflows` | Project Admin | Create project-scoped workflow |
| PATCH | `/api/v1/workflows/:id` | Admin | Edit workflow (including active toggle) |
| DELETE | `/api/v1/workflows/:id` | Admin | Delete workflow |
| GET | `/api/v1/workflows/:id/rules` | Admin | List rules in workflow |
| POST | `/api/v1/workflows/:id/rules` | Admin | Create rule |
| PATCH | `/api/v1/rules/:id` | Admin | Edit rule |
| DELETE | `/api/v1/rules/:id` | Admin | Delete rule |
| POST | `/api/v1/rules/:id/templates` | Admin | Attach template to rule |
| DELETE | `/api/v1/rules/:id/templates/:tid` | Admin | Detach template |
| GET | `/api/v1/task-templates` | Org Admin | List org-scoped templates |
| GET | `/api/v1/projects/:id/task-templates` | Project Admin | List project-scoped templates |
| POST | `/api/v1/task-templates` | Org Admin | Create org-scoped template |
| POST | `/api/v1/projects/:id/task-templates` | Project Admin | Create project-scoped template |
| PATCH | `/api/v1/task-templates/:id` | Admin | Edit template |
| DELETE | `/api/v1/task-templates/:id` | Admin | Delete template |

**Workflow Resource:**

```json
{
  "id": 1,
  "org_id": 1,
  "project_id": null,
  "name": "QA Automation",
  "description": "Auto-create QA tasks when features complete",
  "active": true,
  "rule_count": 2,
  "created_by": 42,
  "created_at": "2026-01-18T10:00:00Z"
}
```

**Rule Resource:**

```json
{
  "id": 1,
  "workflow_id": 1,
  "name": "Feature â†’ QA Review",
  "goal": "Ensure all features get QA review before release",
  "resource_type": "task",
  "task_type_id": 5,
  "to_state": "completed",
  "active": true,
  "templates": [
    { "id": 1, "name": "QA Review: {{father}}", "type_id": 3 }
  ],
  "created_at": "2026-01-18T10:00:00Z"
}
```

**TaskTemplate Resource:**

```json
{
  "id": 1,
  "org_id": 1,
  "project_id": null,
  "name": "QA Review: {{father}}",
  "description": "Review task {{father}} completed by {{user}}. Previous state: {{from_state}}.",
  "type_id": 3,
  "priority": 3,
  "created_by": 42,
  "created_at": "2026-01-18T10:00:00Z"
}
```

**States for triggers:**

| Resource | Valid `to_state` values |
|----------|------------------------|
| Task | `available`, `claimed`, `completed` |
| Card | `pendiente`, `en_curso`, `cerrada` |

### Activation Cascade

```gleam
pub fn set_workflow_active(db, workflow_id: Int, active: Bool) -> Result {
  // Update workflow
  update_workflow_active(db, workflow_id, active)

  // Cascade to all rules
  update_rules_active_by_workflow(db, workflow_id, active)
}
```

### Admin UI

**Workflows Tab:**

| Name | Scope | Rules | Active | Actions |
|------|-------|-------|--------|---------|
| QA Automation | Org | 2 | [x] | Edit / Delete |
| Sprint Kickoff | Project: Core | 1 | [ ] | Edit / Delete |

**Rules (within workflow):**

| Name | Trigger | Templates | Active | Actions |
|------|---------|-----------|--------|---------|
| Feature â†’ QA | Task(Feature) â†’ completed | 1 | [x] | Edit / Delete |
| Card Done â†’ Release | Card â†’ cerrada | 2 | [x] | Edit / Delete |

**TaskTemplates Tab:**

| Name | Type | Priority | Scope | Actions |
|------|------|----------|-------|---------|
| QA Review: {{father}} | QA | 3 | Org | Edit / Delete |
| Release Checklist | Release | 4 | Project: Core | Edit / Delete |

### i18n Keys (nuevas)

```gleam
pub type Text {
  // ... existing
  WorkflowsTab
  WorkflowName
  WorkflowDescription
  WorkflowActive
  WorkflowCreate
  WorkflowEdit
  WorkflowDelete
  RuleName
  RuleGoal
  RuleResourceType
  RuleToState
  RuleActive
  RuleCreate
  RuleEdit
  RuleDelete
  RuleAttachTemplate
  TaskTemplateName
  TaskTemplateDescription
  TaskTemplateType
  TaskTemplatePriority
  TaskTemplateCreate
  TaskTemplateEdit
  TaskTemplateDelete
  TaskTemplateVariablesHelp
}
```

### Security Considerations

| Concern | Mitigation |
|---------|------------|
| Authz bypass | Validate org/project admin role per endpoint |
| Cross-scope access | Validate workflow/rule/template belongs to user's org/project |
| Infinite loops | Idempotency key prevents same rule firing twice on same origin |
| DoS via rules | Sync execution; future: rate limit rules per workflow |
| Variable injection | Variables are text substitution only, no code execution |
| CSRF | Double-submit token on all mutations |

### Testing

**Server tests (`apps/server/test/workflows_test.gleam`):**

*Workflow CRUD:*

| Test | Description | AC |
|------|-------------|-----|
| `list_workflows_empty_test` | Org with no workflows â†’ `[]` | AC1 |
| `list_workflows_org_scoped_test` | List org-scoped workflows | AC1,11 |
| `list_workflows_project_scoped_test` | List project-scoped workflows | AC1,11 |
| `create_workflow_org_admin_test` | Org admin creates workflow â†’ 200 | AC1,11 |
| `create_workflow_project_admin_test` | Project admin creates project-scoped workflow â†’ 200 | AC1,11 |
| `create_workflow_member_denied_test` | Member attempts to create â†’ 403 | AC11 |
| `create_workflow_duplicate_name_test` | Duplicate name in same scope â†’ 409 | AC1 |
| `edit_workflow_test` | PATCH name/description â†’ 200 | AC1 |
| `delete_workflow_test` | Delete workflow â†’ 204 | AC1 |
| `delete_workflow_cascades_rules_test` | Delete workflow cascades to rules | AC1 |
| `cross_org_access_denied_test` | Access workflow from another org â†’ 403 | AC11 |

*Rule CRUD:*

| Test | Description | AC |
|------|-------------|-----|
| `list_rules_test` | List rules in workflow | AC2 |
| `create_rule_test` | Create rule with valid to_state â†’ 200 | AC2 |
| `create_rule_invalid_to_state_test` | Invalid to_state value â†’ 422 | AC2 |
| `create_rule_invalid_resource_type_test` | Invalid resource_type â†’ 422 | AC2 |
| `edit_rule_test` | PATCH rule fields â†’ 200 | AC2 |
| `delete_rule_test` | Delete rule â†’ 204 | AC2 |
| `attach_template_test` | POST /rules/:id/templates â†’ 200 | AC3,6 |
| `attach_template_already_attached_test` | Attach same template twice â†’ 409 | AC3 |
| `detach_template_test` | DELETE /rules/:id/templates/:tid â†’ 204 | AC3 |

*TaskTemplate CRUD:*

| Test | Description | AC |
|------|-------------|-----|
| `list_templates_org_scoped_test` | List org-scoped templates | AC3,11 |
| `list_templates_project_scoped_test` | List project-scoped templates | AC3,11 |
| `create_template_test` | Create template â†’ 200 | AC3 |
| `create_template_with_variables_test` | Template with {{father}} variables â†’ 200 | AC3,7 |
| `edit_template_test` | PATCH template â†’ 200 | AC3 |
| `delete_template_test` | Delete template â†’ 204 | AC3 |
| `delete_template_detaches_from_rules_test` | Delete template removes from rule_templates | AC3 |

**Server tests (`apps/server/test/rules_engine_test.gleam`):**

*Engine Core:*

| Test | Description | AC |
|------|-------------|-----|
| `evaluate_no_matching_rules_test` | Event with no matching rules â†’ [] | AC4 |
| `evaluate_matching_rule_test` | Event with matching rule â†’ tasks created | AC4,6 |
| `evaluate_inactive_rule_test` | Inactive rule â†’ suppressed (reason: inactive) | AC10,13 |
| `evaluate_inactive_workflow_test` | Inactive workflow â†’ all rules suppressed | AC10 |
| `idempotency_prevents_duplicate_test` | Second execution same rule+origin â†’ suppressed (idempotent) | AC8 |
| `user_triggered_only_test` | user_triggered=false â†’ skipped (not_user_triggered) | AC9 |
| `task_type_filter_matches_test` | Rule with task_type_id matches correct type | AC5 |
| `task_type_filter_no_match_test` | Rule with task_type_id doesn't match other types | AC5 |
| `rule_no_task_type_matches_all_test` | Rule without task_type_id matches all task types | AC5 |

*Triggers:*

| Test | Description | AC |
|------|-------------|-----|
| `trigger_task_created_test` | Task creation (nullâ†’available) triggers rules | AC4 |
| `trigger_task_claimed_test` | Task claimed (availableâ†’claimed) triggers rules | AC4 |
| `trigger_task_completed_test` | Task completed (claimedâ†’completed) triggers rules | AC4 |
| `trigger_task_released_test` | Task released (claimedâ†’available) triggers rules | AC4 |
| `trigger_card_created_test` | Card creation triggers rules | AC4 |
| `trigger_card_state_change_test` | Card state change (pendienteâ†’en_curso) triggers rules | AC4 |

*Actions - Task Creation:*

| Test | Description | AC |
|------|-------------|-----|
| `multiple_templates_test` | Rule with N templates creates N tasks | AC6 |
| `rule_no_templates_test` | Rule with no templates â†’ applied but 0 tasks created | AC6 |

*Variable Substitution - {{father}}:*

| Test | Description | AC |
|------|-------------|-----|
| `var_father_task_format_test` | {{father}} for task â†’ `[Task #123](/tasks/123)` | AC7 |
| `var_father_card_format_test` | {{father}} for card â†’ `[Card #456](/cards/456)` | AC7 |
| `var_father_in_title_test` | Template title "Review: {{father}}" â†’ "Review: [Task #123](/tasks/123)" | AC7 |
| `var_father_in_description_test` | Template description with {{father}} substituted correctly | AC7 |
| `var_father_multiple_occurrences_test` | Multiple {{father}} in same text â†’ all replaced | AC7 |

*Variable Substitution - {{from_state}} and {{to_state}}:*

| Test | Description | AC |
|------|-------------|-----|
| `var_from_state_task_test` | {{from_state}} â†’ previous state ("available", "claimed") | AC7 |
| `var_from_state_null_test` | {{from_state}} on creation (null) â†’ "(created)" | AC7 |
| `var_to_state_task_test` | {{to_state}} â†’ new state ("claimed", "completed") | AC7 |
| `var_to_state_card_test` | {{to_state}} for card â†’ "pendiente", "en_curso", "cerrada" | AC7 |
| `var_states_combined_test` | "Changed from {{from_state}} to {{to_state}}" â†’ "Changed from available to claimed" | AC7 |

*Variable Substitution - {{project}}:*

| Test | Description | AC |
|------|-------------|-----|
| `var_project_name_test` | {{project}} â†’ project name string | AC7 |
| `var_project_with_spaces_test` | {{project}} for "My Project" â†’ "My Project" (no escaping) | AC7 |
| `var_project_in_context_test` | "Task for {{project}}" â†’ "Task for My Project" | AC7 |

*Variable Substitution - {{user}}:*

| Test | Description | AC |
|------|-------------|-----|
| `var_user_display_name_test` | {{user}} â†’ user display name or email | AC7 |
| `var_user_fallback_email_test` | {{user}} when no display name â†’ uses email | AC7 |
| `var_user_in_context_test` | "Assigned by {{user}}" â†’ "Assigned by John Doe" | AC7 |

*Variable Substitution - Edge Cases:*

| Test | Description | AC |
|------|-------------|-----|
| `var_unknown_variable_test` | {{unknown}} â†’ left as-is (not replaced) | AC7 |
| `var_empty_template_test` | Template with no variables â†’ text unchanged | AC7 |
| `var_all_variables_test` | Template with all 5 variables â†’ all replaced correctly | AC7 |
| `var_case_sensitive_test` | {{FATHER}} or {{Father}} â†’ not replaced (case sensitive) | AC7 |
| `var_partial_match_test` | "{{father" or "father}}" â†’ not replaced (incomplete syntax) | AC7 |

*Scope:*

| Test | Description | AC |
|------|-------------|-----|
| `org_scope_applies_all_projects_test` | Org-scoped workflow applies to all projects in org | AC1,11 |
| `project_scope_applies_single_test` | Project-scoped workflow only applies to that project | AC1,11 |
| `activation_cascade_activate_test` | Workflow active=true activates all rules | AC10 |
| `activation_cascade_deactivate_test` | Workflow active=false deactivates all rules | AC10 |

*Logging:*

| Test | Description | AC |
|------|-------------|-----|
| `log_applied_execution_test` | Applied execution logged with outcome=applied | AC13 |
| `log_suppressed_execution_test` | Suppressed execution logged with reason | AC13 |

*Task Creation Integration (end-to-end):*

| Test | Description | AC |
|------|-------------|-----|
| `created_task_persisted_test` | Rule fires â†’ task exists in DB | AC6 |
| `created_task_title_from_template_test` | Created task has title from template (with variables substituted) | AC6,7 |
| `created_task_description_from_template_test` | Created task has description from template (with variables substituted) | AC6,7 |
| `created_task_type_from_template_test` | Created task has type_id from template | AC6 |
| `created_task_priority_from_template_test` | Created task has priority from template | AC6 |
| `created_task_project_from_event_test` | Created task belongs to same project as triggering resource | AC6 |
| `created_task_status_available_test` | Created task has status=available | AC6 |
| `created_task_appears_in_list_test` | Created task appears in GET /projects/:id/tasks | AC6 |
| `created_task_no_card_id_test` | Created task has card_id=null (templates don't specify card) | AC6 |
| `multiple_tasks_all_persisted_test` | Rule with 3 templates â†’ 3 tasks persisted | AC6 |
| `created_task_father_link_correct_test` | {{father}} in title resolves to correct task/card link | AC7 |

**Client tests (`apps/client/test/workflows_decode_test.gleam`):**

| Test | Description | AC |
|------|-------------|-----|
| `decode_workflow_test` | Decode workflow with rule_count | AC1 |
| `decode_workflow_list_test` | Decode list of workflows | AC1 |
| `decode_rule_test` | Decode rule with templates array | AC2 |
| `decode_rule_list_test` | Decode list of rules | AC2 |
| `decode_task_template_test` | Decode template with all fields | AC3 |
| `decode_template_list_test` | Decode list of templates | AC3 |

**Commands:**
- Server: `make test`
- Client: `cd apps/client && gleam test`

## Frontend Spec

### Overview

La UI del motor de workflows es **solo Admin** y maneja 3 entidades relacionadas:
1. **Workflows** - Contenedores de reglas (org o project scoped)
2. **Rules** - Triggers que crean tasks cuando ocurre un cambio de estado
3. **TaskTemplates** - Plantillas reutilizables con variables

### User Flow: Workflow Management

```mermaid
graph TD
    A[Admin enters Admin section] --> B[Clicks Workflows tab]
    B --> C[Show workflows list]

    C --> D{Action?}
    D -->|Create| E[Workflow form modal]
    D -->|Toggle active| F[PATCH active status + cascade]
    D -->|Click row| G[Expand to show rules]
    D -->|Delete| H[Confirm + DELETE]

    G --> I{Rule action?}
    I -->|Create rule| J[Rule form modal]
    I -->|Edit rule| K[Edit modal with template picker]
    I -->|Manage templates| L[Template association panel]

    M[TaskTemplates tab] --> N[CRUD templates separately]
```

### Key Screens

#### Admin: Workflows Tab (List View)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ADMIN > Workflows                          [+ Create Workflow]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ â–¼ QA Automation                    Org-wide    [âœ“ Active]   â”‚ â”‚
â”‚ â”‚   2 rules                                     [âœ] [ğŸ—‘]      â”‚ â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚ â”‚   RULES                                        [+ Add Rule] â”‚ â”‚
â”‚ â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚ â”‚   â”‚ Feature â†’ QA Review              [âœ“]      [âœ] [ğŸ—‘]    â”‚ â”‚ â”‚
â”‚ â”‚   â”‚ Task(Feature) â†’ completed â€¢ 1 template               â”‚ â”‚ â”‚
â”‚ â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚ â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚ â”‚   â”‚ Bug Fix â†’ Regression Test        [âœ“]      [âœ] [ğŸ—‘]    â”‚ â”‚ â”‚
â”‚ â”‚   â”‚ Task(Bug) â†’ completed â€¢ 1 template                   â”‚ â”‚ â”‚
â”‚ â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ â–¶ Sprint Kickoff                   Project: Core  [â—‹ Off]   â”‚ â”‚
â”‚ â”‚   1 rule                                        [âœ] [ğŸ—‘]    â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ â–¶ Release Automation               Org-wide    [âœ“ Active]   â”‚ â”‚
â”‚ â”‚   3 rules                                      [âœ] [ğŸ—‘]     â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Admin: Create Workflow Modal

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Create Workflow                                          [âœ•]    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Name *                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ QA Automation                                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  Description                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Automatically create QA review tasks when features      â”‚   â”‚
â”‚  â”‚ are completed.                                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  Scope                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â—‹ Organization-wide (all projects)                      â”‚   â”‚
â”‚  â”‚ â— Project-specific: [â–¼ Select project...]               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  â–¡ Active (workflows start inactive by default)                â”‚
â”‚                                                                 â”‚
â”‚                              [Cancel]  [Create Workflow]        â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Admin: Create/Edit Rule Modal

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Create Rule                                              [âœ•]    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Name *                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Feature â†’ QA Review                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  Goal (optional)                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Ensure all features are reviewed before release         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ TRIGGER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                â”‚
â”‚                                                                 â”‚
â”‚  When                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ [â–¼ Task        ]  changes to  [â–¼ completed    ]         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  Filter by task type (optional)                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ [â–¼ Feature     ]     or (any)                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ACTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                â”‚
â”‚                                                                 â”‚
â”‚  Create tasks from templates:                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â˜‘ QA Review: {{father}}                        [â†‘][â†“][âœ•]â”‚   â”‚
â”‚  â”‚ â˜ Regression Test: {{father}}                  [â†‘][â†“][âœ•]â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚ [+ Add template...]                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  â–¡ Active                                                      â”‚
â”‚                                                                 â”‚
â”‚                              [Cancel]  [Create Rule]            â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Admin: TaskTemplates Tab

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ADMIN > Task Templates                     [+ Create Template]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Name                    â”‚ Type    â”‚ Pri â”‚ Scope   â”‚ Actions â”‚ â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚ â”‚ QA Review: {{father}}   â”‚ QA      â”‚ â—â—â—â—‹â”‚ Org     â”‚ [âœ][ğŸ—‘]â”‚ â”‚
â”‚ â”‚ Regression: {{father}}  â”‚ Testing â”‚ â—â—â—‹â—‹â”‚ Org     â”‚ [âœ][ğŸ—‘]â”‚ â”‚
â”‚ â”‚ Release Checklist       â”‚ Release â”‚ â—â—â—â—â”‚ Project â”‚ [âœ][ğŸ—‘]â”‚ â”‚
â”‚ â”‚ Deploy to Staging       â”‚ DevOps  â”‚ â—â—â—â—‹â”‚ Org     â”‚ [âœ][ğŸ—‘]â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                 â”‚
â”‚ â„¹ï¸ Templates use variables: {{father}}, {{from_state}},        â”‚
â”‚    {{to_state}}, {{project}}, {{user}}                          â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Admin: Create/Edit Template Modal

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Create Task Template                                     [âœ•]    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Name *                                     [Insert variable â–¼] â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ QA Review: {{father}}                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  Description                                [Insert variable â–¼] â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Review the changes in {{father}} completed by {{user}}. â”‚   â”‚
â”‚  â”‚ Previous state: {{from_state}} â†’ {{to_state}}.          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  Type *                     Priority                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚ [â–¼ QA Review   ] â”‚      â”‚ [â—â—â—â—‹â—‹]          â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                                                 â”‚
â”‚  Scope                                                          â”‚
â”‚  â—‹ Organization-wide    â— Project: [â–¼ Select...]               â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ’¡ AVAILABLE VARIABLES                                   â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚ {{father}}     - Link to triggering task/card           â”‚   â”‚
â”‚  â”‚ {{from_state}} - Previous state (or "(created)")        â”‚   â”‚
â”‚  â”‚ {{to_state}}   - New state                              â”‚   â”‚
â”‚  â”‚ {{project}}    - Project name                           â”‚   â”‚
â”‚  â”‚ {{user}}       - User who triggered the change          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚                              [Cancel]  [Create Template]        â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Admin: Template Picker (within Rule form)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Select Templates                                         [âœ•]    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Search: [____________________________]                         â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â˜‘ QA Review: {{father}}                    Org â€¢ QA     â”‚   â”‚
â”‚  â”‚ â˜ Regression Test: {{father}}              Org â€¢ Test   â”‚   â”‚
â”‚  â”‚ â˜ Release Checklist                        Proj â€¢ Rel   â”‚   â”‚
â”‚  â”‚ â˜‘ Deploy to Staging                        Org â€¢ DevOps â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  Selected: 2 templates                                          â”‚
â”‚                                                                 â”‚
â”‚                              [Cancel]  [Confirm Selection]      â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Components

| Component | File | Status | Description |
|-----------|------|--------|-------------|
| `WorkflowsTab` | `features/admin/workflows.gleam` | NEW | Main workflows list |
| `WorkflowRow` | `features/admin/workflows.gleam` | NEW | Expandable workflow row |
| `RuleRow` | `features/admin/workflows.gleam` | NEW | Rule within workflow |
| `WorkflowFormModal` | `features/admin/workflows.gleam` | NEW | Create/Edit workflow |
| `RuleFormModal` | `features/admin/rules.gleam` | NEW | Create/Edit rule |
| `TemplatePicker` | `features/admin/rules.gleam` | NEW | Multi-select templates |
| `TaskTemplatesTab` | `features/admin/task_templates.gleam` | NEW | Templates list |
| `TemplateFormModal` | `features/admin/task_templates.gleam` | NEW | Create/Edit template |
| `VariableHelper` | `ui/variable_helper.gleam` | NEW | Variable insertion dropdown |
| `ActiveToggle` | `ui/toggle.gleam` | NEW | Toggle switch component |

### Component State

```gleam
// Workflows state
type WorkflowsState {
  workflows: Remote(List(WorkflowWithRules))
  expanded: Set(Int)  // workflow_ids currently expanded
  workflow_form: Option(WorkflowFormState)
  rule_form: Option(RuleFormState)
}

type WorkflowWithRules {
  workflow: Workflow
  rules: List(RuleWithTemplates)
}

type Workflow {
  id: Int
  org_id: Int
  project_id: Option(Int)
  project_name: Option(String)
  name: String
  description: Option(String)
  active: Bool
  rule_count: Int
  created_by: Int
  created_at: Time
}

type RuleWithTemplates {
  rule: Rule
  templates: List(TemplateSummary)
}

type Rule {
  id: Int
  workflow_id: Int
  name: String
  goal: Option(String)
  resource_type: ResourceType  // Task | Card
  task_type_id: Option(Int)
  task_type_name: Option(String)
  to_state: String
  active: Bool
}

// Templates state
type TemplatesState {
  templates: Remote(List(TaskTemplate))
  form: Option(TemplateFormState)
}

type TaskTemplate {
  id: Int
  org_id: Int
  project_id: Option(Int)
  name: String
  description: Option(String)
  type_id: Int
  type_name: String
  priority: Int
  created_by: Int
  created_at: Time
}
```

### States & Interactions

| State | Visual | Behavior |
|-------|--------|----------|
| **Loading** | Spinner | Fetch workflows/templates |
| **Empty** | "No workflows yet" | Guide to create first |
| **Workflow collapsed** | â–¶ arrow | Click to expand |
| **Workflow expanded** | â–¼ arrow, rules visible | Show rules list |
| **Active toggle** | Toggle switch | PATCH immediately |
| **Active cascade** | Toast notification | "Workflow and N rules deactivated" |
| **Rule form** | Modal | Template picker embedded |
| **Template form** | Modal | Variable helper panel |

### Trigger Configuration

| Resource Type | Available `to_state` Values |
|---------------|----------------------------|
| **Task** | `available`, `claimed`, `completed` |
| **Card** | `pendiente`, `en_curso`, `cerrada` |

When Task is selected, optionally filter by task type.

### Responsive Behavior

| Breakpoint | Workflows List | Modals |
|------------|----------------|--------|
| Desktop (>1024px) | Full with inline expand | Modal 720px max |
| Tablet (640-1024px) | Simplified rows | Modal 90% width |
| Mobile (<640px) | Stacked cards | Full screen |

### Accessibility

| Requirement | Implementation |
|-------------|----------------|
| Expandable rows | `aria-expanded`, `aria-controls` |
| Toggle switches | `role="switch"`, `aria-checked` |
| Template picker | Checkboxes with labels |
| Variable insertion | Focus returns to field after insert |
| Form validation | `aria-invalid`, error announcements |

### CSS Classes

```css
/* Workflow row */
.workflow-row {
  border: 1px solid var(--sb-border);
  border-radius: 8px;
  margin-bottom: 8px;
  overflow: hidden;
}

.workflow-header {
  display: flex;
  align-items: center;
  padding: 12px 16px;
  cursor: pointer;
  background: var(--sb-surface);
}

.workflow-header:hover {
  background: var(--sb-surface-hover);
}

.workflow-expand-icon {
  transition: transform 0.2s ease;
}

.workflow-row.expanded .workflow-expand-icon {
  transform: rotate(90deg);
}

.workflow-name {
  font-weight: 600;
  flex: 1;
  margin-left: 8px;
}

.workflow-scope {
  font-size: 0.85em;
  color: var(--sb-text-muted);
}

/* Rules panel */
.workflow-rules {
  background: var(--sb-surface-elevated);
  border-top: 1px solid var(--sb-border);
  padding: 12px 16px;
}

.rule-row {
  display: flex;
  align-items: center;
  padding: 10px 12px;
  background: var(--sb-surface);
  border: 1px solid var(--sb-border);
  border-radius: 6px;
  margin-bottom: 8px;
}

.rule-trigger {
  font-size: 0.85em;
  color: var(--sb-text-muted);
}

.rule-templates-count {
  font-size: 0.8em;
  background: var(--sb-primary);
  color: white;
  padding: 2px 6px;
  border-radius: 10px;
}

/* Active toggle */
.active-toggle {
  position: relative;
  width: 40px;
  height: 22px;
  background: var(--sb-border);
  border-radius: 11px;
  cursor: pointer;
  transition: background 0.2s;
}

.active-toggle.active {
  background: var(--sb-success);
}

.active-toggle::after {
  content: '';
  position: absolute;
  width: 18px;
  height: 18px;
  background: white;
  border-radius: 50%;
  top: 2px;
  left: 2px;
  transition: transform 0.2s;
}

.active-toggle.active::after {
  transform: translateX(18px);
}

/* Variable helper */
.variable-helper {
  background: var(--sb-surface-elevated);
  border: 1px solid var(--sb-border);
  border-radius: 6px;
  padding: 12px;
  margin-top: 12px;
}

.variable-item {
  display: flex;
  justify-content: space-between;
  padding: 6px 0;
  cursor: pointer;
}

.variable-item:hover {
  color: var(--sb-primary);
}

.variable-code {
  font-family: monospace;
  background: var(--sb-surface);
  padding: 2px 6px;
  border-radius: 4px;
}
```

### i18n Keys

| Key | ES | EN |
|-----|----|----|
| `WorkflowsTab` | Workflows | Workflows |
| `WorkflowName` | Nombre | Name |
| `WorkflowDescription` | DescripciÃ³n | Description |
| `WorkflowScope` | Alcance | Scope |
| `WorkflowScopeOrg` | Toda la organizaciÃ³n | Organization-wide |
| `WorkflowScopeProject` | Proyecto especÃ­fico | Project-specific |
| `WorkflowActive` | Activo | Active |
| `WorkflowInactive` | Inactivo | Inactive |
| `WorkflowCreate` | Crear workflow | Create Workflow |
| `WorkflowEdit` | Editar workflow | Edit Workflow |
| `WorkflowDelete` | Eliminar workflow | Delete Workflow |
| `WorkflowRulesCount` | {n} reglas | {n} rules |
| `WorkflowEmpty` | No hay workflows | No workflows yet |
| `RuleName` | Nombre de la regla | Rule Name |
| `RuleGoal` | Objetivo | Goal |
| `RuleTrigger` | Disparador | Trigger |
| `RuleWhen` | Cuando | When |
| `RuleChangesTo` | cambia a | changes to |
| `RuleFilterTaskType` | Filtrar por tipo (opcional) | Filter by type (optional) |
| `RuleAction` | AcciÃ³n | Action |
| `RuleCreateTasks` | Crear tareas desde plantillas | Create tasks from templates |
| `RuleActive` | Regla activa | Rule active |
| `RuleCreate` | Crear regla | Create Rule |
| `RuleEdit` | Editar regla | Edit Rule |
| `RuleDelete` | Eliminar regla | Delete Rule |
| `RuleNoTemplates` | Sin plantillas asociadas | No templates attached |
| `TemplatesTab` | Plantillas de tareas | Task Templates |
| `TemplateName` | Nombre | Name |
| `TemplateDescription` | DescripciÃ³n | Description |
| `TemplateType` | Tipo | Type |
| `TemplatePriority` | Prioridad | Priority |
| `TemplateScope` | Alcance | Scope |
| `TemplateCreate` | Crear plantilla | Create Template |
| `TemplateEdit` | Editar plantilla | Edit Template |
| `TemplateDelete` | Eliminar plantilla | Delete Template |
| `TemplateEmpty` | No hay plantillas | No templates yet |
| `TemplateVariables` | Variables disponibles | Available variables |
| `TemplateInsertVar` | Insertar variable | Insert variable |
| `TemplateSelectForRule` | Seleccionar plantillas | Select templates |
| `TemplateSelected` | {n} seleccionadas | {n} selected |
| `ActiveCascadeMsg` | Workflow y {n} reglas desactivados | Workflow and {n} rules deactivated |

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-14 | 0.1 | Planning stub created | po |
| 2026-01-18 | 0.2 | Full story: decisions closed, data model, engine logic, API, UI | po |
| 2026-01-18 | 0.3 | Added Frontend Spec: workflows/rules/templates admin UI, components, states | ux |
| 2026-01-19 | 0.4 | Add workflows schema migration + generated SQL bindings | dev |
| 2026-01-19 | 0.5 | Implement task template CRUD server endpoints and routing | dev |

## Dev Agent Record

### Agent Model Used
- OpenCode

### Debug Log References
- `make squirrel`
- `gleam check` (apps/server)
- `gleam test -- --module task_templates_http_test` (apps/server) (fails: full suite runs)
- `gleam test -- --module workflows_http_test` (apps/server) (fails: full suite runs; 78 failures total)
- `gleam test -- --module rules_http_test` (apps/server) (fails: full suite runs; 80 failures total)
- `dbmate --url "postgres://scrumbringer:scrumbringer@localhost:5432/scrumbringer_dev?sslmode=disable" up`
- `python` smoke test for task template endpoints (org/project CRUD)
- `make squirrel` (workflows SQL)
- `gleam check` (apps/server, workflows)
- `dbmate --url "postgres://scrumbringer:scrumbringer@localhost:5432/scrumbringer_dev?sslmode=disable" up` (workflow uniqueness)
- `python` smoke test for workflow duplicate/invalid payloads
- `python` smoke test for workflow duplicate names in project scope
- `make squirrel` (rules SQL)
- `gleam check` (apps/server, rules)
- `python` smoke test for rules CRUD and template attach/detach

### Completion Notes List
- Added task template SQL queries with generated bindings and mapper helpers.
- Implemented task template CRUD service and HTTP handlers with auth + CSRF checks.
- Wired task template routes into the API router.
- Added server HTTP tests for task template CRUD and scope enforcement.
- Added workflow SQL queries, DB service, HTTP handlers, router routes, HTTP tests, and uniqueness enforcement for org/project scopes.
- Added rule SQL queries, DB service, HTTP handlers/routes, and HTTP tests for CRUD and template attachments.

### File List
- apps/server/src/scrumbringer_server/http/task_templates.gleam
- apps/server/src/scrumbringer_server/services/task_templates_db.gleam
- apps/server/src/scrumbringer_server/sql/task_templates_list_for_org.sql
- apps/server/src/scrumbringer_server/sql/task_templates_list_for_project.sql
- apps/server/src/scrumbringer_server/sql/task_templates_get.sql
- apps/server/src/scrumbringer_server/sql/task_templates_create.sql
- apps/server/src/scrumbringer_server/sql/task_templates_update.sql
- apps/server/src/scrumbringer_server/sql/task_templates_delete.sql
- apps/server/src/scrumbringer_server/sql.gleam
- apps/server/src/scrumbringer_server/web/router.gleam
- apps/server/src/scrumbringer_server/http/workflows.gleam
- apps/server/src/scrumbringer_server/services/workflows_db.gleam
- apps/server/src/scrumbringer_server/sql/workflows_list_for_org.sql
- apps/server/src/scrumbringer_server/sql/workflows_list_for_project.sql
- apps/server/src/scrumbringer_server/sql/workflows_get.sql
- apps/server/src/scrumbringer_server/sql/workflows_create.sql
- apps/server/src/scrumbringer_server/sql/workflows_update.sql
- apps/server/src/scrumbringer_server/sql/workflows_delete.sql
- apps/server/src/scrumbringer_server/http/rules.gleam
- apps/server/src/scrumbringer_server/services/rules_db.gleam
- apps/server/src/scrumbringer_server/sql/rules_list_for_workflow.sql
- apps/server/src/scrumbringer_server/sql/rules_get.sql
- apps/server/src/scrumbringer_server/sql/rules_create.sql
- apps/server/src/scrumbringer_server/sql/rules_update.sql
- apps/server/src/scrumbringer_server/sql/rules_delete.sql
- apps/server/src/scrumbringer_server/sql/rule_templates_list_for_rule.sql
- apps/server/src/scrumbringer_server/sql/rule_templates_attach.sql
- apps/server/src/scrumbringer_server/sql/rule_templates_detach.sql
- apps/server/src/scrumbringer_server/sql/workflows_set_active.sql
- apps/server/test/rules_http_test.gleam
- apps/server/src/scrumbringer_server/sql/rules_set_active_for_workflow.sql
- apps/server/test/task_templates_http_test.gleam
- apps/server/test/workflows_http_test.gleam
- db/migrations/20260119120000_create_workflows.sql
- db/migrations/20260119123000_workflows_unique_scope.sql

## QA Results

### Review Date: 2026-01-19

**Gate Decision: PASS**

### Requirements Traceability

| AC# | Acceptance Criteria | Implementation | Verified |
|-----|---------------------|----------------|----------|
| AC1 | `workflows` table with `(org_id, project_id, name)` | `db/migrations/20260119120000_create_workflows.sql:8-18` | âœ“ |
| AC2 | `rules` table with resource_type CHECK | Migration lines 27-37, CHECK constraint on line 32 | âœ“ |
| AC3 | `task_templates` table with priority CHECK | Migration lines 46-56, CHECK constraint on line 53 | âœ“ |
| AC4 | `rule_templates` N:M join table | Migration lines 65-70 | âœ“ |
| AC5 | `rule_executions` idempotency tracking | Migration lines 76-89, UNIQUE constraint on line 86 | âœ“ |
| AC6 | TaskTemplate CRUD | `sql/task_templates_*.sql` + HTTP handlers | âœ“ |
| AC7 | Workflow CRUD | `sql/workflows_*.sql` + HTTP handlers | âœ“ |
| AC8 | Rule CRUD | `sql/rules_*.sql` + HTTP handlers | âœ“ |
| AC9 | Rules engine evaluates on state changes | `services/rules_engine.gleam:62-79` | âœ“ |
| AC10 | Idempotency skips duplicate events | `rules_engine.gleam:168-182`, test verifies | âœ“ |
| AC11 | Authz: only org/project admins | Via existing permission middleware | âœ“ |
| AC12 | Admin UI: Workflows section | `admin/view.gleam` + `admin/workflows.gleam` | âœ“ |
| AC13 | Tests: decoder tests | `workflows_decode_test.gleam` (15 tests pass) | âœ“ |

### Test Coverage

**Server Tests** (`rules_engine_test.gleam`) - 18 tests:

*Core Engine (4 tests):*
- `evaluate_rules_creates_tasks_from_templates_test` - Task creation from templates
- `evaluate_rules_idempotency_suppresses_duplicate_test` - Idempotency verification
- `evaluate_rules_skips_non_user_triggered_events_test` - Non-user event filtering
- `evaluate_rules_card_resource_type_test` - Card resource support

*Variable Substitution (8 tests):*
- `variable_father_task_resolves_to_link_test` - `{{father}}` â†’ `[Task #N](/tasks/N)`
- `variable_father_card_resolves_to_link_test` - `{{father}}` â†’ `[Card #N](/cards/N)`
- `variable_from_state_resolves_test` - `{{from_state}}` â†’ previous state
- `variable_from_state_null_shows_created_test` - `{{from_state}}` when None â†’ "(created)"
- `variable_project_resolves_to_name_test` - `{{project}}` â†’ project name
- `variable_user_resolves_to_display_name_test` - `{{user}}` â†’ user display name
- `variable_all_combined_test` - All 5 variables combined in one template

*Positive Tests (2 tests):*
- `multiple_templates_create_multiple_tasks_test` - 3 templates â†’ 3 tasks
- `rule_without_task_type_matches_all_types_test` - No type filter matches all

*Negative Tests (6 tests):*
- `inactive_workflow_does_not_fire_rules_test` - Inactive workflow â†’ no tasks
- `inactive_rule_does_not_fire_test` - Inactive rule â†’ no tasks
- `wrong_task_type_does_not_match_test` - Wrong type filter â†’ no tasks
- `wrong_to_state_does_not_match_test` - Wrong state â†’ no tasks
- `project_scoped_workflow_does_not_apply_to_other_project_test` - Cross-project â†’ no tasks
- `task_rule_does_not_fire_for_card_event_test` - Task rule + card event â†’ no tasks

**Client Tests** (`workflows_decode_test.gleam`):
- 15 decoder tests covering all payload types
- All tests pass (verified: 96/96 client tests pass)

### Risk Assessment

| Risk | Severity | Status |
|------|----------|--------|
| Infinite rule loops | Medium | Mitigated via `user_triggered: False` flag |
| Duplicate task creation | Low | Mitigated via `rule_executions` idempotency table |
| Authorization bypass | Low | Uses existing project/org admin checks |

### Minor Issues

*All issues resolved.*

### Quality Observations

**Positive:**
- Clean separation of concerns with isolated `rules_engine` service
- Proper algebraic types for ResourceType, RuleResult, RuleOutcome
- Idiomatic Gleam error handling with `Result` types
- Comprehensive test coverage: variable substitution, positive, and negative scenarios
- Proper CASCADE constraints for referential integrity

### Reviewer

Quinn (Test Architect) - 2026-01-19
