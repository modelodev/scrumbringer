# Story 3.6: Card Detail Modal como Lustre Component

## Status

**Draft**

---

## Story

**As a** maintainer of the Scrumbringer codebase,
**I want** to extract the Card Detail Modal into a self-contained Lustre Component using the Shadow DOM API,
**so that** the modal's state and lifecycle are encapsulated, reducing the main Model's complexity and improving long-term maintainability.

---

## Acceptance Criteria

1. **Component Registration**: A new Lustre Component `<card-detail-modal>` is registered on app init and renders correctly when invoked.

2. **State Encapsulation**: All 7 state fields (`card_detail_tasks`, `card_add_task_*`) are moved from the root `Model` to the component's internal state.

3. **Message Encapsulation**: All 9 `Msg` variants related to Card Detail are removed from root `Msg` and handled internally by the component.

4. **Handler Cleanup**: All inline handlers in `client_update.gleam` (lines 1901-1956) are removed; no dead code remains.

5. **Parent Communication**: The component communicates with the parent via:
   - **Attributes**: `card-id` (Int as string), `locale` (String)
   - **Properties**: `card` (Card as JSON) - card metadata only
   - **Custom Events**: Emits `task-created` when task created, `close-requested` when user closes modal
   - **Internal Fetch**: The component fetches its own tasks using `card-id` attribute

6. **Style Inheritance**: The component uses `adopt_styles(True)` configuration to inherit CSS custom properties from the parent document (theme colors, fonts).

7. **Functional Parity**: All existing functionality works identically:
   - Open modal by clicking a card
   - Display card header (title, state, progress, description)
   - List tasks with status indicators
   - Open/close "Add Task" inline form
   - Create task with title and priority
   - Close modal via backdrop click or X button

8. **Tests Pass**: All existing tests continue to pass; new component has unit tests for internal state transitions and effect verification.

9. **No Dead Code**: All removed state fields, messages, and handlers are completely deleted—no commented-out code, no `_unused` prefixes.

10. **Parent Minimal State**: The parent retains `card_detail_open: Option(Int)` to know which card's modal is open (for conditional rendering). This is the ONLY card-detail state remaining in root Model.

---

## Tasks / Subtasks

- [ ] **Task 0: Spike - Validate Lustre Component API** (AC: 1)
  - [ ] Create minimal test component to validate the real API
  - [ ] Verify how components are actually registered in Lustre
  - [ ] Document the correct pattern in Dev Notes
  - [ ] If API differs significantly from assumptions, update this story before proceeding

- [ ] **Task 1: Create component module** (AC: 1)
  - [ ] Create `apps/client/src/scrumbringer_client/components/card_detail_modal.gleam`
  - [ ] Define internal `Model` type with the 6 encapsulated state fields (not `card_detail_open`)
  - [ ] Define internal `Msg` type with internal message variants
  - [ ] Implement `init`, `update`, `view` functions
  - [ ] Implement `register()` function using validated `lustre/component` API

- [ ] **Task 2: Implement component lifecycle** (AC: 2, 5, 6)
  - [ ] Use `on_attribute_change("card-id", ...)` to receive card ID from parent (parse Int from String)
  - [ ] Use `on_attribute_change("locale", ...)` for i18n locale
  - [ ] Use `on_property_change("card", ...)` to receive Card data as JSON
  - [ ] Configure `adopt_styles(True)` to inherit CSS custom properties
  - [ ] Implement internal task fetching when `card-id` changes
  - [ ] Emit `task-created` custom event on successful task creation
  - [ ] Emit `close-requested` custom event when user clicks backdrop/X button

- [ ] **Task 3: Implement i18n inside component** (AC: 7)
  - [ ] Create internal helper `t(locale, key)` that maps locale + key to text
  - [ ] Import i18n text keys from shared module
  - [ ] Remove dependency on `update_helpers.i18n_t(model, ...)` pattern

- [ ] **Task 4: Migrate view code** (AC: 7)
  - [ ] Move `view_card_detail` from `features/fichas/card_detail.gleam` to component
  - [ ] Move all helper views (`view_card_header`, `view_card_tasks_section`, etc.)
  - [ ] Update view to use internal `Model` and `Msg` types
  - [ ] Update i18n calls to use internal `t(locale, key)` helper
  - [ ] Preserve all CSS classes and accessibility attributes

- [ ] **Task 5: Migrate update logic** (AC: 3)
  - [ ] Move handler logic from `client_update.gleam` lines 1901-1956 to component's `update`
  - [ ] Implement internal API calls (fetch tasks, create task)
  - [ ] Manage loading/error states within component
  - [ ] Emit custom events instead of updating parent state directly

- [ ] **Task 6: Integrate component in parent** (AC: 5, 10)
  - [ ] Register component in `scrumbringer_client.gleam` init (handle Result error)
  - [ ] Replace `view_card_detail` call in `features/fichas/view.gleam` with `<card-detail-modal>` element
  - [ ] Pass attributes via `attribute.attribute("card-id", int.to_string(id))`
  - [ ] Pass card data via `attribute.property("card", card_to_json(card))`
  - [ ] Listen for `task-created` event to trigger parent task list refresh
  - [ ] Listen for `close-requested` event to set `card_detail_open = None`

- [ ] **Task 7: Clean up root Model** (AC: 2, 9, 10)
  - [ ] KEEP `card_detail_open: Option(Int)` in Model (needed for conditional rendering)
  - [ ] Remove 6 fields from `client_state.gleam` Model type:
    - `card_detail_tasks`
    - `card_add_task_open`
    - `card_add_task_title`
    - `card_add_task_priority`
    - `card_add_task_in_flight`
    - `card_add_task_error`
  - [ ] Remove corresponding initializations from `default_model()`

- [ ] **Task 8: Clean up root Msg** (AC: 3, 9)
  - [ ] KEEP `OpenCardDetail(Int)` and `CloseCardDetail` in root Msg (for parent navigation)
  - [ ] Remove 7 variants from `client_state.gleam` Msg type:
    - `CardDetailTasksFetched`
    - `ToggleAddTaskForm`
    - `CardAddTaskTitleInput`
    - `CardAddTaskPrioritySelect`
    - `CancelAddTask`
    - `SubmitAddTask`
    - `CardAddTaskCreated`

- [ ] **Task 9: Clean up client_update.gleam** (AC: 4, 9)
  - [ ] Simplify `OpenCardDetail` handler to only set `card_detail_open = Some(id)`
  - [ ] Simplify `CloseCardDetail` handler to only set `card_detail_open = None`
  - [ ] Remove all other Card Detail handlers (lines ~1915-1956)
  - [ ] Remove imports no longer needed
  - [ ] Verify no dead code remains

- [ ] **Task 10: Delete obsolete view module** (AC: 9)
  - [ ] Delete `features/fichas/card_detail.gleam` entirely OR
  - [ ] If module has other responsibilities, remove only Card Detail functions

- [ ] **Task 11: Write component tests** (AC: 8)
  - [ ] Create `apps/client/test/card_detail_modal_test.gleam`
  - [ ] Test init produces correct initial state
  - [ ] Test `ToggleAddTaskForm` toggles form visibility
  - [ ] Test `CardAddTaskTitleInput` updates title
  - [ ] Test `CardAddTaskPrioritySelect` updates priority
  - [ ] Test `CancelAddTask` resets form state
  - [ ] Test `SubmitAddTask` produces HTTP effect (not just state change)
  - [ ] Test `CardIdReceived` triggers task fetch effect

- [ ] **Task 12: Verify existing tests** (AC: 8)
  - [ ] Run full test suite
  - [ ] Fix any broken tests due to Model/Msg changes

- [ ] **Task 13: Manual QA verification** (AC: 7)
  - [ ] Verify modal opens when clicking a card
  - [ ] Verify card header displays correctly
  - [ ] Verify task list renders (component fetches its own tasks)
  - [ ] Verify "Add Task" form toggles
  - [ ] Verify task creation works
  - [ ] Verify modal closes on backdrop/X click
  - [ ] Verify styles look correct (theme inheritance via adopt_styles)
  - [ ] Verify i18n works correctly in both locales

---

## Dev Notes

### Relevant Source Tree

```
apps/client/src/scrumbringer_client/
├── client_state.gleam          # Model (lines 317-324), Msg (lines 607-616)
├── client_update.gleam         # Handlers (lines 1901-1956)
├── features/fichas/
│   └── card_detail.gleam       # Current view implementation (354 lines) - TO DELETE
├── components/                  # NEW: Create this directory
│   └── card_detail_modal.gleam # NEW: Component module
```

### Lustre Component API Reference

**IMPORTANT**: Task 0 must validate the exact API before implementation. The pattern below is based on documentation but may need adjustment.

```gleam
//// Card Detail Modal Component
////
//// ## Mission
//// Encapsulated Lustre Component for displaying card details and managing
//// task creation within a card context.
////
//// ## Responsibilities
//// - Fetch and display tasks belonging to a card
//// - Handle "Add Task" form with local state
//// - Emit events to parent for refresh and close actions
////
//// ## Relations
//// - Parent: features/fichas/view.gleam renders this component
//// - API: api/tasks.gleam for fetching/creating tasks

import gleam/dynamic.{type Decoder}
import gleam/int
import gleam/json
import gleam/result
import lustre
import lustre/component

// Internal Model - encapsulated state
pub type Model {
  Model(
    card_id: Option(Int),
    card: Option(Card),
    locale: Locale,
    tasks: Remote(List(Task)),
    add_task_open: Bool,
    add_task_title: String,
    add_task_priority: Int,
    add_task_in_flight: Bool,
    add_task_error: Option(String),
  )
}

// Internal Msg - not exposed to parent
pub type Msg {
  // From attributes/properties
  CardIdReceived(Int)
  CardReceived(Card)
  LocaleReceived(Locale)
  // Internal state
  TasksFetched(ApiResult(List(Task)))
  ToggleAddTaskForm
  TitleInput(String)
  PrioritySelect(Int)
  CancelAddTask
  SubmitAddTask
  TaskCreated(ApiResult(Task))
  CloseClicked
}

/// Register the component. Call this once at app init.
/// Returns Result to handle registration errors.
pub fn register() -> Result(Nil, lustre.Error) {
  // NOTE: Verify exact API in Task 0 spike
  lustre.component(init, update, view, on_attribute_change())
  |> lustre.register("card-detail-modal")
}

fn on_attribute_change() -> Dict(String, Decoder(Msg)) {
  dict.from_list([
    #("card-id", fn(s) {
      int.parse(s)
      |> result.map(CardIdReceived)
    }),
    #("locale", fn(s) {
      locale.parse(s)
      |> result.map(LocaleReceived)
    }),
  ])
}
```

### Parent Integration Pattern

```gleam
// In features/fichas/view.gleam
fn view_card_detail_modal(model: Model) -> Element(Msg) {
  case model.card_detail_open {
    option.None -> element.none()
    option.Some(card_id) -> {
      // Find the card data
      let card = find_card(model, card_id)

      html.node("card-detail-modal", [
        // Attributes (strings)
        attribute.attribute("card-id", int.to_string(card_id)),
        attribute.attribute("locale", locale.to_string(model.locale)),
        // Properties (JSON)
        attribute.property("card", card_to_json(card)),
        // Event listeners
        event.on("task-created", fn(_) { Ok(MemberRefreshTasks) }),
        event.on("close-requested", fn(_) { Ok(CloseCardDetail) }),
      ], [])
    }
  }
}
```

### State Fields to Remove from Root Model

| Field | Type | Action |
|-------|------|--------|
| `card_detail_open` | `Option(Int)` | **KEEP** - needed for conditional rendering |
| `card_detail_tasks` | `Remote(List(Task))` | REMOVE - component fetches internally |
| `card_add_task_open` | `Bool` | REMOVE |
| `card_add_task_title` | `String` | REMOVE |
| `card_add_task_priority` | `Int` | REMOVE |
| `card_add_task_in_flight` | `Bool` | REMOVE |
| `card_add_task_error` | `Option(String)` | REMOVE |

**Net reduction: 6 fields** (not 7 as originally stated)

### Msg Variants to Remove from Root Msg

| Variant | Action |
|---------|--------|
| `OpenCardDetail(Int)` | **KEEP** - parent navigation |
| `CloseCardDetail` | **KEEP** - parent receives close event |
| `CardDetailTasksFetched` | REMOVE |
| `ToggleAddTaskForm` | REMOVE |
| `CardAddTaskTitleInput` | REMOVE |
| `CardAddTaskPrioritySelect` | REMOVE |
| `CancelAddTask` | REMOVE |
| `SubmitAddTask` | REMOVE |
| `CardAddTaskCreated` | REMOVE |

**Net reduction: 7 variants** (not 9 as originally stated)

### i18n Inside Component

The component cannot depend on `update_helpers.i18n_t(model, ...)` because it doesn't have access to the parent Model. Solution:

```gleam
// Internal i18n helper
fn t(locale: Locale, key: i18n_text.TextKey) -> String {
  case locale {
    locale.En -> i18n_text.en(key)
    locale.Es -> i18n_text.es(key)
  }
}

// Usage in view
text(t(model.locale, i18n_text.CardTasks))
```

### Coding Standards Reminder

- **Lustre Components**: This is the first component in the codebase; document the pattern thoroughly
- **Pure views**: `view` must be pure, no effects
- **Effects in update**: API calls originate from `update`
- **No dead code**: Completely remove, don't comment out
- **Module docs**: Add `//// Mission, Responsibilities, Relations` to new component
- **Type safety**: Use proper decoders for attributes/properties, handle parse errors

---

## Testing

### Test File Location
- `apps/client/test/card_detail_modal_test.gleam`

### Test Standards
- Use `gleeunit` for assertions
- Test naming: `function_condition_expected_result_test()`
- Test state transitions AND effects produced

### Testing Patterns

```gleam
// State transition test
pub fn toggle_add_task_form_opens_when_closed_test() {
  let model = init_model()
  let #(new_model, _effect) = update(model, ToggleAddTaskForm)

  new_model.add_task_open
  |> should.be_true
}

// Effect verification test
pub fn submit_add_task_produces_http_effect_test() {
  let model = Model(
    ..init_model(),
    card_id: option.Some(42),
    add_task_title: "New Task",
    add_task_priority: 3,
  )
  let #(new_model, effect) = update(model, SubmitAddTask)

  // Verify in-flight state
  new_model.add_task_in_flight
  |> should.be_true

  // Verify effect is not none
  effect
  |> should.not_equal(effect.none())
}

// Card ID change triggers fetch test
pub fn card_id_received_triggers_task_fetch_test() {
  let model = init_model()
  let #(new_model, effect) = update(model, CardIdReceived(42))

  new_model.card_id
  |> should.equal(option.Some(42))

  new_model.tasks
  |> should.equal(Loading)

  effect
  |> should.not_equal(effect.none())
}
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-20 | 0.1 | Initial draft | Sarah (PO Agent) |
| 2026-01-20 | 0.2 | Architectural review corrections: fixed API patterns, clarified parent state, added Task 0 spike, corrected field counts | Winston (Architect) |

---

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

---

## QA Results

_To be filled by QA agent_
