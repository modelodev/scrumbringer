# Story 5.4: Patrones de Uso de Notas en Tareas

## Status

Ready

## Story

**As a** miembro del equipo (humano o agente AI),
**I want** usar notas de tareas de forma inteligente para comunicar progreso y entregar trabajo sin fricción,
**so that** el equipo puede seguir el estado de una tarea de forma visual y asíncrona.

## Acceptance Criteria

### Funcionales - Inteligencia de Notas

1. **AC1**: El sistema detecta automáticamente URLs en el texto de las notas y las hace clickables.
2. **AC2**: Los links a GitHub (PR, Issue, Commit) muestran un icono de GitHub y una ruta corta legible.
3. **AC3**: Las notas que contienen links a Pull Requests se destacan visualmente (ej. borde verde) para indicar "Entrega" de forma automática.

### Funcionales - Visualización e Indicadores

4. **AC4**: El indicador visual `[!]` aparece en la lista de tareas y en el Pool (Kanban) si hay notas con `created_at` posterior a `last_viewed_at` para el usuario.
5. **AC5**: El indicador desaparece inmediatamente cuando el usuario abre el detalle de la tarea (limpieza por lectura personal).

### API

6. **AC6**: `PUT /api/v1/views/tasks/:id` - Marca la tarea como "leída" para el usuario actual (actualiza el timestamp de última vista).

### Modelo de Datos

7. **AC7**: Tabla `user_task_views` con: `user_id, task_id, last_viewed_at` (PK compuesta). Gestiona el tracking individual de notificaciones leídas.

## Tasks / Subtasks

- [ ] Database (AC: 7)
  - [ ] Crear migración para la tabla `user_task_views`.
- [ ] Domain - Link Detection (AC: 1, 2, 3)
  - [ ] Implementar detector de URLs inteligente en el paquete `shared` para compatibilidad SSR.
  - [ ] Definir lógica de "Highlight automático" si se detecta un link de PR.
- [ ] Backend (AC: 6)
  - [ ] Implementar endpoint de "view tracking" para tareas.
- [ ] Frontend UI - Indicators (AC: 4, 5)
  - [ ] Implementar lógica de limpieza de indicador `[!]` al abrir el detalle (usando el nuevo endpoint).
- [ ] Añadir el indicador visual en el Pool (Kanban) y listados.
- [ ] Comportamiento esperado sin realtime: el indicador se actualiza tras refresh o reapertura del detalle.
- [ ] Frontend UI - Rendering
  - [ ] Actualizar `ui/notes_list.gleam` para renderizar links bonitos y aplicar estilos automáticos según el contenido.

## Dev Notes

### Relevant Source Tree info
- Task views: `apps/client/src/scrumbringer_client/features/tasks/`.
- Kanban view: `apps/client/src/scrumbringer_client/features/views/kanban_board.gleam`.

### Technical Context
- **Lustre SSR**: La detección de links debe ser determinista para evitar parpadeos en la hidratación.
- **Performance**: El cálculo de "leído/no leído" se hace comparando el `created_at` de la nota más reciente con el `last_viewed_at` del usuario para esa entidad.
- **Shared Note Struct**: Se recomienda un tipo `Note` compartido en `shared` solo para representación interna (sin campo de tipo asociado).

### Testing Standards
- Validar la detección de URLs GitHub y el resaltado automático de PRs.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-28 | 1.0 | Initial story creation | Sarah (PO) |
| 2026-01-28 | 1.2 | Removed manual templates, focused on Auto-link detection and Option B Tracking | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
{{agent_model_name_version}}

### Debug Log References
- 

### Completion Notes List
- 

### File List
- 

## QA Results

### Review Date: [Date]
### Reviewed By: Quinn (Test Architect)

### Gate Status
Gate: PENDING
