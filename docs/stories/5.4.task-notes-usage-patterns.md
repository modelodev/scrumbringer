# Story 5.4: Patrones de Uso de Notas en Tareas

## Status

Draft

## Story

**As a** miembro del equipo (humano o agente AI),
**I want** usar notas de tareas de forma estructurada para comunicar progreso y entregar trabajo,
**so that** el equipo puede seguir el estado de una tarea sin necesidad de reuniones sincronas.

## Problem Statement

Las notas de tareas existen (Story 1.6), pero no hay patrones establecidos para su uso. Esto causa:
- Notas sin contexto ("done", "WIP")
- Links a PRs/commits sin formato consistente
- Agentes AI que no saben que informacion incluir
- PMs que no pueden extraer metricas de las notas

### Vision: Notas como Canal de Comunicacion

Las notas deben servir como el canal principal de comunicacion asincrona:
1. **Progreso**: "Empezando trabajo en X"
2. **Bloqueos**: "Bloqueado por dependencia Y"
3. **Entrega**: "PR listo: https://..."
4. **Preguntas**: "Necesito clarificacion sobre Z"

---

## Acceptance Criteria

### Funcionales - Templates de Notas

1. **AC1**: Al crear una nota, el usuario puede seleccionar un template o escribir libre
2. **AC2**: Templates disponibles:
   - Progreso: "Trabajando en: [descripcion]"
   - Bloqueo: "Bloqueado por: [razon]"
   - Entrega: "Entregado: [link] | [descripcion]"
   - Pregunta: "Pregunta: [texto]"
3. **AC3**: Los templates son sugerencias, el usuario puede modificar el texto

### Funcionales - Deteccion de Links

4. **AC4**: Las notas detectan URLs y las convierten en links clickables
5. **AC5**: Links a GitHub (PR, Issue, Commit) muestran preview con icono GitHub
6. **AC6**: Links genericos muestran dominio como texto del link

### Funcionales - Visualizacion

7. **AC7**: Las notas con link de entrega se destacan visualmente (borde verde)
8. **AC8**: Las notas con bloqueo se destacan visualmente (borde amarillo)
9. **AC9**: En la lista de tareas, se muestra indicador si tiene notas recientes (< 24h)

### API

10. **AC10**: Nuevo campo opcional en POST nota: `{ content, note_type?: "progress"|"blocked"|"delivery"|"question" }`
11. **AC11**: GET notas incluye `note_type` si fue especificado

### i18n

12. **AC12**: Templates y labels en ES/EN

---

## UX Design

### Wireframe: Crear Nota con Templates

```
+--------------------------------------------------+
| NUEVA NOTA                                       |
+--------------------------------------------------+
| Tipo: [Libre v]                                  |
|       +------------------+                       |
|       | Libre            |                       |
|       | Progreso         |                       |
|       | Bloqueo          |                       |
|       | Entrega          |                       |
|       | Pregunta         |                       |
|       +------------------+                       |
|                                                  |
| [                                             ]  |
| [                                             ]  |
|                                                  |
|                              [Cancelar] [AÃ±adir] |
+--------------------------------------------------+
```

### Wireframe: Nota de Entrega (destacada)

```
+--------------------------------------------------+
| Bob Agent - hace 2h                    ENTREGA   |
+--------------------------------------------------+
| PR listo para review:                            |
| [GH] github.com/org/repo/pull/42                 |
|                                                  |
| Incluye:                                         |
| - Migracion de auth module                       |
| - Tests para edge cases                          |
+--------------------------------------------------+
```

### Wireframe: Indicador en Lista

```
+--------------------------------------------------+
| [Bug] Fix login timeout        Alice   [!] 2 notas nuevas
| [Feature] Add dark mode        -
| [Task] Refactor auth           Bob     [!] 1 nota nueva (bloqueo)
+--------------------------------------------------+
```

---

## Technical Notes

### Backend

**Modificar tabla task_notes:**
```sql
ALTER TABLE task_notes
ADD COLUMN note_type VARCHAR(20) DEFAULT NULL;
-- Valores: 'progress', 'blocked', 'delivery', 'question', NULL (libre)
```

**Modificar API:**
- POST acepta `note_type` opcional
- GET retorna `note_type` en cada nota

### Frontend

**Archivos a modificar:**
- `features/tasks/notes_section.gleam` - Templates y visualizacion
- `components/link_preview.gleam` - NUEVO: Componente para preview de links
- `utils/url_detector.gleam` - NUEVO: Detectar y parsear URLs en texto

**Logica de deteccion de URLs:**
```gleam
/// Detecta URLs en texto y retorna segmentos
pub fn parse_text_with_urls(text: String) -> List(TextSegment) {
  // regex: https?://[^\s]+
  // retorna: [Text("..."), Url("https://..."), Text("...")]
}

/// Identifica tipo de link
pub fn classify_url(url: String) -> UrlType {
  case url {
    _ if string.contains(url, "github.com/") -> GitHubUrl(parse_github_url(url))
    _ -> GenericUrl(url)
  }
}
```

---

## Out of Scope

- Notificaciones push cuando hay nueva nota
- Responder a una nota especifica (threading)
- Reacciones (emojis) en notas
- Rich text / Markdown completo

---

## Dependencias

- Story 1.6 (Notes and Positions) - Completada

---

## Consideraciones para Agentes AI

Un agente AI deberia:
1. Usar template "Progreso" al empezar trabajo
2. Usar template "Bloqueo" si encuentra impedimentos
3. Usar template "Entrega" con link al PR/commit al terminar
4. Usar template "Pregunta" si necesita clarificacion humana

El sistema NO automatiza esto - el agente decide.

---

## Risk Assessment

- **Primary Risk:** Over-engineering de una feature simple
- **Mitigation:** Templates son opcionales, no obligatorios
- **Secondary Risk:** Usuarios ignoran templates y escriben libre
- **Mitigation:** Esta bien, el valor esta en la deteccion de links y visualizacion

