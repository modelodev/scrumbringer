# Story 5.4: Patrones de Uso de Notas en Tareas

## Status

Done

## Story

**As a** miembro del equipo (humano o agente AI),
**I want** usar notas de tareas de forma inteligente para comunicar progreso y entregar trabajo sin fricción,
**so that** el equipo puede seguir el estado de una tarea de forma visual y asíncrona.

## Acceptance Criteria

### Funcionales - Inteligencia de Notas

1. **AC1**: El sistema detecta automáticamente URLs en el texto de las notas y las hace clickables.
2. **AC2**: Los links a GitHub (PR, Issue, Commit) muestran un icono de GitHub y una ruta corta legible.
3. **AC3**: Las notas que contienen links a Pull Requests se destacan visualmente (ej. borde verde) para indicar "Entrega" de forma automática.

### Funcionales - Visualización e Indicadores

4. **AC4**: El indicador visual `[!]` aparece en la lista de tareas y en el Pool (Kanban) si hay notas con `created_at` posterior a `last_viewed_at` para el usuario.
5. **AC5**: El indicador desaparece inmediatamente cuando el usuario abre el detalle de la tarea (limpieza por lectura personal).

### API

6. **AC6**: `PUT /api/v1/views/tasks/:id` - Marca la tarea como "leída" para el usuario actual (actualiza el timestamp de última vista).

### Modelo de Datos

7. **AC7**: Tabla `user_task_views` con: `user_id, task_id, last_viewed_at` (PK compuesta). Gestiona el tracking individual de notificaciones leídas.

## Tasks / Subtasks

- [x] Database (AC: 7)
  - [x] Crear migración para la tabla `user_task_views`.
- [x] Domain - Link Detection (AC: 1, 2, 3)
  - [x] Implementar detector de URLs inteligente en el paquete `shared` para compatibilidad SSR.
  - [x] Definir lógica de "Highlight automático" si se detecta un link de PR.
- [x] Backend (AC: 6)
  - [x] Implementar endpoint de "view tracking" para tareas.
- [x] Frontend UI - Indicators (AC: 4, 5)
  - [x] Implementar lógica de limpieza de indicador `[!]` al abrir el detalle (usando el nuevo endpoint).
- [x] Añadir el indicador visual en el Pool (Kanban) y listados.
- [x] Comportamiento esperado sin realtime: el indicador se actualiza tras refresh o reapertura del detalle.
- [x] Frontend UI - Rendering
  - [x] Actualizar `ui/notes_list.gleam` para renderizar links bonitos y aplicar estilos automáticos según el contenido.

## Dev Notes

### Relevant Source Tree info
- Task views: `apps/client/src/scrumbringer_client/features/tasks/`.
- Kanban view: `apps/client/src/scrumbringer_client/features/views/kanban_board.gleam`.

### Technical Context
- **Lustre SSR**: La detección de links debe ser determinista para evitar parpadeos en la hidratación.
- **Performance**: El cálculo de "leído/no leído" se hace comparando el `created_at` de la nota más reciente con el `last_viewed_at` del usuario para esa entidad.
- **Shared Note Struct**: Se recomienda un tipo `Note` compartido en `shared` solo para representación interna (sin campo de tipo asociado).

### Testing Standards
- Validar la detección de URLs GitHub y el resaltado automático de PRs.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-28 | 1.0 | Initial story creation | Sarah (PO) |
| 2026-01-28 | 1.2 | Removed manual templates, focused on Auto-link detection and Option B Tracking | Sarah (PO) |
| 2026-01-29 | 1.3 | Implementation complete - all ACs implemented with tests | James (Dev) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
- N/A

### Completion Notes List
- AC7: Created `user_task_views` table with composite PK (user_id, task_id) and last_viewed_at timestamp
- AC6: Implemented `PUT /api/v1/views/tasks/:id` endpoint with auth/CSRF/authorization checks
- AC1-3: Implemented link detection in `shared/src/domain/link_detection.gleam` with full test coverage
- AC1: Generic URLs detected and rendered as clickable links
- AC2: GitHub PR/Issue/Commit URLs display with code icon and short path (owner/repo#number)
- AC3: Notes containing PR links highlighted with green border (.note-delivery class)
- AC4-5: Added `has_new_notes` field to Task type and API, calculated from user_task_views table
- All tests pass: Server (256), Client (449), Shared (87)
- FIX: Integrated `notes_list.gleam` into `pool/dialogs.gleam` for task notes rendering (AC1-3 visual validation)

### File List
- db/migrations/20260129100000_create_user_task_views.sql (new)
- apps/server/src/scrumbringer_server/sql/user_task_views_upsert.sql (new)
- apps/server/src/scrumbringer_server/sql/tasks_list.sql (modified - added has_new_notes)
- apps/server/src/scrumbringer_server/services/user_task_views_db.gleam (new)
- apps/server/src/scrumbringer_server/http/task_views.gleam (new)
- apps/server/src/scrumbringer_server/web/router.gleam (modified)
- apps/server/src/scrumbringer_server/persistence/tasks/mappers.gleam (modified - added has_new_notes)
- apps/server/src/scrumbringer_server/persistence/tasks/queries.gleam (modified - user_id param)
- apps/server/src/scrumbringer_server/http/tasks/presenters.gleam (modified - added has_new_notes to JSON)
- shared/src/domain/link_detection.gleam (new)
- shared/src/domain/task.gleam (modified - added has_new_notes field)
- shared/gleam.toml (modified - added gleam_regexp dependency)
- shared/test/link_detection_test.gleam (new)
- apps/client/src/scrumbringer_client/ui/notes_list.gleam (modified - link rendering)
- apps/client/src/scrumbringer_client/ui/icons.gleam (modified - added GitHub, ExternalLink icons)
- apps/client/src/scrumbringer_client/styles.gleam (modified - added note link styles)
- apps/client/src/scrumbringer_client/api/tasks/decoders.gleam (modified - decode has_new_notes)
- apps/client/src/scrumbringer_client/api/metrics.gleam (modified - has_new_notes field)
- apps/client/src/scrumbringer_client/components/card_detail_modal.gleam (modified - has_new_notes field)
- apps/client/test/grouped_list_task_item_test.gleam (modified - has_new_notes field)
- apps/client/test/kanban_task_item_test.gleam (modified - has_new_notes field)
- apps/client/test/right_panel_tasks_test.gleam (modified - has_new_notes field)
- apps/client/test/update_helpers_test.gleam (modified - has_new_notes field)
- apps/client/src/scrumbringer_client/features/pool/dialogs.gleam (modified - integrated notes_list.gleam for AC1-3)

## QA Results

### Review Date: 2026-01-29
### Reviewed By: Quinn (Test Architect)

### Gate Status
Gate: PASS

### Summary
All ACs verified with Playwright visual validation. AC1-3 now integrated via `notes_list.gleam` in `pool/dialogs.gleam`.

### Test Results
- **Shared**: 87 passed, 0 failures
- **Client**: 449 passed, 0 failures
- **Server**: 256 passed, 0 failures
- **Lint**: All packages compile without warnings

### Visual Validation (Playwright)
- Logged in and navigated to Pool/Tarjetas views
- Added note with GitHub PR URL: `https://github.com/anthropics/claude-code/pull/42`
- **Result**: URL rendered as clickable link with GitHub icon and green border

### AC Verification
| AC | Status | Evidence |
|----|--------|----------|
| AC1 | PASS | `.note-link` elements found (count: 2) - URLs clickable |
| AC2 | PASS | `.github-link` elements found (count: 2) - GitHub icon displayed |
| AC3 | PASS | `.note-delivery` elements found (count: 2) - PR notes have green border |
| AC4 | PASS | `.card-notes-indicator` found (count: 1) |
| AC5 | PASS | PUT endpoint updates `last_viewed_at`, clearing indicator on next fetch |
| AC6 | PASS | `PUT /api/v1/views/tasks/:id` with auth/CSRF/authorization, returns 204 |
| AC7 | PASS | Migration creates `user_task_views` table with composite PK and proper indexes |

### NFR Validation
- **Security**: PASS - Full auth stack with CSRF and project membership checks
- **Performance**: PASS - Efficient SQL subqueries and compiled regex
- **Reliability**: PASS - All ACs verified visually
- **Maintainability**: PASS - Consistent note rendering using shared `notes_list.gleam`

### Gate File
See: `docs/qa/gates/5.4-task-notes-usage-patterns.yml`
