# Story 2.1: Invites por link (crear/listar/regenerar por email)

## Status
Done

## Story
**As an** org admin,
**I want** to create invite links tied to a specific email (and list/regenerate them),
**so that** I can onboard users without sharing raw invite tokens and with deterministic invalidation.

## Acceptance Criteria
1. **Create invite link**: `POST /api/v1/org/invite-links` creates an invite link for a specific email.
   - Auth: org admin only.
   - CSRF: required (double-submit).
   - Body: `{ email }`.
   - Response: `200` `{ data: { invite_link } }`.
   - `invite_link` includes `{ email, token, url_path, state, created_at }` (at minimum: `token` + `url_path`; no absolute URL).
2. **List invite links**: `GET /api/v1/org/invite-links` lists invite links for the org.
   - Auth: org admin only.
   - Sorting: `email ASC`.
   - Response: `200` `{ data: { invite_links: InviteLink[] } }`.
3. **Regenerate invite link**: `POST /api/v1/org/invite-links/regenerate` regenerates the token for an email.
   - Auth: org admin only.
   - CSRF: required.
   - Body: `{ email }`.
   - Response: `200` `{ data: { invite_link } }`.
   - `invite_link` includes `{ email, token, url_path, state, created_at }` (at minimum: `token` + `url_path`; no absolute URL).
4. **Single active token per email**: creating or regenerating an invite link for a given `email` invalidates any previous *active* token for the same `email`.
5. **No time expiry**: invite link tokens do **not** expire by time (no `expires_at`-based enforcement).
6. **Token state**: an invite link token has an observable state in the API (at minimum distinguishable as `active | used | invalidated`).
7. **No SMTP/email integration**: the API returns `token` + `url_path` so the admin UI can show/copy a usable link (composed client-side); the server does not send emails.
8. **URL format (fixed)**: `url_path` uses query form: `/accept-invite?token=...`.
9. **Email normalization**: `email` is normalized as `trim + lowercase` for uniqueness and invalidation rules.
10. **Listing scope**: list endpoint includes links in any state (`active|used|invalidated`).
11. **Regenerate behavior**: regenerate creates a new active token even if no prior invite link exists for that email (previous active token, if any, is invalidated).
12. **Response conventions**: envelopes and error shapes follow `docs/architecture/api-contract.md`.

## Tasks / Subtasks
- [x] Add/extend API contract entries for invite links (AC: 1, 2, 3, 5, 8)
  - [x] Document suggested routes and authz/CSRF rules in `docs/architecture/api-contract.md` (AC: 8)
- [x] Implement persistence for invite links (AC: 4, 5, 6)
  - [x] Store token + email + org_id + created_at + used_at? + invalidated_at? (AC: 6)
  - [x] Ensure uniqueness constraints support “single active token per email” (AC: 4)
- [x] Implement `POST /api/v1/org/invite-links` (AC: 1, 4, 5, 6)
  - [x] Validate email format (422 `VALIDATION_ERROR`) (AC: 1)
  - [x] Enforce org-admin authz and CSRF (AC: 1)
  - [x] Invalidate previous active token for same email, then create new active token (AC: 4)
- [x] Implement `GET /api/v1/org/invite-links` (AC: 2)
  - [x] Enforce org-admin authz (AC: 2)
  - [x] Return sorted by `email ASC` (AC: 2)
- [x] Implement `POST /api/v1/org/invite-links/regenerate` (AC: 3, 4)
  - [x] Enforce org-admin authz and CSRF (AC: 3)
  - [x] Invalidate previous active token and return new token for same email (AC: 4)
- [x] Update Admin UI to use invite links (AC: 7)
  - [x] Add email input + “Create/Regenerate” flow and show the generated link with copy-to-clipboard feedback (AC: 7)
  - [x] Add list view for existing invite links (AC: 2)
- [x] Add tests (AC: 1, 2, 3, 4, 5)
  - [x] Authz: non-org-admin gets `403 FORBIDDEN` (AC: 1, 2, 3)
  - [x] CSRF: missing/mismatch rejected for POSTs (AC: 1, 3)
  - [x] Invalidation: old token becomes unusable after regenerate/create for same email (AC: 4)
  - [x] No expiry-by-time behavior (AC: 5)

## Dev Notes
### Scope note
- This story is **about issuing and managing invite links** (create/list/regenerate). Consuming/accepting the invite link and registration UX is Story 2.2.

### Source of truth
- Product context (invite-only onboarding exists, single org model): `docs/brief.md` (see “Scope Organizacional (MVP)” and “Auth”).
- API envelope, auth cookies, CSRF double-submit, and error shape conventions: `docs/architecture/api-contract.md` (see “Conventions”, “Auth & Security”, “CSRF (Double-submit)”, “Response Envelope”).

### Suggested endpoints (new)
- `POST /api/v1/org/invite-links`
- `GET /api/v1/org/invite-links`
- `POST /api/v1/org/invite-links/regenerate`

### Token guidance
- Reuse the existing token guidance style from org invites: treat token as opaque, URL-safe random data (entropy-first).
  [Source: `docs/architecture/api-contract.md` “Invites (invite-only registration)” notes]

## Testing
- Server: `make test`
- Client: `apps/client: gleam test`

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-14 | 1.0 | Initial draft | po |
| 2026-01-14 | 1.1 | Ready for dev (DoR passed; url_path/email normalization/regen behavior fixed) | po |
| 2026-01-14 | 1.2 | Implemented invite-link persistence, endpoints, admin UI, and tests | dev |

## Dev Agent Record

### Agent Model Used
- GPT-5.2 (Codex CLI)

### Debug Log References
- `make squirrel` (generated Squirrel `apps/server/src/scrumbringer_server/sql.gleam`)
- `make test` (server: 44 passed)
- `apps/client: gleam test` (client: 11 passed)

### Completion Notes List
- Added invite-link persistence via `org_invite_links` with a partial unique index to enforce “single active token per email” (active = `used_at is null` and `invalidated_at is null`).
- Implemented invite-link endpoints with org-admin authz and CSRF double-submit enforcement:
  - `POST /api/v1/org/invite-links`
  - `GET /api/v1/org/invite-links` (sorted `email ASC`)
  - `POST /api/v1/org/invite-links/regenerate`
- Normalized emails (`trim + lowercase`) and added basic email format validation (422 `VALIDATION_ERROR`).
- Updated Admin UI “Invites” section to create/regenerate/list invite links and copy a usable URL composed client-side from `window.location.origin` + `url_path`.

### File List
- `Makefile` (modified)
- `db/migrations/20260114100000_create_org_invite_links.sql` (new)
- `apps/server/src/scrumbringer_server.gleam` (modified)
- `apps/server/src/scrumbringer_server/sql.gleam` (modified; generated)
- `apps/server/src/scrumbringer_server/sql/org_invite_links_list.sql` (new)
- `apps/server/src/scrumbringer_server/sql/org_invite_links_upsert.sql` (new)
- `apps/server/src/scrumbringer_server/http/org_invite_links.gleam` (new)
- `apps/server/src/scrumbringer_server/services/org_invite_links_db.gleam` (new)
- `apps/server/test/org_invite_links_http_test.gleam` (new)
- `apps/client/src/scrumbringer_client.gleam` (modified)
- `apps/client/src/scrumbringer_client/api.gleam` (modified)
- `apps/client/src/scrumbringer_client/fetch.ffi.mjs` (modified)
- `apps/client/test/api_decode_invite_links_test.gleam` (new)

### DoD Checklist
- [x] Requirements met: all ACs implemented (create/list/regenerate + invalidation + no expiry + state + client-side URL composition).
- [x] Coding standards / structure: new modules follow existing `apps/server/src/scrumbringer_server/{http,services,sql}` patterns.
- [x] Tests added and passing: `make test` (server 44 passed) and `apps/client: gleam test` (client 11 passed).
- [ ] Manual verification: not manually exercised via browser UI in this session (covered via server HTTP tests + client decoder tests).
- [x] Story admin: tasks checked, Dev Agent Record + Change Log updated.
- [x] Build/deps: no new dependencies added.

## QA Results

### Review Date: 2026-01-14

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Implementation matches the intent: email-bound invite links with deterministic invalidation and no time expiry. The server enforces org-admin authorization and CSRF double-submit for mutations, and the client composes a copyable link from `origin + url_path` (no server absolute URL).

### Refactoring Performed

- **File**: `apps/server/test/org_invite_links_http_test.gleam`
  - **Change**: Added missing coverage for regenerate success, invalid email (422), and list including invalidated links.
  - **Why**: Close functional and security-adjacent gaps at low cost.
  - **How**: Expanded server-level HTTP tests and JSON decoding assertions.

### Compliance Check

- Coding Standards: ✓
- Project Structure: ✓
- Testing Strategy: ✓ (server tests + client decoder tests)
- All ACs Met: ✓ (note: `used` state is exercised in Story 2.2)

### Improvements Checklist

- [x] Added/verified tests for create/list/regenerate flows (`apps/server/test/org_invite_links_http_test.gleam`)
- [x] Verified test runs: `make test` (server: 47 passed) + `apps/client: gleam test` (client: 11 passed)
- [ ] Confirm `Makefile` default `DATABASE_URL` target (dev vs test) to avoid environment/CI confusion
- [ ] Add/verify invite-link validation + `used` state coverage when implementing Story 2.2

### Security Review

- Authz + CSRF enforcement present for invite-link mutations.
- Email normalization reduces ambiguity.
- No rate limiting (acceptable for MVP, consider later if needed).

### Performance Considerations

- Indexed lookups; list is org-scoped and `email ASC`.

### Files Modified During Review

- `apps/server/test/org_invite_links_http_test.gleam`

### Gate Status

Gate: PASS → `docs/qa/gates/2.1-invites-by-link.yml`
Risk profile: `docs/qa/assessments/2.1-risk-20260114.md`
NFR assessment: `docs/qa/assessments/2.1-nfr-20260114.md`

### Recommended Status

[✗ Changes Required - See unchecked items above]
(Story owner decides final status)

---

### Review Date: 2026-01-14 (Follow-up)

### Reviewed By: Quinn (Test Architect)

### Updates

- Resolved the prior maintainability concern by clarifying `Makefile` database expectations and switching migrations to `dbmate migrate` (no implicit DB creation).

### Gate Status

Gate: PASS → `docs/qa/gates/2.1-invites-by-link.yml`

### Recommended Status

[✓ Ready for Done]
(Story owner decides final status)
