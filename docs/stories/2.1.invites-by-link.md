# Story 2.1: Invites por link (crear/listar/regenerar por email)

## Status: Draft

## Story
**As an** org admin,
**I want** to create invite links tied to a specific email (and list/regenerate them),
**so that** I can onboard users without sharing raw invite codes and with deterministic invalidation.

## Acceptance Criteria
1. **Create invite link**: `POST /api/v1/org/invite-links` creates an invite link for a specific email.
   - Auth: org admin only.
   - CSRF: required (double-submit).
   - Body: `{ email }`.
   - Response: `200` `{ data: { invite_link } }`.
2. **List invite links**: `GET /api/v1/org/invite-links` lists invite links for the org.
   - Auth: org admin only.
   - Sorting: `email ASC`.
   - Response: `200` `{ data: { invite_links: InviteLink[] } }`.
3. **Regenerate invite link**: `POST /api/v1/org/invite-links/regenerate` regenerates the token for an email.
   - Auth: org admin only.
   - CSRF: required.
   - Body: `{ email }`.
   - Response: `200` `{ data: { invite_link } }`.
4. **Single active token per email**: creating or regenerating an invite link for a given `email` invalidates any previous *active* token for the same `email`.
5. **No time expiry**: invite link tokens do **not** expire by time (no `expires_at`-based enforcement).
6. **Token state**: an invite link token has an observable state in the API (at minimum distinguishable as `active | used | invalidated`).
7. **No SMTP/email integration**: the API returns enough information for the admin UI to show/copy a usable link; the server does not send emails.
8. **Response conventions**: envelopes and error shapes follow `docs/architecture/api-contract.md`.

## Tasks / Subtasks
- [ ] Add/extend API contract entries for invite links (AC: 1, 2, 3, 5, 8)
  - [ ] Document suggested routes and authz/CSRF rules in `docs/architecture/api-contract.md` (AC: 8)
- [ ] Implement persistence for invite links (AC: 4, 5, 6)
  - [ ] Store token + email + org_id + created_at + used_at? + invalidated_at? (AC: 6)
  - [ ] Ensure uniqueness constraints support “single active token per email” (AC: 4)
- [ ] Implement `POST /api/v1/org/invite-links` (AC: 1, 4, 5, 6)
  - [ ] Validate email format (422 `VALIDATION_ERROR`) (AC: 1)
  - [ ] Enforce org-admin authz and CSRF (AC: 1)
  - [ ] Invalidate previous active token for same email, then create new active token (AC: 4)
- [ ] Implement `GET /api/v1/org/invite-links` (AC: 2)
  - [ ] Enforce org-admin authz (AC: 2)
  - [ ] Return sorted by `email ASC` (AC: 2)
- [ ] Implement `POST /api/v1/org/invite-links/regenerate` (AC: 3, 4)
  - [ ] Enforce org-admin authz and CSRF (AC: 3)
  - [ ] Invalidate previous active token and return new token for same email (AC: 4)
- [ ] Update Admin UI to use invite links (AC: 7)
  - [ ] Add email input + “Create/Regenerate” flow and show the generated link with copy-to-clipboard feedback (AC: 7)
  - [ ] Add list view for existing invite links (AC: 2)
- [ ] Add tests (AC: 1, 2, 3, 4, 5)
  - [ ] Authz: non-org-admin gets `403 FORBIDDEN` (AC: 1, 2, 3)
  - [ ] CSRF: missing/mismatch rejected for POSTs (AC: 1, 3)
  - [ ] Invalidation: old token becomes unusable after regenerate/create for same email (AC: 4)
  - [ ] No expiry-by-time behavior (AC: 5)

## Dev Notes
### Scope note
- This story is **about issuing and managing invite links** (create/list/regenerate). Consuming/accepting the invite link and registration UX is Story 2.2.

### Source of truth
- Product context (invite-only onboarding exists, single org model): `docs/brief.md` (see “Scope Organizacional (MVP)” and “Auth”).
- API envelope, auth cookies, CSRF double-submit, and error shape conventions: `docs/architecture/api-contract.md` (see “Conventions”, “Auth & Security”, “CSRF (Double-submit)”, “Response Envelope”).

### Suggested endpoints (new)
- `POST /api/v1/org/invite-links`
- `GET /api/v1/org/invite-links`
- `POST /api/v1/org/invite-links/regenerate`

### Token guidance
- Reuse the existing token guidance style from org invites: treat token as opaque, URL-safe random data (entropy-first).
  [Source: `docs/architecture/api-contract.md` “Invites (invite-only registration)” notes]

## Testing
- Server: `make test`
- Client: `apps/client: gleam test`

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-14 | 1.0 | Initial draft | po |

## Dev Agent Record

## QA Results
