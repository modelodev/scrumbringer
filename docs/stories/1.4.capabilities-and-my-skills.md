# Story 1.4: Capabilities + My Skills

## Status
Ready for Review

## Story
**As a** user,
**I want** to view organization capabilities and manage my own selected capabilities,
**so that** I can filter the pool to tasks that match my skills.

## Acceptance Criteria
1. **List capabilities (org-scoped)**: `GET /api/v1/capabilities` returns the organization’s capabilities sorted by `name ASC`.
2. **Create capability (org admin only)**: `POST /api/v1/capabilities` is allowed only for org admins; non-admins are rejected with `403` error code `FORBIDDEN`.
3. **Capability uniqueness**: Capability names are unique within an organization (attempt to create duplicate name in same org is rejected).
4. **Get my selected capabilities**: `GET /api/v1/me/capabilities` returns `200` with `{ data: { capability_ids: number[] } }` for the authenticated user.
5. **Set my selected capabilities**: `PUT /api/v1/me/capabilities` accepts `{ capability_ids: number[] }` and returns `{ data: { capability_ids: number[] } }` reflecting the stored selection.
6. **Replace semantics + clear support**: `PUT /api/v1/me/capabilities` replaces the user’s selection exactly; sending an empty array clears all selections.
7. **No cross-org leakage (negative)**: A user cannot read or modify capabilities that belong to a different organization.

## Tasks / Subtasks
- [x] Implement capability storage and org scoping (AC: 1, 2, 3, 7)
  - [x] Create capabilities with org-scoped uniqueness (AC: 3)
  - [x] Implement `GET /api/v1/capabilities` sorted by `name ASC` (AC: 1)
  - [x] Implement `POST /api/v1/capabilities` with org-admin authz (AC: 2)
- [x] Implement user capability selection (AC: 4, 5, 6, 7)
  - [x] Persist selection in `user_capabilities` join table (AC: 5, 6)
  - [x] Implement `GET /api/v1/me/capabilities` (AC: 4)
  - [x] Implement `PUT /api/v1/me/capabilities` with replace semantics (AC: 5, 6)
- [x] Add tests for scoping, permissions, and replace semantics (AC: 2, 3, 6, 7)
  - [x] Non-admin cannot create capability (`FORBIDDEN`) (AC: 2)
  - [x] Duplicate capability name in same org is rejected (AC: 3)
  - [x] PUT replaces selection and supports clearing with `[]` (AC: 6)

## Dev Notes
Source of truth:
- API contract: `docs/architecture/api-contract.md` (see “Capabilities”, “User Capabilities”, “Conventions → Sorting”, “Auth & Security → Roles”) 
- Data model: `docs/architecture/data-model.md` (see “Capability”, “UserCapability”) 

API behaviors (MVP):
- Capabilities are org-scoped and sorted by `name ASC`.
  [Source: `docs/architecture/api-contract.md` “Capabilities”]
- User capability selection is user-scoped under `/api/v1/me/capabilities` and uses an array of ids.
  [Source: `docs/architecture/api-contract.md` “User Capabilities”]

DB constraints:
- `capabilities` has `UNIQUE(name, org_id)`.
  [Source: `docs/architecture/data-model.md` “Capability”]
- `user_capabilities` primary key is `(user_id, capability_id)`.
  [Source: `docs/architecture/data-model.md` “UserCapability”]

MVP / vNext notes:
- MVP task filtering uses `capability_id` from task type as a **single value** filter when listing tasks.
  [Source: `docs/architecture/api-contract.md` “GET /projects/:project_id/tasks”]
- **vNext:** task listing may accept multiple capability IDs (e.g. `capability_id=1,2,3`). Do not implement multi-value parsing in MVP.
  [Source: `docs/architecture/api-contract.md` “GET /projects/:project_id/tasks” (vNext note)]

### Testing
- Use `gleeunit`.
- Focus tests on:
  - org-admin permission for creating capabilities,
  - uniqueness enforcement,
  - replace semantics for `PUT /me/capabilities`,
  - org scoping guarantees (no leakage).

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-12 | 1.0 | Initial draft | architect |
| 2026-01-12 | 1.1 | Refined story statement, acceptance criteria, tasks, dev notes, and testing focus aligned to capabilities contract (incl. vNext note) | sm |
| 2026-01-13 | 1.2 | Implemented capabilities + my skills endpoints with DB schema, Squirrel queries, and tests | dev |

## Dev Agent Record

### Agent Model Used
GPT-5.2 (Codex CLI)

### Debug Log References
- Applied schema to local test DB (dbmate not installed):
  - `psql "postgres://scrumbringer:scrumbringer@localhost:5433/scrumbringer_test?sslmode=disable" -c "CREATE TABLE capabilities ...; CREATE TABLE user_capabilities ...;"`
- Regenerated Squirrel queries:
  - `DATABASE_URL=postgres://scrumbringer:scrumbringer@localhost:5433/scrumbringer_test?sslmode=disable ../../.tools/gleam-1.14.0/gleam run -m squirrel`
- Server tests:
  - `DATABASE_URL=postgres://scrumbringer:scrumbringer@localhost:5433/scrumbringer_test?sslmode=disable ../../.tools/gleam-1.14.0/gleam test`

### Completion Notes List
- Added `capabilities` and `user_capabilities` tables with org-scoped uniqueness and join-table PK.
- Implemented `GET/POST /api/v1/capabilities` (org-scoped, name-sorted; org-admin-only create; CSRF enforced).
- Implemented `GET/PUT /api/v1/me/capabilities` with replace semantics (empty list clears) and cross-org validation.
- Added HTTP-level tests covering permission checks, uniqueness rejection, replace/clear behavior, and cross-org leakage prevention.

### File List
- Added: `db/migrations/20260113120000_create_capabilities.sql`
- Added: `apps/server/src/scrumbringer_server/http/capabilities.gleam`
- Added: `apps/server/src/scrumbringer_server/services/capabilities_db.gleam`
- Added: `apps/server/src/scrumbringer_server/services/user_capabilities_db.gleam`
- Added: `apps/server/src/scrumbringer_server/sql/capabilities_list.sql`
- Added: `apps/server/src/scrumbringer_server/sql/capabilities_create.sql`
- Added: `apps/server/src/scrumbringer_server/sql/capabilities_is_in_org.sql`
- Added: `apps/server/src/scrumbringer_server/sql/user_capabilities_list.sql`
- Added: `apps/server/src/scrumbringer_server/sql/user_capabilities_delete_all.sql`
- Added: `apps/server/src/scrumbringer_server/sql/user_capabilities_insert.sql`
- Added: `apps/server/test/capabilities_http_test.gleam`
- Modified: `apps/server/src/scrumbringer_server.gleam`
- Modified: `apps/server/src/scrumbringer_server/sql.gleam`

## QA Results

### Review Date: 2026-01-13

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Implementation meets the story requirements: capabilities are org-scoped and name-sorted, creation is org-admin-only and respects uniqueness, and `/me/capabilities` supports replace semantics with cross-org protection. CSRF double-submit is enforced on mutating endpoints.

### Refactoring Performed

- None during QA review.

### Compliance Check

- Coding Standards: ✓ (handlers and DB logic split cleanly)
- Testing Strategy: ✓ (HTTP-level tests cover permission, uniqueness, replace/clear, and cross-org constraints)
- All ACs Met: ✓

### Improvements Checklist

- [x] Verify `GET /api/v1/capabilities` is org-scoped and sorted.
- [x] Verify non-admin cannot create capability (`FORBIDDEN`).
- [x] Verify duplicate name is rejected.
- [x] Verify `PUT /api/v1/me/capabilities` replaces and clears with `[]`.
- [x] Verify cross-org capability IDs are rejected and do not corrupt selection.
- [ ] Align test DB schema setup to always run from migrations (avoid ad-hoc SQL).

### Evidence

- Tests passed:
  - `apps/server`: `DATABASE_URL=postgres://scrumbringer:scrumbringer@localhost:5433/scrumbringer_test?sslmode=disable ../../.tools/gleam-1.14.0/gleam test`

### Gate Status

Gate: PASS → docs/qa/gates/1.4-capabilities-my-skills.yml

### Recommended Status

✓ Ready for Done
