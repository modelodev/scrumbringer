# Story 1.4: Capabilities + My Skills

## Status
Approved

## Story
**As a** user,
**I want** to view organization capabilities and manage my own selected capabilities,
**so that** I can filter the pool to tasks that match my skills.

## Acceptance Criteria
1. **List capabilities (org-scoped)**: `GET /api/v1/capabilities` returns the organization’s capabilities sorted by `name ASC`.
2. **Create capability (org admin only)**: `POST /api/v1/capabilities` is allowed only for org admins; non-admins are rejected with `403` error code `FORBIDDEN`.
3. **Capability uniqueness**: Capability names are unique within an organization (attempt to create duplicate name in same org is rejected).
4. **Get my selected capabilities**: `GET /api/v1/me/capabilities` returns `200` with `{ data: { capability_ids: number[] } }` for the authenticated user.
5. **Set my selected capabilities**: `PUT /api/v1/me/capabilities` accepts `{ capability_ids: number[] }` and returns `{ data: { capability_ids: number[] } }` reflecting the stored selection.
6. **Replace semantics + clear support**: `PUT /api/v1/me/capabilities` replaces the user’s selection exactly; sending an empty array clears all selections.
7. **No cross-org leakage (negative)**: A user cannot read or modify capabilities that belong to a different organization.

## Tasks / Subtasks
- [ ] Implement capability storage and org scoping (AC: 1, 2, 3, 7)
  - [ ] Create capabilities with org-scoped uniqueness (AC: 3)
  - [ ] Implement `GET /api/v1/capabilities` sorted by `name ASC` (AC: 1)
  - [ ] Implement `POST /api/v1/capabilities` with org-admin authz (AC: 2)
- [ ] Implement user capability selection (AC: 4, 5, 6, 7)
  - [ ] Persist selection in `user_capabilities` join table (AC: 5, 6)
  - [ ] Implement `GET /api/v1/me/capabilities` (AC: 4)
  - [ ] Implement `PUT /api/v1/me/capabilities` with replace semantics (AC: 5, 6)
- [ ] Add tests for scoping, permissions, and replace semantics (AC: 2, 3, 6, 7)
  - [ ] Non-admin cannot create capability (`FORBIDDEN`) (AC: 2)
  - [ ] Duplicate capability name in same org is rejected (AC: 3)
  - [ ] PUT replaces selection and supports clearing with `[]` (AC: 6)

## Dev Notes
Source of truth:
- API contract: `docs/architecture/api-contract.md` (see “Capabilities”, “User Capabilities”, “Conventions → Sorting”, “Auth & Security → Roles”) 
- Data model: `docs/architecture/data-model.md` (see “Capability”, “UserCapability”) 

API behaviors (MVP):
- Capabilities are org-scoped and sorted by `name ASC`.
  [Source: `docs/architecture/api-contract.md` “Capabilities”]
- User capability selection is user-scoped under `/api/v1/me/capabilities` and uses an array of ids.
  [Source: `docs/architecture/api-contract.md` “User Capabilities”]

DB constraints:
- `capabilities` has `UNIQUE(name, org_id)`.
  [Source: `docs/architecture/data-model.md` “Capability”]
- `user_capabilities` primary key is `(user_id, capability_id)`.
  [Source: `docs/architecture/data-model.md` “UserCapability”]

MVP / vNext notes:
- MVP task filtering uses `capability_id` from task type as a **single value** filter when listing tasks.
  [Source: `docs/architecture/api-contract.md` “GET /projects/:project_id/tasks”]
- **vNext:** task listing may accept multiple capability IDs (e.g. `capability_id=1,2,3`). Do not implement multi-value parsing in MVP.
  [Source: `docs/architecture/api-contract.md` “GET /projects/:project_id/tasks” (vNext note)]

### Testing
- Use `gleeunit`.
- Focus tests on:
  - org-admin permission for creating capabilities,
  - uniqueness enforcement,
  - replace semantics for `PUT /me/capabilities`,
  - org scoping guarantees (no leakage).

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-12 | 1.0 | Initial draft | architect |
| 2026-01-12 | 1.1 | Refined story statement, acceptance criteria, tasks, dev notes, and testing focus aligned to capabilities contract (incl. vNext note) | sm |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
