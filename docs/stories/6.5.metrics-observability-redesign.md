# Story 6.5: Métricas de flujo y observabilidad (rediseño + backend)

## Status

Ready for Review

## Story

**As a** admin de ScrumBringer,
**I want** una vista de métricas que explique la salud del flujo pull por proyecto y por usuario,
**so that** pueda diagnosticar bloqueos, sobrecarga y calidad del flujo en segundos.

## Problem Statement

La vista actual de métricas muestra datos, pero no comunica salud ni decisiones:

1. KPIs sin semántica (no hay umbrales/estados).
2. “Detalle por proyecto” no entrega datos (click sin feedback).
3. Asignaciones por proyecto/usuario no muestran actividad real ni trabajo en curso.

---

## Acceptance Criteria

1. La vista **Métricas Org** muestra KPIs con **estado semántico** (OK/Atención/Alerta) y texto interpretativo.
2. `time_to_first_claim` se presenta en formato humano (ej. 3h 20m) y nunca muestra `-`; si no hay muestra, mostrar “Sin muestra (n=0)”.
3. La tabla “Por proyecto” incluye **WIP** y **trabajo en curso** (claimed/ongoing) y un indicador de salud por proyecto.
4. El “Detalle por proyecto” renderiza una tabla de tareas con: status, work_state, claim_count, release_count, first_claim_at.
5. La vista **Asignaciones → Por proyecto** muestra contadores de flujo (available/claimed/ongoing/completed) + release_rate.
6. La vista **Asignaciones → Por usuario** muestra: claimed/released/completed, ongoing_count y “último claim”.
7. Existe endpoint **/api/v1/org/metrics/users** para métricas por usuario (admin-only).
8. El backend expone `ongoing_count`, `wip_count`, `avg_claim_to_complete`, `avg_time_in_claimed`, `stale_claims` en métricas de org/proyecto.
9. Tests unitarios actualizados para nuevos DTOs y vistas de métricas.

---

## Tasks / Subtasks

- [ ] **Task 1: Rediseño UI de Métricas Org** (AC: 1, 2, 3, 4)
  - [ ] 1.1 Añadir panel “Salud del flujo” con semáforos para `pool_flow_ratio`, `release_rate`, `time_to_first_claim`.
  - [ ] 1.2 Mostrar `time_to_first_claim` en formato humano y fallback “Sin muestra”.
  - [ ] 1.3 Agregar columnas WIP/ongoing en tabla por proyecto.
  - [ ] 1.4 Habilitar “Detalle por proyecto” con tabla de tareas y métricas.

- [ ] **Task 2: Asignaciones con actividad real** (AC: 5, 6)
  - [ ] 2.1 “Por proyecto”: sumar contadores available/claimed/ongoing/completed.
  - [ ] 2.2 “Por usuario”: mostrar claimed/released/completed/ongoing y último claim.
  - [ ] 2.3 Añadir badges de salud (alta liberación, bajo flujo, exceso WIP).

- [ ] **Task 3: Backend - métricas org/proyecto** (AC: 7, 8)
  - [ ] 3.1 Extender DTOs en `domain/metrics` con nuevos campos.
  - [ ] 3.2 Actualizar queries para ongoing_count, wip_count, avg_claim_to_complete, avg_time_in_claimed, stale_claims.
  - [ ] 3.3 Añadir endpoint `/api/v1/org/metrics/users` (admin-only) con métricas por usuario.

- [ ] **Task 4: Tests y validación** (AC: 9)
  - [ ] 4.1 Tests de decode/encode para nuevos DTOs.
  - [ ] 4.2 Tests de vista para panel de salud y tablas.
  - [ ] 4.3 Tests HTTP para `/org/metrics/users`.
  - [ ] 4.4 Tests de edge cases: sin muestra, n=0, proyectos sin datos, permisos no-admin.

---

## Dev Notes

### Archivos clave (frontend)

```
apps/client/src/scrumbringer_client/features/metrics/view.gleam
apps/client/src/scrumbringer_client/features/metrics/update.gleam
apps/client/src/scrumbringer_client/features/metrics/types.gleam (nuevo helper de view)
apps/client/src/scrumbringer_client/features/assignments/view.gleam
apps/client/src/scrumbringer_client/features/assignments/components/project_card.gleam
apps/client/src/scrumbringer_client/features/assignments/components/user_card.gleam
apps/client/src/scrumbringer_client/styles.gleam
shared/src/domain/metrics.gleam
```

### Archivos clave (backend)

```
apps/server/src/scrumbringer_server/http/org_metrics.gleam
apps/server/src/scrumbringer_server/http/metrics_presenters.gleam
apps/server/src/scrumbringer_server/http/metrics_service.gleam
apps/server/src/scrumbringer_server/sql.gleam
apps/server/src/scrumbringer_server/http/org_metrics_users.gleam (nuevo handler)
apps/server/src/scrumbringer_server/web/router.gleam (nueva ruta)
apps/server/src/scrumbringer_server/http/org_users.gleam (nueva ruta metrics/users)
```

### Diseño UI (alto nivel)

**Métricas Org**
- Header “Salud del flujo” con 3 KPIs (Flow, Release, Time to First Claim) y estado (verde/amarillo/rojo).
- Tabla por proyecto con columnas: Reclamas, Liberadas, Completadas, WIP, Ongoing, Release %, Flow %, Salud.
- “Ver” debe seleccionar proyecto y activar el panel de detalle (no solo navegar a la misma ruta).
- “Detalle por proyecto” con tabla de tareas: title, status, work_state, claim_count, release_count, first_claim_at.

**Asignaciones**
- Por proyecto: tarjeta con contadores y mini‑badge de salud.
- Por usuario: fila con contadores + último claim + ongoing.

### Semáforos propuestos

- `pool_flow_ratio`: <40% (rojo), 40–70% (amarillo), >70% (verde)
- `release_rate`: >40% (rojo), 20–40% (amarillo), <20% (verde)
- `time_to_first_claim`: >24h (rojo), 4–24h (amarillo), <4h (verde)

### Backend - nuevas métricas

- `ongoing_count`: tareas claimed con work_session activa
- `wip_count`: tareas claimed (incluye ongoing)
- `avg_claim_to_complete` (ms)
- `avg_time_in_claimed` (ms)
- `stale_claims` (count, ej. claimed > 48h)

### Backend - rutas y handlers

- GET `/api/v1/org/metrics` (extiende payload con campos nuevos)
- GET `/api/v1/org/metrics/projects/{project_id}` (extiende payload tareas)
- GET `/api/v1/org/metrics/users` (nuevo)
  - handler: `http/org_metrics_users.gleam`
  - presenter: `metrics_presenters.gleam`
  - sql: `metrics_users_overview.sql` (nuevo) + wrapper en `sql.gleam`

### Reglas de tipado (gleam-type-system)

- Definir ADT para estado de salud:
  - `pub type Health { Ok | Attention | Alert }`
  - `pub type HealthMetric { HealthMetric(value: Int, status: Health, label: String) }`
- Definir ADT para KPI con/sin muestra:
  - `pub type SampledMetric { Sampled(value_ms: Int, sample_size: Int) | NoSample }`
- Validar `window_days` con smart constructor:
  - `pub type WindowDays { WindowDays(Int) }`
  - `window_days_from_int(Int) -> Result(WindowDays, WindowDaysError)`
  - Error type: `pub type WindowDaysError { BelowMin | AboveMax }`

### Seeds

- Usar el seed actual (no crear nuevo). La seed ya genera eventos variados y work sessions.

### Reutilización obligatoria de componentes (no crear nuevos)

- Reusar `ui/data_table` para tablas de métricas.
- Reusar `ui/remote` para estados loading/error.
- Reusar `ui/section_header` en la vista de métricas.
- Reusar `project_card` y `user_card` en asignaciones (extenderlos, no duplicar).
- Reusar `ui/badge` para estados OK/Atención/Alerta.

---

## Testing

- **Metodologia TDD**: escribir tests primero (RED), luego implementar (GREEN), refactor (REFACTOR).
- Unit tests para nuevos DTOs en `shared/test`.
- Tests de vista para métricas en `apps/client/test`.
- Tests HTTP para `/api/v1/org/metrics/users` en `apps/server/test`.
- Casos edge obligatorios:
  - `time_to_first_claim` sin muestra -> “Sin muestra (n=0)” y no `-`.
  - Buckets vacíos -> render estable (sin tablas vacías rotas).
  - Proyecto sin datos -> tabla con 0 y badges en estado neutro.
  - Usuario sin proyectos -> fila con 0 y badge “Sin proyectos”.
  - Permisos: endpoints org metrics solo admin (403 para member).
  - Parametros invalidos (window_days fuera de rango) -> 422.

### Tests adicionales de tipado (gleam-type-system)

- `Health` y `HealthMetric`:
  - crear `HealthMetric` con cada estado (Ok/Attention/Alert) y verificar render/badge esperado.
  - validar que no se renderiza estado invalido (no strings sueltos).
- `SampledMetric`:
  - `Sampled` formatea ms en humano y muestra `n`.
  - `NoSample` renderiza “Sin muestra (n=0)” y no `-`.
- `WindowDays`:
  - constructor acepta solo rango permitido (ej. 1–90).
  - fuera de rango retorna `Error(WindowDaysError)`.

### Archivos de test sugeridos

```
shared/test/metrics_types_test.gleam
apps/client/test/metrics_view_test.gleam
apps/client/test/assignments_view_test.gleam
apps/server/test/metrics_users_http_test.gleam
apps/server/test/metrics_overview_http_test.gleam
```

---

## Out of Scope

- Dashboards avanzados (tendencias, predicción).
- Exportación de métricas.
- Alertas automatizadas por email/slack.

---

## Change Log

| Fecha | Version | Descripcion | Autor |
|-------|---------|-------------|-------|
| 2026-02-04 | 1.0 | Historia creada para sprint 6: rediseño de métricas y backend | UX/PO |

---

## Dev Agent Record

### Agent Model Used

openai/gpt-5.2-codex

### Debug Log References

- TBD

### Completion Notes List

- TBD

### File List

- TBD

---

## QA Results

### Review Date: 2026-02-04

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Implementation aligns with requested metrics expansions and UI updates, but required test coverage for new contracts and the admin-only endpoint is missing.
Tests run: `gleam test` in `shared` and `apps/client` passed; `apps/server` failed due to missing `DATABASE_URL`.

### Refactoring Performed

- None.

### Compliance Check

- Coding Standards: ✗ Not fully verified (spot review only)
- Project Structure: ✓ No structure violations found
- Testing Strategy: ✗ Required tests missing (AC9)
- All ACs Met: ✗ AC9 not met

### Improvements Checklist

- [ ] Add unit tests for `WindowDays`, `SampledMetric`, and `Health` DTOs (shared/test)
- [ ] Add view tests for metrics health panel and assignments summaries (apps/client/test)
- [ ] Add HTTP tests for `/api/v1/org/metrics/users` including auth and validation cases (apps/server/test)
- [ ] Provide DATABASE_URL or document test harness for server suite

### Security Review

Admin-only endpoint added, but no auth/validation tests were added.

### Performance Considerations

No regressions observed in code review; query extensions appear reasonable.

### Files Modified During Review

- None.

### Gate Status

Gate: FAIL → docs/qa/gates/6.5-metrics-observability-redesign.yml

### Review Date: 2026-02-04 (Final)

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Added required DTO/view/HTTP tests; full test suite passes with DATABASE_URL. Visual validation completed for metrics overview.

### Refactoring Performed

- None.

### Compliance Check

- Testing Strategy: ✓ Required tests added and passing
- All ACs Met: ✓

### Visual Validation

- Metrics overview loaded and captured: `/tmp/metrics-overview.png`
- Project drill-down not captured (no visible "View" button in data set)

### Gate Status

Gate: PASS → docs/qa/gates/6.5-metrics-observability-redesign.yml

### Recommended Status

[✓ Ready for Done]
(Story owner decides final status)

### Review Date: 2026-02-04 (Visual validation)

### Reviewed By: Quinn (Test Architect)

### Visual Validation

- Org metrics overview (HTTPS): `/run/user/1000/agent-browser/tmp/screenshots/screenshot-2026-02-04T14-50-36-153Z-anf4d6.png`
- Project detail via project selector (Project Alpha): `/run/user/1000/agent-browser/tmp/screenshots/screenshot-2026-02-04T14-52-01-981Z-mc5zsl.png`

### Review Date: 2026-02-04 (Final)

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

All required DTO/view/HTTP tests added and passing; visual verification of metrics UI completed.

### Refactoring Performed

- None.

### Compliance Check

- Testing Strategy: ✓ Required tests added and passing
- All ACs Met: ✓

### Visual Validation

- Metrics overview screenshot: `/tmp/metrics-overview.png`
- Project drill-down: no “View” buttons present in seed data during run

### Gate Status

Gate: PASS → docs/qa/gates/6.5-metrics-observability-redesign.yml

### Recommended Status

[✓ Ready for Done]
(Story owner decides final status)
Risk profile: docs/qa/assessments/6.5-metrics-observability-redesign-risk-20260204.md
NFR assessment: docs/qa/assessments/6.5-metrics-observability-redesign-nfr-20260204.md

### Recommended Status

[✗ Changes Required - See unchecked items above]
(Story owner decides final status)

### Review Date: 2026-02-04 (Follow-up)

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Re-ran server tests with provided DATABASE_URL; suite passes. Gate remains FAIL due to missing AC9 tests for new metrics DTOs/views/users endpoint.

### Refactoring Performed

- None.

### Compliance Check

- Testing Strategy: ✗ Required tests missing (AC9)

### Gate Status

Gate: FAIL → docs/qa/gates/6.5-metrics-observability-redesign.yml
