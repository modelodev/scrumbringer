# Story 7.1: Resaltado de bloqueadores en Pool

## Status

Ready for Review

## Story

**As a** miembro del proyecto,
**I want** identificar visualmente las tareas que bloquean la tarea que estoy viendo,
**so that** pueda entender el bloqueo sin buscar manualmente.

## Problem Statement

En Pool, una tarea bloqueada solo muestra un indicador y el detalle aparece en hover, pero no es evidente que tareas concretas son las bloqueadoras en el canvas. Esto obliga a buscar una por una y aumenta el tiempo de decisión.

---

## Acceptance Criteria

1. Al **hover** o **focus** de una tarea bloqueada, las tareas bloqueadoras visibles en el Pool quedan resaltadas.
2. El resaltado es **estático** (solo borde/halo), sin animaciones.
3. El resaltado se apaga al salir del hover/focus.
4. Si hay tareas bloqueadoras fuera de vista por filtros, se muestra un mensaje en el hover: “X bloqueadoras fuera de vista por filtros”.
5. Se implementa un **patrón reutilizable de highlight** con clases genéricas (`is-highlight-source`, `is-highlight-target`, `is-highlight-dimmed`) y variantes de intención.

---

## Tasks / Subtasks

- [x] **Task 1: Modelo de highlight reutilizable** (AC: 2, 5)
  - [x] 1.1 Definir clases CSS base y variantes de intención (warning/info/success).
  - [x] 1.2 Aplicar estilo de borde/halo sutil sin animaciones.
  - [x] 1.3 Definir API de clases reutilizable para origen/target/dimmed sin acoplar a Pool.
  - [x] 1.4 Documentar mapeo de clases para uso futuro en otras vistas.

- [x] **Task 2: Resaltado de bloqueadores en Pool** (AC: 1, 3, 4)
  - [x] 2.1 Detectar hover/focus en tareas bloqueadas.
  - [x] 2.2 Marcar tareas bloqueadoras visibles con `is-highlight-target`.
  - [x] 2.3 Limpiar estado al salir del hover/focus.
  - [x] 2.4 Mostrar aviso de bloqueadoras fuera de vista por filtros.
  - [x] 2.5 Calcular `hidden_blockers_count` como `total_blockers - visible_blockers` (sin valores negativos).
  - [x] 2.6 Marcar la tarea bloqueada activa como `is-highlight-source`.
  - [x] 2.7 No aplicar transiciones ni animaciones al activar/desactivar highlight.

- [x] **Task 3: Tests** (AC: 1-5)
  - [x] 3.1 Test de view: tareas bloqueadoras reciben clase de highlight.
  - [x] 3.2 Test de view: aviso visible cuando hay bloqueadoras fuera de vista.
  - [x] 3.3 Test de view: al salir de hover/focus se limpian clases de highlight.
  - [x] 3.4 Test de view: no se generan clases/estilos con animacion para highlight.
  - [x] 3.5 Test de update/model: `hidden_blockers_count` respeta filtros y nunca es negativo.
  - [x] 3.6 Test de estilos: existen clases genericas `is-highlight-source`, `is-highlight-target`, `is-highlight-dimmed`.

---

## Dev Notes

### Archivos clave (frontend)

```
apps/client/src/scrumbringer_client/features/pool/view.gleam
apps/client/src/scrumbringer_client/features/pool/state.gleam
apps/client/src/scrumbringer_client/features/pool/msg.gleam
apps/client/src/scrumbringer_client/ui/task_item.gleam (si se reutiliza)
apps/client/src/scrumbringer_client/styles.gleam
```

### UX Design

- **Tarea origen (bloqueada):** `is-highlight-source highlight-warning`
- **Tareas bloqueadoras:** `is-highlight-target highlight-warning`
- **Resto (opcional):** `is-highlight-dimmed` (si se decide atenuar)
- Sin animaciones, solo borde/halo.

### Refactor Alignment (docs/architecture/refactor-plan-detailed.md)

- Mantener MVU por feature: la logica de highlight vive en `features/pool/*`.
- Evitar nuevas dependencias en `client_state`/`client_update`/`client_view`.
- Helpers nuevos deben ir a `scrumbringer_client/helpers/*` o usar `update_helpers` como facade temporal.

Referencias:
- [Source: docs/architecture/refactor-plan-detailed.md#Fase 1 - Modularizacion MVU por feature]
- [Source: docs/architecture/refactor-plan-detailed.md#Fase 2 - Reducir update_helpers.gleam]

### Type Notes (gleam-type-system)

- Introducir ADT para estado de highlight (ej. `Highlight = None | Blocked(task_id, blockers)`), evitando flags sueltos.
- Modelar el conteo fuera de vista en el estado derivado del feature Pool (ej. campo `hidden_blockers_count: Int`) para evitar logica en la vista.
- Mantener pattern matching exhaustivo en `update` para transiciones de highlight.

#### Contrato tipado sugerido (idiomatico)

```gleam
pub type HighlightState {
  NoHighlight
  BlockingHighlight(source_task_id: Int, blocker_ids: List(Int), hidden_count: Int)
}
```

- Mensajes del feature Pool (orientativo):
  - `TaskHoverStarted(task_id: Int)`
  - `TaskHoverEnded`
  - `TaskFocused(task_id: Int)`
  - `TaskBlurred`
- La vista consume solo `HighlightState` ya calculado; no recalcula relaciones ni filtros en render.

Referencias:
- [Source: docs/architecture/coding-standards.md#Pattern Matching]
- [Source: docs/architecture/coding-standards.md#Project Best Practices (Mandatory)]

### Componentes UI

- Usar patrones existentes en `ui/` y estilos definidos en `styles.gleam`.

### Source Tree Notes

- Implementacion en feature Pool:
  - `apps/client/src/scrumbringer_client/features/pool/msg.gleam`
  - `apps/client/src/scrumbringer_client/features/pool/state.gleam`
  - `apps/client/src/scrumbringer_client/features/pool/view.gleam`
- Estilos compartidos en:
  - `apps/client/src/scrumbringer_client/styles.gleam`

Referencias:
- [Source: docs/architecture/source-tree.md#Project Structure]
- [Source: docs/architecture/source-tree.md#Key Directories]

---

## Testing

- Tests de vista en `apps/client/test` para clases de highlight.
- Verificar que hover/focus no rompe el popup existente.
- Tests de update/model para garantizar limpieza de estado y calculo correcto de bloqueadoras fuera de vista.
- Ejecutar `make test` y `make format` como baseline de fase.
- Priorizar tests de `update` para transiciones de estado y tests de `view` para clases/resultados de render (TDD: rojo -> verde -> refactor).

Referencias:
- [Source: docs/architecture/testing-architecture.md#1.3 Our Solution: Typed BDD with Dual Backends]
- [Source: docs/architecture/testing-architecture.md#6. Layer 4: Execution Router]
- [Source: docs/architecture/refactor-plan-detailed.md#Guardrails (Fase 0)]

### TDD (gleam-tdd-development)

- Definir firmas y ADTs primero.
- Escribir tests de view/update antes de implementar la logica.

### Criterio operativo AC4 (fuera de vista por filtros)

- `total_blockers`: cantidad de tareas bloqueadoras referenciadas por la tarea bloqueada activa.
- `visible_blockers`: bloqueadoras presentes en el set actualmente renderizado por filtros activos en Pool.
- `hidden_blockers_count = max(0, total_blockers - visible_blockers)`.
- Mostrar mensaje solo si `hidden_blockers_count > 0`: "X bloqueadoras fuera de vista por filtros".

---

## Out of Scope

- Animaciones o transiciones avanzadas.
- Resaltado fuera del Pool (Lista/Kanban).

---

## Change Log

| Fecha | Version | Descripcion | Autor |
|-------|---------|-------------|-------|
| 2026-02-05 | 1.0 | Historia creada para sprint 7 | UX/PO |
| 2026-02-06 | 1.1 | Validacion final: criterios tipados/TDD y ajustes de calidad para ejecucion | Winston |
| 2026-02-06 | 1.2 | Implementacion completa de highlight de bloqueadores con hover/focus, estilos reutilizables y tests | James |
| 2026-02-06 | 1.3 | Correcciones QA: fuente unica para hidden_count y cobertura adicional focus/blur + variantes de highlight | James |
| 2026-02-06 | 1.4 | Correcciones de revision arquitectonica: highlight solo para tareas bloqueadas, texto i18n y tests de borde adicionales | James |

---

## Dev Agent Record

### Agent Model Used

openai/gpt-5.3-codex

### Debug Log References

- `gleam test` (apps/client)
- `make format`
- `make test`
- `gleam test` (apps/client) tras fix QA
- `make format && make test` tras fix QA
- `gleam test` (apps/client) tras fix arquitectonico
- `make format && make test` tras fix arquitectonico

### Completion Notes List

- Se introdujo `HighlightState` tipado en pool para modelar source/targets/hidden_count de forma explicita.
- Se agregaron mensajes MVU para hover/focus/blur y limpieza de estado de highlight.
- Se aplicaron clases reutilizables `is-highlight-source`, `is-highlight-target`, `is-highlight-dimmed` con variantes de intencion sin animaciones.
- Se agrego aviso en hover popup para bloqueadoras fuera de vista por filtros.
- Se cubrio comportamiento con tests de view/update/estilos y se ejecuto regresion completa.
- Se elimino duplicacion de calculo en vista: `hidden_count` ahora se consume desde `HighlightState` (fuente unica en update).
- Se agrego cobertura explicita para `handle_task_focused` y `handle_task_blurred`.
- Se agregaron assertions de estilos para `highlight-info` y `highlight-success`.
- Se ajusto `open_blocker_highlight` para no activar highlight en tareas sin bloqueadores activos.
- Se movio el mensaje de bloqueadoras fuera de vista a i18n (`HiddenBlockedByFilters`) para ES/EN.
- Se agregaron tests de borde para no-highlight en tareas sin bloqueadores y `hidden_count = 0` con bloqueador visible.
- Se agrego verificacion explicita de ausencia de transiciones en clases de highlight.

### File List

- `apps/client/src/scrumbringer_client/client_state/member/pool.gleam`
- `apps/client/src/scrumbringer_client/features/pool/msg.gleam`
- `apps/client/src/scrumbringer_client/features/pool/update.gleam`
- `apps/client/src/scrumbringer_client/features/pool/view.gleam`
- `apps/client/src/scrumbringer_client/i18n/text.gleam`
- `apps/client/src/scrumbringer_client/i18n/es.gleam`
- `apps/client/src/scrumbringer_client/i18n/en.gleam`
- `apps/client/src/scrumbringer_client/styles/pool.gleam`
- `apps/client/src/scrumbringer_client/ui/task_hover_popup.gleam`
- `apps/client/test/pool_highlight_view_test.gleam`
- `apps/client/test/pool_highlight_update_test.gleam`
- `apps/client/test/styles_accessibility_test.gleam`
- `apps/client/test/ui_task_hover_popup_test.gleam`

---

## QA Results

### Review Date: TBD

### Reviewed By: TBD

### Gate Status

Gate: TBD

### Review Date: 2026-02-06

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Implementacion solida y alineada con MVU/ADT en Pool: introduce `HighlightState` tipado, handlers de hover/focus/blur y clases reutilizables sin animaciones para el highlight. La funcionalidad principal cumple, pero hay una desviacion de mantenibilidad: `hidden_count` se calcula en update y tambien en view por separado.

### Refactoring Performed

- Ningun refactor de codigo aplicado en esta revision (solo analisis QA).

### Compliance Check

- Coding Standards: ✓ (uso de ADT y pattern matching idiomatico)
- Project Structure: ✓ (cambios concentrados en `features/pool`, `ui`, `styles`, `client_state/member/pool`)
- Testing Strategy: ⚠ (cobertura fuerte en hover/update, parcial en focus/blur y variantes de intencion)
- All ACs Met: ✓ (con observaciones de profundidad de pruebas)

### Improvements Checklist

- [ ] Unificar la fuente de verdad de `hidden_count` (usar estado tipado o helper unico compartido).
- [ ] Agregar tests explicitos para `handle_task_focused` y `handle_task_blurred`.
- [ ] Agregar assertions para variantes `highlight-info` y `highlight-success`.

### Security Review

Sin hallazgos de seguridad de severidad alta/media en alcance de historia (cambio de UI/estado local).

### Performance Considerations

El highlight es estatico y evita animaciones, cumpliendo AC2. El costo de calculo de blockers visibles es acotado al evento de interaccion y al tamano de listas del Pool.

### Files Modified During Review

- `docs/qa/assessments/7.1-trace-20260206.md`
- `docs/qa/assessments/7.1-risk-20260206.md`
- `docs/qa/assessments/7.1-nfr-20260206.md`
- `docs/qa/gates/7.1-pool-highlight-blockers.yml`

### Gate Status

Gate: CONCERNS -> docs/qa/gates/7.1-pool-highlight-blockers.yml
Risk profile: docs/qa/assessments/7.1-risk-20260206.md
NFR assessment: docs/qa/assessments/7.1-nfr-20260206.md
Trace matrix: docs/qa/assessments/7.1-trace-20260206.md

### Recommended Status

[✗ Changes Required - See unchecked items above]
(Story owner decides final status)

### Review Date: 2026-02-06

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Re-evaluacion posterior a fixes arquitectonicos: el comportamiento queda alineado con los ACs, con activacion de highlight solo para tareas realmente bloqueadas, limpieza explicita por hover/blur, mensaje de bloqueadoras ocultas via i18n y cobertura de bordes/estilos reforzada.

### Refactoring Performed

- Ningun refactor de codigo aplicado en esta revision (solo analisis QA y actualizacion de artefactos).

### Compliance Check

- Coding Standards: ✓ (estado tipado y handlers MVU consistentes)
- Project Structure: ✓ (cambios concentrados en `features/pool`, `i18n`, `test`)
- Testing Strategy: ✓ (cobertura explicita para hover/focus/blur, hidden_count visible/no visible y clases sin transiciones)
- All ACs Met: ✓ (AC1-AC5 con evidencia directa)

### Improvements Checklist

- [x] Verificado no-highlight en tarea sin bloqueadores activos.
- [x] Verificado `hidden_count = 0` cuando bloqueador esta visible.
- [x] Verificadas assertions explicitas de no-transition en clases de highlight.
- [x] Verificado texto i18n `HiddenBlockedByFilters(count)` en ES/EN.

### Security Review

Sin hallazgos de seguridad (alcance de UI/estado local sin cambio en authz/authn ni datos sensibles).

### Performance Considerations

Se mantiene resaltado estatico sin animaciones/transiciones; no se observan impactos de rendimiento relevantes en este alcance.

### Files Modified During Review

- `docs/qa/assessments/7.1-trace-20260206.md`
- `docs/qa/assessments/7.1-risk-20260206.md`
- `docs/qa/assessments/7.1-nfr-20260206.md`
- `docs/qa/gates/7.1-pool-highlight-blockers.yml`
- `docs/stories/7.1.pool-highlight-blockers.md`

### Gate Status

Gate: PASS -> docs/qa/gates/7.1-pool-highlight-blockers.yml
Risk profile: docs/qa/assessments/7.1-risk-20260206.md
NFR assessment: docs/qa/assessments/7.1-nfr-20260206.md
Trace matrix: docs/qa/assessments/7.1-trace-20260206.md

### Recommended Status

[✓ Ready for Done]
(Story owner decides final status)
