# Story 7.4: Hitos (Milestones)

## Status

Ready

## Story

**As a** miembro del proyecto,
**I want** organizar cards y tasks en hitos antes de lanzarlas al pool,
**so that** puedo planificar trabajo futuro sin contaminar el pool con backlog inactivo.

## Problem Statement

Actualmente las tasks se crean y van directo al Pool. Esto genera:
- Pool lleno de trabajo futuro que distrae del foco actual
- Backlog viviendo fuera de ScrumBringer (hojas de cálculo, docs externos)
- Falta de visibilidad sobre qué viene después del trabajo actual

## Filosofía (alineación con brief)

- **Pull real**: el Pool sigue siendo solo trabajo activo; los hitos son planificación
- **Separación clara**: planificación (hitos) vs actividad real (pool) son mundos distintos
- **Irreversibilidad**: activar un hito es un compromiso, refuerza la filosofía Pull
- **Estado implícito**: el estado del hito se deriva de sus cards/tasks

---

## Acceptance Criteria

### Modelo de datos

1. **AC1**: Un hito tiene: nombre, descripción (opcional), estado, proyecto
2. **AC2**: Estados persistidos de hito: `ready` (planificación), `active` (lanzado). El estado `completed` es derivado (no persistido).
3. **AC3**: Un hito puede contener cards y tasks sueltas
4. **AC4**: Máximo 1 hito activo por proyecto
5. **AC5**: El Pool se alimenta de: hito activo + cards/tasks sin hito (huérfanas)
6. **AC5b**: Una task con `card_id` hereda el milestone de su card; no puede tener `milestone_id` propio

### Preparación modelo para métricas (7.5)

> Alcance acotado para 7.4: estos AC solo requieren schema + wiring mínimo backend (sin UI de métricas en 7.4).

7. **AC5c**: Las tasks tienen `pool_lifetime_s` (segundos acumulados en Available) y `last_entered_pool_at`
8. **AC5d**: Las tasks creadas por workflows tienen `created_from_rule_id` para trazabilidad
9. **AC5e**: Al hacer claim, se acumula pool_lifetime y se limpia last_entered_pool_at
10. **AC5f**: Al hacer release, se resetea last_entered_pool_at a NOW()

### Activación de hito

11. **AC6**: Activar un hito lanza todas sus cards y tasks al Pool
12. **AC7**: La activación es irreversible
13. **AC8**: Al activar, se muestra confirmación: "Se lanzarán X cards y Y tasks al Pool. Esta acción no tiene marcha atrás. ¿Continuar?"
14. **AC9**: Si ya hay un hito activo, no se puede activar otro hasta que el actual esté completado
15. **AC10**: Completar el hito activo requiere acción manual para activar el siguiente

### Completitud

16. **AC11**: Un hito se marca `completed` automáticamente cuando todas sus cards y tasks están completadas
17. **AC12**: El progreso del hito se deriva con regla formal:
    - `cards_progress = cards_completed / cards_total`
    - `tasks_progress = tasks_completed / tasks_total` (solo tasks sueltas del hito)
    - `milestone_completed = (cards_completed == cards_total) AND (tasks_completed == tasks_total)`
    - Si `cards_total = 0` y `tasks_total = 0`, entonces `milestone_completed = false`.
18. **AC13**: El progreso de la card se deriva: % de tasks completadas

### Vista Hitos

19. **AC14**: La vista "Hitos" reemplaza la vista "Lista" en el menú lateral
20. **AC15**: La vista muestra todos los hitos en formato acordeón, plegados por defecto
21. **AC16**: Filtros "ver completados" y "ver vacíos" están desmarcados por defecto
22. **AC17**: El acordeón muestra: nombre, estado, barra de progreso
23. **AC18**: Al expandir: cards (con su progreso) y tasks sueltas

### Modal de hito

24. **AC19**: Click en nombre del hito abre modal de detalle
25. **AC20**: El modal muestra: nombre, estado, descripción, barra de progreso, botón activar (si aplica)
26. **AC21**: El modal permite crear cards y tasks dentro del hito
27. **AC22**: El modal lista cards (expandibles) y tasks sueltas

### Creación y movimiento

28. **AC23**: Los botones "+ Nueva tarea" y "+ Nueva tarjeta" del menú lateral crean en el Pool (hito activo o huérfano)
29. **AC24**: Crear cards/tasks dentro de un hito solo desde la vista/modal de Hitos
30. **AC25**: Se puede mover una card/task entre hitos `ready` via drag & drop (si ambos visibles)
31. **AC26**: Se puede mover una card/task entre hitos `ready` via menú contextual (siempre disponible)
32. **AC27**: No se puede mover contenido del Pool a un hito (separación planificación vs actividad)

### i18n

33. **AC28**: Labels en ES/EN:
    - "Hitos" / "Milestones"
    - "Activar hito" / "Activate milestone"
    - "Se lanzarán X cards y Y tasks al Pool" / "X cards and Y tasks will be launched to Pool"
    - "Esta acción no tiene marcha atrás" / "This action cannot be undone"

### UX, accesibilidad y consistencia visual

34. **AC29**: La vista y modal de hitos reutilizan componentes existentes: `ui/expand_toggle.gleam`, `ui/dialog.gleam`, `ui/badge.gleam` (sin variantes ad hoc locales).
35. **AC30**: La navegación de Hitos es consistente en sidebar + center panel + toggle de modo + URL state; no puede coexistir "Lista" como opción visible cuando Hitos la reemplaza y `view=list` queda eliminado.
36. **AC31**: La vista de hitos define estados de datos explícitos con copy i18n: `loading`, `empty`, `error`.
37. **AC32**: El acordeón y acciones del modal son accesibles por teclado (`button`, foco visible) y usan `aria-expanded` + `aria-controls` en expand/collapse.
38. **AC33**: La toolbar de Hitos muestra solo controles relevantes de hitos (buscar/filtros propios); no renderiza filtros de tipo/capacidad heredados del Pool.
39. **AC34**: Cada fila del acordeón define región controlada accesible con `id` estable, `aria-controls`, `aria-labelledby` y nombre accesible contextual ("Expandir/Colapsar hito {nombre}").
40. **AC35**: El modal de activación irreversible aplica patrón seguro: foco inicial en "Cancelar", tecla `Esc` cierra sin activar y acción primaria claramente irreversible.
41. **AC35b**: Al cerrar el modal (Cancelar, `Esc` o `X`), el foco vuelve al botón que abrió la acción ("Activar hito").

---

## Wireframes

### Vista Hitos (acordeón plegado)

```
┌─────────────────────────────────────────────────────────────┐
│ HITOS                           [ ] Completados  [ ] Vacíos │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ ▶ Release 2.0              [ACTIVE]  ████████░░ 80%        │
│                                                             │
│ ▶ Backlog Q2               [READY]   ░░░░░░░░░░ 0%         │
│                                                             │
│ ▶ Tech Debt                [READY]   ██░░░░░░░░ 20%        │
│                                                             │
│                            [+ Nuevo hito]                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### Vista Hitos (acordeón expandido)

```
┌─────────────────────────────────────────────────────────────┐
│ HITOS                           [ ] Completados  [ ] Vacíos │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ ▼ Release 2.0              [ACTIVE]  ████████░░ 80%        │
│   ├─ ▶ Card: Auth refactor          ███░░ 60%    [⋮]      │
│   ├─ ▶ Card: New dashboard          ░░░░░ 0%     [⋮]      │
│   └─ • Task: Update docs            [available]   [⋮]      │
│                                                             │
│ ▼ Backlog Q2               [READY]   ░░░░░░░░░░ 0%         │
│   └─ (vacío)               [+ Card] [+ Task]               │
│                                                             │
│ ▶ Tech Debt                [READY]   ██░░░░░░░░ 20%        │
│                                                             │
│                            [+ Nuevo hito]                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘

Leyenda:
[⋮] = Menú contextual (mover a hito, eliminar)
```

### Modal de hito (tab Contenido)

```
┌─────────────────────────────────────────────────────────────┐
│ Hito: Release 2.0                                    [X]    │
├─────────────────────────────────────────────────────────────┤
│ Estado: READY                          [Activar hito]       │
│                                                             │
│ Progreso  ████████░░░░ 67%                                  │
│                                                             │
│ ─────────────────────────────────────────────────────────── │
│ Descripción:                                                │
│ Release con nuevo sistema de auth y dashboard renovado.     │
│ Incluye migración de tokens y mejoras de UX.                │
│                                                             │
│ ─────────────────────────────────────────────────────────── │
│ Contenido                              [+ Card] [+ Task]    │
│ ─────────────────────────────────────────────────────────── │
│ ▶ Card: Auth refactor                       ███░░ 60%      │
│ ▶ Card: New dashboard                       ░░░░░ 0%       │
│ • Task: Update docs                         [available]     │
│ • Task: Review dependencies                 [available]     │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### Modal de confirmación (activar hito)

```
┌─────────────────────────────────────────────────────────────┐
│ Activar hito                                         [X]    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ⚠️  Se lanzarán al Pool:                                  │
│                                                             │
│       • 4 cards                                             │
│       • 12 tasks                                            │
│                                                             │
│   Esta acción no tiene marcha atrás.                        │
│   Las cards y tasks pasarán a estar disponibles             │
│   para que el equipo las reclame.                           │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│                        [Cancelar]  [Activar hito]           │
└─────────────────────────────────────────────────────────────┘
```

### Menú contextual (mover entre hitos)

```
┌─────────────────────────┐
│ Mover a hito...     ▶  │
├─────────────────────────┤
│   ○ Backlog Q2          │
│   ○ Tech Debt           │
│   ─────────────────     │
│   ○ Sin hito (Pool)     │  ← Solo si hito actual es ready
├─────────────────────────┤
│ Eliminar                │
└─────────────────────────┘
```

---

## Tasks / Subtasks

- [ ] **Task 1: Migración de base de datos** (AC: 1-5, 5b-5f)
  - [ ] 1.1 Crear tabla `milestones`:
    ```sql
    CREATE TABLE milestones (
        id BIGSERIAL PRIMARY KEY,
        project_id BIGINT NOT NULL REFERENCES projects(id),
        name TEXT NOT NULL,
        description TEXT,
        state TEXT NOT NULL DEFAULT 'ready' CHECK (state IN ('ready', 'active')),
        position INT NOT NULL DEFAULT 0,
        created_by BIGINT NOT NULL REFERENCES users(id),
        created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
        activated_at TIMESTAMPTZ
    );
    CREATE INDEX idx_milestones_project ON milestones(project_id);
    CREATE UNIQUE INDEX idx_milestones_one_active ON milestones(project_id) WHERE state = 'active';
    ```
  - [ ] 1.2 Añadir `milestone_id` a `cards`:
    ```sql
    ALTER TABLE cards ADD COLUMN milestone_id BIGINT REFERENCES milestones(id);
    CREATE INDEX idx_cards_milestone ON cards(milestone_id);
    ```
  - [ ] 1.3 Añadir `milestone_id` a `tasks` (excluyente con card_id):
    ```sql
    ALTER TABLE tasks ADD COLUMN milestone_id BIGINT REFERENCES milestones(id);
    CREATE INDEX idx_tasks_milestone ON tasks(milestone_id);
    ALTER TABLE tasks ADD CONSTRAINT task_milestone_exclusive 
        CHECK (NOT (card_id IS NOT NULL AND milestone_id IS NOT NULL));
    ALTER TABLE milestones ADD CONSTRAINT milestones_project_id_id_unique UNIQUE (project_id, id);
    ALTER TABLE cards ADD CONSTRAINT cards_project_milestone_fk
      FOREIGN KEY (project_id, milestone_id) REFERENCES milestones(project_id, id);
    ALTER TABLE tasks ADD CONSTRAINT tasks_project_milestone_fk
      FOREIGN KEY (project_id, milestone_id) REFERENCES milestones(project_id, id);
    ALTER TABLE milestones ADD CONSTRAINT milestones_state_activation_consistency
      CHECK (
        (state = 'ready' AND activated_at IS NULL) OR
        (state = 'active' AND activated_at IS NOT NULL)
      );
    ```
  - [ ] 1.3.1 Reforzar integridad semántica AC5b: task con `card_id` no persiste `milestone_id`; definir `effective_milestone_id` en queries/mappers (`COALESCE(task.milestone_id, card.milestone_id)`).
  - [ ] 1.4 Añadir columnas de tracking para métricas (prepara 7.5):
    ```sql
    -- Pool lifetime tracking
    ALTER TABLE tasks ADD COLUMN pool_lifetime_s INT NOT NULL DEFAULT 0;
    ALTER TABLE tasks ADD COLUMN last_entered_pool_at TIMESTAMPTZ;
    UPDATE tasks
    SET last_entered_pool_at = CASE WHEN status = 'available' THEN created_at ELSE NULL END;
    ALTER TABLE tasks ADD CONSTRAINT tasks_pool_lifetime_non_negative CHECK (pool_lifetime_s >= 0);
    
    -- Workflow traceability
    ALTER TABLE tasks ADD COLUMN created_from_rule_id BIGINT REFERENCES rules(id);
    CREATE INDEX idx_tasks_created_from_rule ON tasks(created_from_rule_id);
    ```
  - [ ] 1.5 Reforzar índices para consultas de milestones/pool:
    ```sql
    CREATE INDEX idx_milestones_project_state_position ON milestones(project_id, state, position);
    CREATE INDEX idx_cards_project_milestone ON cards(project_id, milestone_id);
    CREATE INDEX idx_tasks_project_milestone_status ON tasks(project_id, milestone_id, status);
    CREATE INDEX idx_tasks_card_status ON tasks(card_id, status);
    ```

- [ ] **Task 2: Tipos de dominio** (AC: 1-3)
  - [ ] 2.1 Crear `shared/src/domain/milestone.gleam` con tipos y codecs
  - [ ] 2.2 Definir ADT `MilestoneState = Ready | Active` (Completed es derivado)
  - [ ] 2.3 Actualizar `shared/src/domain/task.gleam` con campos nuevos
  - [ ] 2.4 Actualizar `shared/src/domain/card.gleam` con `milestone_id`

- [ ] **Task 3: API endpoints milestones** (AC: 6-10)
  - [ ] 3.1 `GET /api/v1/projects/:id/milestones` - Lista hitos con contadores
  - [ ] 3.2 `POST /api/v1/projects/:id/milestones` - Crear hito
  - [ ] 3.3 `GET /api/v1/milestones/:id` - Detalle con cards/tasks
  - [ ] 3.4 `PATCH /api/v1/milestones/:id` - Actualizar nombre/descripción
  - [ ] 3.5 `POST /api/v1/milestones/:id/activate` - Activar hito
  - [ ] 3.6 `DELETE /api/v1/milestones/:id` - Eliminar hito (solo si ready y vacío)
  - [ ] 3.7 Ajustar feed de Pool para AC5: solo `hito activo + tasks/cards huérfanas` por proyecto.

- [ ] **Task 4: API mover contenido** (AC: 25-27)
  - [ ] 4.1 `PATCH /api/v1/cards/:id` - Actualizar `milestone_id`
  - [ ] 4.2 `PATCH /api/v1/tasks/:id` - Actualizar `milestone_id`
  - [ ] 4.3 Validar: solo mover a hitos `ready`
  - [ ] 4.4 Validar: no mover desde Pool a hito

- [ ] **Task 5: Tracking de pool_lifetime** (AC: 5e-5f, prepara 7.5)
  - [ ] 5.1 Modificar `apps/server/src/scrumbringer_server/http/tasks/tasks_transitions.gleam` + SQL de claim/release/complete.
  - [ ] 5.2 Fijar fórmula SQL anti doble-conteo y null-safety:
    ```sql
    pool_lifetime_s = pool_lifetime_s + GREATEST(0, EXTRACT(EPOCH FROM (NOW() - last_entered_pool_at))::INT)
    ```
    Aplicar en `claim/complete` solo cuando `last_entered_pool_at IS NOT NULL`; luego setear `last_entered_pool_at = NULL`.
    En `release`, setear `last_entered_pool_at = NOW()`.
  - [ ] 5.3 Modificar `task_complete` para sumar tiempo restante si aplica (sin duplicar acumulación previa).

- [ ] **Task 6: Trazabilidad workflows** (AC: 5d, prepara 7.5)
  - [ ] 6.1 Modificar `rules_engine.gleam` → `create_task_from_template`: pasar rule.id
  - [ ] 6.2 Modificar `sql.tasks_create` → aceptar `created_from_rule_id` opcional
  - [ ] 6.3 Actualizar codec de Task para incluir `created_from_rule_id`

- [ ] **Task 7: Navegación y routing** (AC: 14)
  - [ ] 7.1 Reemplazar "Lista" por "Hitos" en left_panel
  - [ ] 7.2 Añadir `ViewMode.Milestones` al flujo actual de member URL state (`view=milestones`) sin crear ruta nueva `/milestones`
  - [ ] 7.3 Crear `features/milestones/*` (state/msg/update/view)

- [ ] **Task 8: Vista acordeón** (AC: 15-18)
  - [ ] 8.1 Componente acordeón con expand/collapse (triangulito)
  - [ ] 8.2 Render de hitos con estado y progreso
  - [ ] 8.3 Render de cards y tasks al expandir
  - [ ] 8.4 Filtros completados/vacíos
  - [ ] 8.5 Reutilizar `ui/expand_toggle.gleam` para indicador expand/collapse.
  - [ ] 8.6 Incluir estados `loading/empty/error` con copy i18n en la vista de hitos.

- [ ] **Task 9: Modal de hito** (AC: 19-22)
  - [ ] 9.1 Modal con detalle de hito
  - [ ] 9.2 Botones crear card/task dentro del hito
  - [ ] 9.3 Lista expandible de contenido
  - [ ] 9.4 Reutilizar `ui/dialog.gleam` y patrones de modal existentes (header/cierre/footer).

- [ ] **Task 10: Activación de hito** (AC: 6-10)
  - [ ] 10.1 Modal de confirmación con contadores
  - [ ] 10.2 Lógica de activación (estado ready → active)
  - [ ] 10.3 Validación de hito activo único

- [ ] **Task 11: Drag & drop + menú contextual** (AC: 25-26)
  - [ ] 11.1 Drag & drop entre hitos expandidos
  - [ ] 11.2 Menú contextual "Mover a hito..."
  - [ ] 11.3 Selector de hitos destino

- [ ] **Task 12: i18n** (AC: 28, 31, 35, 35b)
  - [ ] 12.1 Añadir labels ES/EN
  - [ ] 12.2 Añadir copy para estados de datos de hitos (`loading`, `empty`, `error`).
  - [ ] 12.3 Añadir keys i18n de milestones y accesibilidad: `Milestones`, `Milestone`, `ActivateMilestone`, `MilestonesLoading`, `MilestonesEmpty`, `MilestonesError`, `MilestonesNoResults`, `ShowCompletedMilestones`, `ShowEmptyMilestones`, `MilestoneActivationTitle`, `MilestoneActivationBody(cards_count, tasks_count)`, `MilestoneActivationIrreversible`, `ExpandMilestone(name)`, `CollapseMilestone(name)`.

- [ ] **Task 12b: Consistencia de navegación** (AC: 30, 33)
  - [ ] 12b.1 Alinear sidebar y `view_mode_toggle` para que Hitos reemplace Lista sin duplicidad.
  - [ ] 12b.2 Asegurar estado activo coherente para `view=milestones`.
  - [ ] 12b.3 Definir toolbar específica de Hitos (sin filtros de tipo/capacidad del Pool).

- [ ] **Task 12c: Compatibilidad y accesibilidad avanzada** (AC: 30, 34, 35)
  - [ ] 12c.1 Eliminar soporte `view=list` en router/url_state y actualizar rutas internas a `view=milestones`.
  - [ ] 12c.2 Implementar `aria-controls`/`aria-labelledby` por ítem de acordeón con ids estables.
  - [ ] 12c.3 En modal de activación, foco inicial en cancelar y soporte `Esc` sin ejecutar activación.
  - [ ] 12c.4 Restaurar foco al botón invocador al cerrar modal (`Cancelar`, `Esc`, `X`).

- [ ] **Task 13: Tests** (AC: 1-35b)
  - [ ] 13.1 Tests de tipos y ADTs
  - [ ] 13.2 Tests de endpoints
  - [ ] 13.3 Tests de pool_lifetime tracking
  - [ ] 13.4 Tests de created_from_rule_id en rules_engine
  - [ ] 13.5 Tests de vista acordeón
  - [ ] 13.6 Tests de activación y validaciones
  - [ ] 13.7 Tests de concurrencia AC4/AC9: activaciones simultáneas mantienen un solo hito activo por proyecto.
  - [ ] 13.8 Tests AC5/AC5b: feed Pool = activo + huérfanas; herencia milestone por card sin milestone en task hija.
  - [ ] 13.9 Tests AC25-AC27: mover entre hitos ready (DnD/menú) y prohibición de Pool -> hito.
  - [ ] 13.10 Tests de migración: constraints e índices críticos creados correctamente.
  - [ ] 13.11 Tests AC29: reutilización de componentes (`expand_toggle`, `dialog`, `badge`) en vista/modal de hitos.
  - [ ] 13.12 Tests AC30: consistencia de navegación (sidebar + toggle + URL state; `view=list` debe fallar/ignorar según contrato final).
  - [ ] 13.13 Tests AC31/AC32: estados `loading/empty/error` con i18n + accesibilidad teclado + `aria-expanded`/`aria-controls` por ítem.
  - [ ] 13.14 Tests AC33: toolbar de Hitos no renderiza filtros de tipo/capacidad de Pool.
  - [ ] 13.15 Tests AC34: región accesible por fila (`aria-controls` + `aria-labelledby` + nombre contextual).
  - [ ] 13.16 Tests AC35: modal irreversible (foco inicial en cancelar, `Esc` cierra, no activa accidentalmente).
  - [ ] 13.17 Tests AC35b: al cerrar modal se restaura foco al botón que abrió la acción.
  - [ ] 13.18 Añadir matriz AC -> test (Given/When/Then) para AC29-AC35b con asserts explícitos.

- [ ] **Task 14: Migración segura y rollback** (AC: 1-5f)
  - [ ] 14.1 Definir migración con bloques `-- migrate:up` y `-- migrate:down` siguiendo patrón del repo.
  - [ ] 14.2 Incluir plan de backfill y rollback operacional (orden de ejecución, validaciones y reversión).
  - [ ] 14.3 Añadir tests de migración con verificación de `up/down` e idempotencia de datos.

---

## Dev Notes

### Archivos clave (backend)

```
# Nuevos
apps/server/src/scrumbringer_server/http/milestones.gleam
apps/server/src/scrumbringer_server/services/milestones_db.gleam
shared/src/domain/milestone.gleam
db/migrations/YYYYMMDDHHMMSS_create_milestones.sql

# Modificar para pool_lifetime tracking
apps/server/src/scrumbringer_server/http/tasks/tasks_transitions.gleam (claim/release/complete handlers)
apps/server/src/scrumbringer_server/persistence/tasks/queries.gleam
apps/server/src/scrumbringer_server/persistence/tasks/mappers.gleam
apps/server/src/scrumbringer_server/sql/tasks_claim.sql
apps/server/src/scrumbringer_server/sql/tasks_release.sql
apps/server/src/scrumbringer_server/sql/tasks_complete.sql

# Modificar para workflow traceability
apps/server/src/scrumbringer_server/services/rules_engine.gleam
apps/server/src/scrumbringer_server/sql/tasks_create.sql

# Modificar para feed de Pool (AC5)
apps/server/src/scrumbringer_server/sql/tasks_list.sql

# Modificar para milestone_id
shared/src/domain/task.gleam
shared/src/domain/card.gleam
shared/src/domain/task/codec.gleam
shared/src/domain/card/codec.gleam
```

### Archivos clave (frontend)

```
apps/client/src/scrumbringer_client/features/milestones/state.gleam (nuevo)
apps/client/src/scrumbringer_client/features/milestones/msg.gleam (nuevo)
apps/client/src/scrumbringer_client/features/milestones/update.gleam (nuevo)
apps/client/src/scrumbringer_client/features/milestones/view.gleam (nuevo)
apps/client/src/scrumbringer_client/features/layout/left_panel.gleam
apps/client/src/scrumbringer_client/features/layout/center_panel.gleam
apps/client/src/scrumbringer_client/features/layout/view_mode_toggle.gleam
apps/client/src/scrumbringer_client/router.gleam
apps/client/src/scrumbringer_client/url_state.gleam
shared/src/domain/view_mode.gleam
```

### Refactor Alignment (docs/architecture/refactor-plan-detailed.md)

- Nuevo feature completo `features/milestones/*` (state/msg/update/view)
- `client_view` solo ensambla; `client_update` solo enruta
- Helpers nuevos en `scrumbringer_client/helpers/*`
- Domain types en `shared/src/domain/milestone.gleam`

### Type Notes (gleam-type-system)

```gleam
// === Milestone types ===

pub type MilestoneState {
  Ready
  Active
  // Completed es derivado, no se almacena
}

pub type Milestone {
  Milestone(
    id: Int,
    project_id: Int,
    name: String,
    description: Option(String),
    state: MilestoneState,
    position: Int,
    created_by: Int,
    created_at: String,
    activated_at: Option(String),
  )
}

pub type MilestoneWithProgress {
  MilestoneWithProgress(
    milestone: Milestone,
    cards_total: Int,
    cards_completed: Int,
    tasks_total: Int,
    tasks_completed: Int,
    is_completed: Bool,  // derivado: cards_total == cards_completed AND tasks_total == tasks_completed
  )
}

// === Extensiones a Task (campos nuevos) ===

// En Task existente, añadir:
//   milestone_id: Option(Int),           // Solo si task suelta (sin card)
//   pool_lifetime_s: Int,                // Tiempo acumulado en Available
//   last_entered_pool_at: Option(String),// NULL si no está en pool
//   created_from_rule_id: Option(Int),   // Si fue creada por workflow

// === Extensiones a Card ===

// En Card existente, añadir:
//   milestone_id: Option(Int),
```

### Lustre Notes (gleam-lustre)

- Modal de hito sigue patrón existente de card/task modal
- Acordeón reutiliza `ui/expand_toggle.gleam` de otras vistas
- Effects para API calls en update, nunca en view
- Drag & drop reusa sistema existente del Pool

### Reuso UI obligatorio

- Reutilizar `ui/dialog.gleam` para modal de hito y confirmación de activación.
- Reutilizar `ui/badge.gleam` para estados (`ready`, `active`, `completed` derivado).
- Evitar crear clases o componentes locales duplicados cuando ya existe patrón equivalente.

---

## Testing

- Tests de tipos en `shared/test`
- Tests de endpoints en `apps/server/test`
- Tests de vista en `apps/client/test`
- Matriz mínima de tests por área:
  - `shared/test/domain/milestone*_test.gleam`: ADTs/codec + derivación `completed`.
  - `apps/server/test/milestones_http_test.gleam`: CRUD, activación irreversible, único activo por proyecto.
  - `apps/server/test/tasks_pool_lifetime_test.gleam`: claim/release/complete acumulan/resetean tiempos.
  - `apps/server/test/rules_engine_milestone_trace_test.gleam`: `created_from_rule_id` en creación por workflow.
  - `apps/client/test/url_state_test.gleam` + `apps/client/test/router_test.gleam`: `view=milestones` parse/format/roundtrip.
  - `apps/client/test/left_panel_test.gleam` + `apps/client/test/center_panel_test.gleam`: reemplazo visual Lista->Hitos y render de vista.
  - `apps/client/test/milestones_view_test.gleam`: acordeón, filtros, progreso, expand/collapse.
  - `apps/client/test/milestone_modal_test.gleam`: detalle, activación, contenido y acciones de creación.

### Matriz AC -> test (obligatoria para AC29-AC35b)

| AC | Archivo test | Escenario Given/When/Then | Assert clave |
|----|--------------|---------------------------|--------------|
| AC29 | `apps/client/test/milestones_view_test.gleam` + `apps/client/test/milestone_modal_test.gleam` | Given vista hitos, When render, Then usa componentes compartidos | presencia de `expand_toggle`, `dialog`, `badge` |
| AC30 | `apps/client/test/url_state_test.gleam` + `apps/client/test/router_test.gleam` + `apps/client/test/left_panel_test.gleam` + `apps/client/test/center_panel_test.gleam` | Given URL legacy `view=list`, When parse/format/nav, Then no coexiste Lista | redirect/normalización + ausencia UI lista |
| AC31 | `apps/client/test/milestones_view_test.gleam` | Given carga remota, When `loading/empty/error`, Then copy i18n correcto | textos i18n y estados |
| AC32 | `apps/client/test/milestones_view_accessibility_test.gleam` | Given teclado, When expand/collapse/modal, Then atributos a11y correctos | `aria-expanded`, foco visible, `button` |
| AC33 | `apps/client/test/center_panel_milestones_toolbar_test.gleam` | Given modo milestones, When render toolbar, Then sin filtros pool | ausencia `filter-type`/`filter-capability` |
| AC34 | `apps/client/test/milestones_view_accessibility_test.gleam` | Given fila acordeón, When render, Then regiones accesibles estables | `id`, `aria-controls`, `aria-labelledby`, nombre contextual |
| AC35 | `apps/client/test/milestone_activation_modal_test.gleam` | Given modal activación, When open/Esc, Then patrón irreversible seguro | foco inicial en cancelar + Esc cierra |
| AC35b | `apps/client/test/milestone_activation_modal_test.gleam` | Given botón activar abre modal, When cerrar por Cancelar/Esc/X, Then foco retorna | `document.activeElement` vuelve al trigger |

### TDD (gleam-tdd-development)

- Definir ADTs y firmas primero
- Escribir tests de modelo/update antes de implementar
- Tests de validación de reglas de negocio (un solo activo, irreversibilidad)

### Definition of Ready+ (10/10)

- [ ] **DoR+1: SQL operativo cerrado por transición**
  - [ ] Incluir SQL final por operación (`claim`, `release`, `complete`) con precondiciones/postcondiciones explícitas.
  - [ ] Definir regla anti doble-conteo con ejemplos de entrada/salida para `pool_lifetime_s` y `last_entered_pool_at`.

- [ ] **DoR+2: Matriz formal AC -> tests**
  - [ ] Añadir tabla trazable por AC crítico (`AC4`, `AC5`, `AC5b-f`, `AC9`, `AC25-27`, `AC29-35b`) con archivo de test, escenario y asserts clave.
  - [ ] Cada AC crítico debe tener al menos un test de error/borde además del happy path.
  - [ ] Incluir caso obligatorio de eliminación: `view=list` no se admite y no aparece en parse/format/roundtrip.
  - [ ] Expresar escenarios críticos en formato Given/When/Then para ejecución determinista en QA.

- [ ] **DoR+3: Eliminación de URL legacy**
  - [ ] Contrato definitivo (sin ambigüedad): `view=list` -> `Redirect` obligatorio a `view=milestones` en `parse`; `format` nunca emite `list`; `roundtrip(list)` falla de forma determinista.
  - [ ] Actualizar tests existentes (`shared/test/view_mode_test.gleam`, `apps/client/test/url_state_test.gleam`, `apps/client/test/router_test.gleam`) para reflejar el contrato definitivo.

- [ ] **DoR+4: Concurrencia formal de activación**
  - [ ] Definir aislamiento transaccional y manejo de colisión para doble activación simultánea.
  - [ ] Especificar código de error y mensaje funcional esperado para el segundo request.
  - [ ] Mapear `unique_violation` del índice parcial activo -> HTTP `409 MILESTONE_ALREADY_ACTIVE`.
  - [ ] Añadir prueba simultánea: 2 requests `POST /activate` => 1 éxito + 1 conflicto.
  - [ ] Definir secuencia SQL transaccional explícita:
    1) lock por proyecto (`SELECT ... FOR UPDATE` sobre hito activo del proyecto),
    2) intento de activar hito objetivo (`state='active', activated_at=NOW()`),
    3) mapear colisión de índice único parcial a `409 MILESTONE_ALREADY_ACTIVE`.

- [ ] **DoR+5: Presupuesto de rendimiento**
  - [ ] Definir objetivo mínimo para consultas de milestones/pool (p95) y volumen de datos de referencia.
  - [ ] Vincular cada objetivo con índices/queries correspondientes y criterio de aceptación.

- [ ] **DoR+6: Plan de despliegue y rollback**
  - [ ] Orden de despliegue explícito: migración DB -> backend -> frontend.
  - [ ] Checklist de verificación post-deploy y pasos de rollback por capa (DB/backend/frontend).
  - [ ] Migración segura: usar `NOT VALID` en FKs nuevas y `VALIDATE CONSTRAINT` posterior; documentar ventanas de lock.
  - [ ] Rollback: secuencia exacta de `down` (constraints -> índices -> columnas -> tabla) y validación de integridad tras revertir.

### Checklist operativo diario (dev + qa)

- [ ] **Dia 1 - Datos y contratos**
  - [ ] Ejecutar migración `up` en entorno local y validar constraints/índices.
  - [ ] Implementar tipos shared (`milestone`, extensiones `task/card`) con tests de codec.
  - [ ] Validar regla formal de completitud (cards + tasks sueltas) con tests unitarios.

- [ ] **Dia 2 - Backend milestones + pool feed**
  - [ ] Implementar endpoints de milestones y validaciones de activación irreversible.
  - [ ] Ajustar feed Pool para `hito activo + huérfanas`.
  - [ ] Añadir tests de concurrencia (doble activación simultánea) y de herencia `effective_milestone_id`.

- [ ] **Dia 3 - Frontend navegación + vista**
  - [ ] Integrar `ViewMode.Milestones` en sidebar/toggle/center/url_state/router.
  - [ ] Implementar `features/milestones/*` reutilizando `ui/expand_toggle`, `ui/dialog`, `ui/badge`.
  - [ ] Cubrir estados `loading/empty/error` + i18n + accesibilidad (`aria-expanded`, `aria-controls`, foco visible).

- [ ] **Dia 4 - End-to-end + hardening**
  - [ ] Ejecutar matriz AC->tests completa (incluye AC29-AC35b).
  - [ ] Validar eliminación de legacy: no quedan rutas internas ni tests que dependan de `view=list`.
  - [ ] Ejecutar validación visual guiada con browser-agent (sección siguiente).

### Validación visual guiada (browser-agent)

- [ ] **Precondiciones**
  - [ ] Entorno levantado con `sh scripts/dev-hot.sh`.
  - [ ] Navegar siempre vía `http://localhost:8080`.
  - [ ] Usuario de prueba: `admin@example.com` / `passwordpassword`.

- [ ] **Recorrido visual mínimo (browser-agent)**
  - [ ] Login -> abrir sección TRABAJO -> confirmar reemplazo visual de `Lista` por `Hitos`.
  - [ ] Cambiar a vista `Hitos` y validar estado inicial (acordeón plegado + filtros por defecto).
  - [ ] Expandir un hito y validar: progreso, cards, tasks sueltas, badges consistentes.
  - [ ] Abrir modal de detalle de hito y validar foco inicial/tecla `Esc`/restauración de foco al cerrar.
  - [ ] Activación irreversible: validar modal de confirmación, copy i18n y flujo seguro.
  - [ ] Navegación legacy: abrir URL con `view=list`, verificar comportamiento definido de no soporte y ausencia de render "Lista".

- [ ] **Evidencia requerida (guardar artefactos)**
  - [ ] Capturas: sidebar (Hitos activo), acordeón colapsado, acordeón expandido, modal detalle, modal activación.
  - [ ] Capturas de estados: `loading`, `empty`, `error`.
  - [ ] Nota de verificación a11y: teclado + `aria-expanded`/`aria-controls` + retorno de foco.
  - [ ] Registro de URLs finales y resultado esperado/obtenido por paso.

---

## Out of Scope

- Tab de métricas en modal (ver historia 7.5)
- Fechas objetivo para hitos
- Ordenamiento de hitos
- Hitos compartidos entre proyectos

---

## Change Log

| Fecha | Version | Descripcion | Autor |
|-------|---------|-------------|-------|
| 2026-02-06 | 1.0 | Historia creada para sprint 7 | UX/PO |
| 2026-02-06 | 1.1 | Añadidas migraciones de preparación para 7.5: pool_lifetime tracking, workflow traceability | Analyst |
| 2026-02-06 | 1.2 | Alineación de routing a ViewMode, cierre de contrato de estado derivado y plan de tests por archivo | Sarah (PO) |
| 2026-02-06 | 1.3 | Ajustes de validación arquitectónica final: rutas backend reales, integridad/índices y cobertura de concurrencia/feed pool | Winston (Architect) |
| 2026-02-06 | 1.4 | Ajustes UX finales: reuso de componentes, estados de datos y accesibilidad de acordeón/modal, consistencia navegación | Sally (UX Expert) |
| 2026-02-06 | 1.5 | Cierre de brechas arquitectónicas finales: consistencia formal de datos, milestone efectivo en consultas y cobertura AC1-32 | Winston (Architect) |
| 2026-02-06 | 1.6 | Cierre UX final: toolbar de Hitos, normalización legacy `view=list`, accesibilidad avanzada por fila y modal irreversible seguro | Sally (UX Expert) |
| 2026-02-06 | 1.7 | Refinamiento UX final: restauración de foco al cerrar modal y set i18n ampliado para hitos | Sally (UX Expert) |
| 2026-02-06 | 1.8 | Estado actualizado a Ready para inicio de implementación | Sarah (PO) |
| 2026-02-06 | 1.9 | Cierre final pre-ejecución: regla formal de completitud, FK compuestas ejecutables, fórmula SQL de lifetime y migración up/down | Winston (Architect) |
| 2026-02-06 | 1.10 | Añadido bloque Definition of Ready+ para elevar la historia a estándar 10/10 pre-ejecución | Sarah (PO) |
| 2026-02-06 | 1.11 | Añadido checklist operativo diario y validación visual guiada con browser-agent para vistas críticas | Sarah (PO) |
| 2026-02-06 | 1.12 | Ajustes arquitectónicos finales: FK compuestas corregidas, constraint estado/activated_at y contrato de concurrencia/legacy explícito | Winston (Architect) |
| 2026-02-06 | 1.13 | Decisión entorno interno: eliminar soporte legacy `view=list` y actualizar contratos/tests a no compatibilidad | Sarah (PO) |
| 2026-02-06 | 1.14 | Cierre pre-ejecución final: contrato legacy determinista, secuencia transaccional de activación y matriz AC->test obligatoria | Winston (Architect) |

---

## Dev Agent Record

### Agent Model Used

TBD

### Debug Log References

- TBD

### Completion Notes List

- TBD

### File List

- TBD

---

## QA Results

### Review Date: TBD

### Reviewed By: TBD

### Gate Status

Gate: TBD
