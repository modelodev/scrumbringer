# Story 7.4: Hitos (Milestones)

## Status

Draft

## Story

**As a** miembro del proyecto,
**I want** organizar cards y tasks en hitos antes de lanzarlas al pool,
**so that** puedo planificar trabajo futuro sin contaminar el pool con backlog inactivo.

## Problem Statement

Actualmente las tasks se crean y van directo al Pool. Esto genera:
- Pool lleno de trabajo futuro que distrae del foco actual
- Backlog viviendo fuera de ScrumBringer (hojas de cálculo, docs externos)
- Falta de visibilidad sobre qué viene después del trabajo actual

## Filosofía (alineación con brief)

- **Pull real**: el Pool sigue siendo solo trabajo activo; los hitos son planificación
- **Separación clara**: planificación (hitos) vs actividad real (pool) son mundos distintos
- **Irreversibilidad**: activar un hito es un compromiso, refuerza la filosofía Pull
- **Estado implícito**: el estado del hito se deriva de sus cards/tasks

---

## Acceptance Criteria

### Modelo de datos

1. **AC1**: Un hito tiene: nombre, descripción (opcional), estado, proyecto
2. **AC2**: Estados de hito: `ready` (planificación), `active` (lanzado), `completed` (derivado)
3. **AC3**: Un hito puede contener cards y tasks sueltas
4. **AC4**: Máximo 1 hito activo por proyecto
5. **AC5**: El Pool se alimenta de: hito activo + cards/tasks sin hito (huérfanas)
6. **AC5b**: Una task con `card_id` hereda el milestone de su card; no puede tener `milestone_id` propio

### Preparación modelo para métricas (7.5)

7. **AC5c**: Las tasks tienen `pool_lifetime_s` (segundos acumulados en Available) y `last_entered_pool_at`
8. **AC5d**: Las tasks creadas por workflows tienen `created_from_rule_id` para trazabilidad
9. **AC5e**: Al hacer claim, se acumula pool_lifetime y se limpia last_entered_pool_at
10. **AC5f**: Al hacer release, se resetea last_entered_pool_at a NOW()

### Activación de hito

11. **AC6**: Activar un hito lanza todas sus cards y tasks al Pool
12. **AC7**: La activación es irreversible
13. **AC8**: Al activar, se muestra confirmación: "Se lanzarán X cards y Y tasks al Pool. Esta acción no tiene marcha atrás. ¿Continuar?"
14. **AC9**: Si ya hay un hito activo, no se puede activar otro hasta que el actual esté completado
15. **AC10**: Completar el hito activo requiere acción manual para activar el siguiente

### Completitud

16. **AC11**: Un hito se marca `completed` automáticamente cuando todas sus cards y tasks están completadas
17. **AC12**: El progreso del hito se deriva: % de cards completadas
18. **AC13**: El progreso de la card se deriva: % de tasks completadas

### Vista Hitos

19. **AC14**: La vista "Hitos" reemplaza la vista "Lista" en el menú lateral
20. **AC15**: La vista muestra todos los hitos en formato acordeón, plegados por defecto
21. **AC16**: Filtros "ver completados" y "ver vacíos" están desmarcados por defecto
22. **AC17**: El acordeón muestra: nombre, estado, barra de progreso
23. **AC18**: Al expandir: cards (con su progreso) y tasks sueltas

### Modal de hito

24. **AC19**: Click en nombre del hito abre modal de detalle
25. **AC20**: El modal muestra: nombre, estado, descripción, barra de progreso, botón activar (si aplica)
26. **AC21**: El modal permite crear cards y tasks dentro del hito
27. **AC22**: El modal lista cards (expandibles) y tasks sueltas

### Creación y movimiento

28. **AC23**: Los botones "+ Nueva tarea" y "+ Nueva tarjeta" del menú lateral crean en el Pool (hito activo o huérfano)
29. **AC24**: Crear cards/tasks dentro de un hito solo desde la vista/modal de Hitos
30. **AC25**: Se puede mover una card/task entre hitos `ready` via drag & drop (si ambos visibles)
31. **AC26**: Se puede mover una card/task entre hitos `ready` via menú contextual (siempre disponible)
32. **AC27**: No se puede mover contenido del Pool a un hito (separación planificación vs actividad)

### i18n

33. **AC28**: Labels en ES/EN:
    - "Hitos" / "Milestones"
    - "Activar hito" / "Activate milestone"
    - "Se lanzarán X cards y Y tasks al Pool" / "X cards and Y tasks will be launched to Pool"
    - "Esta acción no tiene marcha atrás" / "This action cannot be undone"

---

## Wireframes

### Vista Hitos (acordeón plegado)

```
┌─────────────────────────────────────────────────────────────┐
│ HITOS                           [ ] Completados  [ ] Vacíos │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ ▶ Release 2.0              [ACTIVE]  ████████░░ 80%        │
│                                                             │
│ ▶ Backlog Q2               [READY]   ░░░░░░░░░░ 0%         │
│                                                             │
│ ▶ Tech Debt                [READY]   ██░░░░░░░░ 20%        │
│                                                             │
│                            [+ Nuevo hito]                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### Vista Hitos (acordeón expandido)

```
┌─────────────────────────────────────────────────────────────┐
│ HITOS                           [ ] Completados  [ ] Vacíos │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ ▼ Release 2.0              [ACTIVE]  ████████░░ 80%        │
│   ├─ ▶ Card: Auth refactor          ███░░ 60%    [⋮]      │
│   ├─ ▶ Card: New dashboard          ░░░░░ 0%     [⋮]      │
│   └─ • Task: Update docs            [available]   [⋮]      │
│                                                             │
│ ▼ Backlog Q2               [READY]   ░░░░░░░░░░ 0%         │
│   └─ (vacío)               [+ Card] [+ Task]               │
│                                                             │
│ ▶ Tech Debt                [READY]   ██░░░░░░░░ 20%        │
│                                                             │
│                            [+ Nuevo hito]                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘

Leyenda:
[⋮] = Menú contextual (mover a hito, eliminar)
```

### Modal de hito (tab Contenido)

```
┌─────────────────────────────────────────────────────────────┐
│ Hito: Release 2.0                                    [X]    │
├─────────────────────────────────────────────────────────────┤
│ Estado: READY                          [Activar hito]       │
│                                                             │
│ Progreso  ████████░░░░ 67%                                  │
│                                                             │
│ ─────────────────────────────────────────────────────────── │
│ Descripción:                                                │
│ Release con nuevo sistema de auth y dashboard renovado.     │
│ Incluye migración de tokens y mejoras de UX.                │
│                                                             │
│ ─────────────────────────────────────────────────────────── │
│ Contenido                              [+ Card] [+ Task]    │
│ ─────────────────────────────────────────────────────────── │
│ ▶ Card: Auth refactor                       ███░░ 60%      │
│ ▶ Card: New dashboard                       ░░░░░ 0%       │
│ • Task: Update docs                         [available]     │
│ • Task: Review dependencies                 [available]     │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### Modal de confirmación (activar hito)

```
┌─────────────────────────────────────────────────────────────┐
│ Activar hito                                         [X]    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ⚠️  Se lanzarán al Pool:                                  │
│                                                             │
│       • 4 cards                                             │
│       • 12 tasks                                            │
│                                                             │
│   Esta acción no tiene marcha atrás.                        │
│   Las cards y tasks pasarán a estar disponibles             │
│   para que el equipo las reclame.                           │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│                        [Cancelar]  [Activar hito]           │
└─────────────────────────────────────────────────────────────┘
```

### Menú contextual (mover entre hitos)

```
┌─────────────────────────┐
│ Mover a hito...     ▶  │
├─────────────────────────┤
│   ○ Backlog Q2          │
│   ○ Tech Debt           │
│   ─────────────────     │
│   ○ Sin hito (Pool)     │  ← Solo si hito actual es ready
├─────────────────────────┤
│ Eliminar                │
└─────────────────────────┘
```

---

## Tasks / Subtasks

- [ ] **Task 1: Migración de base de datos** (AC: 1-5, 5b-5f)
  - [ ] 1.1 Crear tabla `milestones`:
    ```sql
    CREATE TABLE milestones (
        id BIGSERIAL PRIMARY KEY,
        project_id BIGINT NOT NULL REFERENCES projects(id),
        name TEXT NOT NULL,
        description TEXT,
        state TEXT NOT NULL DEFAULT 'ready' CHECK (state IN ('ready', 'active')),
        position INT NOT NULL DEFAULT 0,
        created_by BIGINT NOT NULL REFERENCES users(id),
        created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
        activated_at TIMESTAMPTZ
    );
    CREATE INDEX idx_milestones_project ON milestones(project_id);
    CREATE UNIQUE INDEX idx_milestones_one_active ON milestones(project_id) WHERE state = 'active';
    ```
  - [ ] 1.2 Añadir `milestone_id` a `cards`:
    ```sql
    ALTER TABLE cards ADD COLUMN milestone_id BIGINT REFERENCES milestones(id);
    CREATE INDEX idx_cards_milestone ON cards(milestone_id);
    ```
  - [ ] 1.3 Añadir `milestone_id` a `tasks` (excluyente con card_id):
    ```sql
    ALTER TABLE tasks ADD COLUMN milestone_id BIGINT REFERENCES milestones(id);
    CREATE INDEX idx_tasks_milestone ON tasks(milestone_id);
    ALTER TABLE tasks ADD CONSTRAINT task_milestone_exclusive 
        CHECK (NOT (card_id IS NOT NULL AND milestone_id IS NOT NULL));
    ```
  - [ ] 1.4 Añadir columnas de tracking para métricas (prepara 7.5):
    ```sql
    -- Pool lifetime tracking
    ALTER TABLE tasks ADD COLUMN pool_lifetime_s INT NOT NULL DEFAULT 0;
    ALTER TABLE tasks ADD COLUMN last_entered_pool_at TIMESTAMPTZ DEFAULT NOW();
    
    -- Workflow traceability
    ALTER TABLE tasks ADD COLUMN created_from_rule_id BIGINT REFERENCES rules(id);
    CREATE INDEX idx_tasks_created_from_rule ON tasks(created_from_rule_id);
    ```

- [ ] **Task 2: Tipos de dominio** (AC: 1-3)
  - [ ] 2.1 Crear `shared/src/domain/milestone.gleam` con tipos y codecs
  - [ ] 2.2 Definir ADT `MilestoneState = Ready | Active` (Completed es derivado)
  - [ ] 2.3 Actualizar `shared/src/domain/task.gleam` con campos nuevos
  - [ ] 2.4 Actualizar `shared/src/domain/card.gleam` con `milestone_id`

- [ ] **Task 3: API endpoints milestones** (AC: 6-10)
  - [ ] 3.1 `GET /api/v1/projects/:id/milestones` - Lista hitos con contadores
  - [ ] 3.2 `POST /api/v1/projects/:id/milestones` - Crear hito
  - [ ] 3.3 `GET /api/v1/milestones/:id` - Detalle con cards/tasks
  - [ ] 3.4 `PATCH /api/v1/milestones/:id` - Actualizar nombre/descripción
  - [ ] 3.5 `POST /api/v1/milestones/:id/activate` - Activar hito
  - [ ] 3.6 `DELETE /api/v1/milestones/:id` - Eliminar hito (solo si ready y vacío)

- [ ] **Task 4: API mover contenido** (AC: 25-27)
  - [ ] 4.1 `PATCH /api/v1/cards/:id` - Actualizar `milestone_id`
  - [ ] 4.2 `PATCH /api/v1/tasks/:id` - Actualizar `milestone_id`
  - [ ] 4.3 Validar: solo mover a hitos `ready`
  - [ ] 4.4 Validar: no mover desde Pool a hito

- [ ] **Task 5: Tracking de pool_lifetime** (AC: 5e-5f, prepara 7.5)
  - [ ] 5.1 Modificar `task_claim` handler: acumular pool_lifetime_s, limpiar last_entered_pool_at
  - [ ] 5.2 Modificar `task_release` handler: resetear last_entered_pool_at = NOW()
  - [ ] 5.3 Modificar `task_complete` handler: si estaba en pool, sumar tiempo restante

- [ ] **Task 6: Trazabilidad workflows** (AC: 5d, prepara 7.5)
  - [ ] 6.1 Modificar `rules_engine.gleam` → `create_task_from_template`: pasar rule.id
  - [ ] 6.2 Modificar `sql.tasks_create` → aceptar `created_from_rule_id` opcional
  - [ ] 6.3 Actualizar codec de Task para incluir `created_from_rule_id`

- [ ] **Task 7: Navegación y routing** (AC: 14)
  - [ ] 7.1 Reemplazar "Lista" por "Hitos" en left_panel
  - [ ] 7.2 Añadir ruta `/milestones` al router
  - [ ] 7.3 Crear `features/milestones/*` (state/msg/update/view)

- [ ] **Task 8: Vista acordeón** (AC: 15-18)
  - [ ] 8.1 Componente acordeón con expand/collapse (triangulito)
  - [ ] 8.2 Render de hitos con estado y progreso
  - [ ] 8.3 Render de cards y tasks al expandir
  - [ ] 8.4 Filtros completados/vacíos

- [ ] **Task 9: Modal de hito** (AC: 19-22)
  - [ ] 9.1 Modal con detalle de hito
  - [ ] 9.2 Botones crear card/task dentro del hito
  - [ ] 9.3 Lista expandible de contenido

- [ ] **Task 10: Activación de hito** (AC: 6-10)
  - [ ] 10.1 Modal de confirmación con contadores
  - [ ] 10.2 Lógica de activación (estado ready → active)
  - [ ] 10.3 Validación de hito activo único

- [ ] **Task 11: Drag & drop + menú contextual** (AC: 25-26)
  - [ ] 11.1 Drag & drop entre hitos expandidos
  - [ ] 11.2 Menú contextual "Mover a hito..."
  - [ ] 11.3 Selector de hitos destino

- [ ] **Task 12: i18n** (AC: 28)
  - [ ] 12.1 Añadir labels ES/EN

- [ ] **Task 13: Tests** (AC: 1-28)
  - [ ] 13.1 Tests de tipos y ADTs
  - [ ] 13.2 Tests de endpoints
  - [ ] 13.3 Tests de pool_lifetime tracking
  - [ ] 13.4 Tests de created_from_rule_id en rules_engine
  - [ ] 13.5 Tests de vista acordeón
  - [ ] 13.6 Tests de activación y validaciones

---

## Dev Notes

### Archivos clave (backend)

```
# Nuevos
apps/server/src/scrumbringer_server/http/milestones.gleam
apps/server/src/scrumbringer_server/services/milestones_db.gleam
shared/src/domain/milestone.gleam
db/migrations/YYYYMMDDHHMMSS_create_milestones.sql

# Modificar para pool_lifetime tracking
apps/server/src/scrumbringer_server/http/tasks.gleam (claim/release/complete handlers)
apps/server/src/scrumbringer_server/services/tasks_db.gleam

# Modificar para workflow traceability
apps/server/src/scrumbringer_server/services/rules_engine.gleam
apps/server/src/scrumbringer_server/sql/tasks_create.sql

# Modificar para milestone_id
shared/src/domain/task.gleam
shared/src/domain/card.gleam
shared/src/domain/task/codec.gleam
shared/src/domain/card/codec.gleam
```

### Archivos clave (frontend)

```
apps/client/src/scrumbringer_client/features/milestones/state.gleam (nuevo)
apps/client/src/scrumbringer_client/features/milestones/msg.gleam (nuevo)
apps/client/src/scrumbringer_client/features/milestones/update.gleam (nuevo)
apps/client/src/scrumbringer_client/features/milestones/view.gleam (nuevo)
apps/client/src/scrumbringer_client/features/layout/left_panel.gleam
apps/client/src/scrumbringer_client/router.gleam
```

### Refactor Alignment (docs/architecture/refactor-plan-detailed.md)

- Nuevo feature completo `features/milestones/*` (state/msg/update/view)
- `client_view` solo ensambla; `client_update` solo enruta
- Helpers nuevos en `scrumbringer_client/helpers/*`
- Domain types en `shared/src/domain/milestone.gleam`

### Type Notes (gleam-type-system)

```gleam
// === Milestone types ===

pub type MilestoneState {
  Ready
  Active
  // Completed es derivado, no se almacena
}

pub type Milestone {
  Milestone(
    id: Int,
    project_id: Int,
    name: String,
    description: Option(String),
    state: MilestoneState,
    position: Int,
    created_by: Int,
    created_at: String,
    activated_at: Option(String),
  )
}

pub type MilestoneWithProgress {
  MilestoneWithProgress(
    milestone: Milestone,
    cards_total: Int,
    cards_completed: Int,
    tasks_total: Int,
    tasks_completed: Int,
    is_completed: Bool,  // derivado: tasks_total > 0 AND tasks_total == tasks_completed
  )
}

// === Extensiones a Task (campos nuevos) ===

// En Task existente, añadir:
//   milestone_id: Option(Int),           // Solo si task suelta (sin card)
//   pool_lifetime_s: Int,                // Tiempo acumulado en Available
//   last_entered_pool_at: Option(String),// NULL si no está en pool
//   created_from_rule_id: Option(Int),   // Si fue creada por workflow

// === Extensiones a Card ===

// En Card existente, añadir:
//   milestone_id: Option(Int),
```

### Lustre Notes (gleam-lustre)

- Modal de hito sigue patrón existente de card/task modal
- Acordeón reutiliza triangulito de otras vistas
- Effects para API calls en update, nunca en view
- Drag & drop reusa sistema existente del Pool

---

## Testing

- Tests de tipos en `shared/test`
- Tests de endpoints en `apps/server/test`
- Tests de vista en `apps/client/test`

### TDD (gleam-tdd-development)

- Definir ADTs y firmas primero
- Escribir tests de modelo/update antes de implementar
- Tests de validación de reglas de negocio (un solo activo, irreversibilidad)

---

## Out of Scope

- Tab de métricas en modal (ver historia 7.5)
- Fechas objetivo para hitos
- Ordenamiento de hitos
- Hitos compartidos entre proyectos

---

## Change Log

| Fecha | Version | Descripcion | Autor |
|-------|---------|-------------|-------|
| 2026-02-06 | 1.0 | Historia creada para sprint 7 | UX/PO |
| 2026-02-06 | 1.1 | Añadidas migraciones de preparación para 7.5: pool_lifetime tracking, workflow traceability | Analyst |

---

## Dev Agent Record

### Agent Model Used

TBD

### Debug Log References

- TBD

### Completion Notes List

- TBD

### File List

- TBD

---

## QA Results

### Review Date: TBD

### Reviewed By: TBD

### Gate Status

Gate: TBD
