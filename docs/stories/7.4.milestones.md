# Story 7.4: Hitos (Milestones)

## Status

Ready for Done

## Story

**As a** miembro del proyecto,
**I want** organizar cards y tasks en hitos antes de lanzarlas al pool,
**so that** puedo planificar trabajo futuro sin contaminar el pool con backlog inactivo.

## Problem Statement

Actualmente las tasks se crean y van directo al Pool. Esto genera:
- Pool lleno de trabajo futuro que distrae del foco actual
- Backlog viviendo fuera de ScrumBringer (hojas de cálculo, docs externos)
- Falta de visibilidad sobre qué viene después del trabajo actual

## Filosofía (alineación con brief)

- **Pull real**: el Pool sigue siendo solo trabajo activo; los hitos son planificación
- **Separación clara**: planificación (hitos) vs actividad real (pool) son mundos distintos
- **Irreversibilidad**: activar un hito es un compromiso, refuerza la filosofía Pull
- **Estado gobernado por regla**: `completed` se persiste cuando se cumple la regla derivada desde cards/tasks

---

## Acceptance Criteria

### Modelo de datos

1. **AC1**: Un hito tiene: nombre, descripción (opcional), estado, proyecto
2. **AC2**: Estados persistidos de hito: `ready` (planificación), `active` (lanzado), `completed` (cerrado por regla de completitud).
3. **AC3**: Un hito puede contener cards y tasks sueltas
4. **AC4**: Máximo 1 hito activo por proyecto
5. **AC5**: El Pool se alimenta de: hito activo + cards/tasks sin hito (huérfanas)
6. **AC5b**: Una task con `card_id` hereda el milestone de su card; no puede tener `milestone_id` propio

### Preparación modelo para métricas (7.5)

> Alcance acotado para 7.4: estos AC solo requieren schema + wiring mínimo backend (sin UI de métricas en 7.4).

7. **AC5c**: Las tasks tienen `pool_lifetime_s` (BIGINT, segundos acumulados en Available) y `last_entered_pool_at`
8. **AC5d**: Las tasks creadas por workflows tienen `created_from_rule_id` para trazabilidad
9. **AC5e**: Al hacer claim, se acumula pool_lifetime y se limpia last_entered_pool_at
10. **AC5f**: Al hacer release, se resetea last_entered_pool_at a NOW()
11. **AC5g**: Crear card/task desde contexto de hito persiste `milestone_id` cuando aplica; para task con `card_id`, el backend ignora/rechaza `milestone_id` explícito y deriva milestone efectivo desde la card.

### Activación de hito

11. **AC6**: Activar un hito lanza todas sus cards y tasks al Pool
12. **AC7**: La activación es irreversible
13. **AC8**: Al activar, se muestra confirmación: "Se lanzarán X cards y Y tasks al Pool. Esta acción no tiene marcha atrás. ¿Continuar?"
14. **AC9**: Si ya hay un hito activo, no se puede activar otro hasta que el actual esté completado
15. **AC10**: Completar el hito activo requiere acción manual para activar el siguiente
15.1 **AC10b**: `POST /api/v1/milestones/:id/activate` devuelve snapshot de activación (`activated_at`, `cards_released`, `tasks_released`) y mapea colisión de único activo a `409 MILESTONE_ALREADY_ACTIVE`.

### Completitud

16. **AC11**: Un hito pasa automáticamente de `active` a `completed` cuando todas sus cards y tasks están completadas (setea `completed_at`).
17. **AC12**: El progreso del hito se deriva con regla formal:
    - `cards_progress = cards_completed / cards_total`
    - `tasks_progress = tasks_completed / tasks_total` (solo tasks sueltas del hito)
    - `milestone_completed = (cards_completed == cards_total) AND (tasks_completed == tasks_total)`
    - Si `cards_total = 0` y `tasks_total = 0`, entonces `milestone_completed = false`.
18. **AC13**: El progreso de la card se deriva: % de tasks completadas

### Vista Hitos

19. **AC14**: La vista "Hitos" reemplaza la vista "Lista" en el menú lateral y la etiqueta "Tarjetas" pasa a "Kanban".
19.1 **AC14b**: Orden obligatorio en sidebar izquierdo (sección TRABAJO): **Pool - Kanban - Personas - Hitos**.
20. **AC15**: La vista muestra todos los hitos en formato acordeón, plegados por defecto
21. **AC16**: Filtros "ver completados" y "ver vacíos" están desmarcados por defecto
22. **AC17**: El acordeón muestra: nombre, estado, barra de progreso
23. **AC18**: Al expandir: cards (con su progreso) y tasks sueltas

### Modal de hito

24. **AC19**: Click en nombre del hito abre modal de detalle
25. **AC20**: El modal muestra: nombre, estado, descripción, barra de progreso, botón activar (si aplica)
26. **AC21**: El modal permite crear cards y tasks dentro del hito
27. **AC22**: El modal lista cards (expandibles) y tasks sueltas

### Creación y movimiento

28. **AC23**: Los botones "+ Nueva tarea" y "+ Nueva tarjeta" del menú lateral crean en el Pool (hito activo o huérfano)
29. **AC24**: Crear cards/tasks dentro de un hito solo desde la vista/modal de Hitos
30. **AC25**: Se puede mover una card/task entre hitos `ready` via drag & drop (si ambos visibles)
31. **AC26**: Se puede mover una card/task entre hitos `ready` via menú contextual (siempre disponible)
32. **AC27**: No se puede mover contenido del Pool a un hito (separación planificación vs actividad)

### i18n

33. **AC28**: Labels en ES/EN:
    - "Hitos" / "Milestones"
    - "Activar hito" / "Activate milestone"
    - "Se lanzarán X cards y Y tasks al Pool" / "X cards and Y tasks will be launched to Pool"
    - "Esta acción no tiene marcha atrás" / "This action cannot be undone"

### UX, accesibilidad y consistencia visual

34. **AC29**: La vista y modal de hitos reutilizan componentes existentes: `ui/expand_toggle.gleam`, `ui/dialog.gleam`, `ui/badge.gleam` (sin variantes ad hoc locales).
34.1 **AC29b**: El modal de hito reutiliza `ui/tabs.gleam` para secciones internas cuando aplique (evitar tabs ad hoc locales).
35. **AC30**: La navegación de Hitos es consistente en sidebar + center panel + toggle de modo + URL state; no puede coexistir "Lista" como opción visible cuando Hitos la reemplaza y `view=list` queda eliminado.
36. **AC31**: La vista de hitos define estados de datos explícitos con copy i18n: `loading`, `empty`, `error`.
37. **AC32**: El acordeón y acciones del modal son accesibles por teclado (`button`, foco visible) y usan `aria-expanded` + `aria-controls` en expand/collapse.
37.1 **AC32b**: Controles de acordeón y tabs soportan teclado completo (`Enter`/`Space`; en tabs también `ArrowLeft`/`ArrowRight`) con foco visible persistente.
38. **AC33**: La toolbar de Hitos muestra solo controles relevantes de hitos (buscar/filtros propios); no renderiza filtros heredados de Pool ni de Personas.
39. **AC34**: Cada fila del acordeón define región controlada accesible con `id` estable, `aria-controls`, `aria-labelledby` y nombre accesible contextual ("Expandir/Colapsar hito {nombre}").
40. **AC35**: El modal de activación irreversible aplica patrón seguro: foco inicial en "Cancelar", tecla `Esc` cierra sin activar y acción primaria claramente irreversible.
41. **AC35b**: Al cerrar el modal (Cancelar, `Esc` o `X`), el foco vuelve al botón que abrió la acción ("Activar hito").
42. **AC36**: Las listas dinámicas de hitos/cards/tasks renderizan con claves estables (keyed) y `data-testid` semánticos por fila/acción para tests deterministas.
43. **AC37**: Interacción por fila no ambigua: el control de expand/collapse y el control de apertura de modal son elementos separados (ambos accesibles por teclado).

---

## Wireframes

### Vista Hitos (acordeón plegado)

```
┌─────────────────────────────────────────────────────────────┐
│ HITOS                           [ ] Completados  [ ] Vacíos │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ ▶ Release 2.0              [ACTIVE]  ████████░░ 80%        │
│                                                             │
│ ▶ Backlog Q2               [READY]   ░░░░░░░░░░ 0%         │
│                                                             │
│ ▶ Tech Debt                [READY]   ██░░░░░░░░ 20%        │
│                                                             │
│                            [+ Nuevo hito]                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### Vista Hitos (acordeón expandido)

```
┌─────────────────────────────────────────────────────────────┐
│ HITOS                           [ ] Completados  [ ] Vacíos │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ ▼ Release 2.0              [ACTIVE]  ████████░░ 80%        │
│   ├─ ▶ Card: Auth refactor          ███░░ 60%    [⋮]      │
│   ├─ ▶ Card: New dashboard          ░░░░░ 0%     [⋮]      │
│   └─ • Task: Update docs            [available]   [⋮]      │
│                                                             │
│ ▼ Backlog Q2               [READY]   ░░░░░░░░░░ 0%         │
│   └─ (vacío)               [+ Card] [+ Task]               │
│                                                             │
│ ▶ Tech Debt                [READY]   ██░░░░░░░░ 20%        │
│                                                             │
│                            [+ Nuevo hito]                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘

Leyenda:
[⋮] = Menú contextual (mover a hito, eliminar)
```

### Modal de hito (tab Contenido)

```
┌─────────────────────────────────────────────────────────────┐
│ Hito: Release 2.0                                    [X]    │
├─────────────────────────────────────────────────────────────┤
│ Estado: READY                          [Activar hito]       │
│                                                             │
│ Progreso  ████████░░░░ 67%                                  │
│                                                             │
│ ─────────────────────────────────────────────────────────── │
│ Descripción:                                                │
│ Release con nuevo sistema de auth y dashboard renovado.     │
│ Incluye migración de tokens y mejoras de UX.                │
│                                                             │
│ ─────────────────────────────────────────────────────────── │
│ Contenido                              [+ Card] [+ Task]    │
│ ─────────────────────────────────────────────────────────── │
│ ▶ Card: Auth refactor                       ███░░ 60%      │
│ ▶ Card: New dashboard                       ░░░░░ 0%       │
│ • Task: Update docs                         [available]     │
│ • Task: Review dependencies                 [available]     │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### Modal de confirmación (activar hito)

```
┌─────────────────────────────────────────────────────────────┐
│ Activar hito                                         [X]    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ⚠️  Se lanzarán al Pool:                                  │
│                                                             │
│       • 4 cards                                             │
│       • 12 tasks                                            │
│                                                             │
│   Esta acción no tiene marcha atrás.                        │
│   Las cards y tasks pasarán a estar disponibles             │
│   para que el equipo las reclame.                           │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│                        [Cancelar]  [Activar hito]           │
└─────────────────────────────────────────────────────────────┘
```

### Menú contextual (mover entre hitos)

```
┌─────────────────────────┐
│ Mover a hito...     ▶  │
├─────────────────────────┤
│   ○ Backlog Q2          │
│   ○ Tech Debt           │
│   ─────────────────     │
│   ○ Sin hito (Pool)     │  ← Solo si hito actual es ready
├─────────────────────────┤
│ Eliminar                │
└─────────────────────────┘
```

---

## Tasks / Subtasks

- [ ] **Task 1: Migración de base de datos** (AC: 1-5, 5b-5f)
  - [ ] 1.1 Crear tabla `milestones`:
    ```sql
    CREATE TABLE milestones (
        id BIGSERIAL PRIMARY KEY,
        project_id BIGINT NOT NULL REFERENCES projects(id),
        name TEXT NOT NULL,
        description TEXT,
        state TEXT NOT NULL DEFAULT 'ready' CHECK (state IN ('ready', 'active', 'completed')),
        position INT NOT NULL DEFAULT 0,
        created_by BIGINT NOT NULL REFERENCES users(id),
        created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
        activated_at TIMESTAMPTZ,
        completed_at TIMESTAMPTZ
    );
    CREATE INDEX idx_milestones_project ON milestones(project_id);
    CREATE UNIQUE INDEX idx_milestones_one_active ON milestones(project_id) WHERE state = 'active';
    ```
  - [ ] 1.2 Añadir `milestone_id` a `cards`:
    ```sql
    ALTER TABLE cards ADD COLUMN milestone_id BIGINT;
    CREATE INDEX idx_cards_milestone ON cards(milestone_id);
    ```
  - [ ] 1.3 Añadir `milestone_id` a `tasks` (excluyente con card_id):
    ```sql
    ALTER TABLE tasks ADD COLUMN milestone_id BIGINT;
    CREATE INDEX idx_tasks_milestone ON tasks(milestone_id);
    ALTER TABLE tasks ADD CONSTRAINT task_milestone_exclusive 
        CHECK (NOT (card_id IS NOT NULL AND milestone_id IS NOT NULL));
    ALTER TABLE milestones ADD CONSTRAINT milestones_project_id_id_unique UNIQUE (project_id, id);
    ALTER TABLE cards ADD CONSTRAINT cards_project_milestone_fk
      FOREIGN KEY (project_id, milestone_id) REFERENCES milestones(project_id, id) NOT VALID;
    ALTER TABLE tasks ADD CONSTRAINT tasks_project_milestone_fk
      FOREIGN KEY (project_id, milestone_id) REFERENCES milestones(project_id, id) NOT VALID;
    ALTER TABLE cards ADD CONSTRAINT cards_project_id_id_unique UNIQUE (project_id, id);
    ALTER TABLE tasks ADD CONSTRAINT tasks_project_card_fk
      FOREIGN KEY (project_id, card_id) REFERENCES cards(project_id, id) NOT VALID;
    ALTER TABLE milestones ADD CONSTRAINT milestones_state_activation_consistency
      CHECK (
        (state = 'ready' AND activated_at IS NULL) OR
        (state = 'active' AND activated_at IS NOT NULL AND completed_at IS NULL) OR
        (state = 'completed' AND activated_at IS NOT NULL AND completed_at IS NOT NULL)
      );
    ```
  - [ ] 1.3.1 Endurecer semántica AC5b en DB + tests:
    - Ejecutar `VALIDATE CONSTRAINT` en paso online separado para:
      - `cards_project_milestone_fk`
      - `tasks_project_milestone_fk`
      - `tasks_project_card_fk`
    - Mantener `CHECK (card_id IS NULL OR milestone_id IS NULL)` como regla de escritura.
    - `effective_milestone_id = COALESCE(t.milestone_id, c.milestone_id)` solo en lectura (queries/mappers).
    - Añadir validación de integridad cruzada: si `tasks.card_id IS NOT NULL`, el `project_id` de la card coincide con `tasks.project_id`.
  - [ ] 1.3.2 Reforzar integridad semántica AC5b: task con `card_id` no persiste `milestone_id`; definir `effective_milestone_id` en queries/mappers (`COALESCE(task.milestone_id, card.milestone_id)`).
  - [ ] 1.4 Añadir columnas de tracking para métricas (prepara 7.5):
    ```sql
    -- Pool lifetime tracking
    ALTER TABLE tasks ADD COLUMN pool_lifetime_s BIGINT NOT NULL DEFAULT 0;
    ALTER TABLE tasks ADD COLUMN last_entered_pool_at TIMESTAMPTZ;
    UPDATE tasks
    SET last_entered_pool_at = CASE WHEN status = 'available' THEN created_at ELSE NULL END;
    ALTER TABLE tasks ADD CONSTRAINT tasks_pool_lifetime_non_negative CHECK (pool_lifetime_s >= 0);
    
    -- Workflow traceability
    ALTER TABLE tasks ADD COLUMN created_from_rule_id BIGINT REFERENCES rules(id) ON DELETE SET NULL;
    CREATE INDEX idx_tasks_created_from_rule ON tasks(created_from_rule_id);
    ```
  - [ ] 1.5 Reforzar índices para consultas de milestones/pool:
    ```sql
    CREATE INDEX idx_milestones_project_state_position ON milestones(project_id, state, position);
    CREATE INDEX idx_cards_project_milestone ON cards(project_id, milestone_id);
    CREATE INDEX idx_tasks_project_milestone_status ON tasks(project_id, milestone_id, status);
    CREATE INDEX idx_tasks_card_status ON tasks(card_id, status);
    ```

- [ ] **Task 2: Tipos de dominio** (AC: 1-3)
  - [ ] 2.1 Crear `shared/src/domain/milestone.gleam` con tipos y codecs
  - [ ] 2.2 Definir ADT `MilestoneState = Ready | Active | Completed`.
  - [ ] 2.3 Actualizar `shared/src/domain/task.gleam` con campos nuevos
  - [ ] 2.4 Actualizar `shared/src/domain/card.gleam` con `milestone_id`

- [ ] **Task 3: API endpoints milestones** (AC: 6-10)
  - [ ] 3.1 `GET /api/v1/projects/:id/milestones` - Lista hitos con contadores
  - [ ] 3.2 `POST /api/v1/projects/:id/milestones` - Crear hito
  - [ ] 3.3 `GET /api/v1/milestones/:id` - Detalle con cards/tasks
  - [ ] 3.4 `PATCH /api/v1/milestones/:id` - Actualizar nombre/descripción
  - [ ] 3.5 `POST /api/v1/milestones/:id/activate` - Activar hito
  - [ ] 3.6 `DELETE /api/v1/milestones/:id` - Eliminar hito (solo si ready y vacío)
  - [ ] 3.7 Ajustar feed de Pool para AC5 con contrato SQL explícito:
    - incluir task si (`effective_milestone_id` pertenece al hito activo del proyecto) O (task huérfana sin card y sin milestone) O (task de card huérfana),
    - usar `effective_milestone_id = COALESCE(t.milestone_id, c.milestone_id)`,
    - excluir siempre contenido de hitos `ready` del feed Pool.
  - [ ] 3.8 Definir contrato HTTP por endpoint (request/response/error) para TDD contract-first:
    - códigos esperados: `200/201/204/400/404/409/422`,
    - errores obligatorios: `MILESTONE_ALREADY_ACTIVE`, `TASK_MILESTONE_INHERITED_FROM_CARD`, `MILESTONE_ACTIVATION_IRREVERSIBLE`, `INVALID_MOVE_POOL_TO_MILESTONE`,
    - ejemplos JSON de request/response por endpoint.
  - [ ] 3.9 Extender contratos de creación para AC5g:
    - `POST /api/v1/projects/:id/cards` acepta `milestone_id` opcional (solo `ready` o `null`),
    - `POST /api/v1/projects/:id/tasks` acepta `milestone_id` solo cuando `card_id IS NULL`,
    - si `card_id IS NOT NULL` y llega `milestone_id`, responder `422 TASK_MILESTONE_INHERITED_FROM_CARD`.

- [ ] **Task 4: API mover contenido** (AC: 25-27)
  - [ ] 4.1 `PATCH /api/v1/cards/:id` - Actualizar `milestone_id`
  - [ ] 4.2 `PATCH /api/v1/tasks/:id` - Actualizar `milestone_id` SOLO para tasks sin `card_id`.
  - [ ] 4.2.1 Si `card_id IS NOT NULL` y se envía `milestone_id`, responder `422 TASK_MILESTONE_INHERITED_FROM_CARD`.
  - [ ] 4.3 Validar: solo mover a hitos `ready`
  - [ ] 4.4 Validar: no mover desde Pool a hito

- [ ] **Task 5: Tracking de pool_lifetime** (AC: 5e-5f, prepara 7.5)
  - [ ] 5.1 Modificar `apps/server/src/scrumbringer_server/http/tasks/tasks_transitions.gleam` + SQL de claim/release/complete.
  - [ ] 5.2 Fijar fórmula SQL anti doble-conteo y null-safety:
    ```sql
    pool_lifetime_s = pool_lifetime_s + GREATEST(0, EXTRACT(EPOCH FROM (NOW() - last_entered_pool_at))::BIGINT)
    ```
    Aplicar en `claim/complete` solo cuando `last_entered_pool_at IS NOT NULL`; luego setear `last_entered_pool_at = NULL`.
    En `release`, setear `last_entered_pool_at = NOW()`.
  - [ ] 5.3 Modificar `task_complete` para sumar tiempo restante si aplica (sin duplicar acumulación previa).
  - [ ] 5.4 Añadir helpers SQL reutilizables para acumulación (`claim/complete`) y reset (`release`) evitando lógica duplicada entre queries.
  - [ ] 5.5 Tests de concurrencia en transiciones (`claim` vs `complete` y `release` repetido) con reloj controlado: sin doble conteo, sin valores negativos, sin drift temporal.

- [ ] **Task 6: Trazabilidad workflows** (AC: 5d, prepara 7.5)
  - [ ] 6.1 Modificar `rules_engine.gleam` → `create_task_from_template`: pasar rule.id
  - [ ] 6.2 Modificar `sql.tasks_create` → aceptar `created_from_rule_id` opcional
  - [ ] 6.2.1 Actualizar todos los callsites de `tasks_create` (incluyendo creación estándar) para nueva aridad/shape.
  - [ ] 6.2.2 Regenerar bindings SQL tipados (`sql.gleam`) y validar compilación backend.
  - [ ] 6.3 Actualizar codec de Task para incluir `created_from_rule_id`
  - [ ] 6.4 Introducir errores tipados compartidos para milestones en `shared/src/domain/api_error*` y mapearlos 1:1 en handlers HTTP.
  - [ ] 6.5 Evitar códigos string ad hoc en handlers: usar ADT de error + codec compartido.

- [ ] **Task 7: Navegación y routing** (AC: 14, 14b)
  - [ ] 7.1 Reemplazar "Lista" por "Hitos" en left_panel
  - [ ] 7.1.1 Renombrar etiqueta "Tarjetas" a "Kanban" en left_panel y view_mode_toggle.
  - [ ] 7.1.2 Aplicar orden final en sidebar TRABAJO: `Pool - Kanban - Personas - Hitos`.
  - [ ] 7.2 Añadir `ViewMode.Milestones` al flujo actual de member URL state (`view=milestones`) sin crear ruta nueva `/milestones`
  - [ ] 7.2.1 Actualizar wiring en `client_view.gleam` y `client_update.gleam` para eliminar cualquier referencia residual a `List`.
  - [ ] 7.3 Crear `features/milestones/*` (state/msg/update/view)

- [ ] **Task 8: Vista acordeón** (AC: 15-18)
  - [x] 8.1 Componente acordeón con expand/collapse (triangulito)
  - [ ] 8.2 Render de hitos con estado y progreso
  - [ ] 8.3 Render de cards y tasks al expandir
  - [x] 8.4 Filtros completados/vacíos
  - [ ] 8.5 Reutilizar `ui/expand_toggle.gleam` para indicador expand/collapse.
  - [ ] 8.6 Incluir estados `loading/empty/error` con copy i18n en la vista de hitos.
  - [x] 8.7 Renderizar filas con keyed list + `data-testid` estables (`milestone-row:{id}`, `milestone-toggle:{id}`, `milestone-progress:{id}`).
  - [ ] 8.8 Separar controles por fila: botón de expand/collapse y botón/título para abrir modal (sin control único ambiguo).

- [ ] **Task 9: Modal de hito** (AC: 19-22)
  - [ ] 9.1 Modal con detalle de hito
  - [ ] 9.2 Botones crear card/task dentro del hito
  - [ ] 9.3 Lista expandible de contenido
  - [ ] 9.4 Reutilizar `ui/dialog.gleam` y patrones de modal existentes (header/cierre/footer).
  - [ ] 9.5 Implementar comportamiento irreversible mediante extensión/wrapper reusable sobre `ui/dialog.gleam` (sin lógica ad hoc local).

- [ ] **Task 10: Activación de hito** (AC: 6-10)
  - [ ] 10.1 Modal de confirmación con contadores
  - [ ] 10.2 Lógica de activación (estado ready → active)
  - [ ] 10.2.1 Lógica de completitud: transición automática `active -> completed` con `completed_at = NOW()` al cumplirse AC11.
  - [ ] 10.3 Validación de hito activo único
  - [ ] 10.3.1 Concurrencia determinista de activación:
    - Ejecutar 2 requests concurrentes `POST /activate` sobre mismo proyecto con barrera de sincronización.
    - Assert obligatorio: exactamente `1x 200` + `1x 409 MILESTONE_ALREADY_ACTIVE`.
    - Verificar persistencia final: solo un registro `state='active'` por `project_id`.
  - [ ] 10.4 Ejecutar transición automática a `completed` desde hooks de dominio en transiciones de task/card (idempotente, una sola query condicional).
  - [ ] 10.5 Definir función SQL única de recomputación de progreso/completitud para evitar divergencia entre endpoints.

- [ ] **Task 11: Drag & drop + menú contextual** (AC: 25-26)
  - [ ] 11.1 Drag & drop entre hitos expandidos
  - [ ] 11.2 Menú contextual "Mover a hito..."
  - [ ] 11.3 Selector de hitos destino

- [ ] **Task 12: i18n** (AC: 28, 31, 35, 35b)
  - [ ] 12.1 Añadir labels ES/EN
  - [x] 12.2 Añadir copy para estados de datos de hitos (`loading`, `empty`, `error`).
  - [x] 12.3 Añadir keys i18n de milestones y accesibilidad: `Milestones`, `Milestone`, `ActivateMilestone`, `MilestonesLoading`, `MilestonesEmpty`, `MilestonesError`, `MilestonesNoResults`, `ShowCompletedMilestones`, `ShowEmptyMilestones`, `MilestoneActivationTitle`, `MilestoneActivationBody(cards_count, tasks_count)`, `MilestoneActivationIrreversible`, `ExpandMilestone(name)`, `CollapseMilestone(name)`.
  - [ ] 12.4 Asegurar clave de navegación `Kanban` (ES/EN) en el catálogo i18n de sidebar/toggle.

- [ ] **Task 12b: Consistencia de navegación** (AC: 30, 33)
  - [ ] 12b.1 Alinear sidebar y `view_mode_toggle` para que Hitos reemplace Lista sin duplicidad.
  - [ ] 12b.1.1 Mantener `view_mode_toggle` como fuente oficial junto a sidebar (mismos labels, mismo orden, mismos modos vigentes).
  - [ ] 12b.2 Asegurar estado activo coherente para `view=milestones`.
  - [ ] 12b.3 Definir toolbar específica de Hitos (sin filtros de tipo/capacidad del Pool).

- [ ] **Task 12c: Compatibilidad y accesibilidad avanzada** (AC: 30, 34, 35)
  - [ ] 12c.1 Eliminar `List` del dominio (`ViewMode`) y de router/url_state/serialización; actualizar rutas internas a `view=milestones`.
  - [ ] 12c.1.1 Eliminar tests/fixtures legacy que dependan de `view=list` y reemplazarlos por asserts de ausencia de `List` en parse/format/UI.
  - [ ] 12c.1.2 Barrido obligatorio de dependencias legacy: `pool_prefs`, `left_panel`, `center_panel`, `view_mode_toggle`, `client_view`, `shared/test`, `apps/client/test`.
  - [ ] 12c.2 Implementar `aria-controls`/`aria-labelledby` por ítem de acordeón con ids estables.
  - [ ] 12c.3 En modal de activación, foco inicial en cancelar y soporte `Esc` sin ejecutar activación.
  - [ ] 12c.4 Restaurar foco al botón invocador al cerrar modal (`Cancelar`, `Esc`, `X`).
  - [ ] 12c.5 Definir `data-testid` estables para a11y del flujo de activación:
    - `milestone-activate-trigger:{id}`
    - `milestone-activate-cancel`
    - `milestone-activate-confirm`

- [ ] **Task 13: Tests** (AC: 1-37)
  - [ ] 13.1 Tests de tipos y ADTs
  - [ ] 13.2 Tests de endpoints
  - [ ] 13.3 Tests de pool_lifetime tracking
  - [ ] 13.4 Tests de created_from_rule_id en rules_engine
  - [x] 13.5 Tests de vista acordeón
  - [ ] 13.6 Tests de activación y validaciones
  - [ ] 13.7 Tests de concurrencia AC4/AC9: activaciones simultáneas mantienen un solo hito activo por proyecto.
  - [ ] 13.8 Tests AC5/AC5b: feed Pool = activo + huérfanas; herencia milestone por card sin milestone en task hija.
  - [ ] 13.9 Tests AC25-AC27: mover entre hitos ready (DnD/menú) y prohibición de Pool -> hito.
  - [ ] 13.10 Tests de migración: constraints e índices críticos creados correctamente.
  - [x] 13.11 Tests AC29: reutilización de componentes (`expand_toggle`, `dialog`, `badge`) en vista/modal de hitos.
  - [ ] 13.12 Tests AC30: consistencia de navegación (sidebar + toggle + URL state) con contrato final obligatorio:
    - `ViewMode.List` no existe en dominio
    - parse/format URL no contemplan `view=list`
    - UI no renderiza vista/entrada "Lista"
  - [x] 13.13 Tests AC31/AC32: estados `loading/empty/error` con i18n + accesibilidad teclado + `aria-expanded`/`aria-controls` por ítem.
  - [ ] 13.14 Tests AC33: toolbar de Hitos no renderiza filtros de tipo/capacidad de Pool.
  - [ ] 13.15 Tests AC34: región accesible por fila (`aria-controls` + `aria-labelledby` + nombre contextual).
  - [x] 13.16 Tests AC35: modal irreversible (foco inicial en cancelar, `Esc` cierra, no activa accidentalmente).
  - [ ] 13.17 Tests AC35b: al cerrar modal se restaura foco al botón que abrió la acción.
  - [ ] 13.17.1 Tests a11y modal con testids estables: foco inicial en cancelar, `Esc` sin side effects de activación, retorno al trigger exacto.
  - [ ] 13.18 Añadir matriz AC -> test (Given/When/Then) para AC29-AC35b con asserts explícitos.
  - [ ] 13.19 Test AC14b: validar orden exacto de sidebar TRABAJO (`Pool - Kanban - Personas - Hitos`) y labels ES/EN.
  - [ ] 13.20 Tests AC5g: creación en milestone (`cards_create`/`tasks_create`) + rechazo `422 TASK_MILESTONE_INHERITED_FROM_CARD`.
  - [ ] 13.21 Tests AC10b: respuesta de activación incluye snapshot y colisión concurrente mapea a `409 MILESTONE_ALREADY_ACTIVE`.
  - [x] 13.22 Tests AC36: presencia de keyed/data-testid estables por fila y acción en vista de hitos.
  - [x] 13.23 Tests AC37: interacción por fila separada (expand no abre modal, abrir modal no altera expand salvo acción explícita).
  - [ ] 13.27 Test explícito de `ui/dialog.gleam` en flujo irreversible: cierre por `Cancelar`/`Esc`/`X` con retorno al trigger exacto.
  - [ ] 13.28 Test de teclado en tabs/acordeón: `Enter`/`Space` y navegación `ArrowLeft`/`ArrowRight` en tabs.
  - [ ] 13.24 Tests de regresión de feed Pool para evitar fuga de contenido en hitos `ready` tras mover/activar/completar.
  - [ ] 13.25 Tests de rollback de migración (`up -> down -> up`) verificando integridad, índices críticos y compatibilidad de codecs.

- [ ] **Task 14: Migración segura y rollback** (AC: 1-5f)
  - [ ] 14.1 Definir migración con bloques `-- migrate:up` y `-- migrate:down` siguiendo patrón del repo.
  - [ ] 14.1.1 Estrategia online obligatoria: crear FKs nuevas como `NOT VALID` y luego `VALIDATE CONSTRAINT`.
  - [ ] 14.1.2 Documentar ventanas de lock por operación de migración y orden recomendado de ejecución.
  - [ ] 14.1.3 Ejecutar `VALIDATE CONSTRAINT` en paso separado tras backfill y verificación de integridad.
  - [ ] 14.1.4 Incluir SQL explícito de `VALIDATE CONSTRAINT` por cada FK añadida y verificación post-validate (`violations = 0`).
  - [ ] 14.2 Incluir plan de backfill y rollback operacional (orden de ejecución, validaciones y reversión).
  - [ ] 14.3 Añadir tests de migración con verificación de `up/down` e idempotencia de datos.
  - [ ] 14.4 Contrato SQL `up/down` explícito en la historia (sin ambigüedad):
    - `up`: crear tabla/columnas -> crear índices -> crear FKs `NOT VALID` -> backfill -> `VALIDATE CONSTRAINT`.
    - `down`: drop FKs -> drop índices -> drop columnas -> drop tabla milestones.
    - verificación post-rollback de integridad y compatibilidad de codecs.

---

## Dev Notes

### Archivos clave (backend)

```
# Nuevos
apps/server/src/scrumbringer_server/http/milestones.gleam
apps/server/src/scrumbringer_server/services/milestones_db.gleam
shared/src/domain/milestone.gleam
db/migrations/YYYYMMDDHHMMSS_create_milestones.sql

# Modificar para pool_lifetime tracking
apps/server/src/scrumbringer_server/http/tasks/tasks_transitions.gleam (claim/release/complete handlers)
apps/server/src/scrumbringer_server/persistence/tasks/queries.gleam
apps/server/src/scrumbringer_server/persistence/tasks/mappers.gleam
apps/server/src/scrumbringer_server/sql/tasks_claim.sql
apps/server/src/scrumbringer_server/sql/tasks_release.sql
apps/server/src/scrumbringer_server/sql/tasks_complete.sql

# Modificar para workflow traceability
apps/server/src/scrumbringer_server/services/rules_engine.gleam
apps/server/src/scrumbringer_server/sql/tasks_create.sql

# Modificar para feed de Pool (AC5)
apps/server/src/scrumbringer_server/sql/tasks_list.sql

# Nuevos SQL milestones (queries tipadas)
apps/server/src/scrumbringer_server/sql/milestones_list.sql
apps/server/src/scrumbringer_server/sql/milestones_get.sql
apps/server/src/scrumbringer_server/sql/milestones_create.sql
apps/server/src/scrumbringer_server/sql/milestones_activate.sql
apps/server/src/scrumbringer_server/sql/milestones_recompute_completion.sql

# Modificar para milestone_id
shared/src/domain/task.gleam
shared/src/domain/card.gleam
shared/src/domain/task/codec.gleam
shared/src/domain/card/codec.gleam
```

### Archivos clave (frontend)

```
apps/client/src/scrumbringer_client/features/milestones/state.gleam (nuevo)
apps/client/src/scrumbringer_client/features/milestones/msg.gleam (nuevo)
apps/client/src/scrumbringer_client/features/milestones/update.gleam (nuevo)
apps/client/src/scrumbringer_client/features/milestones/view.gleam (nuevo)
apps/client/src/scrumbringer_client/features/layout/left_panel.gleam
apps/client/src/scrumbringer_client/features/layout/center_panel.gleam
apps/client/src/scrumbringer_client/features/layout/view_mode_toggle.gleam
apps/client/src/scrumbringer_client/router.gleam
apps/client/src/scrumbringer_client/url_state.gleam
apps/client/src/scrumbringer_client/client_view.gleam
apps/client/src/scrumbringer_client/client_update.gleam
shared/src/domain/view_mode.gleam
```

### Refactor Alignment (docs/architecture/refactor-plan-detailed.md)

- Nuevo feature completo `features/milestones/*` (state/msg/update/view)
- `client_view` solo ensambla; `client_update` solo enruta
- Helpers nuevos en `scrumbringer_client/helpers/*`
- Domain types en `shared/src/domain/milestone.gleam`
- `router.gleam` parsea path y delega query en `url_state` (fuente única parse/format)
- Tests obligatorios de roundtrip `parse -> format -> parse` para `view=milestones` y queries inválidas
- Mantener `view` puro (sin FFI/browser API) y efectos solo en `update` (`Effect`)

### Fuentes verificadas + skills obligatorias aplicadas

- Fuentes de verdad para esta historia (anti-hallucination):
  - [Source: docs/architecture/coding-standards.md]
  - [Source: docs/architecture/tech-stack.md]
  - [Source: docs/architecture/source-tree.md]
  - [Source: docs/architecture/refactor-plan-detailed.md]
- Aplicación explícita de skills:
  - `gleam-tdd-development`: firmas/tipos y tests primero, implementación después (contract-first).
  - `gleam-lustre`: TEA estricto (`state/msg/update/view`), `view` puro y efectos solo en `update`.
  - `gleam-type-system`: ADTs exhaustivos + `Result`/errores tipados compartidos, sin códigos string ad hoc.
- Orden de implementación obligatorio (TDD):
  1. Definir ADTs/aliases/opaque types y contratos HTTP tipados.
  2. Escribir tests que fallen (dominio, SQL, HTTP, UI/a11y).
  3. Implementar mínimo para pasar tests.
  4. Refactorizar sin romper contratos ni cobertura.

### Type Notes (gleam-type-system)

```gleam
// === Milestone types ===

pub type MilestoneState {
  Ready
  Active
  Completed
}

pub type Milestone {
  Milestone(
    id: Int,
    project_id: Int,
    name: String,
    description: Option(String),
    state: MilestoneState,
    position: Int,
    created_by: Int,
    created_at: String,
    activated_at: Option(String),
    completed_at: Option(String),
  )
}

pub type MilestoneWithProgress {
  MilestoneWithProgress(
    milestone: Milestone,
    cards_total: Int,
    cards_completed: Int,
    tasks_total: Int,
    tasks_completed: Int,
    is_completed: Bool,  // derivado: cards_total == cards_completed AND tasks_total == tasks_completed
  )
}

// === Extensiones a Task (campos nuevos) ===

// En Task existente, añadir:
//   milestone_id: Option(Int),           // Solo si task suelta (sin card)
//   pool_lifetime_s: Int,                // Persistido como BIGINT en DB; en Gleam se modela como Int
//   last_entered_pool_at: Option(String),// NULL si no está en pool
//   created_from_rule_id: Option(Int),   // Si fue creada por workflow

// === Extensiones a Card ===

// En Card existente, añadir:
//   milestone_id: Option(Int),

// === Opaque IDs y aliases semánticos (type safety) ===
pub opaque type MilestoneId {
  MilestoneId(Int)
}

pub opaque type RuleId {
  RuleId(Int)
}

pub type LifetimeSeconds = Int

// En Task existente, preferir:
//   milestone_id: Option(MilestoneId)
//   created_from_rule_id: Option(RuleId)
//   pool_lifetime_s: LifetimeSeconds
```

### Lustre Notes (gleam-lustre)

- Modal de hito sigue patrón existente de card/task modal
- Acordeón reutiliza `ui/expand_toggle.gleam` de otras vistas
- Effects para API calls en update, nunca en view
- Drag & drop reusa sistema existente del Pool

### Reuso UI obligatorio

- Reutilizar `ui/dialog.gleam` para modal de hito y confirmación de activación.
- Reutilizar `ui/badge.gleam` para estados (`ready`, `active`, `completed`).
- Evitar crear clases o componentes locales duplicados cuando ya existe patrón equivalente.

---

## Testing

- Tests de tipos en `shared/test`
- Tests de endpoints en `apps/server/test`
- Tests de vista en `apps/client/test`
- Matriz mínima de tests por área:
  - `shared/test/domain/milestone*_test.gleam`: ADTs/codec + derivación `completed`.
  - `apps/server/test/milestones_http_test.gleam`: CRUD, activación irreversible, único activo por proyecto.
  - `apps/server/test/tasks_pool_lifetime_test.gleam`: claim/release/complete acumulan/resetean tiempos.
  - `apps/server/test/rules_engine_milestone_trace_test.gleam`: `created_from_rule_id` en creación por workflow.
  - `apps/client/test/url_state_test.gleam` + `apps/client/test/router_test.gleam`: `view=milestones` parse/format/roundtrip.
  - `apps/client/test/left_panel_test.gleam` + `apps/client/test/center_panel_test.gleam`: reemplazo visual Lista->Hitos y render de vista.
  - `apps/client/test/milestones_view_test.gleam`: acordeón, filtros, progreso, expand/collapse.
  - `apps/client/test/milestone_modal_test.gleam`: detalle, activación, contenido y acciones de creación.

### Matriz AC -> test (obligatoria para AC29-AC35b)

| AC | Archivo test | Escenario Given/When/Then | Assert clave |
|----|--------------|---------------------------|--------------|
| AC29 | `apps/client/test/milestones_view_test.gleam` + `apps/client/test/milestone_modal_test.gleam` | Given vista hitos, When render, Then usa componentes compartidos | presencia de `expand_toggle`, `dialog`, `badge` |
| AC30 | `shared/test/view_mode_test.gleam` + `apps/client/test/url_state_test.gleam` + `apps/client/test/router_test.gleam` + `apps/client/test/left_panel_test.gleam` + `apps/client/test/center_panel_test.gleam` | Given dominio/routing/UI de navegación de trabajo, When parse/format/nav/render, Then no existe `List` | ausencia de `ViewMode.List`, ausencia de `view=list`, ausencia UI Lista |
| AC31 | `apps/client/test/milestones_view_test.gleam` | Given carga remota, When `loading/empty/error`, Then copy i18n correcto | textos i18n y estados |
| AC32 | `apps/client/test/milestones_view_accessibility_test.gleam` | Given teclado, When expand/collapse/modal, Then atributos a11y correctos | `aria-expanded`, foco visible, `button` |
| AC33 | `apps/client/test/center_panel_milestones_toolbar_test.gleam` | Given modo milestones, When render toolbar, Then sin filtros pool | ausencia `filter-type`/`filter-capability` |
| AC34 | `apps/client/test/milestones_view_accessibility_test.gleam` | Given fila acordeón, When render, Then regiones accesibles estables | `id`, `aria-controls`, `aria-labelledby`, nombre contextual |
| AC35 | `apps/client/test/milestone_activation_modal_test.gleam` | Given modal activación, When open/Esc, Then patrón irreversible seguro | foco inicial en cancelar + Esc cierra |
| AC35b | `apps/client/test/milestone_activation_modal_test.gleam` | Given botón activar abre modal, When cerrar por Cancelar/Esc/X, Then foco retorna | `document.activeElement` vuelve al trigger |
| AC37 | `apps/client/test/milestones_row_interaction_test.gleam` | Given fila de hito, When usar control expand o abrir detalle, Then acciones no se mezclan | expand y modal con controles independientes |
| AC4/AC9 (race) | `apps/server/test/milestones_activate_concurrency_test.gleam` | Given dos activaciones concurrentes sobre mismo proyecto, When ejecutan con barrera, Then 1 éxito + 1 conflicto | exactamente `1x 200` + `1x 409 MILESTONE_ALREADY_ACTIVE` |
| AC5e/AC5f (race) | `apps/server/test/tasks_pool_lifetime_concurrency_test.gleam` | Given transiciones simultáneas claim/complete/release, When compiten por misma task, Then acumulación consistente | `pool_lifetime_s` monotónico, sin doble conteo |
| AC5/AC5b (regresión) | `apps/server/test/tasks_pool_feed_regression_test.gleam` | Given hitos ready/active + huérfanas + tasks de card, When listar Pool, Then solo activo+huérfanas | nunca filtra contenido de `ready`; `effective_milestone_id` correcto |

### TDD (gleam-tdd-development)

- Definir ADTs y firmas primero
- Escribir tests de modelo/update antes de implementar
- Tests de validación de reglas de negocio (un solo activo, irreversibilidad)

### Definition of Ready+ (10/10)

- [ ] **DoR+1: SQL operativo cerrado por transición**
  - [ ] Incluir SQL final por operación (`claim`, `release`, `complete`) con precondiciones/postcondiciones explícitas.
  - [ ] Definir regla anti doble-conteo con ejemplos de entrada/salida para `pool_lifetime_s` y `last_entered_pool_at`.

- [ ] **DoR+2: Matriz formal AC -> tests**
  - [ ] Añadir tabla trazable por AC crítico (`AC4`, `AC5`, `AC5b-f`, `AC9`, `AC25-27`, `AC29-35b`) con archivo de test, escenario y asserts clave.
  - [ ] Cada AC crítico debe tener al menos un test de error/borde además del happy path.
  - [ ] Incluir caso obligatorio de eliminación: `view=list` no se admite (parse inválido) y no aparece en format/roundtrip.
  - [ ] Expresar escenarios críticos en formato Given/When/Then para ejecución determinista en QA.

- [ ] **DoR+3: Eliminación de URL legacy**
  - [ ] Contrato definitivo (sin ambigüedad): `ViewMode.List` eliminado; `parse/format` solo soportan modos vigentes y nunca emiten/aceptan `view=list`.
  - [ ] Actualizar tests existentes (`shared/test/view_mode_test.gleam`, `apps/client/test/url_state_test.gleam`, `apps/client/test/router_test.gleam`) para reflejar la eliminación total de `List`.

- [ ] **DoR+4: Concurrencia formal de activación**
  - [ ] Definir aislamiento transaccional y manejo de colisión para doble activación simultánea.
  - [ ] Especificar código de error y mensaje funcional esperado para el segundo request.
  - [ ] Mapear `unique_violation` del índice parcial activo -> HTTP `409 MILESTONE_ALREADY_ACTIVE`.
  - [ ] Añadir prueba simultánea: 2 requests `POST /activate` => 1 éxito + 1 conflicto.
  - [ ] Definir secuencia SQL transaccional explícita:
    1) lock de serialización por proyecto (`SELECT id FROM projects WHERE id = $project_id FOR UPDATE`),
    2) intento de activar hito objetivo (`state='active', activated_at=NOW()`),
    3) mapear colisión de índice único parcial a `409 MILESTONE_ALREADY_ACTIVE`.

- [ ] **DoR+5: Presupuesto de rendimiento**
  - [ ] Definir objetivo mínimo para consultas de milestones/pool (p95) y volumen de datos de referencia.
  - [ ] Vincular cada objetivo con índices/queries correspondientes y criterio de aceptación.

- [ ] **DoR+6: Plan de despliegue y rollback**
  - [ ] Orden de despliegue explícito: migración DB -> backend -> frontend.
  - [ ] Checklist de verificación post-deploy y pasos de rollback por capa (DB/backend/frontend).
  - [ ] Migración segura: usar `NOT VALID` en FKs nuevas y `VALIDATE CONSTRAINT` posterior; documentar ventanas de lock.
  - [ ] Rollback: secuencia exacta de `down` (constraints -> índices -> columnas -> tabla) y validación de integridad tras revertir.

- [ ] **DoR+7: Contratos tipados compartidos**
  - [ ] Error ADT en shared (`api_error`) para milestones + codecs cliente/servidor.
  - [ ] Ningún handler nuevo retorna códigos de error literales fuera del catálogo tipado.
  - [ ] Regeneración de `apps/server/src/scrumbringer_server/sql.gleam` y compilación cruzada sin warnings.

### Checklist operativo diario (dev + qa)

- [ ] **Dia 1 - Datos y contratos**
  - [ ] Ejecutar migración `up` en entorno local y validar constraints/índices.
  - [ ] Implementar tipos shared (`milestone`, extensiones `task/card`) con tests de codec.
  - [ ] Validar regla formal de completitud (cards + tasks sueltas) con tests unitarios.

- [ ] **Dia 2 - Backend milestones + pool feed**
  - [ ] Implementar endpoints de milestones y validaciones de activación irreversible.
  - [ ] Ajustar feed Pool para `hito activo + huérfanas`.
  - [ ] Añadir tests de concurrencia (doble activación simultánea) y de herencia `effective_milestone_id`.

- [ ] **Dia 3 - Frontend navegación + vista**
  - [ ] Integrar `ViewMode.Milestones` en sidebar/toggle/center/url_state/router.
  - [ ] Implementar `features/milestones/*` reutilizando `ui/expand_toggle`, `ui/dialog`, `ui/badge`.
  - [ ] Cubrir estados `loading/empty/error` + i18n + accesibilidad (`aria-expanded`, `aria-controls`, foco visible).

- [ ] **Dia 4 - End-to-end + hardening**
  - [ ] Ejecutar matriz AC->tests completa (incluye AC29-AC35b).
  - [ ] Validar eliminación total de `List`: no quedan rutas internas, tipos ni tests que dependan de `view=list`/`ViewMode.List`.
  - [ ] Ejecutar validación visual guiada con browser-agent (sección siguiente).

### Validación visual guiada (browser-agent)

- [ ] **Precondiciones**
  - [ ] Entorno levantado con `sh scripts/dev-hot.sh`.
  - [ ] Navegar siempre vía `http://localhost:8080`.
  - [ ] Usuario de prueba: `admin@example.com` / `passwordpassword`.

- [ ] **Recorrido visual mínimo (browser-agent)**
  - [ ] Login -> abrir sección TRABAJO -> confirmar reemplazo visual de `Lista` por `Hitos` y renombre `Tarjetas` -> `Kanban`.
  - [ ] Validar orden exacto de navegación en sidebar izquierdo (TRABAJO): `Pool - Kanban - Personas - Hitos`.
  - [ ] Cambiar a vista `Hitos` y validar estado inicial (acordeón plegado + filtros por defecto).
  - [ ] Expandir un hito y validar: progreso, cards, tasks sueltas, badges consistentes.
  - [ ] Abrir modal de detalle de hito y validar foco inicial/tecla `Esc`/restauración de foco al cerrar.
  - [ ] Activación irreversible: validar modal de confirmación, copy i18n y flujo seguro.
  - [ ] Navegación de trabajo: verificar que no existe entrada/ruta/estado `List` en UI ni en URL generadas por la app.

- [ ] **Evidencia requerida (guardar artefactos)**
  - [ ] Capturas: sidebar con orden `Pool - Kanban - Personas - Hitos`, sidebar (Hitos activo), acordeón colapsado, acordeón expandido, modal detalle, modal activación.
  - [ ] Capturas de estados: `loading`, `empty`, `error`.
  - [ ] Nota de verificación a11y: teclado + `aria-expanded`/`aria-controls` + retorno de foco.
  - [ ] Registro de URLs finales y resultado esperado/obtenido por paso.

---

## Out of Scope

- Tab de métricas en modal (ver historia 7.5)
- Fechas objetivo para hitos
- Ordenamiento de hitos
- Hitos compartidos entre proyectos

---

## Change Log

| Fecha | Version | Descripcion | Autor |
|-------|---------|-------------|-------|
| 2026-02-06 | 1.0 | Historia creada para sprint 7 | UX/PO |
| 2026-02-06 | 1.1 | Añadidas migraciones de preparación para 7.5: pool_lifetime tracking, workflow traceability | Analyst |
| 2026-02-06 | 1.2 | Alineación de routing a ViewMode, cierre de contrato de estado derivado y plan de tests por archivo | Sarah (PO) |
| 2026-02-06 | 1.3 | Ajustes de validación arquitectónica final: rutas backend reales, integridad/índices y cobertura de concurrencia/feed pool | Winston (Architect) |
| 2026-02-06 | 1.4 | Ajustes UX finales: reuso de componentes, estados de datos y accesibilidad de acordeón/modal, consistencia navegación | Sally (UX Expert) |
| 2026-02-06 | 1.5 | Cierre de brechas arquitectónicas finales: consistencia formal de datos, milestone efectivo en consultas y cobertura AC1-32 | Winston (Architect) |
| 2026-02-06 | 1.6 | Cierre UX final: toolbar de Hitos, normalización legacy `view=list`, accesibilidad avanzada por fila y modal irreversible seguro | Sally (UX Expert) |
| 2026-02-06 | 1.7 | Refinamiento UX final: restauración de foco al cerrar modal y set i18n ampliado para hitos | Sally (UX Expert) |
| 2026-02-06 | 1.8 | Estado actualizado a Ready para inicio de implementación | Sarah (PO) |
| 2026-02-06 | 1.9 | Cierre final pre-ejecución: regla formal de completitud, FK compuestas ejecutables, fórmula SQL de lifetime y migración up/down | Winston (Architect) |
| 2026-02-06 | 1.10 | Añadido bloque Definition of Ready+ para elevar la historia a estándar 10/10 pre-ejecución | Sarah (PO) |
| 2026-02-06 | 1.11 | Añadido checklist operativo diario y validación visual guiada con browser-agent para vistas críticas | Sarah (PO) |
| 2026-02-06 | 1.12 | Ajustes arquitectónicos finales: FK compuestas corregidas, constraint estado/activated_at y contrato de concurrencia/legacy explícito | Winston (Architect) |
| 2026-02-06 | 1.13 | Decisión entorno interno: eliminar soporte legacy `view=list` y actualizar contratos/tests a no compatibilidad | Sarah (PO) |
| 2026-02-06 | 1.14 | Cierre pre-ejecución final: contrato legacy determinista, secuencia transaccional de activación y matriz AC->test obligatoria | Winston (Architect) |
| 2026-02-06 | 1.16 | Endurecimiento de contrato sin legacy: `view=list` inválido (sin redirect), tests y validación visual actualizados | Sarah (PO) |
| 2026-02-06 | 1.15 | Cierre de bloqueantes finales: AC5b en PATCH tasks, contrato AC30 inequívoco y migración online segura (`NOT VALID`/`VALIDATE`) | Winston (Architect) |
| 2026-02-06 | 1.17 | Ajuste final de coherencia: FKs `NOT VALID`, parse legacy sin redirect con marcador inválido y `VALIDATE` separado post-backfill | Winston (Architect) |
| 2026-02-06 | 1.18 | Cierre de bloqueantes de arquitectura: `created_from_rule_id` con `ON DELETE SET NULL`, contrato SQL de feed AC5 y tipo explícito para parse legacy inválido | Winston (Architect) |
| 2026-02-06 | 1.19 | Cierre de coherencia de estado: `completed` persistido, transición automática `active->completed` y `completed_at` en modelo/SQL/ADT | Winston (Architect) |
| 2026-02-06 | 1.20 | Ajuste de navegación solicitado: renombre `Tarjetas` -> `Kanban` y orden sidebar `Pool - Kanban - Personas - Hitos` | Sarah (PO) |
| 2026-02-06 | 1.21 | Criterio visual obligatorio añadido en browser-agent: validar renombre a `Kanban` y orden exacto de sidebar | Sarah (PO) |
| 2026-02-06 | 1.22 | Eliminación total de legacy: quitar `ViewMode.List` y referencias `view=list` en dominio, routing, tests y validación visual | Sarah (PO) |
| 2026-02-06 | 1.23 | Ajustes finales de ejecución: callsites/bindings SQL explícitos, wiring completo sin `List`, test automático de orden AC14b y `pool_lifetime_s` en BIGINT | Winston (Architect) |
| 2026-02-06 | 1.24 | Cierre de precisión: contrato HTTP de endpoints, barrido legacy exhaustivo y `VALIDATE` SQL explícito por FK | Winston (Architect) |
| 2026-02-06 | 1.25 | Refuerzo final para 10/10: AC5g/AC10b/AC36, SQL milestones tipado, DoR+7 de errores ADT y lock de serialización por proyecto | Winston (Architect) |
| 2026-02-06 | 1.26 | Hardening pre-ejecución: integridad cruzada de FK task-card, concurrencia de transiciones pool_lifetime y regresiones/rollback explícitos | Winston (Architect) |
| 2026-02-06 | 1.26.1 | Microajustes 10/10: semántica AC5b reforzada, concurrencia determinista 1x200/1x409 y contrato a11y modal con testids | Winston (Architect) |
| 2026-02-06 | 1.27 | Ajustes UX: interacción por fila no ambigua (AC37), toolbar sin filtros heredados, wrapper reusable de dialog y consistencia de `Kanban`/toggle | Sally (UX Expert) |
| 2026-02-06 | 1.27.1 | Normalizacion PO de estado BMAD: Ready -> Approved tras cierre formal de 7.3 | Sarah (PO) |
| 2026-02-06 | 1.27.2 | Microajustes UX finales: reuse de `ui/tabs`, contrato de teclado extendido y test explícito de `ui/dialog` en flujo irreversible | Sally (UX Expert) |
| 2026-02-06 | 1.28 | Cierre frontend milestones: testids estables por fila/acción, bloqueo visual de activación con hito activo y batería de tests de vista + AC36 | James (Dev) |
| 2026-02-06 | 1.29 | Refactor TEA milestones: extracción de update dedicado, acordeón accesible con filtros y dialog de detalle, más cobertura de tests frontend/i18n | James (Dev) |
| 2026-02-06 | 1.30 | Cierre QA P0/P1: confirmación irreversible para activar hito (con foco por defecto en cancelar), keyed list en secciones y tests AC37 explícitos | James (Dev) |
| 2026-02-06 | 1.31 | Hardening final de arquitectura: errores de milestones tipados, utilidades compartidas de IDs/dialog y limpieza de atributos duplicados | James (Dev) |
| 2026-02-06 | 1.32 | Cierre plan 10/10: eliminación de ramas legacy de milestones en pool/update, test de cierre explícito de dialog state y contrato legacy `view=list` documentado como inválido con redirect de sanitización | James (Dev) |
| 2026-02-06 | 1.31 | Cierre QA adicional: soporte `Esc` para dialogs de milestones con retorno de foco al trigger, y reuso explícito de `ui/expand_toggle` + `ui/badge` | James (Dev) |

---

## Dev Agent Record

### Agent Model Used

openai/gpt-5.3-codex

### Debug Log References

- `gleam build` (apps/server)
- `make squirrel` (repo root)
- `DATABASE_URL=postgres://scrumbringer:scrumbringer@localhost:5432/scrumbringer_test?sslmode=disable gleam test` (apps/server)
- `make test` (repo root)
- `gleam test` (apps/client)
- `gleam test` (shared)
- `make test` (repo root, post-refactor milestones)
- `gleam test` (apps/client, post-10/10 cleanup)
- `gleam test` (shared, post-10/10 cleanup)
- `make test` (repo root, post-10/10 cleanup)

### Completion Notes List

- Added milestone update/delete backend capability: `PATCH /api/v1/milestones/:id` and `DELETE /api/v1/milestones/:id` with auth/CSRF/project-manager checks.
- Added typed SQL queries for milestone mutation/deletion constraints (`milestones_update`, `milestones_delete`) and wired them through `milestones_db` service.
- Added API conflict mapping for non-deletable milestones: `409 MILESTONE_DELETE_NOT_ALLOWED` when milestone is not `ready` and empty.
- Added server HTTP tests for milestone CRUD extension: patch + delete happy path, delete conflict when milestone has content, and patch authorization guard.
- Added task-create guard for AC5g: when `card_id` and `milestone_id` are both present, API now returns `422 TASK_MILESTONE_INHERITED_FROM_CARD`.
- Added card milestone movement validation for AC25-27 in `cards_db`: only `ready -> ready` or `ready -> pool` moves are allowed, with `422 INVALID_MOVE_POOL_TO_MILESTONE` for forbidden pool-to-milestone moves.
- Added milestone state validation for card create/update so `milestone_id` must belong to same project and be `ready`.
- Extended milestones HTTP test suite with movement and inheritance error scenarios (`TASK_MILESTONE_INHERITED_FROM_CARD`, `INVALID_MOVE_POOL_TO_MILESTONE`).
- Added task PATCH milestone support in workflow + persistence (`TaskUpdates.milestone_id`, `tasks_update.sql`) with explicit sentinel mapping (`-1` unchanged, `0` -> pool, `>0` ready milestone id).
- Enforced AC25-27 for task movement: standalone tasks can move `ready -> ready` and `ready -> pool`; `pool -> milestone` now returns `422 INVALID_MOVE_POOL_TO_MILESTONE`.
- Enforced AC5g on task PATCH: if task has `card_id`, any explicit milestone update now returns `422 TASK_MILESTONE_INHERITED_FROM_CARD`.
- Added HTTP error mappings for task PATCH milestone constraints and robust payload decoding for explicit `milestone_id` updates (including `null` for pool).
- Extended milestone HTTP tests with task PATCH scenarios: card-linked rejection, pool-to-milestone rejection, and allowed ready->ready / ready->pool moves.
- Revalidated full repo tests after changes (`make test`) with all suites passing.
- Added stable frontend testids per milestone row and per action (`milestone-row:{id}`, `milestone-activate-button:{id}`, `milestone-edit-button:{id}`, `milestone-delete-button:{id}`).
- Hardened milestone activation UX: ready milestones no longer render activate action when another milestone is already active in the same loaded project context.
- Added milestone view coverage (`apps/client/test/milestones_view_test.gleam`) for loading/error/empty states, role-based action visibility, ready-only delete, active-conflict activation hiding, in-flight disable, and AC36 testid assertions.
- Re-ran client/shared/full regression (`gleam test` in apps/client + shared, `make test` root) with all suites passing.
- Extracted milestone update handling to `features/milestones/update.gleam` and delegated from `features/pool/update.gleam` to keep feature logic cohesive.
- Implemented milestone accordion interactions with explicit per-row controls (`milestone-toggle:{id}` and `milestone-details-button:{id}`), accessible region wiring (`aria-controls`, `aria-labelledby`, `aria-expanded`) and dedicated progress testids.
- Added milestone filters (`show completed`, `show empty`) with state wiring and i18n labels in EN/ES.
- Added milestone detail dialog flow (`MilestoneDialogView`) and tests for new filter/detail messages and accessibility/testid rendering.
- Added activation confirmation dialog flow (`MilestoneDialogActivate`) with irreversible copy and safe default focus (`autofocus` on cancel), wiring prompt->confirm->activate.
- Switched milestone section rendering to keyed nodes for stable DOM identity in dynamic updates.
- Added explicit AC37 behavioral tests ensuring expand and modal actions remain independent.
- Centralized milestone error-code mapping into typed ADT helper (`features/milestones/error_codes.gleam`) and reused it from both milestone/pool update paths.
- Centralized milestone element IDs in shared helper (`features/milestones/ids.gleam`) and reused them in view + focus-return flows to avoid string drift.
- Extracted shared milestone dialog lookup helper (`features/milestones/dialog_helpers.gleam`) and removed duplicated lookup implementation.
- Removed duplicate HTML `id` attribute assignment on milestone details trigger while preserving `aria-labelledby` contract.
- Removed duplicated milestone handling branches from `features/pool/update.gleam`; milestones now resolve through dedicated `features/milestones/update.gleam` workflow and no-op fallback in pool dispatcher.
- Added explicit regression test for `MemberMilestoneDialogClosed` state reset and clarified legacy URL contract in test naming (`view=list` is invalid and sanitized via redirect).
- AC29b/AC32b scope note: current milestones modal has no internal tab sections, so `ui/tabs` + arrow-navigation contract is treated as N/A for this story increment (no runtime tab UI to exercise).
- Added explicit `Esc` shortcut handling for all milestone dialog variants in pool keyboard shortcuts, with focus restoration effects to the exact action trigger per row.
- Replaced local milestone accordion icon and done badge markup with shared UI components (`ui/expand_toggle`, `ui/badge`) to satisfy AC29 reuse contract.
- Added regression tests for `Esc` close behavior in milestones flow and id-based trigger availability used by focus restoration.

### File List

- `apps/server/src/scrumbringer_server/http/milestones.gleam`
- `apps/server/src/scrumbringer_server/http/cards.gleam`
- `apps/server/src/scrumbringer_server/http/tasks/tasks_list_create.gleam`
- `apps/server/src/scrumbringer_server/http/tasks/tasks_get_patch.gleam`
- `apps/server/src/scrumbringer_server/services/milestones_db.gleam`
- `apps/server/src/scrumbringer_server/services/cards_db.gleam`
- `apps/server/src/scrumbringer_server/services/workflows/types.gleam`
- `apps/server/src/scrumbringer_server/services/workflows/handlers.gleam`
- `apps/server/src/scrumbringer_server/persistence/tasks/queries.gleam`
- `apps/server/src/scrumbringer_server/sql/milestones_update.sql`
- `apps/server/src/scrumbringer_server/sql/milestones_delete.sql`
- `apps/server/src/scrumbringer_server/sql/tasks_update.sql`
- `apps/server/src/scrumbringer_server/sql.gleam`
- `apps/server/test/milestones_http_test.gleam`
- `apps/client/src/scrumbringer_client/features/milestones/view.gleam`
- `apps/client/src/scrumbringer_client/features/milestones/update.gleam`
- `apps/client/src/scrumbringer_client/features/milestones/error_codes.gleam`
- `apps/client/src/scrumbringer_client/features/milestones/ids.gleam`
- `apps/client/src/scrumbringer_client/features/milestones/dialog_helpers.gleam`
- `apps/client/test/milestones_view_test.gleam`
- `apps/client/test/milestones_update_test.gleam`
- `apps/client/test/url_state_test.gleam`
- `apps/client/src/scrumbringer_client/features/pool/update.gleam`
- `apps/client/src/scrumbringer_client/features/pool/msg.gleam`
- `apps/client/src/scrumbringer_client/client_state/member/pool.gleam`
- `apps/client/src/scrumbringer_client/i18n/text.gleam`
- `apps/client/src/scrumbringer_client/i18n/en.gleam`
- `apps/client/src/scrumbringer_client/i18n/es.gleam`

---

## QA Results

### Review Date: 2026-02-07

### Reviewed By: Quinn (Test Architect)

### Gate Status

Gate: PASS -> `docs/qa/gates/7.4-milestones.yml`

Validation matrix: `docs/qa/assessments/7.4-ac-validation-matrix.md`
Browser sweep: `docs/qa/assessments/7.4-agent-browser-sweep-20260207.md`
