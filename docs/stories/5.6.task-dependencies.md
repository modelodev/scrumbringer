# Story 5.6: Dependencias entre Tareas

## Status

Draft

## Story

**As a** project manager,
**I want** poder definir dependencias entre tareas,
**so that** el equipo (humanos y agentes AI) sabe que tareas deben completarse antes de empezar otras.

## Problem Statement

Actualmente las tareas son independientes. Esto causa:
- Trabajo en paralelo que deberia ser secuencial
- Agentes AI que reclaman tareas sin saber que dependen de otras
- PMs que tienen que comunicar dependencias verbalmente
- Bloqueos descubiertos tarde en el proceso

### Concepto: Dependencias Simples

Una dependencia significa: "Tarea A debe completarse antes de empezar Tarea B"

- Tarea B "depende de" Tarea A
- Tarea A "bloquea" Tarea B
- Cuando A se completa, B queda "desbloqueada"

---

## Acceptance Criteria

### Funcionales - Definir Dependencias

1. **AC1**: En el detalle de una tarea, hay seccion "Dependencias"
2. **AC2**: El PM puede a침adir: "Esta tarea depende de [selector de tarea]"
3. **AC3**: El selector muestra tareas del mismo proyecto (no completadas)
4. **AC4**: Se pueden a침adir multiples dependencias
5. **AC5**: Se puede eliminar una dependencia

### Funcionales - Visualizacion

6. **AC6**: Tareas con dependencias incompletas muestran indicador "Bloqueada"
7. **AC7**: El indicador muestra cuantas dependencias faltan: "Bloqueada (2)"
8. **AC8**: Hover en indicador muestra lista de tareas bloqueantes
9. **AC9**: En Kanban y Lista, tareas bloqueadas tienen opacidad reducida
10. **AC10**: La lista de dependencias muestra estado y asignacion de cada tarea bloqueante (Disponible / Reclamada por {email} / Completada)

### Funcionales - Comportamiento

11. **AC11**: Una tarea bloqueada PUEDE ser reclamada (soft block, no hard block)
12. **AC12**: Al reclamar tarea bloqueada, se muestra advertencia: "Esta tarea depende de N tareas incompletas. Continuar?"
13. **AC13**: Cuando todas las dependencias se completan, la tarea queda desbloqueada automaticamente

### API

14. **AC14**: `GET /api/v1/tasks/:id/dependencies` - Lista tareas de las que depende
15. **AC15**: `POST /api/v1/tasks/:id/dependencies` - Body: `{ depends_on_task_id: Int }`
16. **AC16**: `DELETE /api/v1/tasks/:id/dependencies/:dep_task_id` - Elimina dependencia
17. **AC17**: `GET /api/v1/projects/:id/tasks` acepta filtro `?blocked=false` (solo desbloqueadas)

### Validaciones

18. **AC18**: No se puede crear dependencia circular (A depende de B, B depende de A)
19. **AC19**: No se puede crear dependencia a tarea de otro proyecto
20. **AC20**: No se puede crear dependencia a tarea ya completada (no tiene sentido)

### Modelo de Datos

21. **AC21**: Tabla `task_dependencies(task_id, depends_on_task_id, created_at, created_by)`
22. **AC22**: Indices para busqueda rapida en ambas direcciones

### i18n

23. **AC23**: Labels en ES/EN:
    - "Dependencias" / "Dependencies"
    - "Bloqueada por N tareas" / "Blocked by N tasks"
    - "Esta tarea depende de..." / "This task depends on..."
    - "A침adir dependencia" / "Add dependency"

---

## UX Design

### Wireframe: Seccion Dependencias en Tarea

```
+----------------------------------------------------------+
| TAREA: Implementar OAuth                                  |
| Estado: Disponible | Tipo: Feature                        |
+----------------------------------------------------------+
| DEPENDENCIAS (2 incompletas)                              |
+----------------------------------------------------------+
| [!] Configurar credenciales    Disponible          [x]    |
| [!] Dise침ar flujo de auth      Reclamada por Alice  [x]   |
| [九늏 Crear modelo de usuario    Completada          [x]    |
+----------------------------------------------------------+
| [+ A침adir dependencia]                                    |
+----------------------------------------------------------+

Leyenda:
[!] = Dependencia incompleta (bloquea esta tarea)
[九늏 = Dependencia completada
[x] = Eliminar dependencia
```

### Wireframe: Indicador en Lista/Kanban

```
POOL
+------------------------------------------------+
| [Feature] Implementar OAuth        [游 2]       |
| [Bug] Fix login timeout                         |
| [Task] Update docs                 [游 1]       |
+------------------------------------------------+

Hover en [游 2]:
+----------------------------------+
| Bloqueada por:                   |
| - Configurar credenciales (Disp) |
| - Dise침ar flujo de auth (Alice)  |
+----------------------------------+
```

### Wireframe: Advertencia al Reclamar

```
+--------------------------------------------------+
| Tarea bloqueada                                  |
|                                                  |
| "Implementar OAuth" depende de 2 tareas          |
| que aun no estan completadas:                    |
|                                                  |
| - Configurar credenciales (Disponible)           |
| - Dise침ar flujo de auth (En curso por Alice)     |
|                                                  |
| Reclamar de todos modos?                        |
|                                                  |
|              [Cancelar]  [Reclamar]              |
+--------------------------------------------------+
```

### Wireframe: Selector de Dependencia

```
+--------------------------------------------------+
| A침adir dependencia                               |
+--------------------------------------------------+
| Buscar tarea: [________________]                 |
|                                                  |
| Tareas disponibles:                              |
| +----------------------------------------------+ |
| | [Bug] Fix timeout - Disponible               | |
| | [Feature] Add cache - En curso (Bob)         | |
| | [Task] Write tests - Disponible              | |
| +----------------------------------------------+ |
|                                                  |
|              [Cancelar]  [A침adir]                |
+--------------------------------------------------+
```

---

## Technical Notes

### Backend

**Nueva tabla:**
```sql
CREATE TABLE task_dependencies (
  id SERIAL PRIMARY KEY,
  task_id INTEGER NOT NULL REFERENCES tasks(id) ON DELETE CASCADE,
  depends_on_task_id INTEGER NOT NULL REFERENCES tasks(id) ON DELETE CASCADE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  created_by INTEGER NOT NULL REFERENCES users(id),

  UNIQUE(task_id, depends_on_task_id),
  CHECK(task_id != depends_on_task_id)
);

CREATE INDEX idx_task_deps_task_id ON task_dependencies(task_id);
CREATE INDEX idx_task_deps_depends_on ON task_dependencies(depends_on_task_id);
```

**Validacion de ciclos:**
```gleam
/// Detecta si a침adir esta dependencia crea un ciclo
pub fn would_create_cycle(
  db: Connection,
  task_id: Int,
  depends_on: Int,
) -> Bool {
  // BFS/DFS desde depends_on siguiendo dependencias
  // Si llegamos a task_id, hay ciclo
  let visited = find_all_dependencies(db, depends_on)
  list.contains(visited, task_id)
}
```

**Nuevo modulo:** `http/task_dependencies.gleam`

**Modificar GET task:**
```gleam
// Incluir dependencias en response
fn task_json_with_dependencies(task: Task, deps: List(Dependency)) {
  json.object([
    ...task_fields,
    #("dependencies", json.array(deps, dependency_json)),
    #("blocked_count", json.int(count_incomplete(deps))),
  ])
}
```

### Frontend

**Nuevo modulo:** `features/tasks/dependencies.gleam`
```gleam
pub type DependencyState {
  DependencyState(
    dependencies: List(Dependency),
    loading: Bool,
    add_dialog_open: Bool,
    search_query: String,
    search_results: List(Task),
  )
}

pub type Dependency {
  Dependency(
    id: Int,
    task_id: Int,
    depends_on: Task,  // Tarea completa para mostrar info
    is_complete: Bool,
  )
}
```

**Archivos a modificar:**
- `features/tasks/detail.gleam` - A침adir seccion dependencias
- `features/pool/task_card.gleam` - Indicador de bloqueo
- `features/views/grouped_list.gleam` - Indicador de bloqueo
- `features/views/kanban_board.gleam` - Indicador de bloqueo + opacidad
- `api/tasks.gleam` - Endpoints de dependencias

---

## Out of Scope

- Dependencias entre cards (solo tareas)
- Dependencias cross-proyecto
- Fechas estimadas basadas en dependencias (Gantt)
- Notificaciones cuando dependencias se completan
- Hard block (impedir claim de tarea bloqueada)

---

## Consideraciones para Agentes AI

Un agente AI puede:
1. Consultar `?blocked=false` para ver solo tareas que puede empezar
2. Ver dependencias de una tarea antes de reclamar
3. Decidir reclamar tarea bloqueada si tiene contexto adicional
4. A침adir nota explicando por que trabajo en tarea bloqueada

El sistema provee informacion, el agente decide.

---

## Risk Assessment

- **Primary Risk:** Complejidad en modelo de datos (ciclos, cascadas)
- **Mitigation:** Validacion de ciclos, DELETE CASCADE simple
- **Secondary Risk:** Usuarios crean demasiadas dependencias
- **Mitigation:** UI no agresiva, dependencias son opcionales
- **Tertiary Risk:** Performance con muchas dependencias
- **Mitigation:** Indices en ambas direcciones, cache de blocked_count

---

## Casos Edge

1. **Tarea A depende de B, B se elimina**: La dependencia se elimina (CASCADE)
2. **Tarea A depende de B, B se completa**: A queda desbloqueada automaticamente
3. **Ciclo A->B->C->A**: Rechazado en creacion con error "Dependencia circular detectada"
4. **Dependencia a tarea completada**: Rechazado (no tiene sentido)
