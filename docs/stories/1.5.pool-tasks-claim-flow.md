# Story 1.5: Pool + Tasks Core (Create/List/Claim/Release/Complete)

## Status
Ready for Review

## Story
**As a** project member,
**I want** to create, browse, and claim tasks from a shared pool,
**so that** work is self-assigned (pull-based) without any direct assignment.

## Acceptance Criteria
1. **No direct assignment (negative)**: The API provides no endpoint to assign a task to another user, and task updates cannot set `claimed_by` directly.
2. **Task types list**: `GET /api/v1/projects/:project_id/task-types` returns task types for the project sorted by `name ASC`.
3. **Task types create (project admin only)**: `POST /api/v1/projects/:project_id/task-types` is allowed only for project admins and accepts `{ name, icon, capability_id? }`.
4. **List tasks (filters + sorting, no pagination)**: `GET /api/v1/projects/:project_id/tasks`:
   - returns tasks sorted by `created_at DESC`,
   - supports optional filters `status`, `type_id`, `capability_id` (**single value in MVP**, via task type), and `q` (searches **title/description only**),
   - returns full list (no pagination in MVP).
5. **Create task (project member)**: `POST /api/v1/projects/:project_id/tasks` accepts `{ title, description?, priority, type_id }` and returns `{ data: { task } }`.
6. **Get task (project member)**: `GET /api/v1/tasks/:task_id` returns `{ data: { task } }` only if the task belongs to a project the user is a member of.
7. **Patch task requires claim + optimistic concurrency**: `PATCH /api/v1/tasks/:task_id`:
   - requires the task to be claimed by the caller,
   - requires `version` in the request body,
   - rejects version mismatches with `409` error code `CONFLICT_VERSION`.
8. **State machine enforced**: Task status values are `available | claimed | completed` with only these transitions:
   - `available → claimed` via `POST /api/v1/tasks/:task_id/claim`
   - `claimed → available` via `POST /api/v1/tasks/:task_id/release`
   - `claimed → completed` via `POST /api/v1/tasks/:task_id/complete`
   - invalid transitions are rejected with `422` error code `VALIDATION_ERROR`.
9. **Claim uses optimistic concurrency + claim conflict code**: `POST /api/v1/tasks/:task_id/claim`:
   - requires body `{ version }`,
   - on concurrent claim, first-write-wins; the loser gets `409` error code `CONFLICT_CLAIMED`.
10. **Release/complete require claimer + version**: `POST /api/v1/tasks/:task_id/release` and `POST /api/v1/tasks/:task_id/complete`:
   - require the task to be claimed by the caller,
   - require body `{ version }`.

## Tasks / Subtasks
- [x] Implement task types storage + endpoints (AC: 2, 3)
  - [x] Persist `task_types` with `capability_id` optional and `UNIQUE(name, project_id)` (AC: 3)
  - [x] Implement `GET /projects/:project_id/task-types` sorted by `name ASC` (AC: 2)
  - [x] Implement `POST /projects/:project_id/task-types` with project-admin authz (AC: 3)
- [x] Implement tasks storage + core endpoints (AC: 4, 5, 6, 7)
  - [x] Persist tasks with `priority` constraints 1..5 and `version` (AC: 5, 7)
  - [x] Implement `GET /projects/:project_id/tasks` with filters and sorting (AC: 4)
  - [x] Implement `POST /projects/:project_id/tasks` (AC: 5)
  - [x] Implement `GET /tasks/:task_id` with membership enforcement (AC: 6)
  - [x] Implement `PATCH /tasks/:task_id` (claim-required + `version` + `CONFLICT_VERSION`) (AC: 7)
- [x] Implement claim/release/complete state machine endpoints (AC: 8, 9, 10)
  - [x] Enforce allowed transitions and return `VALIDATION_ERROR` on invalid transitions (AC: 8)
  - [x] Enforce first-write-wins claim conflict (`CONFLICT_CLAIMED`) (AC: 9)
  - [x] Enforce claimer-only for release/complete (AC: 10)
- [x] Enforce “no direct assignment” across API surface (AC: 1)
  - [x] Ensure no endpoints exist to assign to others (AC: 1)
  - [x] Ensure PATCH body does not accept `claimed_by` and cannot bypass claim endpoints (AC: 1)
- [x] Add tests for filters, state machine, and concurrency conflicts (AC: 4, 7, 8, 9, 10)
  - [x] `q` searches only title/description (AC: 4)
  - [x] `capability_id` filter is single value only in MVP (AC: 4)
  - [x] Claim conflict: second claimant gets `CONFLICT_CLAIMED` (AC: 9)
  - [x] Version conflict on patch/release/complete returns `CONFLICT_VERSION` (AC: 7, 10)
  - [x] Invalid transitions return `VALIDATION_ERROR` (AC: 8)

## Dev Notes
Source of truth:
- API contract (endpoints, filters, sorting, errors, state machine): `docs/architecture/api-contract.md` (see “Tasks”, “Task Types”, “Conventions”, “Authorization Rules (MVP)”, “Error Codes”) 
- Data model + concurrency strategy: `docs/architecture/data-model.md` (see “TaskType”, “Task”, “Concurrency Strategy”, “Claim Conflicts”, “Status State Machine”) 
- Product constraints (“pull-based / no assignment”): `docs/brief.md` (see “Acceptance Criteria: No Asignación Directa”) 

Authorization rules (MVP):
- Creating tasks: any **project member**.
- Editing tasks (fields other than notes): requires the task to be **claimed by the caller**.
- Claim/Release/Complete: only valid for **project members**; Release/Complete require caller is the claimer.
- No direct assignment (no endpoint to assign tasks to others).
  [Source: `docs/architecture/api-contract.md` “Authorization Rules (MVP)”]

Task list constraints (MVP):
- No pagination.
- Sorting: tasks sorted by `created_at DESC`.
- Search `q` only matches title/description.
- `capability_id` is a **single value** in MVP.
  [Source: `docs/architecture/api-contract.md` “Conventions” and “GET /api/v1/projects/:project_id/tasks”]

vNext note (explicit):
- **vNext**: `GET /projects/:project_id/tasks` may accept multiple capabilities (e.g. `capability_id=1,2,3`). Do not implement multi-value parsing in MVP.
  [Source: `docs/architecture/api-contract.md` “GET /api/v1/projects/:project_id/tasks” (vNext note)]

### Testing
- Use `gleeunit`.
- Focus tests on:
  - state machine correctness,
  - authorization rules (claim-required edits),
  - optimistic concurrency (`version` mismatches),
  - claim conflict behavior (`CONFLICT_CLAIMED`),
  - filter/search correctness and default sorting.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-12 | 1.0 | Initial draft | architect |
| 2026-01-12 | 1.1 | Refined story statement, acceptance criteria, tasks, dev notes, and testing focus aligned to pool/tasks contract and MVP constraints (incl. vNext) | sm |
| 2026-01-13 | 1.2 | Implemented task types + task pool CRUD, claim state machine, optimistic concurrency, and tests | dev |
| 2026-01-13 | 1.3 | Added missing negative/filter/authz tests to satisfy QA gate concerns | dev |
| 2026-01-13 | 1.4 | Re-ran validations and confirmed QA-requested tests are present; ready for QA re-review | dev |

## Dev Agent Record

### Agent Model Used
- GPT-5.2 (Codex CLI)

### Debug Log References
- `psql postgres://scrumbringer:scrumbringer@localhost:5433/scrumbringer_test?sslmode=disable ...` (created `task_types`/`tasks` tables locally for Squirrel validation; `dbmate` not available in environment)
- `make squirrel` (generated 27 queries)
- `make test` (apps/server: 25 passed; packages/domain: no tests; packages/birl: no tests)
- `make test` (apps/server: 29 passed; packages/domain: no tests; packages/birl: no tests)
- `make test` (apps/server: 29 passed; packages/domain: no tests; packages/birl: no tests) (re-run for QA re-review)

### Completion Notes List
- Added `task_types` + `tasks` persistence with optimistic concurrency (`version`) and required indexes.
- Implemented task types endpoints (`GET/POST /api/v1/projects/:project_id/task-types`) with project membership/admin enforcement.
- Implemented tasks endpoints (`GET/POST /api/v1/projects/:project_id/tasks`, `GET/PATCH /api/v1/tasks/:task_id`, `POST /claim|release|complete`) with auth + CSRF, state machine validation, and conflict error codes.
- Added gleeunit coverage for filters/sorting/search, single-value `capability_id`, claim conflict, version conflicts, and invalid transitions.
- Added negative test coverage for membership enforcement (list/get), status/type_id filters + invalid values, and "no direct assignment" via PATCH (claimed_by ignored).

### File List
- `db/migrations/20260113130000_create_task_types.sql` (new)
- `db/migrations/20260113130001_create_tasks.sql` (new)
- `apps/server/src/scrumbringer_server.gleam` (modified)
- `apps/server/src/scrumbringer_server/http/tasks.gleam` (new)
- `apps/server/src/scrumbringer_server/services/projects_db.gleam` (modified)
- `apps/server/src/scrumbringer_server/services/task_types_db.gleam` (new)
- `apps/server/src/scrumbringer_server/services/tasks_db.gleam` (new)
- `apps/server/src/scrumbringer_server/sql.gleam` (modified; generated)
- `apps/server/src/scrumbringer_server/sql/project_members_is_member.sql` (new)
- `apps/server/src/scrumbringer_server/sql/task_types_create.sql` (new)
- `apps/server/src/scrumbringer_server/sql/task_types_is_in_project.sql` (new)
- `apps/server/src/scrumbringer_server/sql/task_types_list.sql` (new)
- `apps/server/src/scrumbringer_server/sql/tasks_claim.sql` (new)
- `apps/server/src/scrumbringer_server/sql/tasks_complete.sql` (new)
- `apps/server/src/scrumbringer_server/sql/tasks_create.sql` (new)
- `apps/server/src/scrumbringer_server/sql/tasks_get_for_user.sql` (new)
- `apps/server/src/scrumbringer_server/sql/tasks_list.sql` (new)
- `apps/server/src/scrumbringer_server/sql/tasks_release.sql` (new)
- `apps/server/src/scrumbringer_server/sql/tasks_update.sql` (new)
- `apps/server/test/tasks_http_test.gleam` (new; updated with QA follow-ups)
- `docs/stories/1.5.pool-tasks-claim-flow.md` (modified)

## QA Results

### Review Date: 2026-01-13

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Implementation aligns well with the story’s API contract: membership/admin authorization is enforced, mutating endpoints require double-submit CSRF, and the task state machine + optimistic concurrency behave consistently.

### Refactoring Performed

- None.

### Compliance Check

- Coding Standards: ✓ (consistent handler patterns and error shape)
- Project Structure: ✓ (HTTP handlers in `apps/server/src/scrumbringer_server/http/`, DB access in `apps/server/src/scrumbringer_server/services/`, SQL in `apps/server/src/scrumbringer_server/sql/`)
- Testing Strategy: ⚠️ (good coverage on core flows, but several AC scenarios are untested)
- All ACs Met: ✓ (based on code inspection; see test gaps below)

### Test Coverage Notes (AC Traceability)

- Covered by tests: AC2, AC3, AC4 (partial), AC5, AC7, AC8, AC9, AC10
- Gaps / should add tests: AC1 (explicit negative), AC6 (membership enforcement)

### Improvements Checklist

- [x] Verified `make test` passes (apps/server: 25 passed)
- [ ] Add negative test: non-member cannot `GET /api/v1/tasks/:task_id` (AC6)
- [ ] Add negative test: PATCH with `claimed_by` present does not change `claimed_by` (AC1)
- [ ] Add task list filter tests for `status` and `type_id`, plus invalid filter values (AC4)
- [ ] Add authorization negative tests for PATCH/release/complete by non-claimer (AC7, AC10)

### Security Review

- PASS: Auth is required for all endpoints; mutating endpoints enforce double-submit CSRF (`X-CSRF` matches `sb_csrf`).
- Note: add a couple of negative tests (missing/mismatched CSRF, non-member access) to lock this down against regressions.

### Performance Considerations

- PASS for MVP: filtering/search/sorting are done in SQL (`ORDER BY created_at DESC`; `q` is limited to title/description; capability filter is via task type).

### Files Modified During Review

- None.

### Gate Status

Gate: CONCERNS → docs/qa/gates/1.5-pool-tasks-core-create-list-claim-release-complete.yml

### Recommended Status

✗ Changes Required - Add the unchecked tests above (then re-run QA gate).

---

### Review Date: 2026-01-13 (Re-review)

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Dev addressed the prior gate concerns by adding targeted HTTP tests for membership enforcement, the remaining task-list filter matrix, and the negative “no direct assignment” constraint. No new functional issues surfaced in this re-review.

### Evidence (Tests Run)

- `make test` (apps/server: 29 passed)

### Test Coverage Notes (AC Traceability)

- AC1: Covered (PATCH ignores provided `claimed_by`; no direct assignment via update)
- AC2–AC3: Covered (task types list sorting; create admin-only + CSRF)
- AC4: Covered (sorting + q; `capability_id` single-value; `status`/`type_id` filters; invalid filter values → `422 VALIDATION_ERROR`)
- AC5: Covered (create task request/response exercised by tests)
- AC6: Covered (`/projects/:id/tasks` forbidden for non-member; `/tasks/:id` returns 404 for non-member)
- AC7–AC10: Covered (claim-required edits, version conflicts, claim conflict, state machine, non-claimer forbidden for patch/release/complete)

### Refactoring Performed

- None.

### Files Modified During Review

- None.

### Gate Status

Gate: PASS → docs/qa/gates/1.5-pool-tasks-core-create-list-claim-release-complete.yml

### Recommended Status

✓ Ready for Done
