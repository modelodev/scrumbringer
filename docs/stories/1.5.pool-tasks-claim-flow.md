# Story 1.5: Pool + Tasks Core (Create/List/Claim/Release/Complete)

## Status
Approved

## Story
**As a** project member,
**I want** to create, browse, and claim tasks from a shared pool,
**so that** work is self-assigned (pull-based) without any direct assignment.

## Acceptance Criteria
1. **No direct assignment (negative)**: The API provides no endpoint to assign a task to another user, and task updates cannot set `claimed_by` directly.
2. **Task types list**: `GET /api/v1/projects/:project_id/task-types` returns task types for the project sorted by `name ASC`.
3. **Task types create (project admin only)**: `POST /api/v1/projects/:project_id/task-types` is allowed only for project admins and accepts `{ name, icon, capability_id? }`.
4. **List tasks (filters + sorting, no pagination)**: `GET /api/v1/projects/:project_id/tasks`:
   - returns tasks sorted by `created_at DESC`,
   - supports optional filters `status`, `type_id`, `capability_id` (**single value in MVP**, via task type), and `q` (searches **title/description only**),
   - returns full list (no pagination in MVP).
5. **Create task (project member)**: `POST /api/v1/projects/:project_id/tasks` accepts `{ title, description?, priority, type_id }` and returns `{ data: { task } }`.
6. **Get task (project member)**: `GET /api/v1/tasks/:task_id` returns `{ data: { task } }` only if the task belongs to a project the user is a member of.
7. **Patch task requires claim + optimistic concurrency**: `PATCH /api/v1/tasks/:task_id`:
   - requires the task to be claimed by the caller,
   - requires `version` in the request body,
   - rejects version mismatches with `409` error code `CONFLICT_VERSION`.
8. **State machine enforced**: Task status values are `available | claimed | completed` with only these transitions:
   - `available → claimed` via `POST /api/v1/tasks/:task_id/claim`
   - `claimed → available` via `POST /api/v1/tasks/:task_id/release`
   - `claimed → completed` via `POST /api/v1/tasks/:task_id/complete`
   - invalid transitions are rejected with `422` error code `VALIDATION_ERROR`.
9. **Claim uses optimistic concurrency + claim conflict code**: `POST /api/v1/tasks/:task_id/claim`:
   - requires body `{ version }`,
   - on concurrent claim, first-write-wins; the loser gets `409` error code `CONFLICT_CLAIMED`.
10. **Release/complete require claimer + version**: `POST /api/v1/tasks/:task_id/release` and `POST /api/v1/tasks/:task_id/complete`:
   - require the task to be claimed by the caller,
   - require body `{ version }`.

## Tasks / Subtasks
- [ ] Implement task types storage + endpoints (AC: 2, 3)
  - [ ] Persist `task_types` with `capability_id` optional and `UNIQUE(name, project_id)` (AC: 3)
  - [ ] Implement `GET /projects/:project_id/task-types` sorted by `name ASC` (AC: 2)
  - [ ] Implement `POST /projects/:project_id/task-types` with project-admin authz (AC: 3)
- [ ] Implement tasks storage + core endpoints (AC: 4, 5, 6, 7)
  - [ ] Persist tasks with `priority` constraints 1..5 and `version` (AC: 5, 7)
  - [ ] Implement `GET /projects/:project_id/tasks` with filters and sorting (AC: 4)
  - [ ] Implement `POST /projects/:project_id/tasks` (AC: 5)
  - [ ] Implement `GET /tasks/:task_id` with membership enforcement (AC: 6)
  - [ ] Implement `PATCH /tasks/:task_id` (claim-required + `version` + `CONFLICT_VERSION`) (AC: 7)
- [ ] Implement claim/release/complete state machine endpoints (AC: 8, 9, 10)
  - [ ] Enforce allowed transitions and return `VALIDATION_ERROR` on invalid transitions (AC: 8)
  - [ ] Enforce first-write-wins claim conflict (`CONFLICT_CLAIMED`) (AC: 9)
  - [ ] Enforce claimer-only for release/complete (AC: 10)
- [ ] Enforce “no direct assignment” across API surface (AC: 1)
  - [ ] Ensure no endpoints exist to assign to others (AC: 1)
  - [ ] Ensure PATCH body does not accept `claimed_by` and cannot bypass claim endpoints (AC: 1)
- [ ] Add tests for filters, state machine, and concurrency conflicts (AC: 4, 7, 8, 9, 10)
  - [ ] `q` searches only title/description (AC: 4)
  - [ ] `capability_id` filter is single value only in MVP (AC: 4)
  - [ ] Claim conflict: second claimant gets `CONFLICT_CLAIMED` (AC: 9)
  - [ ] Version conflict on patch/release/complete returns `CONFLICT_VERSION` (AC: 7, 10)
  - [ ] Invalid transitions return `VALIDATION_ERROR` (AC: 8)

## Dev Notes
Source of truth:
- API contract (endpoints, filters, sorting, errors, state machine): `docs/architecture/api-contract.md` (see “Tasks”, “Task Types”, “Conventions”, “Authorization Rules (MVP)”, “Error Codes”) 
- Data model + concurrency strategy: `docs/architecture/data-model.md` (see “TaskType”, “Task”, “Concurrency Strategy”, “Claim Conflicts”, “Status State Machine”) 
- Product constraints (“pull-based / no assignment”): `docs/brief.md` (see “Acceptance Criteria: No Asignación Directa”) 

Authorization rules (MVP):
- Creating tasks: any **project member**.
- Editing tasks (fields other than notes): requires the task to be **claimed by the caller**.
- Claim/Release/Complete: only valid for **project members**; Release/Complete require caller is the claimer.
- No direct assignment (no endpoint to assign tasks to others).
  [Source: `docs/architecture/api-contract.md` “Authorization Rules (MVP)”]

Task list constraints (MVP):
- No pagination.
- Sorting: tasks sorted by `created_at DESC`.
- Search `q` only matches title/description.
- `capability_id` is a **single value** in MVP.
  [Source: `docs/architecture/api-contract.md` “Conventions” and “GET /api/v1/projects/:project_id/tasks”]

vNext note (explicit):
- **vNext**: `GET /projects/:project_id/tasks` may accept multiple capabilities (e.g. `capability_id=1,2,3`). Do not implement multi-value parsing in MVP.
  [Source: `docs/architecture/api-contract.md` “GET /api/v1/projects/:project_id/tasks” (vNext note)]

### Testing
- Use `gleeunit`.
- Focus tests on:
  - state machine correctness,
  - authorization rules (claim-required edits),
  - optimistic concurrency (`version` mismatches),
  - claim conflict behavior (`CONFLICT_CLAIMED`),
  - filter/search correctness and default sorting.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-12 | 1.0 | Initial draft | architect |
| 2026-01-12 | 1.1 | Refined story statement, acceptance criteria, tasks, dev notes, and testing focus aligned to pool/tasks contract and MVP constraints (incl. vNext) | sm |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
