# Story 7.6: Creacion contextual de tarjeta desde Hito

## Status

Draft

## Story

**As a** manager del proyecto,
**I want** crear tarjetas desde el detalle de un hito con contexto preseleccionado,
**so that** el flujo sea consistente con la creacion de subelementos en otras entidades (por ejemplo, task desde card) y reduzca errores de asignacion.

## Problem Statement

Hoy el flujo tecnico de crear tarjeta desde hito ya existe (abre el `card-crud-dialog` con `milestone-id`), pero la experiencia no comunica claramente el contexto, y no sigue al 100% el mismo patron visible de "creacion de subelemento" usado en card-detail (`+ Anadir tarea` -> dialog global con contexto).

## Objetivo UX

Unificar el patron de "creacion contextual" en toda la plataforma:

- Entidad padre (Card/Hito) -> CTA contextual de subelemento
- Apertura de dialog global estandar
- Contexto visible y bloqueado en el dialog
- Retorno al contexto de origen al cerrar

## Acceptance Criteria

1. **AC1**: Desde el detalle de hito, el CTA principal para subelemento es `+ Nueva tarjeta en este hito` (o copy equivalente i18n), visible junto a `+ Nueva tarea` en el tab `Contenido`.
2. **AC2**: Al hacer click en crear tarjeta desde hito, se abre `card-crud-dialog` en modo create con `milestone-id` preseleccionado.
3. **AC3**: En `card-crud-dialog`, cuando hay `milestone-id`, se muestra bloque contextual de solo lectura: `Hito destino: <nombre del hito>`.
4. **AC4**: En flujo contextual desde hito, el usuario no puede crear tarjeta "sin hito" accidentalmente (el contexto queda fijo en ese dialog).
5. **AC5**: Al cerrar/cancelar el dialog de tarjeta, se preserva el contexto de navegacion de hitos (misma vista y, si aplica, mismo detalle abierto).
6. **AC6**: El patron UX queda alineado con card-detail: `+ Anadir tarea` en card -> dialog de task con contexto de card; `+ Anadir tarjeta` en hito -> dialog de card con contexto de hito.
7. **AC7**: i18n completo ES/EN para labels nuevos de CTA/contexto.
8. **AC8**: Cobertura de pruebas deterministicas para estado y render contextual (unit/integration UI).

## Componentes a reutilizar

### Reutilizacion directa (sin crear componentes nuevos)

1. **`ui/dialog.gleam`**
   - Shell modal estandar para create/edit.
   - Mantener estructura header/body/footer y accesibilidad existente.
2. **`components/card_crud_dialog` + `features/admin/view.gleam`**
   - Ya soporta atributo `milestone-id`.
   - Extender solo el body para mostrar contexto visible (read-only) cuando aplique.
3. **`features/milestones/update.gleam`**
   - Ya enruta `MemberMilestoneCreateCardClicked(milestone_id)` hacia apertura contextual.
4. **`ui/card_section_header.gleam`**
   - Reusar para consistencia visual del CTA de subelemento en encabezados de seccion.
5. **`features/pool/dialogs.gleam`**
   - Reusar el patron existente de campo contextual read-only (ejemplo: milestone target en create task).

### No reutilizar/evitar

- No crear modal ad hoc para "tarjeta en hito".
- No duplicar formularios de create card dentro de `features/milestones/view.gleam`.
- No introducir variante visual separada para este flujo.

## Proposed UX spec

1. **Punto de entrada**: detalle de hito -> tab `Contenido`.
2. **CTA**: `+ Nueva tarjeta en este hito`.
3. **Dialog**: `card-crud-dialog` (mismo componente global).
4. **Contexto visible**:
   - Label: `Hito destino`
   - Value: nombre del hito
   - Estado: read-only
5. **Acciones**:
   - `Cancelar` cierra sin perder contexto.
   - `Crear` crea tarjeta asociada a milestone.
6. **Post-accion**:
   - Toast de exito existente.
   - Refetch/list refresh existente.
   - Mantener foco y contexto de hito.

## Tasks / Subtasks

- [ ] **Task 1: Ajustar copy y entrada contextual en detalle de hito**
  - [ ] 1.1 Actualizar label CTA de crear tarjeta para explicitar contexto de hito.
  - [ ] 1.2 Confirmar consistencia con CTA de crear task en card-detail (mismo tono/patron).

- [ ] **Task 2: Hacer visible el contexto en card-crud-dialog**
  - [ ] 2.1 Renderizar bloque `Hito destino: <nombre>` cuando `milestone-id` venga informado.
  - [ ] 2.2 Marcar el contexto como read-only en este flujo.

- [ ] **Task 3: Asegurar integridad del flujo contextual**
  - [ ] 3.1 Verificar que `MemberMilestoneCreateCardClicked` propaga `milestone-id` hasta el submit.
  - [ ] 3.2 Verificar que cancelar/cerrar no rompe el estado de la vista de hitos.

- [ ] **Task 4: i18n**
  - [ ] 4.1 Agregar/ajustar claves ES/EN para CTA y label de contexto.
  - [ ] 4.2 Validar que no queden hardcodes en view/dialog.

- [ ] **Task 5: Testing**
  - [ ] 5.1 Unit test de estado: apertura contextual setea `cards_create_milestone_id = Some(id)`.
  - [ ] 5.2 Render test: `card-crud-dialog` muestra `milestone-id` + contexto visible.
  - [ ] 5.3 Regression test de cancelacion y retorno de contexto.
  - [ ] 5.4 (Opcional) E2E con agent-browser: crear tarjeta desde hito y validar asociacion.

## Testing Notes

- Cliente:
  - `gleam check && gleam test` en `apps/client`
- Server/shared:
  - no se esperan cambios funcionales de backend para este story

## Definition of Done

- Flujo contextual de crear tarjeta desde hito visible y consistente con otros subelementos.
- Reutilizacion de componentes existentes sin crear variantes ad hoc.
- i18n ES/EN completo.
- Pruebas de regresion pasando.
