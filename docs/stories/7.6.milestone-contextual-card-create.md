# Story 7.6: Creacion contextual de tarjeta desde Hito

## Status

Approved

## Story

**As a** manager del proyecto,
**I want** crear tarjetas desde el detalle de un hito con contexto preseleccionado,
**so that** el flujo sea consistente con la creacion de subelementos en otras entidades (por ejemplo, task desde card) y reduzca errores de asignacion.

## Problem Statement

Hoy el flujo tecnico de crear tarjeta desde hito ya existe (abre el `card-crud-dialog` con `milestone-id`), pero la experiencia no comunica claramente el contexto, y no sigue al 100% el mismo patron visible de "creacion de subelemento" usado en card-detail (`+ Anadir tarea` -> dialog global con contexto).

## Objetivo UX

Unificar el patron de "creacion contextual" en toda la plataforma:

- Entidad padre (Card/Hito) -> CTA contextual de subelemento
- Apertura de dialog global estandar
- Contexto visible y bloqueado en el dialog
- Retorno al contexto de origen al cerrar

## Acceptance Criteria

1. **AC1**: Desde el detalle de hito, el CTA principal para subelemento es `+ Nueva tarjeta en este hito` (o copy equivalente i18n), visible junto a `+ Nueva tarea` en el tab `Contenido`.
2. **AC2**: Al hacer click en crear tarjeta desde hito, se abre `card-crud-dialog` en modo create con `milestone-id` preseleccionado.
3. **AC3**: En `card-crud-dialog`, cuando hay `milestone-id`, se muestra bloque contextual de solo lectura: `Hito destino: <nombre del hito>`.
4. **AC4**: En flujo contextual desde hito, el usuario no puede crear tarjeta "sin hito" accidentalmente (el contexto queda fijo en ese dialog).
5. **AC5**: Al cerrar/cancelar el dialog de tarjeta, se preserva el contexto de navegacion de hitos (misma vista y, si aplica, mismo detalle abierto).
6. **AC6**: El patron UX queda alineado con card-detail: `+ Anadir tarea` en card -> dialog de task con contexto de card; `+ Anadir tarjeta` en hito -> dialog de card con contexto de hito.
7. **AC7**: i18n completo ES/EN para labels nuevos de CTA/contexto.
8. **AC8**: Cobertura de pruebas deterministicas para estado y render contextual (unit/integration UI).
9. **AC9**: La implementacion reutiliza componentes y flujo existentes (`card-crud-dialog`, `ui/dialog`, `features/milestones/update`) sin crear modal/formulario duplicado ni rutas paralelas de estado.
10. **AC10**: El manejo del contexto `milestone-id` es type-safe en Gleam (sin estados invalidos representables), usando `Option`/tipos de dominio y pattern matching exhaustivo en las ramas relevantes.
11. **AC11**: El desarrollo sigue enfoque TDD: primero pruebas que fallen para comportamiento contextual y luego implementacion minima hasta verde.
12. **AC12**: Se mantiene calidad de arquitectura y codigo: funciones publicas con firmas explicitas, helpers puros para logica de contexto y cero regresiones en flujo existente de creacion de tarjetas fuera de hito.
13. **AC13**: Accesibilidad del flujo contextual: al abrir el dialog el foco cae en un objetivo predecible (titulo o primer campo), al cerrar retorna al CTA de origen, y el bloque `Hito destino` es legible por lector de pantalla.
14. **AC14**: Feedback de error en create contextual: si falla la creacion, el dialog permanece abierto, muestra error claro, y conserva el `milestone-id` para reintento.
15. **AC15**: Calidad de microcopy/i18n ES/EN: textos nuevos son claros, consistentes en termino funcional (`hito`, `tarjeta`, `crear`), sin hardcodes ni traducciones ambiguas.
16. **AC16**: Reutilizacion visual estricta en vistas: no se introducen estructuras ni estilos ad hoc para este flujo; se reutilizan componentes y clases existentes de dialog/header/acciones, o se documenta excepcion justificada en `Dev Agent Record`.

## Componentes a reutilizar

### Reutilizacion directa (sin crear componentes nuevos)

1. **`ui/dialog.gleam`**
   - Shell modal estandar para create/edit.
   - Mantener estructura header/body/footer y accesibilidad existente.
2. **`components/card_crud_dialog` + `features/admin/view.gleam`**
   - Ya soporta atributo `milestone-id`.
   - Extender solo el body para mostrar contexto visible (read-only) cuando aplique.
3. **`features/milestones/update.gleam`**
   - Ya enruta `MemberMilestoneCreateCardClicked(milestone_id)` hacia apertura contextual.
4. **`ui/card_section_header.gleam`**
   - Reusar para consistencia visual del CTA de subelemento en encabezados de seccion.
5. **`features/pool/dialogs.gleam`**
   - Reusar el patron existente de campo contextual read-only (ejemplo: milestone target en create task).

### No reutilizar/evitar

- No crear modal ad hoc para "tarjeta en hito".
- No duplicar formularios de create card dentro de `features/milestones/view.gleam`.
- No introducir variante visual separada para este flujo.

## Criterios de calidad (gleam-tdd-development + gleam-type-system)

1. **Signatures first**
   - Toda funcion publica nueva/modificada relacionada con el flujo contextual debe declarar tipo explicito.
2. **Modelado type-safe del contexto**
   - Evitar booleans sueltos o strings implicitos para decidir modo contextual.
   - Representar el contexto de creacion con `Option` y/o un tipo de dominio pequeno (si aplica) para hacer estados invalidos no representables.
3. **Pattern matching exhaustivo**
   - En actualizaciones y render de estado contextual, cubrir explicitamente todas las variantes esperadas.
4. **Efectos explicitos**
   - Mantener separada la logica pura de transformacion de estado (helpers puros) de los efectos de UI/comandos.
5. **Reutilizacion por extraccion**
   - Si aparece logica duplicada entre create-card contextual/no contextual, extraer helper compartido en vez de copiar ramas.
6. **TDD pragmatica**
   - Orden minimo: test de estado -> test de render contextual -> test de regresion de cancelacion/contexto.

## UX NFRs (usabilidad y calidad visual)

1. **Foco y teclado**
   - Apertura de dialog con foco inicial predecible.
   - Cierre/cancelacion devuelve foco al CTA origen en detalle de hito.
   - Flujo operable por teclado en acciones principales (`Cancelar`/`Crear`).
2. **Feedback de estado**
   - Exito: toast existente.
   - Error: mensaje visible y accionable sin perder contexto.
3. **Jerarquia visual**
   - CTA contextual y bloque `Hito destino` deben ser facilmente distinguibles del resto del formulario.
   - Sin nuevas variantes visuales; usar patrones existentes.
4. **Copy e i18n**
   - ES/EN con tono consistente y terminologia estable.
   - Evitar textos literales confusos o tecnicos para usuario final.

## Proposed UX spec

1. **Punto de entrada**: detalle de hito -> tab `Contenido`.
2. **CTA**: `+ Nueva tarjeta en este hito`.
3. **Dialog**: `card-crud-dialog` (mismo componente global).
4. **Contexto visible**:
   - Label: `Hito destino`
   - Value: nombre del hito
   - Estado: read-only
5. **Acciones**:
   - `Cancelar` cierra sin perder contexto.
   - `Crear` crea tarjeta asociada a milestone.
6. **Post-accion**:
   - Toast de exito existente.
   - Refetch/list refresh existente.
   - Mantener foco y contexto de hito.

## Tasks / Subtasks

- [ ] **Task 1 (AC: 1, 6, 7, 15, 16): Ajustar copy y entrada contextual en detalle de hito**
  - [ ] 1.1 Actualizar label CTA de crear tarjeta para explicitar contexto de hito.
  - [ ] 1.2 Confirmar consistencia con CTA de crear task en card-detail (mismo tono/patron).
  - [ ] 1.3 Reusar `ui/card_section_header.gleam` para header+accion en detalle de hito; si no se usa, documentar motivo tecnico en `Dev Agent Record`.

- [ ] **Task 2 (AC: 2, 3, 4, 9, 10, 16): Hacer visible el contexto en card-crud-dialog**
  - [ ] 2.1 Renderizar bloque `Hito destino: <nombre>` cuando `milestone-id` venga informado.
  - [ ] 2.2 Marcar el contexto como read-only en este flujo.
  - [ ] 2.3 Implementar el render contextual sobre el componente existente, sin duplicar cuerpo/formulario del dialog.

- [ ] **Task 3 (AC: 2, 5, 9, 10, 12): Asegurar integridad del flujo contextual**
  - [ ] 3.1 Verificar que `MemberMilestoneCreateCardClicked` propaga `milestone-id` hasta el submit.
  - [ ] 3.2 Verificar que cancelar/cerrar no rompe el estado de la vista de hitos.
  - [ ] 3.3 Extraer/usar helper puro para resolver estado de create card contextual y evitar logica duplicada.
  - [ ] 3.4 Revisar pattern matching para asegurar exhaustividad en rutas contextual/no contextual.

- [ ] **Task 4 (AC: 7, 15): i18n**
  - [ ] 4.1 Agregar/ajustar claves ES/EN para CTA y label de contexto.
  - [ ] 4.2 Validar que no queden hardcodes en view/dialog.

- [ ] **Task 5 (AC: 8, 11, 13, 14): Testing**
  - [ ] 5.0 Escribir primero pruebas en rojo para flujo contextual (TDD).
  - [ ] 5.1 Unit test de estado: apertura contextual setea `cards_create_milestone_id = Some(id)`.
  - [ ] 5.2 Render test: `card-crud-dialog` muestra `milestone-id` + contexto visible.
  - [ ] 5.3 Regression test de cancelacion y retorno de contexto.
  - [ ] 5.4 Regression test: crear tarjeta no contextual sigue funcionando sin bloque contextual.
  - [ ] 5.5 (Opcional) E2E con agent-browser: crear tarjeta desde hito y validar asociacion.
  - [ ] 5.6 Test UX de foco: apertura/cierre del dialog preserva origen de navegacion.
  - [ ] 5.7 Test de error contextual: fallo en create mantiene dialog abierto y contexto de hito.

- [ ] **Task 7 (AC: 13, 14, 15): Calidad UX final (copy + accesibilidad)**
  - [ ] 7.1 Revisar microcopy ES/EN para CTA/contexto/error con criterio de claridad para usuario final.
  - [ ] 7.2 Validar atributos/estructura accesible del bloque contextual (`Hito destino`) en render.
  - [ ] 7.3 Confirmar consistencia visual final con patrones existentes, sin variantes nuevas.
  - [ ] 7.4 Verificar que no se agregaron clases/estructura ad hoc para este flujo (o dejar excepcion justificada).

- [ ] **Task 6 (AC: 10, 11, 12): Quality gates de implementacion Gleam**
  - [ ] 6.1 Verificar firmas explicitas en funciones publicas tocadas por el flujo.
  - [ ] 6.2 Ejecutar `gleam format` en modulos modificados.
  - [ ] 6.3 Ejecutar `gleam check && gleam test` y dejar evidencia en registro del agente dev.

## Mapa de implementacion (ready for dev)

### Task 1 - CTA contextual en detalle de hito

- `apps/client/src/scrumbringer_client/features/milestones/view.gleam:1075`
  - Boton actual `milestone-details-new-card:*` con copy `+ NewCard`.
  - Ajustar copy para contexto (nuevo key i18n) y mantener `data-testid` existente.
- `apps/client/src/scrumbringer_client/ui/card_section_header.gleam:67`
  - Reusar API `view`/`view_with_class` para alinear patron visual de header + accion en detalle de hito.

### Task 2 - Contexto visible y bloqueado en `card-crud-dialog`

- `apps/client/src/scrumbringer_client/features/admin/view.gleam:1020`
  - Inyeccion de atributos del custom element `card-crud-dialog`.
  - Extender atributos para pasar contexto legible (ej. nombre del hito), ademas de `milestone-id`.
- `apps/client/src/scrumbringer_client/components/card_crud_dialog.gleam:60`
  - Modelo del componente (`create_milestone_id`) y mensajes de atributos (`MilestoneIdReceived`).
  - Agregar campo/atributo para nombre de hito contextual.
- `apps/client/src/scrumbringer_client/components/card_crud_dialog.gleam:644`
  - `view_create_dialog`: insertar bloque read-only `Hito destino: <nombre>` cuando hay contexto.
  - Mantener formulario create existente (sin duplicar modal ni form).

### Task 3 - Integridad del flujo contextual y reutilizacion de codigo

- `apps/client/src/scrumbringer_client/features/milestones/update.gleam:195`
  - Evento `MemberMilestoneCreateCardClicked(milestone_id)`.
  - Mantener cierre de dialog de hito + apertura de dialog global contextual.
- `apps/client/src/scrumbringer_client/features/admin/cards.gleam:81`
  - `handle_open_card_dialog` y `handle_open_card_dialog_for_milestone`.
  - Punto recomendado para extraer helper puro compartido de resolucion de `cards_create_milestone_id`.
- `apps/client/src/scrumbringer_client/features/pool/update.gleam:1998`
  - Enrutamiento unificado de `OpenCardDialog/CloseCardDialog` hacia `features/admin/cards`.
  - Validar que cancelar/cerrar solo limpia estado de card dialog sin romper navegacion en hitos.
- `apps/client/src/scrumbringer_client/client_view.gleam:145`
  - Overlays globales (`view_global_overlays`) que sostienen apertura/cierre del `card-crud-dialog`.

### Task 4 - i18n ES/EN

- `apps/client/src/scrumbringer_client/i18n/text.gleam:6`
  - Agregar claves nuevas de CTA contextual y label de contexto de hito.
- `apps/client/src/scrumbringer_client/i18n/es.gleam:812`
  - Traducciones ES para nuevas claves.
- `apps/client/src/scrumbringer_client/i18n/en.gleam:796`
  - Traducciones EN para nuevas claves.

### Task 5 - Testing deterministico (TDD)

- `apps/client/test/milestones_update_test.gleam:493`
  - Ya cubre apertura contextual con `cards_create_milestone_id = Some(id)`.
  - Extender con regresion de cierre/cancelacion y no regresion de flujo no contextual.
- `apps/client/test/milestones_view_test.gleam:505`
  - Agregar assertions del nuevo copy contextual en CTA de detalle de hito.
- `apps/client/test/admin_cards_view_test.gleam:50`
  - Agregar test de render de `card-crud-dialog` con atributos contextuales (`milestone-id` y nombre) cuando corresponda.
- `apps/client/test/card_crud_dialog_test.gleam:21`
  - Ampliar con pruebas del modelo/mensajes para contexto visible read-only (sin permitir edicion de contexto).

### Task 6 - Gates de calidad Gleam

- Verificar en cada modulo tocado:
  - firmas de funciones publicas explicitas,
  - pattern matching exhaustivo en ramas contextual/no contextual,
  - helpers puros para logica de estado.
- Comandos obligatorios en `apps/client`:
  - `gleam format`
  - `gleam check`
  - `gleam test`

## Testing Notes

- Cliente:
  - `gleam check && gleam test` en `apps/client`
  - Validar especificamente pruebas nuevas de estado/render/regresion para flujo contextual de hito.
- Server/shared:
  - no se esperan cambios funcionales de backend para este story

## Dev Notes

- Flujo de apertura contextual ya existente en `features/milestones/update.gleam` con `MemberMilestoneCreateCardClicked(milestone_id)`; la implementacion debe extenderlo sin crear rutas paralelas.
- El dialog de tarjeta es global y se renderiza desde `client_view.gleam` via `features/admin/view.gleam` (`card-crud-dialog`), por lo que el contexto debe viajar via atributos del custom element.
- El patron de contexto read-only ya existe en task create dialog (`features/pool/dialogs.gleam`); reutilizar ese enfoque visual/semantico.
- Mantener type-safety: `Option(Int)` para `cards_create_milestone_id`, pattern matching exhaustivo en ramas contextual/no contextual, y helper puro para evitar duplicacion.

### Testing

- Ubicacion principal de pruebas: `apps/client/test`.
- Suites objetivo de esta historia:
  - `milestones_update_test.gleam` (estado/contexto),
  - `milestones_view_test.gleam` (CTA/copy en detalle de hito),
  - `admin_cards_view_test.gleam` (atributos del dialog global),
  - `card_crud_dialog_test.gleam` (render/estado contextual read-only).
- Validacion obligatoria: `gleam format && gleam check && gleam test` en `apps/client`.

## Definition of Done

- Flujo contextual de crear tarjeta desde hito visible y consistente con otros subelementos.
- Reutilizacion de componentes existentes sin crear variantes ad hoc.
- Logica contextual type-safe y sin duplicacion accidental de ramas.
- i18n ES/EN completo.
- Pruebas unit/integration de contexto y regresion pasando bajo enfoque TDD.
- Accesibilidad y feedback de error validados para flujo contextual.
- Verificado en review: sin modal/formulario/ruta de estado duplicada para este flujo.
- Verificado en review: sin estructuras o estilos ad hoc en vistas para este flujo (o excepcion justificada documentada).

## Change Log

| Date       | Version | Description                                                                 | Author |
| ---------- | ------- | --------------------------------------------------------------------------- | ------ |
| 2026-02-07 | 0.1     | Story inicial 7.6 con flujo contextual de tarjeta desde hito               | PO     |
| 2026-02-07 | 0.2     | Refuerzo de ACs de reutilizacion, type-safety, TDD y quality gates Gleam   | PO     |
| 2026-02-07 | 0.3     | Refuerzo UX: accesibilidad, feedback de error, microcopy i18n y pre-flight | PO     |
| 2026-02-07 | 1.0     | Pre-flight completado, trazabilidad Task-AC y status cambiado a Approved   | PO     |

## Dev Agent Record

### Agent Model Used

_Pending implementation._

### Debug Log References

_Pending implementation._

### Completion Notes List

_Pending implementation._

### File List

_Pending implementation._

## QA Results

_Pending QA review._
