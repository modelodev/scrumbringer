# Story 1.6: Notes (Append-only) + Task Positions (Per-user)

## Status
Approved

## Story
**As a** project member,
**I want** to add append-only notes to tasks and persist my per-task positions,
**so that** collaboration is captured and my personal pool layout is preserved.

## Acceptance Criteria
1. **List notes**: `GET /api/v1/tasks/:task_id/notes` returns `200` `{ data: { notes: TaskNote[] } }` for tasks in projects the user belongs to.
2. **Add note (append-only)**: `POST /api/v1/tasks/:task_id/notes` accepts `{ content }` and returns `200` `{ data: { note } }`.
3. **Append-only enforcement (negative)**: There is no edit/delete for task notes in MVP; notes cannot be modified once created.
4. **Notes do not require claim**: Any project member can add notes to a task regardless of whether the task is claimed, and this is the only universally writable task-related action without claim.
5. **Get my positions**: `GET /api/v1/me/task-positions` returns `200` `{ data: { positions: TaskPosition[] } }` for the current user, optionally filtered by `project_id`.
6. **Set my position (per-user)**: `PUT /api/v1/me/task-positions/:task_id` accepts `{ x, y }` and stores the position for the current user and that task.
7. **Per-user enforcement (negative)**: A user cannot create/update positions for other users.
8. **Project membership enforcement**: Notes and positions endpoints reject access (non-2xx) when the referenced task is not in a project the user belongs to.

## Tasks / Subtasks
- [ ] Implement task notes persistence + endpoints (AC: 1, 2, 3, 4, 8)
  - [ ] Persist `task_notes` with `task_id`, `user_id`, `content`, `created_at` (AC: 2)
  - [ ] Implement `GET /tasks/:task_id/notes` (AC: 1)
  - [ ] Implement `POST /tasks/:task_id/notes` (AC: 2)
  - [ ] Ensure no endpoints exist for patch/delete notes (AC: 3)
  - [ ] Enforce project membership for note access (AC: 8)
- [ ] Implement per-user task positions persistence + endpoints (AC: 5, 6, 7, 8)
  - [ ] Persist `task_positions` with primary key `(task_id, user_id)` (AC: 6)
  - [ ] Implement `GET /me/task-positions` with optional `project_id` filter (AC: 5)
  - [ ] Implement `PUT /me/task-positions/:task_id` to upsert the current user’s position (AC: 6, 7)
  - [ ] Enforce that positions are only writable for the current user (AC: 7)
  - [ ] Enforce project membership for task_id access (AC: 8)
- [ ] Add tests for append-only and per-user scoping (AC: 3, 4, 7, 8)
  - [ ] Notes creation works without claim and returns expected shape (AC: 2, 4)
  - [ ] Task patch still requires claim (regression check against story 1.5 rules) (AC: 4)
  - [ ] Position upsert is per-user (cannot overwrite another user’s position) (AC: 7)
  - [ ] Access is rejected for tasks outside user’s projects (AC: 8)

## Dev Notes
Source of truth:
- API contract (notes + positions endpoints, auth rules): `docs/architecture/api-contract.md` (see “Task Notes”, “Task Positions”, “Authorization Rules (MVP)”) 
- Data model (tables): `docs/architecture/data-model.md` (see “TaskNote”, “TaskPosition”) 

Notes (MVP):
- Notes are **append-only** and can be added by any project member.
  [Source: `docs/architecture/api-contract.md` “Authorization Rules (MVP)” and “Task Notes (append-only)”]

Positions (MVP):
- Positions are **per-user** and can only be written by the current user.
  [Source: `docs/architecture/api-contract.md` “Authorization Rules (MVP)” and “Task Positions (per-user)”]

DB constraint:
- `task_positions` primary key is `(task_id, user_id)`, so the intended behavior is a per-user per-task upsert/overwrite.
  [Source: `docs/architecture/data-model.md` “TaskPosition”]

### Testing
- Use `gleeunit`.
- Focus tests on:
  - append-only notes (presence of list/create + absence of edit/delete),
  - note creation allowed without claim,
  - per-user positions scoping,
  - membership enforcement (cannot read/write against tasks in other projects).

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-12 | 1.0 | Initial draft | architect |
| 2026-01-12 | 1.1 | Refined story statement, acceptance criteria, tasks, dev notes, and testing focus aligned to notes/positions contract | sm |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
