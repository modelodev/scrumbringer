# Story 1.6: Notes (Append-only) + Task Positions (Per-user)

## Status
Done

## Story
**As a** project member,
**I want** to add append-only notes to tasks and persist my per-task positions,
**so that** collaboration is captured and my personal pool layout is preserved.

## Acceptance Criteria
1. **List notes**: `GET /api/v1/tasks/:task_id/notes` returns `200` `{ data: { notes: TaskNote[] } }` for tasks in projects the user belongs to.
2. **Add note (append-only)**: `POST /api/v1/tasks/:task_id/notes` accepts `{ content }` and returns `200` `{ data: { note } }`.
3. **Append-only enforcement (negative)**: There is no edit/delete for task notes in MVP; notes cannot be modified once created.
4. **Notes do not require claim**: Any project member can add notes to a task regardless of whether the task is claimed, and this is the only universally writable task-related action without claim.
5. **Get my positions**: `GET /api/v1/me/task-positions` returns `200` `{ data: { positions: TaskPosition[] } }` for the current user, optionally filtered by `project_id`.
6. **Set my position (per-user)**: `PUT /api/v1/me/task-positions/:task_id` accepts `{ x, y }` and stores the position for the current user and that task.
7. **Per-user enforcement (negative)**: A user cannot create/update positions for other users.
8. **Project membership enforcement**: Notes and positions endpoints reject access (non-2xx) when the referenced task is not in a project the user belongs to.

## Tasks / Subtasks
- [x] Implement task notes persistence + endpoints (AC: 1, 2, 3, 4, 8)
  - [x] Persist `task_notes` with `task_id`, `user_id`, `content`, `created_at` (AC: 2)
  - [x] Implement `GET /tasks/:task_id/notes` (AC: 1)
  - [x] Implement `POST /tasks/:task_id/notes` (AC: 2)
  - [x] Ensure no endpoints exist for patch/delete notes (AC: 3)
  - [x] Enforce project membership for note access (AC: 8)
- [x] Implement per-user task positions persistence + endpoints (AC: 5, 6, 7, 8)
  - [x] Persist `task_positions` with primary key `(task_id, user_id)` (AC: 6)
  - [x] Implement `GET /me/task-positions` with optional `project_id` filter (AC: 5)
  - [x] Implement `PUT /me/task-positions/:task_id` to upsert the current user’s position (AC: 6, 7)
  - [x] Enforce that positions are only writable for the current user (AC: 7)
  - [x] Enforce project membership for task_id access (AC: 8)
- [x] Add tests for append-only and per-user scoping (AC: 3, 4, 7, 8)
  - [x] Notes creation works without claim and returns expected shape (AC: 2, 4)
  - [x] Task patch still requires claim (regression check against story 1.5 rules) (AC: 4)
  - [x] Position upsert is per-user (cannot overwrite another user’s position) (AC: 7)
  - [x] Access is rejected for tasks outside user’s projects (AC: 8)

## Dev Notes
Source of truth:
- API contract (notes + positions endpoints, auth rules): `docs/architecture/api-contract.md` (see “Task Notes”, “Task Positions”, “Authorization Rules (MVP)”) 
- Data model (tables): `docs/architecture/data-model.md` (see “TaskNote”, “TaskPosition”) 

Notes (MVP):
- Notes are **append-only** and can be added by any project member.
  [Source: `docs/architecture/api-contract.md` “Authorization Rules (MVP)” and “Task Notes (append-only)”]

Positions (MVP):
- Positions are **per-user** and can only be written by the current user.
  [Source: `docs/architecture/api-contract.md` “Authorization Rules (MVP)” and “Task Positions (per-user)”]

DB constraint:
- `task_positions` primary key is `(task_id, user_id)`, so the intended behavior is a per-user per-task upsert/overwrite.
  [Source: `docs/architecture/data-model.md` “TaskPosition”]

### Testing
- Use `gleeunit`.
- Focus tests on:
  - append-only notes (presence of list/create + absence of edit/delete),
  - note creation allowed without claim,
  - per-user positions scoping,
  - membership enforcement (cannot read/write against tasks in other projects).

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-12 | 1.0 | Initial draft | architect |
| 2026-01-12 | 1.1 | Refined story statement, acceptance criteria, tasks, dev notes, and testing focus aligned to notes/positions contract | sm |
| 2026-01-13 | 1.2 | Implemented append-only task notes and per-user task positions endpoints with tests | dev |

## Dev Agent Record

### Agent Model Used
- GPT-5.2 (Codex CLI)

### Debug Log References
- `make migrate` (failed: `dbmate` not available in this environment)
- `psql postgres://scrumbringer:scrumbringer@localhost:5433/scrumbringer_test?sslmode=disable ...` (applied `task_notes`/`task_positions` tables to test DB so Squirrel + tests can run)
- `make squirrel` (regenerated `apps/server/src/scrumbringer_server/sql.gleam`; generated 31 queries)
- `make test` (apps/server: 33 passed; packages/domain: no tests; packages/birl: no tests)

### Completion Notes List
- Added DB migrations for `task_notes` (append-only) and `task_positions` (per-user, `(task_id, user_id)` primary key).
- Implemented `GET/POST /api/v1/tasks/:task_id/notes` with auth + CSRF on POST, and project membership enforcement via `tasks_db.get_task_for_user`.
- Implemented `GET /api/v1/me/task-positions` (optional `project_id`) and `PUT /api/v1/me/task-positions/:task_id` with auth + CSRF and per-user scoping.
- Added HTTP-level tests for append-only behavior (no edit/delete routes), claimless note creation, per-user position isolation, and membership boundary enforcement.

### File List
- `apps/server/src/scrumbringer_server.gleam`
- `apps/server/src/scrumbringer_server/http/task_notes.gleam`
- `apps/server/src/scrumbringer_server/http/task_positions.gleam`
- `apps/server/src/scrumbringer_server/services/task_notes_db.gleam`
- `apps/server/src/scrumbringer_server/services/task_positions_db.gleam`
- `apps/server/src/scrumbringer_server/sql.gleam`
- `apps/server/src/scrumbringer_server/sql/task_notes_create.sql`
- `apps/server/src/scrumbringer_server/sql/task_notes_list.sql`
- `apps/server/src/scrumbringer_server/sql/task_positions_list_for_user.sql`
- `apps/server/src/scrumbringer_server/sql/task_positions_upsert.sql`
- `apps/server/test/notes_and_positions_http_test.gleam`
- `db/migrations/20260113140000_create_task_notes.sql`
- `db/migrations/20260113140001_create_task_positions.sql`

## QA Results

### Review Date: 2026-01-13

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
Implementation matches AC1-AC8: notes are append-only (GET/POST only), claimless note creation is allowed for project members, and task positions are per-user with membership enforcement on read/write. Authentication is required; CSRF double-submit is enforced on write endpoints.

### Test Coverage Notes
- Notes: create/list happy path, membership boundary (404), and regression that task PATCH still requires claim.
- Positions: per-user isolation, project_id filter behavior (403 when filtering by non-member project), and membership boundary on upsert (404).
- Added: append-only negative surface (no edit/delete routes) and CSRF enforcement on note create + position upsert.

### Refactoring Performed
- **File**: `apps/server/test/notes_and_positions_http_test.gleam`
  - **Change**: Added tests for no edit/delete routes and CSRF-required writes
  - **Why**: Protect AC3 and security contract from regressions
  - **How**: Exercised 405/404 route behavior and 403 CSRF failures

### Compliance Check
- Coding Standards: ✓
- Testing Strategy: ✓
- All ACs Met: ✓

### Security Review
- CSRF: ✓ double-submit required on write endpoints; negative tests added.
- Authorization: ✓ membership enforced via `tasks_db.get_task_for_user`; per-user scope enforced by `/me/...` routes.

### Performance Considerations
Notes have an index on `task_id`; positions upsert uses PK `(task_id, user_id)`. Consider adding a `task_positions(user_id)` index if position counts grow.

### Files Modified During Review
- `apps/server/test/notes_and_positions_http_test.gleam` (tests only; already in File List)

### Gate Status
Gate: PASS → docs/qa/gates/1.6-notes-append-only-task-positions-per-user.yml

### Recommended Status
✓ Ready for Done

---

### Re-Verification Date: 2026-01-13

### Reviewed By: Quinn (Test Architect)

### Re-Verification Evidence
- `make test` re-run: apps/server `39 passed, no failures` (domain/birl: no tests found)
- Gate file re-checked: `docs/qa/gates/1.6-notes-append-only-task-positions-per-user.yml` is still `PASS`
  - Gate `updated`: `2026-01-13T13:23:03Z`
  - Gate `expires`: `2026-01-27T13:23:08Z` (still valid as of today)

### Re-Verification Conclusion
No action required. Implementation + tests remain green; gate remains valid.
