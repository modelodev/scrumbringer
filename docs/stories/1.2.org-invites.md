# Story 1.2: Org Invites (Invite-only Registration)

## Status
Done

## Story
**As an** org admin,
**I want** to create invite codes for my organization,
**so that** new users can register (invite-only) and join the org.

## Acceptance Criteria
1. **Create invite (authz)**: `POST /api/v1/org/invites` is accessible only to org admins; non-admins are rejected with `403` error code `FORBIDDEN`.
2. **Request payload**: `POST /api/v1/org/invites` accepts body `{ expires_in_hours? }` where `expires_in_hours` is optional.
3. **Default expiry**: If `expires_in_hours` is omitted, the server uses a default of **168 hours (7 days)**.
4. **Response shape**: On success, `POST /api/v1/org/invites` returns `200` `{ data: { invite } }` where `invite` includes:
   - `code` (opaque, URL-safe token)
   - `created_at`
   - `expires_at`
5. **Single-use enforcement**: An invite can be used exactly once for registration; a consumed invite cannot be used again and is rejected with error code `INVITE_USED`.
6. **Expiry enforcement**: An expired invite is rejected with error code `INVITE_EXPIRED`.
7. **Opaque token**: Invite `code` is treated as an opaque, URL-safe random token (no embedded meaning).
8. **CSRF required (mutating)**: `POST /api/v1/org/invites` requires double-submit CSRF (`X-CSRF` header matches `sb_csrf` cookie); missing/invalid CSRF is rejected with `403` error code `FORBIDDEN`.

## Tasks / Subtasks
- [x] Implement persistence for org invites in PostgreSQL (requires Story 1.2a) (AC: 2, 3, 4, 5, 6)
  - [x] Store `code`, `org_id`, `created_by`, `created_at`, `expires_at`, `used_at`, `used_by` (AC: 4, 5, 6)
  - [x] Ensure invite `code` is unique and URL-safe (AC: 4, 7)
- [x] Implement endpoint `POST /api/v1/org/invites` (AC: 1, 2, 3, 4, 8)
  - [x] Enforce org-admin authorization (AC: 1)
  - [x] Enforce double-submit CSRF (AC: 8)
  - [x] Apply default expiry when omitted (AC: 3)
  - [x] Return `{ data: { invite } }` (AC: 4)
- [x] Ensure registration consumes invites exactly once (AC: 5, 6)
  - [x] Mark `used_at` and `used_by` during successful registration (AC: 5)
  - [x] Reject used invites with `INVITE_USED` (AC: 5)
  - [x] Reject expired invites with `INVITE_EXPIRED` (AC: 6)
- [x] Add tests for invite creation + consumption rules (AC: 1, 3, 5, 6, 8)
  - [x] Non-admin cannot create invite (`FORBIDDEN`) (AC: 1)
  - [x] Missing/invalid CSRF is rejected (`FORBIDDEN`) (AC: 8)
  - [x] Default expiry = 168h when omitted (AC: 3)
  - [x] Used invite is rejected with `INVITE_USED` (AC: 5)
  - [x] Expired invite is rejected with `INVITE_EXPIRED` (AC: 6)

## Dev Notes
Prerequisite:
- This story assumes DB-backed persistence from `docs/stories/1.2a.db-foundation.md` (PostgreSQL + dbmate + pog + Squirrel).

Source of truth:
- API contract (endpoint + defaults + error codes): `docs/architecture/api-contract.md` (see “Organization → Invites”)
- Data model (table shape): `docs/architecture/data-model.md` (see “OrgInvite (invite-only registration)”)

Invite rules (MVP):
- Default expiration when omitted is **168h (7 days)**.
- Invite codes are **single-use**.
  [Source: `docs/architecture/api-contract.md` “Invites (invite-only registration)”]

Token guidance (MVP):
- Treat `invite_code` as an **opaque, URL-safe random token** (not a human-memorable code).
- The API contract includes a shape recommendation (base64url/URL-safe alphabet, ~128 bits+ entropy).
  [Source: `docs/architecture/api-contract.md` “Notes (de facto)”]

### Testing
- Use `gleeunit`.
- Focus tests on:
  - admin authorization,
  - default expiry behavior,
  - single-use + expired invite enforcement,
  - error code mapping for `INVITE_USED` and `INVITE_EXPIRED`.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-12 | 1.0 | Initial draft | architect |
| 2026-01-12 | 1.1 | Refined story statement, acceptance criteria, tasks, dev notes, and testing focus aligned to invites contract | sm |
| 2026-01-13 | 1.2 | Implemented org invite creation endpoint + DB persistence + tests | dev |

## Dev Agent Record

### Agent Model Used
GPT-5.2 (Codex CLI)

### Debug Log References
- `apps/server`: `DATABASE_URL=postgres://scrumbringer:scrumbringer@localhost:5433/scrumbringer_test?sslmode=disable ../../.tools/gleam-1.14.0/gleam run -m squirrel`
- `apps/server`: `DATABASE_URL=postgres://scrumbringer:scrumbringer@localhost:5433/scrumbringer_test?sslmode=disable ../../.tools/gleam-1.14.0/gleam test`

### Completion Notes List
- Added `POST /api/v1/org/invites` route and handler requiring JWT auth, org admin role, and double-submit CSRF.
- Implemented invite creation via Squirrel-generated SQL, storing `created_by` and `expires_at` (default 168h) and returning `{ data: { invite } }` with UTC ISO8601 timestamps.
- Added tests covering admin authz, CSRF enforcement, default expiry behavior, and invite single-use consumption.
- Fixed DB pool naming in tests by making pool names unique per app instance to avoid cross-test interference.

### File List
- Modified `apps/server/src/scrumbringer_server.gleam`
- Modified `apps/server/src/scrumbringer_server/http/auth.gleam`
- Added `apps/server/src/scrumbringer_server/http/org_invites.gleam`
- Added `apps/server/src/scrumbringer_server/services/org_invites_db.gleam`
- Added `apps/server/src/scrumbringer_server/sql/org_invites.sql`
- Modified `apps/server/src/scrumbringer_server/sql.gleam`
- Modified `apps/server/test/auth_http_test.gleam`
- Added `apps/server/test/org_invites_http_test.gleam`

## QA Results

### Review Date: 2026-01-13

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Implementation matches story + API contract: invite creation is org-admin only, requires CSRF double-submit, persists to Postgres, returns `{ data: { invite } }` with ISO-8601 UTC timestamps, and registration consumes invites exactly once.

### Refactoring Performed

- None during QA review.

### Compliance Check

- Coding Standards: ✓ (modular handler in `http/org_invites.gleam`; DB logic isolated)
- Testing Strategy: ✓ (covers authz, CSRF, default expiry, and single-use/expired enforcement)
- All ACs Met: ✓

### Improvements Checklist

- [x] Verify non-admin gets `403 FORBIDDEN`.
- [x] Verify missing CSRF gets `403 FORBIDDEN`.
- [x] Verify default expiry is 168h when omitted.
- [x] Verify invite is single-use (`INVITE_USED`) and expiry enforced (`INVITE_EXPIRED`).
- [ ] Add a short developer note on running DB-backed tests (DATABASE_URL required) if not already present elsewhere.

### Evidence

- Tests passed:
  - `apps/server`: `DATABASE_URL=postgres://scrumbringer:scrumbringer@localhost:5433/scrumbringer_test?sslmode=disable ../../.tools/gleam-1.14.0/gleam test`

### Gate Status

Gate: PASS → docs/qa/gates/1.2-org-invites.yml

### Recommended Status

✓ Ready for Done
