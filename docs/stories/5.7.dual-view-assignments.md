# Story 5.7: Dual View - Vista HÃ­brida de Asignaciones Usuarios/Proyectos

## Status

Approved

## Story

**As a** org administrator,
**I want** una vista unificada que me permita alternar entre "Ver por Proyecto" y "Ver por Usuario" para gestionar asignaciones,
**so that** puedo gestionar la membresÃ­a de usuarios en mÃºltiples proyectos de forma eficiente sin navegar entre vistas separadas.

## Problem Statement

Actualmente la gestiÃ³n de usuarios multi-proyecto estÃ¡ fragmentada en tres vistas desconectadas:

1. **`/org/projects`** - Lista proyectos con CRUD bÃ¡sico, sin visibilidad de miembros
2. **`/org/users`** - Lista usuarios con diÃ¡logo modal para ver/aÃ±adir proyectos (lazy loading, UX pobre)
3. **`/admin/members?project=X`** - Miembros por proyecto (requiere seleccionar proyecto primero en sidebar)

**Problemas identificados:**

- No hay forma de ver "Â¿en quÃ© proyectos estÃ¡ MarÃ­a?" sin abrir un modal
- No hay forma de ver "Â¿quiÃ©n tiene acceso a Project Beta?" sin cambiar de vista
- Onboarding de nuevos empleados requiere mÃºltiples navegaciones y modales
- Usuarios sin proyectos y proyectos vacÃ­os no son visibles fÃ¡cilmente
- La informaciÃ³n de proyectos en la tabla de usuarios muestra "..." hasta abrir el modal

**Nota de integraciÃ³n:** Esta nueva vista **no reemplaza** `/org/users` ni `/org/projects`. Ambas rutas se mantienen sin cambios.

## Objetivos

1. **Vista unificada**: Una sola ruta `/org/assignments` que consolide la gestiÃ³n de asignaciones
2. **Perspectiva dual**: Toggle para cambiar entre "Por Proyecto" y "Por Usuario"
3. **EdiciÃ³n inline**: AÃ±adir/quitar usuarios de proyectos sin modales anidados
4. **Visibilidad de problemas**: Indicadores claros de usuarios sin proyectos y proyectos sin miembros

---

## DiseÃ±o UX

### Toggle de Perspectiva

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â–£ Por Proyecto â”‚ â˜ Por Usuario      â”‚    ğŸ” Buscar...
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Vista Por Proyecto (cards expandidas)

```
â”Œâ”€ ğŸ“ Project Alpha â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                              â”‚
â”‚   ğŸ‘¤ admin@example.com        âš™ï¸ Manager     [Cambiar rol â–¾]  [âœ• Quitar]    â”‚
â”‚   ğŸ‘¤ pm@example.com           ğŸ‘¤ Miembro     [Cambiar rol â–¾]  [âœ• Quitar]    â”‚
â”‚   ğŸ‘¤ member@example.com       ğŸ‘¤ Miembro     [Cambiar rol â–¾]  [âœ• Quitar]    â”‚
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  + AÃ±adir usuario   ğŸ” [Buscar email...              ]  [Manager â–¾]  â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â”‚                                                    [âœ Editar] [ğŸ—‘ Eliminar] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Vista Por Usuario (cards expandidas)

```
â”Œâ”€ ğŸ‘¤ admin@example.com â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Rol Org: Admin â”
â”‚                                                                              â”‚
â”‚   ğŸ“ Project Alpha            âš™ï¸ Manager     [Cambiar rol â–¾]  [âœ• Quitar]    â”‚
â”‚   ğŸ“ Project Beta             âš™ï¸ Manager     [Cambiar rol â–¾]  [âœ• Quitar]    â”‚
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  + AÃ±adir a proyecto   [Seleccionar proyecto...  â–¾]      [Manager â–¾] â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ ğŸ‘¤ nuevo@example.com â”€â”€â”€ âš ï¸ SIN PROYECTOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Rol Org: Member â”
â”‚                                                                              â”‚
â”‚   Este usuario no estÃ¡ asignado a ningÃºn proyecto                            â”‚
â”‚                                                                              â”‚
â”‚   + AÃ±adir a proyecto...                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Indicadores de Problemas

- **Usuario sin proyectos**: Badge `âš ï¸ SIN PROYECTOS` en header de card
- **Proyecto sin miembros**: Badge `âš ï¸ SIN MIEMBROS` + mensaje explicativo

## Acceptance Criteria

### Core

1. Nueva ruta `/org/assignments` accesible desde sidebar bajo "ORGANIZACIÃ“N"
2. Toggle funcional entre "Por Proyecto" y "Por Usuario" que preserva filtro de bÃºsqueda
3. Vista Por Proyecto muestra todos los proyectos como cards expandidas con sus miembros
4. Vista Por Usuario muestra todos los usuarios de la org como cards con sus proyectos asignados
5. BÃºsqueda unificada filtra por nombre de proyecto O email de usuario en ambas vistas

### GestiÃ³n Inline

6. Formulario inline "AÃ±adir usuario" en cada card de proyecto (sin modal)
7. Formulario inline "AÃ±adir a proyecto" en cada card de usuario (sin modal)
8. Dropdown para cambiar rol de usuario en proyecto (member/manager) con guardado automÃ¡tico
9. BotÃ³n para quitar usuario de proyecto con confirmaciÃ³n inline (no modal)

### Indicadores y UX

10. Badge visual `âš ï¸ SIN PROYECTOS` en cards de usuarios sin asignaciones
11. Badge visual `âš ï¸ SIN MIEMBROS` en cards de proyectos vacÃ­os

### Permisos

12. Solo org admins pueden acceder a `/org/assignments`
13. Project managers no pueden acceder (mantiene comportamiento actual de `/org/users`)

### Responsive

14. En mobile, cards mantienen legibilidad sin modales anidados
15. Ãreas tappable mÃ­nimo 44x44px

### Estados vacÃ­os y loading

16. Si no hay proyectos, la vista Por Proyecto muestra un empty state con CTA para crear proyecto
17. Si no hay usuarios, la vista Por Usuario muestra un empty state con CTA para invitar usuario
18. Mientras se cargan miembros/proyectos, cada card muestra indicador de carga local

---

## Tasks / Subtasks

- [ ] **Task 1: Estructura base y routing** (AC: 1, 15)
  - [ ] 1.1 AÃ±adir nueva ruta `/org/assignments` en router
  - [ ] 1.2 Crear mÃ³dulo `features/assignments/view.gleam`
  - [ ] 1.3 Crear mÃ³dulo `features/assignments/update.gleam`
  - [ ] 1.4 AÃ±adir `AssignmentsModel` al estado de admin
  - [ ] 1.5 Verificar permisos de org admin en guard de ruta
  - [ ] 1.6 AÃ±adir entrada en sidebar bajo "ORGANIZACIÃ“N"

- [ ] **Task 2: Toggle y estado de vista** (AC: 2)
  - [ ] 2.1 Crear tipo `AssignmentsViewMode { ByProject | ByUser }`
  - [ ] 2.2 Implementar componente toggle con estilos
  - [ ] 2.3 Sincronizar modo con URL query param `view=projects|users`
  - [ ] 2.4 Preservar bÃºsqueda al cambiar de modo

- [ ] **Task 3: Carga de datos** (AC: 3, 4)
  - [ ] 3.1 Fetch paralelo: `GET /api/v1/projects` + `GET /api/v1/org/users`
  - [ ] 3.2 Fetch members por proyecto: `GET /api/v1/projects/:id/members`
  - [ ] 3.3 Fetch proyectos por usuario: `GET /api/v1/org/users/:id/projects`
  - [ ] 3.4 Manejo de estados de carga y errores
  - [ ] 3.5 Nota: Task 3 debe completarse antes de Task 4/5

- [ ] **Task 4: Vista Por Proyecto** (AC: 3, 6, 8, 9, 11)
  - [ ] 4.1 Crear componente `project_card.gleam` con lista de miembros
  - [ ] 4.2 Reutilizar formulario inline "AÃ±adir usuario"
  - [ ] 4.3 Reutilizar dropdown de cambio de rol
  - [ ] 4.4 Reutilizar botÃ³n quitar con confirmaciÃ³n inline
  - [ ] 4.5 AÃ±adir badge `âš ï¸ SIN MIEMBROS` para proyectos vacÃ­os
  - [ ] 4.6 AÃ±adir acciones de proyecto (editar nombre, eliminar)
  - [ ] 4.7 Empty state si no hay proyectos
  - [ ] 4.8 Loading local por card mientras se cargan miembros

- [ ] **Task 5: Vista Por Usuario** (AC: 4, 7, 8, 9, 10)
  - [ ] 5.1 Crear componente `user_card.gleam` con lista de proyectos
  - [ ] 5.2 Reutilizar formulario inline "AÃ±adir a proyecto"
  - [ ] 5.3 Reutilizar dropdown de cambio de rol
  - [ ] 5.4 Reutilizar botÃ³n quitar
  - [ ] 5.5 AÃ±adir badge `âš ï¸ SIN PROYECTOS` para usuarios sin asignaciones
  - [ ] 5.6 Mostrar rol de org en header de card
  - [ ] 5.7 Empty state si no hay usuarios
  - [ ] 5.8 Loading local por card mientras se cargan proyectos

- [ ] **Task 6: BÃºsqueda** (AC: 5)
  - [ ] 6.1 Implementar input de bÃºsqueda con debounce
  - [ ] 6.2 Filtrar proyectos por nombre en vista proyecto
  - [ ] 6.3 Filtrar usuarios por email en vista usuario

- [ ] **Task 7: API y datos** (AC: 3, 4, 6, 7, 8, 9)
  - [ ] 7.1 Reutilizar endpoints existentes para CRUD de membresÃ­as (base `/api/v1`)
  - [ ] 7.2 Optimistic updates para cambios de rol
  - [ ] 7.3 Manejo de errores con rollback visual

- [ ] **Task 8: Responsive y accesibilidad** (AC: 14, 15)
  - [ ] 8.1 Ajustes de layout mobile para legibilidad sin modales
  - [ ] 8.2 Ãreas tappable 44x44px mÃ­nimo
  - [ ] 8.3 Focus management para navegaciÃ³n por teclado

- [ ] **Task 9: Tests**
  - [ ] 9.1 Escribir tests antes de implementar cada bloque
  - [ ] 9.2 Tests unitarios para toggle y filtrado
  - [ ] 9.3 Tests de renderizado para project_card y user_card
  - [ ] 9.4 Tests de permisos (solo org admin)

---

## Dev Notes

### Fuentes de arquitectura usadas

- `docs/architecture/coding-standards.md`
- `docs/architecture/source-tree.md`
- `docs/architecture/api-contract.md`
- `docs/architecture/lustre-components.md`
- `docs/architecture/testing-architecture.md`
- `docs/brief.md`

### Contexto del brief

- La membresia de proyectos es admin-managed; no hay auto-join. [Source: docs/brief.md#L138]
- Una organizacion puede tener multiples proyectos y un usuario puede estar en varios. [Source: docs/brief.md#L138]

### Frontend architecture guidance

- Preferir **view functions** y usar **components** solo cuando haya estado interno aislado. [Source: docs/architecture/coding-standards.md#L203]
- Reutilizar componentes UI existentes en `ui/` (section_header, data_table, dialog, toast, icons, badge). [Source: docs/architecture/coding-standards.md#L229]
- Usar `icons.nav_icon()` para iconos y tamaÃ±os predefinidos. [Source: docs/architecture/coding-standards.md#L278]
- Empty states deben incluir icono + titulo + descripcion orientada a la accion. [Source: docs/architecture/coding-standards.md#L661]
- Router boundary: parsing/formatting/navegacion en `router.gleam` solamente. [Source: docs/architecture/coding-standards.md#L675]

### API contract constraints

- Base URL `/api/v1` y envelope `{ "data": ... }`. [Source: docs/architecture/api-contract.md#L12]
- Mutaciones requieren CSRF double-submit (header + cookie). [Source: docs/architecture/api-contract.md#L81]
- Endpoints org/users y project members son admin-managed. [Source: docs/architecture/api-contract.md#L333]

### Source tree alignment

- UI client en `apps/client/src/` con composicion en `pages/` y `components/`. [Source: docs/architecture/source-tree.md#L58]

### Testing standards

- Arquitectura de testing tipado (BDD) disponible para specs. [Source: docs/architecture/testing-architecture.md#L9]
- Tests del cliente viven en `apps/client/test/`. [Source: docs/architecture/source-tree.md#L58]

**Casos de test prioritarios:**
1. Toggle cambia vista y preserva bÃºsqueda
2. Filtrado funciona en ambas vistas
3. Cards muestran badge de warning cuando corresponde
4. Empty state correcto cuando no hay proyectos/usuarios
5. Solo org admin puede acceder

---

## Testing

### Test Standards

- Tests en `apps/client/test/`.
- Aplicar arquitectura de testing tipado cuando corresponda.
[Source: docs/architecture/source-tree.md#L58]

### EnumeraciÃ³n de tests (lenguaje natural)

1. Al abrir `/org/assignments`, un org admin puede acceder y ver la vista Por Proyecto por defecto.
2. Un usuario no admin recibe bloqueo de acceso a `/org/assignments`.
3. Cambiar el toggle de Por Proyecto a Por Usuario conserva el texto de bÃºsqueda.
4. Buscar por nombre de proyecto filtra las cards de proyectos en vista Por Proyecto.
5. Buscar por email filtra las cards de usuarios en vista Por Usuario.
6. Si no hay proyectos, la vista Por Proyecto muestra el empty state con CTA â€œCrear proyectoâ€.
7. Si no hay usuarios, la vista Por Usuario muestra el empty state con CTA â€œInvitar usuarioâ€.
8. Un proyecto sin miembros muestra el badge â€œâš ï¸ SIN MIEMBROSâ€.
9. Un usuario sin proyectos muestra el badge â€œâš ï¸ SIN PROYECTOSâ€.
10. Al cargar miembros de un proyecto, la card muestra indicador de loading local y luego lista de miembros.
11. Al cargar proyectos de un usuario, la card muestra indicador de loading local y luego lista de proyectos.
12. Cambiar el rol de un usuario en proyecto hace optimistic update y revierte si la API falla.
13. Quitar usuario de proyecto requiere confirmaciÃ³n inline antes de enviar la solicitud.

### Test Cases

1. **Toggle**: Cambiar de ByProject a ByUser preserva search_query
2. **Filtrado**: Buscar "alpha" en vista proyecto muestra solo Project Alpha
3. **Filtrado**: Buscar "admin" en vista usuario muestra solo admin@example.com
4. **Warning badge**: Usuario sin proyectos muestra `âš ï¸ SIN PROYECTOS`
5. **Warning badge**: Proyecto sin miembros muestra `âš ï¸ SIN MIEMBROS`
6. **Empty state**: Sin proyectos muestra CTA en vista proyecto
7. **Empty state**: Sin usuarios muestra CTA en vista usuario
8. **Permisos**: Usuario member no puede acceder a /org/assignments

---

## Out of Scope

- Acciones masivas (bulk assign) - puede ser historia futura
- Drag & drop para asignar usuarios a proyectos
- Vista matricial (usuarios Ã— proyectos)
- EdiciÃ³n de rol de organizaciÃ³n (se mantiene en /org/users)
- GestiÃ³n de capacidades de usuario (se mantiene en /admin/members)

---

## Risk Assessment

### Primary Risks (Brownfield)

1. **Riesgo de duplicaciÃ³n/confusiÃ³n de flujos**
   - MitigaciÃ³n: mantener `/org/users` y `/org/projects` sin cambios y documentar que `/org/assignments` es adicional.

2. **Riesgo de permisos inconsistentes**
   - MitigaciÃ³n: reutilizar el guard admin-only de `/org/users` y tests de permisos.

3. **Riesgo de rendimiento por mÃºltiples requests**
   - MitigaciÃ³n: fetch paralelo y loading local por card para evitar bloqueo global.

---

## Change Log

| Fecha | VersiÃ³n | DescripciÃ³n | Autor |
|-------|---------|-------------|-------|
| 2026-01-27 | 1.0 | Historia inicial creada desde anÃ¡lisis UX | Sarah (PO) |
| 2026-01-27 | 1.1 | Ajuste de endpoints, fuentes y ready | Sarah (PO) |
| 2026-01-27 | 1.2 | Normalizacion Dev Notes y QA Results | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used

_TBD_

### Debug Log References

_TBD_

### Completion Notes List

_TBD_

### File List

_TBD_

---

## QA Results

_TBD_
