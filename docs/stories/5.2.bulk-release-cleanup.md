# Story 5.2: Limpiar Usuario (Bulk Release)

## Status

Draft

## Story

**As a** project manager,
**I want** poder liberar todas las tareas reclamadas por un usuario con un solo click,
**so that** puedo reasignar trabajo rapidamente cuando un miembro se ausenta o un agente AI se desconecta.

## Problem Statement

Cuando un usuario (humano o agente AI) tiene tareas en estado `claimed` y:
- Se va de vacaciones sin avisar
- Un agente AI se desconecta/cuelga
- Un miembro deja el proyecto

El PM tiene que liberar cada tarea individualmente, lo cual es tedioso y propenso a olvidos.

---

## Acceptance Criteria

### Funcionales

1. **AC1**: En la vista de miembros del proyecto, cada miembro con tareas claimed muestra contador "(N tareas)"
2. **AC2**: Junto al contador hay un boton "Liberar todas"
3. **AC3**: Al hacer click en "Liberar todas", se muestra confirmacion: "Vas a liberar N tareas de {nombre}. Continuars?"
4. **AC4**: Al confirmar, todas las tareas claimed del usuario en ese proyecto pasan a `available`
5. **AC5**: Las tareas liberadas vuelven al pool inmediatamente
6. **AC6**: Se muestra feedback: "Se liberaron N tareas"

### Seguridad

7. **AC7**: Solo el PM del proyecto puede ejecutar esta accion
8. **AC8**: Un usuario no puede ejecutar "Liberar todas" sobre si mismo (debe usar release individual)

### API

9. **AC9**: Nuevo endpoint: `POST /api/v1/projects/:id/members/:user_id/release-all-tasks`
10. **AC10**: El endpoint retorna `{ released_count: N, tasks: [...] }`
11. **AC11**: Si el usuario no tiene tareas claimed, retorna `{ released_count: 0, tasks: [] }`

### i18n

12. **AC12**: Labels en ES/EN para:
    - "Liberar todas" / "Release all"
    - "N tareas reclamadas" / "N claimed tasks"
    - Confirmacion
    - Feedback

---

## UX Design

### Wireframe: Panel de Miembros

```
+-------------------------------------------------+
| MIEMBROS DEL PROYECTO                           |
+-------------------------------------------------+
| Alice Chen (PM)                                 |
|   2 tareas reclamadas                           |
|                                                 |
| Bob Agent (AI)                                  |
|   5 tareas reclamadas  [Liberar todas]          |
|                                                 |
| Carlos Dev                                      |
|   0 tareas reclamadas                           |
+-------------------------------------------------+
```

### Flujo de Confirmacion

```
[PM hace click en "Liberar todas" para Bob Agent]
              |
              v
+------------------------------------------+
| Confirmar liberacion                     |
|                                          |
| Vas a liberar 5 tareas de Bob Agent.     |
| Las tareas volveran al pool.             |
|                                          |
|         [Cancelar]  [Liberar]            |
+------------------------------------------+
              |
              v (si confirma)
+------------------------------------------+
| Se liberaron 5 tareas                    |
+------------------------------------------+
```

---

## Technical Notes

### Backend

**Nuevo endpoint:**
```
POST /api/v1/projects/:project_id/members/:user_id/release-all-tasks
Authorization: PM del proyecto
Body: {} (no requiere payload)
Response: { released_count: Int, tasks: [Task] }
```

**SQL aproximado:**
```sql
UPDATE tasks
SET status = 'available',
    claimed_by = NULL,
    claimed_at = NULL,
    version = version + 1
WHERE project_id = $1
  AND claimed_by = $2
  AND status = 'claimed'
RETURNING *;
```

### Frontend

**Archivos a modificar:**
- `features/admin/members_view.gleam` - Añadir contador y boton
- `api/tasks.gleam` - Añadir `release_all_tasks(project_id, user_id)`
- `client_state.gleam` - Msg para release all
- `i18n/*.gleam` - Nuevos textos

---

## Out of Scope

- Liberar tareas de multiples usuarios a la vez
- Seleccionar que tareas liberar (todo o nada)
- Notificar al usuario afectado

---

## Risk Assessment

- **Primary Risk:** Liberar tareas accidentalmente
- **Mitigation:** Confirmacion obligatoria con nombre del usuario y cantidad
- **Secondary Risk:** Conflictos de version si el usuario completa mientras se ejecuta
- **Mitigation:** El UPDATE con WHERE status='claimed' solo afecta las que siguen claimed

