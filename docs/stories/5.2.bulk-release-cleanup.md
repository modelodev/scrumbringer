# Story 5.2: Limpiar Usuario (Bulk Release)

## Status

Done

## Story

**As a** project manager,
**I want** poder liberar todas las tareas reclamadas por un usuario con un solo click,
**so that** puedo reasignar trabajo rapidamente cuando un miembro se ausenta o un agente AI se desconecta.

## Problem Statement

Cuando un usuario (humano o agente AI) tiene tareas en estado `claimed` y:
- Se va de vacaciones sin avisar
- Un agente AI se desconecta/cuelga
- Un miembro deja el proyecto

El PM tiene que liberar cada tarea individualmente, lo cual es tedioso y propenso a olvidos.

---

## Acceptance Criteria

### Funcionales

1. **AC1**: En la vista de miembros del proyecto, cada miembro con tareas claimed muestra contador "N reclamadas"
2. **AC2**: Junto al contador hay un boton secundario "Liberar todas" (solo si N > 0)
3. **AC3**: Al hacer click en "Liberar todas", se muestra confirmacion: "Vas a liberar N tareas de {nombre}. Las tareas volveran al pool."
4. **AC4**: Al confirmar, todas las tareas claimed del usuario en ese proyecto pasan a `available`
5. **AC5**: Las tareas liberadas vuelven al pool inmediatamente
6. **AC6**: Se muestra feedback: "Se liberaron N tareas de {nombre}"
7. **AC7**: Si el API retorna `released_count = 0`, se muestra feedback informativo: "{nombre} no tiene tareas reclamadas"

### Seguridad

8. **AC8**: Solo el PM/Manager del proyecto puede ejecutar esta accion
9. **AC9**: Un usuario no puede ejecutar "Liberar todas" sobre si mismo (boton oculto)

### API

10. **AC10**: Nuevo endpoint: `POST /api/v1/projects/:project_id/members/:user_id/release-all-tasks`
11. **AC11**: El endpoint retorna `{ released_count: N, task_ids: [Int] }`
12. **AC12**: Si el usuario no tiene tareas claimed, retorna `{ released_count: 0, task_ids: [] }`
13. **AC13**: Errores: 403 (no autorizado), 400 (self-release), 404 (user/proyecto no existe). Payload con `code` y `message`.
    - Codes: `FORBIDDEN`, `SELF_RELEASE`, `NOT_FOUND`

### i18n

14. **AC14**: Labels en ES/EN para:
    - "Liberar todas" / "Release all"
    - "N reclamadas" / "N claimed"
    - Confirmacion (titulo + cuerpo)
    - Feedback success, info (0), error
    - Error self-release (copy exacto)
      - ES: "No puedes liberar tus propias tareas"
      - EN: "You cannot release your own tasks"

---

## UX Design

### Wireframe: Panel de Miembros (fila)

```
+-------------------------------------------------+
| MIEMBROS DEL PROYECTO                           |
+-------------------------------------------------+
| Alice Chen (PM)                                 |
|   2 tareas reclamadas                           |
|                                                 |
| Bob Agent (AI)                                  |
|   5 reclamadas  [Liberar todas]                 |
|                                                 |
| Carlos Dev                                      |
|   0 tareas reclamadas                           |
+-------------------------------------------------+
```

### Flujo de Confirmacion

```
[PM hace click en "Liberar todas" para Bob Agent]
              |
              v
+------------------------------------------+
| Confirmar liberacion                     |
|                                          |
| Vas a liberar 5 tareas de Bob Agent.     |
| Las tareas volveran al pool.             |
|                                          |
|         [Cancelar]  [Liberar]            |
+------------------------------------------+
              |
              v (si confirma)
+------------------------------------------+
| Se liberaron 5 tareas                    |
+------------------------------------------+
```

---

## UX Behavior Details

- **Visibilidad del boton**: solo si N > 0 y el miembro NO es el usuario actual.
- **Estado loading**: al confirmar, boton se deshabilita y muestra estado loading en esa fila.
- **Feedback**:
  - Success: "Se liberaron N tareas de {nombre}"
  - Info (0): "{nombre} no tiene tareas reclamadas"
  - Error: "No se pudieron liberar tareas de {nombre}"

## Technical Notes

### Backend

**Nuevo endpoint:**
```
POST /api/v1/projects/:project_id/members/:user_id/release-all-tasks
Authorization: PM del proyecto
Body: {} (no requiere payload)
Response: { released_count: Int, task_ids: [Int] }
Errors:
- 403 FORBIDDEN
- 400 SELF_RELEASE
- 404 NOT_FOUND
```

**Routing / Handler:**
- Ruta en `apps/server/src/scrumbringer_server/web/router.gleam`.
- Handler en `apps/server/src/scrumbringer_server/http/projects.gleam` (seccion members).

**Authorization (source of truth):**
- Usar `scrumbringer_server/http/authorization.require_project_manager_simple` para PM/Manager.
- Si `user_id` no es miembro del proyecto: responder `NOT_FOUND`.

**Response contract:**
- Respuesta unica: `{ released_count: Int, task_ids: [Int] }`
- Error format (api.error): `{ code: String, message: String }`

**Implementacion alineada con la base de codigo:**
- Reusar el flujo de release ya existente en `services/workflows/handlers.gleam` (ver `handle_release_task` y `tasks_queries.release_task`).
- Para bulk release, crear query en `persistence/tasks/queries.gleam` que:
  - Actualice en transaccion todas las tasks `status='claimed'` del usuario/proyecto.
  - Cierre work sessions igual que `release_task` (reusar `work_sessions_db.close_session_for_task`).
  - Inserte eventos `task_released` por cada task (reusar `task_events_db.insert`).
- Evitar sobreingenieria: no crear un nuevo workflow si no aporta reutilizacion real; preferir helper compartido si solo se usa aqui.

**SQL aproximado:**
```sql
UPDATE tasks
SET status = 'available',
    claimed_by = NULL,
    claimed_at = NULL,
    version = version + 1
WHERE project_id = $1
  AND claimed_by = $2
  AND status = 'claimed'
RETURNING *;
```

### Frontend

**Archivos a modificar:**
- `features/admin/members_view.gleam` - Añadir contador y boton
- `api/tasks.gleam` - Añadir `release_all_tasks(project_id, user_id)`
- `client_state.gleam` - Msg para release all
- `i18n/*.gleam` - Nuevos textos

**UI State:**
- El contador y el boton viven en la fila del miembro (zona de acciones secundarias).
- Si `released_count = 0`, no recargar lista, solo toast info.

**Client flow:**
- Msg en `client_state.gleam` que dispara la llamada.
- Update en `features/admin/update.gleam` con in-flight por user_id.
- On success: toast success/info y refresh de pool/miembros si `released_count > 0`.

**Datos para el contador (DRY):**
- El contador debe venir de backend.
- Ampliar `ProjectMember` en `shared/src/domain/project.gleam` con `claimed_count: Int`.
- Actualizar serializer en `apps/server/src/scrumbringer_server/http/projects.gleam` (`member_json`).
- Actualizar SQL en `apps/server/src/scrumbringer_server/sql.gleam` / `sql/project_members_list.sql` para incluir `claimed_count`.
- Actualizar decoder en `apps/client/src/scrumbringer_client/api/projects.gleam`.
- Nuevo campo en endpoint: `GET /api/v1/projects/:id/members` incluye `claimed_count`.

---

## Out of Scope

- Liberar tareas de multiples usuarios a la vez
- Seleccionar que tareas liberar (todo o nada)
- Notificar al usuario afectado

---

## Risk Assessment

- **Primary Risk:** Liberar tareas accidentalmente
- **Mitigation:** Confirmacion obligatoria con nombre del usuario y cantidad
- **Secondary Risk:** Conflictos de version si el usuario completa mientras se ejecuta
- **Mitigation:** El UPDATE con WHERE status='claimed' solo afecta las que siguen claimed

---

## Tasks / Subtasks

- [ ] **Task 1: Backend endpoint bulk release** (AC: 4, 10, 11, 12, 13)
  - [ ] 1.1 Añadir route en `web/router.gleam` y handler en `http/projects.gleam`.
  - [ ] 1.2 Query de bulk release en `persistence/tasks/queries.gleam` con transaccion.
  - [ ] 1.3 Insertar eventos `task_released` y cerrar work sessions por task.
  - [ ] 1.4 Respuesta con `released_count` + `task_ids`.

- [ ] **Task 2: Project members con claimed_count** (AC: 1)
  - [ ] 2.1 Extender `ProjectMember` con `claimed_count`.
  - [ ] 2.2 Actualizar `member_json` y decoder en client.

- [ ] **Task 3: UI members + confirm dialog** (AC: 1, 2, 3, 8, 9)
  - [ ] 3.1 Mostrar contador "N reclamadas" y boton solo si N>0 y no es self.
  - [ ] 3.2 Dialog de confirmacion con textos definidos.
  - [ ] 3.3 Estado loading por fila y deshabilitar accion.

- [ ] **Task 4: Client flow + feedback** (AC: 5, 6, 7)
  - [ ] 4.1 Msg + update para bulk release.
  - [ ] 4.2 Toast success/info/error segun `released_count` o error.
  - [ ] 4.3 Refresh miembros/pool si `released_count > 0`.

- [ ] **Task 5: i18n** (AC: 14)
  - [ ] 5.1 Agregar keys ES/EN para textos del flujo.

- [ ] **Task 6: Tests (TDD)**
  - [ ] 6.1 Unit query bulk release (version++, nulls, filtros).
  - [ ] 6.2 HTTP: 403/400/404/200 (N y 0).
  - [ ] 6.3 Integracion: eventos `task_released` + cierre work sessions.
  - [ ] 6.4 UI: boton visible/oculto, confirm, loading, toasts.

---

## Reuse / DRY

- Reusar la logica de release individual si existe (mover a helper compartido si aplica).
- Reusar patrones de toast y confirm dialog ya existentes en admin/members.

## TDD (Red/Green/Refactor)

- **Red**: tests de backend para bulk release y permisos antes de implementar.
- **Green**: implementar query y handler minimo hasta pasar tests.
- **Refactor**: extraer helper compartido con release individual si hay duplicacion real.

## Anti-sobreingenieria

- No crear capa nueva si un helper/local module basta.
- No duplicar payload completo de tareas si solo se requiere refrescar listas.
- Mantener la logica de permisos en un solo lugar (source of truth).

---

## Testing Strategy (TDD)

### Backend
- Unit test query: solo tasks claimed del usuario/proyecto, version++ y null de claimed_by/claimed_at.
- HTTP: 403 (no PM/Manager), 400 (self-release), 404 (user/proyecto), 200 (released_count N), 200 (released_count 0).
- Integracion: inserta eventos `task_released` y cierra work sessions.

### Frontend
- UI: boton oculto si N=0 o self; loading por fila; confirm modal copy.
- i18n: keys nuevas ES/EN.
