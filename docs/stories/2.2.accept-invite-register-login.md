# Story 2.2: Aceptar invite + registro + login (solo invitación)

## Status: Done

## Story
**As a** newly invited user,
**I want** to open an invite link, set my password, and start using the app,
**so that** onboarding is self-serve and does not require sharing raw invite tokens.

## Acceptance Criteria
1. **Validate invite token (public)**: `GET /api/v1/auth/invite-links/:token` validates an invite-link token and returns `200` `{ data: { email } }` when valid and active.
2. **Reject invalid/used tokens**: `GET /api/v1/auth/invite-links/:token` rejects invalid/used/invalidated tokens with `403` using a consistent error code:
   - `INVITE_INVALID` when token unknown/invalidated,
   - `INVITE_USED` when token already consumed.
3. **Invite-only registration via token**: After bootstrap, `POST /api/v1/auth/register` supports registration using an invite-link token:
   - Body: `{ password, invite_token }`.
   - The server derives the `email` from the invite token; the client does not edit it.
   - Missing `invite_token` (post-bootstrap) returns `403` `INVITE_REQUIRED`.
   - Invalid/used token returns `403` with `INVITE_INVALID`/`INVITE_USED`.
4. **Consume token on successful registration**: A successful registration with `invite_token` marks that token as used (single-use).
5. **Successful register logs in**: A successful registration sets `sb_session` (HttpOnly) and `sb_csrf` cookies and returns `200` `{ data: { user } }`.
6. **Accept-invite UI exists**: Client has an “Accept invite” screen reachable by URL that:
   - reads `token` from the URL,
   - calls `GET /api/v1/auth/invite-links/:token`,
   - shows the resolved `email` as read-only,
   - lets the user set a password and submit registration.
7. **Accept-invite UX states**:
   - loading state while validating token,
   - invalid/used token shows a clear error state (no crash),
   - password validation errors are shown inline,
   - successful registration transitions into the authenticated app experience.
8. **Login remains available**: `POST /api/v1/auth/login` continues to work for existing users (invite requirement is for registration only).
9. **Password policy (minimum)**: Password must be at least 12 characters.
10. **No SMTP/email integration**: Invite acceptance and registration rely only on the token in the URL; no emails are sent.

## Tasks / Subtasks
- [x] Add/extend API contract entries for invite-link acceptance (AC: 1, 2, 3, 5)
  - [x] Document `GET /api/v1/auth/invite-links/:token` and the `invite_token` register variant in `docs/architecture/api-contract.md` (AC: 1, 3)
- [x] Implement `GET /api/v1/auth/invite-links/:token` (AC: 1, 2)
  - [x] Look up invite-link token and return its bound email when active (AC: 1)
  - [x] Return `403 INVITE_INVALID` for unknown/invalidated (AC: 2)
  - [x] Return `403 INVITE_USED` for used tokens (AC: 2)
- [x] Extend registration to accept `invite_token` (AC: 3, 4, 5)
   - [x] Enforce post-bootstrap invite-only registration using `invite_token` only (no legacy interfaces) (AC: 3)

  - [x] Mark invite-link token as used as part of successful registration transaction (AC: 4)
  - [x] Preserve cookie behaviors per API contract (AC: 5)
- [x] Implement Accept-invite UI (AC: 6, 7)
  - [x] Add a new client route/page for accept-invite (URL includes `token`) (AC: 6)
  - [x] Implement token validation request + decoding (AC: 1, 6)
   - [x] Implement password form + submit to `POST /api/v1/auth/register` with `{ password, invite_token }` (AC: 3, 6)
  - [x] Handle error codes `INVITE_INVALID`, `INVITE_USED`, `INVITE_REQUIRED` with clear UI messaging (AC: 2, 7)
- [x] Add tests (AC: 1, 2, 3, 4, 6)
  - [x] Server: token validation endpoint returns expected success/error codes (AC: 1, 2)
  - [x] Server: registration consumes token and cannot reuse it (AC: 4)
  - [x] Client: accept-invite state machine (loading → ready → success/error) (AC: 6, 7)

- [x] Apply QA fixes from gate CONCERNS (SEC-001, TEST-001)
  - [x] Add best-effort rate limiting for invite token endpoints (SEC-001)
  - [x] Add server test for short password rejection (>=12) (TEST-001)

## Dev Notes
### Source of truth
- Invite-only registration rules + error code vocabulary: `docs/architecture/api-contract.md` (see “Bootstrap rules (MVP)”, “Auth”, and “Error Codes (Minimum Set)”).
- Product constraints: single org, onboarding via invites: `docs/brief.md` (see “Scope Organizacional (MVP)” and “MVP Scope v1.0 → Auth”).

### Suggested endpoints (new/extended)
- New: `GET /api/v1/auth/invite-links/:token`
- Extended: `POST /api/v1/auth/register` supports `{ email, password, invite_token }` (post-bootstrap)

### Cookie + CSRF reminders
- Successful auth must set cookies:
  - `sb_session` (JWT): `HttpOnly; Secure; SameSite=Strict; Path=/`
  - `sb_csrf`: not HttpOnly; `Secure; SameSite=Strict; Path=/`
  [Source: `docs/architecture/api-contract.md` “Cookies”]

## Testing
- Server: `make test`
- Client: `apps/client: gleam test`

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-14 | 1.0 | Initial draft | po |
| 2026-01-14 | 1.1 | Ready for dev (DoR passed; email derived from token; password min 12) | po |
| 2026-01-14 | 1.2 | Implement invite-link validation + invite-only registration + accept-invite UI | dev |
| 2026-01-14 | 1.3 | Apply QA fixes: rate limiting + password min-length server test | dev |

## Dev Agent Record

### Agent Model Used
- GPT-5.2

### Debug Log References
- `make migrate`
- `make test`
- `apps/client: gleam test`
- `make test` (QA fixes)

### Completion Notes
- Implemented public invite-link validation endpoint and consistent `INVITE_INVALID`/`INVITE_USED` errors.
- Switched post-bootstrap registration to invite-link tokens (`invite_token`), derived email server-side, enforced minimum password length (12), and consumed tokens transactionally.
- Added client `/accept-invite?token=...` screen with loading/ready/error/success states and wired it to the new API.
- Added best-effort rate limiting for invite token endpoints when `X-Forwarded-For`/`X-Real-Ip` is present.
- Added server integration test asserting short passwords are rejected with `422 VALIDATION_ERROR`.

### File List
- Modified: `apps/server/src/scrumbringer_server.gleam`
- Modified: `apps/server/src/scrumbringer_server/http/auth.gleam`
- Modified: `apps/server/src/scrumbringer_server/services/auth_db.gleam`
- Modified: `apps/server/src/scrumbringer_server/services/org_invite_links_db.gleam`
- Modified: `apps/server/test/auth_http_test.gleam`
- Modified: `apps/server/test/capabilities_http_test.gleam`
- Modified: `apps/server/test/notes_and_positions_http_test.gleam`
- Modified: `apps/server/test/org_invite_links_http_test.gleam`
- Modified: `apps/server/test/org_invites_http_test.gleam`
- Modified: `apps/server/test/org_users_http_test.gleam`
- Modified: `apps/server/test/projects_http_test.gleam`
- Modified: `apps/server/test/tasks_http_test.gleam`
- Modified: `apps/server/src/scrumbringer_server_ffi.erl`
- Added: `apps/server/src/scrumbringer_server/services/rate_limit.gleam`
- Modified: `apps/client/src/scrumbringer_client.gleam`
- Modified: `apps/client/src/scrumbringer_client/api.gleam`
- Modified: `apps/client/src/scrumbringer_client/client_ffi.gleam`
- Modified: `docs/architecture/api-contract.md`
- Added: `apps/client/src/scrumbringer_client/accept_invite.gleam`
- Added: `apps/client/test/accept_invite_test.gleam`

## QA Results

### Review Date: 2026-01-14

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

- Implementación alineada con el contrato: validación pública de invite-link + registro invite-only con `invite_token` y email derivado server-side.
- Separación razonable de responsabilidades: DB/service logic en server y state machine aislada en client.

### Refactoring Performed

- Ninguno (solo revisión). Código y tests ya pasan.

### Compliance Check

- Coding Standards: ✓ (convenciones Gleam + manejo de errores consistente)
- Project Structure: ✓ (módulo cliente agregado en `apps/client/src/scrumbringer_client/`)
- Testing Strategy: ✓ (tests server + unit tests de state machine en client)
- All ACs Met: ✓ con CONCERNS (ver checklist)

### Improvements Checklist

- [ ] Añadir rate limiting / abuse controls a endpoints basados en token (`GET /api/v1/auth/invite-links/:token`, `POST /api/v1/auth/register`)
- [ ] Añadir test server-side explícito para password corto (>=12) → `422 VALIDATION_ERROR`
- [x] Tests de happy path + errores para validación de token
- [x] Tests de consumo single-use del token
- [x] Tests de state machine del flujo accept-invite en client

### Security Review

- CONCERNS: endpoints basados en token sin throttling pueden ser objetivo de brute force/enumeration.
- Mitigación sugerida: rate limiting + logging/alerting por IP / ventana temporal.

### Performance Considerations

- PASS: operaciones de DB simples (lookup + update), esperado OK para MVP.

### Files Modified During Review

- Ninguno.

### Gate Status

Gate: CONCERNS → `docs/qa/gates/2.2-aceptar-invite-registro-login-solo-invitacion.yml`
Risk profile: `docs/qa/assessments/2.2-risk-20260114.md`
NFR assessment: `docs/qa/assessments/2.2-nfr-20260114.md`
Trace matrix: `docs/qa/assessments/2.2-trace-20260114.md`

### Recommended Status

[✗ Changes Required - See unchecked items above]
(Story owner decides final status)

---

### Review Date: 2026-01-14 (Post-fixes)

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

- Se aplicaron los fixes del gate anterior: rate limiting best-effort + test server-side para password corto.
- La solución de rate limiting es pragmática para MVP (in-memory) y reduce riesgo de brute force/enumeration.

### Refactoring Performed

- Ninguno.

### Compliance Check

- Coding Standards: ✓
- Project Structure: ✓
- Testing Strategy: ✓
- All ACs Met: ✓

### Improvements Checklist

- [x] Añadir rate limiting / abuse controls a endpoints basados en token (`GET /api/v1/auth/invite-links/:token`, `POST /api/v1/auth/register`)
- [x] Añadir test server-side explícito para password corto (>=12) → `422 VALIDATION_ERROR`

### Security Review

- PASS (MVP): rate limiting aplicado; recomendado añadir logging/alerting más adelante.

### Performance Considerations

- PASS: rate limiting en ETS + DB queries simples.

### Files Modified During Review

- Ninguno (solo verificación).

### Gate Status

Gate: PASS → `docs/qa/gates/2.2-aceptar-invite-registro-login-solo-invitacion.yml`
Risk profile: `docs/qa/assessments/2.2-risk-20260114.md`
NFR assessment: `docs/qa/assessments/2.2-nfr-20260114.md`
Trace matrix: `docs/qa/assessments/2.2-trace-20260114.md`

### Recommended Status

[✓ Ready for Done]
(Story owner decides final status)
