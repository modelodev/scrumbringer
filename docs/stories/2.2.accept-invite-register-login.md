# Story 2.2: Aceptar invite + registro + login (solo invitación)

## Status: Draft

## Story
**As a** newly invited user,
**I want** to open an invite link, set my password, and start using the app,
**so that** onboarding is self-serve and does not require sharing raw invite codes.

## Acceptance Criteria
1. **Validate invite token (public)**: `GET /api/v1/auth/invite-links/:token` validates an invite-link token and returns `200` `{ data: { email } }` when valid and active.
2. **Reject invalid/used tokens**: `GET /api/v1/auth/invite-links/:token` rejects invalid/used/invalidated tokens with `403` using a consistent error code:
   - `INVITE_INVALID` when token unknown/invalidated,
   - `INVITE_USED` when token already consumed.
3. **Invite-only registration via token**: After bootstrap, `POST /api/v1/auth/register` supports registration using an invite-link token:
   - Body: `{ email, password, invite_token }`.
   - Missing `invite_token` (post-bootstrap) returns `403` `INVITE_REQUIRED`.
   - Invalid/used token returns `403` with `INVITE_INVALID`/`INVITE_USED`.
4. **Consume token on successful registration**: A successful registration with `invite_token` marks that token as used (single-use).
5. **Successful register logs in**: A successful registration sets `sb_session` (HttpOnly) and `sb_csrf` cookies and returns `200` `{ data: { user } }`.
6. **Accept-invite UI exists**: Client has an “Accept invite” screen reachable by URL that:
   - reads `token` from the URL,
   - calls `GET /api/v1/auth/invite-links/:token`,
   - shows the resolved `email` as read-only,
   - lets the user set a password and submit registration.
7. **Accept-invite UX states**:
   - loading state while validating token,
   - invalid/used token shows a clear error state (no crash),
   - successful registration transitions into the authenticated app experience.
8. **Login remains available**: `POST /api/v1/auth/login` continues to work for existing users (invite requirement is for registration only).
9. **No SMTP/email integration**: Invite acceptance and registration rely only on the token in the URL; no emails are sent.

## Tasks / Subtasks
- [ ] Add/extend API contract entries for invite-link acceptance (AC: 1, 2, 3, 5)
  - [ ] Document `GET /api/v1/auth/invite-links/:token` and the `invite_token` register variant in `docs/architecture/api-contract.md` (AC: 1, 3)
- [ ] Implement `GET /api/v1/auth/invite-links/:token` (AC: 1, 2)
  - [ ] Look up invite-link token and return its bound email when active (AC: 1)
  - [ ] Return `403 INVITE_INVALID` for unknown/invalidated (AC: 2)
  - [ ] Return `403 INVITE_USED` for used tokens (AC: 2)
- [ ] Extend registration to accept `invite_token` (AC: 3, 4, 5)
  - [ ] Enforce post-bootstrap invite-only registration (existing behavior) and allow either `invite_code` or `invite_token` (backward compatible) (AC: 3)
  - [ ] Mark invite-link token as used as part of successful registration transaction (AC: 4)
  - [ ] Preserve cookie behaviors per API contract (AC: 5)
- [ ] Implement Accept-invite UI (AC: 6, 7)
  - [ ] Add a new client route/page for accept-invite (URL includes `token`) (AC: 6)
  - [ ] Implement token validation request + decoding (AC: 1, 6)
  - [ ] Implement password form + submit to `POST /api/v1/auth/register` with `{ email, password, invite_token }` (AC: 3, 6)
  - [ ] Handle error codes `INVITE_INVALID`, `INVITE_USED`, `INVITE_REQUIRED` with clear UI messaging (AC: 2, 7)
- [ ] Add tests (AC: 1, 2, 3, 4, 6)
  - [ ] Server: token validation endpoint returns expected success/error codes (AC: 1, 2)
  - [ ] Server: registration consumes token and cannot reuse it (AC: 4)
  - [ ] Client: accept-invite state machine (loading → ready → success/error) (AC: 6, 7)

## Dev Notes
### Source of truth
- Invite-only registration rules + error code vocabulary: `docs/architecture/api-contract.md` (see “Bootstrap rules (MVP)”, “Auth”, and “Error Codes (Minimum Set)”).
- Product constraints: single org, onboarding via invites: `docs/brief.md` (see “Scope Organizacional (MVP)” and “MVP Scope v1.0 → Auth”).

### Suggested endpoints (new/extended)
- New: `GET /api/v1/auth/invite-links/:token`
- Extended: `POST /api/v1/auth/register` supports `{ email, password, invite_token }` (post-bootstrap)

### Cookie + CSRF reminders
- Successful auth must set cookies:
  - `sb_session` (JWT): `HttpOnly; Secure; SameSite=Strict; Path=/`
  - `sb_csrf`: not HttpOnly; `Secure; SameSite=Strict; Path=/`
  [Source: `docs/architecture/api-contract.md` “Cookies”]

## Testing
- Server: `make test`
- Client: `apps/client: gleam test`

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-14 | 1.0 | Initial draft | po |

## Dev Agent Record

## QA Results
