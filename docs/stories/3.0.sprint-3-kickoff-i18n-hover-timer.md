# Story 3.0 (Sprint 3 kickoff): i18n (ES/EN) + hover popover en Pool + cronómetro acumulado

## Status: Draft

## Story
**As a** user,
**I want** to use Scrumbringer in Spanish or English and get clear, accessible hover details in the Pool,
**so that** I can work comfortably in my preferred language and understand tasks quickly.

## Context
- Esta historia debe ser la **primera** en ejecutarse en el Sprint 3.
- Queremos profesionalizar i18n (sin “stringly-typed keys” desperdigadas) con un enfoque idiomático en Gleam.
- El hover preview actual del Pool se ve “debuggy” y no aparece en `:focus-within`.
- Bug reportado: en “Now Working”, el cronómetro **reinicia** al pausar y reanudar la misma tarea; queremos que el tiempo sea **acumulado** (por usuario + tarea) en pausas/reanudaciones.

## Acceptance Criteria
1. **i18n base (ES/EN) sin ensuciar el código**
   - La app soporta al menos `es` y `en`.
   - El idioma por defecto se detecta por navegador (e.g., `navigator.language`) y se persiste en local storage para sesiones futuras.
   - La implementación evita claves string sueltas en el código; se usa un enfoque tipado (ADT/enum) para garantizar cobertura.

2. **Cobertura de traducción: toda la UI actual**
   - Todos los textos user-facing existentes quedan traducidos (ES/EN), incluyendo:
     - Member UI: Pool, My Bar, My Skills, Now Working.
     - Admin UI: Projects/Members/Capabilities/Task Types/Metrics/Org settings.
     - Login / Accept invite / Reset password.
   - Labels y textos de accesibilidad (`aria-label`, `alt`, tooltips visibles) también se traducen.

3. **Pool: hover popover limpio con flecha (propuesta 1C)**
   - En modo canvas, el hover de una task card muestra un popover con:
     - Fondo, borde, padding y sombra acorde al sistema visual.
     - Una flecha discreta que conecte el popover con la card.
   - El popover aparece tanto en `:hover` como en `:focus-within` (teclado).
   - El contenido del popover es humano y traducible (ES/EN). Ejemplo ES:
     - `Tipo: Bug`
     - `Creada: hace 1 día`
     - `Estado: Disponible`

4. **Now Working: cronómetro acumulado por tarea**
   - Si el usuario hace `Start` sobre una tarea, deja correr 1 minuto, hace `Pause`, y luego vuelve a `Start` la misma tarea:
     - El cronómetro continúa desde el tiempo previamente acumulado (no reinicia a 0).
   - El acumulado es personal (por usuario) y no afecta al estado global del Pool.
   - Si el usuario cambia de tarea activa, el tiempo acumulado se registra correctamente para la tarea previa.

5. **Tests / Validación**
   - Se añaden pruebas de unidad para:
     - Resolución de locale (browser language) + persistencia.
     - Traducciones: al menos un set de “smoke tests” que cubran que `t(Es, …)` y `t(En, …)` devuelven strings no vacíos para un subconjunto representativo.
     - Cronómetro acumulado: server-side y/o client-side decode/logic (mínimo) cubriendo pause/resume.
   - Se actualiza Playwright para capturar evidencia del popover en hover y focus.

## Tasks / Subtasks
- [ ] Task 1: Añadir infraestructura i18n tipada (AC: 1)
  - [ ] Crear módulos `i18n` (Locale + Text + t)
  - [ ] Detección inicial por navegador y persistencia en local storage
  - [ ] Añadir estado de `locale` al modelo del cliente

- [ ] Task 2: Migrar toda la UI actual a i18n (AC: 2)
  - [ ] Sustituir literales por `i18n.t(locale, ...)` en todas las pantallas
  - [ ] Traducir labels de accesibilidad (`aria-label`, `alt`, tooltips)
  - [ ] Verificar que no quedan strings user-facing “hardcoded” fuera de i18n

- [ ] Task 3: Rediseñar hover preview como popover con flecha (AC: 3)
  - [ ] Ajustar markup/CSS del popover para que sea una mini tarjeta (fondo/borde/sombra)
  - [ ] Añadir flecha (pseudo-element)
  - [ ] Mostrar en `:hover` y `:focus-within`
  - [ ] Humanizar contenido (Tipo/Creada/Estado) a través de i18n

- [ ] Task 4: Fix Now Working timer: acumulado pausa/reanuda (AC: 4)
  - [ ] Definir modelo de persistencia del acumulado (por usuario+task)
  - [ ] Actualizar endpoints start/pause para actualizar y devolver el acumulado
  - [ ] Actualizar UI/cliente para mostrar `elapsed_total = accumulated + (as_of - started_at)`
  - [ ] Mantener compatibilidad con release/complete (limpiar estado personal correctamente)

- [ ] Task 5: Tests y evidencia (AC: 5)
  - [ ] Unit tests i18n (locale parsing + samples)
  - [ ] Server tests timer acumulado (pause/resume)
  - [ ] Client tests decode/elapsed logic (si aplica)
  - [ ] Playwright: screenshots de hover + focus popover

## Dev Notes
### i18n (enfoque recomendado)
- Implementar i18n tipado con:
  - `Locale` (Es/En)
  - `Text` (ADT de claves + variantes parametrizadas)
  - `t(locale, text) -> String` con pattern matching
- Organización sugerida:
  - `apps/client/src/scrumbringer_client/i18n/locale.gleam`
  - `apps/client/src/scrumbringer_client/i18n/text.gleam`
  - `apps/client/src/scrumbringer_client/i18n/es.gleam`
  - `apps/client/src/scrumbringer_client/i18n/en.gleam`
  - `apps/client/src/scrumbringer_client/i18n/i18n.gleam`

### Hover popover
- Reusar `.task-card-preview` pero convertirlo en popover real:
  - posicionamiento absoluto respecto a `.task-card`
  - `pointer-events: none` para evitar flicker
  - flecha con `::before` (triángulo) o pseudo-element rotado

### Now Working timer acumulado
- Actualmente (Story 2.8) se calcula por sesión activa: `as_of - started_at`.
- Ajuste requerido: acumular tiempo por usuario+tarea para no reiniciar tras `pause`.
- Implementación mínima sugerida:
  - Guardar `accumulated_ms` por `(user_id, task_id)` en DB (tabla dedicada o extensión de modelo existente) y actualizarla al pausar/cambiar.
  - Al start, devolver `accumulated_ms` + `started_at`.
  - En el cliente, renderizar `elapsed = accumulated_ms + (as_of - started_at)`.

## Testing
- Server: `make test` / `make verify`
- Client: `cd apps/client && gleam test`
- Visual: `npx playwright test tests/2.9-pool-visual-sweep.spec.ts --project=chromium`

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-15 | 0.1 | Draft story for Sprint 3 kickoff | po/dev |

## Dev Agent Record

### Agent Model Used
- _TBD_

### Debug Log References
- _TBD_

### Completion Notes List
- _TBD_

### File List
- _TBD_

## QA Results
- _TBD_