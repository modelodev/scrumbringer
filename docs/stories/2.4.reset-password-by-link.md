# Story 2.4: Reset password por link (sin email real)

## Status: Ready for Review

## Story
**As a** user who forgot my password,
**I want** to generate a reset-password link and set a new password via that link,
**so that** I can regain access without requiring real email integration in MVP.

## Acceptance Criteria
1. **Request reset token (public)**: `POST /api/v1/auth/password-resets` generates a reset token for an email.
   - Body: `{ email }`.
   - Response: `200` `{ data: { reset: { token, url_path } } }`.
   - `url_path` is a relative path (no scheme/host) suitable for client-side composition (e.g. `/reset-password?token=...`).
2. **Single active token per email**: generating a new reset token for an `email` invalidates any previous active reset token for that `email`.
3. **Tokens are single-use**: a reset token can be consumed exactly once.
4. **Validate reset token (public)**: `GET /api/v1/auth/password-resets/:token` returns `200` `{ data: { email } }` when token is active.
5. **Consume reset token (public)**: `POST /api/v1/auth/password-resets/consume` updates the user’s password.
   - Body: `{ token, password }`.
   - On success: `204` and the token becomes used.
6. **Unknown email does not leak**: `POST /api/v1/auth/password-resets` does not reveal whether an email exists (still returns `200`). Tokens generated for unknown emails are not persisted and must be rejected by validate/consume as `RESET_TOKEN_INVALID`.
7. **Token TTL**: Reset tokens expire after 24 hours.

8. **Error codes are consistent**: invalid/used/expired tokens are rejected with a stable error code:
   - `RESET_TOKEN_INVALID` (403)
   - `RESET_TOKEN_USED` (403)
9. **Password policy (minimum)**: Password must be at least 12 characters.
10. **Client UX**:
   - Login screen provides a “Forgot password?” flow to request a reset link.
   - Client provides a reset-password screen reachable by URL (`/reset-password?token=...`) that validates token and submits new password.
11. **No SMTP/email integration**: the reset link is shown directly in the UI for copy/paste; server sends no emails.

## Tasks / Subtasks
- [x] Add API contract entries for password reset flow (AC: 1, 4, 5, 7)
  - [x] Document endpoints and suggested error codes in `docs/architecture/api-contract.md` (AC: 7)
- [x] Implement persistence for password reset tokens (AC: 2, 3, 6)
  - [x] Store `email`, `token`, `created_at`, `used_at?`, `invalidated_at?` (AC: 2, 3)
  - [x] Ensure “single active token per email” behavior at write-time (AC: 2)
- [x] Implement `POST /api/v1/auth/password-resets` (AC: 1, 2, 6)
  - [x] Always respond `200` (avoid existence leak) (AC: 6)
  - [x] If user exists, create new active token and invalidate previous (AC: 2)
  - [x] If user does not exist, still return `200` with a token that cannot be used (implementation choice: don’t persist) (AC: 6)
- [x] Implement `GET /api/v1/auth/password-resets/:token` (AC: 4, 7)
- [x] Implement `POST /api/v1/auth/password-resets/consume` (AC: 3, 5, 7)
  - [x] Validate token active and associated user exists; update password hash; mark token used (AC: 3, 5)
- [x] Implement client flow (AC: 8, 9)
   - [x] Add “Forgot password?” dialog/screen on Login (request by email; show returned reset link, constructed from `url_path`, with copy) (AC: 8, 9)
  - [x] Add Reset Password screen that:
    - [x] reads `token` from URL,
    - [x] validates via `GET /api/v1/auth/password-resets/:token`,
    - [x] submits new password to consume endpoint,
    - [x] shows success and routes back to Login.
- [x] Add tests (AC: 2, 3, 5, 6)
  - [x] Server: token invalidation on regenerate for same email (AC: 2)
  - [x] Server: single-use enforcement (AC: 3)
  - [x] Server: request does not leak existence (AC: 6)
  - [x] Client: reset flow state machine (loading/invalid/success) (AC: 8)

## Dev Notes
### Source of truth
- Auth conventions (cookies, error envelope) and error-code style: `docs/architecture/api-contract.md` (see “Conventions”, “Response Envelope”, “Error Codes (Minimum Set)”).
- Product constraint: no integrations required in MVP: `docs/brief.md` (see “OUT (Later) → Integraciones”).

### Suggested endpoints (new)
- `POST /api/v1/auth/password-resets`
- `GET /api/v1/auth/password-resets/:token`
- `POST /api/v1/auth/password-resets/consume`

## Testing
- Server: `make test`
- Client: `apps/client: gleam test`

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-14 | 1.0 | Initial draft | po |
| 2026-01-14 | 1.1 | Ready for dev (DoR passed; TTL 24h; min password 12; unknown email no-leak clarified) | po |
| 2026-01-14 | 1.2 | Implement reset password by link flow | dev |

## Dev Agent Record

### Agent Model Used
- GPT-5.2

### Debug Log References
- `make migrate`
- `make test`
- `apps/client: gleam test`

### Completion Notes
- Added password reset persistence (`password_resets` table + single-active-per-email unique index).
- Implemented public endpoints to request/validate/consume reset tokens with 24h TTL and stable error codes (`RESET_TOKEN_INVALID`, `RESET_TOKEN_USED`).
- Implemented client “Forgot password?” flow that returns a copyable link (no SMTP) and `/reset-password?token=...` screen to set a new password.
- Added server + client tests for invalidation, single-use, non-leak, and expired token behavior.

### File List
- Modified: `apps/client/src/scrumbringer_client.gleam`
- Modified: `apps/client/src/scrumbringer_client/api.gleam`
- Added: `apps/client/src/scrumbringer_client/reset_password.gleam`
- Added: `apps/client/test/reset_password_test.gleam`
- Modified: `apps/server/src/scrumbringer_server.gleam`
- Added: `apps/server/src/scrumbringer_server/http/password_resets.gleam`
- Added: `apps/server/src/scrumbringer_server/services/password_resets_db.gleam`
- Added: `apps/server/test/password_resets_http_test.gleam`
- Added: `db/migrations/20260114120000_create_password_resets.sql`
- Modified: `docs/architecture/api-contract.md`
- Modified: `docs/stories/2.4.reset-password-by-link.md`

## QA Results

### Review Date: 2026-01-14

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

- Implementación consistente con el contrato (`data`/`error` envelope) y con el patrón usado en invite-links (token opaco + `url_path`).
- Buenas garantías de integridad: single-active-token por email (índice parcial), single-use (`used_at`), invalidación al regenerar, TTL 24h.

### Refactoring Performed

- Ninguno.

### Compliance Check

- Coding Standards: ✓
- Project Structure: ✓
- Testing Strategy: ⚠️ (ver gaps)
- All ACs Met: ✓ (con notas)

### Improvements Checklist

- [x] Tests server para invalidación, single-use, no-leak, y expiración (TTL)
- [x] Tests client para state machine de reset password
- [ ] Añadir rate limiting a endpoints públicos de password reset (request + consume) para mitigar abuso/enumeración
- [ ] Añadir test server-side explícito para password < 12 en `/auth/password-resets/consume`

### Security Review

- CONCERNS: endpoints públicos sin rate limiting; además, request→validate puede usarse para enumeración (PO/Dev a decidir mitigación).

### Performance Considerations

- PASS: operaciones simples, indexadas y transacciones cortas.

### Files Modified During Review

- Ninguno.

### Gate Status

Gate: CONCERNS → `docs/qa/gates/2.4-reset-password-por-link-sin-email-real.yml`
Risk profile: `docs/qa/assessments/2.4-risk-20260114.md`
NFR assessment: `docs/qa/assessments/2.4-nfr-20260114.md`
Trace matrix: `docs/qa/assessments/2.4-trace-20260114.md`

### Recommended Status

[✗ Changes Required - See unchecked items above]
(Story owner decides final status)
