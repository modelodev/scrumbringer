# Story 2.4: Reset password por link (sin email real)

## Status: Ready

## Story
**As a** user who forgot my password,
**I want** to generate a reset-password link and set a new password via that link,
**so that** I can regain access without requiring real email integration in MVP.

## Acceptance Criteria
1. **Request reset token (public)**: `POST /api/v1/auth/password-resets` generates a reset token for an email.
   - Body: `{ email }`.
   - Response: `200` `{ data: { reset: { token, url_path } } }`.
   - `url_path` is a relative path (no scheme/host) suitable for client-side composition (e.g. `/reset-password?token=...`).
2. **Single active token per email**: generating a new reset token for an `email` invalidates any previous active reset token for that `email`.
3. **Tokens are single-use**: a reset token can be consumed exactly once.
4. **Validate reset token (public)**: `GET /api/v1/auth/password-resets/:token` returns `200` `{ data: { email } }` when token is active.
5. **Consume reset token (public)**: `POST /api/v1/auth/password-resets/consume` updates the user’s password.
   - Body: `{ token, password }`.
   - On success: `204` and the token becomes used.
6. **Unknown email does not leak**: `POST /api/v1/auth/password-resets` does not reveal whether an email exists (still returns `200`). Tokens generated for unknown emails are not persisted and must be rejected by validate/consume as `RESET_TOKEN_INVALID`.
7. **Token TTL**: Reset tokens expire after 24 hours.

8. **Error codes are consistent**: invalid/used/expired tokens are rejected with a stable error code:
   - `RESET_TOKEN_INVALID` (403)
   - `RESET_TOKEN_USED` (403)
9. **Password policy (minimum)**: Password must be at least 12 characters.
10. **Client UX**:
   - Login screen provides a “Forgot password?” flow to request a reset link.
   - Client provides a reset-password screen reachable by URL (`/reset-password?token=...`) that validates token and submits new password.
11. **No SMTP/email integration**: the reset link is shown directly in the UI for copy/paste; server sends no emails.

## Tasks / Subtasks
- [ ] Add API contract entries for password reset flow (AC: 1, 4, 5, 7)
  - [ ] Document endpoints and suggested error codes in `docs/architecture/api-contract.md` (AC: 7)
- [ ] Implement persistence for password reset tokens (AC: 2, 3, 6)
  - [ ] Store `email`, `token`, `created_at`, `used_at?`, `invalidated_at?` (AC: 2, 3)
  - [ ] Ensure “single active token per email” behavior at write-time (AC: 2)
- [ ] Implement `POST /api/v1/auth/password-resets` (AC: 1, 2, 6)
  - [ ] Always respond `200` (avoid existence leak) (AC: 6)
  - [ ] If user exists, create new active token and invalidate previous (AC: 2)
  - [ ] If user does not exist, still return `200` with a token that cannot be used (implementation choice: don’t persist) (AC: 6)
- [ ] Implement `GET /api/v1/auth/password-resets/:token` (AC: 4, 7)
- [ ] Implement `POST /api/v1/auth/password-resets/consume` (AC: 3, 5, 7)
  - [ ] Validate token active and associated user exists; update password hash; mark token used (AC: 3, 5)
- [ ] Implement client flow (AC: 8, 9)
   - [ ] Add “Forgot password?” dialog/screen on Login (request by email; show returned reset link, constructed from `url_path`, with copy) (AC: 8, 9)
  - [ ] Add Reset Password screen that:
    - [ ] reads `token` from URL,
    - [ ] validates via `GET /api/v1/auth/password-resets/:token`,
    - [ ] submits new password to consume endpoint,
    - [ ] shows success and routes back to Login.
- [ ] Add tests (AC: 2, 3, 5, 6)
  - [ ] Server: token invalidation on regenerate for same email (AC: 2)
  - [ ] Server: single-use enforcement (AC: 3)
  - [ ] Server: request does not leak existence (AC: 6)
  - [ ] Client: reset flow state machine (loading/invalid/success) (AC: 8)

## Dev Notes
### Source of truth
- Auth conventions (cookies, error envelope) and error-code style: `docs/architecture/api-contract.md` (see “Conventions”, “Response Envelope”, “Error Codes (Minimum Set)”).
- Product constraint: no integrations required in MVP: `docs/brief.md` (see “OUT (Later) → Integraciones”).

### Suggested endpoints (new)
- `POST /api/v1/auth/password-resets`
- `GET /api/v1/auth/password-resets/:token`
- `POST /api/v1/auth/password-resets/consume`

## Testing
- Server: `make test`
- Client: `apps/client: gleam test`

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-14 | 1.0 | Initial draft | po |
| 2026-01-14 | 1.1 | Ready for dev (DoR passed; TTL 24h; min password 12; unknown email no-leak clarified) | po |

## Dev Agent Record

## QA Results
