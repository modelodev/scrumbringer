# Story 4.4: IA Redesign - Layout de 3 Paneles

## Status

Draft

## Story

**As a** usuario de Scrumbringer (Member, PM, u Org Admin),
**I want** una interfaz reorganizada con layout de 3 paneles y navegación unificada,
**so that** puedo trabajar de forma más eficiente con menos clics, vistas claras por propósito, y navegación que persiste con F5.

## Prerequisites

- **Story 4.1** (Permissions Refactor) - DONE
- **Story 4.2** (Project Manager UX) - DONE
- **Story 4.3** (Org Users UX) - DONE

## Reference Document

> **IMPORTANTE:** Esta historia implementa el spec completo definido en:
>
> **`docs/front-end-spec-4.4-ia-redesign.md`** (v1.6)
>
> El spec contiene wireframes, user flows, componentes, responsive strategy, URL strategy, accesibilidad, y validación E2E. El desarrollador DEBE leer el spec completo antes de implementar.

---

## Acceptance Criteria

### Layout y Estructura

1. **AC1**: Layout de 3 paneles visible en desktop (izquierda: navegación, centro: contenido, derecha: mi actividad)
2. **AC2**: Header global eliminado - contenido absorbido en los paneles laterales
3. **AC3**: Vistas `/app/bar` y `/app/skills` eliminadas (rutas redirigen a `/app`)

### Modos de Vista

4. **AC4**: Toggle de 3 modos de vista visible: Pool, Lista, Fichas
5. **AC5**: Modo Pool muestra canvas de tareas disponibles (funcionalidad existente)
6. **AC6**: Modo Lista muestra tareas agrupadas por ficha con secciones colapsables
7. **AC7**: Modo Fichas muestra kanban de fichas (Pendiente → En Curso → Cerrada)

### URL Strategy (F5 Persistence)

8. **AC8**: Cambiar proyecto actualiza URL con `?project=ID`
9. **AC9**: Cambiar modo de vista actualiza URL con `&view=pool|list|cards`
10. **AC10**: Aplicar filtros actualiza URL con `&type=ID&cap=ID&search=TERM`
11. **AC11**: F5 restaura estado completo (proyecto, vista, filtros)
12. **AC12**: Deep links compartibles funcionan para usuarios con permisos

### Panel Izquierdo (Navegación)

13. **AC13**: Selector de proyecto siempre visible en panel izquierdo
14. **AC14**: Sección CONFIGURACIÓN visible para PM y Org Admin (Equipo, Catálogo, Automatización)
15. **AC15**: Sección ORGANIZACIÓN visible solo para Org Admin (Invitaciones, Usuarios, Proyectos)
16. **AC16**: Member NO ve secciones CONFIGURACIÓN ni ORGANIZACIÓN

### Panel Derecho (Mi Actividad)

17. **AC17**: Sección "Mis tareas" muestra tareas reclamadas por el usuario
18. **AC18**: Sección "Mis fichas" muestra fichas donde el usuario tiene tareas
19. **AC19**: Timer de tarea activa visible con controles (pausar, completar)
20. **AC20**: Información de perfil y botón Salir en panel derecho

### Responsive

21. **AC21**: Mobile (< 768px): Solo panel central visible, drawers para laterales
22. **AC22**: Botón hamburguesa abre drawer izquierdo en mobile
23. **AC23**: Botón usuario abre drawer derecho en mobile
24. **AC24**: Mini-barra de tarea activa visible en mobile cuando hay timer

### Accesibilidad

25. **AC25**: Navegación completa por teclado (Tab, Enter, Escape, Arrow keys)
26. **AC26**: ARIA landmarks correctos (nav, main, aside)
27. **AC27**: Skip link a contenido principal

### Type Safety (Anexo C del Spec)

28. **AC28**: `ViewMode` implementado como sum type con exhaustive matching
29. **AC29**: `UrlState` implementado como opaque type con smart constructor
30. **AC30**: `WorkspaceState` implementado como state machine ADT

### Validación E2E

31. **AC31**: Todos los tests de Playwright (sección 13 del spec) pasan en modo headless
32. **AC32**: Tests ejecutados para los 3 roles (Org Admin, PM, Member)

---

## Tasks / Subtasks

### Fase 0: Preparación y Types (AC: 28, 29, 30)

- [ ] **Task 0.1: Crear ViewMode sum type**
  - [ ] Crear `shared/src/domain/view_mode.gleam`
  - [ ] Implementar `ViewMode { Pool, List, Cards }`
  - [ ] Añadir `from_string`, `to_string`, `supports_drag_drop`
  - [ ] Crear `test/view_mode_test.gleam` con tests TDD

- [ ] **Task 0.2: Crear UrlState opaque type**
  - [ ] Crear `apps/client/src/scrumbringer_client/url_state.gleam`
  - [ ] Implementar tipo opaco con `parse(Uri) -> UrlState`
  - [ ] Implementar builders: `with_project`, `with_view`, `with_type_filter`, etc.
  - [ ] Implementar `to_query_string` para serialización
  - [ ] Crear `test/url_state_test.gleam` con tests TDD (ver Anexo C.5)

- [ ] **Task 0.3: Crear WorkspaceState state machine**
  - [ ] Crear `apps/client/src/scrumbringer_client/workspace_state.gleam`
  - [ ] Implementar ADT: `NoProject | LoadingWorkspace | Ready | WorkspaceError`
  - [ ] Implementar transiciones: `select_project`, `workspace_loaded`, `workspace_failed`
  - [ ] Crear `test/workspace_state_test.gleam` con tests TDD (ver Anexo C.6)

### Fase 1: Layout Base (AC: 1, 2, 3)

- [ ] **Task 1.1: Crear ThreePanelLayout**
  - [ ] Crear componente `ThreePanelLayout` en `features/layout/`
  - [ ] Implementar estructura HTML con `nav`, `main`, `aside`
  - [ ] Añadir CSS para layout de 3 columnas (flexbox/grid)
  - [ ] Añadir `data-testid` según Anexo B del spec

- [ ] **Task 1.2: Eliminar header global**
  - [ ] Eliminar componente header existente
  - [ ] Migrar contenido relevante a paneles laterales
  - [ ] Actualizar CSS para aprovechar espacio vertical

- [ ] **Task 1.3: Eliminar rutas obsoletas**
  - [ ] Eliminar `/app/bar` del router
  - [ ] Eliminar `/app/skills` del router
  - [ ] Añadir redirects a `/app` para URLs antiguas
  - [ ] Eliminar código de vistas eliminadas

### Fase 2: Panel Izquierdo (AC: 13, 14, 15, 16)

- [ ] **Task 2.1: Implementar ProjectSelector**
  - [ ] Crear componente `ProjectSelector` con dropdown
  - [ ] Integrar con `UrlState.with_project`
  - [ ] Mostrar nombre del proyecto seleccionado
  - [ ] Cargar lista de proyectos del usuario

- [ ] **Task 2.2: Implementar navegación CONFIGURACIÓN**
  - [ ] Crear sección colapsable CONFIGURACIÓN
  - [ ] Añadir links: Equipo (`/config/team`), Catálogo (`/config/catalog`), Automatización (`/config/automation`)
  - [ ] Mostrar solo si `is_pm || is_org_admin`
  - [ ] Añadir botones "+ Nueva Tarea" y "+ Nueva Ficha" (solo PM/Admin)

- [ ] **Task 2.3: Implementar navegación ORGANIZACIÓN**
  - [ ] Crear sección colapsable ORGANIZACIÓN
  - [ ] Añadir links: Invitaciones, Usuarios, Proyectos
  - [ ] Mostrar solo si `is_org_admin`

- [ ] **Task 2.4: Integrar rutas de configuración**
  - [ ] Actualizar router para `/config/*` (project scope)
  - [ ] Migrar contenido de `/admin/members` a `/config/team`
  - [ ] Migrar contenido de `/admin/capabilities`, `/admin/task-types` a `/config/catalog`
  - [ ] Migrar contenido de `/admin/workflows`, `/admin/cards` a `/config/automation`

### Fase 3: Modos de Vista (AC: 4, 5, 6, 7)

- [ ] **Task 3.1: Implementar ViewModeToggle**
  - [ ] Crear componente toggle con 3 botones: Pool, Lista, Fichas
  - [ ] Integrar con `UrlState.with_view`
  - [ ] Destacar modo activo visualmente
  - [ ] Añadir `data-testid="view-mode-pool|list|cards"`

- [ ] **Task 3.2: Implementar modo Pool**
  - [ ] Reutilizar/adaptar vista Pool existente
  - [ ] Integrar con nuevo layout central
  - [ ] Mantener funcionalidad de drag & drop

- [ ] **Task 3.3: Implementar modo Lista**
  - [ ] Crear vista `GroupedList` con tareas agrupadas por ficha
  - [ ] Implementar secciones colapsables por ficha
  - [ ] Mostrar progreso de ficha (completadas/total)

- [ ] **Task 3.4: Implementar modo Fichas (Kanban)**
  - [ ] Crear componente `KanbanBoard` con 3 columnas
  - [ ] Columnas: Pendiente, En Curso, Cerrada
  - [ ] Mostrar fichas como tarjetas con progreso
  - [ ] PM ve menú contextual [⋮] para CRUD

### Fase 4: Panel Derecho - Mi Actividad (AC: 17, 18, 19, 20)

- [ ] **Task 4.1: Implementar sección "Mis tareas"**
  - [ ] Mostrar lista de tareas reclamadas por usuario actual
  - [ ] Botón "Empezar" para iniciar timer
  - [ ] Indicador de tarea en curso

- [ ] **Task 4.2: Implementar sección "Mis fichas"**
  - [ ] Mostrar fichas donde el usuario tiene tareas asignadas
  - [ ] Mostrar progreso de cada ficha (mis tareas completadas/total)

- [ ] **Task 4.3: Implementar TaskTimer**
  - [ ] Mostrar timer de tarea activa
  - [ ] Controles: Pausar, Completar, Liberar
  - [ ] Integrar con sistema de sesiones existente

- [ ] **Task 4.4: Implementar perfil y logout**
  - [ ] Mostrar nombre/email del usuario
  - [ ] Botón "Salir" (logout)
  - [ ] Link a preferencias (si existe)

### Fase 5: URL Strategy + Estado (AC: 8, 9, 10, 11, 12)

- [ ] **Task 5.1: Integrar UrlState con router**
  - [ ] Parsear URL en init con `url_state.parse`
  - [ ] Actualizar URL en cada cambio con `pushState`/`replaceState`
  - [ ] Implementar handler para `popstate` (botón atrás)

- [ ] **Task 5.2: Integrar WorkspaceState**
  - [ ] Reemplazar campos individuales en Model por `WorkspaceState`
  - [ ] Implementar carga de workspace al seleccionar proyecto
  - [ ] Manejar estados Loading y Error

- [ ] **Task 5.3: Implementar filtros en URL**
  - [ ] Filtro por tipo de tarea (`&type=ID`)
  - [ ] Filtro por capacidad (`&cap=ID`)
  - [ ] Búsqueda (`&search=TERM`) con debounce 300ms
  - [ ] Filtros aplican a los 3 modos de vista

### Fase 6: Responsive (AC: 21, 22, 23, 24)

- [ ] **Task 6.1: Implementar ResponsiveDrawer**
  - [ ] Crear componente drawer genérico (izq/der)
  - [ ] Animación slide-in desde el lado correspondiente
  - [ ] Overlay para cerrar al hacer tap fuera

- [ ] **Task 6.2: Implementar layout mobile**
  - [ ] Media query para < 768px
  - [ ] Ocultar paneles laterales en mobile
  - [ ] Mostrar botón hamburguesa (izq) y usuario (der)

- [ ] **Task 6.3: Implementar MiniTaskBar**
  - [ ] Barra compacta fija en mobile cuando hay timer activo
  - [ ] Mostrar nombre de tarea + tiempo
  - [ ] Tap expande a controles completos

- [ ] **Task 6.4: Adaptar modos de vista para mobile**
  - [ ] Pool: Grid de 2 columnas, sin drag & drop
  - [ ] Lista: Secciones colapsables (funciona bien)
  - [ ] Fichas: Selector de columna en lugar de 3 columnas

### Fase 7: Accesibilidad (AC: 25, 26, 27)

- [ ] **Task 7.1: Implementar navegación por teclado**
  - [ ] Tab entre elementos focusables
  - [ ] Escape cierra modals/drawers
  - [ ] Arrow keys en Pool y Kanban
  - [ ] Atajos: `r` para reclamar tarea seleccionada

- [ ] **Task 7.2: Añadir ARIA landmarks**
  - [ ] `<nav aria-label="Navegación principal">` en panel izquierdo
  - [ ] `<main id="main-content">` en panel central
  - [ ] `<aside aria-label="Mi actividad">` en panel derecho

- [ ] **Task 7.3: Implementar skip link**
  - [ ] Añadir `<a class="skip-link" href="#main-content">`
  - [ ] Visible solo en focus
  - [ ] Salta directamente al contenido principal

- [ ] **Task 7.4: Añadir aria-live regions**
  - [ ] Anunciar cambios de vista
  - [ ] Anunciar acciones (tarea reclamada, completada, etc.)
  - [ ] Anunciar errores con `role="alert"`

### Fase 8: Validación E2E (AC: 31, 32)

- [ ] **Task 8.1: Configurar Playwright**
  - [ ] Instalar `@playwright/test` como devDependency
  - [ ] Crear `playwright.config.js`
  - [ ] Configurar base URL y viewports

- [ ] **Task 8.2: Implementar tests de layout y navegación (T1, T2)**
  - [ ] Test: Layout 3 paneles visible en desktop
  - [ ] Test: Selector de proyecto visible
  - [ ] Test: Toggle de modos de vista funciona
  - [ ] Test: F5 mantiene el modo de vista

- [ ] **Task 8.3: Implementar tests de permisos (T3, T4, T5)**
  - [ ] Test: Member NO ve CONFIGURACIÓN ni ORGANIZACIÓN
  - [ ] Test: PM VE CONFIGURACIÓN, NO ve ORGANIZACIÓN
  - [ ] Test: Org Admin VE todo

- [ ] **Task 8.4: Implementar tests de CRUD (T6, T7)**
  - [ ] Test: PM puede crear/editar/eliminar fichas
  - [ ] Test: PM puede crear/editar/eliminar tareas
  - [ ] Test: Member NO puede crear fichas ni tareas

- [ ] **Task 8.5: Implementar tests de flujo de trabajo (T8)**
  - [ ] Test: Member puede reclamar tarea
  - [ ] Test: Member puede empezar/pausar timer
  - [ ] Test: Member puede completar tarea

- [ ] **Task 8.6: Implementar tests de Config y Org (T9, T10)**
  - [ ] Test: PM puede gestionar equipo y asignar skills
  - [ ] Test: Org Admin puede gestionar usuarios de org

- [ ] **Task 8.7: Implementar tests de URL y F5 (T11)**
  - [ ] Test: Cambiar proyecto actualiza URL
  - [ ] Test: Filtros se reflejan en URL
  - [ ] Test: F5 restaura estado completo
  - [ ] Test: Deep link funciona con permisos

- [ ] **Task 8.8: Implementar tests de responsive (T12)**
  - [ ] Test: Solo panel central visible en mobile (375px)
  - [ ] Test: Botón hamburguesa abre drawer izquierdo
  - [ ] Test: Mini-barra visible con tarea activa

- [ ] **Task 8.9: Ejecutar suite completa**
  - [ ] Ejecutar todos los tests en modo headless
  - [ ] Verificar que pasan para los 3 roles
  - [ ] Generar reporte HTML

### Fase 9: Limpieza y Verificación Final

- [ ] **Task 9.1: Eliminar código obsoleto**
  - [ ] Eliminar archivos de vistas eliminadas (bar, skills)
  - [ ] Eliminar rutas antiguas del router
  - [ ] Eliminar CSS no utilizado

- [ ] **Task 9.2: Verificar compilación y tests**
  - [ ] `gleam build` en client y server sin errores
  - [ ] `gleam test` pasa (client: 261+ tests)
  - [ ] Playwright suite pasa (12 grupos de tests)

- [ ] **Task 9.3: Actualizar documentación**
  - [ ] Actualizar `docs/architecture/source-tree.md` si hay cambios significativos
  - [ ] Verificar que i18n tiene todas las claves nuevas

---

## Dev Notes

### Spec de Referencia

**El documento maestro es `docs/front-end-spec-4.4-ia-redesign.md` (v1.6).**

Contiene:
- Sección 2: Nueva IA (estructura de rutas)
- Sección 3: Wireframes detallados de cada panel
- Sección 6: User flows (6 flujos)
- Sección 7: Responsive strategy con wireframes mobile/tablet
- Sección 8: Especificación de componentes UI
- Sección 9: URL Strategy completo
- Sección 10: Guía de accesibilidad
- Sección 11: Defectos corregidos
- Sección 13: Tests E2E completos con código Playwright
- Anexo B: Lista de `data-testid` requeridos
- Anexo C: Patrones Gleam type-safe con código de referencia

### Estructura de Rutas Nueva

```
/app                    → Vista principal (redirect si no hay proyecto)
/app?project=8&view=pool → Pool de tareas
/app?project=8&view=list → Lista agrupada
/app?project=8&view=cards → Kanban de fichas

/config/team?project=8      → Equipo (ex /admin/members)
/config/catalog?project=8   → Catálogo (ex /admin/capabilities + task-types)
/config/automation?project=8 → Automatización (ex /admin/workflows + cards)

/admin/invites          → Invitaciones (sin cambio)
/admin/users            → Usuarios org (ex /admin/org)
/admin/projects         → Proyectos (sin cambio)
```

### Visibilidad por Rol

| Elemento | Member | PM | Org Admin |
|----------|--------|----|-----------|
| Panel izquierdo | ✅ Solo proyecto | ✅ + CONFIGURACIÓN | ✅ + ORGANIZACIÓN |
| Botón Nueva Tarea | ❌ | ✅ | ✅ |
| Botón Nueva Ficha | ❌ | ✅ | ✅ |
| Menú [⋮] en fichas | ❌ | ✅ | ✅ |
| Panel derecho | ✅ Mi actividad | ✅ | ✅ |

### Breakpoints Responsive

| Breakpoint | Nombre | Layout |
|------------|--------|--------|
| < 768px | Mobile (SM) | 1 panel + drawers |
| 768px - 1024px | Tablet (MD) | 2 paneles |
| > 1024px | Desktop (LG+) | 3 paneles |

### Archivos Clave a Crear

```
shared/src/domain/view_mode.gleam           (nuevo)
apps/client/src/scrumbringer_client/url_state.gleam         (nuevo)
apps/client/src/scrumbringer_client/workspace_state.gleam   (nuevo)
apps/client/src/scrumbringer_client/features/layout/        (nuevo directorio)
  - three_panel_layout.gleam
  - left_panel.gleam
  - center_panel.gleam
  - right_panel.gleam
  - responsive_drawer.gleam
apps/client/src/scrumbringer_client/features/views/         (nuevo directorio)
  - grouped_list.gleam
  - kanban_board.gleam
test/e2e/ia-redesign.spec.js                (nuevo - Playwright)
```

### Testing

**Unit Tests (Gleam):**
- `test/view_mode_test.gleam`
- `test/url_state_test.gleam`
- `test/workspace_state_test.gleam`

**E2E Tests (Playwright):**
- `test/e2e/ia-redesign.spec.js` con 12 grupos de tests
- Ver sección 13 del spec para código completo
- Ejecutar: `npx playwright test test/e2e/ia-redesign.spec.js`

### Criterios de Completitud (del Spec 13.13)

- [ ] Todos los tests Playwright pasan en modo headless
- [ ] Tests ejecutados para los 3 roles (Org Admin, PM, Member)
- [ ] Cobertura de CRUD: Fichas, Tareas
- [ ] Cobertura de acciones: Reclamar, Empezar, Pausar, Completar, Liberar
- [ ] URL persiste estado (F5 funciona)
- [ ] Layout responsive funciona en mobile (375px)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-21 | 1.0 | Initial story creation from spec v1.6 | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used

_To be filled by dev agent_

### Debug Log References

_To be filled by dev agent_

### Completion Notes List

_To be filled by dev agent_

### File List

_To be filled by dev agent_

---

## QA Results

_To be filled by QA agent after implementation_
