# Story 1.8: Member UI (Pool, Filters, My Bar, Priority/Decay, Positions, Notes)

## Status
Done

## Story
**As a** project member,
**I want** a responsive pool UI with filters and a personal “my bar”,
**so that** I can claim/release/complete tasks, organize my view, and collaborate via notes.

## Acceptance Criteria
1. **No assignee in UI (negative)**: UI does not expose an “Assignee” field anywhere.
2. **Project selection**: User can select an active project from the projects list (`GET /api/v1/projects`), and the active project is handled client-side in MVP.
3. **Empty state (no projects)**: If `GET /api/v1/projects` returns an empty list, UI clearly indicates the user is not in any project yet and must ask an admin to add them.
4. **Pool view + filters**: For the active project, UI renders tasks list from `GET /api/v1/projects/:project_id/tasks` supporting filters:
   - status (available/claimed/completed)
   - type
   - capability (single value in MVP)
   - `q` search (title/description only)
5. **Default scope + filters**: By default, the Pool shows tasks from the user’s active project; if no project is active, UI shows tasks across all projects the user belongs to (client-side aggregation of per-project task lists). Capability filter defaults to “All”, with a “My capabilities” quick filter that highlights tasks matching any of the user’s selected capabilities (client-side, since API capability filter is single-value in MVP).
6. **Create task UI**: Project members can create tasks from the UI (calls `POST /api/v1/projects/:project_id/tasks` with `{ title, description?, priority, type_id }`).
7. **Claim/Release/Complete**: UI supports claiming, releasing, and completing tasks via:
   - `POST /api/v1/tasks/:task_id/claim`
   - `POST /api/v1/tasks/:task_id/release`
   - `POST /api/v1/tasks/:task_id/complete`
8. **My bar**: UI shows a dedicated area listing the user’s claimed tasks.
9. **My skills UI**: User can view and update their capability selection (calls `GET /api/v1/me/capabilities` and `PUT /api/v1/me/capabilities`).
10. **Priority visual**: UI represents priority visually as size (not ordering).
11. **Decay visual**: UI represents task age visually and shows age in days.
12. **Positions per-user**: User can reposition tasks in their view, and positions are persisted per-user via:
   - `GET /api/v1/me/task-positions`
   - `PUT /api/v1/me/task-positions/:task_id`
13. **Notes**: User can read and add append-only notes via:
   - `GET /api/v1/tasks/:task_id/notes`
   - `POST /api/v1/tasks/:task_id/notes`
14. **Responsive**: Pool + bar are mobile-friendly.
15. **CSRF for mutations**: All UI-triggered mutating requests include CSRF double-submit (`sb_csrf` + `X-CSRF`).
16. **Information architecture**: Member UI has a single entry route (e.g., `/app`) with a consistent header (project selector + logout) and navigation between: Pool, My Bar, My Skills.
17. **Claimed tasks without assignee leak**: For tasks not claimed by the current user, UI may show status “Claimed” but MUST NOT render `claimed_by` (or any user identifier) anywhere.
18. **Conflict & validation UX**: On `409 CONFLICT_*` or `422 VALIDATION_ERROR` from any task mutation (claim/release/complete, notes, positions), UI shows a clear error message and re-fetches the relevant task list/details to reconcile state.
19. **UX states**: Pool, My Bar, My Skills, Notes, and Positions each define loading/empty/error states; controls are disabled while requests are in-flight and inputs are preserved on recoverable errors.

## Tasks / Subtasks
- [ ] Implement member app routing/layout (header with project selector + logout; nav Pool/My Bar/My Skills) (AC: 2, 16)
- [ ] Implement project selector based on `GET /api/v1/projects` (client-side active project) (AC: 2, 3, 16)
- [ ] Implement empty state when user has no projects (AC: 3)
- [ ] Fetch and cache project task types + capabilities + my capabilities (for filters/labels) (AC: 4, 5, 9)
- [ ] Implement pool list with filters + search `q` + default scope behavior (active project; if none, aggregate across projects) (AC: 4, 5, 19)
- [ ] Implement “My capabilities” quick filter (client-side multi-capability filter) (AC: 5)
- [ ] Implement create task UI (validate required fields; priority 1-5) (AC: 6, 15, 19)
- [ ] Implement claim/release/complete actions with conflict handling + state reconciliation (AC: 7, 15, 18)
- [ ] Implement “my bar” view (only tasks claimed by current user; no assignee display) (AC: 8, 17, 19)
- [ ] Implement “my skills” view using `/me/capabilities` + `GET /api/v1/capabilities` for labels (AC: 9, 15, 19)
- [ ] Implement priority size mapping per architecture guidance (AC: 10)
- [ ] Implement decay factor + age-in-days display per architecture guidance (AC: 11)
- [ ] Implement positions: free canvas by default + persist per-task position (drag) + accessible numeric fallback (AC: 12, 15, 19)
- [ ] Implement task details surface (drawer/modal) with notes list + append-only add and author display (AC: 13, 15, 19)
- [ ] Verify responsive layout (Pool + My Bar usable on mobile) (AC: 14)
- [ ] Add tests (gleeunit where applicable):
  - [ ] priority-to-size mapping and decay calculation (AC: 10, 11)
  - [ ] filter/query + CSRF header inclusion for mutating calls (AC: 4, 15)

## Dev Notes
### Source of truth
- MVP UI requirements: `docs/brief.md` (pool, filters, my bar, priority visual, decay visual, responsive, no assignee).
- API calls, auth, and constraints: `docs/architecture/api-contract.md`.
- Priority/decay guidance:
  - `docs/architecture/data-model.md` (“Decay Calculation”, “Priority Visual Mapping”).

### UI scope (MVP)
- Single member area (route name up to implementation, e.g., `/app`).
- Primary navigation items:
  - **Pool** (task discovery)
  - **My Bar** (your claimed tasks)
  - **My Skills** (capability selection)
- Shared header:
  - Project selector (from `GET /api/v1/projects`, client-side active project)
  - Logout action

### Pool view (tasks + filters)
- Data sources (active project):
  - Tasks: `GET /api/v1/projects/:project_id/tasks` with query params (`status`, `type_id`, `capability_id`, `q`) [Source: `docs/architecture/api-contract.md` “Tasks”]
  - Task types (for filter labels and task cards): `GET /api/v1/projects/:project_id/task-types`
  - Capabilities (for capability filter label and “My Skills” labels): `GET /api/v1/capabilities`
- Filter controls:
  - Status (All/Available/Claimed/Completed)
  - Type (All + task type names)
  - Capability (All + single select)
  - Search `q` input (debounced)
- List rendering:
  - Task card shows: title, type icon/name, status chip, **age in days**, and **priority as size** (not ordering).
  - **No assignee field**: do not render `claimed_by` or any other user identifier.

### My Bar (your claimed tasks)
- Shows tasks where `claimed_by == current_user_id` (derive `current_user_id` from `GET /api/v1/auth/me`).
- Same task card visuals as Pool.
- Actions available on your claimed tasks: Release, Complete.

### Create task
- Trigger: “New task” button (from Pool).
- Form fields:
  - Title (required)
  - Description (optional)
  - Priority (int 1-5; default 3) [Source: `docs/architecture/data-model.md` “Task”]
  - Type (required; `type_id`)
- Validation:
  - Inline errors on required fields
  - Keep form values on `422 VALIDATION_ERROR`

### Claim / Release / Complete UX
- Buttons appear based on state:
  - Available tasks: “Claim”
  - Your claimed tasks: “Release”, “Complete”
  - Completed tasks: no actions
- Mutations must include `version` in body and CSRF headers.
- Conflict handling:
  - On `409 CONFLICT_CLAIMED` or `409 CONFLICT_VERSION`: show toast/error, then refresh tasks (and task details if open).

### Positions (per-user)
- Load positions via `GET /api/v1/me/task-positions` (optionally filtered by project).
- Persist a moved task via `PUT /api/v1/me/task-positions/:task_id` with `{ x, y }`.
- Interaction model:
  - Default: freeform canvas layout (x/y) with drag to move task cards.
  - Accessibility fallback: “Edit position” action opens a small dialog with `x`/`y` numeric inputs + Save.

### Notes (append-only)
- Task details drawer/modal includes a Notes panel:
  - Notes list from `GET /api/v1/tasks/:task_id/notes` (chronological)
  - Add note form (multiline text, required) posts to `POST /api/v1/tasks/:task_id/notes`
- Notes UI MUST show the author:
  - Show “You” when `user_id == current_user_id`.
  - Otherwise show best-available identity (prefer `email`/`name` if available; fallback to `User #{user_id}` in MVP).

### States & feedback
- Loading: visible loading state for all initial fetches.
- Empty:
  - No projects: explain “Ask an admin to add you to a project”.
  - No tasks (given filters): show “No tasks match your filters” + “Clear filters”.
  - My Bar empty: explain how to claim a task.
- Errors:
  - `401 AUTH_REQUIRED`: redirect to login.
  - `403 FORBIDDEN`: show “Not permitted” state.
  - `422`/`409`: show server message; reconcile state by refetch.

### Security (client)
- All mutating requests (`POST`, `PUT`, `PATCH`, `DELETE`) must include CSRF double-submit:
  - Cookie `sb_csrf` and header `X-CSRF: <same value>`.
  [Source: `docs/architecture/api-contract.md` “CSRF (Double-submit)”]

### Accessibility
- All controls are keyboard reachable; focus is visible.
- Filters have labels; search input has clear placeholder and label.
- Dialogs/drawers: focus management (initial focus, Esc to close, return focus).

Notes:
- Sorting is server-defined; do not rely on client re-sorting for priority (priority is a visual size).
- Concurrency conflicts must be surfaced and UI state reconciled with server.

### Testing
- Use `gleeunit` where applicable (pure functions such as decay/priority mapping).

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-12 | 1.0 | Initial draft | architect |
| 2026-01-12 | 1.1 | Filled key usability gaps: no-projects empty state, create-task UI, and my-skills UI; updated AC/tasks accordingly | architect |
| 2026-01-12 | 1.2 | Approved for implementation (end-to-end member flow coverage) | architect |
| 2026-01-13 | 1.3 | UX pass: clarified member IA, task card behaviors, and missing UI states | ux-expert |
| 2026-01-13 | 1.4 | Implemented Member UI core flows + tests (blocked: Gleam >=1.14 needed to run `gleam test`) | dev |

## Dev Agent Record

### Agent Model Used
- GPT-5.2 (opencode)

### Debug Log References
- `apps/client`: `gleam test` (blocked earlier: required Gleam `>=1.14.0`; resolved after upgrade)
- `apps/client`: `gleam format`
- `apps/client`: `gleam test` → `8 passed, no failures`

### Completion Notes List
- Implemented Member area (Pool/My Bar/My Skills) with shared header (project selector + logout) and navigation.
- Added Pool filters: status, type, capability, and debounced `q` search; supports “All projects” aggregation when no active project selected.
- Added “My capabilities” quick toggle to highlight tasks whose task type matches any selected capability.
- Implemented create task dialog using project task types (select) + priority validation (1-5).
- Implemented claim/release/complete with in-flight disabling and error reconciliation (toast + refetch).
- Implemented task notes modal with append-only add and reconciliation on errors (refetch notes).
- Implemented per-user task positions: load, numeric edit modal, and drag-to-move handle with persistence; reconciliation on save errors (refetch positions).
- Added pure visual helpers + tests for priority sizing, decay factor, and tasks URL query building.

### File List
- `apps/client/src/scrumbringer_client.gleam` (modified)
- `apps/client/src/scrumbringer_client/api.gleam` (modified)
- `apps/client/src/scrumbringer_client/fetch.ffi.mjs` (modified)
- `apps/client/src/scrumbringer_client/member_visuals.gleam` (added)
- `apps/client/test/api_tasks_url_test.gleam` (added)
- `apps/client/test/member_visuals_test.gleam` (added)

## QA Results

### Review Date: 2026-01-13

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
Member UI implementation is cohesive and follows the API contract for tasks, skills, positions, and notes. Error paths generally reconcile state via refetch, and UI avoids rendering assignee identifiers.

### Refactoring Performed
- **File**: `apps/client/src/scrumbringer_client.gleam`
  - **Change**: Fetch and merge task types across all projects (when no active project is selected).
  - **Why**: Ensures AC5 “My capabilities” highlight and type labels can work in the client-side aggregated (all-projects) view.
  - **How**: Added pending counters + per-project dict, then merged lists when all responses arrive.

### Compliance Check
- Coding Standards: ✓
- Project Structure: ✓
- Testing Strategy: ✓ (gleeunit tests exist for pure helpers)
- All ACs Met: ✓

### Improvements Checklist
- [x] Verified mutations attach CSRF header when cookie present
- [x] Verified conflict/validation errors show toast and refetch relevant state
- [ ] Consider adding pointer/touch drag support on mobile (numeric fallback already exists)

### Security Review
- PASS: CSRF double-submit enforced via client request helper for mutating methods.
- PASS: UI does not expose `claimed_by` or other assignee identifiers.

### Performance Considerations
- PASS (MVP): lists intentionally unpaginated; changes are linear list operations.

### Files Modified During Review
- `apps/client/src/scrumbringer_client.gleam` (modified)

### Gate Status
Gate: PASS → `docs/qa/gates/1.8-member-ui-pool.yml`

### Recommended Status
✓ Ready for Done
(Story owner decides final status)
