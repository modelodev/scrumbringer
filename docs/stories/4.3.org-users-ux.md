# Story 4.3: Org Users Management - UX Specification

## Overview

This document defines the UI/UX improvements for the Organization Users management section ("Org" in sidebar). The goal is to provide a clearer, more consistent interface for managing organization users and their project memberships.

---

## Current State Analysis

### Problems Identified

| # | Problem | Severity | Impact |
|---|---------|----------|--------|
| 1 | **Empty "PROYECTOS" column** - Only shows "Ver" button, no indication of project count | High | User cannot see project info without opening dialog |
| 2 | **Confusing "ROL" dropdown** - Shows org_role but header just says "ROL" | High | Confusion between org role and project role |
| 3 | **"Guardar" always visible** - Button appears even without pending changes | Medium | Visual noise, unclear what gets saved |
| 4 | **Dialog cannot change project role** - Shows role as text, not editable | High | User specifically reported this issue |
| 5 | **Add always assigns "member"** - No role selector when adding to project | High | Cannot add user as manager from this view |
| 6 | **No pending changes indicator** - No visual feedback for unsaved changes | Medium | Confusing UX |
| 7 | **Inconsistent with Members view** - Project Members table has role dropdown, this doesn't | High | Inconsistent experience |

### Current Screenshots

The current "Org" section shows:
- Table with EMAIL, ROL (dropdown), PROYECTOS (Ver button), ACCIONES (Guardar button)
- "Ver" opens dialog showing projects with role as text (not editable)
- Add form only has project selector, no role selector

---

## Proposed Design

### 1. Main Table: Organization Users

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ¢ USUARIOS DE LA ORGANIZACIÃ“N                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Gestiona los usuarios y sus roles en la organizaciÃ³n.                       â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ EMAIL              â”‚ ROL ORG      â”‚ PROYECTOS              â”‚ ACCIONES  â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ admin@example.com  â”‚ ğŸŸ£ Admin     â”‚ 2: Alpha, Beta         â”‚ [Gestionarâ”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ pm@example.com     â”‚ [Member â–¼] * â”‚ 2: Alpha (mgr), Beta   â”‚ [Gestionarâ”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ member@example.com â”‚ [Member â–¼]   â”‚ 1: Alpha               â”‚ [Gestionarâ”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ new@example.com    â”‚ [Member â–¼]   â”‚ Sin proyectos          â”‚ [Gestionarâ”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                              â”‚
â”‚  * cambio pendiente                              [Guardar cambios de rol]    â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Column Specifications

| Column | Content | Notes |
|--------|---------|-------|
| EMAIL | User email | Plain text |
| ROL ORG | Dropdown (admin/member) | Shows badge for Admin (ğŸŸ£). Asterisk (*) if pending change |
| PROYECTOS | Summary text | Format: "{count}: {names}" or "Sin proyectos". Shows "(mgr)" suffix for manager role |
| ACCIONES | Single button | "Gestionar" opens user projects dialog |

#### Changes from Current

1. **Rename "ROL" to "ROL ORG"** - Clarifies this is organization role
2. **Add project summary in PROYECTOS column** - Shows count + abbreviated list with roles
3. **Rename "Ver" to "Gestionar"** - Better reflects the action (manage, not just view)
4. **Move "Guardar" to bottom** - Single button for all pending org role changes
5. **Add pending indicator (*)** - Visual feedback for unsaved changes
6. **Disable "Guardar" when no changes** - Only enabled when there are pending changes

---

### 2. User Projects Dialog (Redesigned)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“‚ Proyectos de pm@example.com                                         [Ã—] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  PROYECTOS ASIGNADOS                                                         â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ PROYECTO             â”‚ ROL EN PROYECTO     â”‚ ACCIONES        â”‚           â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤           â”‚
â”‚  â”‚ Project Alpha        â”‚ [Manager â–¼]         â”‚ [Quitar]        â”‚           â”‚
â”‚  â”‚ Project Beta         â”‚ [Member â–¼]          â”‚ [Quitar]        â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                                                              â”‚
â”‚  AÃ‘ADIR A PROYECTO                                                           â”‚
â”‚                                                                              â”‚
â”‚  Proyecto: [Seleccionar proyecto â–¼]   Rol: [Member â–¼]   [+ AÃ±adir]          â”‚
â”‚                                                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              [Cerrar]        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Dialog Specifications

| Element | Behavior |
|---------|----------|
| Title | "Proyectos de {email}" with folder icon |
| Projects table | Shows all projects user belongs to |
| ROL EN PROYECTO column | **Dropdown** (Manager/Member) - changes role immediately on selection |
| ACCIONES column | "Quitar" button removes user from project |
| Add form - Proyecto | Dropdown with available projects (not already assigned) |
| Add form - Rol | **NEW**: Dropdown with Manager/Member options |
| Add form - AÃ±adir | Adds user to selected project with selected role |

#### Key Changes from Current

1. **Role column is now editable** - Dropdown instead of text
2. **Add form includes role selector** - Can add as Manager or Member
3. **Role changes are immediate** - Like in Project Members view (Story 4.2)
4. **Consistent with Project Members table** - Same interaction pattern

---

## Visibility & Permission Rules

### Main Table (Org Users)

| Element | Org Admin | Project Manager | Member |
|---------|-----------|-----------------|--------|
| View table | âœ… | âŒ Hidden section | âŒ Hidden section |
| Change org role | âœ… | N/A | N/A |
| Open user projects dialog | âœ… | N/A | N/A |

### User Projects Dialog

| Element | Org Admin |
|---------|-----------|
| View projects list | âœ… |
| Change project role (dropdown) | âœ… |
| Add to project | âœ… |
| Add as Manager | âœ… |
| Add as Member | âœ… |
| Remove from project | âœ… |

> **Note:** This dialog is only accessible to Org Admins, so all features are available.

---

## API Requirements

### Existing Endpoints (Already Implemented)

| Endpoint | Method | Purpose | Status |
|----------|--------|---------|--------|
| `/api/v1/org/users` | GET | List org users | âœ… Exists |
| `/api/v1/org/users/:id` | PATCH | Update org role | âœ… Exists |
| `/api/v1/org/users/:id/projects` | GET | List user's projects | âœ… Exists |
| `/api/v1/org/users/:id/projects` | POST | Add user to project | âœ… Exists (needs role param) |
| `/api/v1/org/users/:id/projects/:pid` | DELETE | Remove from project | âœ… Exists |

### API Changes Required

#### 1. POST /api/v1/org/users/:id/projects - Add Role Parameter

**Current Request:**
```json
{
  "project_id": 8
}
```

**New Request:**
```json
{
  "project_id": 8,
  "role": "manager" | "member"  // NEW: optional, defaults to "member"
}
```

#### 2. NEW: PATCH /api/v1/org/users/:id/projects/:pid - Change Project Role

This endpoint already exists for Project Members (`PATCH /projects/:id/members/:uid`). We need a parallel endpoint from the user-centric perspective.

**Request:**
```json
{
  "role": "manager" | "member"
}
```

**Response 200:**
```json
{
  "project": {
    "id": 8,
    "name": "Project Alpha",
    "role": "manager"
  }
}
```

**Response 422 (Last manager):**
```json
{
  "error": "last_manager",
  "message": "Cannot demote the last project manager"
}
```

---

## i18n Keys Required

### New Keys

| Key | ES | EN |
|-----|----|----|
| `OrgRole` | "Rol org" | "Org role" |
| `ProjectsCount(n)` | "{n} proyectos" / "1 proyecto" / "Sin proyectos" | "{n} projects" / "1 project" / "No projects" |
| `Manage` | "Gestionar" | "Manage" |
| `SaveOrgRoleChanges` | "Guardar cambios de rol" | "Save role changes" |
| `PendingChange` | "cambio pendiente" | "pending change" |
| `RoleInProject` | "Rol en proyecto" | "Role in project" |
| `AddToProjectWithRole` | "AÃ±adir a proyecto" | "Add to project" |
| `ProjectRoleUpdated` | "Rol de proyecto actualizado" | "Project role updated" |

### Existing Keys to Reuse

- `RoleManager`, `RoleMember` - Already exist
- `UserProjectsTitle`, `UserProjectsAdd`, `UserProjectRemove` - Already exist
- `SelectProject` - Already exists

---

## Component Changes

### Files to Modify

| File | Changes |
|------|---------|
| `features/admin/view.gleam` | Redesign `view_org_settings` and `view_user_projects_dialog` |
| `features/admin/update.gleam` | Add handlers for role change in dialog |
| `client_state.gleam` | Add new messages for project role change |
| `api/org.gleam` | Add `update_user_project_role` function, modify `add_user_to_project` |
| `i18n/text.gleam` | Add new text keys |
| `i18n/en.gleam`, `i18n/es.gleam` | Add translations |

### Server Files to Modify

| File | Changes |
|------|---------|
| `http/org_users.gleam` | Add PATCH handler for project role, modify POST to accept role |
| `services/projects_db.gleam` | May need new function or reuse existing |

---

## Interaction Patterns

### Changing Org Role

```
1. User changes dropdown value
2. Row shows (*) indicator
3. "Guardar cambios de rol" button enables
4. User clicks save
5. API call to PATCH /org/users/:id
6. On success: toast "Rol actualizado", indicator clears
7. On error: inline error message
```

### Changing Project Role (in Dialog)

```
1. User changes role dropdown in dialog table
2. Immediate API call to PATCH /org/users/:id/projects/:pid
3. On success: toast "Rol de proyecto actualizado"
4. On error: toast with error message, revert dropdown
```

### Adding User to Project

```
1. User selects project from dropdown
2. User selects role (Manager/Member)
3. User clicks "AÃ±adir"
4. API call to POST /org/users/:id/projects with role
5. On success: project appears in table with selected role
6. On error: inline error in dialog
```

---

## Empty States

### No Projects Assigned

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                              â”‚
â”‚                              ğŸ“‚                                              â”‚
â”‚                                                                              â”‚
â”‚                    Este usuario no tiene proyectos                           â”‚
â”‚                                                                              â”‚
â”‚            Usa el formulario de abajo para aÃ±adirlo a un proyecto            â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### No Available Projects to Add

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AÃ‘ADIR A PROYECTO                                            â”‚
â”‚                                                               â”‚
â”‚  El usuario ya pertenece a todos los proyectos disponibles.   â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Accessibility

- All dropdowns must be keyboard navigable
- Role changes should announce via `aria-live` region
- Error messages should have `role="alert"`
- Dialog should trap focus while open
- Close button should be accessible via Escape key

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-21 | 1.0 | Initial UX specification | Sally (UX Expert) |
