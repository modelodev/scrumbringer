# Story 7.7: Creacion de hito

## Status

Done

## Story

**As a** manager del proyecto,
**I want** crear hitos desde un punto de entrada claro en la navegacion de Hitos,
**so that** pueda estructurar trabajo por etapas y encadenar rapidamente la creacion contextual de tarjetas sin friccion.

## Contexto UX (recorrido visual real)

Recorrido realizado con `agent-browser` en `https://localhost:8443` (usuario `admin@example.com`) antes de disenar:

- En navegacion principal existen CTAs globales `+ Nueva tarea` y `+ Nueva tarjeta`.
- En vista `Hitos` no existe CTA directo de `+ Nuevo hito` en header principal.
- En filas de hito existen acciones `Ver detalle`, `Activar`, `Editar hito`, `Acciones`.
- En detalle de hito existen CTAs `+ Nueva tarjeta` y `+ Nueva tarea`.
- Existe dialogo de edicion de hito (nombre + descripcion), utilizable como base visual para create.

Conclusion de contexto: el sistema ya soporta gestionar y editar hitos, pero el alta de hito no tiene punto de entrada principal consistente con el resto de creaciones.

## Decisiones de diseno (a/b/c)

### a) Desde donde puede y debe crearse un hito

**Debe (principal):**

1. Vista `Hitos` en header de seccion con CTA primario `+ Nuevo hito`.
2. Empty state de `Hitos` con CTA `Crear primer hito`.

**Puede (secundario):**

3. Accion rapida en topbar como menu unificado de creacion (`Tarea`, `Tarjeta`, `Hito`) solo para roles con permiso.

**No recomendado (por ruido de IA/UX):**

- Duplicar CTA de `Nuevo hito` en `Kanban`, `Personas` o paneles no orientados a planificacion por etapas.

### b) Como debe ser la interfaz de creacion de hito

Patron visual y de interaccion consistente con create de `card` y `task`:

1. Dialogo global estandar (overlay + header + body + footer).
2. Header con titulo `Crear hito` y boton close.
3. Body con:
   - `Nombre del hito` (required)
   - `Descripcion` (optional)
   - Contexto de proyecto visible read-only (si aplica): `Proyecto destino: <nombre>`
4. Footer con `Cancelar` (secundario) y `Crear` (primario), con estado `Creando` en in-flight.
5. Validaciones y errores en mismo patron de dialogs existentes (sin banners ad hoc).
6. i18n ES/EN completo para labels, placeholders y errores.
7. A11y: foco inicial predecible, navegacion teclado completa, retorno de foco al CTA origen al cerrar.

### c) Desde creacion de hitos, como crear card y si conviene crear tasks

Flujo recomendado post-create:

1. Tras crear hito, mantener al usuario en contexto `Hitos` y abrir detalle del hito recien creado (o resaltarlo en lista).
2. CTA principal de continuacion: `+ Nueva tarjeta en este hito` (alineado con Story 7.6).
3. CTA secundaria opcional: `+ Nueva tarea` desde detalle de hito, pero no como accion principal del flujo de alta.

Decision UX:

- **Tarjetas**: si conviene exponerlas inmediatamente tras crear hito (es el siguiente paso natural de estructuracion).
- **Tasks**: no priorizar en el punto de alta del hito; ya hay vistas/contextos suficientes para crearlas y suelen depender de tarjetas para mejor orden.

## Relacion con Story 7.6

7.6 define la creacion contextual de tarjeta desde detalle de hito y la estandariza.

7.7 debe integrarse asi:

1. Crear hito -> navegar/abrir detalle de hito.
2. Desde ese detalle usar CTA contextual de 7.6 (`+ Nueva tarjeta en este hito`).
3. Reusar mismas reglas de contexto visible, no duplicacion de modales y consistencia i18n/a11y.

Dependencia funcional recomendada:

- Si 7.6 esta implementada: 7.7 queda completa en experiencia end-to-end (crear hito -> crear tarjeta contextual).
- Si 7.6 no esta implementada aun: 7.7 puede salir, pero con handoff menos consistente para alta de tarjeta contextual.

## Acceptance Criteria

1. **AC1**: Existe CTA principal `+ Nuevo hito` en vista `Hitos` visible para roles con permiso.
2. **AC2**: Si no hay hitos, el empty state muestra CTA `Crear primer hito`.
3. **AC3**: Al activar el CTA de create hito, se abre dialogo global estandar (mismo patron visual de create card/task).
4. **AC4**: Dialogo create hito incluye `Nombre` requerido y `Descripcion` opcional.
5. **AC5**: Validacion: no permite submit con nombre vacio y muestra error claro i18n.
6. **AC6**: Submit exitoso crea hito, cierra dialogo, muestra toast y mantiene contexto de navegacion en `Hitos`.
7. **AC7**: Post-create permite continuidad rapida hacia detalle del hito creado y CTA de crear tarjeta contextual.
8. **AC8**: Reutilizacion estricta de componentes/patrones existentes (sin modal o estilos ad hoc).
9. **AC9**: i18n ES/EN completo para CTA, dialogo, errores y estados de accion.
10. **AC10**: Accesibilidad: foco inicial/retorno, teclado y semantica de labels en dialogo.
11. **AC11**: Cobertura de tests deterministas para apertura, validacion, create exitoso, error y continuidad hacia flujo de 7.6.

## Componentes a reutilizar

1. `ui/dialog.gleam` (shell modal estandar).
2. Patron de formularios y botones de create usado por dialogs existentes de card/task.
3. `features/milestones/view.gleam` para punto de entrada en vista Hitos.
4. `features/milestones/update.gleam` para manejo de estado create/edit/delete de hito.
5. Reglas i18n existentes en `i18n/text.gleam`, `i18n/es.gleam`, `i18n/en.gleam`.

## Tasks / Subtasks

- [x] **Task 1 (AC: 1, 2): Definir puntos de entrada de create hito**
  - [x] 1.1 Agregar CTA primario `+ Nuevo hito` en header de vista Hitos.
  - [x] 1.2 Agregar CTA `Crear primer hito` en empty state de Hitos.
  - [x] 1.3 Asegurar visibilidad por permisos (manager/admin).

- [x] **Task 2 (AC: 3, 4, 5, 8): Implementar dialogo de create hito con patron existente**
  - [x] 2.1 Reusar estructura visual/modal existente (header/body/footer).
  - [x] 2.2 Campos: nombre required, descripcion optional.
  - [x] 2.3 Estados de boton `Crear/Creando` y errores inline consistentes.
  - [x] 2.4 Sin introducir modal/formulario paralelo ni estilos ad hoc.

- [x] **Task 3 (AC: 6, 7): Continuidad de flujo tras crear hito**
  - [x] 3.1 Al crear, refrescar lista y mantener contexto en Hitos.
  - [x] 3.2 Abrir/seleccionar hito creado y facilitar acceso a detalle.
  - [x] 3.3 Desde detalle, priorizar CTA de tarjeta contextual (alineado con 7.6).

- [x] **Task 4 (AC: 9, 10): i18n + accesibilidad**
  - [x] 4.1 Agregar claves ES/EN para CTA, labels, errores y estados.
  - [x] 4.2 Verificar foco inicial/retorno y navegacion por teclado.

- [x] **Task 5 (AC: 11): Testing (TDD)**
  - [x] 5.1 Test de apertura de create hito desde header y empty state.
  - [x] 5.2 Test de validacion de nombre requerido.
  - [x] 5.3 Test de create exitoso (toast + contexto Hitos preservado).
  - [x] 5.4 Test de error de create sin cierre accidental del dialogo.
  - [x] 5.5 Test de continuidad de flujo hacia detalle y entrada a 7.6.

## Testing Notes

- Cliente:
  - `gleam format`
  - `gleam check`
  - `gleam test`
- Foco de suites:
  - pruebas de vista/estado de milestones,
  - pruebas de dialogos y regresion de navegacion.

## Definition of Done

- Create de hito disponible y claro en vista Hitos (header + empty state).
- Dialogo create consistente con patrones de card/task.
- Continuidad post-create hacia creacion de tarjeta contextual (7.6).
- i18n ES/EN y accesibilidad validadas.
- Sin duplicacion de componentes ni estilos ad hoc.
- Tests de estado/UI/regresion pasando.

## Change Log

| Date       | Version | Description                                                   | Author |
| ---------- | ------- | ------------------------------------------------------------- | ------ |
| 2026-02-08 | 0.1     | Story inicial 7.7 basada en recorrido visual real con browser | UX     |
| 2026-02-08 | 1.0     | Implementacion completa de create milestone + tests           | James  |
| 2026-02-08 | 1.1     | QA final en PASS y cierre de historia                         | Quinn  |

## Dev Agent Record

### Agent Model Used

openai/gpt-5.3-codex

### Debug Log References

- `gleam format` (apps/client)
- `gleam check` (apps/client)
- `gleam test` (apps/client)

### Completion Notes List

- Se agrego flujo de creacion de hito con CTA en toolbar y empty state de vista Hitos.
- Se implemento dialogo de create milestone reutilizando `ui/dialog` y `form_field`, sin variantes ad hoc.
- Se extendio `MilestoneDialog` con variante `MilestoneDialogCreate` para modelar estado de forma type-safe.
- Se agregaron mensajes y handlers TEA para create submit/success/error.
- En create exitoso se abre detalle del hito creado para continuidad con 7.6 (`+ Nueva tarjeta en este hito`).
- Se agrego API client `create_milestone` y claves i18n ES/EN para textos nuevos.
- Se cubrieron escenarios nuevos con tests de vista y update para flujo create.

### File List

- `apps/client/src/scrumbringer_client/api/milestones.gleam`
- `apps/client/src/scrumbringer_client/client_state/member/pool.gleam`
- `apps/client/src/scrumbringer_client/features/milestones/ids.gleam`
- `apps/client/src/scrumbringer_client/features/milestones/update.gleam`
- `apps/client/src/scrumbringer_client/features/milestones/view.gleam`
- `apps/client/src/scrumbringer_client/features/pool/msg.gleam`
- `apps/client/src/scrumbringer_client/features/pool/update.gleam`
- `apps/client/src/scrumbringer_client/i18n/text.gleam`
- `apps/client/src/scrumbringer_client/i18n/en.gleam`
- `apps/client/src/scrumbringer_client/i18n/es.gleam`
- `apps/client/test/milestones_view_test.gleam`
- `apps/client/test/milestones_update_test.gleam`

## QA Results

### Review Date: 2026-02-08

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

La implementacion cumple bien la arquitectura TEA/Lustre esperada para cliente Gleam: estado en `Model`, transiciones en `update`, vistas puras y reutilizacion de `ui/dialog`/`form_field`. El flujo principal de create milestone esta bien integrado y mantiene continuidad funcional con hitos y detalle.

### Refactoring Performed

No se aplico refactor directo desde QA; revision de calidad enfocada en cobertura AC y riesgos residuales.

### Compliance Check

- Coding Standards: ✓
- Project Structure: ✓
- Testing Strategy: ✓ (con hueco puntual de regresion end-to-end)
- All ACs Met: ⚠️ Parcial (ver concerns)

### Improvements Checklist

- [x] Verificado uso de componentes/patrones existentes (`ui/dialog`, `form_field`, flujo de milestones)
- [x] Verificado modelado de estado create con variante tipada (`MilestoneDialogCreate`)
- [ ] Endurecer validacion de nombre en create (`trim` + no solo cadena vacia literal)
- [ ] Agregar prueba de regresion completa create milestone -> detalle -> create card contextual (7.6)

### Security Review

Sin hallazgos criticos. El create usa endpoint existente con controles de autorizacion/CSRF ya presentes en backend.

### Performance Considerations

Sin impacto relevante; cambios acotados a UI/state y una llamada create ya soportada por API.

### Files Modified During Review

Ninguno.

### Gate Status

Gate: CONCERNS -> docs/qa/gates/7.7-milestone-create.yml

### Recommended Status

[✗ Changes Required - See unchecked items above]
(Story owner decides final status)

### Review Date: 2026-02-08 (Final Follow-up)

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Se validan fixes finales: nombre con `trim` antes de validar/crear y prueba encadenada de continuidad 7.7 -> 7.6. La implementacion mantiene consistencia TEA/Lustre, reutilizacion de componentes y pruebas en verde.

### Compliance Check

- Coding Standards: ✓
- Project Structure: ✓
- Testing Strategy: ✓
- All ACs Met: ✓

### Improvements Checklist

- [x] Endurecer validacion de nombre en create (`trim` + no solo cadena vacia literal)
- [x] Agregar prueba de regresion completa create milestone -> detalle -> create card contextual (7.6)

### Gate Status

Gate: PASS -> docs/qa/gates/7.7-milestone-create.yml

### Recommended Status

[✓ Ready for Done]
(Story owner decides final status)

### Review Date: 2026-02-08 (Follow-up)

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Seguimiento aplicado tras cambios recientes: la implementacion mantiene buena calidad arquitectonica (TEA/Lustre), reutilizacion correcta de componentes y pruebas en verde. No obstante, los dos concerns originales siguen abiertos.

### Compliance Check

- Coding Standards: ✓
- Project Structure: ✓
- Testing Strategy: ✓ (continua faltando cobertura encadenada 7.7 -> 7.6)
- All ACs Met: ⚠️ Parcial

### Improvements Checklist

- [x] Verificada estabilidad visual de tabs en detalle de hitos al alternar contenido/metricas
- [ ] Endurecer validacion de nombre en create (`trim` + no solo cadena vacia literal)
- [ ] Agregar prueba de regresion completa create milestone -> detalle -> create card contextual (7.6)

### Gate Status

Gate: CONCERNS -> docs/qa/gates/7.7-milestone-create.yml

### Recommended Status

[✗ Changes Required - See unchecked items above]
(Story owner decides final status)
