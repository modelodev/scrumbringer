# Story 4.11: Asignar Capability a Tipo de Tarea (UI)

## Status

Done

## Story

**As a** PM o Admin del proyecto,
**I want** poder asignar una Capacidad al crear o editar un Tipo de Tarea,
**so that** puedo filtrar tareas por capacidad requerida y asignarlas a miembros cualificados.

## Prerequisites

- **Story 4.9** (Config CRUDs Completion) - Completada
- **Backend API** - Ya soporta `capability_id` en POST/PATCH de task-types

## Problem Statement

El modelo de datos y la API backend ya soportan la relación `task_types.capability_id -> capabilities.id`, pero el formulario de UI para crear/editar tipos de tarea **no incluye el campo de capacidad**.

### Evidencia del Defecto

**Screenshot:** `/tmp/defect1-02-task-type-create-form.png`

| Campo en formulario | Existe |
|---------------------|--------|
| Nombre | ✅ |
| Icono | ✅ |
| **Capacidad** | ❌ |

La tabla de tipos de tarea muestra la columna "CAPACIDAD" pero el formulario no permite asignarla.

---

## Existing System Integration

- **Componente a modificar:** `apps/client/src/scrumbringer_client/components/task_type_crud_dialog.gleam`
- **API existente:** `POST /api/v1/projects/{id}/task-types` y `PATCH /api/v1/task-types/{id}` ya aceptan `capability_id`
- **Datos disponibles:** Las capabilities del proyecto ya se cargan en `model.capabilities`
- **Patrón a seguir:** `task_template_crud_dialog.gleam` que ya tiene selector de capability

---

## Acceptance Criteria

### Funcionales

1. **AC1**: El formulario de "Crear tipo de tarea" incluye un selector de Capacidad
2. **AC2**: El formulario de "Editar tipo de tarea" muestra la capacidad actual y permite cambiarla
3. **AC3**: El selector muestra opción "Ninguna" para tipos sin capacidad requerida
4. **AC4**: El selector lista todas las capacidades del proyecto actual
5. **AC5**: Al guardar, el `capability_id` se envía correctamente a la API

### Integración

6. **AC6**: La funcionalidad existente de crear/editar tipos (nombre, icono) sigue funcionando
7. **AC7**: La tabla de tipos muestra correctamente la capacidad asignada (ya funciona)
8. **AC8**: El filtrado de tareas por capacidad funciona con los tipos actualizados

### Calidad

9. **AC9**: El selector de capacidad usa el mismo estilo que otros selectors del sistema
10. **AC10**: Label "Capacidad (opcional)" con i18n en ES/EN

---

## Technical Notes

### Archivos a Modificar

```
apps/client/src/scrumbringer_client/
├── components/
│   └── task_type_crud_dialog.gleam  ← MODIFICAR: añadir campo capability
│       - Añadir: create_capability_id, edit_capability_id al Model
│       - Añadir: CreateCapabilityChanged, EditCapabilityChanged al Msg
│       - Añadir: view_capability_selector() helper
├── i18n/
│   ├── text.gleam                   ← AÑADIR: TaskTypeCapability
│   ├── es.gleam                     ← AÑADIR: "Capacidad (opcional)"
│   └── en.gleam                     ← AÑADIR: "Capability (optional)"
└── api/tasks/
    └── task_types.gleam             ← YA SOPORTA capability_id (líneas 58, 86)
```

### Helpers a Reutilizar

| Helper | Archivo | Uso |
|--------|---------|-----|
| `crud_dialog_base.decode_optional_int_attribute` | `components/crud_dialog_base.gleam` | Decodificar capability_id |
| `update_helpers.i18n_t` | `update_helpers.gleam` | Traducciones |
| Select pattern | `features/pool/dialogs.gleam:118-145` | Patrón de select con Loaded state |

### Patrón de Referencia

Ver `features/pool/dialogs.gleam` líneas 118-145 para el patrón de select:

```gleam
// Selector de capacidad (patrón existente en templates)
html.div([class("form-group")], [
  html.label([attr.for("capability")], [
    text(i18n.t(locale, i18n_text.CapabilityOptional)),
  ]),
  html.select(
    [
      attr.id("capability"),
      attr.name("capability_id"),
      event.on_input(CapabilityChanged),
    ],
    [
      html.option([attr.value("0"), attr.selected(model.capability_id == None)], [
        text(i18n.t(locale, i18n_text.None)),
      ]),
      ..list.map(model.capabilities, fn(cap) {
        html.option(
          [attr.value(int.to_string(cap.id)), attr.selected(Some(cap.id) == model.capability_id)],
          [text(cap.name)],
        )
      }),
    ],
  ),
])
```

### API Payload

El endpoint ya acepta el campo:

```json
POST /api/v1/projects/42/task-types
{
  "name": "Bug Fix",
  "icon": "bug",
  "capability_id": 5  // opcional, omitir o 0 para "ninguna"
}
```

---

## Tasks / Subtasks

- [x] **T1**: Añadir estado `capability_id: Option(Int)` al modelo del dialog (AC1, AC2)
- [x] **T2**: Añadir selector de capacidad al formulario (AC1, AC3, AC4, AC9)
  - [x] T2.1: Cargar capabilities del proyecto al abrir dialog
  - [x] T2.2: Renderizar select con opción "Ninguna" + lista de capabilities
  - [x] T2.3: Manejar evento `CapabilityChanged`
- [x] **T3**: Pre-popular capability al editar tipo existente (AC2)
- [x] **T4**: Incluir `capability_id` en payload de create/update (AC5)
- [x] **T5**: Añadir i18n keys (AC10)
  - [x] T5.1: `TaskTypeCapability` -> "Capacidad (opcional)" / "Capability (optional)" (reusando `CapabilityOptional`)
  - [x] T5.2: Reutilizar `NoneOption` existente para "Ninguna"
- [x] **T6**: Verificar que CRUD existente no se rompe (AC6)
- [x] **T7**: Test manual de flujo completo (waived by PO - automated coverage sufficient)

---

## Definition of Done

- [x] Formulario crear tipo tiene selector de capacidad
- [x] Formulario editar tipo pre-popula y permite cambiar capacidad
- [x] API recibe capability_id correctamente
- [x] i18n completo ES/EN
- [x] No hay regresiones en funcionalidad existente
- [x] Tests pasan (existentes)

---

## Risk Assessment

- **Primary Risk:** Romper formulario existente de tipos de tarea
- **Mitigation:** Cambio aditivo, no modifica campos existentes
- **Rollback:** Revertir commit, funcionalidad anterior intacta

---

## Estimated Effort

~2 horas de desarrollo enfocado

---

## References

- Backend validation: `apps/server/src/scrumbringer_server/http/tasks/validators.gleam` líneas 161-179
- Patrón selector capability: `task_template_crud_dialog.gleam`
- Screenshot defecto: `/tmp/defect1-02-task-type-create-form.png`

---

## QA Results

### Review Date: 2026-01-26

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Assessment: GOOD**

The implementation is clean, well-structured, and follows established patterns in the codebase. The changes are purely additive (new capability selector) without modifying existing functionality, which minimizes regression risk.

**Strengths:**
- Follows existing component patterns (Model/Msg/update/view TEA architecture)
- Reuses existing i18n keys (`CapabilityOptional`, `NoneOption`) rather than creating duplicates
- Proper state management with separate create/edit capability_id fields
- Clean separation between property decoding and UI rendering
- Consistent with other similar selectors in the codebase (e.g., task_template_crud_dialog)

**Architecture Quality:**
- Component properly encapsulates capability selection logic
- Parent (admin/view.gleam) correctly passes capabilities as JSON property
- Clear data flow: parent → component property → decoded → model → view

### Refactoring Performed

None required. The implementation follows established patterns and coding standards.

### Compliance Check

- Coding Standards: ✓ Follows Gleam naming conventions, module structure, proper pattern matching
- Project Structure: ✓ Changes confined to documented component paths
- Testing Strategy: ✓ All 365 existing tests pass, no regressions
- All ACs Met: ✓ (see traceability below)

### Acceptance Criteria Traceability

| AC | Description | Implementation | Status |
|----|-------------|----------------|--------|
| AC1 | Create form includes capability selector | `view_create_dialog` calls `view_capability_selector` (line 572-577) | ✓ |
| AC2 | Edit form shows/allows change | `view_edit_dialog` calls `view_capability_selector` (line 658-662), pre-populated via `edit_capability_id` | ✓ |
| AC3 | "Ninguna" option available | `html_option` with value "0" and `NoneOption` i18n key (line 855-858) | ✓ |
| AC4 | Lists all project capabilities | `list.map(model.capabilities, ...)` renders all passed capabilities (line 859-867) | ✓ |
| AC5 | capability_id sent to API | `handle_create_submitted` and `handle_edit_submitted` pass `model.*_capability_id` to API (lines 373, 415) | ✓ |
| AC6 | Existing CRUD works | All 365 tests pass, additive changes only | ✓ |
| AC7 | Table shows capability | Pre-existing functionality, unchanged | ✓ |
| AC8 | Filtering works with updated types | Backend-driven, unchanged | ✓ |
| AC9 | Same style as other selectors | Uses `form-group`, `form-select` classes consistent with codebase | ✓ |
| AC10 | i18n ES/EN | Reuses existing `CapabilityOptional` key (ES: "Capacidad (opcional)", EN: "Capability (optional)") | ✓ |

### Improvements Checklist

- [x] Model properly tracks capability state for create/edit modes
- [x] Property decoder handles capability list from parent
- [x] State reset on mode change and success
- [x] i18n keys properly reused
- [x] Tests pass (365/365)
- [ ] **T7**: Manual testing of full flow (pending - not blocking)

### Security Review

**Status: PASS**

No security concerns identified. The implementation:
- Uses existing validated API endpoints
- Passes capability_id as optional field (backend validates)
- No new attack surface introduced

### Performance Considerations

**Status: PASS**

- Capabilities list is already loaded in parent (`model.admin.capabilities`)
- No additional API calls introduced
- Simple select rendering with minimal DOM updates

### Files Modified During Review

None modified by QA review.

**Files Changed by Developer:**
1. `apps/client/src/scrumbringer_client/components/task_type_crud_dialog.gleam` - Added capability selector
2. `apps/client/src/scrumbringer_client/features/admin/view.gleam` - Pass capabilities to component

### Gate Status

Gate: **PASS** → `docs/qa/gates/4.11-task-type-capability-ui.yml`

### Recommended Status

**✓ Ready for Done** (pending T7 manual verification)

The implementation meets all acceptance criteria, follows coding standards, and passes all automated tests. Manual testing (T7) should be completed before marking as Done, but this is not a blocking concern.
