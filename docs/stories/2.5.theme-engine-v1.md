# Story 2.5: Theme engine v1 (tokens + CSS vars + persistencia)

## Status: Done

## Story
**As a** user,
**I want** to switch between a default theme and a dark theme,
**so that** the UI is comfortable in different lighting conditions and we establish a token-based styling system.

## Acceptance Criteria
1. **Tokens semánticos definidos**: El cliente define un set mínimo de tokens *semánticos* (no nombres de colores) que describen intención UI (p.ej. `bg`, `surface`, `text`, `primary`, etc.).
2. **CSS variables como fuente de verdad**: El runtime aplica los tokens exclusivamente vía CSS variables (custom properties) con prefijo `--sb-` (p.ej. `--sb-bg`, `--sb-surface`, `--sb-text`, `--sb-border`, `--sb-primary`).
3. **Dos temas completos**: Se soportan al menos `default` (baseline de validación visual) y `dark`, y **cada tema define valores para el 100% del set mínimo de tokens** (sin tokens “faltantes”).
4. **Default + fallback predecible**: Si no hay preferencia persistida, el tema activo por defecto es `default`. Si el valor persistido es inválido/desconocido, se hace fallback a `default` sin romper estilos.
5. **Persistencia client-only**: La selección de tema se persiste en el cliente (localStorage key: `sb_theme`) y se restaura al recargar (sin dependencia de servidor, sin API calls).
6. **Efecto global**: El tema aplica de forma consistente en superficies Admin y Member (mínimo: `bg/surface/elevated`, `text/muted/inverse`, `border`, `link`, `primary`, `focus-ring`, y estados `danger/warning/success/info`).
7. **UI de switch discoverable y accesible**: Existe un control de cambio de tema en la UI autenticada (ubicación flexible pero fácil de encontrar), operable con teclado y con etiqueta/estado entendible.
8. **Sin acoplar CSS a lógica**: Ningún componente decide colores en lógica (if/else por tema, clases “dark-mode”, etc.). Los componentes consumen únicamente tokens semánticos (CSS vars); cambiar/añadir un tema no requiere tocar estilos por componente.
9. **Contrato mínimo de tokens (naming sugerido)**: El set mínimo incluye (al menos) estos tokens: `--sb-bg`, `--sb-surface`, `--sb-elevated`, `--sb-text`, `--sb-muted`, `--sb-inverse`, `--sb-border`, `--sb-link`, `--sb-primary`, `--sb-primary-hover`, `--sb-focus-ring`, `--sb-danger`, `--sb-warning`, `--sb-success`, `--sb-info`. Tokens opcionales permitidos: `--sb-shadow-*`, `--sb-radius-*`, `--sb-space-*`, `--sb-font-*`.
10. **Estados interactivos coherentes**: En ambos temas, los estados hover/focus/disabled de links y acciones primarias son distinguibles y consistentes (especialmente `--sb-primary-hover` y `--sb-focus-ring`).
11. **Accesibilidad básica**: En ambos temas, el texto principal y los links mantienen contraste suficiente sobre `bg/surface/elevated` y el foco (focus ring) es claramente visible.
12. **Sin parpadeos perceptibles**: Al cargar la app con un tema persistido, no hay “flash” perceptible del tema incorrecto (el usuario no ve primero `default` y luego `dark`).
   - Decisión MVP: ignorar `prefers-color-scheme` y usar solo `sb_theme` (o `default` si no existe).
13. **Validación visual mínima (manual)**: Se verifica en `default` y `dark` el checklist visual acordado (ver abajo en este story) y pasa sin issues P0.

### Checklist visual de aceptación (manual)
- Login/autenticación: inputs, labels, placeholders, errores.
- Header/nav autenticado: el switch de tema es visible, entendible y operable.
- Listados/tablas: encabezados, filas, bordes, estados hover.
- Botones: primary/secondary (si existe), disabled, focus visible.
- Links: color + estado hover/focus distinguible.
- Mensajes/estados: `danger/warning/success/info` legibles en `surface` y `elevated`.
- Diálogos/modales (si existen): fondo, elevated, overlay, foco atrapado/visible.

## Tasks / Subtasks
- [x] Define theme tokens + variable mapping (AC: 1, 2, 3)
  - [x] Create a dedicated client module for theme definitions (e.g. `scrumbringer_client/theme.gleam`) (AC: 1)
  - [x] Provide functions to render the active theme as CSS variables (AC: 2)
- [x] Apply theme variables at the app root (AC: 2, 5)
  - [x] Ensure the root container sets the variables so all components inherit them (AC: 5)
- [x] Refactor key UI styling to use CSS variables (AC: 2, 5)
  - [x] Replace hard-coded colors in shared layout, tables, buttons, and dialogs with vars (AC: 5)
- [x] Add theme switch UI + state (AC: 6)
  - [x] Add a theme toggle/select control in the authenticated header (Admin + Member) (AC: 6)
  - [x] Add message/update logic to switch theme (AC: 3)
- [x] Persist theme selection (AC: 4)
  - [x] Read persisted theme at startup (AC: 4)
  - [x] Write persisted theme on change (AC: 4)
- [x] Add tests (AC: 3, 4)
  - [x] Client: serialization/deserialization of theme value (AC: 4)
  - [x] Client: mapping produces expected CSS vars for both themes (AC: 3)

## Dev Notes
### Source of truth
- Product requirement: responsive, mobile-friendly UI; keep MVP simple: `docs/brief.md` (see “MVP Scope v1.0” and “Risks → Scope creep”).
- Client stack and layout: `docs/architecture/source-tree.md` (see `apps/client/`).

### Implementation note
- Prefer a small token set to avoid premature design-system complexity.
- Treat `default` as the baseline theme for visual validation (manual spot-checks and future snapshot/regression checks).

## Testing
- Server: `make test`
- Client: `apps/client: gleam test`

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-14 | 1.0 | Initial draft | po |
| 2026-01-14 | 1.1 | Ready for dev (DoR passed; sb_theme key; default/dark baseline; prefers-color-scheme ignored) | po |
| 2026-01-14 | 1.2 | Implement theme tokens + CSS vars + persistence + switch UI | dev |

## Dev Agent Record

### Agent Model Used
- GPT-5.2

### Debug Log References
- `make test`
- `apps/client: gleam test`

### Completion Notes
- Added token-based theming (`default` + `dark`) implemented as CSS variables (`--sb-*`) with client-only persistence under `sb_theme`.
- Injected a small global stylesheet that styles common UI surfaces (topbar/nav/content, tables, buttons, inputs, modals, toast) exclusively via semantic tokens.
- Added an accessible theme selector in authenticated Admin + Member headers.
- Refactored remaining hard-coded card colors to consume tokens (no theme-specific branching in components).
- Manual visual checklist (AC13) still requires a quick browser spot-check in both themes.

### File List
- Modified: `apps/client/src/scrumbringer_client.gleam`
- Modified: `apps/client/src/scrumbringer_client/client_ffi.gleam`
- Added: `apps/client/src/scrumbringer_client/theme.gleam`
- Added: `apps/client/test/theme_test.gleam`
- Modified: `docs/stories/2.5.theme-engine-v1.md`

## QA Results

### Review Date: 2026-01-14

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

- Buena base para design system MVP: tokens semánticos mínimos + CSS variables como fuente de verdad.
- Implementación sin branching por tema en componentes (el switch sólo cambia CSS vars), lo que reduce acoplamiento.
- Tests unitarios cubren completitud de tokens por tema y fallback de deserialización.

### Refactoring Performed

- Ninguno.

### Compliance Check

- Coding Standards: ✓
- Project Structure: ✓
- Testing Strategy: ⚠️ (faltan checks manuales/visuales)
- All ACs Met: ⚠️ (AC11-AC13 requieren validación manual)

### Improvements Checklist

- [x] Tokens mínimos `--sb-*` definidos para `default` y `dark` (100% del set)
- [x] Persistencia client-only (`sb_theme`) con fallback seguro a `default`
- [x] Switch accesible en UI autenticada (Admin + Member)
- [ ] Ejecutar checklist visual manual en ambos temas (AC13)
- [ ] Verificar “no flash” perceptible con `sb_theme=dark` en reload (AC12)

### Security Review

- PASS: Sin cambios de superficie server. Persistencia local solamente.

### Performance Considerations

- PASS: Switch basado en CSS vars (sin recomputación pesada ni network).

### Files Modified During Review

- Added: `docs/qa/gates/2.5-theme-engine-v1-tokens-css-vars-persistencia.yml`
- Added: `docs/qa/assessments/2.5-nfr-20260114.md`
- Added: `docs/qa/assessments/2.5-risk-20260114.md`
- Added: `docs/qa/assessments/2.5-trace-20260114.md`
- Modified: `docs/stories/2.5.theme-engine-v1.md`

### Gate Status

Gate: CONCERNS → `docs/qa/gates/2.5-theme-engine-v1-tokens-css-vars-persistencia.yml`
Risk profile: `docs/qa/assessments/2.5-risk-20260114.md`
NFR assessment: `docs/qa/assessments/2.5-nfr-20260114.md`
Trace matrix: `docs/qa/assessments/2.5-trace-20260114.md`

### Recommended Status

[✗ Changes Required - See unchecked items above]
(Story owner decides final status)

---

### Review Date: 2026-01-15

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

- Re-evaluated current client state; `apps/client: gleam test` passes (48 tests).
- Theming model remains clean: semantic tokens + CSS vars, no component-level theme branching.

### Requirements Traceability (AC → evidence)

- **AC3/AC4**: Covered by `apps/client/test/theme_test.gleam` (theme completeness + invalid fallback).
- **AC11–AC13**: Still require manual validation (contrast/focus visibility, no-flash check, and the visual checklist).

### NFR Assessment (quick)

- Security: PASS (client-only persistence, no new server surface).
- Performance: PASS (CSS-var switch; no network).
- Reliability: PASS (invalid persisted theme falls back to `default`).
- Maintainability: CONCERNS (ensure token set stays minimal and avoid reintroducing hard-coded colors).

### Top Issues

- **UX-001 (medium)**: AC13 visual checklist not executed/recorded.
- **UX-002 (medium)**: `apps/client/dist/index.html` does not apply theme vars before loading `scrumbringer_client.js`; with `sb_theme=dark`, a flash of the wrong theme is still plausible (AC12).

### Improvements Checklist

- [x] Automated tests passing (`apps/client: gleam test`)
- [ ] Execute/record manual visual checklist in `default` + `dark` (AC13)
- [ ] Verify reload with `sb_theme=dark` has no perceptible flash; if it does, implement pre-mount theme application (AC12)

### Files Modified During Review

- Modified: `docs/qa/gates/2.5-theme-engine-v1-tokens-css-vars-persistencia.yml`
- Modified: `docs/stories/2.5.theme-engine-v1.md`

### Gate Status

Gate: CONCERNS → `docs/qa/gates/2.5-theme-engine-v1-tokens-css-vars-persistencia.yml`

### Recommended Status

[✗ Changes Required - See unchecked items above]
(Story owner decides final status)

---

### Review Date: 2026-01-15

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

- AC12 mitigation implemented: `apps/client/dist/index.html` now applies the persisted theme before the bundle loads (inline script reads localStorage `sb_theme` and sets CSS vars on `document.documentElement`).
- Build safety added: `apps/client/gleam.toml` sets `[tools.lustre.build] no_html = true` so the above HTML isn’t overwritten by the build.
- Reported automated checks: `apps/client: gleam test` passes.

### Requirements Traceability (delta)

- **AC12**: Implementation added; still needs a quick human confirmation that the “no perceptible flash” requirement is met in real reload conditions.
- **AC13**: Manual checklist is tracked but not completed yet: `docs/qa/assessments/2.5-visual-checklist-20260115.md`.

### Improvements Checklist

- [x] Prevent Lustre from overwriting `dist/index.html` (`no_html = true`)
- [x] Apply persisted theme before JS loads (AC12 mitigation)
- [ ] Complete and record manual visual checklist in `default` + `dark` (AC13)
- [ ] Manually verify reload with `sb_theme=dark` has no perceptible flash (AC12)

### Gate Status

Gate: CONCERNS → `docs/qa/gates/2.5-theme-engine-v1-tokens-css-vars-persistencia.yml`
Risk profile: `docs/qa/assessments/2.5-risk-20260114.md`
NFR assessment: `docs/qa/assessments/2.5-nfr-20260114.md`
Trace matrix: `docs/qa/assessments/2.5-trace-20260114.md`
Visual checklist: `docs/qa/assessments/2.5-visual-checklist-20260115.md`

### Recommended Status

[✗ Changes Required - Manual checklist pending]
(Story owner decides final status)

---

### Review Date: 2026-01-15

### Reviewed By: Quinn (Test Architect)

### Evidence Update (Playwright)

- New evidence recorded in `docs/qa/assessments/2.5-visual-checklist-20260115.md` with screenshots under `/tmp/`.
- **AC12 (sin parpadeos perceptibles)**: Verified via Playwright check that CSS vars match the persisted theme at `domcontentloaded` for both themes (`default` + `dark`).
- **AC13 (validación visual mínima)**: Most checklist items exercised and marked PASS for both themes; remaining gaps below were not explicitly exercised.

### Remaining Gaps (non-blocking for MVP)

- Status messages (`danger/warning/success/info`) readability on `surface`/`elevated` was not explicitly exercised in this run.
- Dialogs/modals/overlay (if present) were not explicitly exercised in this run.

### Gate Status

Gate: PASS → `docs/qa/gates/2.5-theme-engine-v1-tokens-css-vars-persistencia.yml`
Visual checklist: `docs/qa/assessments/2.5-visual-checklist-20260115.md`

### Recommended Status

[✓ Ready for Done] / [✗ Changes Required - Follow up low-priority UI checks]
(Story owner decides final status)
