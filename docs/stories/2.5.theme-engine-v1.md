# Story 2.5: Theme engine v1 (tokens + CSS vars + persistencia)

## Status: Ready for Review

## Story
**As a** user,
**I want** to switch between a default theme and a dark theme,
**so that** the UI is comfortable in different lighting conditions and we establish a token-based styling system.

## Acceptance Criteria
1. **Tokens semánticos definidos**: El cliente define un set mínimo de tokens *semánticos* (no nombres de colores) que describen intención UI (p.ej. `bg`, `surface`, `text`, `primary`, etc.).
2. **CSS variables como fuente de verdad**: El runtime aplica los tokens exclusivamente vía CSS variables (custom properties) con prefijo `--sb-` (p.ej. `--sb-bg`, `--sb-surface`, `--sb-text`, `--sb-border`, `--sb-primary`).
3. **Dos temas completos**: Se soportan al menos `default` (baseline de validación visual) y `dark`, y **cada tema define valores para el 100% del set mínimo de tokens** (sin tokens “faltantes”).
4. **Default + fallback predecible**: Si no hay preferencia persistida, el tema activo por defecto es `default`. Si el valor persistido es inválido/desconocido, se hace fallback a `default` sin romper estilos.
5. **Persistencia client-only**: La selección de tema se persiste en el cliente (localStorage key: `sb_theme`) y se restaura al recargar (sin dependencia de servidor, sin API calls).
6. **Efecto global**: El tema aplica de forma consistente en superficies Admin y Member (mínimo: `bg/surface/elevated`, `text/muted/inverse`, `border`, `link`, `primary`, `focus-ring`, y estados `danger/warning/success/info`).
7. **UI de switch discoverable y accesible**: Existe un control de cambio de tema en la UI autenticada (ubicación flexible pero fácil de encontrar), operable con teclado y con etiqueta/estado entendible.
8. **Sin acoplar CSS a lógica**: Ningún componente decide colores en lógica (if/else por tema, clases “dark-mode”, etc.). Los componentes consumen únicamente tokens semánticos (CSS vars); cambiar/añadir un tema no requiere tocar estilos por componente.
9. **Contrato mínimo de tokens (naming sugerido)**: El set mínimo incluye (al menos) estos tokens: `--sb-bg`, `--sb-surface`, `--sb-elevated`, `--sb-text`, `--sb-muted`, `--sb-inverse`, `--sb-border`, `--sb-link`, `--sb-primary`, `--sb-primary-hover`, `--sb-focus-ring`, `--sb-danger`, `--sb-warning`, `--sb-success`, `--sb-info`. Tokens opcionales permitidos: `--sb-shadow-*`, `--sb-radius-*`, `--sb-space-*`, `--sb-font-*`.
10. **Estados interactivos coherentes**: En ambos temas, los estados hover/focus/disabled de links y acciones primarias son distinguibles y consistentes (especialmente `--sb-primary-hover` y `--sb-focus-ring`).
11. **Accesibilidad básica**: En ambos temas, el texto principal y los links mantienen contraste suficiente sobre `bg/surface/elevated` y el foco (focus ring) es claramente visible.
12. **Sin parpadeos perceptibles**: Al cargar la app con un tema persistido, no hay “flash” perceptible del tema incorrecto (el usuario no ve primero `default` y luego `dark`).
   - Decisión MVP: ignorar `prefers-color-scheme` y usar solo `sb_theme` (o `default` si no existe).
13. **Validación visual mínima (manual)**: Se verifica en `default` y `dark` el checklist visual acordado (ver abajo en este story) y pasa sin issues P0.

### Checklist visual de aceptación (manual)
- Login/autenticación: inputs, labels, placeholders, errores.
- Header/nav autenticado: el switch de tema es visible, entendible y operable.
- Listados/tablas: encabezados, filas, bordes, estados hover.
- Botones: primary/secondary (si existe), disabled, focus visible.
- Links: color + estado hover/focus distinguible.
- Mensajes/estados: `danger/warning/success/info` legibles en `surface` y `elevated`.
- Diálogos/modales (si existen): fondo, elevated, overlay, foco atrapado/visible.

## Tasks / Subtasks
- [x] Define theme tokens + variable mapping (AC: 1, 2, 3)
  - [x] Create a dedicated client module for theme definitions (e.g. `scrumbringer_client/theme.gleam`) (AC: 1)
  - [x] Provide functions to render the active theme as CSS variables (AC: 2)
- [x] Apply theme variables at the app root (AC: 2, 5)
  - [x] Ensure the root container sets the variables so all components inherit them (AC: 5)
- [x] Refactor key UI styling to use CSS variables (AC: 2, 5)
  - [x] Replace hard-coded colors in shared layout, tables, buttons, and dialogs with vars (AC: 5)
- [x] Add theme switch UI + state (AC: 6)
  - [x] Add a theme toggle/select control in the authenticated header (Admin + Member) (AC: 6)
  - [x] Add message/update logic to switch theme (AC: 3)
- [x] Persist theme selection (AC: 4)
  - [x] Read persisted theme at startup (AC: 4)
  - [x] Write persisted theme on change (AC: 4)
- [x] Add tests (AC: 3, 4)
  - [x] Client: serialization/deserialization of theme value (AC: 4)
  - [x] Client: mapping produces expected CSS vars for both themes (AC: 3)

## Dev Notes
### Source of truth
- Product requirement: responsive, mobile-friendly UI; keep MVP simple: `docs/brief.md` (see “MVP Scope v1.0” and “Risks → Scope creep”).
- Client stack and layout: `docs/architecture/source-tree.md` (see `apps/client/`).

### Implementation note
- Prefer a small token set to avoid premature design-system complexity.
- Treat `default` as the baseline theme for visual validation (manual spot-checks and future snapshot/regression checks).

## Testing
- Server: `make test`
- Client: `apps/client: gleam test`

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-14 | 1.0 | Initial draft | po |
| 2026-01-14 | 1.1 | Ready for dev (DoR passed; sb_theme key; default/dark baseline; prefers-color-scheme ignored) | po |
| 2026-01-14 | 1.2 | Implement theme tokens + CSS vars + persistence + switch UI | dev |

## Dev Agent Record

### Agent Model Used
- GPT-5.2

### Debug Log References
- `make test`
- `apps/client: gleam test`

### Completion Notes
- Added token-based theming (`default` + `dark`) implemented as CSS variables (`--sb-*`) with client-only persistence under `sb_theme`.
- Injected a small global stylesheet that styles common UI surfaces (topbar/nav/content, tables, buttons, inputs, modals, toast) exclusively via semantic tokens.
- Added an accessible theme selector in authenticated Admin + Member headers.
- Refactored remaining hard-coded card colors to consume tokens (no theme-specific branching in components).
- Manual visual checklist (AC13) still requires a quick browser spot-check in both themes.

### File List
- Modified: `apps/client/src/scrumbringer_client.gleam`
- Modified: `apps/client/src/scrumbringer_client/fetch.ffi.mjs`
- Added: `apps/client/src/scrumbringer_client/theme.gleam`
- Added: `apps/client/test/theme_test.gleam`
- Modified: `docs/stories/2.5.theme-engine-v1.md`

## QA Results
