# Story 7.5: Tabs de métricas (Hito, Card, Task)

## Status

Draft

## Story

**As a** miembro del proyecto,
**I want** ver métricas básicas de hitos, cards y tasks en sus modales de detalle,
**so that** puedo entender el progreso y salud de cada elemento sin salir de su contexto.

## Problem Statement

Los modales de detalle de hito, card y task muestran información operativa pero no métricas de progreso/salud. Esto obliga a ir a vistas separadas de métricas para entender el estado de un elemento específico.

## Filosofía (alineación con brief)

- **Estado implícito**: las métricas se derivan del estado de las tasks (no se gestionan aparte)
- **Trabajo real visible**: métricas reflejan actividad real (claimed/ongoing/completed)
- **Minimalismo**: métricas básicas ahora, sprint dedicado para profundizar después

## Prerrequisitos

> **IMPORTANTE**: Esta historia depende de 7.4 (Milestones), que prepara el modelo de datos:
> - `tasks.pool_lifetime_s` + `tasks.last_entered_pool_at` para tracking de tiempo en pool
> - `tasks.created_from_rule_id` para trazabilidad de workflows
> - Handlers de claim/release/complete actualizados para mantener pool_lifetime
>
> Si 7.4 no está completado, las métricas `pool_lifetime` y `tasks_by_workflow` no funcionarán.

---

## Acceptance Criteria

### General

1. **AC1**: Los modales de hito, card y task tienen tabs: "Contenido" (o "Detalle") y "Métricas"
2. **AC2**: Tab por defecto es "Contenido"/"Detalle"
3. **AC3**: Las métricas se calculan/derivan en tiempo real (excepto pool_lifetime que se acumula en DB)

### Métricas de Hito

4. **AC4**: Cards totales / completadas
5. **AC5**: Tasks totales / completadas
6. **AC6**: Tasks por estado: available / claimed / ongoing / completed
7. **AC7**: Barra de progreso visual (% completitud)
8. **AC8**: Rebotes promedio (avg release_count de tasks)
9. **AC9**: Vida en pool promedio (avg pool_lifetime de tasks)
10. **AC10**: Ejecutores promedio por task (avg unique_executors)
11. **AC11**: Tasks creadas por workflow (desglose)
12. **AC12**: Workflow más activado

### Métricas de Card

13. **AC13**: Tasks totales / completadas
14. **AC14**: Tasks por estado: available / claimed / ongoing / completed
15. **AC15**: Barra de progreso visual (% completitud)
16. **AC16**: Rebotes promedio (avg release_count de tasks)
17. **AC17**: Vida en pool promedio (avg pool_lifetime de tasks)
18. **AC18**: Ejecutores promedio por task (avg unique_executors)
19. **AC19**: Tasks creadas por workflow (desglose)
20. **AC20**: Workflow más activado

### Métricas de Task

21. **AC21**: Claim count (veces reclamada)
22. **AC22**: Release count / rebotes (veces liberada)
23. **AC23**: Ejecutores únicos (personas distintas que la reclamaron)
24. **AC24**: First claim at (fecha primer claim, si existe)
25. **AC25**: Tiempo en estado actual
26. **AC26**: Vida en pool acumulada (tiempo total en estado Available)
27. **AC27**: Sesiones de trabajo (count)
28. **AC28**: Tiempo total trabajado (suma de sesiones)

### i18n

29. **AC29**: Labels ES/EN para todas las métricas

---

## Wireframes

### Modal de Hito (tab Métricas)

```
┌─────────────────────────────────────────────────────────────┐
│ Hito: Release 2.0                                    [X]    │
├─────────────────────────────────────────────────────────────┤
│ [Contenido]  [Métricas ●]                                   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ Progreso general                                            │
│ ████████████░░░░░░░░ 67%                                    │
│                                                             │
│ ─────────────────────────────────────────────────────────── │
│                                                             │
│ Cards                              Tasks                    │
│ ┌─────────────────────┐           ┌─────────────────────┐  │
│ │ Completadas    4/6  │           │ Completadas   12/18 │  │
│ │ ████████░░░░   67%  │           │ ████████░░░░   67%  │  │
│ └─────────────────────┘           └─────────────────────┘  │
│                                                             │
│ ─────────────────────────────────────────────────────────── │
│                                                             │
│ Desglose de tasks por estado                                │
│ ┌───────────────────────────────────────────────────────┐  │
│ │ Available     ░░░░░░░░░░░░░░░░░░░░░░░░  3            │  │
│ │ Claimed       ████░░░░░░░░░░░░░░░░░░░░  2            │  │
│ │ Ongoing       ██░░░░░░░░░░░░░░░░░░░░░░  1            │  │
│ │ Completed     ████████████████████████  12           │  │
│ └───────────────────────────────────────────────────────┘  │
│                                                             │
│ ─────────────────────────────────────────────────────────── │
│                                                             │
│ Salud de ejecución                                          │
│ ┌───────────────────────────────────────────────────────┐  │
│ │ Rebotes promedio         1.2 por task                 │  │
│ │ Vida en pool promedio    3h 45m                       │  │
│ │ Ejecutores promedio      1.8 personas/task            │  │
│ └───────────────────────────────────────────────────────┘  │
│                                                             │
│ ─────────────────────────────────────────────────────────── │
│                                                             │
│ Workflows                                                   │
│ ┌───────────────────────────────────────────────────────┐  │
│ │ Creadas desde workflow:                               │  │
│ │   Bug Report         ██████████████  8                │  │
│ │   Feature Request    ████████░░░░░░  5                │  │
│ │   Quick Task         ████░░░░░░░░░░  3                │  │
│ │   (sin workflow)     ██░░░░░░░░░░░░  2                │  │
│ │                                                       │  │
│ │ Más activado: Bug Report                              │  │
│ └───────────────────────────────────────────────────────┘  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### Modal de Card (tab Métricas)

```
┌─────────────────────────────────────────────────────────────┐
│ Card: Auth refactor                                  [X]    │
├─────────────────────────────────────────────────────────────┤
│ [Detalle]  [Métricas ●]                                     │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ Progreso                                                    │
│ ██████░░░░░░░░░░░░░░ 60%                                    │
│                                                             │
│ ─────────────────────────────────────────────────────────── │
│                                                             │
│ Tasks                                                       │
│ ┌─────────────────────────────────────────────────────────┐│
│ │ Completadas                                    3/5      ││
│ └─────────────────────────────────────────────────────────┘│
│                                                             │
│ ─────────────────────────────────────────────────────────── │
│                                                             │
│ Desglose por estado                                         │
│ ┌───────────────────────────────────────────────────────┐  │
│ │ Available     ░░░░░░░░░░░░  1                         │  │
│ │ Claimed       ████░░░░░░░░  1                         │  │
│ │ Ongoing       ░░░░░░░░░░░░  0                         │  │
│ │ Completed     ████████████  3                         │  │
│ └───────────────────────────────────────────────────────┘  │
│                                                             │
│ ─────────────────────────────────────────────────────────── │
│                                                             │
│ Salud de ejecución                                          │
│ ┌───────────────────────────────────────────────────────┐  │
│ │ Rebotes promedio         0.4 por task                 │  │
│ │ Vida en pool promedio    1h 20m                       │  │
│ │ Ejecutores promedio      1.2 personas/task            │  │
│ └───────────────────────────────────────────────────────┘  │
│                                                             │
│ ─────────────────────────────────────────────────────────── │
│                                                             │
│ Workflows                                                   │
│ ┌───────────────────────────────────────────────────────┐  │
│ │ Creadas desde workflow:                               │  │
│ │   Feature Request    ████████████  4                  │  │
│ │   (sin workflow)     ████░░░░░░░░  1                  │  │
│ │                                                       │  │
│ │ Más activado: Feature Request                         │  │
│ └───────────────────────────────────────────────────────┘  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### Modal de Task (tab Métricas)

```
┌─────────────────────────────────────────────────────────────┐
│ Task: Migrate tokens                                 [X]    │
├─────────────────────────────────────────────────────────────┤
│ [Detalle]  [Métricas ●]                                     │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ Estado actual: Claimed                                      │
│ Tiempo en este estado: 2h 34m                               │
│                                                             │
│ ─────────────────────────────────────────────────────────── │
│                                                             │
│ Historial de claims                                         │
│ ┌───────────────────────────────────────────────────────┐  │
│ │ Veces reclamada              2                        │  │
│ │ Veces liberada (rebotes)     1                        │  │
│ │ Ejecutores únicos            2 personas               │  │
│ │ Primer claim                 2026-02-04 10:23         │  │
│ └───────────────────────────────────────────────────────┘  │
│                                                             │
│ ─────────────────────────────────────────────────────────── │
│                                                             │
│ Tiempo en pool                                              │
│ ┌───────────────────────────────────────────────────────┐  │
│ │ Vida en pool acumulada       5h 30m                   │  │
│ │ (tiempo total en Available)                           │  │
│ └───────────────────────────────────────────────────────┘  │
│                                                             │
│ ─────────────────────────────────────────────────────────── │
│                                                             │
│ Trabajo acumulado                                           │
│ ┌───────────────────────────────────────────────────────┐  │
│ │ Sesiones de trabajo          3                        │  │
│ │ Tiempo total trabajado       4h 15m                   │  │
│ └───────────────────────────────────────────────────────┘  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## Tasks / Subtasks

- [ ] **Task 1: Sistema de tabs en modales** (AC: 1-3)
  - [ ] 1.1 Componente Tab reutilizable en `ui/tabs.gleam`
  - [ ] 1.2 Integrar tabs en modal de hito
  - [ ] 1.3 Integrar tabs en modal de card
  - [ ] 1.4 Integrar tabs en modal de task

- [ ] **Task 2: Métricas de hito** (AC: 4-12)
  - [ ] 2.1 Endpoint o extensión de `GET /milestones/:id` con métricas
  - [ ] 2.2 Barras de progreso (cards/tasks)
  - [ ] 2.3 Desglose por estado
  - [ ] 2.4 Salud de ejecución (rebotes_avg, pool_lifetime_avg, executors_avg)
  - [ ] 2.5 Workflows (tasks por workflow, más activado)
  - [ ] 2.6 Render de métricas en tab

- [ ] **Task 3: Métricas de card** (AC: 13-20)
  - [ ] 3.1 Endpoint o extensión de `GET /cards/:id` con métricas
  - [ ] 3.2 Barras de progreso y desglose por estado
  - [ ] 3.3 Salud de ejecución (rebotes_avg, pool_lifetime_avg, executors_avg)
  - [ ] 3.4 Workflows (tasks por workflow, más activado)
  - [ ] 3.5 Render de métricas en tab

- [ ] **Task 4: Métricas de task** (AC: 21-28)
  - [ ] 4.1 Endpoint o extensión de `GET /tasks/:id` con métricas
  - [ ] 4.2 Historial de claims (claim_count, release_count, unique_executors, first_claim_at)
  - [ ] 4.3 Tiempo en pool (pool_lifetime_accumulated)
  - [ ] 4.4 Trabajo acumulado (session_count, total_work_time)
  - [ ] 4.5 Tiempo en estado actual
  - [ ] 4.6 Render de métricas en tab

- [ ] **Task 5: i18n** (AC: 29)
  - [ ] 5.1 Labels ES/EN para todas las métricas

- [ ] **Task 6: Tests** (AC: 1-29)
  - [ ] 6.1 Tests de componente tabs
  - [ ] 6.2 Tests de cálculo de métricas (backend)
  - [ ] 6.3 Tests de agregación (rebotes_avg, etc)
  - [ ] 6.4 Tests de render de métricas

---

## Dev Notes

### Dependencias de modelo (de 7.4)

Esta historia asume que 7.4 completó:
1. Tabla `milestones` con relaciones a cards/tasks
2. Columnas en `tasks`: `pool_lifetime_s`, `last_entered_pool_at`, `created_from_rule_id`
3. Tracking de pool_lifetime en handlers de claim/release/complete
4. Trazabilidad workflow→task vía `created_from_rule_id`

### Fuentes de datos para métricas

| Métrica | Fuente | Query |
|---------|--------|-------|
| claim_count | task_events | `COUNT(*) WHERE event_type='task_claimed'` |
| release_count | task_events | `COUNT(*) WHERE event_type='task_released'` |
| unique_executors | task_events | `COUNT(DISTINCT actor_user_id) WHERE claimed/released` |
| first_claim_at | task_events | `MIN(created_at) WHERE event_type='task_claimed'` |
| time_in_current_state | task_events | `NOW() - MAX(created_at)` del último evento |
| pool_lifetime | tasks | `tasks.pool_lifetime_s` (acumulado por 7.4) |
| session_count | user_task_work_session | `COUNT(*)` por task |
| total_work_time | user_task_work_total | `SUM(accumulated_s)` por task |
| tasks_by_workflow | tasks + rules + workflows | JOIN via `created_from_rule_id` |

### Archivos clave (frontend)

```
apps/client/src/scrumbringer_client/ui/tabs.gleam (nuevo)
apps/client/src/scrumbringer_client/features/milestones/view.gleam
apps/client/src/scrumbringer_client/features/cards/view.gleam
apps/client/src/scrumbringer_client/features/tasks/view.gleam
```

### Archivos clave (backend)

```
# Nuevos o extender
apps/server/src/scrumbringer_server/services/metrics_db.gleam (nuevo)
apps/server/src/scrumbringer_server/sql/metrics_*.sql (nuevos)

# Extender endpoints existentes
apps/server/src/scrumbringer_server/http/milestones.gleam
apps/server/src/scrumbringer_server/http/cards.gleam
apps/server/src/scrumbringer_server/http/tasks.gleam
```

### Refactor Alignment (docs/architecture/refactor-plan-detailed.md)

- Componente tabs en `ui/` para reutilización
- Métricas calculadas en backend, no en frontend
- Mantener views puros, cálculos en update/helpers

### Type Notes (gleam-type-system)

```gleam
/// Aggregated health metrics (used by Card and Milestone)
pub type ExecutionHealth {
  ExecutionHealth(
    avg_rebotes: Float,           // avg release_count across tasks
    avg_pool_lifetime: Duration,  // avg time tasks spent in Available
    avg_executors: Float,         // avg unique_executors per task
  )
}

/// Workflow distribution for a container (Card/Milestone)
pub type WorkflowMetrics {
  WorkflowMetrics(
    tasks_by_workflow: List(#(Option(String), Int)),  // (workflow_name, count)
    most_activated: Option(String),                   // workflow with most tasks
  )
}

pub type MilestoneMetrics {
  MilestoneMetrics(
    // Progress
    cards_total: Int,
    cards_completed: Int,
    tasks_total: Int,
    tasks_completed: Int,
    // State breakdown
    tasks_available: Int,
    tasks_claimed: Int,
    tasks_ongoing: Int,
    // Health
    health: ExecutionHealth,
    // Workflows
    workflows: WorkflowMetrics,
  )
}

pub type CardMetrics {
  CardMetrics(
    // Progress
    tasks_total: Int,
    tasks_completed: Int,
    // State breakdown
    tasks_available: Int,
    tasks_claimed: Int,
    tasks_ongoing: Int,
    // Health
    health: ExecutionHealth,
    // Workflows
    workflows: WorkflowMetrics,
  )
}

pub type TaskMetrics {
  TaskMetrics(
    // Claims
    claim_count: Int,
    release_count: Int,              // "rebotes"
    unique_executors: Int,           // distinct people who claimed
    first_claim_at: Option(Time),
    // Time tracking
    time_in_current_state: Duration,
    pool_lifetime: Duration,         // accumulated time in Available
    // Work sessions
    session_count: Int,
    total_work_time: Duration,
  )
}
```

---

## Testing

- Tests de componente tabs
- Tests de queries de métricas (backend)
- Tests de agregación (ExecutionHealth, WorkflowMetrics)
- Tests de vista (frontend)

### TDD (gleam-tdd-development)

- Definir tipos de métricas primero (TaskMetrics, CardMetrics, MilestoneMetrics)
- Escribir tests de queries de agregación antes de implementar
- Tests de render con datos mock para cada nivel

### Datos de prueba

Los tests asumen que existen en seed:
- Tasks con múltiples claims/releases (para probar rebotes)
- Tasks creadas por workflows (para probar trazabilidad)
- Work sessions con tiempo acumulado

---

## Out of Scope

- Métricas avanzadas (tendencias, predicciones)
- Exportación de métricas
- Gráficos históricos
- Comparativas entre elementos
- Vista de métricas a nivel proyecto (sprint futuro dedicado)
- Métricas de persona/equipo
- Alertas basadas en métricas (ej: "task lleva 3 días en pool")

---

## Change Log

| Fecha | Version | Descripcion | Autor |
|-------|---------|-------------|-------|
| 2026-02-06 | 1.0 | Historia creada para sprint 7 | UX/PO |
| 2026-02-06 | 1.1 | Métricas ampliadas: rebotes, pool_lifetime, ejecutores únicos, workflows | Analyst |
| 2026-02-06 | 1.2 | Simplificada: cambios de modelo movidos a 7.4 como prerrequisito | Analyst |

---

## Dev Agent Record

### Agent Model Used

TBD

### Debug Log References

- TBD

### Completion Notes List

- TBD

### File List

- TBD

---

## QA Results

### Review Date: TBD

### Reviewed By: TBD

### Gate Status

Gate: TBD
