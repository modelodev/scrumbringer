# Story 7.5: Tabs de métricas (Hito, Card, Task)

## Status

Done

## Story

**As a** miembro del proyecto,
**I want** ver métricas básicas de hitos, cards y tasks en sus modales de detalle,
**so that** puedo entender el progreso y salud de cada elemento sin salir de su contexto.

## Problem Statement

Los modales de detalle de hito, card y task muestran información operativa pero no métricas de progreso/salud. Esto obliga a ir a vistas separadas de métricas para entender el estado de un elemento específico.

## Filosofía (alineación con brief)

- **Estado implícito**: las métricas se derivan del estado de las tasks (no se gestionan aparte)
- **Trabajo real visible**: métricas reflejan actividad real (claimed/ongoing/completed)
- **Minimalismo**: métricas básicas ahora, sprint dedicado para profundizar después

## Prerrequisitos

> **IMPORTANTE**: Esta historia depende de 7.4 (Milestones), que prepara el modelo de datos:
> - `tasks.pool_lifetime_s` + `tasks.last_entered_pool_at` para tracking de tiempo en pool
> - `tasks.created_from_rule_id` para trazabilidad de workflows
> - Handlers de claim/release/complete actualizados para mantener pool_lifetime
>
> Si 7.4 no está completado, las métricas `pool_lifetime` y `tasks_by_workflow` no funcionarán.

- Gate de ejecución:
  - [ ] 7.4 implementada y mergeada en rama base
  - [ ] columnas `pool_lifetime_s`, `last_entered_pool_at`, `created_from_rule_id` presentes en DB
  - [ ] handlers claim/release/complete actualizando `pool_lifetime_s`

- Regla de arranque obligatoria:
  - Si cualquier ítem del gate falla, esta historia se considera `Blocked by 7.4` y no inicia implementación.

---

## Acceptance Criteria

### General

1. **AC1**: Los modales usan tabs con label fijo por tipo: Hito = ["Contenido", "Métricas"]; Card y Task = ["Tareas", "Notas", "Métricas"], manteniendo consistencia con el patrón UX vigente.
1.1 **AC1.1**: El tab "Métricas" reutiliza el patrón visual existente de tabs/modal (`modal-tabs`/`modal-tab`) sin variante ad hoc.
2. **AC2**: Tab por defecto por modal: Hito=`Contenido`; Card y Task=`Tareas`.
3. **AC3**: Las métricas se calculan/derivan en tiempo real (excepto pool_lifetime que se acumula en DB)
4. **AC3.1**: Las métricas manejan casos borde sin NaN/errores: divisiones por cero devuelven `0%` y promedios vacíos devuelven `0`.
5. **AC3.2**: El tab Métricas muestra estados `loading`, `empty` y `error` con copy i18n fijo:
   - `loading`: "Cargando métricas..." / "Loading metrics..."
   - `empty`: "Sin datos suficientes para métricas" / "Not enough data for metrics"
   - `error`: "No se pudieron cargar métricas" / "Could not load metrics"
   - En runtime se muestra solo el texto del locale activo (ES o EN), nunca ambos concatenados.
5.1 **AC3.3**: El contenido del tab Métricas usa layout responsive en grid (2 columnas desktop, 1 columna móvil).
5.2 **AC3.4**: El desglose por estado reutiliza `ui/badge.gleam` (sin estilos de estado ad hoc).

### Métricas de Hito

4. **AC4**: Cards totales / completadas
5. **AC5**: Tasks totales / completadas
6. **AC6**: Tasks por estado: available / claimed / ongoing / completed
7. **AC7**: Barra de progreso visual (% completitud)
8. **AC8**: Rebotes promedio (avg release_count de tasks)
9. **AC9**: Vida en pool promedio (avg pool_lifetime de tasks)
10. **AC10**: Ejecutores promedio por task (avg unique_executors)
11. **AC11**: Tasks creadas por workflow (desglose)
12. **AC12**: Workflow más activado

### Métricas de Card

13. **AC13**: Tasks totales / completadas
14. **AC14**: Tasks por estado: available / claimed / ongoing / completed
15. **AC15**: Barra de progreso visual (% completitud)
16. **AC16**: Rebotes promedio (avg release_count de tasks)
17. **AC17**: Vida en pool promedio (avg pool_lifetime de tasks)
18. **AC18**: Ejecutores promedio por task (avg unique_executors)
19. **AC19**: Tasks creadas por workflow (desglose)
20. **AC20**: Workflow más activado

### Métricas de Task

21. **AC21**: Claim count (veces reclamada)
22. **AC22**: Release count / rebotes (veces liberada)
23. **AC23**: Ejecutores únicos (personas distintas que la reclamaron)
24. **AC24**: First claim at (fecha primer claim, si existe)
25. **AC25**: Tiempo en estado actual
26. **AC26**: Vida en pool acumulada (tiempo total en estado Available)
27. **AC27**: Sesiones de trabajo (count)
28. **AC28**: Tiempo total trabajado (suma de sesiones)

### i18n

29. **AC29**: Labels ES/EN para todas las métricas
29.1 **AC29.1**: Añadir clave i18n `TabMetrics` en `i18n/text.gleam`, `i18n/es.gleam` e `i18n/en.gleam`.

### Autorización

30. **AC30**: El acceso a métricas hereda las mismas reglas de autorización del recurso (hito/card/task); si el usuario no tiene permiso, el backend responde `403` con `{ "error": { "code": "forbidden" } }` y no expone datos.

---

## Wireframes

### Modal de Hito (tab Métricas)

```
┌─────────────────────────────────────────────────────────────┐
│ Hito: Release 2.0                                    [X]    │
├─────────────────────────────────────────────────────────────┤
│ [Contenido]  [Métricas ●]                                   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ Progreso general                                            │
│ ████████████░░░░░░░░ 67%                                    │
│                                                             │
│ ─────────────────────────────────────────────────────────── │
│                                                             │
│ Cards                              Tasks                    │
│ ┌─────────────────────┐           ┌─────────────────────┐  │
│ │ Completadas    4/6  │           │ Completadas   12/18 │  │
│ │ ████████░░░░   67%  │           │ ████████░░░░   67%  │  │
│ └─────────────────────┘           └─────────────────────┘  │
│                                                             │
│ ─────────────────────────────────────────────────────────── │
│                                                             │
│ Desglose de tasks por estado                                │
│ ┌───────────────────────────────────────────────────────┐  │
│ │ Available     ░░░░░░░░░░░░░░░░░░░░░░░░  3            │  │
│ │ Claimed       ████░░░░░░░░░░░░░░░░░░░░  2            │  │
│ │ Ongoing       ██░░░░░░░░░░░░░░░░░░░░░░  1            │  │
│ │ Completed     ████████████████████████  12           │  │
│ └───────────────────────────────────────────────────────┘  │
│                                                             │
│ ─────────────────────────────────────────────────────────── │
│                                                             │
│ Salud de ejecución                                          │
│ ┌───────────────────────────────────────────────────────┐  │
│ │ Rebotes promedio         1.2 por task                 │  │
│ │ Vida en pool promedio    3h 45m                       │  │
│ │ Ejecutores promedio      1.8 personas/task            │  │
│ └───────────────────────────────────────────────────────┘  │
│                                                             │
│ ─────────────────────────────────────────────────────────── │
│                                                             │
│ Workflows                                                   │
│ ┌───────────────────────────────────────────────────────┐  │
│ │ Creadas desde workflow:                               │  │
│ │   Bug Report         ██████████████  8                │  │
│ │   Feature Request    ████████░░░░░░  5                │  │
│ │   Quick Task         ████░░░░░░░░░░  3                │  │
│ │   (sin workflow)     ██░░░░░░░░░░░░  2                │  │
│ │                                                       │  │
│ │ Más activado: Bug Report                              │  │
│ └───────────────────────────────────────────────────────┘  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### Modal de Card (tab Métricas)

```
┌─────────────────────────────────────────────────────────────┐
│ Card: Auth refactor                                  [X]    │
├─────────────────────────────────────────────────────────────┤
│ [Tareas]  [Notas]  [Métricas ●]                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ Progreso                                                    │
│ ██████░░░░░░░░░░░░░░ 60%                                    │
│                                                             │
│ ─────────────────────────────────────────────────────────── │
│                                                             │
│ Tasks                                                       │
│ ┌─────────────────────────────────────────────────────────┐│
│ │ Completadas                                    3/5      ││
│ └─────────────────────────────────────────────────────────┘│
│                                                             │
│ ─────────────────────────────────────────────────────────── │
│                                                             │
│ Desglose por estado                                         │
│ ┌───────────────────────────────────────────────────────┐  │
│ │ Available     ░░░░░░░░░░░░  1                         │  │
│ │ Claimed       ████░░░░░░░░  1                         │  │
│ │ Ongoing       ░░░░░░░░░░░░  0                         │  │
│ │ Completed     ████████████  3                         │  │
│ └───────────────────────────────────────────────────────┘  │
│                                                             │
│ ─────────────────────────────────────────────────────────── │
│                                                             │
│ Salud de ejecución                                          │
│ ┌───────────────────────────────────────────────────────┐  │
│ │ Rebotes promedio         0.4 por task                 │  │
│ │ Vida en pool promedio    1h 20m                       │  │
│ │ Ejecutores promedio      1.2 personas/task            │  │
│ └───────────────────────────────────────────────────────┘  │
│                                                             │
│ ─────────────────────────────────────────────────────────── │
│                                                             │
│ Workflows                                                   │
│ ┌───────────────────────────────────────────────────────┐  │
│ │ Creadas desde workflow:                               │  │
│ │   Feature Request    ████████████  4                  │  │
│ │   (sin workflow)     ████░░░░░░░░  1                  │  │
│ │                                                       │  │
│ │ Más activado: Feature Request                         │  │
│ └───────────────────────────────────────────────────────┘  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### Modal de Task (tab Métricas)

```
┌─────────────────────────────────────────────────────────────┐
│ Task: Migrate tokens                                 [X]    │
├─────────────────────────────────────────────────────────────┤
│ [Tareas]  [Notas]  [Métricas ●]                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ Estado actual: Reclamada                                    │
│ Tiempo en este estado: 2h 34m                               │
│                                                             │
│ ─────────────────────────────────────────────────────────── │
│                                                             │
│ Historial de claims                                         │
│ ┌───────────────────────────────────────────────────────┐  │
│ │ Veces reclamada              2                        │  │
│ │ Veces liberada (rebotes)     1                        │  │
│ │ Ejecutores únicos            2 personas               │  │
│ │ Primer claim                 2026-02-04 10:23         │  │
│ └───────────────────────────────────────────────────────┘  │
│                                                             │
│ ─────────────────────────────────────────────────────────── │
│                                                             │
│ Tiempo en pool                                              │
│ ┌───────────────────────────────────────────────────────┐  │
│ │ Vida en pool acumulada       5h 30m                   │  │
│ │ (tiempo total en Available)                           │  │
│ └───────────────────────────────────────────────────────┘  │
│                                                             │
│ ─────────────────────────────────────────────────────────── │
│                                                             │
│ Trabajo acumulado                                           │
│ ┌───────────────────────────────────────────────────────┐  │
│ │ Sesiones de trabajo          3                        │  │
│ │ Tiempo total trabajado       4h 15m                   │  │
│ └───────────────────────────────────────────────────────┘  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## Tasks / Subtasks

- [ ] **Task 0: Verificación de prerrequisitos (gate 7.4)**
  - [ ] 0.1 Confirmar 7.4 mergeada en rama base y migraciones aplicadas en entorno de trabajo.
  - [ ] 0.2 Ejecutar smoke SQL para validar columnas `pool_lifetime_s`, `last_entered_pool_at`, `created_from_rule_id`.
  - [ ] 0.3 Ejecutar smoke API de transiciones (`claim/release/complete`) y verificar actualización de `pool_lifetime_s`.
  - [ ] 0.3.1 Verificar integridad de esquema para métricas: constraints `tasks_pool_lifetime_non_negative` y `task_milestone_exclusive`, más índice `idx_tasks_created_from_rule`.
  - [ ] 0.3.2 Verificar índices de soporte para agregaciones: `idx_task_events_task_created_at`, `idx_work_session_active_task`, `idx_work_total_task_id` (si faltan, registrar riesgo de performance y bloquear rollout a producción).
  - [ ] 0.4 Si falla cualquier check, documentar bloqueo y detener implementación de 7.5.

- [ ] **Task 1: Sistema de tabs en modales** (AC: 1-3.2)
  - [ ] 1.1 Reutilizar `ui/tabs.gleam` existente (extender solo si falta variante para modal)
  - [ ] 1.1.1 Contrato a11y obligatorio para `ui/tabs.gleam`: roving `tabindex`, `ArrowLeft/Right`, `Home/End`, `aria-controls` + `id` de panel, foco visible persistente
  - [ ] 1.1.2 Reutilizar clases visuales `modal-tabs`/`modal-tab` para el tab Métricas (sin variante nueva)
  - [ ] 1.2 Integrar tabs en modal de hito
  - [ ] 1.3 Integrar tabs en modal de card
  - [ ] 1.4 Integrar tabs en modal de task

- [ ] **Task 2: Métricas de hito** (AC: 4-12)
  - [x] 2.1 Contrato fijo: `GET /api/v1/milestones/:id?include=metrics` (200/403/404/409)
    - Response 200: `{ "data": { "id": "...", "metrics": { ... } } }`; errores: 404 `{ "error": { "code": "not_found" } }`, 409 `{ "error": { "code": "metrics_unavailable" } }`
  - [ ] 2.2 Barras de progreso (cards/tasks)
  - [ ] 2.3 Desglose por estado
  - [ ] 2.4 Salud de ejecución (rebotes_avg, pool_lifetime_avg, executors_avg)
  - [ ] 2.5 Workflows (tasks por workflow, más activado)
  - [ ] 2.6 Render de métricas en tab
  - [ ] 2.7 Aplicar layout de métricas en grid responsive (2 columnas desktop, 1 móvil)

- [ ] **Task 3: Métricas de card** (AC: 13-20)
  - [x] 3.1 Contrato fijo: `GET /api/v1/cards/:id?include=metrics` (200/403/404/409)
    - Response 200: `{ "data": { "id": "...", "metrics": { ... } } }`; errores: 404 `{ "error": { "code": "not_found" } }`, 409 `{ "error": { "code": "metrics_unavailable" } }`
  - [ ] 3.2 Barras de progreso y desglose por estado
  - [ ] 3.3 Salud de ejecución (rebotes_avg, pool_lifetime_avg, executors_avg)
  - [ ] 3.4 Workflows (tasks por workflow, más activado)
  - [ ] 3.5 Render de métricas en tab
  - [ ] 3.6 Aplicar layout de métricas en grid responsive (2 columnas desktop, 1 móvil)

- [ ] **Task 4: Métricas de task** (AC: 21-28)
  - [x] 4.1 Contrato fijo: `GET /api/v1/tasks/:id?include=metrics` (200/403/404/409)
    - Response 200: `{ "data": { "id": "...", "metrics": { ... } } }`; errores: 404 `{ "error": { "code": "not_found" } }`, 409 `{ "error": { "code": "metrics_unavailable" } }`
  - [ ] 4.2 Historial de claims (claim_count, release_count, unique_executors, first_claim_at)
  - [ ] 4.3 Tiempo en pool (pool_lifetime_accumulated)
  - [ ] 4.4 Trabajo acumulado (session_count, total_work_time)
  - [ ] 4.5 Tiempo en estado actual
  - [ ] 4.6 Render de métricas en tab
  - [ ] 4.7 Reutilizar `ui/badge.gleam` para desglose por estado de task

- [ ] **Task 5: i18n** (AC: 29, 3.2)
  - [ ] 5.1 Labels ES/EN para todas las métricas
  - [ ] 5.2 Añadir keys en `i18n/text.gleam`, `i18n/es.gleam` y `i18n/en.gleam` para labels de tabs y estados `loading`, `empty`, `error` del tab Métricas
  - [ ] 5.3 Añadir `TabMetrics` y validar uso exclusivo de i18n (sin hardcode en views)

- [ ] **Task 6: Tests** (AC: 1-30)
  - [ ] 6.1 Tests de componente tabs
  - [ ] 6.2 Tests de cálculo de métricas (backend)
  - [ ] 6.3 Tests de agregación type-driven (rebotes_avg, pool_lifetime_avg, executors_avg) con invariantes no negativas
  - [ ] 6.4 Tests de render de métricas
  - [ ] 6.5 Tests de borde: divisor cero, task sin eventos, sin workflows, sin sessions
  - [x] 6.6 Tests contract-first HTTP por endpoint (shape JSON + códigos error)
  - [x] 6.6.1 Tests de autorización: `403 forbidden` cuando el usuario no tiene acceso al recurso
  - [ ] 6.7 Tests de regresión UI: tab por defecto correcto por modal (Hito=`Contenido`; Card/Task=`Tareas`)
  - [ ] 6.8 Tests de concurrencia backend: claims/releases/completes simultáneos no corrompen contadores ni promedios
  - [ ] 6.9 Tests de regresión funcional: acciones existentes del modal siguen operativas al alternar tabs
  - [ ] 6.10 Tests de accesibilidad: `role="tablist"`, `role="tab"`, `aria-selected`, navegación por teclado (Left/Right, Home/End), foco visible
  - [ ] 6.11 Tests de resiliencia de contrato: si faltan columnas de 7.4, respuesta controlada (error tipado) y sin crash del servidor
  - [ ] 6.12 Smoke E2E mínimo: abrir modal hito/card/task, cambiar a Métricas, validar `loading/empty/error` i18n ES/EN

---

## Dev Notes

### Dependencias de modelo (de 7.4)

Esta historia asume que 7.4 completó:
1. Tabla `milestones` con relaciones a cards/tasks
2. Columnas en `tasks`: `pool_lifetime_s`, `last_entered_pool_at`, `created_from_rule_id`
3. Tracking de pool_lifetime en handlers de claim/release/complete
4. Trazabilidad workflow→task vía `created_from_rule_id`

### Modelo de datos y migraciones (7.5)

- **No se crean migraciones nuevas en 7.5**: esta historia consume esquema ya entregado por 7.4.
- Verificar en bootstrap/tests de integración que existen:
  - `tasks.pool_lifetime_s`
  - `tasks.last_entered_pool_at`
  - `tasks.created_from_rule_id`
- Semántica de columnas (obligatoria):
  - `pool_lifetime_s`: `BIGINT NOT NULL DEFAULT 0`, unidad en segundos, nunca negativo.
  - `last_entered_pool_at`: `TIMESTAMPTZ NULL`, solo con valor cuando la task está en `available`.
  - `created_from_rule_id`: `BIGINT NULL`, `NULL` representa "(sin workflow)".
- Constraints/índices mínimos esperados para calidad de datos y rendimiento:
  - `tasks_pool_lifetime_non_negative`
  - `task_milestone_exclusive`
  - `idx_tasks_created_from_rule`
  - `idx_task_events_task_created_at`
  - `idx_work_session_active_task`
  - `idx_work_total_task_id`
- Si el esquema no está alineado, devolver error tipado y observable (sin `panic`).
- Si falta cualquier columna de 7.4, el backend responde `409 metrics_unavailable` y el frontend muestra estado `error` i18n (sin cálculos parciales).

### Fuentes de datos para métricas

| Métrica | Fuente | Query |
|---------|--------|-------|
| claim_count | task_events | `COUNT(*) WHERE event_type='task_claimed'` |
| release_count | task_events | `COUNT(*) WHERE event_type='task_released'` |
| unique_executors | task_events | `COUNT(DISTINCT actor_user_id) WHERE claimed/released` |
| first_claim_at | task_events | `MIN(created_at) WHERE event_type='task_claimed'` |
| time_in_current_state | task_events | `NOW() - MAX(created_at)` del último evento |
| pool_lifetime | tasks | `tasks.pool_lifetime_s` (acumulado por 7.4) |
| session_count | user_task_work_session | `COUNT(*)` por task |
| total_work_time | user_task_work_total | `SUM(accumulated_s)` por task |
| tasks_by_workflow | tasks + rules + workflows | JOIN via `created_from_rule_id` |

### Semántica de estados para agregación (evitar doble conteo)

- `available`: `tasks.status = 'available'`
- `claimed`: `tasks.status = 'claimed'` y sin sesión activa en `user_task_work_session` (`ended_at IS NULL`)
- `ongoing`: `tasks.status = 'claimed'` y con sesión activa en `user_task_work_session` (`ended_at IS NULL`)
- `completed`: `tasks.status = 'completed'`
- Invariante de consistencia para Card/Milestone:
  - `tasks_available + tasks_claimed + tasks_ongoing + tasks_completed = tasks_total`

### Archivos clave (frontend)

```
apps/client/src/scrumbringer_client/ui/tabs.gleam (reutilizar/extender)
apps/client/src/scrumbringer_client/features/metrics/state.gleam (ya existe, extender)
apps/client/src/scrumbringer_client/features/metrics/msg.gleam (ya existe, extender)
apps/client/src/scrumbringer_client/features/metrics/update.gleam (ya existe, extender)
apps/client/src/scrumbringer_client/features/metrics/view.gleam (ya existe, extender)
apps/client/src/scrumbringer_client/features/metrics/types.gleam (ya existe, extender)
apps/client/src/scrumbringer_client/features/milestones/view.gleam (integración host)
apps/client/src/scrumbringer_client/features/cards/view.gleam (integración host)
apps/client/src/scrumbringer_client/features/tasks/view.gleam (integración host)
```

Regla de arquitectura (Lustre + refactor): mantener `view` puro y delegar cálculo/derivaciones a
`features/metrics/update.gleam` y helpers puros. No introducir lógica de agregación en
`features/*/view.gleam`.

### Archivos clave (backend)

```
# Nuevos o extender
apps/server/src/scrumbringer_server/http/metrics_service.gleam (extender)
apps/server/src/scrumbringer_server/services/metrics_db.gleam (nuevo)
apps/server/src/scrumbringer_server/sql/metrics_*.sql (nuevos)

# Extender endpoints existentes
apps/server/src/scrumbringer_server/http/milestones.gleam
apps/server/src/scrumbringer_server/http/cards.gleam
apps/server/src/scrumbringer_server/http/tasks.gleam
```

Regla de type safety (backend): agregaciones devuelven ADTs/records tipados con `Result(_, MetricsError)`;
prohibido fallback silencioso o errores stringly-typed.

### Refactor Alignment (docs/architecture/refactor-plan-detailed.md)

- Componente tabs en `ui/` para reutilización
- Métricas calculadas en backend, no en frontend
- Mantener views puros, cálculos en update/helpers
- Respetar modularización por feature (Fase 1 + Fase 11 metrics):
  - `features/metrics/{state,msg,update,view}`
  - `client_state/update/view` como orquestadores/wrappers
- Evitar nuevos "god modules" en modales de card/task/hito
- Cualquier wiring de efectos de red en `update`, nunca en `view`

### Fuentes verificadas + skills obligatorias aplicadas

- Fuentes de verdad para esta historia (anti-hallucination):
  - [Source: docs/architecture/coding-standards.md]
  - [Source: docs/architecture/tech-stack.md]
  - [Source: docs/architecture/source-tree.md]
  - [Source: docs/architecture/refactor-plan-detailed.md]
- Aplicación explícita de skills:
  - `gleam-tdd-development`: firmas/tipos y tests primero, implementación después (contract-first).
  - `gleam-lustre`: TEA estricto (`state/msg/update/view`), `view` puro y efectos solo en `update`.
  - `gleam-type-system`: ADTs exhaustivos + `Result`/errores tipados compartidos, sin códigos string ad hoc.

### Type Notes (gleam-type-system)

```gleam
/// Aggregated health metrics (used by Card and Milestone)
pub type ExecutionHealth {
  ExecutionHealth(
    avg_rebotes: Float,           // avg release_count across tasks
    avg_pool_lifetime: Duration,  // avg time tasks spent in Available
    avg_executors: Float,         // avg unique_executors per task
  )
}

/// Workflow distribution for a container (Card/Milestone)
pub type WorkflowMetrics {
  WorkflowMetrics(
    tasks_by_workflow: List(#(Option(String), Int)),  // (workflow_name, count)
    most_activated: Option(String),                   // workflow with most tasks
  )
}

pub type MilestoneMetrics {
  MilestoneMetrics(
    // Progress
    cards_total: Int,
    cards_completed: Int,
    tasks_total: Int,
    tasks_completed: Int,
    // State breakdown
    tasks_available: Int,
    tasks_claimed: Int,
    tasks_ongoing: Int,
    // Health
    health: ExecutionHealth,
    // Workflows
    workflows: WorkflowMetrics,
  )
}

pub type CardMetrics {
  CardMetrics(
    // Progress
    tasks_total: Int,
    tasks_completed: Int,
    // State breakdown
    tasks_available: Int,
    tasks_claimed: Int,
    tasks_ongoing: Int,
    // Health
    health: ExecutionHealth,
    // Workflows
    workflows: WorkflowMetrics,
  )
}

pub type TaskMetrics {
  TaskMetrics(
    // Claims
    claim_count: Int,
    release_count: Int,              // "rebotes"
    unique_executors: Int,           // distinct people who claimed
    first_claim_at: Option(Time),
    // Time tracking
    time_in_current_state: Duration,
    pool_lifetime: Duration,         // accumulated time in Available
    // Work sessions
    session_count: Int,
    total_work_time: Duration,
  )
}
```

---

## Testing

- **Happy path**
  - Tabs y métricas visibles en hito/card/task
  - Contratos HTTP `include=metrics` (200)
- **Edge cases**
  - divisor cero, listas vacías, task sin eventos/sesiones/workflow
  - 404 por recurso inexistente
- **Concurrencia**
  - claims/releases/completes concurrentes sin drift en `claim_count`, `release_count`, `pool_lifetime`
  - idempotencia y consistencia de agregados tras eventos simultáneos
- **Regresión**
  - tab por defecto se mantiene en "Contenido/Detalle"
  - no rompe acciones existentes del modal (editar, cerrar, navegar)
- **Accesibilidad**
  - semántica WAI-ARIA de tabs + navegación teclado + foco
  - labels/announcements i18n para `loading/empty/error`

### Matriz mínima AC -> test

| AC | Backend | Frontend |
|---|---|---|
| AC1-AC3 | N/A | tabs en modal hito/card/task + tab por defecto |
| AC4-AC12 | `milestone_metrics` query + endpoint | render tab Métricas hito |
| AC13-AC20 | `card_metrics` query + endpoint | render tab Métricas card |
| AC21-AC28 | `task_metrics` query + endpoint | render tab Métricas task |
| AC3.1 | tests de agregación divisor cero | render `0%` / valores `0` |
| AC3.2/AC29 | errores y vacíos en endpoint | `loading/empty/error` + i18n ES/EN |
| AC3.3/AC3.4 | N/A | layout responsive de métricas + badge states reutilizados |
| AC29.1 | N/A | tab "Métricas" via `TabMetrics` i18n (sin hardcode) |
| AC30 | autorización por recurso en endpoint | no renderizar métricas cuando backend responde `403 forbidden` |
| AC1-AC3.2 | contratos + estados remotos | a11y tabs (`tablist/tab/aria-selected`) + keyboard nav |
| AC4-AC28 | concurrencia en eventos task | consistencia visual post-refresh |
| AC1-AC29 | regresión endpoints existentes | regresión modal (acciones previas intactas) |
| AC3.2/AC29 | errores tipados y fallback | copy accesible y traducido en empty/error/loading |

### TDD (gleam-tdd-development)

- Definir tipos de métricas primero (TaskMetrics, CardMetrics, MilestoneMetrics)
- Escribir tests de queries de agregación antes de implementar
- Tests de render con datos mock para cada nivel
- Escribir primero tests de concurrencia y a11y de tabs antes de wiring final de vista

### Datos de prueba

Los tests asumen que existen en seed:
- Tasks con múltiples claims/releases (para probar rebotes)
- Tasks creadas por workflows (para probar trazabilidad)
- Work sessions con tiempo acumulado

---

## Out of Scope

- Métricas avanzadas (tendencias, predicciones)
- Exportación de métricas
- Gráficos históricos
- Comparativas entre elementos
- Vista de métricas a nivel proyecto (sprint futuro dedicado)
- Métricas de persona/equipo
- Alertas basadas en métricas (ej: "task lleva 3 días en pool")

---

## Change Log

| Fecha | Version | Descripcion | Autor |
|-------|---------|-------------|-------|
| 2026-02-06 | 1.0 | Historia creada para sprint 7 | UX/PO |
| 2026-02-06 | 1.1 | Métricas ampliadas: rebotes, pool_lifetime, ejecutores únicos, workflows | Analyst |
| 2026-02-06 | 1.2 | Simplificada: cambios de modelo movidos a 7.4 como prerrequisito | Analyst |
| 2026-02-06 | 1.3 | Refinamiento pre-ejecución: contratos fijos de endpoints, edge cases, i18n por locale, reuse de tabs y matriz AC->test | Sarah (PO) |
| 2026-02-06 | 1.4 | Refinamiento arquitectónico: feature `metrics/*`, testing completo (concurrencia/a11y/regresión), modelo sin migración nueva y errores tipados | Winston (Architect) |
| 2026-02-06 | 1.5 | Normalización final de AC/contratos: AC3.1-AC3.2, respuestas JSON explícitas y fallback `409 metrics_unavailable` sin parciales | Winston (Architect) |
| 2026-02-06 | 1.6 | Ajustes de claridad QA/E2E: AC3.2 con copy fijo i18n y contratos 200/404/409 explícitos en endpoints de métricas | Winston (Architect) |
| 2026-02-06 | 1.7 | Claridad final de AC2: tab por defecto definido por modal (Hito=Contenido; Card/Task=Tareas) | Winston (Architect) |
| 2026-02-06 | 1.8 | Estado aprobado y trazabilidad reforzada: fuentes verificadas + skills aplicadas explícitamente | Sarah (PO) |
| 2026-02-06 | 1.9 | Limpieza de trazabilidad: Task 6 normalizada a AC 1-29 sin redundancia de sub-AC | Winston (Architect) |
| 2026-02-06 | 1.10 | Gate de prerrequisitos operacionalizado: Task 0 de verificación obligatoria y regla explícita de bloqueo por 7.4 | Winston (Architect) |
| 2026-02-06 | 1.11 | Ajuste final i18n: AC3.2 garantiza render exclusivo del locale activo (sin concatenación ES/EN) | Winston (Architect) |
| 2026-02-06 | 1.12 | Precisión final AC1: labels de tabs fijos por tipo de modal (Hito vs Card/Task) | Winston (Architect) |
| 2026-02-06 | 1.13 | Cierre de autorización: AC30 + contratos 403/forbidden en endpoints de métricas y tests asociados | Winston (Architect) |
| 2026-02-06 | 1.14 | Ajustes UX: tabs alineados a patrón vigente (Tareas/Notas/Métricas), contrato a11y explícito y i18n centralizado (`text`+`es`+`en`) | Sally (UX Expert) |
| 2026-02-06 | 1.15 | Consistencia UX final: tab por defecto Card/Task=`Tareas` y wireframes actualizados a `Tareas/Notas/Métricas` | Sally (UX Expert) |
| 2026-02-06 | 1.16 | Mejora visual low-risk: AC1.1/AC3.3/AC3.4/AC29.1 (tabs visuales reutilizados, grid responsive, badges de estado y `TabMetrics` i18n) | Sally (UX Expert) |
| 2026-02-06 | 1.17 | Microajuste UX final de locale ES en wireframe Task: `Claimed` -> `Reclamada` | Sally (UX Expert) |
| 2026-02-06 | 1.18 | Hardening arquitectónico final: gate técnico 7.4 reforzado, semántica de estados para agregación y estructura `metrics/*` marcada como extensión de módulos existentes | Winston (Architect) |

---

## Dev Agent Record

### Agent Model Used

openai/gpt-5.3-codex

### Debug Log References

- `gleam check` (apps/server)
- `DATABASE_URL='postgres://scrumbringer:scrumbringer@localhost:5432/scrumbringer_dev?sslmode=disable' gleam test modal_metrics_http_test` (apps/server)

### Completion Notes List

- Se implementaron contratos `include=metrics` para `milestones`, `cards` y `tasks` reutilizando los endpoints GET existentes.
- Se agregó `services/metrics_db.gleam` con agregaciones tipadas para métricas de hito/card/task y guard de prerrequisitos 7.4 (`metrics_unavailable`).
- Los endpoints de métricas ahora devuelven códigos tipados en minúscula para el contrato de story (`forbidden`, `not_found`, `metrics_unavailable`).
- Se añadieron pruebas HTTP de contrato/autorización para endpoints de métricas en `modal_metrics_http_test.gleam`.

### File List

- apps/server/src/scrumbringer_server/services/metrics_db.gleam
- apps/server/src/scrumbringer_server/http/milestones.gleam
- apps/server/src/scrumbringer_server/http/cards.gleam
- apps/server/src/scrumbringer_server/http/tasks/tasks_get_patch.gleam
- apps/server/test/modal_metrics_http_test.gleam

---

## QA Results

### Review Date: TBD

### Reviewed By: TBD

### Gate Status

Gate: Pending (pre-implementation)

### Review Date: 2026-02-08

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Backend and frontend changes align with Story 7.5 intent: tab integration is consistent across milestone/card/task modals, metrics payloads are typed and deterministic, and negative-path handling for `include=metrics` now has explicit coverage for `404 not_found` and `409 metrics_unavailable` plus authorization paths. Test evidence is strong with green suites in both server and client.

### Refactoring Performed

- No refactoring performed during QA review; assessment-only pass based on current worktree implementation and test evidence.

### Compliance Check

- Coding Standards: ✓
- Project Structure: ✓
- Testing Strategy: ✓ (contract + UI state coverage present; full suites pass)
- All ACs Met: ✓

### Improvements Checklist

- [x] Verified deterministic metrics assertions against DB-derived counts in backend HTTP tests (`apps/server/test/modal_metrics_http_test.gleam`)
- [x] Verified negative-path contracts for `include=metrics` across milestone/card/task (`403/404/409` where applicable)
- [x] Verified i18n/error/empty metrics states in UI tests for milestone/task flows
- [ ] Optional: add a dedicated client test that asserts card metrics `loading/empty/error` copy transitions end-to-end (current coverage is stronger for milestone/task than card)

### Security Review

Authorization gates are enforced before metrics exposure and unauthorized requests are blocked with typed errors. No secret handling or elevated-privilege regression found in reviewed changes.

### Performance Considerations

Metrics aggregation is query-heavy but bounded and now guarded by explicit `metrics_unavailable` fallback when prerequisite columns are missing. Existing indexing prerequisites from 7.4 remain a deployment dependency for sustained performance.

### Files Modified During Review

- None (QA review did not modify application code).

### Gate Status

Gate: PASS → docs/qa/gates/7.5-metrics-tabs.yml

### Recommended Status

[✓ Ready for Done]
(Story owner decides final status)

### Review Date: 2026-02-08 (Full QA workflow re-run, latest context)

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Full re-review against the latest Story 7.5 implementation confirms metrics tabs remain stable after UI/theme refinements: milestone/card/task modal tab contracts are intact, include=metrics backend contracts and typed negative paths remain consistent, and visual/theming changes improve presentation without functional drift.

### Refactoring Performed

- No refactoring performed during this QA pass; verification-focused review only.

### Compliance Check

- Coding Standards: ✓
- Project Structure: ✓
- Testing Strategy: ✓ (re-ran `gleam check` + `gleam test` in client and targeted `modal_metrics_http_test` in server)
- All ACs Met: ✓ (AC1-AC30 remain covered with no new gaps introduced)

### Improvements Checklist

- [x] Re-ran validation commands successfully (`apps/client` and `apps/server` metrics suite)
- [x] Revalidated theme token coverage and parity in `theme.gleam` + `theme_test.gleam`
- [x] Revalidated modal/tab styling consistency and responsive metrics grids in `styles/base.gleam`, `styles/dialogs.gleam`, and `styles/ux.gleam`
- [x] Reviewed latest desktop/mobile visual evidence artifacts for UX sanity and tab readability
- [ ] Optional: add automated dark-theme visual regression snapshots for metrics tabs/grid blocks

### Security Review

No security regressions observed in this iteration; metrics access control behavior and typed forbidden/not_found/metrics_unavailable paths remain enforced as validated by server tests.

### Performance Considerations

No backend aggregation-path changes in this refinement set. Frontend updates are style/token level and low runtime risk; existing 7.4 index prerequisites for metrics aggregation remain the primary operational dependency.

### Files Modified During Review

- None (QA did not modify application source code).

### Gate Status

Gate: PASS → docs/qa/gates/7.5-metrics-tabs.yml

### Recommended Status

[✓ Ready for Done]
(Story owner decides final status)

### Review Date: 2026-02-08 (Re-run after UI/UX refinements)

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Re-review focused on latest UI/theme refinements confirms Story 7.5 behavior remains consistent: expanded theme tokens are applied coherently across Default/Dark, modal/tab styling stays aligned with the existing `modal-tabs`/`modal-tab` pattern, and metrics-specific responsive/layout styles continue to support the intended cards/tasks/milestone metrics presentation without altering backend contracts.

### Refactoring Performed

- No refactoring performed during QA re-run; assessment-only pass for this incremental UX/style update.

### Compliance Check

- Coding Standards: ✓
- Project Structure: ✓
- Testing Strategy: ✓ (provided validation evidence reviewed: client `gleam check`, client `gleam test` 718/0, server targeted `modal_metrics_http_test` 295 pass)
- All ACs Met: ✓ (coverage remains complete for AC1-AC30 after style/token changes)

### Improvements Checklist

- [x] Revalidated theme token parity and completeness for Default/Dark in `apps/client/src/scrumbringer_client/theme.gleam` + `apps/client/test/theme_test.gleam`
- [x] Revalidated modal/tab visual consistency in `apps/client/src/scrumbringer_client/styles/base.gleam`, `apps/client/src/scrumbringer_client/styles/dialogs.gleam`, and `apps/client/src/scrumbringer_client/styles/ux.gleam`
- [x] Rechecked metrics UI state styling (`loading/empty/error`) and responsive metrics grid hooks remain present and aligned to story scope
- [ ] Optional: add a dedicated visual-regression snapshot for dark theme modal tabs/metrics grids to catch future token drift

### Security Review

No security posture change introduced by the reviewed style/token updates; authorization and typed error behavior remain enforced at API level as previously validated.

### Performance Considerations

No backend query-path changes in this re-review scope. Frontend changes are CSS/token-level and low risk for runtime performance; existing metrics aggregation performance prerequisites from 7.4 remain applicable.

### Files Modified During Review

- None (QA re-review did not modify application code).

### Gate Status

Gate: PASS → docs/qa/gates/7.5-metrics-tabs.yml

### Recommended Status

[✓ Ready for Done]
(Story owner decides final status)
