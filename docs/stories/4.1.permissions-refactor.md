# Story 4.1: Permissions Refactor

## Status

Draft

## Story

**As a** developer,
**I want** a simplified and clear permission model with three distinct roles (Org Admin, Project Manager, Project Member),
**so that** authorization logic is consistent, predictable, and easy to maintain.

## Context

### Current State (Problematic)

- `project_members.role` uses `'admin'` which conflicts semantically with `users.org_role = 'admin'`
- Workflows and task_templates can be org-scoped (`project_id = NULL`) or project-scoped
- Capabilities are org-scoped only (`org_id`, no `project_id`)
- Project admins can assign other admins (should be org admin only)
- No typed ADT for project roles

### Target State

- Clear role hierarchy: **Org Admin > Project Manager > Project Member**
- All entities are **project-scoped only** (no org-scoped workflows/templates)
- Capabilities become **project-scoped**
- Only **Org Admin** can assign Project Managers
- Typed `ProjectRole` ADT in Gleam

## Acceptance Criteria

### Data Model

1. **AC1**: `project_members.role` accepts `'manager'` | `'member'` (migrate from `'admin'`)
2. **AC2**: `capabilities` table has `project_id NOT NULL` instead of `org_id`
3. **AC3**: `workflows.project_id` is `NOT NULL` (no org-scoped workflows)
4. **AC4**: `task_templates.project_id` is `NOT NULL` (no org-scoped templates)

### Authorization

5. **AC5**: Only Org Admin can assign `role = 'manager'` to project members
6. **AC6**: Project Manager can only add members with `role = 'member'`
7. **AC7**: Project Manager cannot demote themselves
8. **AC8**: Org Admin has implicit manager permissions on all projects

### Types

9. **AC9**: New `ProjectRole` ADT in `shared/src/domain/project_role.gleam`
10. **AC10**: `ProjectMember.role` uses `ProjectRole` type instead of `String`

### UI

11. **AC11**: Role selector in "Add Member" dialog shows only valid options based on current user's permissions
12. **AC12**: Project Managers see "Manager" | "Member" labels (not "Admin")

## Tasks / Subtasks

### Phase 1: Database Migration

- [ ] **Task 1.1: Migrate project_members.role** (AC: 1)
  - [ ] Create migration `YYYYMMDD_rename_project_role_admin_to_manager.sql`
  - [ ] `UPDATE project_members SET role = 'manager' WHERE role = 'admin'`
  - [ ] `ALTER TABLE project_members DROP CONSTRAINT project_members_role_check`
  - [ ] `ALTER TABLE project_members ADD CONSTRAINT project_members_role_check CHECK (role IN ('manager', 'member'))`

- [ ] **Task 1.2: Migrate capabilities to project-scoped** (AC: 2)
  - [ ] Create migration `YYYYMMDD_capabilities_project_scoped.sql`
  - [ ] Add `project_id INT REFERENCES projects(id)`
  - [ ] Populate `project_id` from existing data (requires strategy - see Dev Notes)
  - [ ] Drop `org_id` column
  - [ ] Update unique constraint to `(name, project_id)`

- [ ] **Task 1.3: Make workflows project-only** (AC: 3)
  - [ ] Create migration `YYYYMMDD_workflows_project_only.sql`
  - [ ] Delete org-scoped workflows: `DELETE FROM workflows WHERE project_id IS NULL`
  - [ ] `ALTER TABLE workflows ALTER COLUMN project_id SET NOT NULL`

- [ ] **Task 1.4: Make task_templates project-only** (AC: 4)
  - [ ] Create migration `YYYYMMDD_task_templates_project_only.sql`
  - [ ] Delete org-scoped templates: `DELETE FROM task_templates WHERE project_id IS NULL`
  - [ ] `ALTER TABLE task_templates ALTER COLUMN project_id SET NOT NULL`

- [ ] **Task 1.5: Run squirrel to regenerate sql.gleam**
  - [ ] `gleam run -m squirrel`
  - [ ] Verify generated code compiles

### Phase 2: Domain Types

- [ ] **Task 2.1: Create ProjectRole ADT** (AC: 9)
  - [ ] Create `shared/src/domain/project_role.gleam`
  - [ ] Define `pub type ProjectRole { Manager, Member }`
  - [ ] Add `to_string()` and `parse()` functions

- [ ] **Task 2.2: Update ProjectMember type** (AC: 10)
  - [ ] Change `role: String` to `role: ProjectRole` in `shared/src/domain/project.gleam`
  - [ ] Update all usages in client and server

### Phase 3: Server Authorization

- [ ] **Task 3.1: Update SQL queries**
  - [ ] `project_members_is_admin.sql` → `project_members_is_manager.sql`
  - [ ] Update all queries that check `role = 'admin'` to `role = 'manager'`

- [ ] **Task 3.2: Update projects_db.gleam**
  - [ ] Rename `is_project_admin()` → `is_project_manager()`
  - [ ] Update `add_member()` to validate role based on caller's permissions

- [ ] **Task 3.3: Implement role assignment restriction** (AC: 5, 6)
  - [ ] In `handle_members_add()`: check if caller is org admin
  - [ ] If caller is org admin → allow 'manager' or 'member'
  - [ ] If caller is project manager → only allow 'member'

- [ ] **Task 3.4: Prevent manager self-demotion** (AC: 7)
  - [ ] In role change endpoint: reject if `user_id == current_user.id` and demoting

- [ ] **Task 3.5: Update authorization helpers**
  - [ ] `require_project_admin()` → `require_project_manager()`
  - [ ] Update all call sites

- [ ] **Task 3.6: Update capabilities endpoints**
  - [ ] Change from org-scoped to project-scoped routes
  - [ ] Update authorization to use project manager check

- [ ] **Task 3.7: Remove org-scoped workflow/template logic**
  - [ ] Delete `workflows_list_for_org.sql`
  - [ ] Delete `task_templates_list_for_org.sql`
  - [ ] Simplify handlers to always require project_id

### Phase 4: Client Updates

- [ ] **Task 4.1: Update permissions.gleam** (AC: 8)
  - [ ] Rename `is_project_admin()` → `is_project_manager()`
  - [ ] Update `visible_sections()` logic
  - [ ] Remove org-scoped workflow/template sections for non-org-admins

- [ ] **Task 4.2: Update i18n**
  - [ ] Add `RoleManager` text (es: "Manager", en: "Manager")
  - [ ] Update any "Admin" references in project context

- [ ] **Task 4.3: Update Add Member dialog** (AC: 11)
  - [ ] Show role selector based on current user's org_role
  - [ ] Org Admin sees: Manager, Member
  - [ ] Project Manager sees: Member only

- [ ] **Task 4.4: Update Members table** (AC: 12)
  - [ ] Display "Manager" instead of "Admin" for project role

- [ ] **Task 4.5: Update Capabilities UI**
  - [ ] Change from org-scoped to project-scoped
  - [ ] Add project selector or scope to current project

### Phase 5: Testing

- [ ] **Task 5.1: Update existing tests**
  - [ ] Replace `'admin'` with `'manager'` in all test fixtures
  - [ ] Update test assertions

- [ ] **Task 5.2: Add new authorization tests**
  - [ ] Test: Org Admin can assign manager role
  - [ ] Test: Project Manager cannot assign manager role
  - [ ] Test: Project Manager cannot self-demote
  - [ ] Test: Org Admin has implicit manager access

## Dev Notes

### Role Hierarchy Summary

| Role | Scope | Can Manage | Can Assign |
|------|-------|------------|------------|
| **Org Admin** | Organization | Everything | Manager, Member |
| **Project Manager** | Project(s) | Project entities | Member only |
| **Project Member** | Project(s) | Tasks only | Nobody |

### Migration Strategy for Capabilities

Current `capabilities` has `org_id`. To make it project-scoped:

**Option A (Recommended)**: Delete all capabilities and let users recreate per-project
```sql
TRUNCATE capabilities CASCADE;
ALTER TABLE capabilities DROP COLUMN org_id;
ALTER TABLE capabilities ADD COLUMN project_id INT NOT NULL REFERENCES projects(id);
```

**Option B**: Duplicate to all projects in org (more complex)
```sql
-- For each capability, create a copy for each project in the org
INSERT INTO capabilities (name, project_id)
SELECT c.name, p.id
FROM capabilities c
JOIN projects p ON p.org_id = c.org_id;
-- Then drop old data
```

**Recommendation**: Use Option A since this is a refactor and data can be recreated.

### Files to Modify

**Migrations (new):**
- `db/migrations/YYYYMMDD_rename_project_role_admin_to_manager.sql`
- `db/migrations/YYYYMMDD_capabilities_project_scoped.sql`
- `db/migrations/YYYYMMDD_workflows_project_only.sql`
- `db/migrations/YYYYMMDD_task_templates_project_only.sql`

**Shared domain:**
- `shared/src/domain/project_role.gleam` (new)
- `shared/src/domain/project.gleam`

**Server:**
- `apps/server/src/scrumbringer_server/sql/*.sql` (multiple)
- `apps/server/src/scrumbringer_server/services/projects_db.gleam`
- `apps/server/src/scrumbringer_server/http/projects.gleam`
- `apps/server/src/scrumbringer_server/http/capabilities.gleam`
- `apps/server/src/scrumbringer_server/http/workflows.gleam`
- `apps/server/src/scrumbringer_server/http/task_templates.gleam`
- `apps/server/src/scrumbringer_server/http/authorization.gleam`

**Client:**
- `apps/client/src/scrumbringer_client/permissions.gleam`
- `apps/client/src/scrumbringer_client/features/admin/view.gleam`
- `apps/client/src/scrumbringer_client/features/admin/update.gleam`
- `apps/client/src/scrumbringer_client/i18n/*.gleam`

### Breaking Changes

1. **API**: Role values change from `'admin'` to `'manager'`
2. **API**: Capabilities endpoint changes from `/api/capabilities` to `/api/projects/:id/capabilities`
3. **Data**: Existing org-scoped workflows/templates will be deleted
4. **Data**: Existing capabilities will be deleted (recreate per-project)

### Testing

**Test files to update:**
- `apps/server/test/projects_http_test.gleam`
- `apps/server/test/capabilities_http_test.gleam` (if exists)
- `apps/server/test/workflows_http_test.gleam`
- `apps/server/test/task_templates_http_test.gleam`

**New test cases:**
```gleam
pub fn org_admin_can_assign_manager_role_test() { ... }
pub fn project_manager_cannot_assign_manager_role_test() { ... }
pub fn project_manager_cannot_self_demote_test() { ... }
pub fn org_admin_has_implicit_manager_access_test() { ... }
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-21 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

## QA Results
_To be filled by QA agent_
