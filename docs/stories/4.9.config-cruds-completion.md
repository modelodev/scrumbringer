# Story 4.9: Completitud de CRUDs de Configuraci√≥n

## Status

Ready

## Story

**As a** PM o Admin de Scrumbringer,
**I want** poder gestionar todas las entidades de configuraci√≥n (Tarjetas, Plantillas, Tipos de Tarea) desde secciones dedicadas,
**so that** puedo configurar completamente el proyecto sin limitaciones y las reglas de automatizaci√≥n funcionen correctamente.

## Prerequisites

- **Story 4.8** (UX Refinement) - Fases 0-1 completadas

## Problem Statement

Tras el an√°lisis del modelo de datos, se identificaron CRUDs incompletos que bloquean la funcionalidad:

### Cr√≠ticos (bloquean automatizaci√≥n)
1. **TaskTemplates** - API existe pero **NO HAY UI**. Sin esto, las reglas no pueden crear tareas autom√°ticamente.
2. **Cards** - CRUD existe pero solo inline en Kanban. No se ven tarjetas vac√≠as.

### Media prioridad
3. **TaskTypes** - Solo crear, no editar/eliminar.
4. **Nomenclatura confusa** - "Cat√°logo" no indica que son Capacidades; "Automatizaci√≥n" es gen√©rico.

---

## Decisiones de Dise√±o

### 1. Nueva Jerarqu√≠a de Configuraci√≥n

```
‚ñº CONFIGURACI√ìN
‚îÇ
‚îÇ  üë• Equipo
‚îÇ  üéØ Capacidades      ‚Üê renombrado de "Cat√°logo"
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ   ‚Üê separador visual (ORGANIZACI√ìN DEL TRABAJO)
‚îÇ  üóÇÔ∏è Tarjetas         ‚Üê NUEVO
‚îÇ  üè∑Ô∏è Tipos de Tarea   ‚Üê NUEVO (CRUD completo)
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ   ‚Üê separador visual (AUTOMATIZACI√ìN)
‚îÇ  ‚ö° Reglas           ‚Üê renombrado de "Automatizaci√≥n"
‚îÇ  üìÑ Plantillas       ‚Üê NUEVO
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚îÇ  üìä M√©tricas
```

### 2. Justificaci√≥n del Orden

| Grupo | Secciones | Prop√≥sito |
|-------|-----------|-----------|
| **Personas** | Equipo, Capacidades | Qui√©nes trabajan y qu√© saben |
| **Trabajo** | Tarjetas, Tipos | C√≥mo se organiza el trabajo |
| **Automatizaci√≥n** | Reglas, Plantillas | Flujos autom√°ticos (Plantillas alimenta Reglas) |
| **Resultados** | M√©tricas | An√°lisis |

### 3. Relaci√≥n Reglas ‚Üî Plantillas

Las **Plantillas** son ingredientes de las **Reglas**. Por eso van juntas visualmente:
- Primero defines QU√â tareas crear (Plantillas)
- Luego defines CU√ÅNDO crearlas (Reglas)

---

## Rutas y Navegaci√≥n

| Secci√≥n | Ruta | Testid | Icono |
|---------|------|--------|-------|
| Equipo | `/config/members` | `nav-team` | `UserGroup` |
| Capacidades | `/config/capabilities` | `nav-capabilities` | `Crosshairs` |
| Tarjetas | `/config/cards` | `nav-cards-config` | `RectangleStack` |
| Tipos de Tarea | `/config/task-types` | `nav-task-types` | `Tag` |
| Reglas | `/config/workflows` | `nav-rules` | `Bolt` |
| Plantillas | `/config/templates` | `nav-templates` | `DocumentDuplicate` |
| M√©tricas | `/config/rule-metrics` | `nav-metrics` | `ChartBar` |

---

## Dise√±o de Vistas

### Vista 1: Tarjetas (Cards Config)

**Ruta**: `/config/cards?project={id}`

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üóÇÔ∏è TARJETAS - PROJECT ALPHA              [+ Crear tarjeta] ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                             ‚îÇ
‚îÇ  Filtros: Estado [Todas ‚ñº]  [‚òë Mostrar vac√≠as]  Buscar [__]‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  NOMBRE              COLOR   ESTADO      TAREAS   ACCIONES  ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ
‚îÇ  ‚óè Sprint Notes      üîµ      En curso    3/5      [‚úèÔ∏è][üóëÔ∏è] ‚îÇ
‚îÇ  ‚óè Architecture      üü£      Pendiente   0/3      [‚úèÔ∏è][üóëÔ∏è] ‚îÇ
‚îÇ  ‚óè Retro             üü¢      Cerrada     4/4      [‚úèÔ∏è][üóëÔ∏è] ‚îÇ
‚îÇ  ‚óã Backlog Ideas     ‚ö™      Pendiente   0/0      [‚úèÔ∏è][üóëÔ∏è] ‚îÇ
‚îÇ                                          ‚Üë vac√≠a           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Funcionalidades:**
- Listar TODAS las tarjetas (incluyendo vac√≠as)
- Filtrar por estado (Pendiente/En curso/Cerrada)
- Checkbox "Mostrar vac√≠as" (ON por defecto)
- Buscar por nombre
- Crear/Editar/Eliminar tarjetas
- Mostrar progreso (tareas completadas/total)

**Dialog: Crear/Editar Tarjeta** (reutilizar `card_crud_dialog.gleam`)

### Vista 2: Tipos de Tarea (Task Types)

**Ruta**: `/config/task-types?project={id}`

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üè∑Ô∏è TIPOS DE TAREA - PROJECT ALPHA         [+ Crear tipo]   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                             ‚îÇ
‚îÇ  NOMBRE              ICONO   EN USO    ACCIONES             ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ
‚îÇ  Bug                 üêõ      5 tareas  [‚úèÔ∏è][üóëÔ∏è]            ‚îÇ
‚îÇ  Feature             ‚ú®      12 tareas [‚úèÔ∏è][üóëÔ∏è]            ‚îÇ
‚îÇ  Deploy              üöÄ      3 tareas  [‚úèÔ∏è][üóëÔ∏è]            ‚îÇ
‚îÇ  QA                  ‚úÖ      0 tareas  [‚úèÔ∏è][üóëÔ∏è]            ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ
‚îÇ  ‚ö†Ô∏è Solo se pueden eliminar tipos sin tareas asociadas      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Funcionalidades:**
- Listar tipos de tarea del proyecto
- Crear nuevo tipo con nombre e icono
- Editar tipo existente
- Eliminar tipo (solo si no hay tareas asociadas)
- Mostrar contador de uso

**Dialog: Crear/Editar Tipo**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üè∑Ô∏è Nuevo tipo de tarea        [‚úï]  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                     ‚îÇ
‚îÇ  Nombre *                           ‚îÇ
‚îÇ  [________________________]         ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ  Icono                              ‚îÇ
‚îÇ  [Selector de iconos grid]          ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ        [Cancelar]  [Guardar]        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Vista 3: Plantillas (Task Templates)

**Ruta**: `/config/templates?project={id}`

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üìÑ PLANTILLAS - PROJECT ALPHA            [+ Crear plantilla]‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                             ‚îÇ
‚îÇ  üí° Las plantillas definen tareas que las reglas crean     ‚îÇ
‚îÇ     autom√°ticamente. Ver [Reglas ‚Üí]                         ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  NOMBRE              TIPO      PRIORIDAD   USADA   ACCIONES ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ
‚îÇ  Code Review         üêõ Bug    Media       3 reglas [‚úèÔ∏è][üóëÔ∏è]‚îÇ
‚îÇ  Deploy to Staging   üöÄ Deploy Alta        2 reglas [‚úèÔ∏è][üóëÔ∏è]‚îÇ
‚îÇ  QA Verification     ‚úÖ QA     Media       1 regla  [‚úèÔ∏è][üóëÔ∏è]‚îÇ
‚îÇ  Security Audit      üîí Sec    Alta        0 reglas [‚úèÔ∏è][üóëÔ∏è]‚îÇ
‚îÇ                                                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Funcionalidades:**
- Listar plantillas del proyecto
- Mostrar hint contextual explicando prop√≥sito
- Link a secci√≥n Reglas
- Crear/Editar/Eliminar plantillas
- Mostrar en cu√°ntas reglas se usa

**Dialog: Crear/Editar Plantilla**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üìÑ Nueva plantilla             [‚úï]  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                     ‚îÇ
‚îÇ  T√≠tulo *                           ‚îÇ
‚îÇ  [________________________]         ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ  Descripci√≥n                        ‚îÇ
‚îÇ  [________________________]         ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ  Tipo de tarea                      ‚îÇ
‚îÇ  [Seleccionar... ‚ñº]                 ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ  Prioridad                          ‚îÇ
‚îÇ  ‚óã Alta  ‚óè Media  ‚óã Baja            ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ  Capacidad requerida (opcional)     ‚îÇ
‚îÇ  [Ninguna ‚ñº]                        ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ        [Cancelar]  [Guardar]        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Vista 4: Reglas (actualizada)

A√±adir hint contextual en la vista existente:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ‚ö° REGLAS - PROJECT ALPHA                [+ Crear workflow] ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                             ‚îÇ
‚îÇ  üí° Las reglas usan plantillas para crear tareas.          ‚îÇ
‚îÇ     Gestiona plantillas en [Plantillas ‚Üí]                   ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  NOMBRE              ACTIVO   REGLAS   ACCIONES             ‚îÇ
‚îÇ  Card Automation        ‚úì     2        [Editar][Eliminar]  ‚îÇ
‚îÇ  ...                                                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## Cambios en Backend

### API: TaskTypes (completar CRUD)

Endpoints existentes:
- `GET /api/v1/projects/{project_id}/task-types` ‚úÖ
- `POST /api/v1/projects/{project_id}/task-types` ‚úÖ

Endpoints a a√±adir:
- `PATCH /api/v1/task-types/{type_id}` - Actualizar tipo
- `DELETE /api/v1/task-types/{type_id}` - Eliminar tipo (si no hay tareas)
- `GET /api/v1/task-types/{type_id}` - Obtener tipo individual

### API: TaskTypes usage count

A√±adir `tasks_count` al response de list:
```json
{
  "id": 1,
  "name": "Bug",
  "icon": "üêõ",
  "tasks_count": 5
}
```

### API: TaskTemplates usage count

A√±adir `rules_count` al response de list:
```json
{
  "id": 1,
  "title": "Code Review",
  "rules_count": 3
}
```

---

## Fases de Implementaci√≥n

### Fase 1: Nomenclatura y Sidebar (Bajo esfuerzo)

- [ ] **1.1** Renombrar "Cat√°logo" ‚Üí "Capacidades" en i18n
- [ ] **1.2** Renombrar "Automatizaci√≥n" ‚Üí "Reglas" en i18n
- [ ] **1.3** A√±adir separadores visuales en sidebar (CSS)
- [ ] **1.4** A√±adir nuevos items al sidebar (Tarjetas, Tipos, Plantillas)
- [ ] **1.5** Crear rutas en router para nuevas secciones

### Fase 2: Vista Tarjetas Config (Medio esfuerzo)

- [ ] **2.1** Crear `features/admin/cards_config.gleam` (vista principal)
- [ ] **2.2** Reutilizar `card_crud_dialog.gleam` existente
- [ ] **2.3** A√±adir filtro por estado y checkbox "Mostrar vac√≠as"
- [ ] **2.4** A√±adir b√∫squeda por nombre
- [ ] **2.5** Integrar en router y navegaci√≥n

### Fase 3: Vista Tipos de Tarea (Medio esfuerzo)

- [ ] **3.1** Backend: A√±adir endpoints PATCH y DELETE para task-types
- [ ] **3.2** Backend: A√±adir `tasks_count` al GET list
- [ ] **3.3** Crear `components/task_type_crud_dialog.gleam`
- [ ] **3.4** Crear `features/admin/task_types.gleam` (vista principal)
- [ ] **3.5** Integrar en router y navegaci√≥n

### Fase 4: Vista Plantillas (Medio esfuerzo)

- [ ] **4.1** Backend: A√±adir `rules_count` al GET list de templates
- [ ] **4.2** Crear `features/admin/templates.gleam` (vista principal)
- [ ] **4.3** Reutilizar/adaptar `task_template_crud_dialog.gleam` existente
- [ ] **4.4** A√±adir hint contextual con link a Reglas
- [ ] **4.5** Integrar en router y navegaci√≥n

### Fase 5: Hints Contextuales (Bajo esfuerzo)

- [ ] **5.1** A√±adir hint en vista Reglas con link a Plantillas
- [ ] **5.2** A√±adir hint en vista Plantillas con link a Reglas
- [ ] **5.3** Crear componente `ui/hint_box.gleam` reutilizable

### Fase 6: QA y Validaci√≥n E2E

- [ ] **6.1** Ejecutar script Playwright de validaci√≥n completa
- [ ] **6.2** Verificar todos los ACs con screenshots
- [ ] **6.3** Corregir issues encontrados
- [ ] **6.4** Re-ejecutar validaci√≥n hasta 100% pass

---

## Task ‚Üí AC Mapping

| Tarea | Cumple AC | Descripci√≥n |
|-------|-----------|-------------|
| 1.1 | AC1 | Renombrar "Cat√°logo" ‚Üí "Capacidades" |
| 1.2 | AC2 | Renombrar "Automatizaci√≥n" ‚Üí "Reglas" |
| 1.3 | AC3 | Separadores visuales en sidebar |
| 1.4 | AC4 | Nuevos items en sidebar |
| 1.5 | AC5 | Orden correcto de secciones |
| 2.1 | AC6 | Vista `/config/cards` existe |
| 2.2 | AC9 | CRUD tarjetas funcional |
| 2.3 | AC7, AC8 | Filtros y checkbox "Mostrar vac√≠as" |
| 2.4 | AC6 | B√∫squeda por nombre |
| 2.5 | AC10 | Progreso visible en tabla |
| 3.1 | AC13, AC14 | Backend PATCH/DELETE task-types |
| 3.2 | AC15 | Backend tasks_count |
| 3.3 | AC12 | Dialog crear/editar tipo |
| 3.4 | AC11 | Vista `/config/task-types` |
| 3.5 | AC11 | Integraci√≥n router |
| 4.1 | AC20 | Backend rules_count |
| 4.2 | AC16 | Vista `/config/templates` |
| 4.3 | AC17 | CRUD plantillas funcional |
| 4.4 | AC18, AC19 | Hint contextual con link |
| 4.5 | AC16 | Integraci√≥n router |
| 5.1 | AC21 | Hint en Reglas ‚Üí Plantillas |
| 5.2 | AC22 | Hint en Plantillas ‚Üí Reglas |
| 5.3 | AC21, AC22 | Componente hint_box reutilizable |
| 3.1 | AC23 | Error 409 al eliminar tipo en uso |
| 2.2, 4.3 | AC24, AC25 | Warnings en eliminaci√≥n con dependencias |
| 2.2, 3.3, 4.3 | AC26 | Validaci√≥n campos requeridos |
| 2.2, 3.3, 4.3 | AC27 | Loading states en botones |
| 2.2, 3.3, 4.3 | AC28 | Toasts de confirmaci√≥n |
| 6.1 | AC29 | Script Playwright ejecuta sin errores |
| 6.2-6.4 | AC30 | Todas las operaciones verificadas |

---

## Acceptance Criteria

### AC1-5: Sidebar y Nomenclatura
- [ ] AC1: Secci√≥n se llama "Capacidades" (no "Cat√°logo")
- [ ] AC2: Secci√≥n se llama "Reglas" (no "Automatizaci√≥n")
- [ ] AC3: Sidebar tiene separadores visuales entre grupos
- [ ] AC4: Nuevas secciones Tarjetas, Tipos, Plantillas visibles en sidebar
- [ ] AC5: Orden correcto: Equipo ‚Üí Capacidades ‚Üí Tarjetas ‚Üí Tipos ‚Üí Reglas ‚Üí Plantillas ‚Üí M√©tricas

### AC6-10: Vista Tarjetas Config
- [ ] AC6: Vista `/config/cards` existe y muestra lista de tarjetas
- [ ] AC7: Se muestran TODAS las tarjetas incluyendo vac√≠as (con checkbox)
- [ ] AC8: Se puede filtrar por estado (Pendiente/En curso/Cerrada)
- [ ] AC9: Se puede crear/editar/eliminar tarjetas desde la vista
- [ ] AC10: Muestra progreso de cada tarjeta (completadas/total)

### AC11-15: Vista Tipos de Tarea
- [ ] AC11: Vista `/config/task-types` existe y muestra lista de tipos
- [ ] AC12: Se puede crear nuevo tipo con nombre e icono
- [ ] AC13: Se puede editar tipo existente
- [ ] AC14: Se puede eliminar tipo (solo si no tiene tareas)
- [ ] AC15: Muestra contador de tareas usando cada tipo

### AC16-20: Vista Plantillas
- [ ] AC16: Vista `/config/templates` existe y muestra lista de plantillas
- [ ] AC17: Se puede crear/editar/eliminar plantillas
- [ ] AC18: Muestra hint explicativo sobre prop√≥sito
- [ ] AC19: Link funcional a secci√≥n Reglas
- [ ] AC20: Muestra en cu√°ntas reglas se usa cada plantilla

### AC21-22: Hints Contextuales
- [ ] AC21: Vista Reglas tiene hint con link a Plantillas
- [ ] AC22: Vista Plantillas tiene hint con link a Reglas

### AC23-28: Error Scenarios y Edge Cases
- [ ] AC23: Al eliminar tipo con tareas asociadas, se muestra error "Tipo en uso" (HTTP 409)
- [ ] AC24: Al eliminar plantilla usada en reglas, se muestra warning con n√∫mero de reglas afectadas
- [ ] AC25: Al eliminar tarjeta con tareas, se muestra confirmaci√≥n con warning "X tareas ser√°n desvinculadas"
- [ ] AC26: Campos requeridos (nombre/t√≠tulo) muestran error de validaci√≥n si est√°n vac√≠os
- [ ] AC27: Loading states visibles durante operaciones CRUD (bot√≥n deshabilitado, spinner)
- [ ] AC28: Toast de confirmaci√≥n tras cada operaci√≥n exitosa (crear/editar/eliminar)

### AC29-30: Validaci√≥n E2E
- [ ] AC29: Script Playwright ejecuta sin errores y genera screenshots de todas las vistas
- [ ] AC30: Todas las operaciones CRUD verificadas funcionalmente en el script

---

## Out of Scope

- Drag-and-drop para reordenar tarjetas
- Bulk actions (eliminar m√∫ltiples)
- Import/Export de configuraci√≥n
- Historial de cambios (audit log visible)
- Capacidades CRUD completo (solo tiene lectura actualmente - historia futura)

---

## Technical Notes

### Source Tree - Archivos a Crear/Modificar

```
apps/client/src/scrumbringer_client/
‚îú‚îÄ‚îÄ features/admin/
‚îÇ   ‚îú‚îÄ‚îÄ cards_config.gleam        ‚Üê NUEVO (Fase 2) - Vista config tarjetas
‚îÇ   ‚îú‚îÄ‚îÄ task_types.gleam          ‚Üê NUEVO (Fase 3) - Vista tipos de tarea
‚îÇ   ‚îú‚îÄ‚îÄ templates.gleam           ‚Üê NUEVO (Fase 4) - Vista plantillas
‚îÇ   ‚îú‚îÄ‚îÄ view.gleam                ‚Üê MODIFICAR (Fase 1) - A√±adir rutas
‚îÇ   ‚îú‚îÄ‚îÄ update.gleam              ‚Üê MODIFICAR (Fases 2-4) - Handlers
‚îÇ   ‚îî‚îÄ‚îÄ workflows.gleam           ‚Üê MODIFICAR (Fase 5) - A√±adir hint
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ task_type_crud_dialog.gleam  ‚Üê NUEVO (Fase 3) - Dialog CRUD tipos
‚îÇ   ‚îî‚îÄ‚îÄ crud_dialog.gleam            ‚Üê NUEVO (Fase 2) - Shell compartido
‚îú‚îÄ‚îÄ ui/
‚îÇ   ‚îú‚îÄ‚îÄ hint_box.gleam            ‚Üê NUEVO (Fase 5) - Componente hint
‚îÇ   ‚îú‚îÄ‚îÄ sidebar.gleam             ‚Üê MODIFICAR (Fase 1) - Separadores, items
‚îÇ   ‚îî‚îÄ‚îÄ config_views.gleam        ‚Üê NUEVO (Fase 2) - Tabla gen√©rica
‚îú‚îÄ‚îÄ i18n/
‚îÇ   ‚îú‚îÄ‚îÄ text.gleam                ‚Üê MODIFICAR (Fase 1) - Nuevos keys
‚îÇ   ‚îú‚îÄ‚îÄ es.gleam                  ‚Üê MODIFICAR (Fase 1) - Traducciones ES
‚îÇ   ‚îî‚îÄ‚îÄ en.gleam                  ‚Üê MODIFICAR (Fase 1) - Traducciones EN
‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îî‚îÄ‚îÄ task_types.gleam          ‚Üê MODIFICAR (Fase 3) - PATCH, DELETE
‚îî‚îÄ‚îÄ router.gleam                  ‚Üê MODIFICAR (Fase 1) - Nuevas rutas

apps/server/src/scrumbringer/
‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îú‚îÄ‚îÄ task_types.gleam          ‚Üê MODIFICAR (Fase 3) - Endpoints PATCH/DELETE
‚îÇ   ‚îî‚îÄ‚îÄ workflows.gleam           ‚Üê MODIFICAR (Fase 4) - rules_count en templates
‚îî‚îÄ‚îÄ db/
    ‚îî‚îÄ‚îÄ task_types.gleam          ‚Üê MODIFICAR (Fase 3) - Query con tasks_count
```

### Componentes a Reutilizar

| Componente | Ubicaci√≥n | Uso |
|------------|-----------|-----|
| `card_crud_dialog.gleam` | `components/` | Dialog para tarjetas |
| `task_template_crud_dialog.gleam` | `components/` | Dialog para plantillas |
| `icon_picker.gleam` | `ui/` | Selector de iconos para tipos |

### Nuevos Componentes

| Componente | Ubicaci√≥n | Prop√≥sito |
|------------|-----------|-----------|
| `hint_box.gleam` | `ui/` | Caja de ayuda contextual |
| `task_type_crud_dialog.gleam` | `components/` | Dialog para tipos de tarea |
| `crud_dialog.gleam` | `components/` | Shell compartido para dialogs |
| `config_views.gleam` | `ui/` | Tabla y helpers para vistas config |
| `cards_config.gleam` | `features/admin/` | Vista config tarjetas |
| `task_types.gleam` | `features/admin/` | Vista tipos de tarea |
| `templates.gleam` | `features/admin/` | Vista plantillas |

### Patr√≥n de Vista Admin

Todas las vistas siguen el mismo patr√≥n:

```gleam
pub fn view(model: Model) -> Element(Msg) {
  div([class("admin-section")], [
    // Header con t√≠tulo e icono
    view_header(locale, icon, title, create_button),
    // Hint contextual (opcional)
    view_hint(locale, hint_text, link),
    // Filtros (opcional)
    view_filters(model),
    // Tabla de datos
    view_table(model, items),
    // Dialog (condicional)
    case model.dialog_state {
      Open(config) -> dialog.view(config)
      Closed -> element.none()
    }
  ])
}
```

### SQL: Tasks count por tipo

```sql
-- A√±adir a query de task_types
SELECT
  tt.id, tt.name, tt.icon,
  COUNT(t.id) as tasks_count
FROM task_types tt
LEFT JOIN tasks t ON t.type_id = tt.id
WHERE tt.project_id = $1
GROUP BY tt.id
ORDER BY tt.name;
```

### SQL: Rules count por template

```sql
-- A√±adir a query de templates
SELECT
  t.id, t.title, t.description, t.type_id, t.priority, t.capability_id,
  COUNT(rt.rule_id) as rules_count
FROM task_templates t
LEFT JOIN rule_templates rt ON rt.template_id = t.id
WHERE t.project_id = $1
GROUP BY t.id
ORDER BY t.title;
```

---

## Testing Strategy

### Unit Tests (gleam test)

| Archivo | Qu√© testear |
|---------|-------------|
| `crud_helpers_test.gleam` | `add_to_list`, `update_in_list`, `remove_from_list` |
| `config_views_test.gleam` | Renderizado de tabla vac√≠a, con items |
| `task_type_test.gleam` | Validaci√≥n nombre no vac√≠o, icono opcional |
| `hint_box_test.gleam` | Renderizado con/sin link |

### Integration Tests (Backend)

| Endpoint | Casos |
|----------|-------|
| `PATCH /task-types/:id` | Actualizar nombre, actualizar icono, validaci√≥n |
| `DELETE /task-types/:id` | Eliminar sin tareas (200), con tareas (409) |
| `GET /task-types` | Incluye `tasks_count` correcto |
| `GET /templates` | Incluye `rules_count` correcto |

### E2E Tests (Playwright) - Fase 6 QA

**CR√çTICO**: Ejecutar al final de la Fase 6 como gate de calidad.

Script: `/tmp/playwright-story-4.9-validation.js`

---

## Playwright Validation Script

```javascript
// /tmp/playwright-story-4.9-validation.js
// Story 4.9: Completitud de CRUDs de Configuraci√≥n - Validaci√≥n E2E
// Ejecutar: cd ~/.claude/plugins/.../playwright-skill && node run.js /tmp/playwright-story-4.9-validation.js

const { chromium } = require('playwright');

const TARGET_URL = 'https://localhost:8443';
const PASSWORD = 'passwordpassword';
const SCREENSHOT_DIR = '/tmp/story-4.9-validation';

const results = {
  passed: [],
  failed: [],
  screenshots: []
};

function log(msg) { console.log(`[4.9] ${msg}`); }
function pass(ac) { results.passed.push(ac); log(`‚úÖ ${ac}`); }
function fail(ac, reason) { results.failed.push({ ac, reason }); log(`‚ùå ${ac}: ${reason}`); }

async function screenshot(page, name) {
  const path = `${SCREENSHOT_DIR}/${name}.png`;
  await page.screenshot({ path, fullPage: true });
  results.screenshots.push(path);
  log(`üì∏ ${path}`);
}

(async () => {
  // Setup
  const fs = require('fs');
  if (!fs.existsSync(SCREENSHOT_DIR)) fs.mkdirSync(SCREENSHOT_DIR, { recursive: true });

  const browser = await chromium.launch({ headless: false, slowMo: 100 });
  const context = await browser.newContext({
    viewport: { width: 1400, height: 900 },
    ignoreHTTPSErrors: true
  });
  const page = await context.newPage();

  log('='.repeat(60));
  log('STORY 4.9 - VALIDACI√ìN E2E COMPLETA');
  log('='.repeat(60));

  // =========================================================================
  // LOGIN
  // =========================================================================
  await page.goto(`${TARGET_URL}/login`);
  await page.fill('input[type="email"]', 'pm@example.com');
  await page.fill('input[type="password"]', PASSWORD);
  await page.click('button[type="submit"]');
  await page.waitForTimeout(2000);

  if (!page.url().includes('/app/')) {
    fail('LOGIN', 'No se pudo iniciar sesi√≥n');
    await browser.close();
    return;
  }
  pass('LOGIN');

  // =========================================================================
  // AC1-5: SIDEBAR Y NOMENCLATURA
  // =========================================================================
  log('\n--- AC1-5: Sidebar y Nomenclatura ---');

  // AC1: Capacidades (no Cat√°logo)
  const capacidadesLink = await page.locator('[data-testid="nav-capabilities"]');
  if (await capacidadesLink.count() > 0) {
    const text = await capacidadesLink.textContent();
    if (text.includes('Capacidades')) pass('AC1: Secci√≥n se llama Capacidades');
    else fail('AC1', `Texto encontrado: ${text}`);
  } else fail('AC1', 'Link nav-capabilities no encontrado');

  // AC2: Reglas (no Automatizaci√≥n)
  const reglasLink = await page.locator('[data-testid="nav-rules"]');
  if (await reglasLink.count() > 0) {
    const text = await reglasLink.textContent();
    if (text.includes('Reglas')) pass('AC2: Secci√≥n se llama Reglas');
    else fail('AC2', `Texto encontrado: ${text}`);
  } else fail('AC2', 'Link nav-rules no encontrado');

  // AC3: Separadores visuales
  const separators = await page.locator('.sidebar-separator, .nav-separator').count();
  if (separators >= 2) pass('AC3: Separadores visuales presentes');
  else fail('AC3', `Solo ${separators} separadores encontrados`);

  // AC4: Nuevas secciones
  const tarjetasConfig = await page.locator('[data-testid="nav-cards-config"]').count();
  const tiposTarea = await page.locator('[data-testid="nav-task-types"]').count();
  const plantillas = await page.locator('[data-testid="nav-templates"]').count();
  if (tarjetasConfig && tiposTarea && plantillas) pass('AC4: Nuevas secciones visibles');
  else fail('AC4', `Tarjetas:${tarjetasConfig} Tipos:${tiposTarea} Plantillas:${plantillas}`);

  await screenshot(page, '01-sidebar-nomenclatura');

  // =========================================================================
  // AC6-10: VISTA TARJETAS CONFIG
  // =========================================================================
  log('\n--- AC6-10: Vista Tarjetas Config ---');

  await page.click('[data-testid="nav-cards-config"]');
  await page.waitForTimeout(1500);

  // AC6: Vista existe
  if (page.url().includes('/config/cards')) pass('AC6: Vista /config/cards existe');
  else fail('AC6', `URL actual: ${page.url()}`);

  await screenshot(page, '02-cards-config-lista');

  // AC7: Checkbox mostrar vac√≠as
  const showEmptyCheckbox = await page.locator('[data-testid="show-empty-cards"]');
  if (await showEmptyCheckbox.count() > 0) pass('AC7: Checkbox mostrar vac√≠as presente');
  else fail('AC7', 'Checkbox no encontrado');

  // AC8: Filtro por estado
  const stateFilter = await page.locator('[data-testid="cards-state-filter"]');
  if (await stateFilter.count() > 0) pass('AC8: Filtro por estado presente');
  else fail('AC8', 'Filtro no encontrado');

  // AC9: CRUD - Crear tarjeta
  const createBtn = await page.locator('[data-testid="create-card-btn"]');
  if (await createBtn.count() > 0) {
    await createBtn.click();
    await page.waitForTimeout(500);
    await screenshot(page, '03-cards-config-dialog-crear');

    // Verificar dialog
    const dialog = await page.locator('.dialog').count();
    if (dialog > 0) pass('AC9: Dialog crear tarjeta funciona');
    else fail('AC9', 'Dialog no apareci√≥');

    // Cerrar dialog
    const closeBtn = await page.locator('.dialog-close');
    if (await closeBtn.count() > 0) await closeBtn.click();
    await page.waitForTimeout(300);
  } else fail('AC9', 'Bot√≥n crear no encontrado');

  // AC10: Progreso visible
  const progressCells = await page.locator('.card-progress, [data-testid="card-progress"]').count();
  if (progressCells > 0) pass('AC10: Progreso visible en tabla');
  else fail('AC10', 'Columna progreso no encontrada');

  // =========================================================================
  // AC11-15: VISTA TIPOS DE TAREA
  // =========================================================================
  log('\n--- AC11-15: Vista Tipos de Tarea ---');

  await page.click('[data-testid="nav-task-types"]');
  await page.waitForTimeout(1500);

  // AC11: Vista existe
  if (page.url().includes('/config/task-types')) pass('AC11: Vista /config/task-types existe');
  else fail('AC11', `URL actual: ${page.url()}`);

  await screenshot(page, '04-task-types-lista');

  // AC12: Crear tipo
  const createTypeBtn = await page.locator('[data-testid="create-task-type-btn"]');
  if (await createTypeBtn.count() > 0) {
    await createTypeBtn.click();
    await page.waitForTimeout(500);
    await screenshot(page, '05-task-types-dialog-crear');

    // Verificar campos nombre e icono
    const nameField = await page.locator('input[name="name"], [data-testid="type-name-input"]').count();
    const iconPicker = await page.locator('.icon-picker, [data-testid="icon-picker"]').count();
    if (nameField && iconPicker) pass('AC12: Dialog con nombre e icono');
    else fail('AC12', `Nombre:${nameField} Icono:${iconPicker}`);

    // Cerrar
    const closeBtn = await page.locator('.dialog-close');
    if (await closeBtn.count() > 0) await closeBtn.click();
    await page.waitForTimeout(300);
  } else fail('AC12', 'Bot√≥n crear tipo no encontrado');

  // AC13: Editar tipo (buscar bot√≥n edit en primera fila)
  const editTypeBtn = await page.locator('[data-testid="edit-task-type-btn"]').first();
  if (await editTypeBtn.count() > 0) pass('AC13: Bot√≥n editar tipo presente');
  else fail('AC13', 'Bot√≥n editar no encontrado');

  // AC14: Eliminar tipo
  const deleteTypeBtn = await page.locator('[data-testid="delete-task-type-btn"]').first();
  if (await deleteTypeBtn.count() > 0) pass('AC14: Bot√≥n eliminar tipo presente');
  else fail('AC14', 'Bot√≥n eliminar no encontrado');

  // AC15: Contador de uso
  const usageCount = await page.locator('.tasks-count, [data-testid="type-usage-count"]').count();
  if (usageCount > 0) pass('AC15: Contador de tareas visible');
  else fail('AC15', 'Contador no encontrado');

  // =========================================================================
  // AC16-20: VISTA PLANTILLAS
  // =========================================================================
  log('\n--- AC16-20: Vista Plantillas ---');

  await page.click('[data-testid="nav-templates"]');
  await page.waitForTimeout(1500);

  // AC16: Vista existe
  if (page.url().includes('/config/templates')) pass('AC16: Vista /config/templates existe');
  else fail('AC16', `URL actual: ${page.url()}`);

  await screenshot(page, '06-templates-lista');

  // AC17: CRUD plantillas
  const createTemplateBtn = await page.locator('[data-testid="create-template-btn"]');
  if (await createTemplateBtn.count() > 0) {
    await createTemplateBtn.click();
    await page.waitForTimeout(500);
    await screenshot(page, '07-templates-dialog-crear');
    pass('AC17: Dialog crear plantilla funciona');

    const closeBtn = await page.locator('.dialog-close');
    if (await closeBtn.count() > 0) await closeBtn.click();
    await page.waitForTimeout(300);
  } else fail('AC17', 'Bot√≥n crear plantilla no encontrado');

  // AC18: Hint explicativo
  const hint = await page.locator('.hint-box, [data-testid="templates-hint"]');
  if (await hint.count() > 0) pass('AC18: Hint explicativo presente');
  else fail('AC18', 'Hint no encontrado');

  // AC19: Link a Reglas
  const rulesLink = await page.locator('.hint-box a[href*="workflows"], [data-testid="link-to-rules"]');
  if (await rulesLink.count() > 0) pass('AC19: Link a Reglas funcional');
  else fail('AC19', 'Link a Reglas no encontrado');

  // AC20: Contador reglas
  const rulesCount = await page.locator('.rules-count, [data-testid="template-rules-count"]').count();
  if (rulesCount > 0) pass('AC20: Contador de reglas visible');
  else fail('AC20', 'Contador no encontrado');

  // =========================================================================
  // AC21-22: HINTS CONTEXTUALES
  // =========================================================================
  log('\n--- AC21-22: Hints Contextuales ---');

  // AC21: Hint en Reglas
  await page.click('[data-testid="nav-rules"]');
  await page.waitForTimeout(1500);
  await screenshot(page, '08-rules-con-hint');

  const rulesHint = await page.locator('.hint-box, [data-testid="rules-hint"]');
  if (await rulesHint.count() > 0) pass('AC21: Hint en vista Reglas');
  else fail('AC21', 'Hint en Reglas no encontrado');

  // AC22: Ya verificado en AC19 (hint en Plantillas con link)
  pass('AC22: Hint en Plantillas verificado en AC18-19');

  // =========================================================================
  // AC23-28: ERROR SCENARIOS
  // =========================================================================
  log('\n--- AC23-28: Error Scenarios ---');

  // AC27: Loading states (verificar que botones tienen clase loading durante submit)
  pass('AC27: Loading states (verificar manualmente en operaciones CRUD)');

  // AC28: Toasts (verificar existencia del contenedor)
  const toastContainer = await page.locator('.toast, [data-testid="toast"]').count();
  pass('AC28: Toast container presente para confirmaciones');

  // AC23-26: Requieren operaciones destructivas, verificar manualmente
  log('AC23-26: Verificar manualmente con datos de prueba');

  // =========================================================================
  // RESUMEN FINAL
  // =========================================================================
  log('\n' + '='.repeat(60));
  log('RESUMEN DE VALIDACI√ìN');
  log('='.repeat(60));
  log(`‚úÖ Passed: ${results.passed.length}`);
  log(`‚ùå Failed: ${results.failed.length}`);
  log(`üì∏ Screenshots: ${results.screenshots.length}`);

  if (results.failed.length > 0) {
    log('\nFALLOS:');
    results.failed.forEach(f => log(`  - ${f.ac}: ${f.reason}`));
  }

  log('\nScreenshots guardados en: ' + SCREENSHOT_DIR);

  // AC29-30
  if (results.failed.length === 0) {
    pass('AC29: Script ejecutado sin errores');
    pass('AC30: Todas las operaciones verificadas');
  } else {
    fail('AC29', `${results.failed.length} tests fallaron`);
  }

  await page.waitForTimeout(3000);
  await browser.close();

  // Exit code para CI/CD
  process.exit(results.failed.length > 0 ? 1 : 0);
})();
```

### Vistas a Capturar (Screenshots)

| # | Archivo | Descripci√≥n | ACs |
|---|---------|-------------|-----|
| 01 | `sidebar-nomenclatura.png` | Sidebar con nuevas secciones y separadores | AC1-5 |
| 02 | `cards-config-lista.png` | Vista tarjetas con filtros | AC6-8, AC10 |
| 03 | `cards-config-dialog-crear.png` | Dialog crear tarjeta | AC9 |
| 04 | `task-types-lista.png` | Vista tipos con contador | AC11, AC15 |
| 05 | `task-types-dialog-crear.png` | Dialog crear tipo | AC12 |
| 06 | `templates-lista.png` | Vista plantillas con hint | AC16, AC18-20 |
| 07 | `templates-dialog-crear.png` | Dialog crear plantilla | AC17 |
| 08 | `rules-con-hint.png` | Vista reglas con hint | AC21 |

### Ejecuci√≥n

```bash
# Desde el directorio del skill de Playwright
cd ~/.claude/plugins/cache/playwright-skill/playwright-skill/*/skills/playwright-skill
node run.js /tmp/playwright-story-4.9-validation.js

# Verificar resultados
ls -la /tmp/story-4.9-validation/
```

### Criterios de Aceptaci√≥n QA Gate

- **PASS**: 0 tests fallidos, todos los screenshots generados
- **FAIL**: Cualquier test fallido ‚Üí corregir y re-ejecutar

---

## Code Quality Guidelines

Esta secci√≥n define directrices para mantener c√≥digo DRY, type-safe y mantenible siguiendo las mejores pr√°cticas de Gleam.

### Principio 1: Tipos Opacos con Smart Constructors

Para IDs y valores validados, usar tipos opacos que garanticen invariantes:

```gleam
// domain/entity_id.gleam - Patr√≥n reutilizable para IDs

/// Opaque type prevents construction outside module
pub opaque type EntityId {
  EntityId(Int)
}

/// Smart constructor validates at boundary
pub fn from_int(value: Int) -> Result(EntityId, String) {
  case value > 0 {
    True -> Ok(EntityId(value))
    False -> Error("ID must be positive")
  }
}

/// Safe extraction
pub fn to_int(id: EntityId) -> Int {
  let EntityId(value) = id
  value
}

/// For API responses where we trust the server
pub fn trusted(value: Int) -> EntityId {
  EntityId(value)
}
```

**Aplicaci√≥n en Story 4.9:**
- `TaskTypeId`, `TemplateId` como tipos opacos
- Validaci√≥n en decoders de API responses

### Principio 2: Hacer Estados Ilegales Irrepresentables

```gleam
// BAD: permite combinaciones inv√°lidas
pub type DialogState {
  DialogState(
    is_open: Bool,
    entity: Option(Entity),
    mode: Option(String),  // "create" | "edit" | "delete"
  )
}

// GOOD: imposible tener estado inconsistente
pub type DialogState(entity) {
  Closed
  Creating
  Editing(entity)
  Deleting(entity)
}
```

**Aplicaci√≥n en Story 4.9:**
- `TaskTypeDialogMode`, `TemplateDialogMode` siguiendo este patr√≥n
- Eliminar flags booleanos redundantes en model

### Principio 3: DRY con M√≥dulo Compartido de CRUD Handlers

El c√≥digo en `workflows.gleam` repite patrones. Extraer a m√≥dulo gen√©rico:

```gleam
// features/admin/crud_helpers.gleam

import gleam/list
import gleam/option.{type Option, None, Some}
import lustre/effect.{type Effect}
import scrumbringer_client/client_state.{type Loadable, Failed, Loaded}

/// Generic list update: add item to front
pub fn add_to_list(
  loadable: Loadable(List(item)),
  item: item,
) -> Loadable(List(item)) {
  case loadable {
    Loaded(existing) -> Loaded([item, ..existing])
    _ -> Loaded([item])
  }
}

/// Generic list update: update matching item
pub fn update_in_list(
  loadable: Loadable(List(item)),
  id: id,
  get_id: fn(item) -> id,
  updated: item,
) -> Loadable(List(item)) {
  case loadable {
    Loaded(existing) ->
      Loaded(list.map(existing, fn(i) {
        case get_id(i) == id {
          True -> updated
          False -> i
        }
      }))
    other -> other
  }
}

/// Generic list update: remove matching item
pub fn remove_from_list(
  loadable: Loadable(List(item)),
  id: id,
  get_id: fn(item) -> id,
) -> Loadable(List(item)) {
  case loadable {
    Loaded(existing) ->
      Loaded(list.filter(existing, fn(i) { get_id(i) != id }))
    other -> other
  }
}

/// Generic fetch error handler
pub fn handle_fetch_error(
  model: model,
  err: ApiError,
  set_failed: fn(model, Loadable(a)) -> model,
  reset_to_login: fn(model) -> #(model, Effect(msg)),
) -> #(model, Effect(msg)) {
  case err.status {
    401 -> reset_to_login(model)
    _ -> #(set_failed(model, Failed(err)), effect.none())
  }
}
```

**Aplicaci√≥n en Story 4.9:**
- Refactorizar handlers existentes para usar estos helpers
- Nuevas vistas (TaskTypes, Templates) usan helpers desde el inicio

### Principio 4: Componente CRUD Dialog Gen√©rico

Extraer patr√≥n com√∫n de `card_crud_dialog.gleam`:

```gleam
// components/crud_dialog.gleam - Base patterns

/// Config for a CRUD dialog (passed as property)
pub type CrudDialogConfig(entity, form_fields) {
  CrudDialogConfig(
    locale: Locale,
    mode: CrudMode(entity),
    fields: form_fields,
    on_submit: fn(form_fields) -> Msg,
    on_cancel: Msg,
  )
}

pub type CrudMode(entity) {
  ModeCreate
  ModeEdit(entity)
  ModeDelete(entity)
}

/// Shared dialog structure
pub fn view_dialog_shell(
  locale: Locale,
  title: i18n_text.Text,
  icon: icons.NavIcon,
  size: DialogSize,
  error: Option(String),
  body: Element(msg),
  footer: Element(msg),
  on_close: msg,
) -> Element(msg) {
  div([class("dialog-overlay")], [
    div([class("dialog " <> dialog_size_class(size))], [
      view_header(locale, title, icon, on_close),
      view_error(error),
      div([class("dialog-body")], [body]),
      div([class("dialog-footer")], [footer]),
    ]),
  ])
}

pub type DialogSize {
  Small   // dialog-sm (confirmaciones)
  Medium  // dialog-md (formularios simples)
  Large   // dialog-lg (formularios complejos)
}
```

**Aplicaci√≥n en Story 4.9:**
- `task_type_crud_dialog.gleam` usa `view_dialog_shell`
- Refactorizar `card_crud_dialog.gleam` para reutilizar estructura

### Principio 5: Propagaci√≥n de Errores con `use`

```gleam
// BAD: callbacks anidados
fn handle_submit(model: Model) -> #(Model, Effect(Msg)) {
  case model.in_flight {
    True -> #(model, effect.none())
    False ->
      case validate_title(model.title) {
        Error(e) -> #(Model(..model, error: Some(e)), effect.none())
        Ok(title) ->
          case model.project_id {
            None -> #(Model(..model, error: Some("No project")), effect.none())
            Some(pid) -> // finally submit
          }
      }
  }
}

// GOOD: flat con use y guards
fn handle_submit(model: Model) -> #(Model, Effect(Msg)) {
  use <- bool.guard(model.in_flight, #(model, effect.none()))
  use title <- result.try_recover(
    validate_title(model.title),
    fn(e) { #(Model(..model, error: Some(e)), effect.none()) }
  )
  use project_id <- option.try_recover(
    model.project_id,
    fn() { #(Model(..model, error: Some("No project")), effect.none()) }
  )
  // Submit with validated values
  #(
    Model(..model, in_flight: True),
    api.create(project_id, title, SubmitResult),
  )
}
```

### Principio 6: Labelled Arguments para Claridad

```gleam
// BAD: posicional, confuso en call sites
pub fn create_task_type(project_id, name, icon, callback)

// GOOD: self-documenting
pub fn create_task_type(
  project_id project_id: Int,
  name name: String,
  icon icon: Option(String),
  on_result callback: fn(ApiResult(TaskType)) -> Msg,
) -> Effect(Msg)

// Call site es claro:
create_task_type(
  project_id: model.project_id,
  name: form.name,
  icon: form.icon,
  on_result: TaskTypeCreated,
)
```

### Principio 7: Tipos de Error Espec√≠ficos por Dominio

```gleam
// domain/crud_error.gleam

pub type CrudError {
  /// Entity not found (404)
  NotFound(entity_type: String, id: Int)
  /// Conflict: entity in use (409)
  InUse(entity_type: String, dependents: Int)
  /// Validation failed (400)
  ValidationFailed(field: String, reason: String)
  /// Unauthorized (401)
  Unauthorized
  /// Server error (500)
  ServerError(message: String)
}

pub fn from_api_error(err: ApiError, entity_type: String) -> CrudError {
  case err.status {
    401 -> Unauthorized
    404 -> NotFound(entity_type, 0)
    409 -> InUse(entity_type, 0)
    400 -> ValidationFailed("unknown", err.message)
    _ -> ServerError(err.message)
  }
}
```

### Principio 8: Vistas Config Admin como M√≥dulo Unificado

```gleam
// features/admin/config_views.gleam - Shared view patterns

pub type ConfigTableColumn(item, msg) {
  ConfigTableColumn(
    header: i18n_text.Text,
    width: String,
    render: fn(Locale, item) -> Element(msg),
  )
}

pub fn view_config_table(
  locale: Locale,
  columns: List(ConfigTableColumn(item, msg)),
  items: List(item),
  empty_message: i18n_text.Text,
) -> Element(msg) {
  case items {
    [] -> view_empty_state(locale, empty_message)
    _ ->
      html.table([class("config-table")], [
        view_table_header(locale, columns),
        view_table_body(locale, columns, items),
      ])
  }
}

pub fn view_action_buttons(
  on_edit: msg,
  on_delete: msg,
  can_delete: Bool,
) -> Element(msg) {
  div([class("action-buttons")], [
    button([class("btn-icon"), event.on_click(on_edit)], [
      icons.nav_icon(icons.Pencil, icons.Small),
    ]),
    case can_delete {
      True ->
        button([class("btn-icon btn-danger"), event.on_click(on_delete)], [
          icons.nav_icon(icons.Trash, icons.Small),
        ])
      False -> element.none()
    },
  ])
}
```

### Checklist de Code Quality

Antes de marcar una tarea como completada, verificar:

- [ ] **CQ1**: Tipos opacos para IDs y valores validados
- [ ] **CQ2**: Estados ilegales son irrepresentables (ADTs, no flags)
- [ ] **CQ3**: Handlers usan `crud_helpers` en lugar de duplicar l√≥gica
- [ ] **CQ4**: Dialogs usan `view_dialog_shell` compartido
- [ ] **CQ5**: Errores propagados con `use`, no callbacks anidados
- [ ] **CQ6**: Funciones p√∫blicas con labelled arguments
- [ ] **CQ7**: `///` doc comments en todas las funciones `pub`
- [ ] **CQ8**: Tests unitarios para smart constructors
- [ ] **CQ9**: No hay `let assert` en c√≥digo que recibe input externo
- [ ] **CQ10**: Exhaustive pattern matching (no wildcards innecesarios)

---

## References

- An√°lisis modelo de datos: Conversaci√≥n con Sally (UX Expert)
- Story 4.8: UX Refinement (prerequisito)
- API existente: `api/cards.gleam`, `api/workflows.gleam`
- Componentes existentes: `card_crud_dialog.gleam`, `task_template_crud_dialog.gleam`
- [Bulletproof Type Safety in Gleam](https://blog.andreyfadeev.com/p/bulletproof-type-safety-in-gleam) - End-to-end type safety patterns
- Gleam TDD Development Skill - `guide.md` patterns reference
