# Story 3.3: MÃ©tricas del motor de reglas v1 (validaciÃ³n del motor)

## Status: Ready for Dev

## Story
**As an** org admin (or project admin),
**I want** per-rule metrics and traceability with drill-down to individual executions,
**so that** I can validate the rules engine behavior, detect issues early, and understand rule effectiveness.

## Acceptance Criteria

1. **Per-rule counters**: For each rule, the system exposes counts for `evaluated`, `applied`, and `suppressed`.
2. **Suppression breakdown**: Suppressed events include reason breakdown: `idempotent | not_user_triggered | not_matching | inactive`.
3. **Date range filter**: Metrics can be filtered by start/end date range.
4. **Drill-down to executions**: Clicking on a counter shows a list of individual executions for that rule.
5. **Admin-only visibility**: Only org admins (and project admins for project-scoped rules) can access rule metrics.
6. **No leaderboards**: Rule metrics do not rank users; they focus on rule behavior.
7. **UI: Workflow summary**: Workflows/Rules view shows inline metric summary (applied/suppressed counts).
8. **UI: Dedicated metrics tab**: A dedicated "Rule Metrics" tab shows detailed metrics with filtering and drill-down.
9. **API conventions**: Responses follow `{ data: ... }` envelope; timestamps ISO-8601 UTC.

## Tasks / Subtasks

- [ ] Task 1: Server - Metrics query endpoints (AC: 1, 2, 3, 5, 9)
  - [ ] Create `apps/server/src/scrumbringer_server/http/rule_metrics.gleam`
  - [ ] Create `apps/server/src/scrumbringer_server/services/rule_metrics_db.gleam`
  - [ ] Create SQL queries in `apps/server/src/scrumbringer_server/sql/rule_metrics_*.sql`
  - [ ] Endpoints:
    - [ ] `GET /api/v1/workflows/:id/metrics` â€” aggregated metrics for all rules in workflow
    - [ ] `GET /api/v1/rules/:id/metrics` â€” aggregated metrics for single rule
    - [ ] `GET /api/v1/rules/:id/executions` â€” paginated list of executions (drill-down)
    - [ ] `GET /api/v1/org/rule-metrics` â€” org-wide metrics summary
    - [ ] `GET /api/v1/projects/:id/rule-metrics` â€” project-scoped metrics summary

- [ ] Task 2: Server - Date range filtering (AC: 3)
  - [ ] Add query params `from` and `to` (ISO-8601) to metrics endpoints
  - [ ] Default: last 30 days if not specified
  - [ ] Validate date range (max 90 days in v1)

- [ ] Task 3: Client - Inline metrics in Workflows view (AC: 7)
  - [ ] Modify `apps/client/src/scrumbringer_client/features/admin/workflows.gleam`
  - [ ] Show applied/suppressed counts next to each rule
  - [ ] Fetch metrics on workflow detail view load

- [ ] Task 4: Client - Dedicated Rule Metrics tab (AC: 4, 8)
  - [ ] Create `apps/client/src/scrumbringer_client/features/admin/rule_metrics.gleam`
  - [ ] Add "Rule Metrics" tab in Admin
  - [ ] Implement:
    - [ ] Date range picker (from/to)
    - [ ] Metrics table with counters per rule
    - [ ] Suppression reason breakdown (expandable)
    - [ ] Click on counter â†’ drill-down modal/panel with executions list
  - [ ] Add i18n keys

- [ ] Task 5: Tests (AC: all)
  - [ ] Server tests: `apps/server/test/rule_metrics_test.gleam`
  - [ ] Client tests: `apps/client/test/rule_metrics_decode_test.gleam`

## Dev Notes

### Source Tree (relevante para esta story)

```
apps/
â”œâ”€â”€ client/
â”‚   â”œâ”€â”€ src/scrumbringer_client/
â”‚   â”‚   â”œâ”€â”€ api.gleam                          # MODIFY: add metrics endpoints
â”‚   â”‚   â”œâ”€â”€ features/admin/
â”‚   â”‚   â”‚   â”œâ”€â”€ admin.gleam                    # MODIFY: add Rule Metrics tab
â”‚   â”‚   â”‚   â”œâ”€â”€ workflows.gleam                # MODIFY: inline metrics
â”‚   â”‚   â”‚   â””â”€â”€ rule_metrics.gleam             # NEW: dedicated metrics view
â”‚   â”‚   â””â”€â”€ i18n/
â”‚   â”‚       â”œâ”€â”€ text.gleam                     # MODIFY: add RuleMetrics* keys
â”‚   â”‚       â”œâ”€â”€ es.gleam                       # MODIFY
â”‚   â”‚       â””â”€â”€ en.gleam                       # MODIFY
â”‚   â””â”€â”€ test/
â”‚       â””â”€â”€ rule_metrics_decode_test.gleam     # NEW
â”œâ”€â”€ server/
â”‚   â”œâ”€â”€ src/scrumbringer_server/
â”‚   â”‚   â”œâ”€â”€ scrumbringer_server.gleam          # MODIFY: register routes
â”‚   â”‚   â”œâ”€â”€ http/
â”‚   â”‚   â”‚   â””â”€â”€ rule_metrics.gleam             # NEW
â”‚   â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”‚   â””â”€â”€ rule_metrics_db.gleam          # NEW
â”‚   â”‚   â””â”€â”€ sql/
â”‚   â”‚       â”œâ”€â”€ rule_metrics_by_workflow.sql   # NEW
â”‚   â”‚       â”œâ”€â”€ rule_metrics_by_rule.sql       # NEW
â”‚   â”‚       â”œâ”€â”€ rule_executions_list.sql       # NEW
â”‚   â”‚       â””â”€â”€ rule_metrics_summary.sql       # NEW
â”‚   â””â”€â”€ test/
â”‚       â””â”€â”€ rule_metrics_test.gleam            # NEW
```

### Data Source (from Story 3.2)

Story 3.2 creates `rule_executions` table:

```sql
CREATE TABLE rule_executions (
    id BIGSERIAL PRIMARY KEY,
    rule_id BIGINT NOT NULL REFERENCES rules(id) ON DELETE CASCADE,
    origin_type TEXT NOT NULL,  -- 'task' | 'card'
    origin_id BIGINT NOT NULL,
    outcome TEXT NOT NULL,  -- 'applied' | 'suppressed'
    suppression_reason TEXT,  -- 'idempotent' | 'not_user_triggered' | 'not_matching' | 'inactive'
    user_id BIGINT REFERENCES users(id),
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    UNIQUE(rule_id, origin_type, origin_id)
);
```

This story queries this table for aggregated metrics.

### Metrics Queries

**Aggregated metrics per rule:**

```sql
-- rule_metrics_by_rule.sql
SELECT
    r.id AS rule_id,
    r.name AS rule_name,
    COUNT(re.id) AS evaluated_count,
    COUNT(re.id) FILTER (WHERE re.outcome = 'applied') AS applied_count,
    COUNT(re.id) FILTER (WHERE re.outcome = 'suppressed') AS suppressed_count,
    COUNT(re.id) FILTER (WHERE re.suppression_reason = 'idempotent') AS suppressed_idempotent,
    COUNT(re.id) FILTER (WHERE re.suppression_reason = 'not_user_triggered') AS suppressed_not_user,
    COUNT(re.id) FILTER (WHERE re.suppression_reason = 'not_matching') AS suppressed_not_matching,
    COUNT(re.id) FILTER (WHERE re.suppression_reason = 'inactive') AS suppressed_inactive
FROM rules r
LEFT JOIN rule_executions re ON re.rule_id = r.id
    AND re.created_at >= $2  -- from
    AND re.created_at <= $3  -- to
WHERE r.id = $1
GROUP BY r.id;
```

**Metrics for all rules in workflow:**

```sql
-- rule_metrics_by_workflow.sql
SELECT
    r.id AS rule_id,
    r.name AS rule_name,
    r.active,
    COUNT(re.id) AS evaluated_count,
    COUNT(re.id) FILTER (WHERE re.outcome = 'applied') AS applied_count,
    COUNT(re.id) FILTER (WHERE re.outcome = 'suppressed') AS suppressed_count
FROM rules r
LEFT JOIN rule_executions re ON re.rule_id = r.id
    AND re.created_at >= $2
    AND re.created_at <= $3
WHERE r.workflow_id = $1
GROUP BY r.id
ORDER BY r.name;
```

**Executions list (drill-down):**

```sql
-- rule_executions_list.sql
SELECT
    re.id,
    re.origin_type,
    re.origin_id,
    re.outcome,
    re.suppression_reason,
    re.user_id,
    u.email AS user_email,
    re.created_at
FROM rule_executions re
LEFT JOIN users u ON u.id = re.user_id
WHERE re.rule_id = $1
    AND re.created_at >= $2
    AND re.created_at <= $3
ORDER BY re.created_at DESC
LIMIT $4 OFFSET $5;
```

### API Contract

**Endpoints:**

| Method | Path | Auth | Description |
|--------|------|------|-------------|
| GET | `/api/v1/workflows/:id/metrics` | Admin | Metrics for all rules in workflow |
| GET | `/api/v1/rules/:id/metrics` | Admin | Detailed metrics for single rule |
| GET | `/api/v1/rules/:id/executions` | Admin | Paginated executions list |
| GET | `/api/v1/org/rule-metrics` | Org Admin | Org-wide summary |
| GET | `/api/v1/projects/:id/rule-metrics` | Project Admin | Project-scoped summary |

**Query params (all metrics endpoints):**

| Param | Type | Default | Description |
|-------|------|---------|-------------|
| `from` | ISO-8601 | now - 30 days | Start of date range |
| `to` | ISO-8601 | now | End of date range |

**Query params (executions list):**

| Param | Type | Default | Description |
|-------|------|---------|-------------|
| `from` | ISO-8601 | now - 30 days | Start of date range |
| `to` | ISO-8601 | now | End of date range |
| `limit` | Int | 50 | Page size (max 100) |
| `offset` | Int | 0 | Pagination offset |

**Workflow Metrics Response:**

```json
{
  "data": {
    "workflow_id": 1,
    "workflow_name": "QA Automation",
    "from": "2026-01-01T00:00:00Z",
    "to": "2026-01-18T23:59:59Z",
    "rules": [
      {
        "rule_id": 1,
        "rule_name": "Feature â†’ QA Review",
        "active": true,
        "evaluated_count": 42,
        "applied_count": 38,
        "suppressed_count": 4
      }
    ],
    "totals": {
      "evaluated_count": 42,
      "applied_count": 38,
      "suppressed_count": 4
    }
  }
}
```

**Rule Metrics Response (detailed):**

```json
{
  "data": {
    "rule_id": 1,
    "rule_name": "Feature â†’ QA Review",
    "from": "2026-01-01T00:00:00Z",
    "to": "2026-01-18T23:59:59Z",
    "evaluated_count": 42,
    "applied_count": 38,
    "suppressed_count": 4,
    "suppression_breakdown": {
      "idempotent": 3,
      "not_user_triggered": 1,
      "not_matching": 0,
      "inactive": 0
    }
  }
}
```

**Executions List Response:**

```json
{
  "data": {
    "rule_id": 1,
    "executions": [
      {
        "id": 123,
        "origin_type": "task",
        "origin_id": 456,
        "outcome": "applied",
        "suppression_reason": null,
        "user_id": 42,
        "user_email": "dev@team.com",
        "created_at": "2026-01-18T10:30:00Z"
      },
      {
        "id": 122,
        "origin_type": "task",
        "origin_id": 455,
        "outcome": "suppressed",
        "suppression_reason": "idempotent",
        "user_id": 42,
        "user_email": "dev@team.com",
        "created_at": "2026-01-18T10:25:00Z"
      }
    ],
    "pagination": {
      "limit": 50,
      "offset": 0,
      "total": 42
    }
  }
}
```

### Admin UI

**Inline en Workflows (resumen):**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Workflow: QA Automation                              [Active âœ“] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Rules:                                                          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Feature â†’ QA Review          Applied: 38  Suppressed: 4    â”‚ â”‚
â”‚ â”‚ Card Done â†’ Release          Applied: 12  Suppressed: 0    â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Tab dedicado "Rule Metrics":**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Rule Metrics                                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Date Range: [2026-01-01] to [2026-01-18]        [Apply Filter]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Rule                    â”‚ Evaluated â”‚ Applied â”‚ Suppressed â”‚    â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚    â”‚
â”‚ Feature â†’ QA Review     â”‚    42     â”‚   38    â”‚     4  [â–¼] â”‚    â”‚
â”‚   â””â”€ idempotent: 3, not_user_triggered: 1                  â”‚    â”‚
â”‚ Card Done â†’ Release     â”‚    12     â”‚   12    â”‚     0      â”‚    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Drill-down (click en counter):**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Executions: Feature â†’ QA Review (Suppressed: 4)         [Close] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Time                â”‚ Origin      â”‚ Reason           â”‚ User     â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ 2026-01-18 10:30    â”‚ Task #456   â”‚ idempotent       â”‚ dev@...  â”‚
â”‚ 2026-01-18 10:25    â”‚ Task #455   â”‚ idempotent       â”‚ dev@...  â”‚
â”‚ 2026-01-17 15:00    â”‚ Task #440   â”‚ not_user_trigg.  â”‚ (system) â”‚
â”‚ 2026-01-16 09:45    â”‚ Task #430   â”‚ idempotent       â”‚ dev@...  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Showing 1-4 of 4                              [< Prev] [Next >] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### i18n Keys (nuevas)

```gleam
pub type Text {
  // ... existing
  RuleMetricsTab
  RuleMetricsDateRange
  RuleMetricsFrom
  RuleMetricsTo
  RuleMetricsApplyFilter
  RuleMetricsEvaluated
  RuleMetricsApplied
  RuleMetricsSuppressed
  RuleMetricsSuppressionBreakdown
  RuleMetricsReasonIdempotent
  RuleMetricsReasonNotUserTriggered
  RuleMetricsReasonNotMatching
  RuleMetricsReasonInactive
  RuleMetricsExecutions
  RuleMetricsOrigin
  RuleMetricsUser
  RuleMetricsNoData
}
```

### Security Considerations

| Concern | Mitigation |
|---------|------------|
| Authz bypass | Validate admin role per endpoint; project admins only see project-scoped |
| Data exposure | Executions show user_email only to admins of same org |
| DoS via large queries | Max date range 90 days; pagination with max limit 100 |
| CSRF | Not needed (GET endpoints are read-only) |

### Future Enhancements (out of scope for v1)

| Feature | Description |
|---------|-------------|
| Time series | Counters por dÃ­a/hora para grÃ¡ficos de tendencia |
| Export | CSV/JSON export de mÃ©tricas |
| Alerts | Notificaciones si suppression rate > threshold |
| Goal validation | Comparar mÃ©tricas con `rule.goal` |

### Testing

**Server tests (`apps/server/test/rule_metrics_test.gleam`):**

*Aggregated Metrics:*

| Test | Description | AC |
|------|-------------|-----|
| `metrics_empty_test` | Rule with no executions â†’ all counters = 0 | AC1 |
| `metrics_applied_count_test` | N applied executions â†’ applied_count = N | AC1 |
| `metrics_suppressed_count_test` | M suppressed executions â†’ suppressed_count = M | AC1 |
| `metrics_evaluated_equals_sum_test` | evaluated_count = applied_count + suppressed_count | AC1 |
| `metrics_suppression_breakdown_test` | Breakdown by reason is correct | AC2 |
| `metrics_suppression_breakdown_idempotent_test` | idempotent reason counted correctly | AC2 |
| `metrics_suppression_breakdown_not_user_test` | not_user_triggered reason counted correctly | AC2 |
| `workflow_metrics_aggregates_rules_test` | Workflow metrics sums all rules | AC1 |
| `workflow_metrics_totals_test` | Workflow response includes totals object | AC1 |

*Date Filtering:*

| Test | Description | AC |
|------|-------------|-----|
| `date_filter_from_to_test` | Filter by date range works | AC3 |
| `date_filter_default_30_days_test` | No params uses last 30 days | AC3 |
| `date_filter_max_90_days_test` | Range > 90 days â†’ truncated or error | AC3 |
| `date_filter_invalid_format_test` | Invalid date format â†’ 422 | AC3,9 |
| `date_filter_from_after_to_test` | from > to â†’ 422 or empty results | AC3 |

*Drill-down:*

| Test | Description | AC |
|------|-------------|-----|
| `executions_list_test` | List executions for rule | AC4 |
| `executions_list_empty_test` | Rule with no executions â†’ empty list | AC4 |
| `executions_list_pagination_test` | Pagination with limit/offset works | AC4 |
| `executions_list_pagination_total_test` | Response includes total count | AC4 |
| `executions_list_includes_user_test` | Executions include user_id and user_email | AC4 |
| `executions_list_includes_origin_test` | Executions include origin_type and origin_id | AC4 |

*Authorization:*

| Test | Description | AC |
|------|-------------|-----|
| `authz_org_admin_sees_all_test` | Org admin can see all org metrics | AC5 |
| `authz_project_admin_sees_project_test` | Project admin sees project-scoped only | AC5 |
| `authz_member_denied_test` | Member cannot access metrics â†’ 403 | AC5 |
| `authz_cross_org_denied_test` | Cannot access metrics from another org â†’ 403 | AC5 |

**Client tests (`apps/client/test/rule_metrics_decode_test.gleam`):**

| Test | Description | AC |
|------|-------------|-----|
| `decode_workflow_metrics_test` | Decode workflow metrics with rules array | AC1,7 |
| `decode_workflow_metrics_totals_test` | Decode totals object correctly | AC1 |
| `decode_rule_metrics_test` | Decode rule metrics with breakdown | AC2 |
| `decode_rule_metrics_breakdown_test` | Decode suppression_breakdown object | AC2 |
| `decode_executions_list_test` | Decode executions with all fields | AC4 |
| `decode_executions_pagination_test` | Decode pagination object | AC4 |

**Commands:**
- Server: `make test`
- Client: `cd apps/client && gleam test`

## Frontend Spec

### Overview

La UI de mÃ©tricas tiene dos partes:
1. **Inline en Workflows** - Contadores de applied/suppressed por regla
2. **Tab dedicado "Rule Metrics"** - Vista completa con filtros y drill-down

### User Flow: Viewing Rule Metrics

```mermaid
graph TD
    A[Admin in Workflows tab] --> B[See inline metrics per rule]
    B --> C[Click Rule Metrics tab for detail]

    C --> D[Rule Metrics tab loads]
    D --> E[Default: last 30 days]
    E --> F[Show metrics table]

    F --> G{Action?}
    G -->|Change date range| H[Update from/to pickers]
    H --> I[Click Apply Filter]
    I --> J[Reload metrics with new range]

    G -->|Expand suppression| K[Show breakdown by reason]

    G -->|Click counter| L[Open drill-down modal]
    L --> M[Show executions list]
    M --> N[Paginate through executions]
    N --> O[Click origin link to view task/card]
```

### Key Screens

#### Inline Metrics in Workflows Tab (from Story 3.2)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â–¼ QA Automation                              Org    [âœ“ Active]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ RULES                                                           â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Feature â†’ QA Review           [âœ“]                 [âœŽ] [ðŸ—‘] â”‚ â”‚
â”‚ â”‚ Task(Feature) â†’ completed                                   â”‚ â”‚
â”‚ â”‚ ðŸ“Š Applied: 38  Suppressed: 4                   [View â–¶]   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Card Done â†’ Release           [âœ“]                 [âœŽ] [ðŸ—‘] â”‚ â”‚
â”‚ â”‚ Card â†’ cerrada                                              â”‚ â”‚
â”‚ â”‚ ðŸ“Š Applied: 12  Suppressed: 0                   [View â–¶]   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Dedicated Rule Metrics Tab

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ADMIN > Rule Metrics                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚ Date Range                                                      â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚ â”‚ ðŸ“… 2026-01-01â”‚ to â”‚ ðŸ“… 2026-01-18â”‚    [Apply Filter]         â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                                                                 â”‚
â”‚ Workflow: [â–¼ All workflows        ]                            â”‚
â”‚                                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Rule                    â”‚Evaluatedâ”‚ Applied â”‚Suppressedâ”‚    â”‚ â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¤ â”‚
â”‚ â”‚ Feature â†’ QA Review     â”‚   42    â”‚  [38]   â”‚   [4]    â”‚ â–¼  â”‚ â”‚
â”‚ â”‚ â”œâ”€ Suppression breakdown:                              â”‚    â”‚ â”‚
â”‚ â”‚ â”‚  â€¢ idempotent: 3                                     â”‚    â”‚ â”‚
â”‚ â”‚ â”‚  â€¢ not_user_triggered: 1                             â”‚    â”‚ â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¤ â”‚
â”‚ â”‚ Card Done â†’ Release     â”‚   12    â”‚  [12]   â”‚   [0]    â”‚ â–¶  â”‚ â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¤ â”‚
â”‚ â”‚ Bug â†’ Regression Test   â”‚   25    â”‚  [20]   â”‚   [5]    â”‚ â–¶  â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                 â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ TOTALS                    â”‚   79    â”‚   70    â”‚    9     â”‚      â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[38] [4] = clickable counters for drill-down
â–¼ â–¶ = expand/collapse suppression breakdown
```

#### Drill-down Modal: Executions List

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Rule Executions: Feature â†’ QA Review                     [âœ•]    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚ Showing: Suppressed executions (4 total)                       â”‚
â”‚                                                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Time             â”‚ Origin       â”‚ Reason          â”‚ User    â”‚ â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚ â”‚ Jan 18, 10:30    â”‚ [Task #456]  â”‚ ðŸ” idempotent   â”‚ @john   â”‚ â”‚
â”‚ â”‚ Jan 18, 10:25    â”‚ [Task #455]  â”‚ ðŸ” idempotent   â”‚ @john   â”‚ â”‚
â”‚ â”‚ Jan 17, 15:00    â”‚ [Task #440]  â”‚ ðŸ¤– not_user_tr. â”‚ (system)â”‚ â”‚
â”‚ â”‚ Jan 16, 09:45    â”‚ [Task #430]  â”‚ ðŸ” idempotent   â”‚ @jane   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                 â”‚
â”‚ Showing 1-4 of 4                        [â—€ Prev]  [Next â–¶]     â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Drill-down: Applied Executions

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Rule Executions: Feature â†’ QA Review                     [âœ•]    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚ Showing: Applied executions (38 total)                         â”‚
â”‚                                                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Time             â”‚ Origin       â”‚ Tasks Created   â”‚ User    â”‚ â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚ â”‚ Jan 18, 11:00    â”‚ [Task #460]  â”‚ 1 task created  â”‚ @john   â”‚ â”‚
â”‚ â”‚ Jan 18, 09:15    â”‚ [Task #458]  â”‚ 1 task created  â”‚ @jane   â”‚ â”‚
â”‚ â”‚ Jan 17, 16:30    â”‚ [Task #445]  â”‚ 1 task created  â”‚ @john   â”‚ â”‚
â”‚ â”‚ ...              â”‚ ...          â”‚ ...             â”‚ ...     â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                 â”‚
â”‚ Showing 1-50 of 38                      [â—€ Prev]  [Next â–¶]     â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Empty State

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ADMIN > Rule Metrics                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚ Date Range: [2026-01-01] to [2026-01-18]      [Apply Filter]   â”‚
â”‚                                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚                    ðŸ“Š                                           â”‚
â”‚                                                                 â”‚
â”‚            No metrics data for this period                      â”‚
â”‚                                                                 â”‚
â”‚   Rules haven't been evaluated yet, or no workflows exist.     â”‚
â”‚   Create workflows and rules to start tracking metrics.         â”‚
â”‚                                                                 â”‚
â”‚                    [Go to Workflows â†’]                          â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Components

| Component | File | Status | Description |
|-----------|------|--------|-------------|
| `RuleMetricsTab` | `features/admin/rule_metrics.gleam` | NEW | Main metrics view |
| `DateRangePicker` | `ui/date_picker.gleam` | NEW | From/To date inputs |
| `MetricsTable` | `features/admin/rule_metrics.gleam` | NEW | Table with counters |
| `MetricsRow` | `features/admin/rule_metrics.gleam` | NEW | Row with expandable breakdown |
| `SuppressionBreakdown` | `features/admin/rule_metrics.gleam` | NEW | Reason breakdown list |
| `ExecutionsModal` | `features/admin/rule_metrics.gleam` | NEW | Drill-down modal |
| `ExecutionsList` | `features/admin/rule_metrics.gleam` | NEW | Paginated executions |
| `Pagination` | `ui/pagination.gleam` | NEW | Reusable pagination |
| `RuleInlineMetrics` | `features/admin/workflows.gleam` | MODIFY | Add inline counters |

### Component State

```gleam
type RuleMetricsState {
  date_from: Date
  date_to: Date
  workflow_filter: Option(Int)  // None = all workflows
  metrics: Remote(WorkflowMetrics)
  expanded_rules: Set(Int)  // rule_ids with visible breakdown
  drill_down: Option(DrillDownState)
}

type WorkflowMetrics {
  workflow_id: Option(Int)
  workflow_name: Option(String)
  from: Time
  to: Time
  rules: List(RuleMetrics)
  totals: MetricsTotals
}

type RuleMetrics {
  rule_id: Int
  rule_name: String
  active: Bool
  evaluated_count: Int
  applied_count: Int
  suppressed_count: Int
  suppression_breakdown: SuppressionBreakdown
}

type SuppressionBreakdown {
  idempotent: Int
  not_user_triggered: Int
  not_matching: Int
  inactive: Int
}

type MetricsTotals {
  evaluated_count: Int
  applied_count: Int
  suppressed_count: Int
}

type DrillDownState {
  rule_id: Int
  rule_name: String
  outcome_filter: OutcomeFilter  // Applied | Suppressed | All
  executions: Remote(ExecutionsList)
  page: Int
}

type ExecutionsList {
  executions: List(Execution)
  pagination: Pagination
}

type Execution {
  id: Int
  origin_type: String  // "task" | "card"
  origin_id: Int
  outcome: String
  suppression_reason: Option(String)
  user_id: Option(Int)
  user_email: Option(String)
  created_at: Time
}

type Pagination {
  limit: Int
  offset: Int
  total: Int
}
```

### States & Interactions

| State | Visual | Behavior |
|-------|--------|----------|
| **Loading** | Spinner | Fetch metrics for date range |
| **Empty** | Empty state with hint | Link to Workflows tab |
| **With data** | Metrics table | Counters clickable |
| **Date change** | Date pickers | Requires Apply button |
| **Filter workflow** | Dropdown | Filter to single workflow |
| **Expand breakdown** | â–¼ arrow | Show suppression reasons |
| **Drill-down** | Modal | Show executions list |
| **Pagination** | Prev/Next | Load more executions |

### Date Range Validation

| Scenario | Behavior |
|----------|----------|
| Default | Last 30 days |
| Max range | 90 days (show warning if exceeded) |
| from > to | Show error, disable Apply |
| Invalid date | Show error on field |

### Suppression Reason Icons

| Reason | Icon | Description |
|--------|------|-------------|
| `idempotent` | ðŸ” | Rule already fired for this origin |
| `not_user_triggered` | ðŸ¤– | System change, not user action |
| `not_matching` | ðŸš« | Filter conditions not met |
| `inactive` | â¸ | Rule or workflow was inactive |

### Responsive Behavior

| Breakpoint | Metrics Table | Drill-down |
|------------|---------------|------------|
| Desktop (>1024px) | Full table | Modal 720px |
| Tablet (640-1024px) | Hide Evaluated column | Modal 90% |
| Mobile (<640px) | Stacked cards | Full screen |

### Accessibility

| Requirement | Implementation |
|-------------|----------------|
| Clickable counters | `role="button"`, `tabindex="0"` |
| Date pickers | Native `<input type="date">` |
| Expandable rows | `aria-expanded`, `aria-controls` |
| Pagination | `aria-label` on buttons, current page announced |
| Modal | Focus trap, Escape to close |
| Origin links | Clear link text "[Task #456]" |

### CSS Classes

```css
/* Metrics table */
.metrics-table {
  width: 100%;
  border-collapse: collapse;
}

.metrics-table th {
  text-align: left;
  padding: 12px;
  font-weight: 600;
  color: var(--sb-text-muted);
  border-bottom: 2px solid var(--sb-border);
}

.metrics-table td {
  padding: 12px;
  border-bottom: 1px solid var(--sb-border);
}

.metrics-table tr:hover {
  background: var(--sb-surface-hover);
}

/* Clickable counter */
.metric-counter {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 48px;
  padding: 4px 12px;
  border-radius: 4px;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.2s;
}

.metric-counter:hover {
  background: var(--sb-surface-hover);
}

.metric-counter.applied {
  color: var(--sb-success);
}

.metric-counter.suppressed {
  color: var(--sb-warning);
}

.metric-counter.zero {
  color: var(--sb-text-muted);
  cursor: default;
}

/* Suppression breakdown */
.suppression-breakdown {
  padding: 8px 12px 8px 24px;
  font-size: 0.9em;
  color: var(--sb-text-muted);
  background: var(--sb-surface-elevated);
  border-left: 3px solid var(--sb-warning);
}

.suppression-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 4px 0;
}

.suppression-icon {
  font-size: 1em;
}

/* Expand toggle */
.expand-toggle {
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: transform 0.2s;
}

.expand-toggle.expanded {
  transform: rotate(90deg);
}

/* Date range */
.date-range-picker {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 16px;
}

.date-input {
  padding: 8px 12px;
  border: 1px solid var(--sb-border);
  border-radius: 6px;
  background: var(--sb-surface);
}

/* Totals row */
.metrics-totals {
  font-weight: 700;
  background: var(--sb-surface-elevated);
}

/* Executions list */
.executions-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.9em;
}

.executions-table th {
  text-align: left;
  padding: 10px;
  background: var(--sb-surface-elevated);
}

.executions-table td {
  padding: 10px;
  border-bottom: 1px solid var(--sb-border);
}

.origin-link {
  color: var(--sb-primary);
  text-decoration: none;
}

.origin-link:hover {
  text-decoration: underline;
}

/* Empty state */
.metrics-empty {
  text-align: center;
  padding: 48px 24px;
  color: var(--sb-text-muted);
}

.metrics-empty-icon {
  font-size: 3em;
  margin-bottom: 16px;
}

/* Pagination */
.pagination {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 0;
  font-size: 0.9em;
  color: var(--sb-text-muted);
}

.pagination-buttons {
  display: flex;
  gap: 8px;
}
```

### i18n Keys

| Key | ES | EN |
|-----|----|----|
| `RuleMetricsTab` | MÃ©tricas de reglas | Rule Metrics |
| `RuleMetricsDateRange` | Rango de fechas | Date Range |
| `RuleMetricsFrom` | Desde | From |
| `RuleMetricsTo` | Hasta | To |
| `RuleMetricsApplyFilter` | Aplicar filtro | Apply Filter |
| `RuleMetricsWorkflow` | Workflow | Workflow |
| `RuleMetricsAllWorkflows` | Todos los workflows | All workflows |
| `RuleMetricsEvaluated` | Evaluadas | Evaluated |
| `RuleMetricsApplied` | Aplicadas | Applied |
| `RuleMetricsSuppressed` | Suprimidas | Suppressed |
| `RuleMetricsTotals` | Totales | Totals |
| `RuleMetricsSuppressionBreakdown` | Desglose de supresiones | Suppression breakdown |
| `RuleMetricsReasonIdempotent` | Idempotencia (ya ejecutada) | Idempotent (already fired) |
| `RuleMetricsReasonNotUserTriggered` | No disparada por usuario | Not user triggered |
| `RuleMetricsReasonNotMatching` | No coincide filtro | Filter not matching |
| `RuleMetricsReasonInactive` | Regla/workflow inactivo | Rule/workflow inactive |
| `RuleMetricsExecutions` | Ejecuciones | Executions |
| `RuleMetricsOrigin` | Origen | Origin |
| `RuleMetricsUser` | Usuario | User |
| `RuleMetricsTime` | Fecha/hora | Time |
| `RuleMetricsTasksCreated` | Tareas creadas | Tasks created |
| `RuleMetricsNoData` | Sin datos para este perÃ­odo | No data for this period |
| `RuleMetricsNoDataHint` | Las reglas no han sido evaluadas aÃºn | Rules haven't been evaluated yet |
| `RuleMetricsGoToWorkflows` | Ir a Workflows | Go to Workflows |
| `RuleMetricsShowing` | Mostrando | Showing |
| `RuleMetricsOf` | de | of |
| `RuleMetricsPrev` | Anterior | Prev |
| `RuleMetricsNext` | Siguiente | Next |
| `RuleMetricsDateRangeMax` | Rango mÃ¡ximo: 90 dÃ­as | Maximum range: 90 days |
| `RuleMetricsDateRangeInvalid` | Fecha inicial posterior a final | Start date after end date |

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-14 | 0.1 | Planning stub created | po |
| 2026-01-18 | 0.2 | Full story: date filter, drill-down, inline + dedicated UI | po |
| 2026-01-18 | 0.3 | Added Frontend Spec: metrics tab, date picker, drill-down modal, pagination | ux |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results

### Review Date: 2026-01-19

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Server metrics endpoints and DB layer are well-structured and follow existing fixtures/testing conventions. Client implementation is partial and diverges from the story requirements: the Rule Metrics tab surfaces only workflow summaries and the decoder contract for workflow metrics is mismatched with the server response.

### Refactoring Performed

- None.

### Compliance Check

- Coding Standards: âœ“ Server/DB modules follow existing patterns; client module aligns with update handler style.
- Project Structure: âœ“ Files are in expected locations.
- Testing Strategy: âœ— Client tests for metrics decode are missing; server tests are present but incomplete for date validation.
- All ACs Met: âœ— (AC2/3/4/8 incomplete; AC7/9 has a contract mismatch).

### Improvements Checklist

- [ ] Align workflow metrics decoder with `{ data: ... }` envelope (no nested `metrics`).
- [ ] Implement rule-level metrics tab (per-rule counters, suppression breakdown, drill-down executions).
- [ ] Enforce RFC3339 date validation and reject `from > to` with 422.
- [ ] Add client decode tests for rule metrics payloads and drill-down list.
- [ ] Add server tests for invalid date format and `from > to` cases.

### Security Review

Admin gating is enforced for org/project scopes; org-only metrics require org admin. No additional concerns noted.

### Performance Considerations

Pagination and date-range limits are in place; server queries are bounded. No regression risks identified.

### Files Modified During Review

- None.

### Gate Status

Gate: FAIL â†’ docs/qa/gates/3.3-metricas-del-motor-de-reglas-v1-validacion-del-motor.yml

### Recommended Status

[âœ— Changes Required - See unchecked items above]

---

### Review Date: 2026-01-19 (Follow-up)

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Server-side:** Excellent implementation. All 5 endpoints implemented correctly with proper authorization (org admin vs project admin). Date range filtering works with 90-day max validation. SQL queries are well-structured and performant.

**Client-side:** Substantial progress made:
- Inline metrics in Workflows view: âœ“ Implemented with Applied/Suppressed columns
- Dedicated Rule Metrics tab: âš ï¸ Partial - shows workflow summaries but lacks per-rule drill-down
- API functions: âœ“ Added `get_workflow_metrics`, `get_org_rule_metrics`, `get_project_rule_metrics`

**Critical Issue:** The `get_workflow_metrics` decoder (line 603) expects `decode.field("metrics", ...)` but the server wraps response in `{ "data": {...} }` and the client `core.request` already unwraps `data`. This will cause runtime decode errors.

### Refactoring Performed

- None.

### Compliance Check

- Coding Standards: âœ“ Both server and client follow existing patterns
- Project Structure: âœ“ Files in expected locations (server SQL, http, services; client api, features, i18n)
- Testing Strategy: âœ— Server tests present (9 tests); client decode tests missing
- All ACs Met: âš ï¸ Partial

| AC | Status | Notes |
|----|--------|-------|
| AC1 | âœ“ | Per-rule counters implemented |
| AC2 | âœ“ | Suppression breakdown in rule detail endpoint |
| AC3 | âš ï¸ | Date range works but `from > to` not rejected with 422 |
| AC4 | âœ“ | Drill-down executions endpoint exists |
| AC5 | âœ“ | Admin-only authorization enforced |
| AC6 | âœ“ | No user ranking (by design) |
| AC7 | âš ï¸ | Inline metrics implemented but decoder contract mismatch |
| AC8 | âš ï¸ | Tab exists but shows workflows only, not per-rule drill-down |
| AC9 | âœ“ | `{ data: ... }` envelope used throughout |

### Improvements Checklist

- [ ] **Fix decoder contract**: Remove `decode.field("metrics", ...)` wrapper in `get_workflow_metrics` - data is already unwrapped
- [ ] **Add `from > to` validation**: Server should return 422 when from date > to date
- [ ] **Complete Rule Metrics tab**: Add per-rule breakdown with clickable counters for drill-down modal
- [ ] **Add client decode tests**: Create `apps/client/test/rule_metrics_decode_test.gleam`
- [ ] **Add server edge case tests**: Invalid date format (422), `from > to` (422)

### Security Review

âœ“ Admin gating properly implemented:
- Org-scoped workflows require org admin
- Project-scoped workflows allow project admin OR org admin
- No data leakage to non-admins (403 returned)

### Performance Considerations

âœ“ Mitigations in place:
- 90-day max date range
- Pagination with limit 100 max
- SQL queries use indexed joins

### Files Modified During Review

- None.

### Gate Status

Gate: CONCERNS â†’ docs/qa/gates/3.3-workflows-admin-metrics.yml

Rationale: Core server functionality is complete and well-tested. Client has functional implementation but decoder mismatch will cause runtime errors. Dedicated tab is partial (workflow-level only). These are addressable issues that don't fundamentally block the feature.

### Recommended Status

[âš ï¸ Changes Required - Address decoder contract mismatch before production use]

Priority fixes:
1. HIGH: Fix `get_workflow_metrics` decoder (runtime error)
2. MEDIUM: Add `from > to` date validation
3. MEDIUM: Complete Rule Metrics tab with drill-down
4. LOW: Add missing tests
