# Story 2.6: Métricas v1 (event log + Mi panel + Admin overview)

## Status: Ready for Review

## Story
**As an** org admin (and as a member),
**I want** lightweight MVP metrics based on an event log,
**so that** I can monitor pool health and my own activity without introducing leaderboards.

## Acceptance Criteria
1. **Event log persisted**: The server records a minimal event log for task lifecycle actions (at least: task created, claimed, released, completed).
2. **No leaderboard**: Metrics endpoints and UI do not expose user rankings or “top users” lists.
3. **My metrics endpoint**: `GET /api/v1/me/metrics` exists and is authenticated (OA/PA/M).
   - Query: `window_days` (optional, integer). Default: `30` when omitted.
   - Response: `200` `{ data: { metrics: MyMetrics } }`.
4. **Admin overview endpoint**: `GET /api/v1/org/metrics/overview` exists and is org-admin only.
   - Query: `window_days` (optional, integer). Default: `30` when omitted.
   - Response: `200` `{ data: { overview: MetricsOverview } }`.
5. **KPI alignment**: Admin overview includes the MVP KPIs from the brief (computed org-wide and/or by project where applicable):
   - `time_to_first_claim` (from first successful login to first successful claim; null if no claim in window)
   - `pool_flow_ratio` (defined as `completed / claimed` in the requested window; if `claimed=0`, ratio is `null`)
   - `release_rate` (defined as `released / claimed` in the requested window; if `claimed=0`, rate is `null`)
6. **Distributions**: Admin overview includes distributions (histograms/buckets) for at least `time_to_first_claim` and `release_rate`.
7. **Drill-down limited to project/tasks**: Admin can drill down only to project and task level.
   - `GET /api/v1/org/metrics/projects/:project_id/tasks` returns a task list with fields needed to inspect the KPI drivers.
   - Query: `window_days` (optional, integer). Default: `30` when omitted.
8. **UI surfaces exist**:
   - Member UI has a “My Metrics” panel consuming `GET /api/v1/me/metrics`.
   - Admin UI has an “Metrics Overview” panel consuming `GET /api/v1/org/metrics/overview`.
9. **Consistent API conventions**: Responses use the `{ data: ... }` envelope and error shapes from `docs/architecture/api-contract.md`.

## Tasks / Subtasks
- [x] Define event log model and persistence (AC: 1)
  - [x] Add a DB table for events (e.g. `events` or `task_events`) with: `id`, `org_id`, `project_id`, `task_id`, `actor_user_id`, `event_type`, `created_at` (AC: 1)
  - [x] Decide minimal `event_type` vocabulary (create/claim/release/complete) (AC: 1)
- [x] Emit events from existing task endpoints (AC: 1)
  - [x] On task create: emit `task_created` (AC: 1)
  - [x] On claim/release/complete: emit corresponding events (AC: 1)
- [x] Implement metrics queries and endpoints (AC: 3, 4, 5, 6, 7, 9)
   - [x] Implement `GET /api/v1/me/metrics` (AC: 3)
     - [x] Support `window_days` query param; default to `30` days when omitted (AC: 3)
     - [x] Provide counts for the current user (claimed, released, completed) within the requested window (AC: 3)
   - [x] Implement `GET /api/v1/org/metrics/overview` (AC: 4, 5, 6)
     - [x] Support `window_days` query param; default to `30` days when omitted (AC: 4)
     - [x] Compute `time_to_first_claim` buckets (e.g. 0–1h, 1–4h, 4–24h, >24h) (AC: 6)
    - [x] Compute `release_rate` as `releases / claims` (org-wide and by project) (AC: 5, 6)
    - [x] Compute `pool_flow_ratio` (document chosen definition clearly in the response fields) (AC: 5)
   - [x] Implement `GET /api/v1/org/metrics/projects/:project_id/tasks` (AC: 7)
     - [x] Support `window_days` query param; default to `30` days when omitted (AC: 7)
     - [x] Return tasks in the project with derived fields needed for drill-down (created_at, first_claimed_at?, release_count?, status, etc.) (AC: 7)
- [x] Implement UI panels (AC: 8)
  - [x] Member: add a “My Metrics” section/panel and render the returned metrics (AC: 8)
  - [x] Admin: add a “Metrics Overview” section/panel and render distributions + KPI summaries (AC: 8)
  - [x] Drill-down: from Admin overview, navigate to a project-level task list view (AC: 7)
- [x] Add tests (AC: 1, 3, 4, 7)
  - [x] Server: event emission on claim/release/complete (AC: 1)
  - [x] Server: authz for org admin overview (403 for non-org-admin) (AC: 4)
  - [x] Server: drill-down endpoint is project-scoped and returns expected shape (AC: 7)
  - [x] Client: decode + render for my metrics and admin overview (AC: 8)

## Dev Notes
### Source of truth
- KPI definitions and targets are stated in the brief: `docs/brief.md` (see “Métricas MVP”).
- API conventions (envelope, error shape, roles) are defined in: `docs/architecture/api-contract.md`.

### Suggested endpoints (new)
- `GET /api/v1/me/metrics`
- `GET /api/v1/org/metrics/overview`
- `GET /api/v1/org/metrics/projects/:project_id/tasks`

### KPI notes (MVP)
- The brief defines targets for:
  - `time_to_first_claim` (< 4h P50)
  - `pool_flow_ratio` (> 0.8)
  - `release_rate` (< 15%)
  [Source: `docs/brief.md` “Métricas MVP”]
- This story should compute and expose these metrics; it should not introduce competitive ranking/leaderboards.

## Testing
- Server: `make test`
- Client: `apps/client: gleam test`

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-14 | 1.0 | Initial draft | po |
| 2026-01-14 | 1.1 | Ready for dev (DoR passed; KPI formulas fixed; window_days default 30) | po |
| 2026-01-15 | 1.2 | Implement metrics v1 (event log, endpoints, UI) | dev |

## Dev Agent Record

### Agent Model Used
- OpenCode/Codex CLI (model provided by platform)

### Debug Log References
- `DATABASE_URL=postgres://scrumbringer:scrumbringer@localhost:5432/scrumbringer_test?sslmode=disable make verify`
- `cd apps/client && gleam test`

### Completion Notes
- Added `task_events` persistence and transactional emission for `task_created`, `task_claimed`, `task_released`, `task_completed`.
- Implemented metrics endpoints and SQL queries (org overview + per-user counts + project drill-down) with `window_days` validation.
- Added UI panels: Member “My Metrics” (inside My Bar) and Admin “Metrics” section with overview + buckets + project drill-down.

### File List
- Added: `db/migrations/20260115130000_create_task_events.sql`
- Added: `apps/server/src/scrumbringer_server/sql/task_events_insert.sql`
- Added: `apps/server/src/scrumbringer_server/sql/metrics_my.sql`
- Added: `apps/server/src/scrumbringer_server/sql/metrics_org_overview.sql`
- Added: `apps/server/src/scrumbringer_server/sql/metrics_org_overview_by_project.sql`
- Added: `apps/server/src/scrumbringer_server/sql/metrics_project_tasks.sql`
- Added: `apps/server/src/scrumbringer_server/sql/metrics_release_rate_buckets.sql`
- Added: `apps/server/src/scrumbringer_server/sql/metrics_time_to_first_claim_buckets.sql`
- Added: `apps/server/src/scrumbringer_server/sql/metrics_time_to_first_claim_p50_ms.sql`
- Modified: `apps/server/src/scrumbringer_server/sql.gleam`
- Added: `apps/server/src/scrumbringer_server/services/task_events_db.gleam`
- Modified: `apps/server/src/scrumbringer_server/services/tasks_db.gleam`
- Added: `apps/server/src/scrumbringer_server/http/me_metrics.gleam`
- Added: `apps/server/src/scrumbringer_server/http/org_metrics.gleam`
- Modified: `apps/server/src/scrumbringer_server/http/tasks.gleam`
- Modified: `apps/server/src/scrumbringer_server.gleam`
- Modified: `apps/server/test/tasks_http_test.gleam`
- Modified: `apps/client/src/scrumbringer_client/api.gleam`
- Modified: `apps/client/src/scrumbringer_client/hydration.gleam`
- Modified: `apps/client/src/scrumbringer_client/permissions.gleam`
- Modified: `apps/client/src/scrumbringer_client/router.gleam`
- Modified: `apps/client/src/scrumbringer_client.gleam`
- Modified: `apps/client/test/hydration_test.gleam`
- Modified: `apps/client/test/permissions_test.gleam`

## QA Results

### Review Date: 2026-01-15

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

- Server-side approach is clean and testable: dedicated handlers (`apps/server/src/scrumbringer_server/http/me_metrics.gleam`, `apps/server/src/scrumbringer_server/http/org_metrics.gleam`) and minimal query surface in `apps/server/src/scrumbringer_server/sql/*.sql`.
- Event emission is implemented transactionally alongside task mutations, reducing risk of partial writes.

### Requirements Traceability (High Level)

- AC1: Covered via `task_events` migration + event emission test in `apps/server/test/tasks_http_test.gleam`.
- AC3/4/7: Covered via endpoint tests in `apps/server/test/tasks_http_test.gleam` and client integration via new API decoders and UI rendering.
- AC5/6: Implemented (KPIs + buckets), but see KPI definition concern below.

### Notable Finding

- **KPI definition mismatch (time_to_first_claim)**
  - AC5 defines this as **first successful login → first claim**.
  - Current implementation computes **users.created_at → first claim** (`apps/server/src/scrumbringer_server/sql/metrics_time_to_first_claim_p50_ms.sql`).
  - Recommendation: either (a) persist first successful login timestamp and compute from that, or (b) adjust the story/brief definition to explicitly use account creation.

### Tests Re-run (QA)

- `DATABASE_URL=postgres://scrumbringer:scrumbringer@localhost:5432/scrumbringer_test?sslmode=disable make verify` (PASS)
- `apps/client: gleam test` (PASS)

### Gate Status

Gate: CONCERNS → docs/qa/gates/2.6-metricas-v1-event-log-mi-panel-admin-overview.yml

### Recommended Status

✗ Changes Required - clarify the time_to_first_claim definition and align implementation accordingly.

### Review Date: 2026-01-15

### Reviewed By: Quinn (Test Architect)

### Delta Since Last Gate

- ✅ Persisted `users.first_login_at` on first successful login and updated `time_to_first_claim` computations to use first-login timestamp instead of account creation.
- ✅ Re-ran test suites (server + client) successfully.

### Tests Re-run (QA)

- `DATABASE_URL=postgres://scrumbringer:scrumbringer@localhost:5432/scrumbringer_test?sslmode=disable make verify` (PASS)
- `apps/client: gleam test` (PASS)

### Gate Status

Gate: PASS → docs/qa/gates/2.6-metricas-v1-event-log-mi-panel-admin-overview.yml

### Recommended Status

✓ Ready for Done
