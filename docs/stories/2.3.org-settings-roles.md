# Story 2.3: Org Settings (roles admin/member + guardrail last admin)

## Status: Ready

## Story
**As an** org admin,
**I want** to manage organization-level roles (admin/member) in a dedicated Org Settings panel,
**so that** I can delegate admin responsibilities and keep governance safe.

## Acceptance Criteria
1. **Org settings UI**: Admin UI includes an Org Settings panel for org admins.
2. **List org users for settings**: Org Settings loads a list of org users including `{ id, email, org_role, created_at }`.
   - The list may reuse `GET /api/v1/org/users` (already defined) as the data source.
3. **Update org role endpoint**: `PATCH /api/v1/org/users/:user_id` exists to update a user’s org role.
   - Auth: org admin only.
   - CSRF: required.
   - Body: `{ org_role }` where `org_role` is `admin|member`.
   - Response: `200` `{ data: { user } }`.
4. **Guardrail: cannot remove last org admin**: Attempting to demote the last remaining org admin (including yourself) is rejected.
   - `409` error code `CONFLICT_LAST_ORG_ADMIN`.
5. **UI handles guardrail**: UI uses an explicit “Save” action (no auto-save). If the last-admin guardrail triggers, UI shows a clear inline error and the screen remains usable (no crash).
6. **Authorization respected (negative)**: Non-org-admin users cannot access Org Settings UI, and any direct API attempt returns `403 FORBIDDEN`.

## Tasks / Subtasks
- [ ] Add/extend API contract for org role management (AC: 3, 4, 6)
  - [ ] Document `PATCH /api/v1/org/users/:user_id` for org role updates in `docs/architecture/api-contract.md` (AC: 3)
  - [ ] Document guardrail behavior + suggested error code in API contract (AC: 4)
- [ ] Implement `PATCH /api/v1/org/users/:user_id` (AC: 3, 4, 6)
  - [ ] Enforce org-admin authz and CSRF (AC: 3, 6)
  - [ ] Validate `org_role` values (422 `VALIDATION_ERROR`) (AC: 3)
  - [ ] Enforce “cannot demote last org admin” (AC: 4)
- [ ] Implement Org Settings UI (AC: 1, 2, 5, 6)
  - [ ] Add a new Admin section entry (left-nav) visible only to org admins (AC: 1, 6)
  - [ ] Render users table with role selector + save action (AC: 2)
  - [ ] Handle `401 AUTH_REQUIRED` by redirecting to login; handle `403 FORBIDDEN` by showing “Not permitted” (AC: 6)
  - [ ] Handle `409 CONFLICT_LAST_ORG_ADMIN` with inline message and no state corruption (AC: 5)
- [ ] Add tests (AC: 3, 4, 6)
  - [ ] Server: non-org-admin rejected (`FORBIDDEN`) (AC: 6)
  - [ ] Server: last admin demotion rejected (AC: 4)
  - [ ] Client: role gating hides Org Settings for non-org-admin (AC: 6)

## Dev Notes
### Source of truth
- Roles + authorization expectations: `docs/architecture/api-contract.md` (see “Roles” and “Authorization Matrix (MVP)”).
- Org-level model constraints: `docs/brief.md` (see “Scope Organizacional (MVP)”).

### Suggested endpoints (new/extended)
- Reuse: `GET /api/v1/org/users` (already exists; includes `org_role`) [Source: `docs/architecture/api-contract.md` “Organization → Users (directory)”].
- New: `PATCH /api/v1/org/users/:user_id` (org admin only; CSRF required).

## Testing
- Server: `make test`
- Client: `apps/client: gleam test`

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-14 | 1.0 | Initial draft | po |
| 2026-01-14 | 1.1 | Ready for dev (DoR passed; save action; last-admin guardrail clarified) | po |

## Dev Agent Record

## QA Results
