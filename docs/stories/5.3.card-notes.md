# Story 5.3: Notas en Cards (Fichas)

## Status

Approved

## Story

**As a** miembro del equipo,
**I want** poder a帽adir notas a una card (ficha),
**so that** puedo documentar decisiones, contexto y actualizaciones a nivel de feature/epic.

## Problem Statement

Las tareas tienen notas, pero las cards (fichas) no. Esto obliga a:
- Crear tareas "dummy" solo para documentar decisiones de la card
- Usar la descripci贸n de la card como log de cambios (antipatr贸n)
- Perder contexto cuando un agente AI necesita entender el "por qu茅" de una card

### Caso de uso: Agente AI

Un agente AI que trabaja en tareas de una card necesita:
1. Entender el contexto general (descripcion de card)
2. Ver decisiones tomadas (notas de card)
3. Ver progreso de tareas individuales (notas de tareas)

Sin notas en cards, el contexto se pierde.

---

## Acceptance Criteria

### Funcionales

1. **AC1**: La vista detalle de una card tiene secci贸n "Notas" (se accede desde Kanban/listado de Cards; Pool no aplica)
2. **AC2**: Un miembro puede a帽adir una nota con texto libre
3. **AC3**: Las notas muestran: autor, fecha, contenido
4. **AC4**: Las notas se ordenan cronol贸gicamente (m谩s reciente al final)
5. **AC5**: Un PM puede eliminar cualquier nota de sus cards
6. **AC6**: Un miembro solo puede eliminar sus propias notas

### API

7. **AC7**: `GET /api/v1/cards/:id/notes` - Lista notas de una card
8. **AC8**: `POST /api/v1/cards/:id/notes` - Crea nota (body: `{ content: string }`)
9. **AC9**: `DELETE /api/v1/cards/:id/notes/:note_id` - Elimina nota

### Modelo de Datos

10. **AC10**: Tabla `card_notes` con: `id, card_id, user_id, content, created_at`
11. **AC11**: Foreign key a `cards.id` con ON DELETE CASCADE

### i18n

12. **AC12**: Labels en ES/EN:
    - "Notas" / "Notes"
    - "A帽adir nota" / "Add note"
    - "Escribe una nota..." / "Write a note..."

---

## UX Design

### Wireframe: Secci贸n Notas en Card Detail

```
+-------------------------------------------------------+
| CARD: Architecture Refactor                           |
| Estado: En curso | Progreso: 3/7 tareas               |
+-------------------------------------------------------+
| Descripci贸n:                                          |
| Reestructurar la arquitectura del cliente para...     |
+-------------------------------------------------------+
| NOTAS (2)                                             |
+-------------------------------------------------------+
| Alice Chen - hace 3 dias                              |
| Decidimos usar patron MVC en lugar de MVVM porque...  |
|                                                       |
| Bob Agent - hace 1 dia                                |
| Completada la migracion del modulo auth. PR #42       |
| incluye tests para los casos edge.                    |
+-------------------------------------------------------+
| [Escribe una nota...]                   [A帽adir nota]  |
+-------------------------------------------------------+
```

### Interacci贸n

- Textarea expandible para escribir nota
- Bot贸n "A帽adir nota" o Ctrl+Enter para enviar
- La nota aparece inmediatamente al final
- Icono de eliminar visible siempre para quien tiene permiso (PM/Manager o autor)
- **Acceso**: Card Detail se abre desde Kanban/listado de Cards (Pool no aplica)

### Mockup: Borrar nota (sin hover)

```
- T煤 路 hace 2 horas                             []
  Revis茅 el scope con PM...

- Alice Chen 路 hace 3 d铆as
  Decidimos usar patr贸n MVC...

- Alice Chen 路 hace 3 d铆as                      []
  Decidimos usar patr贸n MVC...
```

---

## Technical Notes

### Backend

**Nuevo m贸dulo:** `http/card_notes.gleam` (sim茅trico a `task_notes.gleam`)

**Nuevas rutas en router:**
```gleam
["api", "v1", "cards", card_id, "notes"] ->
  Some(card_notes.handle_card_notes(req, auth_ctx, card_id))
["api", "v1", "cards", card_id, "notes", note_id] ->
  Some(card_notes.handle_card_note(req, auth_ctx, card_id, note_id))
```

**SQL:**
```sql
CREATE TABLE card_notes (
  id SERIAL PRIMARY KEY,
  card_id INTEGER NOT NULL REFERENCES cards(id) ON DELETE CASCADE,
  user_id INTEGER NOT NULL REFERENCES users(id),
  content TEXT NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_card_notes_card_id ON card_notes(card_id);
```

### Frontend

**Archivos a modificar:**
- `features/fichas/card_detail.gleam` - A帽adir secci贸n notas
- `api/cards.gleam` - A帽adir `get_card_notes`, `create_card_note`, `delete_card_note`
- `client_state.gleam` - Estado para notas de card

### Reuse / DRY (alineado a 5.4)

- Crear componentes UI reutilizables: `ui/notes_list` y `ui/notes_composer` (puros, sin efectos).
- Mantener handlers separados: `http/card_notes.gleam` y `http/task_notes.gleam`.
- Reusar helpers de permisos/author desde auth existente.

### TDD (Red/Green/Refactor)

- Red: tests para listar/crear/eliminar nota y permisos antes de implementar.
- Green: implementar endpoints y UI m铆nima hasta pasar tests.
- Refactor: extraer componentes comunes (notes_list/notes_composer) solo si hay duplicaci贸n real.

### Checklist TDD

Backend
- [ ] GET notes retorna lista ordenada con `author`, `created_at`, `content`.
- [ ] POST crea nota y retorna payload esperado.
- [ ] DELETE solo autor o PM/Manager.
- [ ] Errores 403/404/422 segun caso.

Frontend
- [ ] Render de lista con autor/fecha/contenido.
- [ ] Composer envia con boton y Ctrl+Enter.
- [ ] Icono delete visible solo con permiso.

---

## Out of Scope

- Editar notas existentes (solo crear y eliminar)
- Menciones (@usuario) en notas
- Markdown en notas (texto plano por ahora)
- Adjuntar archivos a notas

---

## Dependencias

- Story 3.1 (Fichas v1) - Completada

---

## Risk Assessment

- **Primary Risk:** Complejidad a帽adida a card detail que ya es denso
- **Mitigation:** Secci贸n colapsable, empieza cerrada si hay pocas notas
- **Secondary Risk:** Notas spam sin moderacion
- **Mitigation:** PM puede eliminar cualquier nota
