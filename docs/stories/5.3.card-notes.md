# Story 5.3: Notas en Cards (Fichas)

## Status

Draft

## Story

**As a** miembro del equipo,
**I want** poder añadir notas a una card (ficha),
**so that** puedo documentar decisiones, contexto y actualizaciones a nivel de feature/epic.

## Problem Statement

Las tareas tienen notas, pero las cards (fichas) no. Esto obliga a:
- Crear tareas "dummy" solo para documentar decisiones de la card
- Usar la descripcion de la card como log de cambios (antipatron)
- Perder contexto cuando un agente AI necesita entender el "por que" de una card

### Caso de uso: Agente AI

Un agente AI que trabaja en tareas de una card necesita:
1. Entender el contexto general (descripcion de card)
2. Ver decisiones tomadas (notas de card)
3. Ver progreso de tareas individuales (notas de tareas)

Sin notas en cards, el contexto se pierde.

---

## Acceptance Criteria

### Funcionales

1. **AC1**: La vista detalle de una card tiene seccion "Notas"
2. **AC2**: Un miembro puede añadir una nota con texto libre
3. **AC3**: Las notas muestran: autor, fecha, contenido
4. **AC4**: Las notas se ordenan cronologicamente (mas reciente al final)
5. **AC5**: Un PM puede eliminar cualquier nota de sus cards
6. **AC6**: Un miembro solo puede eliminar sus propias notas

### API

7. **AC7**: `GET /api/v1/cards/:id/notes` - Lista notas de una card
8. **AC8**: `POST /api/v1/cards/:id/notes` - Crea nota (body: `{ content: string }`)
9. **AC9**: `DELETE /api/v1/cards/:id/notes/:note_id` - Elimina nota

### Modelo de Datos

10. **AC10**: Tabla `card_notes` con: `id, card_id, user_id, content, created_at`
11. **AC11**: Foreign key a `cards.id` con ON DELETE CASCADE

### i18n

12. **AC12**: Labels en ES/EN:
    - "Notas" / "Notes"
    - "Añadir nota" / "Add note"
    - "Escribe una nota..." / "Write a note..."

---

## UX Design

### Wireframe: Seccion Notas en Card Detail

```
+-------------------------------------------------------+
| CARD: Architecture Refactor                           |
| Estado: En curso | Progreso: 3/7 tareas               |
+-------------------------------------------------------+
| Descripcion:                                          |
| Reestructurar la arquitectura del cliente para...     |
+-------------------------------------------------------+
| NOTAS (2)                                             |
+-------------------------------------------------------+
| Alice Chen - hace 3 dias                              |
| Decidimos usar patron MVC en lugar de MVVM porque...  |
|                                                       |
| Bob Agent - hace 1 dia                                |
| Completada la migracion del modulo auth. PR #42       |
| incluye tests para los casos edge.                    |
+-------------------------------------------------------+
| [Escribe una nota...]                          [Add]  |
+-------------------------------------------------------+
```

### Interaccion

- Textarea expandible para escribir nota
- Boton "Add" o Enter+Ctrl para enviar
- Nota aparece inmediatamente al final
- Hover en nota propia muestra icono de eliminar

---

## Technical Notes

### Backend

**Nuevo modulo:** `http/card_notes.gleam` (simetrico a `task_notes.gleam`)

**Nuevas rutas en router:**
```gleam
["api", "v1", "cards", card_id, "notes"] ->
  Some(card_notes.handle_card_notes(req, auth_ctx, card_id))
["api", "v1", "cards", card_id, "notes", note_id] ->
  Some(card_notes.handle_card_note(req, auth_ctx, card_id, note_id))
```

**SQL:**
```sql
CREATE TABLE card_notes (
  id SERIAL PRIMARY KEY,
  card_id INTEGER NOT NULL REFERENCES cards(id) ON DELETE CASCADE,
  user_id INTEGER NOT NULL REFERENCES users(id),
  content TEXT NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_card_notes_card_id ON card_notes(card_id);
```

### Frontend

**Archivos a modificar:**
- `features/fichas/card_detail.gleam` - Añadir seccion notas
- `api/cards.gleam` - Añadir `get_card_notes`, `create_card_note`, `delete_card_note`
- `client_state.gleam` - Estado para notas de card

---

## Out of Scope

- Editar notas existentes (solo crear y eliminar)
- Menciones (@usuario) en notas
- Markdown en notas (texto plano por ahora)
- Adjuntar archivos a notas

---

## Dependencias

- Story 3.1 (Fichas v1) - Completada

---

## Risk Assessment

- **Primary Risk:** Complejidad añadida a card detail que ya es denso
- **Mitigation:** Seccion colapsable, empieza cerrada si hay pocas notas
- **Secondary Risk:** Notas spam sin moderacion
- **Mitigation:** PM puede eliminar cualquier nota

