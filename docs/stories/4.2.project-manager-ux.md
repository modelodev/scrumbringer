# Story 4.2: Project Manager UX

## Status

Ready

## Story

**As an** Org Admin,
**I want** to change the role of project members between "manager" and "member" via the UI,
**so that** I can delegate project management responsibilities without removing and re-adding users.

## Prerequisites

- **Story 4.1** (Permissions Refactor) must be completed first
- Roles are already `'manager'` | `'member'` in database
- Authorization logic already restricts manager assignment to Org Admin only

> **Note:** Story 4.1 deferred AC9/AC10 (ProjectRole ADT). This story includes Task 0 to implement it.

> **Note:** This story follows the same **"Clean Break" migration philosophy** as Story 4.1:
> - No backward compatibility with old API or data structures
> - No legacy aliases or deprecated endpoints
> - Old code (functions, files) is DELETED, not renamed

## Acceptance Criteria

1. **AC1**: Org Admin can change a member's role from "member" to "manager" via the Members table
2. **AC2**: Org Admin can change a manager's role from "manager" to "member" (if not last manager)
3. **AC3**: System prevents demoting the last project manager (422 error with clear message)
4. **AC4**: Role change is reflected immediately in the UI without page refresh
5. **AC5**: Project Manager does NOT see the option to change roles (view only)
6. **AC6**: API endpoint `PATCH /projects/:id/members/:user_id` accepts `{ "role": "manager" | "member" }`
7. **AC7**: API returns 404 if user is not a member of the project
8. **AC8**: API returns 403 if caller is not Org Admin
9. **AC9**: Role change is idempotent (setting same role returns success)

---

## API Specification

### PATCH /projects/:id/members/:user_id

**Authorization:** Org Admin only

**Request Body:**
```json
{
  "role": "manager" | "member"
}
```

**Response 200 (Success):**
```json
{
  "user_id": 123,
  "email": "user@example.com",
  "role": "manager",
  "previous_role": "member"
}
```

**Response 404 (User not member of project):**
```json
{
  "error": "not_found",
  "message": "User is not a member of this project"
}
```

**Response 422 (Last manager protection):**
```json
{
  "error": "last_manager",
  "message": "Cannot demote the last project manager"
}
```

**Response 403 (Not authorized):**
```json
{
  "error": "forbidden",
  "message": "Only organization admins can change member roles"
}
```

**Response 400 (Invalid role):**
```json
{
  "error": "invalid_role",
  "message": "Role must be 'manager' or 'member'"
}
```

---

## Tasks / Subtasks

- [ ] **Task 0: Shared - Create ProjectRole ADT** (deferred from 4.1 AC9/AC10)
  - [ ] Create `shared/src/shared/domain/project_role.gleam`
  - [ ] Define `pub type ProjectRole { Manager, Member }`
  - [ ] Add `to_string(role) -> String` function
  - [ ] Add `parse(s: String) -> Result(ProjectRole, Nil)` function
  - [ ] Add `to_json(role) -> json.Json` function
  - [ ] Update `shared/src/shared/domain/project.gleam`: change `ProjectMember.role` from `String` to `ProjectRole`
  - [ ] Update server decoders/encoders to use `ProjectRole`
  - [ ] Update client decoders/encoders to use `ProjectRole`
  - [ ] Verify both apps compile: `gleam build` in client and server

- [ ] **Task 1: Server - Add role change endpoint** (AC: 1, 2, 3, 6, 7, 8, 9)
  - [ ] Create SQL `project_members_update_role.sql` with last-manager protection (see Dev Notes)
  - [ ] Run `gleam run -m squirrel` to generate Gleam bindings
  - [ ] Add `update_member_role()` function to `projects_db.gleam`
  - [ ] Add `PATCH` handler in `projects.gleam` for `/projects/:id/members/:user_id`
  - [ ] Implement authorization check: return 403 if not Org Admin
  - [ ] Implement 404 response if user not member of project
  - [ ] Implement 422 response if demoting last manager
  - [ ] Implement 400 response if invalid role value
  - [ ] Ensure idempotent behavior (same role = success)

- [ ] **Task 2: Client - Add role change UI** (AC: 1, 2, 4, 5)
  - [ ] Add `MemberRoleChangeClicked(user_id, ProjectRole)` message
  - [ ] Add `MemberRoleChanged` result message
  - [ ] Update `view_members_table` to show role dropdown for Org Admin only
  - [ ] Project Manager sees role as text (no dropdown)
  - [ ] Add API call for PATCH request
  - [ ] Update members list on successful role change

- [ ] **Task 3: Client - Error handling** (AC: 3)
  - [ ] Add i18n text for "Cannot demote last manager" error
  - [ ] Display error toast/message when role change fails

- [ ] **Task 4: Testing** (AC: 1-9)
  - [ ] Server: `org_admin_can_change_member_to_manager_test()` (AC1)
  - [ ] Server: `org_admin_can_change_manager_to_member_test()` (AC2)
  - [ ] Server: `cannot_demote_last_project_manager_test()` (AC3)
  - [ ] Server: `project_manager_cannot_change_roles_test()` (AC8)
  - [ ] Server: `change_role_user_not_member_returns_404_test()` (AC7)
  - [ ] Server: `change_role_idempotent_test()` (AC9)
  - [ ] Server: `change_role_invalid_value_returns_400_test()`

## Dev Notes

### Post-4.1 State (Actual)

After Story 4.1, the following exists:

**Database:**
- `project_members.role` with constraint `CHECK (role IN ('manager', 'member'))`
- `project_members_is_manager.sql` - checks if user is manager

**Server:**
- `projects_db.is_project_manager()` function
- `require_project_manager()` helper
- Authorization: only Org Admin can assign 'manager' role

**Shared:**
- ⚠️ `ProjectRole` ADT was **NOT implemented** in 4.1 (deferred AC9/AC10)
- `ProjectMember.role` is currently `String`
- Task 0 of this story will implement the ADT

**Client:**
- `permissions.gleam` uses `is_project_manager()` with string matching
- i18n has "Manager" / "Member" labels

### SQL Pattern for Last-Manager Protection

The query must handle these cases:
1. **Promotion** (member → manager): Always allowed
2. **Demotion** (manager → member): Only if more than 1 manager exists
3. **Idempotent** (same role): Return success without change
4. **User not found**: Return empty result (handler returns 404)

```sql
-- project_members_update_role.sql
-- Parameters: $1 = project_id, $2 = user_id, $3 = new_role

WITH current_state AS (
  SELECT
    pm.role as current_role,
    u.email,
    (SELECT COUNT(*) FROM project_members WHERE project_id = $1 AND role = 'manager') as manager_count
  FROM project_members pm
  JOIN users u ON u.id = pm.user_id
  WHERE pm.project_id = $1 AND pm.user_id = $2
),
validation AS (
  SELECT
    current_role,
    email,
    manager_count,
    CASE
      -- Promotion: always allowed
      WHEN current_role = 'member' AND $3 = 'manager' THEN 'allowed'
      -- Demotion with multiple managers: allowed
      WHEN current_role = 'manager' AND $3 = 'member' AND manager_count > 1 THEN 'allowed'
      -- Demotion with single manager: blocked
      WHEN current_role = 'manager' AND $3 = 'member' AND manager_count = 1 THEN 'last_manager'
      -- No change (idempotent): allowed
      WHEN current_role = $3 THEN 'no_change'
      -- Fallback
      ELSE 'allowed'
    END as status
  FROM current_state
)
UPDATE project_members pm
SET role = $3
FROM validation v
WHERE pm.project_id = $1
  AND pm.user_id = $2
  AND v.status IN ('allowed', 'no_change')
RETURNING
  pm.user_id,
  v.email,
  pm.role as role,
  v.current_role as previous_role,
  v.status;
```

**Handler Logic:**
- Empty result → 404 (user not member)
- `status = 'last_manager'` → 422 with error message
- `status = 'allowed'` or `'no_change'` → 200 with updated member

**Alternative (Two-Query Approach):**

If the single-query approach is too complex, split into:
1. `SELECT` to check current state and validate
2. `UPDATE` only if validation passes

```gleam
pub fn update_member_role(db, project_id, user_id, new_role) {
  // 1. Check current state
  use current <- result.try(get_member_with_manager_count(db, project_id, user_id))

  case current {
    Error(Nil) -> Error(NotFound)
    Ok(member) -> {
      // 2. Validate
      case member.role, new_role, member.manager_count {
        // Demotion of last manager
        "manager", "member", 1 -> Error(LastManager)
        // All other cases: proceed
        _, _, _ -> do_update_role(db, project_id, user_id, new_role)
      }
    }
  }
}
```

### Key Files to Modify

**Shared (Task 0):**
- `shared/src/shared/domain/project_role.gleam` (new)
- `shared/src/shared/domain/project.gleam` (update ProjectMember.role type)

**Server:**
- `apps/server/src/scrumbringer_server/sql/project_members_update_role.sql` (new)
- `apps/server/src/scrumbringer_server/services/projects_db.gleam`
- `apps/server/src/scrumbringer_server/http/projects.gleam`
- Server decoders for `ProjectMember` (update for ProjectRole ADT)

**Client:**
- `apps/client/src/scrumbringer_client/features/admin/model.gleam`
- `apps/client/src/scrumbringer_client/features/admin/update.gleam`
- `apps/client/src/scrumbringer_client/features/admin/view.gleam`
- `apps/client/src/scrumbringer_client/features/admin/workflows.gleam`
- `apps/client/src/scrumbringer_client/i18n/*.gleam`
- Client decoders for `ProjectMember` (update for ProjectRole ADT)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-21 | 1.4 | Added Task 0 for ProjectRole ADT (deferred from 4.1), updated prerequisites and dev notes | Sarah (PO) |
| 2026-01-21 | 1.3 | Added "Clean Break" philosophy reference in Prerequisites | Winston (Architect) |
| 2026-01-21 | 1.2 | Added API Specification, AC7-9, improved SQL pattern, expanded tests | Winston (Architect) |
| 2025-01-21 | 1.1 | Updated for post-4.1 terminology (manager/member) | Sarah (PO) |
| 2025-01-21 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

## QA Results
_To be filled by QA agent_
