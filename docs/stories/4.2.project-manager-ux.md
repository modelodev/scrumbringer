# Story 4.2: Project Manager UX

## Status

Draft

## Story

**As an** Org Admin,
**I want** to change the role of project members between "manager" and "member" via the UI,
**so that** I can delegate project management responsibilities without removing and re-adding users.

## Prerequisites

- **Story 4.1** (Permissions Refactor) must be completed first
- Roles are already `'manager'` | `'member'` in database
- `ProjectRole` ADT exists in shared domain
- Authorization logic already restricts manager assignment to Org Admin only

## Acceptance Criteria

1. **AC1**: Org Admin can change a member's role from "member" to "manager" via the Members table
2. **AC2**: Org Admin can change a manager's role from "manager" to "member" (if not last manager)
3. **AC3**: System prevents demoting the last project manager (422 error with clear message)
4. **AC4**: Role change is reflected immediately in the UI without page refresh
5. **AC5**: Project Manager does NOT see the option to change roles (view only)
6. **AC6**: API endpoint `PATCH /projects/:id/members/:user_id` accepts `{ "role": "manager" | "member" }`

## Tasks / Subtasks

- [ ] **Task 1: Server - Add role change endpoint** (AC: 1, 2, 3, 6)
  - [ ] Create SQL `project_members_update_role.sql` with last-manager protection
  - [ ] Run `gleam run -m squirrel` to generate Gleam bindings
  - [ ] Add `update_member_role()` function to `projects_db.gleam`
  - [ ] Add `PATCH` handler in `projects.gleam` for `/projects/:id/members/:user_id`
  - [ ] Verify only Org Admin can call this endpoint (Project Manager cannot)
  - [ ] Write HTTP tests

- [ ] **Task 2: Client - Add role change UI** (AC: 1, 2, 4, 5)
  - [ ] Add `MemberRoleChangeClicked(user_id, ProjectRole)` message
  - [ ] Add `MemberRoleChanged` result message
  - [ ] Update `view_members_table` to show role dropdown for Org Admin only
  - [ ] Project Manager sees role as text (no dropdown)
  - [ ] Add API call for PATCH request
  - [ ] Update members list on successful role change

- [ ] **Task 3: Client - Error handling** (AC: 3)
  - [ ] Add i18n text for "Cannot demote last manager" error
  - [ ] Display error toast/message when role change fails

- [ ] **Task 4: Testing**
  - [ ] Server: `org_admin_can_change_member_to_manager_test()`
  - [ ] Server: `org_admin_can_change_manager_to_member_test()`
  - [ ] Server: `cannot_demote_last_project_manager_test()`
  - [ ] Server: `project_manager_cannot_change_roles_test()`

## Dev Notes

### Post-4.1 State (Assumed)

After Story 4.1, the following already exists:

**Database:**
- `project_members.role` with constraint `CHECK (role IN ('manager', 'member'))`
- `project_members_is_manager.sql` - checks if user is manager

**Server:**
- `projects_db.is_project_manager()` function
- `require_project_manager()` helper
- Authorization: only Org Admin can assign 'manager' role

**Shared:**
- `ProjectRole { Manager, Member }` ADT
- `ProjectMember` uses `ProjectRole` type

**Client:**
- `permissions.gleam` uses `is_project_manager()`
- i18n has "Manager" / "Member" labels

### SQL Pattern for Last-Manager Protection

```sql
WITH manager_count AS (
  SELECT COUNT(*) as cnt
  FROM project_members
  WHERE project_id = $1 AND role = 'manager'
),
target AS (
  SELECT role FROM project_members
  WHERE project_id = $1 AND user_id = $2
)
UPDATE project_members
SET role = $3
WHERE project_id = $1 AND user_id = $2
  AND NOT (
    (SELECT role FROM target) = 'manager'
    AND $3 = 'member'
    AND (SELECT cnt FROM manager_count) = 1
  )
RETURNING user_id, role,
  (SELECT cnt FROM manager_count) as manager_count,
  CASE WHEN (SELECT role FROM target) = 'manager'
       AND $3 = 'member'
       AND (SELECT cnt FROM manager_count) = 1
  THEN false ELSE true END as updated;
```

### Key Files to Modify

**Server:**
- `apps/server/src/scrumbringer_server/sql/project_members_update_role.sql` (new)
- `apps/server/src/scrumbringer_server/services/projects_db.gleam`
- `apps/server/src/scrumbringer_server/http/projects.gleam`

**Client:**
- `apps/client/src/scrumbringer_client/features/admin/model.gleam`
- `apps/client/src/scrumbringer_client/features/admin/update.gleam`
- `apps/client/src/scrumbringer_client/features/admin/view.gleam`
- `apps/client/src/scrumbringer_client/features/admin/workflows.gleam`
- `apps/client/src/scrumbringer_client/i18n/*.gleam`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-21 | 1.1 | Updated for post-4.1 terminology (manager/member) | Sarah (PO) |
| 2025-01-21 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

## QA Results
_To be filled by QA agent_
