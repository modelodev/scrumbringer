# Story 1.9: Org User Directory (Search by Email)

## Status
Ready for Done

## Story
**As a** project admin,
**I want** to search and list users in the organization,
**so that** I can add them to projects without needing internal IDs or database access.

## Acceptance Criteria
1. **Endpoint exists**: `GET /api/v1/org/users` exists.
2. **Authorization**: `GET /api/v1/org/users` is allowed for org admins and project admins; non-authorized users are rejected with `403 FORBIDDEN`.
3. **Org scoping**: The endpoint returns only users in the caller’s organization.
4. **Sorting**: Results are sorted by `email ASC`.
5. **Search**: Optional query `q` filters by email only.
6. **Response shape**: Response is `200` `{ data: { users: User[] } }` and each user includes at least `{ id, email, org_role, created_at }`.
7. **UI-friendly empty states**: If `q` yields no matches, return `200` with an empty `users: []` list (not `404`).
8. **UI-friendly “list all”**: If `q` is omitted or empty, return the full org user list (MVP has no pagination).

## Tasks / Subtasks
- [x] Add endpoint contract + authz rules to API layer (AC: 1, 2)
- [x] Implement org scoping and sorting/search (AC: 3, 4, 5, 8)
- [x] Add tests:
  - [x] org scoping (cannot see users from other org) (AC: 3)
  - [x] authorization checks (AC: 2)
  - [x] sorting + search behavior (AC: 4, 5)
  - [x] empty results are `200` with `users: []` (AC: 7)
  - [x] missing/empty `q` returns full list (AC: 8)

## Dev Notes
### Source of truth
- API contract: `docs/architecture/api-contract.md` (Organization → Users, Authorization Matrix).

### Why this is needed for usability
- Membership endpoints use `user_id`; without a directory/search, admins cannot reliably discover `user_id` to add members.

### UI integration notes (no standalone UI in this story)
- This endpoint is consumed by the Admin UI in `docs/stories/1.7.admin-ui-management.md` (Members → Add member flow).
- UI expectations:
  - Debounced email search using `q`.
  - Renderable fields: `email`, `org_role`, `created_at`.
  - Support a “Copy user id” affordance (uses `id`, but avoid making `id` the primary visual identifier).
- Errors for UI:
  - `401 AUTH_REQUIRED`: UI should redirect to login.
  - `403 FORBIDDEN`: UI should show “Not permitted” and hide the search UI.

### Testing
- Use `gleeunit`.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-12 | 1.0 | Initial draft | architect |
| 2026-01-12 | 1.1 | Approved for implementation (unblocks onboarding and membership management UX) | architect |
| 2026-01-13 | 1.2 | UX pass: clarified UI consumption requirements and empty-state behaviors | ux-expert |
| 2026-01-13 | 1.3 | Implemented org user directory endpoint + tests | dev |

## Dev Agent Record

### Agent Model Used
- GPT-5.2 (Codex CLI)

### Debug Log References
- `make squirrel` (regenerated `apps/server/src/scrumbringer_server/sql.gleam`; generated 33 queries)
- `make test` (apps/server: 39 passed; packages/domain: no tests; packages/birl: no tests)

### Completion Notes List
- Added `GET /api/v1/org/users` with org scoping, `email ASC` sorting, and optional `q` filter.
- Enforced authorization: org admins and project admins allowed; others receive `403 FORBIDDEN`.
- Added gleeunit tests for authorization, org scoping, sorting/search, and UI-friendly empty/list-all behavior.

### File List
- `apps/server/src/scrumbringer_server.gleam` (modified)
- `apps/server/src/scrumbringer_server/http/org_users.gleam` (new)
- `apps/server/src/scrumbringer_server/services/org_users_db.gleam` (new)
- `apps/server/src/scrumbringer_server/services/projects_db.gleam` (modified)
- `apps/server/src/scrumbringer_server/sql.gleam` (modified; generated)
- `apps/server/src/scrumbringer_server/sql/org_users_list.sql` (new)
- `apps/server/src/scrumbringer_server/sql/project_members_is_any_admin_in_org.sql` (new)
- `apps/server/test/org_users_http_test.gleam` (new)
- `docs/stories/1.9.org-user-directory.md` (modified)

## QA Results

### Review Date: 2026-01-13

### Reviewed By: Quinn (Test Architect)

### Acceptance Criteria Verification

- AC1 (Endpoint exists): PASS — route matches `GET /api/v1/org/users` via `scrumbringer_server/http/org_users.gleam`.
- AC2 (Authorization): PASS — org admins allowed; non-admins allowed iff project admin in same org; otherwise `403 FORBIDDEN`; missing session returns `401 AUTH_REQUIRED`.
- AC3 (Org scoping): PASS — `org_users_list.sql` filters `where org_id = $1`.
- AC4 (Sorting): PASS — `order by email asc`.
- AC5 (Search): PASS — optional `q` filters email only via `email ilike ('%' || $2 || '%')`.
- AC6 (Response shape): PASS — `api.ok({ users: [...] })` produces `{ data: { users: [...] } }` and each user includes `{ id, email, org_role, created_at }`.
- AC7 (Empty state): PASS — empty match returns `200` with `users: []`.
- AC8 (List all): PASS — missing/empty `q` treated as `""` and returns full org list.

### Test Evidence

- `make test` (apps/server): 39 passed.
- Coverage highlights in `apps/server/test/org_users_http_test.gleam`:
  - authz (403 for non-admin, 200 for org admin)
  - project admin access + org scoping across orgs
  - sorting, search, empty result, and `q=` list-all behavior

### Non-Blocking Recommendations

- Add a small assertion/decoder test that each user object includes `id`, `org_role`, and `created_at` (AC6), not just email.
- Optional: add an explicit unauthenticated request test asserting `401 AUTH_REQUIRED` (aligns with Dev Notes, prevents regression).

### Gate Status

Gate: PASS → docs/qa/gates/1.9-org-user-directory-search-by-email.yml

### Recommended Status

[✓ Ready for Done] / [✗ Changes Required - See unchecked items above]
(Story owner decides final status)
