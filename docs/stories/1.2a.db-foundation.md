# Story 1.2a: DB Foundation + Auth Persistence (Postgres + dbmate + pog + squirrel)

## Status
Ready for Review

## Story
**As a** developer/operator,
**I want** the server to use PostgreSQL for persistence (with migrations and Squirrel-ready query generation),
**so that** auth/bootstrap/invites are durable, scalable, and safe to run in real deployments.

## Acceptance Criteria
1. **DB tooling present**: The repo includes:
   - `docker-compose.yml` for local PostgreSQL 16
   - `database.yml` for dbmate
   - `db/migrations/` with up/down migrations needed for auth/bootstrap.
2. **Server can connect to DB**: `apps/server` can be configured to connect to Postgres via `DATABASE_URL` (or an equivalent documented configuration). Missing critical config fails fast with a clear error.
3. **Schema supports Auth 1.1**: Migrations define the minimum schema (tables + constraints/indexes) to support the implemented auth/bootstrap behavior:
   - `organizations`, `users`, `projects`, `project_members`, `org_invites`.
4. **Auth 1.1 preserved on DB**:
   - `POST /api/v1/auth/register` (bootstrap) creates org + `Default` project + admin user + project admin membership in PostgreSQL.
   - `POST /api/v1/auth/login` authenticates against PostgreSQL stored `users.password_hash`.
   - `GET /api/v1/auth/me` returns authenticated user.
   - `POST /api/v1/auth/logout` behavior unchanged (cookies cleared; CSRF enforced).
5. **Squirrel integrated**:
   - `apps/server` includes `squirrel` as a dev dependency.
   - `apps/server` includes `pog` as a runtime dependency (required by Squirrel-generated code).
   - At least one SQL query exists under `apps/server/src/**/sql/*.sql` and the generated `sql.gleam` is committed.
6. **Tests validate the DB-backed flow**:
   - There is test coverage for the bootstrap + login flow using PostgreSQL.
   - Running tests locally with DB is documented in the story (commands and env vars).

## Tasks / Subtasks
- [x] Add local Postgres + migrations tooling (AC: 1)
  - [x] Create `docker-compose.yml` for Postgres 16 and local development DB
  - [x] Create `database.yml` for dbmate (dev/test)
  - [x] Create `db/migrations/` directory
- [x] Create schema migrations for auth/bootstrap (AC: 3)
  - [x] Add migration for `organizations`
  - [x] Add migration for `users` (email unique, org_role check)
  - [x] Add migration for `projects`
  - [x] Add migration for `project_members`
  - [x] Add migration for `org_invites` (per data model)
- [x] Wire Postgres connection into `apps/server` (AC: 2)
  - [x] Add `pog` (runtime) and `squirrel` (dev) to `apps/server/gleam.toml`
  - [x] Add DB connection/pool wiring (per `pog` docs) and make it available to HTTP handlers
  - [x] Add clear startup failure behavior when DB config is missing
- [x] Migrate auth/bootstrap implementation to use DB as source of truth (AC: 4)
  - [x] Replace in-memory `store_state` usage for org/users/projects/project_members with DB-backed operations
  - [x] Keep response envelopes, cookies, CSRF behavior per API contract
- [x] Add Squirrel “smoke” query and generate typed code (AC: 5)
  - [x] Add at least one query under `apps/server/src/**/sql/*.sql`
  - [x] Run `gleam run -m squirrel` with `DATABASE_URL` set
  - [x] Commit generated `apps/server/src/**/sql.gleam`
- [x] Add DB-backed tests (AC: 6)
  - [x] Ensure test DB can be created and migrated (dbmate) as part of local test workflow
  - [x] Add/port integration tests for bootstrap + login (minimum)

## Dev Notes
Source of truth:
- Stack + DB + migrations + Squirrel: `docs/architecture/tech-stack.md` (see “Database”, “Migrations”, “Squirrel (SQL)”).
- Project layout: `docs/architecture/source-tree.md` (see `db/migrations`, `database.yml`, `apps/server/src/**/sql`).
- API conventions (timestamps, envelopes, CSRF): `docs/architecture/api-contract.md`.
- Data model schema: `docs/architecture/data-model.md`.

Squirrel constraints (important):
- Squirrel discovers queries under `src/**/sql/*.sql` and generates `sql.gleam`.
- Squirrel must connect to PostgreSQL (uses `DATABASE_URL` or `PG*`) during generation.
- Generated code relies on `pog`.

Timestamp convention:
- API timestamps are ISO-8601 strings (UTC). Ensure DB-backed implementation preserves this output.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-12 | 1.0 | Drafted DB foundation story split from 1.2 to enable durable invites via Postgres + Squirrel | sm |
| 2026-01-12 | 1.1 | Implemented Postgres foundation + DB-backed auth/bootstrap + Squirrel generation + DB-backed tests | dev |

## Dev Agent Record

### Agent Model Used
GPT-5.2 (Codex CLI)

### Debug Log References
- Preferred local DB: `docker compose up -d db` (not runnable in this environment: Docker daemon unavailable)
- Sandbox fallback DB (local Postgres): `initdb -D .ai/pg/1.2a/data -U postgres -A trust` then `pg_ctl -D .ai/pg/1.2a/data -o "-p 5433 -k /home/yo/usr/dev/experimentos/scrumbringer/.ai/pg/1.2a/run" -l .ai/pg/1.2a/postgres.log start`
- Apply migrations (fallback): execute the `db/migrations/*` `-- migrate:up` sections via `psql` (dbmate not installed in this environment)
- Generate Squirrel code: `DATABASE_URL=postgresql://scrumbringer:scrumbringer@localhost:5433/scrumbringer_test ../../.tools/gleam-1.14.0/gleam run -m squirrel`
- Run tests: `DATABASE_URL=postgresql://scrumbringer:scrumbringer@localhost:5433/scrumbringer_test ../../.tools/gleam-1.14.0/gleam test`

### Completion Notes List
- Added DB tooling files (`docker-compose.yml`, `database.yml`) and dbmate-style migrations for `organizations`, `users`, `projects`, `project_members`, `org_invites`.
- Added `pog` runtime dependency and `squirrel` dev dependency to `apps/server/gleam.toml`.
- Wired a `pog` pool into the server app and ensured the `pgo` OTP app is started before running queries.
- Migrated auth/bootstrap endpoints to use PostgreSQL via `apps/server/src/scrumbringer_server/services/auth_db.gleam`.
- Added Squirrel “smoke” query and committed generated `apps/server/src/scrumbringer_server/sql.gleam`.
- Ported `apps/server/test/auth_http_test.gleam` to validate bootstrap + login using PostgreSQL.

### File List
- docker-compose.yml
- database.yml
- db/init/01_create_test_db.sql
- db/migrations/20260112100000_create_organizations.sql
- db/migrations/20260112100001_create_users.sql
- db/migrations/20260112100002_create_projects.sql
- db/migrations/20260112100003_create_project_members.sql
- db/migrations/20260112100004_create_org_invites.sql
- apps/server/gleam.toml
- apps/server/manifest.toml
- apps/server/src/main.gleam
- apps/server/src/scrumbringer_server.gleam
- apps/server/src/scrumbringer_server/http/auth.gleam
- apps/server/src/scrumbringer_server/services/auth_db.gleam
- apps/server/src/scrumbringer_server/services/auth_logic.gleam
- apps/server/src/scrumbringer_server/sql/ping.sql
- apps/server/src/scrumbringer_server/sql.gleam
- apps/server/test/auth_http_test.gleam

## QA Results

### Review Date: 2026-01-13

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

The implementation meets the story’s intent: DB foundation files exist, migrations cover the required tables, server startup is DB-aware, auth/bootstrap flows now use PostgreSQL, and Squirrel generation is wired in.

### Refactoring Performed

- None during QA review.

### Compliance Check

- Coding Standards: ✓ (structure aligns with planned server layout; generated `sql.gleam` committed)
- Testing Strategy: ✓ (DB-backed tests added; requires `DATABASE_URL`)
- All ACs Met: ✓

### Improvements Checklist

- [x] Verify DB-backed bootstrap creates org + Default project + admin membership.
- [x] Verify login/me/logout behaviors still pass.
- [x] Verify invite invalid/expired/used errors (via DB seed in tests).
- [ ] Add a short dev doc for DB setup + migrations + squirrel generation.
- [ ] Consider adding explicit DB health signal (separate from `GET /health`).

### Reliability Considerations

- Runtime now depends on Postgres availability. Startup retries (`wait_for_db`) help, but there’s no automatic migration step at startup; local workflow should include `dbmate up`.

### Evidence

- Tests passed with DB running:
  - `apps/server`: `DATABASE_URL=postgresql://scrumbringer:scrumbringer@localhost:5433/scrumbringer_test ../../.tools/gleam-1.14.0/gleam test`

### Gate Status

Gate: PASS → docs/qa/gates/1.2a-db-foundation-auth-persistence.yml

### Recommended Status

✓ Ready for Done
