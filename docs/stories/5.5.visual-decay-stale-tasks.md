# Story 5.5: Decay Visual para Tareas Estancadas

## Status

Done

## Story

**As a** project manager,
**I want** ver indicadores visuales cuando una tarea lleva demasiado tiempo en estado claimed sin progreso,
**so that** puedo intervenir antes de que el trabajo se estanque.

## Problem Statement

Una tarea puede ser reclamada y quedarse "olvidada":
- El miembro se distrae con otras prioridades
- Un agente AI se desconecta sin liberar
- El trabajo es mas complejo de lo esperado y nadie pide ayuda

Actualmente no hay forma visual de detectar esto sin revisar cada tarea manualmente.

### Concepto: Decay Visual

El "decay" es un indicador visual progresivo que muestra cuanto tiempo lleva una tarea sin actividad:
- **Fresca** (0-2 dias): Sin indicador
- **Tibia** (3-5 dias): Indicador amarillo sutil
- **Estancada** (6-10 dias): Indicador naranja
- **Critica** (>10 dias): Indicador rojo parpadeante

La actividad que "resetea" el decay:
- Añadir una nota
- Cambiar estado (claim, release, complete)
- Actualizar campos de la tarea

---

## Acceptance Criteria

### Funcionales - Indicador Visual

1. **AC1**: Las tareas claimed muestran indicador de decay segun dias sin actividad
2. **AC2**: El indicador es un icono/badge junto al titulo de la tarea
3. **AC3**: Umbrales configurables por proyecto (default: 2/5/10 dias)
4. **AC4**: El decay se muestra en: Pool (tareas claimed), Lista, Kanban, Sidebar

### Funcionales - Calculo

5. **AC5**: "Ultima actividad" = MAX(claimed_at, last_note_at, updated_at)
6. **AC6**: El calculo se hace en frontend basado en timestamps existentes
7. **AC7**: Tareas en estado `available` o `completed` no muestran decay

### Funcionales - Filtrado

8. **AC8**: Nuevo filtro en lista: "Mostrar solo estancadas"
9. **AC9**: El PM puede ver lista de todas las tareas estancadas del proyecto

### API

10. **AC10**: GET task incluye `last_activity_at` (timestamp calculado)
11. **AC11**: GET tasks acepta filtro `?stale=true` (>= umbral estancada)

### i18n

12. **AC12**: Tooltips en ES/EN:
    - "Sin actividad hace N dias"
    - "Tarea estancada"

---

## UX Design

### Wireframe: Indicadores de Decay

```
POOL (tareas claimed de otros)
+---------------------------------------+
| [Fix login bug]           Alice  2d   |  <- Fresca, sin indicador
| [Add dark mode]           Bob   [!]5d |  <- Tibia, icono amarillo
| [Refactor auth]           AI   [!!]8d |  <- Estancada, icono naranja
| [Update docs]             Eve [!!!]12d|  <- Critica, icono rojo
+---------------------------------------+

Leyenda de iconos:
  (nada) = fresca (0-2d)
  [!]    = tibia (3-5d) - amarillo
  [!!]   = estancada (6-10d) - naranja
  [!!!]  = critica (>10d) - rojo, pulso
```

### Wireframe: Tooltip de Decay

```
         +----------------------------------+
[!!] --> | Sin actividad hace 8 dias        |
         | Ultima nota: hace 8 dias         |
         | Reclamada por: AI Agent          |
         |                                  |
         | [Liberar tarea]                  |
         +----------------------------------+
```

### Wireframe: Vista "Tareas Estancadas"

```
+--------------------------------------------------+
| TAREAS ESTANCADAS (proyecto: Scrumbringer)       |
+--------------------------------------------------+
| Filtro: [>= Tibia v]   Ordenar: [Mas antigua v]  |
+--------------------------------------------------+
| [!!!] Update documentation     Eve      12 dias  |
|       Ultima nota: "WIP" - hace 12 dias          |
|       [Ver] [Liberar]                            |
|                                                  |
| [!!]  Refactor auth module     AI Agent  8 dias  |
|       Sin notas                                  |
|       [Ver] [Liberar]                            |
|                                                  |
| [!]   Add dark mode support    Bob       5 dias  |
|       Ultima nota: "Blocked by design" - 5 dias  |
|       [Ver] [Liberar]                            |
+--------------------------------------------------+
```

---

## Technical Notes

### Backend

**Añadir campo calculado en GET task:**
```gleam
// En task presenter
fn add_last_activity(task: Task) -> Task {
  let last_activity = max([
    task.claimed_at,
    task.updated_at,
    get_last_note_at(task.id),
  ])
  Task(..task, last_activity_at: Some(last_activity))
}
```

**Añadir filtro stale:**
```sql
-- tasks con ultima actividad > N dias
WHERE status = 'claimed'
  AND GREATEST(claimed_at, updated_at, COALESCE(last_note_at, claimed_at))
      < NOW() - INTERVAL '$1 days'
```

### Frontend

**Nuevo modulo:** `utils/decay.gleam`
```gleam
pub type DecayLevel {
  Fresh      // 0-2 dias
  Warm       // 3-5 dias
  Stale      // 6-10 dias
  Critical   // >10 dias
}

pub fn calculate_decay(last_activity: Time, now: Time) -> DecayLevel {
  let days = time.diff_days(now, last_activity)
  case days {
    d if d <= 2 -> Fresh
    d if d <= 5 -> Warm
    d if d <= 10 -> Stale
    _ -> Critical
  }
}

pub fn decay_icon(level: DecayLevel) -> Element(msg) {
  case level {
    Fresh -> element.none()
    Warm -> icon.warning_yellow()
    Stale -> icon.warning_orange()
    Critical -> icon.warning_red_pulse()
  }
}
```

**Archivos a modificar:**
- `features/pool/task_card.gleam` - Añadir icono de decay
- `features/views/grouped_list.gleam` - Añadir icono de decay
- `features/views/kanban_board.gleam` - Añadir icono de decay
- `features/my_bar/view.gleam` - Añadir icono de decay en sidebar

---

## Out of Scope

- Notificaciones automaticas al usuario con tareas estancadas
- Umbrales diferentes por tipo de tarea
- Auto-release despues de N dias (seria destructivo)

---

## Consideraciones para Agentes AI

El decay visual ayuda al PM a detectar cuando un agente AI:
1. Se desconecto sin liberar tareas
2. Esta trabajando pero no añade notas de progreso
3. Esta bloqueado pero no lo comunico

Combinado con Story 5.2 (Bulk Release), el PM puede limpiar rapidamente.

---

## Risk Assessment

- **Primary Risk:** Indicadores molestos/ruidosos
- **Mitigation:** Solo aparece despues de 3 dias, tooltips no intrusivos
- **Secondary Risk:** Falsos positivos (tarea legitima que toma tiempo)
- **Mitigation:** Añadir nota de progreso resetea el decay

## QA Results

### Review Date: 2026-02-02

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
QA review evidence is not available yet. Implementation status and test coverage need validation before a PASS gate can be issued.

### Refactoring Performed
- None.

### Compliance Check
- Coding Standards: ⚠️ Not reviewed
- Project Structure: ⚠️ Not reviewed
- Testing Strategy: ⚠️ Not reviewed
- All ACs Met: ⚠️ Not reviewed

### Improvements Checklist
- [ ] Perform QA review of decay indicator logic and UI placements.
- [ ] Add tests for decay thresholds and visibility across Pool/List/Kanban/Sidebar.
- [ ] Verify stale filter behavior and API support (AC8-AC11).

### Security Review
Not reviewed.

### Performance Considerations
Not reviewed.

### Gate Status
Gate: CONCERNS → docs/qa/gates/5.5-visual-decay-stale-tasks.yml

### Recommended Status
[✗ Changes Required - QA review pending]

### Review Date: 2026-02-02

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
Decay visuals appear only as generic age-based styling (created_at) in limited areas and do not follow the story requirements for last-activity-based indicators. Required API fields and stale filters are not present.

### Refactoring Performed
- None.

### Compliance Check
- Coding Standards: ⚠️ Not reviewed
- Project Structure: ⚠️ Not reviewed
- Testing Strategy: ✗ (no decay-specific tests found)
- All ACs Met: ✗ (AC1-AC12 not evidenced)

### Improvements Checklist
- [ ] Implement `last_activity_at` and stale filter API support (AC10-AC11).
- [ ] Add decay badge/tooltip based on last activity (AC1-AC7).
- [ ] Add stale-only filter in list and PM view (AC8-AC9).
- [ ] Add i18n tooltip strings (AC12).
- [ ] Add tests for thresholds, filters, and view visibility.

### Security Review
No security concerns identified, but functionality is missing.

### Performance Considerations
No evidence of last-activity computation or filtering to assess.

### Gate Status
Gate: FAIL → docs/qa/gates/5.5-visual-decay-stale-tasks.yml

### Recommended Status
[✗ Changes Required - Missing core functionality]

### Review Date: 2026-02-02

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
Story marked complete by owner via alternate implementation; QA gate waived.

### Refactoring Performed
- None.

### Compliance Check
- Coding Standards: ⚠️ Not reviewed
- Project Structure: ⚠️ Not reviewed
- Testing Strategy: ⚠️ Not reviewed
- All ACs Met: ⚠️ Not reviewed

### Improvements Checklist
- [x] Gate waived per owner decision.

### Security Review
Not reviewed.

### Performance Considerations
Not reviewed.

### Gate Status
Gate: WAIVED → docs/qa/gates/5.5-visual-decay-stale-tasks.yml

### Recommended Status
[✓ Ready for Done]
