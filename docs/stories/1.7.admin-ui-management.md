# Story 1.7: Admin UI (Invites, Projects, Members, Capabilities, Task Types)

## Status
Done

## Story
**As an** organization admin (and project admin),
**I want** a minimal admin UI to manage invites, projects, members, capabilities and task types,
**so that** I can onboard users and configure projects without direct database access.

## Acceptance Criteria
1. **Login-required**: Admin UI requires authentication; unauthenticated users are redirected to login.
2. **Invite creation**: Org admins can create org invites from the UI (calls `POST /api/v1/org/invites`) and see the generated `invite.code`.
3. **Project creation**: Org admins can create projects (calls `POST /api/v1/projects`).
4. **Org user directory**: Admin UI can search/list org users (calls `GET /api/v1/org/users?q=...`) to find user ids by email.
5. **Project membership management**: Project admins can list/add/remove members for a selected project (calls:
   - `GET /api/v1/projects/:project_id/members`
   - `POST /api/v1/projects/:project_id/members`
   - `DELETE /api/v1/projects/:project_id/members/:user_id`
   ).
6. **Capabilities management**: Org admins can list/create capabilities (calls `GET /api/v1/capabilities`, `POST /api/v1/capabilities`).
7. **Task types management**: Project admins can list/create task types for a selected project (calls `GET /api/v1/projects/:project_id/task-types`, `POST /api/v1/projects/:project_id/task-types`).
8. **Onboarding flow is doable**: A newly-invited user can be added to a project using this UI without needing direct DB access.
9. **Authorization respected (negative)**: UI hides/blocks actions not allowed by the user’s role (e.g., non-org-admin cannot create projects or capabilities).
10. **CSRF for mutations**: All UI-triggered mutating requests include CSRF double-submit (`sb_csrf` + `X-CSRF`).
11. **No pagination (MVP)**: Lists are rendered without pagination in MVP.
12. **Information architecture**: Admin UI has a single entry route (e.g., `/admin`) with a left-nav for: Invites, Projects, Members, Capabilities, Task Types. A top-bar project selector is shown when a project-scoped page is active.
13. **Invite code is usable**: After creating an invite, UI shows `invite.code` in a read-only field with a one-click “Copy” action and success feedback.
14. **Add member flow is self-contained**: Members page provides an “Add member” dialog that (a) searches users by email via `GET /api/v1/org/users?q=...`, (b) allows selecting a result, (c) chooses role (member/admin), and (d) submits `POST /api/v1/projects/:project_id/members`.
15. **UX states**: For each section, UI defines loading, empty, and error states; `403 FORBIDDEN` shows a clear “Not permitted” message and disables relevant controls.

## Tasks / Subtasks
- [x] Implement `/admin` routing + left-nav + section gating (AC: 1, 9, 12)
- [x] Implement project selector from `GET /api/v1/projects` (client-side state) (AC: 5, 7, 12)
- [x] Implement Invites page: create invite + copy-to-clipboard feedback (AC: 2, 10, 13)
- [x] Implement Projects page: list + create project (AC: 3, 9, 10, 11, 15)
- [x] Implement Org users page/component: email search + results table (AC: 4, 11, 15)
- [x] Implement Members page: list members + add/remove with confirmations + role select (AC: 5, 8, 9, 10, 11, 14, 15)
- [x] Implement Capabilities page: list + create capability (AC: 6, 9, 10, 11, 15)
- [x] Implement Task types page: list + create task type (AC: 7, 9, 10, 11, 15)
- [x] Add client tests (gleeunit where applicable):
  - [x] role gating logic for nav/actions (org_role + `my_role`) (AC: 9)
  - [x] request building includes CSRF on mutating calls (AC: 10)

## Dev Notes
### Source of truth
- MVP features include managing capabilities, task types, projects, and invite-based auth: `docs/brief.md` (see “MVP Scope v1.0”).
- API endpoints, auth, and authorization matrix: `docs/architecture/api-contract.md`.
- Roles:
  - Org admin: can create projects, org invites, capabilities.
  - Project admin: can manage project membership and create task types.
  [Source: `docs/architecture/api-contract.md` “Roles” and “Authorization Matrix (MVP)”].

### UI scope (MVP)
- Single admin area (route name up to implementation, e.g., `/admin`) with a simple left-nav.
- Pages:
  - **Invites** (org admin)
  - **Projects** (org admin)
  - **Members** (project admin; project-scoped)
  - **Capabilities** (org admin)
  - **Task Types** (project admin; project-scoped)
- Project selection is **client-side state** in MVP, sourced from `GET /api/v1/projects` (each project includes `my_role`).

### Layout & navigation
- **Top bar**: current section title + (when on project-scoped pages) a **Project selector** dropdown + “Logout”.
- **Left nav**: show only sections the current user can access; if a user deep-links to a blocked route, render a clear “Not permitted” state (don’t crash).

### Screen/component specs

#### Invites
- Primary action: “Create invite”.
- Dialog fields:
  - `expires_in_hours` (optional, default 168)
- On success: show `invite.code` in a read-only text field with **Copy** button + success feedback.
- Also show `expires_at` when returned.

#### Projects
- List projects (name) with the active project highlighted.
- Create project form (name required). On success: add to list and auto-select.

#### Members (project-scoped)
- If no project selected: show an empty state explaining the user must select a project.
- Members table:
  - columns: user (email if resolvable), user_id (secondary), role, created_at, actions
- Since `/projects/:project_id/members` returns `user_id` only, resolve display email by joining against `GET /api/v1/org/users` (project admins are authorized). If a user is not resolvable, show “User #{id}”.
- “Add member” dialog:
  - Email search input (calls `GET /api/v1/org/users?q=...` with debounce)
  - Results list/table (email, org_role, created_at) and select-one behavior
  - Role selector: `member` | `admin`
  - Submit calls `POST /api/v1/projects/:project_id/members`
- “Remove member” action:
  - Confirmation dialog (“Remove {email} from {project}?”)
  - Handle server constraint errors (e.g., cannot remove last admin) with inline message.

#### Capabilities
- List capabilities (name).
- Create capability form (name required). Show conflict/validation errors inline.

#### Task Types (project-scoped)
- List task types (name, icon, capability).
- Create task type form:
  - name (required)
  - icon (required; input is a heroicon name, example: `bug-ant`) [Source: `docs/architecture/data-model.md` “TaskType”]
    - Show a live preview of the icon next to the input.
    - If the icon name is unknown/unrenderable, show a clear validation error and disable submit.
  - capability (optional; dropdown from `GET /api/v1/capabilities`)

### States & feedback
- Loading: show a visible loading state while fetching each list.
- Empty states: “No projects yet”, “No members yet”, etc., with the next best action.
- Errors:
  - `401 AUTH_REQUIRED`: redirect to login.
  - `403 FORBIDDEN`: show “Not permitted” message + hide/disable controls.
  - `422 VALIDATION_ERROR` and `409 CONFLICT_*`: show server message inline; keep user input when safe.
- Mutations: disable submit buttons while in-flight; on success show a simple toast/notice.

### Security (client)
- All `POST`/`PUT`/`DELETE` requests must include CSRF double-submit:
  - Cookie `sb_csrf` and header `X-CSRF: <same value>`.
  [Source: `docs/architecture/api-contract.md` “CSRF (Double-submit)”]

### Accessibility
- Forms: every input has a visible label; errors are associated to inputs.
- Dialogs: initial focus on first field; Esc closes; focus returns to triggering button.
- Tables: column headers are semantic; action buttons have descriptive text (not icon-only).

### Testing
- Use `gleeunit` where applicable.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-12 | 1.0 | Initial draft | architect |
| 2026-01-12 | 1.1 | Added org user directory requirement to make membership management usable; aligned AC/tasks to include user search by email | architect |
| 2026-01-12 | 1.2 | Approved for implementation (usability pass: onboarding without DB access) | architect |
| 2026-01-13 | 1.3 | UX pass: clarified admin IA, component states, and testable UI behaviors | ux-expert |
| 2026-01-13 | 1.4 | Implemented admin UI in Lustre with CSRF-safe API calls and added client tests | dev |

## Dev Agent Record

### Agent Model Used
- GPT-5.2 (Codex CLI)

### Debug Log References
- `apps/client/../../.tools/gleam-1.14.0/gleam test` (apps/client: 5 passed)
- `apps/client/../../.tools/gleam-1.14.0/gleam test` (apps/client: 5 passed)

### Completion Notes List
- Confirmed Admin UI is implemented in `apps/client/src/scrumbringer_client.gleam` with sections: Invites, Projects, Members, Capabilities, Task Types, including role gating and project selector.
- Ensured all mutating requests include CSRF double-submit via `scrumbringer_client/api.gleam` (`X-CSRF` header from `sb_csrf` cookie).
- Fixed client compilation for current Gleam/Lustre versions (list.find return type, select/option/hr signatures, and DOM event decoder usage for icon preview).
- Added gleeunit tests for permissions gating and CSRF header attachment.
- Hardened mutation-side `403` UX to show consistent “Not permitted” messaging.
- Made member removal confirmation resilient when org user cache/email resolution is missing (fallback by `user_id`).

### File List
- `apps/client/gleam.toml` (new)
- `apps/client/manifest.toml` (new)
- `apps/client/src/scrumbringer_client.gleam` (modified)
- `apps/client/src/scrumbringer_client/api.gleam` (new; API client helpers)
- `apps/client/src/scrumbringer_client/fetch.ffi.mjs` (new)
- `apps/client/src/scrumbringer_client/permissions.gleam` (new)
- `apps/client/test/scrumbringer_client_test.gleam` (new)
- `apps/client/test/permissions_test.gleam` (new)
- `apps/client/test/api_csrf_test.gleam` (new)
- `docs/stories/1.7.admin-ui-management.md` (modified)

## QA Results

### Review Date: 2026-01-13

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Implementation is cohesive and matches the story’s IA/UX intent: a single admin surface with left-nav, a conditional project selector for project-scoped sections, and consistent loading/empty/error rendering for list endpoints. API calls align with the specified endpoints, and state management is clear and localized.

### Requirements Coverage (AC1–AC15)

- AC1 (auth gating): `fetch_me` bootstraps auth; `401` transitions to `Login`.
- AC2/AC13 (invite create + code/copy): invite creation + read-only code display + copy feedback implemented.
- AC3 (project create): create project + add to list + auto-select implemented.
- AC4/AC14 (org user search + add member dialog): debounce search against `GET /api/v1/org/users?q=...`, select result, role select, submit add member.
- AC5/AC8 (membership management): list/add/remove members for selected project implemented with confirmations.
- AC6 (capabilities): list + create capability implemented.
- AC7 (task types + heroicon preview validation): list + create task type with icon preview, unknown-icon validation, submit disabled until preview OK.
- AC9 (authorization respected): sections/actions are gated via `permissions.visible_sections` and `permissions.can_access_section`, with deep-link denial rendered as “Not permitted”.
- AC10 (CSRF mutations): client request builder attaches `X-CSRF` from `sb_csrf` for mutating methods.
- AC11 (no pagination): lists render directly, no pagination.
- AC12 (IA): left-nav present; project selector shown only for Members/Task Types; logout present.
- AC15 (UX states + 403): list-level 403 shows “Not permitted”; loading/empty/error states present throughout.

### Test Architecture Assessment

- CSRF attachment coverage exists at helper level (`should_attach_csrf` / `build_csrf_headers`).
- Role gating coverage exists for visible sections and project-scoped access behavior.

### Improvements Checklist

- [ ] Add `apps/client/` to git (or explicitly justify ignoring it) to preserve the implemented UI + tests.
- [ ] Normalize mutation-side `403` UX to consistently show “Not permitted” and disable relevant controls (today, most `403` handling is list-centric and mutations surface `err.message`).
- [ ] Consider making member removal confirmation resilient if org user cache is missing (fallback confirm using user_id).

### Security Review

- CSRF double-submit is implemented in the client request layer and covered by unit tests.
- No obvious client-side secret handling issues observed in reviewed files.

### Performance Considerations

- Unpaginated lists are intentional per MVP; the UI uses straightforward rendering without obvious runaway work.

### Files Modified During Review

- None (QA review only).

### Gate Status

Gate: CONCERNS → docs/qa/gates/1.7-admin-ui-management.yml

### Recommended Status

✗ Changes Required - See unchecked items above
(Story owner decides final status)

---

### Review Date: 2026-01-13 (Re-review after dev fixes)

### Reviewed By: Quinn (Test Architect)

### Findings

Re-review confirms the previously logged CONCERNS are resolved:

- `apps/client/` is now tracked in git and committed, preserving the shipped UI + tests.
- Mutation-side `403 FORBIDDEN` UX is normalized to a clear “Not permitted” message (rather than surfacing raw server messages).
- Member removal confirmation is resilient when cached user/email resolution is missing (fallback behavior).

### Evidence

- Client tests pass: `apps/client/../../.tools/gleam-1.14.0/gleam test`

### Gate Status

Gate: PASS → docs/qa/gates/1.7-admin-ui-management.yml

### Recommended Status

✓ Ready for Done
(Story owner decides final status)
