# Story 1.7: Admin UI (Invites, Projects, Members, Capabilities, Task Types)

## Status
Approved

## Story
**As an** organization admin (and project admin),
**I want** a minimal admin UI to manage invites, projects, members, capabilities and task types,
**so that** I can onboard users and configure projects without direct database access.

## Acceptance Criteria
1. **Login-required**: Admin UI requires authentication; unauthenticated users are redirected to login.
2. **Invite creation**: Org admins can create org invites from the UI (calls `POST /api/v1/org/invites`) and see the generated `invite.code`.
3. **Project creation**: Org admins can create projects (calls `POST /api/v1/projects`).
4. **Org user directory**: Admin UI can search/list org users (calls `GET /api/v1/org/users?q=...`) to find user ids by email.
5. **Project membership management**: Project admins can list/add/remove members for a selected project (calls:
   - `GET /api/v1/projects/:project_id/members`
   - `POST /api/v1/projects/:project_id/members`
   - `DELETE /api/v1/projects/:project_id/members/:user_id`
   ).
6. **Capabilities management**: Org admins can list/create capabilities (calls `GET /api/v1/capabilities`, `POST /api/v1/capabilities`).
7. **Task types management**: Project admins can list/create task types for a selected project (calls `GET /api/v1/projects/:project_id/task-types`, `POST /api/v1/projects/:project_id/task-types`).
8. **Onboarding flow is doable**: A newly-invited user can be added to a project using this UI without needing direct DB access.
9. **Authorization respected (negative)**: UI hides/blocks actions not allowed by the user’s role (e.g., non-org-admin cannot create projects or capabilities).
10. **CSRF for mutations**: All UI-triggered mutating requests include CSRF double-submit (`sb_csrf` + `X-CSRF`).
11. **No pagination (MVP)**: Lists are rendered without pagination in MVP.
12. **Information architecture**: Admin UI has a single entry route (e.g., `/admin`) with a left-nav for: Invites, Projects, Members, Capabilities, Task Types. A top-bar project selector is shown when a project-scoped page is active.
13. **Invite code is usable**: After creating an invite, UI shows `invite.code` in a read-only field with a one-click “Copy” action and success feedback.
14. **Add member flow is self-contained**: Members page provides an “Add member” dialog that (a) searches users by email via `GET /api/v1/org/users?q=...`, (b) allows selecting a result, (c) chooses role (member/admin), and (d) submits `POST /api/v1/projects/:project_id/members`.
15. **UX states**: For each section, UI defines loading, empty, and error states; `403 FORBIDDEN` shows a clear “Not permitted” message and disables relevant controls.

## Tasks / Subtasks
- [ ] Implement `/admin` routing + left-nav + section gating (AC: 1, 9, 12)
- [ ] Implement project selector from `GET /api/v1/projects` (client-side state) (AC: 5, 7, 12)
- [ ] Implement Invites page: create invite + copy-to-clipboard feedback (AC: 2, 10, 13)
- [ ] Implement Projects page: list + create project (AC: 3, 9, 10, 11, 15)
- [ ] Implement Org users page/component: email search + results table (AC: 4, 11, 15)
- [ ] Implement Members page: list members + add/remove with confirmations + role select (AC: 5, 8, 9, 10, 11, 14, 15)
- [ ] Implement Capabilities page: list + create capability (AC: 6, 9, 10, 11, 15)
- [ ] Implement Task types page: list + create task type (AC: 7, 9, 10, 11, 15)
- [ ] Add client tests (gleeunit where applicable):
  - [ ] role gating logic for nav/actions (org_role + `my_role`) (AC: 9)
  - [ ] request building includes CSRF on mutating calls (AC: 10)

## Dev Notes
### Source of truth
- MVP features include managing capabilities, task types, projects, and invite-based auth: `docs/brief.md` (see “MVP Scope v1.0”).
- API endpoints, auth, and authorization matrix: `docs/architecture/api-contract.md`.
- Roles:
  - Org admin: can create projects, org invites, capabilities.
  - Project admin: can manage project membership and create task types.
  [Source: `docs/architecture/api-contract.md` “Roles” and “Authorization Matrix (MVP)”].

### UI scope (MVP)
- Single admin area (route name up to implementation, e.g., `/admin`) with a simple left-nav.
- Pages:
  - **Invites** (org admin)
  - **Projects** (org admin)
  - **Members** (project admin; project-scoped)
  - **Capabilities** (org admin)
  - **Task Types** (project admin; project-scoped)
- Project selection is **client-side state** in MVP, sourced from `GET /api/v1/projects` (each project includes `my_role`).

### Layout & navigation
- **Top bar**: current section title + (when on project-scoped pages) a **Project selector** dropdown + “Logout”.
- **Left nav**: show only sections the current user can access; if a user deep-links to a blocked route, render a clear “Not permitted” state (don’t crash).

### Screen/component specs

#### Invites
- Primary action: “Create invite”.
- Dialog fields:
  - `expires_in_hours` (optional, default 168)
- On success: show `invite.code` in a read-only text field with **Copy** button + success feedback.
- Also show `expires_at` when returned.

#### Projects
- List projects (name) with the active project highlighted.
- Create project form (name required). On success: add to list and auto-select.

#### Members (project-scoped)
- If no project selected: show an empty state explaining the user must select a project.
- Members table:
  - columns: user (email if resolvable), user_id (secondary), role, created_at, actions
- Since `/projects/:project_id/members` returns `user_id` only, resolve display email by joining against `GET /api/v1/org/users` (project admins are authorized). If a user is not resolvable, show “User #{id}”.
- “Add member” dialog:
  - Email search input (calls `GET /api/v1/org/users?q=...` with debounce)
  - Results list/table (email, org_role, created_at) and select-one behavior
  - Role selector: `member` | `admin`
  - Submit calls `POST /api/v1/projects/:project_id/members`
- “Remove member” action:
  - Confirmation dialog (“Remove {email} from {project}?”)
  - Handle server constraint errors (e.g., cannot remove last admin) with inline message.

#### Capabilities
- List capabilities (name).
- Create capability form (name required). Show conflict/validation errors inline.

#### Task Types (project-scoped)
- List task types (name, icon, capability).
- Create task type form:
  - name (required)
  - icon (required; input is a heroicon name, example: `bug-ant`) [Source: `docs/architecture/data-model.md` “TaskType”]
    - Show a live preview of the icon next to the input.
    - If the icon name is unknown/unrenderable, show a clear validation error and disable submit.
  - capability (optional; dropdown from `GET /api/v1/capabilities`)

### States & feedback
- Loading: show a visible loading state while fetching each list.
- Empty states: “No projects yet”, “No members yet”, etc., with the next best action.
- Errors:
  - `401 AUTH_REQUIRED`: redirect to login.
  - `403 FORBIDDEN`: show “Not permitted” message + hide/disable controls.
  - `422 VALIDATION_ERROR` and `409 CONFLICT_*`: show server message inline; keep user input when safe.
- Mutations: disable submit buttons while in-flight; on success show a simple toast/notice.

### Security (client)
- All `POST`/`PUT`/`DELETE` requests must include CSRF double-submit:
  - Cookie `sb_csrf` and header `X-CSRF: <same value>`.
  [Source: `docs/architecture/api-contract.md` “CSRF (Double-submit)”]

### Accessibility
- Forms: every input has a visible label; errors are associated to inputs.
- Dialogs: initial focus on first field; Esc closes; focus returns to triggering button.
- Tables: column headers are semantic; action buttons have descriptive text (not icon-only).

### Testing
- Use `gleeunit` where applicable.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-12 | 1.0 | Initial draft | architect |
| 2026-01-12 | 1.1 | Added org user directory requirement to make membership management usable; aligned AC/tasks to include user search by email | architect |
| 2026-01-12 | 1.2 | Approved for implementation (usability pass: onboarding without DB access) | architect |
| 2026-01-13 | 1.3 | UX pass: clarified admin IA, component states, and testable UI behaviors | ux-expert |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
