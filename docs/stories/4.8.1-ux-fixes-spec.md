# Story 4.8.1 - UX Fixes Specification

**Parent Story:** 4.8 UX Refinement
**Date:** 2026-01-22
**Status:** Ready for Implementation

## Executive Summary

Playwright automation testing revealed 6 UX issues requiring fixes. This document provides detailed technical specifications for each fix.

---

## Issue 1: Color Picker Dropdown Cut-off in Card Dialog

### Problem
When opening the "+ Nueva tarjeta" dialog and clicking the color picker, the dropdown options are cut off by the modal boundary. Playwright confirmed: `element is not visible` for color picker options at index 6+.

### Root Cause
The `card-crud-dialog` component's body has `overflow: hidden` which clips the color picker dropdown that extends beyond the modal bounds.

### Technical Analysis

**Affected Files:**
- `apps/client/src/scrumbringer_client/components/card_crud_dialog.gleam` (lines 837-897)
- `apps/client/src/scrumbringer_client/styles.gleam` (dialog styles)

**Current Structure:**
```
<card-crud-dialog>
  <div class="dialog dialog-md">
    <div class="dialog-body" style="overflow: hidden">  <!-- PROBLEM -->
      <div class="color-picker">
        <div class="color-picker-trigger">...</div>
        <div class="color-picker-dropdown">  <!-- Gets clipped -->
          <div class="color-picker-option">...</div> × 24
        </div>
      </div>
    </div>
  </div>
</card-crud-dialog>
```

### Solution

**Option A (Recommended): Relocate dropdown to body with portal pattern**

1. Move dropdown rendering outside the modal using a portal approach
2. Calculate position relative to trigger element
3. Use `position: fixed` with calculated coordinates

**Option B: Change dropdown direction dynamically**

1. Detect available space below trigger
2. If insufficient, open dropdown upward (`dropdown-up` class)
3. Add CSS: `.color-picker-dropdown.dropdown-up { bottom: 100%; top: auto; }`

**Option C: Adjust overflow on dialog body**

1. Change dialog body to `overflow: visible`
2. Ensure modal mask still clips content outside modal
3. Risk: May cause unintended visual overflow elsewhere

### Implementation (Option B - Simplest)

**File: `apps/client/src/scrumbringer_client/components/card_crud_dialog.gleam`**

```gleam
// Add to view_color_picker function around line 850
fn view_color_picker(
  // ... existing params
  dropdown_up: Bool,  // NEW: calculated in view based on position
) -> Element(Msg) {
  let dropdown_class = case dropdown_up {
    True -> "color-picker-dropdown dropdown-up"
    False -> "color-picker-dropdown"
  }
  // ... rest of function using dropdown_class
}
```

**File: `apps/client/src/scrumbringer_client/styles.gleam`**

Add to color picker styles:
```css
.color-picker-dropdown.dropdown-up {
  bottom: calc(100% + 4px);
  top: auto;
  transform-origin: bottom center;
}
```

### Acceptance Criteria
- [ ] Color picker dropdown fully visible when opened in card dialog
- [ ] All 24 color options clickable
- [ ] Dropdown closes on selection
- [ ] Works on viewport heights 600px-1200px

### Test Criteria
```javascript
// Playwright test
await page.click('button:has-text("Nueva tarjeta")');
await page.waitForSelector('card-crud-dialog');
await page.click('.color-picker-trigger');
const options = await page.locator('.color-picker-option').all();
expect(options.length).toBe(24);
for (const option of options) {
  expect(await option.isVisible()).toBe(true);
}
```

---

## Issue 2: "+Nueva tarea" Button Opens Wrong Dialog

### Problem
The "+Nueva tarea" button is supposed to open the task creation dialog, but testing shows inconsistent behavior. The button handler is correct (`MemberCreateDialogOpened`) but may not be working.

### Technical Analysis

**Affected Files:**
- `apps/client/src/scrumbringer_client/client_view.gleam` (line 463)
- `apps/client/src/scrumbringer_client/features/layout/left_panel.gleam` (lines 165-176)

**Current Wiring (CORRECT):**
```gleam
// client_view.gleam:463
on_new_task: MemberCreateDialogOpened,

// left_panel.gleam:170
event.on_click(config.on_new_task),
```

### Investigation Required

The code wiring appears correct. The issue may be:
1. **Button disabled:** `attribute.disabled(config.selected_project_id == None)` - button won't fire if no project selected
2. **Test selector mismatch:** Playwright looked for `a:has-text("Nueva tarea")` but element is `button`

### Solution

1. **Verify button is enabled** when project is selected
2. **Add visual feedback** for disabled state
3. **Ensure test uses correct selector**

### Implementation

**File: `apps/client/src/scrumbringer_client/features/layout/left_panel.gleam`**

Add disabled visual state:
```gleam
// Line 165-176: Add tooltip for disabled state
button(
  [
    attribute.class("btn-action btn-action-primary"),
    attribute.attribute("data-testid", "btn-new-task"),
    attribute.disabled(config.selected_project_id == None),
    // ADD: Tooltip explaining why disabled
    case config.selected_project_id {
      None -> attribute.attribute("title", i18n.t(config.locale, i18n_text.SelectProjectFirst))
      Some(_) -> attribute.none()
    },
    event.on_click(config.on_new_task),
  ],
  // ...
)
```

### Acceptance Criteria
- [ ] Button enabled when project selected
- [ ] Button disabled with tooltip when no project
- [ ] Click opens task creation dialog
- [ ] Dialog pre-selects current project

### Test Criteria
```javascript
// Playwright test
await page.click('[data-testid="btn-new-task"]');
await page.waitForSelector('.dialog, [class*="modal"]');
const dialogTitle = await page.locator('.dialog-title, h2').first().textContent();
expect(dialogTitle).toContain('Nueva tarea');
```

---

## Issue 3: Navigation Links (Lista/Tarjetas) Don't Navigate

### Problem
Clicking "Lista" or "Tarjetas" in the sidebar doesn't change the view. URL remains the same.

### Technical Analysis

**Affected Files:**
- `apps/client/src/scrumbringer_client/client_view.gleam` (lines 466-489)
- `apps/client/src/scrumbringer_client/client_update.gleam` (handle_navigate_to)
- `apps/client/src/scrumbringer_client/features/layout/left_panel.gleam`
- `apps/client/src/scrumbringer_client/features/layout/center_panel.gleam` (lines 167-176)

**Current Navigation Wiring (CORRECT):**
```gleam
// client_view.gleam:474-481
on_navigate_list: NavigateTo(
  router.Member(
    member_section.Pool,  // Section stays Pool
    model.selected_project_id,
    opt.Some(view_mode.List),  // ViewMode changes
  ),
  Push,
),
```

**Route Handling (CORRECT):**
```gleam
// client_update.gleam - apply_route_fields
router.Member(section, project_id, view) -> {
  let new_view = opt.unwrap(view, model.view_mode)
  Model(..model, view_mode: new_view, ...)  // ViewMode IS updated
}
```

**View Rendering (CORRECT):**
```gleam
// center_panel.gleam:167-176
let content = case config.view_mode {
  Pool -> config.pool_content   // Pool canvas view
  List -> config.list_content   // List/table view
  Cards -> config.cards_content // Kanban board view
}

let testid = case config.view_mode {
  Pool -> "pool-canvas"
  List -> "grouped-list"
  Cards -> "kanban-board"
}
```

### Root Cause Analysis

**The navigation IS working correctly at the code level.** The architecture is:
1. `left_panel.gleam` emits `NavigateTo(router.Member(..., Some(view_mode.X)))`
2. `client_update.gleam` updates `model.view_mode` in `apply_route_fields`
3. `center_panel.gleam` switches rendered content based on `config.view_mode`

The Playwright test failure was likely caused by:
1. **Buttons disabled** - `attribute.disabled(config.selected_project_id == None)`
2. **Wrong test selector** - Test used `a:has-text("Lista")` but elements are `button`
3. **No project selected** - All navigation buttons disable when no project is selected

### Solution: Verify in Tests

The code is correct. The validation test needs to:
1. Ensure a project is selected BEFORE clicking navigation
2. Use correct button selectors: `button:has-text("Lista")` or `[data-testid="nav-list"]`

### No Code Changes Required

The navigation system is correctly implemented. This is a **test issue**, not a code issue.

### Acceptance Criteria
- [ ] Clicking "Pool" shows pool canvas view
- [ ] Clicking "Lista" shows list/table view
- [ ] Clicking "Tarjetas" shows kanban board view
- [ ] Active indicator shows on current view
- [ ] URL updates with view parameter

### Test Criteria
```javascript
// Playwright test - use correct selectors
await page.click('[data-testid="nav-list"]');
await page.waitForTimeout(500);
// Check URL contains view parameter
expect(page.url()).toContain('view=list');
// Check list view rendered
const table = await page.locator('table, .list-view').count();
expect(table).toBeGreaterThan(0);
```

---

## Issue 4: Inconsistent Button Styles (Nueva tarea vs Nueva tarjeta)

### Problem
The "+Nueva tarea" and "+Nueva tarjeta" buttons have different visual styles, violating design consistency.

### Technical Analysis

**Affected Files:**
- `apps/client/src/scrumbringer_client/features/layout/left_panel.gleam` (lines 165-193)
- `apps/client/src/scrumbringer_client/styles.gleam`

**Current Code:**
Both buttons use identical classes:
```gleam
// Line 167 (Nueva tarea)
attribute.class("btn-action btn-action-primary"),

// Line 182 (Nueva tarjeta)
attribute.class("btn-action btn-action-primary"),
```

### Root Cause

The classes are identical. The visual difference must come from:
1. Different computed styles due to element order/specificity
2. One button being disabled (different visual state)
3. External CSS override

### Solution

Verify both buttons render with identical styles by:
1. Ensuring neither is disabled during comparison
2. Adding explicit shared styling
3. Using same icon prefix structure

### Implementation

**File: `apps/client/src/scrumbringer_client/styles.gleam`**

Ensure `.btn-action.btn-action-primary` has explicit styles:
```css
.btn-action.btn-action-primary {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 8px 12px;
  background: var(--sb-accent);
  color: var(--sb-on-accent);
  border: none;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: background 150ms ease;
}

.btn-action.btn-action-primary:hover:not(:disabled) {
  background: var(--sb-accent-hover);
}

.btn-action.btn-action-primary:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.btn-action .btn-icon-prefix {
  font-weight: 600;
}
```

### Acceptance Criteria
- [ ] Both buttons have identical background color
- [ ] Both buttons have identical text color
- [ ] Both buttons have identical padding
- [ ] Both buttons have identical font size/weight
- [ ] Hover states match
- [ ] Disabled states match

### Test Criteria
```javascript
// Playwright style comparison
const tareaBtn = page.locator('[data-testid="btn-new-task"]');
const tarjetaBtn = page.locator('[data-testid="btn-new-card"]');

const tareaStyles = await tareaBtn.evaluate(el => ({
  bg: getComputedStyle(el).backgroundColor,
  color: getComputedStyle(el).color,
  padding: getComputedStyle(el).padding
}));

const tarjetaStyles = await tarjetaBtn.evaluate(el => ({
  bg: getComputedStyle(el).backgroundColor,
  color: getComputedStyle(el).color,
  padding: getComputedStyle(el).padding
}));

expect(tareaStyles).toEqual(tarjetaStyles);
```

---

## Issue 5: Date Format (ISO instead of YYYY-MM-DD)

### Problem
Dates in admin tables show full ISO format (`2026-01-21T08:16:58Z`) instead of simplified `YYYY-MM-DD`.

### Technical Analysis

**Affected Files:**
- `apps/client/src/scrumbringer_client/features/invites/view.gleam`
- `apps/client/src/scrumbringer_client/features/admin/view.gleam`
- Potentially other admin table views

### Solution

Create a date formatting utility and apply consistently.

### Implementation

**File: `apps/client/src/scrumbringer_client/utils/date_format.gleam`** (NEW)

```gleam
//// Date formatting utilities

/// Format ISO date string to YYYY-MM-DD
pub fn format_date(iso_string: String) -> String {
  // Extract first 10 characters (YYYY-MM-DD)
  case string.slice(iso_string, 0, 10) {
    Ok(date) -> date
    Error(_) -> iso_string
  }
}

/// Format ISO date string to locale-aware short format
pub fn format_date_short(iso_string: String, locale: Locale) -> String {
  // For now, use YYYY-MM-DD universally
  format_date(iso_string)
}
```

**File: `apps/client/src/scrumbringer_client/features/invites/view.gleam`**

```gleam
import scrumbringer_client/utils/date_format

// In table row rendering, replace:
// text(invite.created_at)
// With:
text(date_format.format_date(invite.created_at))
```

### Acceptance Criteria
- [ ] Created dates show as YYYY-MM-DD
- [ ] Expiry dates show as YYYY-MM-DD
- [ ] Format consistent across all admin tables

### Test Criteria
```javascript
// Playwright test
const dateCell = await page.locator('td:has-text("2026-")').first();
const dateText = await dateCell.textContent();
// Should match YYYY-MM-DD pattern, not full ISO
expect(dateText).toMatch(/^\d{4}-\d{2}-\d{2}$/);
expect(dateText).not.toContain('T');
expect(dateText).not.toContain('Z');
```

---

## Issue 6: "Salir" Button Missing Secondary Style

### Problem
The logout button "Salir" should have a secondary/ghost style to differentiate it from primary actions, but currently uses `btn-logout` class without explicit secondary styling.

### Technical Analysis

**Affected Files:**
- `apps/client/src/scrumbringer_client/features/layout/right_panel.gleam`
- `apps/client/src/scrumbringer_client/styles.gleam`

### Solution

Add explicit secondary button class.

### Implementation

**File: `apps/client/src/scrumbringer_client/features/layout/right_panel.gleam`**

```gleam
// Change logout button class from:
attribute.class("btn-logout"),

// To:
attribute.class("btn-action btn-action-secondary btn-logout"),
```

**File: `apps/client/src/scrumbringer_client/styles.gleam`**

```css
.btn-action.btn-action-secondary {
  background: transparent;
  color: var(--sb-text-muted);
  border: 1px solid var(--sb-border);
}

.btn-action.btn-action-secondary:hover {
  background: var(--sb-elevated);
  color: var(--sb-text);
}

/* Specific logout styling */
.btn-logout {
  margin-top: auto;
}
```

### Acceptance Criteria
- [ ] "Salir" button has transparent background
- [ ] "Salir" button has border
- [ ] "Salir" button is visually distinct from primary buttons
- [ ] Hover state shows subtle background

### Test Criteria
```javascript
// Playwright test
const salirBtn = page.locator('button:has-text("Salir")');
const styles = await salirBtn.evaluate(el => ({
  bg: getComputedStyle(el).backgroundColor,
  border: getComputedStyle(el).border
}));

// Should have transparent or very light background
expect(styles.bg).toMatch(/rgba\(0,\s*0,\s*0,\s*0\)|transparent/);
// Should have visible border
expect(styles.border).not.toContain('none');
```

---

## Implementation Priority

| Priority | Issue | Effort | Impact |
|----------|-------|--------|--------|
| 1 | Color Picker Cut-off | Medium | High - Blocks card creation |
| 2 | Navigation Links | Low | High - Blocks view switching |
| 3 | Nueva tarea Button | Low | Medium - Investigate first |
| 4 | Button Style Consistency | Low | Medium - Visual polish |
| 5 | Date Format | Low | Low - Cosmetic |
| 6 | Salir Button Style | Low | Low - Cosmetic |

## Dependencies

- Issue 1 (Color Picker) requires CSS changes and possibly Gleam component changes
- Issues 2, 3 may be testing issues rather than code issues - investigate first
- Issues 4, 5, 6 are CSS/styling changes with no component logic changes

## Playwright Test File

Save as `/tmp/playwright-4.8.1-validation.js`:

```javascript
const { chromium } = require('playwright');

const TARGET_URL = 'https://localhost:8443';

async function login(page, email) {
  await page.goto(TARGET_URL, { waitUntil: 'networkidle' });
  const inputs = await page.locator('input').all();
  if (inputs.length >= 2) {
    await inputs[0].fill(email);
    await inputs[1].fill('passwordpassword');
    await page.click('button:has-text("Acceso")');
    await page.waitForTimeout(2500);
  }
}

(async () => {
  const browser = await chromium.launch({
    headless: true,
    args: ['--ignore-certificate-errors']
  });

  const context = await browser.newContext({
    ignoreHTTPSErrors: true,
    viewport: { width: 1280, height: 800 }
  });
  const page = await context.newPage();

  try {
    await login(page, 'admin@example.com');

    console.log('\n=== VALIDATION 4.8.1 UX FIXES ===\n');

    // Test 1: Color Picker
    console.log('TEST 1: Color Picker Visibility');
    await page.click('[data-testid="btn-new-card"]');
    await page.waitForSelector('card-crud-dialog');
    await page.click('.color-picker-trigger');
    const colorOptions = await page.locator('.color-picker-option:visible').count();
    console.log(`  Visible color options: ${colorOptions}/24`);
    console.log(colorOptions >= 20 ? '  ✓ PASS' : '  ✗ FAIL');
    await page.keyboard.press('Escape');
    await page.waitForTimeout(500);

    // Test 2: Nueva tarea button
    console.log('\nTEST 2: Nueva tarea Button');
    const tareaBtn = page.locator('[data-testid="btn-new-task"]');
    const isEnabled = !(await tareaBtn.isDisabled());
    console.log(`  Button enabled: ${isEnabled}`);
    if (isEnabled) {
      await tareaBtn.click();
      await page.waitForTimeout(1000);
      const dialogVisible = await page.locator('.dialog, [class*="modal"]').count();
      console.log(dialogVisible > 0 ? '  ✓ PASS - Dialog opened' : '  ✗ FAIL - No dialog');
      await page.keyboard.press('Escape');
    }

    // Test 3: Navigation Links
    console.log('\nTEST 3: Navigation Links');
    const initialUrl = page.url();
    await page.click('[data-testid="nav-list"]');
    await page.waitForTimeout(1000);
    const newUrl = page.url();
    console.log(`  URL changed: ${initialUrl !== newUrl}`);
    const hasListView = await page.locator('table, .list-view').count();
    console.log(hasListView > 0 ? '  ✓ PASS - List view visible' : '  ✗ FAIL - No list view');

    // Test 4: Button Style Consistency
    console.log('\nTEST 4: Button Style Consistency');
    await page.click('[data-testid="nav-pool"]');
    await page.waitForTimeout(500);
    const tareaStyles = await page.locator('[data-testid="btn-new-task"]').evaluate(el =>
      getComputedStyle(el).backgroundColor);
    const tarjetaStyles = await page.locator('[data-testid="btn-new-card"]').evaluate(el =>
      getComputedStyle(el).backgroundColor);
    console.log(`  Nueva tarea bg: ${tareaStyles}`);
    console.log(`  Nueva tarjeta bg: ${tarjetaStyles}`);
    console.log(tareaStyles === tarjetaStyles ? '  ✓ PASS' : '  ✗ FAIL - Styles differ');

    // Test 5: Date Format
    console.log('\nTEST 5: Date Format');
    await page.click('[data-testid="nav-invites"]');
    await page.waitForTimeout(1000);
    const dateCell = await page.locator('td').filter({ hasText: /2026/ }).first();
    if (await dateCell.count() > 0) {
      const dateText = await dateCell.textContent();
      const isShortFormat = !dateText.includes('T') && !dateText.includes('Z');
      console.log(`  Date text: ${dateText}`);
      console.log(isShortFormat ? '  ✓ PASS' : '  ✗ FAIL - ISO format');
    }

    // Test 6: Salir Button Style
    console.log('\nTEST 6: Salir Button Style');
    const salirBtn = page.locator('button:has-text("Salir")');
    const salirBg = await salirBtn.evaluate(el => getComputedStyle(el).backgroundColor);
    const isSecondary = salirBg.includes('rgba(0, 0, 0, 0)') || salirBg === 'transparent';
    console.log(`  Background: ${salirBg}`);
    console.log(isSecondary ? '  ✓ PASS - Secondary style' : '  ✗ FAIL - Not secondary');

    console.log('\n=== VALIDATION COMPLETE ===');

  } catch (error) {
    console.error('Error:', error.message);
  } finally {
    await browser.close();
  }
})();
```

---

## Sign-off

- [ ] Tech Lead Review
- [ ] UX Review
- [ ] Ready for Sprint Planning
