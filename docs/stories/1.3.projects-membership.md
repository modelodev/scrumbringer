# Story 1.3: Projects + Membership Management

## Status
Done

## Story
**As an** org admin or project admin,
**I want** to create projects and manage project membership,
**so that** the organization can collaborate across multiple projects with admin-managed access.

## Acceptance Criteria
1. **Create project (org admin only)**: `POST /api/v1/projects` is allowed only for org admins; non-org-admins are rejected with `403` error code `FORBIDDEN`.
2. **List my projects only**: `GET /api/v1/projects` returns only projects the current user belongs to.
3. **List sorting**: `GET /api/v1/projects` returns projects sorted by `name ASC`.
4. **Includes my role**: Each project in `GET /api/v1/projects` includes `my_role` for the current user (used to drive UI permissions).
5. **List members (project admin only)**: `GET /api/v1/projects/:project_id/members` is allowed only for project admins of that project.
6. **Add member (project admin only)**: `POST /api/v1/projects/:project_id/members` is allowed only for project admins of that project and accepts `{ user_id, role }` where `role` is `member|admin`.
7. **Add member is same-org only**: Adding a project member is rejected (non-2xx) if the target `user_id` is not in the same organization as the project.
8. **Remove member (project admin only)**: `DELETE /api/v1/projects/:project_id/members/:user_id` is allowed only for project admins of that project.
9. **Cannot remove last project admin**: Removing the last project admin is rejected (non-2xx) and the membership is not changed.
10. **Admin-managed membership (negative)**: There is no self-join capability in MVP; users do not gain project membership without a project admin adding them.

## Tasks / Subtasks
- [x] Implement projects storage and endpoints (AC: 1, 2, 3, 4)
  - [x] Create `projects` table usage (org-scoped) (AC: 1)
  - [x] Implement `POST /api/v1/projects` (org admin authz) (AC: 1)
  - [x] Implement `GET /api/v1/projects` (membership-scoped, includes `my_role`, sorted) (AC: 2, 3, 4)
- [x] Implement project membership storage and endpoints (AC: 5, 6, 7, 8, 9)
  - [x] Create/read/write `project_members` with roles `member|admin` (AC: 6)
  - [x] Implement `GET /projects/:project_id/members` (AC: 5)
  - [x] Implement `POST /projects/:project_id/members` (AC: 6, 7)
  - [x] Implement `DELETE /projects/:project_id/members/:user_id` (AC: 8, 9)
  - [x] Enforce “cannot remove last admin” rule (AC: 9)
  - [x] Enforce “target user must be in same org as project” constraint (AC: 7)
- [x] Add tests for role checks and constraints (AC: 1, 5, 6, 7, 8, 9)
  - [x] Non-org-admin cannot create project (`FORBIDDEN`) (AC: 1)
  - [x] Project list is membership-scoped + sorted, includes `my_role` (AC: 2, 3, 4)
  - [x] Non-project-admin cannot list/add/remove members (AC: 5, 6, 8)
  - [x] Adding a member from a different org is rejected (AC: 7)
  - [x] Attempt to remove last project admin is rejected and leaves membership unchanged (AC: 9)

## Dev Notes
Source of truth:
- API contract (projects + members endpoints and rules): `docs/architecture/api-contract.md` (see “Projects”, “Project Members (admin-managed)”, “Roles”) 
- Data model (tables): `docs/architecture/data-model.md` (see “Project”, “ProjectMember”) 
- Product constraints: `docs/brief.md` (see “Scope Organizacional (MVP)”) 

Org/project model (MVP):
- A user belongs to exactly **one organization**.
- An organization can have **multiple projects**.
- A user can be in **multiple projects** within the org.
- Project membership is **admin-managed** (no self-join).
  [Source: `docs/brief.md` “Scope Organizacional (MVP)” and `docs/architecture/api-contract.md` “Authorization Rules (MVP)” / “Project Members (admin-managed)”]

API behaviors (MVP):
- `GET /api/v1/projects` includes `my_role` per project.
  [Source: `docs/architecture/api-contract.md` “Project” resource]
- Adding a project member must ensure the target user is in the same org as the project.
  [Source: `docs/architecture/data-model.md` “Commands” → `AddProjectMember`]

### Testing
- Use `gleeunit`.
- Focus tests on:
  - role checks (org admin vs project admin vs member),
  - last-admin removal constraint,
  - response shape including `my_role` and ordering (`name ASC`).

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-12 | 1.0 | Initial draft | architect |
| 2026-01-12 | 1.1 | Refined story statement, acceptance criteria, tasks, dev notes, and testing focus aligned to projects/membership contract | sm |
| 2026-01-13 | 1.2 | Implemented projects + membership endpoints with Postgres persistence, Squirrel queries, CSRF enforcement, and tests | dev |

## Dev Agent Record

### Agent Model Used
GPT-5.2 (Codex CLI)

### Debug Log References
- `PGHOST=localhost PGPORT=5433 PGUSER=scrumbringer PGDATABASE=scrumbringer_test ../../.tools/gleam-1.14.0/gleam run -m squirrel`
- `DATABASE_URL="postgres://scrumbringer@localhost:5433/scrumbringer_test" ../../.tools/gleam-1.14.0/gleam test`
- `../../.tools/gleam-1.14.0/gleam format`

### Completion Notes List
- Added Projects endpoints: `POST /api/v1/projects` (org admin only + CSRF) and `GET /api/v1/projects` (membership-scoped, sorted by `name ASC`, includes `my_role`).
- Added Project Members endpoints: `GET /api/v1/projects/:project_id/members`, `POST /api/v1/projects/:project_id/members`, `DELETE /api/v1/projects/:project_id/members/:user_id` (project admin only; CSRF on mutating).
- Enforced constraints: target user must be in same org as project; cannot remove last project admin.
- Added HTTP integration tests covering authz and constraints (AC: 1, 2, 3, 4, 5, 6, 7, 8, 9).

### File List
- Modified: `apps/server/src/scrumbringer_server.gleam`
- Modified: `apps/server/src/scrumbringer_server/sql.gleam`
- Added: `apps/server/src/scrumbringer_server/http/projects.gleam`
- Added: `apps/server/src/scrumbringer_server/services/projects_db.gleam`
- Added: `apps/server/src/scrumbringer_server/sql/projects_create.sql`
- Added: `apps/server/src/scrumbringer_server/sql/projects_for_user.sql`
- Added: `apps/server/src/scrumbringer_server/sql/projects_org_id.sql`
- Added: `apps/server/src/scrumbringer_server/sql/users_org_id.sql`
- Added: `apps/server/src/scrumbringer_server/sql/project_members_is_admin.sql`
- Added: `apps/server/src/scrumbringer_server/sql/project_members_list.sql`
- Added: `apps/server/src/scrumbringer_server/sql/project_members_insert.sql`
- Added: `apps/server/src/scrumbringer_server/sql/project_members_remove.sql`
- Added: `apps/server/test/projects_http_test.gleam`

## QA Results

### Review Date: 2026-01-13

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Implementation satisfies the story’s access control and data constraints: org-admin-only project creation, membership-scoped project listing sorted by name with `my_role`, project-admin-only member management, same-org enforcement when adding members, and prevention of removing the last project admin.

### Refactoring Performed

- None during QA review.

### Compliance Check

- Coding Standards: ✓ (HTTP handler split into `http/projects.gleam`; DB logic isolated in `projects_db`)
- Testing Strategy: ✓ (integration tests cover authz + constraints)
- All ACs Met: ✓

### Improvements Checklist

- [x] Verify mutating endpoints enforce double-submit CSRF.
- [x] Verify org-admin and project-admin rules.
- [x] Verify same-org constraint for adding member.
- [x] Verify cannot remove last admin constraint.
- [ ] Consider tightening error code consistency vs the API contract as it solidifies.

### Evidence

- Tests passed:
  - `apps/server`: `DATABASE_URL=postgres://scrumbringer:scrumbringer@localhost:5433/scrumbringer_test?sslmode=disable ../../.tools/gleam-1.14.0/gleam test`

### Gate Status

Gate: PASS → docs/qa/gates/1.3-projects-membership.yml

### Recommended Status

✓ Ready for Done
