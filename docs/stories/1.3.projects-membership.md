# Story 1.3: Projects + Membership Management

## Status
Approved

## Story
**As an** org admin or project admin,
**I want** to create projects and manage project membership,
**so that** the organization can collaborate across multiple projects with admin-managed access.

## Acceptance Criteria
1. **Create project (org admin only)**: `POST /api/v1/projects` is allowed only for org admins; non-org-admins are rejected with `403` error code `FORBIDDEN`.
2. **List my projects only**: `GET /api/v1/projects` returns only projects the current user belongs to.
3. **List sorting**: `GET /api/v1/projects` returns projects sorted by `name ASC`.
4. **Includes my role**: Each project in `GET /api/v1/projects` includes `my_role` for the current user (used to drive UI permissions).
5. **List members (project admin only)**: `GET /api/v1/projects/:project_id/members` is allowed only for project admins of that project.
6. **Add member (project admin only)**: `POST /api/v1/projects/:project_id/members` is allowed only for project admins of that project and accepts `{ user_id, role }` where `role` is `member|admin`.
7. **Add member is same-org only**: Adding a project member is rejected (non-2xx) if the target `user_id` is not in the same organization as the project.
8. **Remove member (project admin only)**: `DELETE /api/v1/projects/:project_id/members/:user_id` is allowed only for project admins of that project.
9. **Cannot remove last project admin**: Removing the last project admin is rejected (non-2xx) and the membership is not changed.
10. **Admin-managed membership (negative)**: There is no self-join capability in MVP; users do not gain project membership without a project admin adding them.

## Tasks / Subtasks
- [ ] Implement projects storage and endpoints (AC: 1, 2, 3, 4)
  - [ ] Create `projects` table usage (org-scoped) (AC: 1)
  - [ ] Implement `POST /api/v1/projects` (org admin authz) (AC: 1)
  - [ ] Implement `GET /api/v1/projects` (membership-scoped, includes `my_role`, sorted) (AC: 2, 3, 4)
- [ ] Implement project membership storage and endpoints (AC: 5, 6, 7, 8, 9)
  - [ ] Create/read/write `project_members` with roles `member|admin` (AC: 6)
  - [ ] Implement `GET /projects/:project_id/members` (AC: 5)
  - [ ] Implement `POST /projects/:project_id/members` (AC: 6, 7)
  - [ ] Implement `DELETE /projects/:project_id/members/:user_id` (AC: 8, 9)
  - [ ] Enforce “cannot remove last admin” rule (AC: 9)
  - [ ] Enforce “target user must be in same org as project” constraint (AC: 7)
- [ ] Add tests for role checks and constraints (AC: 1, 5, 6, 7, 8, 9)
  - [ ] Non-org-admin cannot create project (`FORBIDDEN`) (AC: 1)
  - [ ] Project list is membership-scoped + sorted, includes `my_role` (AC: 2, 3, 4)
  - [ ] Non-project-admin cannot list/add/remove members (AC: 5, 6, 8)
  - [ ] Adding a member from a different org is rejected (AC: 7)
  - [ ] Attempt to remove last project admin is rejected and leaves membership unchanged (AC: 9)

## Dev Notes
Source of truth:
- API contract (projects + members endpoints and rules): `docs/architecture/api-contract.md` (see “Projects”, “Project Members (admin-managed)”, “Roles”) 
- Data model (tables): `docs/architecture/data-model.md` (see “Project”, “ProjectMember”) 
- Product constraints: `docs/brief.md` (see “Scope Organizacional (MVP)”) 

Org/project model (MVP):
- A user belongs to exactly **one organization**.
- An organization can have **multiple projects**.
- A user can be in **multiple projects** within the org.
- Project membership is **admin-managed** (no self-join).
  [Source: `docs/brief.md` “Scope Organizacional (MVP)” and `docs/architecture/api-contract.md` “Authorization Rules (MVP)” / “Project Members (admin-managed)”]

API behaviors (MVP):
- `GET /api/v1/projects` includes `my_role` per project.
  [Source: `docs/architecture/api-contract.md` “Project” resource]
- Adding a project member must ensure the target user is in the same org as the project.
  [Source: `docs/architecture/data-model.md` “Commands” → `AddProjectMember`]

### Testing
- Use `gleeunit`.
- Focus tests on:
  - role checks (org admin vs project admin vs member),
  - last-admin removal constraint,
  - response shape including `my_role` and ordering (`name ASC`).

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-12 | 1.0 | Initial draft | architect |
| 2026-01-12 | 1.1 | Refined story statement, acceptance criteria, tasks, dev notes, and testing focus aligned to projects/membership contract | sm |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
