# Story 6.1: Cache de Fichas Normalizado (Arquitectura de Alto Rendimiento)

## Status

Draft

## Story

**As a** miembro del equipo,
**I want** que las fichas se gestionen mediante un cache normalizado y particionado,
**so that** el sistema sea instantaneo, el sidebar siempre sea consistente y el orden de las fichas se preserve por proyecto.

## Problem Statement

La implementación actual de `member_cards` como una lista plana que se sobrescribe causa parpadeo y falta de datos para tareas de proyectos secundarios en el sidebar. 
Aunque el patrón de "espejo" (copiar tareas) mejoraría la persistencia, seguiría pagando un coste $O(n)$ en búsquedas y renders. Necesitamos una arquitectura que separe la **identidad** de los datos del **orden** en la interfaz.

---

## Arquitectura (Patrón de 3 Estructuras con Tipo Opaco)

Adoptamos un modelo normalizado para maximizar el rendimiento en las vistas y la consistencia global:

### 1. Estado (MemberModel)

Agregamos al `MemberModel`:
- **`member_cards_store: NormalizedStore(Int, Card)`**: Store opaco con entidades, indices y pending.

Mantenemos para compatibilidad:
- **`member_cards: Remote(List(Card))`**: Lista global aplanada. Se regenera desde el store cuando termina la carga.

---

## Idiomatico en Gleam + Lustre (Type/System/TDD)

### Tipos y patrones

- **Firmas primero**: declarar tipos de helpers antes de implementar.
- **Exhaustive match**: evitar `_` en `case` sobre `Remote` y `Option`.
- **Sin estados ilegales**: usar `Option` para ausencia y `Result` para errores esperados.
- **Reusar patrones existentes**: seguir `member_tasks_by_project` como referencia directa.

### Lustre/TEA

- **Views puras**: ninguna transformacion con efectos en `view`.
- **Effects en update**: todo fetch/side-effect en `update`/effects.
- **Separacion clara**: helpers puros en `update_helpers`/`card_queries`.

### TDD (orden obligatorio)

1. Escribir tests que fallen para los helpers (`store.upsert`, `store.to_list`).
2. Escribir tests de update para `MemberProjectCardsFetched`.
3. Implementar codigo minimo para pasar tests.
4. Refactor si es necesario (mantener helpers puros).

### 2. Pipeline de Normalización (Upsert)

Cuando llega la respuesta `Ok(cards)` de un proyecto:
1. **Upsert**: `store.upsert(member_cards_store, project_id, cards)`.
2. **Decrementar Pending**: gestionado por el store.
3. **Flatten Final**: si `store.is_ready(...)`, regenerar `member_cards` con `store.to_list(...)`.

### 3. Reglas de UI

- **Acceso por ID (Sidebar/Tasks)**: `store.get_by_id(...)`.
- **Vista de Proyecto (Pool/Kanban)**: `store.get_by_project(...)`.
- **Vista Global**: `store.to_list(...)` o `member_cards`.

---

## Acceptance Criteria

1. `member_cards_store` contiene todas las fichas cargadas sin duplicados.
2. `member_cards_store` preserva el orden exacto del servidor para cada proyecto.
3. El sidebar derecho muestra correctamente el título/color de historias de cualquier proyecto cargado.
4. `card_queries.find_card` utiliza el store para lookup $O(1)$.
5. El cambio de proyecto no provoca el vaciado de las fichas de otros proyectos.
6. Los errores de red no borran los datos previos en el store.
7. El rendimiento de renderizado en el Pool no se ve afectado por el número total de fichas en memoria.

---

## Dev Notes

### Contexto Tecnico

- Cliente Lustre TEA con estado en `apps/client/src/scrumbringer_client/client_state.gleam`. [Source: docs/architecture/source-tree.md]
- Reusar patrones existentes de cache por proyecto (`member_tasks_by_project`). [Source: docs/architecture/coding-standards.md]
- Helpers puros en `update_helpers` y queries en `utils/card_queries`. [Source: docs/architecture/coding-standards.md]

### Archivos implicados

- `apps/client/src/scrumbringer_client/client_state.gleam`
- `apps/client/src/scrumbringer_client/client_update.gleam`
- `apps/client/src/scrumbringer_client/client_update_dispatch.gleam`
- `apps/client/src/scrumbringer_client/update_helpers.gleam`
- `apps/client/src/scrumbringer_client/utils/card_queries.gleam`
- `apps/client/src/scrumbringer_client/features/fichas/view.gleam`

### Comportamiento de estados remotos

- Si hay cache por proyecto, la vista debe renderizar desde cache aunque `member_cards` este en `Loading`.
- En error parcial, no borrar `member_cards_store`.

### Testing (estandares del proyecto)

- Framework: `gleeunit` (tests de cliente en `apps/client/test/`). [Source: docs/architecture/coding-standards.md]
- Convencion: funciones terminan en `_test`. [Source: docs/architecture/coding-standards.md]
- Ejecutar: `cd apps/client && gleam test`. [Source: docs/architecture/coding-standards.md]

---

## Plan de Implementacion

### 1) Cambios en el Estado
- `apps/client/src/scrumbringer_client/client_state.gleam`
  - Agregar `member_cards_store: NormalizedStore(Int, Card)`.
  - Inicializar en `default_model()`.

### 2) Lógica de Normalización
- `apps/client/src/scrumbringer_client/state/normalized_store.gleam`
  - Tipo opaco `NormalizedStore(id, data)`.
  - API propuesta (firmas):
    ```gleam
    pub opaque type NormalizedStore(id, data)

    pub fn new() -> NormalizedStore(id, data)
    pub fn with_pending(store: NormalizedStore(id, data), pending: Int) -> NormalizedStore(id, data)
    pub fn pending(store: NormalizedStore(id, data)) -> Int
    pub fn decrement_pending(store: NormalizedStore(id, data)) -> NormalizedStore(id, data)

    pub fn upsert(
      store: NormalizedStore(id, data),
      project_id: id,
      items: List(data),
      to_id: fn(data) -> id,
    ) -> NormalizedStore(id, data)

    pub fn get_by_id(
      store: NormalizedStore(id, data),
      item_id: id,
    ) -> Option(data)

    pub fn get_by_project(
      store: NormalizedStore(id, data),
      project_id: id,
    ) -> List(data)

    pub fn to_list(store: NormalizedStore(id, data)) -> List(data)

    pub fn is_ready(store: NormalizedStore(id, data)) -> Bool
    ```
  - Firmas publicas con tipos explicitos.

### 3) Refresh y Dispatch
- `apps/client/src/scrumbringer_client/client_update.gleam`
  - Modificar `refresh_member_data` para emitir `MemberProjectCardsFetched` por cada proyecto.
- `apps/client/src/scrumbringer_client/client_update_dispatch.gleam`
  - Implementar el handler de `MemberProjectCardsFetched` con la lógica de normalización.

### 4) Optimización de Queries
- `apps/client/src/scrumbringer_client/utils/card_queries.gleam`
  - Refactorizar `find_card` para usar `member_cards_store`.
  - Refactorizar `get_project_cards` para usar `store.get_by_project`.

### 5) Actualización de Vistas
- `apps/client/src/scrumbringer_client/features/fichas/view.gleam`
  - Asegurar que usa las nuevas queries optimizadas.

---

## Tasks / Subtasks

- [ ] Task 1 (AC: 1, 2, 5)
  - [ ] Agregar `member_cards_store: NormalizedStore(Int, Card)` al `MemberModel`.
  - [ ] Inicializar nuevos campos en `default_model()`.

- [ ] Task 2 (AC: 1, 2, 4)
  - [ ] Implementar `NormalizedStore` opaco en `state/normalized_store.gleam`.
  - [ ] Asegurar firmas publicas con tipos explicitos.

- [ ] Task 3 (AC: 5, 6)
  - [ ] Emitir `MemberProjectCardsFetched(project_id, result)` por cada proyecto en `refresh_member_data`.
  - [ ] Eliminar el branch de cards solo para selected_project_id.

- [ ] Task 4 (AC: 1, 2, 6)
  - [ ] Manejar `MemberProjectCardsFetched` usando `store.upsert` + `store.is_ready` + `store.to_list`.
  - [ ] Mantener cache en errores parciales.

- [ ] Task 5 (AC: 3, 4)
  - [ ] Refactorizar `card_queries.find_card` para usar `member_cards_store`.
  - [ ] Refactorizar `card_queries.get_project_cards` para usar `store.get_by_project`.

- [ ] Task 6 (AC: 3, 7)
  - [ ] Actualizar `features/fichas/view.gleam` para usar las nuevas queries.
  - [ ] Verificar que la vista usa cache si existe.

- [ ] Task 7 (AC: 1-7)
  - [ ] Implementar tests obligatorios (seccion inferior).

---

## Test Plan

1. **Test de Identidad**: Verificar que actualizar una ficha en el Proyecto A no duplica la entrada si el ID ya existe.
2. **Test de Orden**: Confirmar que `get_project_cards` devuelve las fichas en el orden exacto definido en el índice del proyecto.
3. **Test de Sidebar**: Simular una tarea del Proyecto B en el sidebar mientras el Pool está en Proyecto A y verificar que la ficha de B se encuentra correctamente.
4. **Test de Robustez**: Verificar que un error de carga en el Proyecto B deja intactas las fichas del Proyecto A ya existentes en el cache.

---

## Tests Obligatorios (Gate de Calidad)

### Helpers (unit)

1. `store.upsert` no duplica y actualiza por id.
2. `store.to_list` respeta el orden por proyecto y omite ids inexistentes.
3. `store.upsert` con lista vacia no modifica el store.
4. `store.upsert` con ids duplicados en la misma respuesta deja una sola entrada.
5. `store.to_list` no falla si un proyecto no tiene ids cargados.
6. `store.get_by_project` omite ids inexistentes sin error.

### Update (unit)

3. `MemberProjectCardsFetched(Ok)` actualiza `member_cards_store`.
4. `MemberProjectCardsFetched(Error)` no borra cache previa y deja `member_cards` en `Failed`.
5. `pending` nunca baja de 0 con respuestas repetidas o fuera de orden.
6. Respuesta tardia de Proyecto A no sobrescribe indices de Proyecto B.
7. Si ya habia `member_cards = Loaded`, un Error parcial no borra la lista global existente.
8. `member_cards_store` mantiene `pending` coherente al hacer refresh multi-proyecto.

### Queries (unit)

5. `find_card` usa `store.get_by_id` con lookup O(1).
6. `get_project_cards` respeta el orden por `store.get_by_project`.
7. `get_project_cards` ignora ids inexistentes y no revienta.

### Views (render)

7. Fichas muestra cache si existe (sin Loading).
8. Fichas muestra Loading solo cuando no hay cache y hay pending.
9. Fichas muestra Empty cuando no hay cache ni pending.

---

## Tests (Nombres y Ubicacion)

- `apps/client/test/normalized_store_test.gleam`
  - `upsert_deduplicates_by_id_test`
  - `upsert_empty_list_no_changes_test`
  - `to_list_preserves_project_order_test`
  - `to_list_skips_missing_ids_test`
  - `get_by_project_ignores_missing_ids_test`

- `apps/client/test/member_cards_store_update_test.gleam`
  - `member_project_cards_ok_updates_store_and_pending_test`
  - `member_project_cards_error_preserves_store_test`
  - `pending_never_below_zero_test`
  - `partial_error_keeps_global_loaded_test`

- `apps/client/test/card_queries_store_test.gleam`
  - `find_card_uses_store_by_id_test`
  - `get_project_cards_uses_store_index_test`

- `apps/client/test/fichas_view_store_test.gleam`
  - `fichas_uses_cache_when_available_test`
  - `fichas_shows_loading_only_without_cache_test`
  - `fichas_shows_empty_without_cache_or_pending_test`

---

## Testing (Ejecucion)

- Ejecutar tests de cliente: `cd apps/client && gleam test`
- Asegurar que los tests nuevos viven en `apps/client/test/` y siguen la convención `_test`.

---

## Definition of Done

- [ ] Todos los AC cumplidos.
- [ ] Tests obligatorios pasan en `apps/client`.
- [ ] No hay regresiones en `member_cards` ni en vistas de fichas.
- [ ] Codigo sigue patrones TEA y helpers puros.

---

## Out of Scope

- Cambios en API server.
- Cambios en Card CRUD admin.
- UI nueva de vistas globales.

---

## Change Log

| Fecha | Version | Descripcion | Autor |
|------|---------|-------------|-------|
| 2026-02-02 | 1.0 | Evolución a arquitectura normalizada de 3 estructuras | Architect |

---

## Dev Agent Record

### Agent Model Used

TBD

### Debug Log References

- TBD

### Completion Notes List

- TBD

### File List

- TBD

---

## QA Results

TBD
