# Story 5.3.1: Dise√±o de Mejoras UX para 100% Cobertura

## Objetivo

Completar AC16, AC20 y AC21 de Story 5.3 que actualmente est√°n parcialmente implementados.

---

## AC16: Hover en indicador `[!]` muestra preview rico

### Estado Actual
- Implementado: Tooltip simple con `title="Hay notas nuevas"`
- Falta: Preview rico con cantidad, tiempo, √∫ltima nota y autor

### Wireframe Objetivo
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üí¨ 2 notas nuevas               ‚îÇ
‚îÇ    desde hace 3 horas           ‚îÇ
‚îÇ                                 ‚îÇ
‚îÇ √öltima: "Revis√© los mockups..." ‚îÇ
‚îÇ         ‚Äî Mar√≠a G.              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Dise√±o T√©cnico

#### 1. Extender el modelo de Card
El backend debe incluir datos de preview en la respuesta de cards.

**Archivo**: `shared/src/domain/card.gleam`
```gleam
pub type Card {
  Card(
    // ... campos existentes ...
    has_new_notes: Bool,
    // NUEVO: Preview de notas para tooltip
    new_notes_count: Int,
    last_note_preview: Option(String),
    last_note_author: Option(String),
    last_note_time_ago: Option(String),
  )
}
```

#### 2. Actualizar SQL de listado de cards
**Archivo**: `apps/server/src/scrumbringer_server/sql/cards_list.sql`

```sql
-- A√±adir subquery para obtener √∫ltima nota
WITH card_notes_preview AS (
  SELECT DISTINCT ON (cn.card_id)
    cn.card_id,
    cn.content,
    u.email as author_email,
    cn.created_at
  FROM card_notes cn
  JOIN org_users u ON u.id = cn.user_id
  ORDER BY cn.card_id, cn.created_at DESC
)
SELECT
  c.*,
  -- Contar notas nuevas para el usuario
  (SELECT COUNT(*) FROM card_notes cn
   WHERE cn.card_id = c.id
   AND cn.created_at > COALESCE(ucv.last_viewed_at, '1970-01-01')) as new_notes_count,
  -- Preview de √∫ltima nota
  cnp.content as last_note_preview,
  cnp.author_email as last_note_author,
  -- Tiempo relativo (calculado en backend o frontend)
  cnp.created_at as last_note_at
FROM cards c
LEFT JOIN user_card_views ucv ON ucv.card_id = c.id AND ucv.user_id = $2
LEFT JOIN card_notes_preview cnp ON cnp.card_id = c.id
WHERE c.project_id = $1;
```

#### 3. Crear componente de popup hover
**Archivo**: `apps/client/src/scrumbringer_client/ui/notes_indicator.gleam`

```gleam
//// Notes indicator [!] with hover popup (AC16).

import gleam/int
import gleam/option.{type Option, None, Some}
import lustre/attribute
import lustre/element.{type Element}
import lustre/element/html.{div, span, text}
import lustre/event

import scrumbringer_client/ui/tooltips/types.{type NotesPreviewData}

pub type Labels {
  Labels(
    new_notes: String,        // "{n} notas nuevas"
    time_ago_prefix: String,  // "desde hace"
    latest: String,           // "√öltima:"
  )
}

pub type Config(msg) {
  Config(
    data: NotesPreviewData,
    labels: Labels,
    is_hovered: Bool,
    on_mouse_enter: msg,
    on_mouse_leave: msg,
  )
}

pub fn view(config: Config(msg)) -> Element(msg) {
  let Config(data: data, labels: labels, is_hovered: is_hovered, ..) = config

  div(
    [
      attribute.class("notes-indicator-wrapper"),
      event.on_mouse_enter(config.on_mouse_enter),
      event.on_mouse_leave(config.on_mouse_leave),
    ],
    [
      // El indicador [!]
      span(
        [
          attribute.class("card-notes-indicator"),
          attribute.attribute("data-testid", "card-notes-indicator"),
        ],
        [text("[!]")],
      ),
      // Popup que aparece en hover
      case is_hovered {
        True -> view_popup(data, labels)
        False -> element.none()
      },
    ],
  )
}

fn view_popup(data: NotesPreviewData, labels: Labels) -> Element(msg) {
  div(
    [
      attribute.class("notes-preview-popup"),
      attribute.role("tooltip"),
    ],
    [
      // Header: "2 notas nuevas"
      div([attribute.class("notes-preview-count")], [
        text("üí¨ " <> int.to_string(data.new_count) <> " " <> labels.new_notes),
      ]),
      // Time: "desde hace 3 horas"
      div([attribute.class("notes-preview-time")], [
        text(labels.time_ago_prefix <> " " <> data.time_ago),
      ]),
      // Preview de √∫ltima nota (si existe)
      case data.last_note_preview, data.last_note_author {
        Some(preview), Some(author) ->
          div([attribute.class("notes-preview-last")], [
            div([attribute.class("notes-preview-label")], [
              text(labels.latest),
            ]),
            div([attribute.class("notes-preview-content")], [
              text("\"" <> truncate(preview, 50) <> "\""),
            ]),
            div([attribute.class("notes-preview-author")], [
              text("‚Äî " <> author),
            ]),
          ])
        _, _ -> element.none()
      },
    ],
  )
}

fn truncate(s: String, max: Int) -> String {
  case string.length(s) > max {
    True -> string.slice(s, 0, max) <> "..."
    False -> s
  }
}
```

#### 4. CSS para el popup
**Archivo**: `apps/client/static/styles/components/_notes-indicator.css`

```css
.notes-indicator-wrapper {
  position: relative;
  display: inline-block;
}

.notes-preview-popup {
  position: absolute;
  top: 100%;
  left: 50%;
  transform: translateX(-50%);
  z-index: 1000;

  background: var(--sb-surface);
  border: 1px solid var(--sb-border);
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  padding: 12px;
  min-width: 200px;
  max-width: 280px;

  margin-top: 4px;
}

.notes-preview-count {
  font-weight: 600;
  color: var(--sb-primary);
  margin-bottom: 4px;
}

.notes-preview-time {
  font-size: 0.85em;
  color: var(--sb-muted);
  margin-bottom: 8px;
}

.notes-preview-label {
  font-size: 0.8em;
  color: var(--sb-muted);
  margin-bottom: 2px;
}

.notes-preview-content {
  font-style: italic;
  color: var(--sb-text);
  margin-bottom: 4px;
}

.notes-preview-author {
  font-size: 0.85em;
  color: var(--sb-muted);
  text-align: right;
}
```

#### 5. Integrar en vistas

**Archivos a modificar**:
- `kanban_board.gleam` - Reemplazar span simple por `notes_indicator.view`
- `grouped_list.gleam` - Idem
- `admin/view.gleam` - Idem

**Cambio requerido en config**:
```gleam
pub type KanbanConfig(msg) {
  KanbanConfig(
    // ... existentes ...
    // NUEVO: Estado de hover por card_id
    hovered_indicator: Option(Int),
    on_indicator_hover: fn(Option(Int)) -> msg,
  )
}
```

#### 6. i18n Labels necesarios

```gleam
// text.gleam
NewNotesCount(count: Int)      // "{n} notas nuevas" / "{n} new notes"
TimeAgoPrefix                   // "desde hace" / "ago"
LatestNote                      // "√öltima:" / "Latest:"
```

---

## AC20: Hover en nombre de autor muestra email y rol

### Estado Actual
- Componente `author_tooltip.gleam` existe
- Tipo `AuthorInfo` definido
- NO integrado en `notes_list.gleam`

### Wireframe Objetivo
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üë§ Mar√≠a Garc√≠a                ‚îÇ
‚îÇ    maria@example.com           ‚îÇ
‚îÇ    üè∑Ô∏è Product Owner            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Dise√±o T√©cnico

#### 1. Extender NoteView con datos de autor
El tipo `NoteView` ya tiene `author_email` y `author_role`, pero no se usan.

**Archivo**: `apps/client/src/scrumbringer_client/ui/notes_list.gleam`

```gleam
pub type NoteView {
  NoteView(
    id: Int,
    author: String,
    created_at: String,
    content: String,
    can_delete: Bool,
    delete_context: DeleteNoteContext,
    author_email: String,   // Ya existe
    author_role: String,    // Ya existe
  )
}
```

#### 2. A√±adir estado de hover al componente

**Opci√≥n A: Estado local con CSS**

Usar CSS `:hover` pseudo-class para mostrar el tooltip sin estado Gleam:

```gleam
fn view_note(...) -> Element(msg) {
  div([attribute.class("note-item")], [
    div([attribute.class("note-header")], [
      // Wrapper con hover
      span(
        [attribute.class("note-author-wrapper")],
        [
          span([attribute.class("note-author")], [text(author)]),
          // Tooltip siempre renderizado, oculto por CSS
          view_author_tooltip(author, author_email, author_role),
        ],
      ),
      // ... resto
    ]),
  ])
}

fn view_author_tooltip(name: String, email: String, role: String) -> Element(msg) {
  div(
    [attribute.class("author-tooltip")],
    [
      div([attribute.class("author-tooltip-name")], [text("üë§ " <> name)]),
      div([attribute.class("author-tooltip-email")], [text(email)]),
      div([attribute.class("author-tooltip-role")], [
        text("üè∑Ô∏è " <> role),
      ]),
    ],
  )
}
```

#### 3. CSS para tooltip con hover puro

```css
.note-author-wrapper {
  position: relative;
  display: inline-block;
  cursor: pointer;
}

.author-tooltip {
  position: absolute;
  bottom: 100%;
  left: 0;
  z-index: 100;

  background: var(--sb-surface);
  border: 1px solid var(--sb-border);
  border-radius: 6px;
  padding: 8px 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.12);

  white-space: nowrap;

  /* Oculto por defecto */
  opacity: 0;
  visibility: hidden;
  transform: translateY(4px);
  transition: opacity 0.15s, transform 0.15s, visibility 0.15s;
}

.note-author-wrapper:hover .author-tooltip {
  opacity: 1;
  visibility: visible;
  transform: translateY(0);
}

.author-tooltip-name {
  font-weight: 600;
  margin-bottom: 2px;
}

.author-tooltip-email {
  font-size: 0.85em;
  color: var(--sb-muted);
}

.author-tooltip-role {
  font-size: 0.85em;
  color: var(--sb-muted);
  margin-top: 4px;
}
```

#### 4. Obtener datos de autor desde backend

El backend debe incluir email y rol en la respuesta de notas.

**Archivo**: `apps/server/src/scrumbringer_server/sql/card_notes_list.sql`

```sql
SELECT
  n.id,
  n.card_id,
  n.user_id,
  n.content,
  to_char(n.created_at at time zone 'utc', 'YYYY-MM-DD"T"HH24:MI:SS"Z"') as created_at,
  -- NUEVO: Datos del autor
  u.email as author_email,
  COALESCE(pm.role, ou.org_role) as author_role
FROM card_notes n
JOIN org_users ou ON ou.id = n.user_id
LEFT JOIN project_members pm ON pm.user_id = n.user_id AND pm.project_id = (
  SELECT project_id FROM cards WHERE id = n.card_id
)
WHERE n.card_id = $1
ORDER BY n.created_at ASC;
```

---

## AC21: Sistema de Tabs con badge y tooltip

### Estado Actual
- `card_tabs.gleam` existe con tipos `Tab`, `Config`, `Labels`
- `tab_badge.gleam` existe para tooltip del badge
- Modal NO usa tabs (muestra notas y tareas en secciones separadas)

### Wireframe Objetivo
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   TAREAS    ‚îÇ  NOTAS (3)‚óè ‚îÇ  ACTIVIDAD  ‚îÇ
‚îÇ   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê   ‚îÇ      ‚ñº      ‚îÇ             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
          ‚îÇ 3 notas en total    ‚îÇ
          ‚îÇ 2 nuevas para ti    ‚îÇ
          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Dise√±o T√©cnico

#### 1. A√±adir estado de tab activo al modelo

**Archivo**: `apps/client/src/scrumbringer_client/components/card_detail_modal.gleam`

```gleam
import scrumbringer_client/ui/card_tabs

pub type Model {
  Model(
    // ... campos existentes ...
    // NUEVO: Tab activo
    active_tab: card_tabs.Tab,
    // NUEVO: Stats de notas para tooltip
    notes_stats: Option(TabNotesStats),
  )
}

// Mensaje para cambio de tab
pub type Msg {
  // ... existentes ...
  TabClicked(card_tabs.Tab)
}
```

#### 2. Inicializar con TAREAS como tab por defecto

```gleam
pub fn init(props: Props) -> #(Model, Effect(Msg)) {
  let model = Model(
    // ...
    active_tab: card_tabs.TasksTab,  // TAREAS por defecto
    notes_stats: None,
  )
  // ...
}
```

#### 3. Refactorizar vista del modal

```gleam
fn view_modal(model: Model, card: Card) -> Element(Msg) {
  let color_opt = color_from_string(card.color)
  let border_class = color_picker.border_class(color_opt)

  div([attribute.class("card-detail-modal")], [
    div([attribute.class("modal-backdrop"), event.on_click(CloseClicked)], []),
    div([attribute.class("modal-content card-detail " <> border_class)], [
      view_card_header(model, card),
      // NUEVO: Sistema de tabs
      view_tabs(model),
      // Contenido seg√∫n tab activo
      view_tab_content(model, card),
    ]),
  ])
}

fn view_tabs(model: Model) -> Element(Msg) {
  let notes_count = case model.notes {
    Loaded(list) -> list.length(list)
    _ -> 0
  }

  // Calcular si hay notas nuevas (simplificado)
  let has_new = case model.notes_stats {
    Some(stats) -> stats.new_for_user > 0
    None -> False
  }

  card_tabs.view(card_tabs.Config(
    active_tab: model.active_tab,
    notes_count: notes_count,
    has_new_notes: has_new,
    labels: card_tabs.Labels(
      tasks: t(model.locale, i18n_text.CardTasks),
      notes: t(model.locale, i18n_text.Notes),
      activity: t(model.locale, i18n_text.Activity),
    ),
    on_tab_click: TabClicked,
  ))
}

fn view_tab_content(model: Model, card: Card) -> Element(Msg) {
  case model.active_tab {
    card_tabs.TasksTab -> view_card_tasks_section(model)
    card_tabs.NotesTab -> view_card_notes_section(model)
    card_tabs.ActivityTab -> view_activity_section(model)  // Placeholder
  }
}

fn view_activity_section(_model: Model) -> Element(Msg) {
  div([attribute.class("card-detail-activity-section")], [
    div([attribute.class("empty-state")], [
      text("Pr√≥ximamente: historial de actividad"),
    ]),
  ])
}
```

#### 4. Modificar card_tabs.gleam para hover en badge

```gleam
fn tab_button(...) -> Element(msg) {
  button(
    [
      attribute.class(active_class),
      attribute.role("tab"),
      // ...
    ],
    [
      text(label),
      case count {
        Some(n) ->
          span(
            [
              attribute.class("tab-count"),
              // NUEVO: Tooltip con stats
              attribute.attribute("title",
                int.to_string(n) <> " notas en total"
              ),
            ],
            [text(" (" <> int.to_string(n) <> ")")],
          )
        None -> element.none()
      },
      // Indicador de nuevas
      case has_new {
        True ->
          span([attribute.class("new-notes-indicator")], [text("‚óè")])
        False -> element.none()
      },
    ],
  )
}
```

#### 5. Actualizar handler de mensajes

```gleam
fn update(model: Model, msg: Msg) -> #(Model, Effect(Msg)) {
  case msg {
    TabClicked(tab) -> #(Model(..model, active_tab: tab), effect.none())
    // ... resto
  }
}
```

#### 6. CSS para tabs

```css
.card-tabs {
  display: flex;
  border-bottom: 2px solid var(--sb-border);
  margin-bottom: 16px;
}

.card-tab {
  padding: 8px 16px;
  background: none;
  border: none;
  cursor: pointer;
  color: var(--sb-muted);
  font-weight: 500;
  position: relative;
}

.card-tab.tab-active {
  color: var(--sb-primary);
}

.card-tab.tab-active::after {
  content: '';
  position: absolute;
  bottom: -2px;
  left: 0;
  right: 0;
  height: 2px;
  background: var(--sb-primary);
}

.tab-count {
  font-size: 0.85em;
  color: var(--sb-muted);
}

.new-notes-indicator {
  color: var(--sb-accent);
  font-size: 0.7em;
  margin-left: 4px;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}
```

---

## Plan de Implementaci√≥n

### Fase 1: AC20 (m√°s simple, CSS-only hover)
1. Modificar SQL para incluir author_email y author_role
2. Actualizar decoder en cliente
3. A√±adir tooltip HTML al autor en notes_list.gleam
4. A√±adir CSS para mostrar en hover
5. Tests

**Estimaci√≥n**: ~2 horas

### Fase 2: AC21 (refactor de modal)
1. A√±adir active_tab al Model
2. A√±adir mensaje TabClicked
3. Refactorizar view_modal para usar tabs
4. Condicional de contenido seg√∫n tab
5. A√±adir CSS de tabs
6. Tests

**Estimaci√≥n**: ~3 horas

### Fase 3: AC16 (m√°s complejo, requiere backend)
1. Modificar SQL de cards para incluir preview data
2. Actualizar Card type en shared
3. Actualizar decoder en cliente
4. Crear notes_indicator.gleam con popup
5. A√±adir estado de hover al config de vistas
6. Integrar en kanban, lista, admin
7. A√±adir CSS de popup
8. Tests

**Estimaci√≥n**: ~4 horas

---

## i18n Labels Necesarios

```gleam
// A√±adir a text.gleam

// AC16
NewNotesCount(count: Int)  // "{n} notas nuevas"
TimeAgoPrefix              // "desde hace"
LatestNote                 // "√öltima:"

// AC21
Activity                   // "Actividad"
NotesTotal(count: Int)     // "{n} notas en total"
NotesNewForYou(count: Int) // "{n} nuevas para ti"
ActivityComingSoon         // "Pr√≥ximamente"
```

---

## Tests Requeridos

### AC16
- `notes_indicator_renders_popup_on_hover_test`
- `notes_indicator_shows_count_and_time_test`
- `notes_indicator_shows_last_note_preview_test`

### AC20
- `author_tooltip_shows_email_and_role_test`
- `author_tooltip_appears_on_hover_test`

### AC21
- `card_tabs_renders_three_tabs_test`
- `card_tabs_tasks_active_by_default_test`
- `card_tabs_shows_notes_count_test`
- `card_tabs_switches_content_on_click_test`
