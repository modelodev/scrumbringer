# Story 4.3: Org Users Management UX Improvements

## Status

Draft

## Story

**As an** Org Admin,  
**I want** to manage user project memberships and roles from a single, consistent interface,  
**so that** I can efficiently assign users to projects with appropriate roles without confusion.

## Prerequisites

- **Story 4.1** (Permissions Refactor) completed
- **Story 4.2** (Project Manager UX) completed - role change pattern established
- UX Specification: `docs/stories/4.3.org-users-ux.md`

> **Note:** This story follows the **"Clean Break" migration philosophy**:
> - No backward compatibility with old patterns
> - Consistent with Project Members view (4.2)

---

## Acceptance Criteria

### Main Table Improvements

1. **AC1**: "PROYECTOS" column shows summary text with count and project names (e.g., "2: Alpha (mgr), Beta")
2. **AC2**: "ROL" column header renamed to "ROL ORG" for clarity
3. **AC3**: "Ver" button renamed to "Gestionar"
4. **AC4**: Individual "Guardar" buttons per row replaced with single "Guardar cambios de rol" at bottom
5. **AC5**: Pending org role changes show visual indicator (*) next to dropdown
6. **AC6**: "Guardar cambios de rol" button disabled when no pending changes

### User Projects Dialog Improvements

7. **AC7**: Role column in projects table is editable dropdown (Manager/Member)
8. **AC8**: Changing role dropdown triggers immediate API call (same pattern as Project Members)
9. **AC9**: Add-to-project form includes role selector (Manager/Member dropdown)
10. **AC10**: Adding user to project respects selected role (not always "member")
11. **AC11**: Toast notification shown on successful role change
12. **AC12**: Error toast shown if role change fails (e.g., last manager protection)

### API Requirements

13. **AC13**: `POST /org/users/:id/projects` accepts optional `role` parameter (defaults to "member")
14. **AC14**: New endpoint `PATCH /org/users/:id/projects/:pid` changes user's role in a project
15. **AC15**: PATCH endpoint returns 422 with "last_manager" error when applicable

---

## API Specification

### POST /api/v1/org/users/:user_id/projects (Modified)

**Authorization:** Org Admin only

**Request Body:**
```json
{
  "project_id": 8,
  "role": "manager" | "member"  // optional, defaults to "member"
}
```

**Response 200:** (unchanged structure, now respects role)
```json
{
  "project": {
    "id": 8,
    "name": "Project Alpha",
    "role": "manager"
  }
}
```

### PATCH /api/v1/org/users/:user_id/projects/:project_id (New)

**Authorization:** Org Admin only

**Request Body:**
```json
{
  "role": "manager" | "member"
}
```

**Response 200:**
```json
{
  "project": {
    "id": 8,
    "name": "Project Alpha",
    "role": "manager",
    "previous_role": "member"
  }
}
```

**Response 422 (Last manager):**
```json
{
  "error": "last_manager",
  "message": "Cannot demote the last project manager"
}
```

**Response 404:**
```json
{
  "error": "not_found",
  "message": "User is not a member of this project"
}
```

---

## Tasks / Subtasks

### Server Tasks

- [ ] **Task 1: Modify add_user_to_project to accept role**
  - [ ] Update `handle_add_user_to_project` to parse optional `role` from JSON
  - [ ] Default to "member" if not provided
  - [ ] Pass role to `projects_db.add_member`
  - [ ] Update response to include role

- [ ] **Task 2: Add PATCH endpoint for user project role**
  - [ ] Add route `PATCH /org/users/:uid/projects/:pid` in router
  - [ ] Create handler `handle_update_user_project_role` in `org_users.gleam`
  - [ ] Reuse `projects_db.update_member_role` (from 4.2) or call directly
  - [ ] Handle last-manager protection (422)
  - [ ] Include project name in response

### Client Tasks

- [ ] **Task 3: Update main table UI**
  - [ ] Change "ROL" header to "ROL ORG"
  - [ ] Add projects summary in PROYECTOS column (count + names)
  - [ ] Rename "Ver" to "Gestionar"
  - [ ] Remove per-row "Guardar" buttons
  - [ ] Add single "Guardar cambios de rol" button at bottom
  - [ ] Add pending change indicator (*)
  - [ ] Disable save button when no pending changes

- [ ] **Task 4: Update user projects dialog**
  - [ ] Change role column from text to dropdown
  - [ ] Add `UserProjectRoleChangeRequested(project_id, role)` message
  - [ ] Add API call for project role change
  - [ ] Show toast on success/error
  - [ ] Add role selector to add-project form
  - [ ] Update `add_user_to_project` API call to include role

- [ ] **Task 5: Add i18n keys**
  - [ ] Add `OrgRole`, `ProjectsCount`, `Manage`, `SaveOrgRoleChanges`
  - [ ] Add `PendingChange`, `RoleInProject`, `ProjectRoleUpdated`
  - [ ] Translations for ES and EN

### Testing Tasks

- [ ] **Task 6: Server tests**
  - [ ] `add_user_to_project_with_role_test()` (AC13)
  - [ ] `add_user_to_project_defaults_to_member_test()` (AC13)
  - [ ] `update_user_project_role_test()` (AC14)
  - [ ] `update_user_project_role_last_manager_test()` (AC15)
  - [ ] `update_user_project_role_not_member_test()` (AC14)

---

## Dev Notes

### Reusing Existing Code

The `PATCH /projects/:id/members/:uid` endpoint (from Story 4.2) already handles role changes with last-manager protection. The new `PATCH /org/users/:uid/projects/:pid` should:

1. **Option A**: Call the same `projects_db.update_member_role` function
2. **Option B**: Delegate to the existing handler internally

Option A is cleaner - just reuse the database function.

### Projects Summary Format

The PROYECTOS column should show:
- "Sin proyectos" if empty
- "1: Alpha" if one project
- "2: Alpha (mgr), Beta" if multiple (show role indicator for managers)

Truncate if more than 3 projects: "3: Alpha (mgr), Beta, +1 m√°s"

### State Management

For pending org role changes:
- Keep existing `org_settings_role_drafts: Dict(Int, String)` 
- Add computed function `has_pending_org_role_changes(model)` for button state

---

## UI Reference

See `docs/stories/4.3.org-users-ux.md` for detailed wireframes and specifications.

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-21 | 1.0 | Initial story creation with UX spec | Sally (UX Expert) |
