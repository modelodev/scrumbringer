# Story 3.1: Fichas v1 (contenedor de tareas con estado derivado)

## Status: Draft

## Story
**As a** project admin,
**I want** to create and manage “fichas” (cards) that contain tasks,
**so that** we can group related work without forcing a specific agile methodology.

## Acceptance Criteria
1. **Entity exists**: A `Card` (ficha) exists with fields at least `{ id, project_id, title, description?, created_at }`.
2. **Task association**: A task can optionally belong to a card (ficha) via `card_id`.
3. **Card states**: Card state is one of `pendiente | en_curso | cerrada`.
4. **Automatic state transitions**: Card state is derived automatically from its tasks:
   - If all tasks are `completed` → card is `cerrada`.
   - Else if any task is `claimed` → card is `en_curso`.
   - Else → card is `pendiente`.
5. **No manual card state changes**: There is no endpoint/UI to set card state directly.
6. **Authz**: Creating/editing cards is restricted to project admins; members can view cards in their projects.
7. **API conventions**: Responses follow `{ data: ... }` envelope conventions.

## Tasks / Subtasks
- [ ] Define DB schema for cards + task relation (AC: 1, 2)
- [ ] Implement endpoints:
  - [ ] `POST /api/v1/projects/:project_id/cards` (create) (AC: 1, 6)
  - [ ] `GET /api/v1/projects/:project_id/cards` (list) (AC: 1, 6)
  - [ ] `PATCH /api/v1/cards/:card_id` (edit title/description) (AC: 1, 6)
- [ ] Extend tasks to support `card_id`:
  - [ ] `POST /api/v1/cards/:card_id/tasks` (create task within card) (AC: 2)
  - [ ] Or allow passing `card_id` in task create (decide and document) (AC: 2)
- [ ] Implement card state derivation (AC: 3, 4, 5)
  - [ ] Derive on read (query-time) OR maintain a materialized state updated on task events (choose) (AC: 4)
- [ ] Tests:
  - [ ] Card state derivation logic (AC: 4)
  - [ ] Authz for create/edit (AC: 6)

## Dev Notes
⚠️ **Planning stub / example**: This story is not fully refined.

- Product direction: cards/fichas are planned for v1.1+ (`docs/brief.md` “Jerarquía (fichas/historias)”).
- State model in this repo today uses tasks with `available/claimed/completed`; card states should be derived from those.

## Testing
- Server: `make test`
- Client: `apps/client: gleam test`

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-14 | 0.1 | Planning stub created | po |

## Dev Agent Record

## QA Results
