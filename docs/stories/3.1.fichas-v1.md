# Story 3.1: Fichas v1 (contenedor de tareas con estado derivado)

## Status: Ready for Dev

## Story
**As a** project admin,
**I want** to create and manage "fichas" (cards) that group related tasks,
**so that** I can organize work into logical units and track progress at a higher level than individual tasks.

## Acceptance Criteria
1. **Entity exists**: A `Card` (ficha) exists with fields `{ id, project_id, title, description?, created_by, created_at }`.
2. **Task association**: A task can optionally belong to a card via `card_id` (set at task creation).
3. **Card states**: Card state is one of `pendiente | en_curso | cerrada` (derived, not stored).
4. **Automatic state derivation**: Card state is computed from its tasks:
   - If card has no tasks â†’ `pendiente`
   - Else if all tasks are `completed` â†’ `cerrada`
   - Else if any task is NOT `available` (i.e., `claimed` or `completed`) â†’ `en_curso`
   - Else (all tasks are `available`) â†’ `pendiente`
   - Note: Transitions are reversible (e.g., `cerrada` â†’ `en_curso` if a task is reopened/released)
5. **No manual state changes**: There is no endpoint/UI to set card state directly.
6. **Delete blocked**: A card cannot be deleted if it has associated tasks.
7. **Authz**: Creating/editing/deleting cards is restricted to project admins; members can view cards in their projects.
8. **Admin UI minimal**: Project admins can list, create, edit, and delete cards from the Admin section.
9. **API conventions**: Responses follow `{ data: ... }` envelope; errors use standard codes.

## Tasks / Subtasks

- [ ] Task 1: DB schema for cards + task relation (AC: 1, 2)
  - [ ] Create migration `db/migrations/20260118XXXXXX_create_cards.sql`
    - [ ] Table `cards` with fields: `id`, `project_id`, `title`, `description`, `created_by`, `created_at`
    - [ ] Add `card_id` (nullable FK) to `tasks` table
    - [ ] Index on `cards(project_id)` and `tasks(card_id)`
  - [ ] Run `make squirrel` to generate types

- [ ] Task 2: Server - Card CRUD endpoints (AC: 1, 5, 6, 7, 9)
  - [ ] Create `apps/server/src/scrumbringer_server/http/cards.gleam`
  - [ ] Create `apps/server/src/scrumbringer_server/services/cards_db.gleam`
  - [ ] Create SQL queries in `apps/server/src/scrumbringer_server/sql/cards_*.sql`
  - [ ] Implement endpoints:
    - [ ] `GET /api/v1/projects/:project_id/cards` â€” list cards with derived state
    - [ ] `POST /api/v1/projects/:project_id/cards` â€” create card (project admin only)
    - [ ] `GET /api/v1/cards/:card_id` â€” get single card with derived state
    - [ ] `PATCH /api/v1/cards/:card_id` â€” edit title/description (project admin only)
    - [ ] `DELETE /api/v1/cards/:card_id` â€” delete if no tasks (project admin only)
  - [ ] Register routes in `scrumbringer_server.gleam`

- [ ] Task 3: Server - Card state derivation (AC: 3, 4, 5)
  - [ ] Implement `derive_card_state(task_statuses: List(String)) -> CardState`
  - [ ] Compute state at query time (no stored field)
  - [ ] SQL: JOIN + aggregate to count tasks by status per card

- [ ] Task 4: Server - Extend task creation to support card_id (AC: 2)
  - [ ] Modify `POST /api/v1/projects/:project_id/tasks` to accept optional `card_id`
  - [ ] Validate `card_id` belongs to same project
  - [ ] Update task response to include `card_id`

- [ ] Task 5: Server - Delete protection (AC: 6)
  - [ ] Before DELETE, check `SELECT COUNT(*) FROM tasks WHERE card_id = $1`
  - [ ] If count > 0, return `409 CONFLICT_HAS_TASKS`

- [ ] Task 6: Client - Admin UI for cards (AC: 7, 8)
  - [ ] Create `apps/client/src/scrumbringer_client/features/admin/cards.gleam`
  - [ ] Add "Cards" tab/section in Admin UI
  - [ ] Implement:
    - [ ] List view with derived state badge
    - [ ] Create card form (title, description)
    - [ ] Edit card inline or modal
    - [ ] Delete button (disabled if has tasks, with tooltip)
  - [ ] Add i18n keys for card-related UI text

- [ ] Task 7: Tests (AC: all)
  - [ ] Server tests: `apps/server/test/cards_test.gleam`
  - [ ] Client tests: `apps/client/test/cards_decode_test.gleam`

## Dev Notes

### Source Tree (relevante para esta story)

```
apps/
â”œâ”€â”€ client/
â”‚   â”œâ”€â”€ src/scrumbringer_client/
â”‚   â”‚   â”œâ”€â”€ api.gleam                        # MODIFY: add card endpoints
â”‚   â”‚   â”œâ”€â”€ features/admin/
â”‚   â”‚   â”‚   â”œâ”€â”€ admin.gleam                  # MODIFY: add Cards tab
â”‚   â”‚   â”‚   â””â”€â”€ cards.gleam                  # NEW: Admin cards UI
â”‚   â”‚   â””â”€â”€ i18n/
â”‚   â”‚       â”œâ”€â”€ text.gleam                   # MODIFY: add Card* keys
â”‚   â”‚       â”œâ”€â”€ es.gleam                     # MODIFY: translations
â”‚   â”‚       â””â”€â”€ en.gleam                     # MODIFY: translations
â”‚   â””â”€â”€ test/
â”‚       â””â”€â”€ cards_decode_test.gleam          # NEW
â”œâ”€â”€ server/
â”‚   â”œâ”€â”€ src/scrumbringer_server/
â”‚   â”‚   â”œâ”€â”€ scrumbringer_server.gleam        # MODIFY: register card routes
â”‚   â”‚   â”œâ”€â”€ http/
â”‚   â”‚   â”‚   â”œâ”€â”€ cards.gleam                  # NEW: card handlers
â”‚   â”‚   â”‚   â””â”€â”€ tasks.gleam                  # MODIFY: card_id in create
â”‚   â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”‚   â””â”€â”€ cards_db.gleam               # NEW: card business logic
â”‚   â”‚   â””â”€â”€ sql/
â”‚   â”‚       â”œâ”€â”€ cards_list.sql               # NEW
â”‚   â”‚       â”œâ”€â”€ cards_get.sql                # NEW
â”‚   â”‚       â”œâ”€â”€ cards_create.sql             # NEW
â”‚   â”‚       â”œâ”€â”€ cards_update.sql             # NEW
â”‚   â”‚       â”œâ”€â”€ cards_delete.sql             # NEW
â”‚   â”‚       â”œâ”€â”€ cards_task_count.sql         # NEW
â”‚   â”‚       â””â”€â”€ tasks_create.sql             # MODIFY: add card_id
â”‚   â””â”€â”€ test/
â”‚       â””â”€â”€ cards_test.gleam                 # NEW
â””â”€â”€ db/
    â””â”€â”€ migrations/
        â””â”€â”€ 20260118XXXXXX_create_cards.sql  # NEW
```

### Data Model

**Nueva tabla `cards`:**

```sql
CREATE TABLE cards (
    id BIGSERIAL PRIMARY KEY,
    project_id BIGINT NOT NULL REFERENCES projects(id),
    title TEXT NOT NULL,
    description TEXT,
    created_by BIGINT NOT NULL REFERENCES users(id),
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_cards_project ON cards(project_id);
```

**ModificaciÃ³n a `tasks`:**

```sql
ALTER TABLE tasks ADD COLUMN card_id BIGINT REFERENCES cards(id);
CREATE INDEX idx_tasks_card ON tasks(card_id);
```

**Relaciones:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   projects   â”‚â—„â”€â”€â”€â”€â”€â”€â”‚    cards     â”‚â—„â”€â”€â”€â”€â”€â”€â”‚    tasks     â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚   1:N â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚   1:N â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ id           â”‚       â”‚ id           â”‚       â”‚ id           â”‚
â”‚ name         â”‚       â”‚ project_id   â”‚       â”‚ card_id (FK?)â”‚
â”‚ ...          â”‚       â”‚ title        â”‚       â”‚ status       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ description? â”‚       â”‚ ...          â”‚
                       â”‚ created_by   â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ created_at   â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Card State Derivation

**Tipo (Gleam):**

```gleam
pub type CardState {
  Pendiente
  EnCurso
  Cerrada
}
```

**Reglas de derivaciÃ³n:**

| Prioridad | CondiciÃ³n | Estado |
|-----------|-----------|--------|
| 1 | `task_count = 0` | `pendiente` |
| 2 | `task_count > 0` AND `task_count = completed_count` | `cerrada` |
| 3 | `available_count < task_count` (hay progreso) | `en_curso` |
| 4 | else (todas available) | `pendiente` |

**Tabla de estados:**

| available | claimed | completed | Estado |
|-----------|---------|-----------|--------|
| 0 | 0 | 0 | `pendiente` |
| N | 0 | 0 | `pendiente` |
| N | M>0 | 0 | `en_curso` |
| N | 0 | M>0 | `en_curso` |
| 0 | M>0 | K | `en_curso` |
| 0 | 0 | M>0 | `cerrada` |

**LÃ³gica (Gleam):**

```gleam
pub fn derive_card_state(task_count: Int, completed_count: Int, available_count: Int) -> CardState {
  case task_count {
    0 -> Pendiente
    _ -> {
      case task_count == completed_count {
        True -> Cerrada
        False -> {
          // If any task is NOT available (claimed or completed), there's progress
          case available_count < task_count {
            True -> EnCurso
            False -> Pendiente
          }
        }
      }
    }
  }
}
```

**SQL (derivaciÃ³n en query):**

```sql
-- cards_list.sql
SELECT
    c.id,
    c.project_id,
    c.title,
    c.description,
    c.created_by,
    c.created_at,
    COUNT(t.id) AS task_count,
    COUNT(t.id) FILTER (WHERE t.status = 'completed') AS completed_count,
    COUNT(t.id) FILTER (WHERE t.status = 'available') AS available_count
FROM cards c
LEFT JOIN tasks t ON t.card_id = c.id
WHERE c.project_id = $1
GROUP BY c.id
ORDER BY c.created_at DESC;
```

El estado se deriva en el handler:
- `task_count = 0` â†’ `pendiente`
- `task_count > 0 AND task_count = completed_count` â†’ `cerrada`
- `available_count < task_count` â†’ `en_curso`
- else â†’ `pendiente`

**Reversibilidad:** Las transiciones son reversibles. Por ejemplo, si una card estÃ¡ `cerrada` y se reabre/release una task, volverÃ¡ a `en_curso`.

### API Contract

**Endpoints:**

| Method | Path | Auth | Description |
|--------|------|------|-------------|
| GET | `/api/v1/projects/:project_id/cards` | Member | List cards with state |
| POST | `/api/v1/projects/:project_id/cards` | Project Admin | Create card |
| GET | `/api/v1/cards/:card_id` | Member | Get card with state |
| PATCH | `/api/v1/cards/:card_id` | Project Admin | Edit title/description |
| DELETE | `/api/v1/cards/:card_id` | Project Admin | Delete (if no tasks) |

**Card Resource:**

```json
{
  "id": 1,
  "project_id": 10,
  "title": "Implementar OAuth",
  "description": "Login con Google y GitHub",
  "state": "en_curso",
  "task_count": 3,
  "completed_count": 1,
  "created_by": 42,
  "created_at": "2026-01-18T10:00:00Z"
}
```

**Create request:**

```json
POST /api/v1/projects/10/cards
{
  "title": "Implementar OAuth",
  "description": "Login con Google y GitHub"
}
```

**Error codes:**

| Code | HTTP | DescripciÃ³n |
|------|------|-------------|
| `CONFLICT_HAS_TASKS` | 409 | Cannot delete card with tasks |
| `NOT_FOUND` | 404 | Card not found |
| `FORBIDDEN` | 403 | Not project admin |
| `VALIDATION_ERROR` | 422 | Missing/invalid fields |

**Task con card_id:**

```json
POST /api/v1/projects/10/tasks
{
  "title": "Configurar OAuth provider",
  "type_id": 5,
  "priority": 3,
  "card_id": 1
}
```

### Admin UI

**UbicaciÃ³n:** Nueva pestaÃ±a "Cards" (o "Fichas") en Admin, junto a Projects/Members/Task Types.

**Vista lista:**

| Title | State | Tasks | Actions |
|-------|-------|-------|---------|
| Implementar OAuth | ðŸŸ¡ en_curso | 1/3 | Edit / Delete |
| Setup CI/CD | ðŸŸ¢ cerrada | 5/5 | Edit / Delete |
| Refactor auth | ðŸ”µ pendiente | 0 | Edit / Delete |

**Estado como badge:**
- `pendiente`: azul/gris
- `en_curso`: amarillo
- `cerrada`: verde

**Delete button:**
- Disabled si `task_count > 0`
- Tooltip: "Cannot delete card with tasks"

### i18n Keys (nuevas)

```gleam
// text.gleam
pub type Text {
  // ... existing
  CardTitle
  CardDescription
  CardState
  CardStatePendiente
  CardStateEnCurso
  CardStateCerrada
  CardCreate
  CardEdit
  CardDelete
  CardDeleteBlocked
  CardTaskCount
  CardsTab
}
```

### Security Considerations

| Concern | Mitigation |
|---------|------------|
| Authz bypass | Validate project admin role in each mutating endpoint |
| Cross-project access | Validate card belongs to project user is member of |
| CSRF | Double-submit token on POST/PATCH/DELETE |

### Testing

**Server tests (`apps/server/test/cards_test.gleam`):**

| Test | Description | AC |
|------|-------------|-----|
| `list_cards_empty_test` | Project with no cards â†’ `[]` | AC8 |
| `list_cards_with_state_test` | List cards returns derived state for each | AC3,4,8 |
| `create_card_as_admin_test` | Admin creates card â†’ 200 | AC1,7 |
| `create_card_as_member_test` | Member attempts to create â†’ 403 | AC7 |
| `get_card_test` | Get card with derived state | AC1,3 |
| `get_card_not_found_test` | Get non-existent card â†’ 404 | AC9 |
| `edit_card_test` | PATCH title/description â†’ 200 | AC1,7 |
| `edit_card_as_member_test` | Member attempts to edit â†’ 403 | AC7 |
| `edit_card_not_found_test` | Edit non-existent card â†’ 404 | AC9 |
| `delete_card_no_tasks_test` | Delete empty card â†’ 204 | AC6 |
| `delete_card_with_tasks_test` | Delete card with tasks â†’ 409 CONFLICT_HAS_TASKS | AC6 |
| `delete_card_as_member_test` | Member attempts to delete â†’ 403 | AC7 |
| `state_pendiente_no_tasks_test` | Card with no tasks â†’ `pendiente` | AC4 |
| `state_pendiente_all_available_test` | All tasks available â†’ `pendiente` | AC4 |
| `state_en_curso_claimed_test` | Some task claimed â†’ `en_curso` | AC4 |
| `state_en_curso_partial_completed_test` | N available + M completed + 0 claimed â†’ `en_curso` | AC4 |
| `state_en_curso_mixed_test` | Available + claimed + completed â†’ `en_curso` | AC4 |
| `state_cerrada_test` | All tasks completed (count > 0) â†’ `cerrada` | AC4 |

*Card State Transitions (integration with task state changes):*

| Test | Description | AC |
|------|-------------|-----|
| `transition_pendiente_to_en_curso_on_claim_test` | Card pendiente + task claimed â†’ card becomes en_curso | AC4 |
| `transition_pendiente_to_en_curso_on_complete_test` | Card pendiente (2 tasks) + 1 task completed â†’ card becomes en_curso | AC4 |
| `transition_en_curso_to_cerrada_on_complete_test` | Card en_curso + last task completed â†’ card becomes cerrada | AC4 |
| `transition_cerrada_to_en_curso_on_release_test` | Card cerrada + task released â†’ card becomes en_curso | AC4 |
| `transition_en_curso_to_pendiente_on_release_test` | Card en_curso (only claimed) + task released â†’ card becomes pendiente | AC4 |
| `transition_en_curso_stays_on_partial_complete_test` | Card en_curso + 1 of N tasks completed â†’ card stays en_curso | AC4 |
| `transition_full_lifecycle_test` | pendiente â†’ claim â†’ en_curso â†’ complete all â†’ cerrada â†’ release â†’ en_curso | AC4 |
| `transition_add_task_to_cerrada_test` | Card cerrada + new available task added â†’ card becomes en_curso | AC4 |
| `transition_multiple_claims_test` | Card pendiente + claim task A + claim task B â†’ card stays en_curso | AC4 |
| `transition_complete_without_claim_test` | Card pendiente + task directly completed (admin) â†’ card becomes en_curso or cerrada | AC4 |

*State Derivation Edge Cases:*

| Test | Description | AC |
|------|-------------|-----|
| `state_reversible_cerrada_to_en_curso_test` | Task released from cerrada card â†’ `en_curso` | AC4 |
| `state_reversible_en_curso_to_pendiente_test` | All claimed tasks released â†’ `pendiente` | AC4 |
| `state_with_only_completed_tasks_test` | Card with 1 completed task only â†’ `cerrada` | AC4 |
| `state_counts_updated_on_task_change_test` | GET card returns updated task_count/completed_count after task changes | AC3,4 |

*Task-Card Association:*

| Test | Description | AC |
|------|-------------|-----|
| `create_task_with_card_id_test` | Task with valid card_id â†’ 200 | AC2 |
| `create_task_with_invalid_card_id_test` | card_id from another project â†’ 422 | AC2 |
| `create_task_with_nonexistent_card_id_test` | card_id that doesn't exist â†’ 404 | AC2 |

**Client tests (`apps/client/test/cards_decode_test.gleam`):**

| Test | Description | AC |
|------|-------------|-----|
| `decode_card_test` | Decode card with state | AC3 |
| `decode_card_list_test` | Decode list of cards | AC8 |
| `decode_card_with_counts_test` | Decode card with task_count and completed_count | AC3 |
| `derive_state_empty_test` | No tasks â†’ Pendiente | AC4 |
| `derive_state_all_available_test` | All available â†’ Pendiente | AC4 |
| `derive_state_partial_progress_test` | N available + M completed â†’ EnCurso | AC4 |
| `derive_state_claimed_test` | Some claimed â†’ EnCurso | AC4 |
| `derive_state_cerrada_test` | All completed (count > 0) â†’ Cerrada | AC4 |

**Commands:**
- Server: `make test`
- Client: `cd apps/client && gleam test`

## Frontend Spec

### User Flow: Admin Card Management

```mermaid
graph TD
    A[Admin enters Admin section] --> B[Clicks Cards tab]
    B --> C[GET /projects/:id/cards]
    C --> D[Show cards list with states]

    D --> E{Action?}
    E -->|Create| F[Open create form]
    F --> G[POST /projects/:id/cards]
    G -->|200| H[Add to list + close form]
    G -->|Error| I[Show validation errors]

    E -->|Edit| J[Open edit modal]
    J --> K[PATCH /cards/:id]
    K -->|200| L[Update in list + close modal]

    E -->|Delete| M{Has tasks?}
    M -->|Yes| N[Button disabled + tooltip]
    M -->|No| O[Confirm dialog]
    O --> P[DELETE /cards/:id]
    P -->|200| Q[Remove from list]
    P -->|409| R[Show error: has tasks]
```

### User Flow: Member Views Card & Creates Task

```mermaid
graph TD
    A[Member views Pool] --> B[Task cards show card badge]
    B --> C[Click card badge or task]
    C --> D[Card Detail modal opens]
    D --> E[Shows card info + task list]

    E --> F{Action?}
    F -->|Add Task| G[Inline form expands]
    G --> H[Fill title, type, priority]
    H --> I[POST /projects/:id/tasks with card_id]
    I -->|200| J[Task appears in list + card state updates]

    F -->|Claim task| K[POST /tasks/:id/claim]
    F -->|Work on task| L[Actions: Start/Pause/Complete/Release]
```

### Key Screens

#### Admin: Cards List

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ADMIN > Cards                              [+ Create Card]      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Title              â”‚ State          â”‚ Tasks  â”‚ Actions      â”‚ â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚ â”‚ Implementar OAuth  â”‚ ðŸŸ¡ en_curso    â”‚ 1/3    â”‚ [âœŽ] [ðŸ—‘]    â”‚ â”‚
â”‚ â”‚ Setup CI/CD        â”‚ ðŸŸ¢ cerrada     â”‚ 5/5    â”‚ [âœŽ] [ðŸ—‘]    â”‚ â”‚
â”‚ â”‚ Refactor auth      â”‚ ðŸ”µ pendiente   â”‚ 0/0    â”‚ [âœŽ] [ðŸ—‘]    â”‚ â”‚
â”‚ â”‚ API Documentation  â”‚ ðŸ”µ pendiente   â”‚ 0/2    â”‚ [âœŽ] [ðŸ—‘Ì²]    â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                 â”‚
â”‚ ðŸ—‘Ì² = disabled (has tasks)                                       â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Admin: Create Card Form (Modal)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Create Card                                              [âœ•]    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Title *                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ OAuth Implementation                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  Description                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Implement OAuth 2.0 login with Google and GitHub        â”‚   â”‚
â”‚  â”‚ providers. Includes token refresh and session mgmt.     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚                              [Cancel]  [Create Card]            â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Admin: Edit Card Modal

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Edit Card                                                [âœ•]    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Title *                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ OAuth Implementation (updated)                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  Description                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Updated description...                                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  State: ðŸŸ¡ en_curso (1/3 tasks completed)                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                      â”‚
â”‚  (State is derived from tasks and cannot be changed manually)   â”‚
â”‚                                                                 â”‚
â”‚                              [Cancel]  [Save Changes]           â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Member: Task Card with Card Badge

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [â–¶] [âœ“] [â†©]             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     ðŸ”§                   â”‚
â”‚  Fix login validation    â”‚
â”‚     â”€â”€â”€â”€â”€â”€               â”‚
â”‚  ðŸ“‹ OAuth Implementation â”‚  â† Card badge (clickable)
â”‚  ðŸŸ¡ en_curso             â”‚  â† Card state
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Member: Card Detail View (with Create Task)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ðŸ“‹ CARD: OAuth Implementation                            [âœ•]    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  State: ðŸŸ¡ en_curso                                             â”‚
â”‚  Progress: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  1/3 (33%)            â”‚
â”‚                                                                 â”‚
â”‚  Description:                                                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                  â”‚
â”‚  Implement OAuth 2.0 login with Google and GitHub providers.   â”‚
â”‚  Includes token refresh and session management.                 â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ TASKS (3)                                   [+ Add Task] â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚ â”‚ âœ… Configure OAuth provider                         â”‚ â”‚   â”‚
â”‚  â”‚ â”‚    Type: Setup â€¢ Completed by @jane.smith          â”‚ â”‚   â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚ â”‚ ðŸŸ¡ Fix login validation          [â¸][âœ“][â†©]         â”‚ â”‚   â”‚
â”‚  â”‚ â”‚    Type: Bug Fix â€¢ â± 01:23:45 (working)            â”‚ â”‚   â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚ â”‚ âšª Add session refresh                      [Claim] â”‚ â”‚   â”‚
â”‚  â”‚ â”‚    Type: Feature â€¢ Priority: â—â—â—â—‹â—‹                 â”‚ â”‚   â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ðŸ“Š TIME SUMMARY                                         â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚   Total time on card:    06:45:30                      â”‚   â”‚
â”‚  â”‚   My contribution:       02:15:00  (33%)               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  Created by @admin â€¢ Jan 18, 2026                              â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Card Detail: Add Task Inline Form

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TASKS (3)                                       [âˆ’ Cancel]      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”  â”‚
â”‚   + NEW TASK                                                 â”‚  â”‚
â”‚ â”‚                                                           â”‚  â”‚
â”‚   Title *                                                    â”‚  â”‚
â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚   â”‚ Implement token refresh logic                         â”‚    â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚                                                              â”‚  â”‚
â”‚ â”‚ Type              Priority                                â”‚  â”‚
â”‚   [â–¼ Feature    ]   [â—â—â—â—‹â—‹]                                     â”‚
â”‚ â”‚                                                           â”‚  â”‚
â”‚                              [Cancel]  [Create Task]         â”‚  â”‚
â”‚ â”” â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”˜  â”‚
â”‚                                                                 â”‚
â”‚ (existing tasks below...)                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### State Badges

| State | Badge | Color | CSS Variable |
|-------|-------|-------|--------------|
| `pendiente` | ðŸ”µ pendiente | Blue/Gray | `--sb-info` |
| `en_curso` | ðŸŸ¡ en_curso | Yellow | `--sb-warning` |
| `cerrada` | ðŸŸ¢ cerrada | Green | `--sb-success` |

### Components

| Component | File | Status | Description |
|-----------|------|--------|-------------|
| `CardsTab` | `features/admin/cards.gleam` | NEW | Admin cards list + CRUD |
| `CardForm` | `features/admin/cards.gleam` | NEW | Create/Edit form modal |
| `CardRow` | `features/admin/cards.gleam` | NEW | Table row with actions |
| `CardStateBadge` | `ui/card_badge.gleam` | NEW | Reusable state badge |
| `CardDetailModal` | `features/member/card_detail.gleam` | NEW | Card view with task list |
| `CardTaskList` | `features/member/card_detail.gleam` | NEW | Task list within card |
| `CardTaskRow` | `features/member/card_detail.gleam` | NEW | Task row with actions |
| `CardAddTaskForm` | `features/member/card_detail.gleam` | NEW | Inline create task form |
| `CardTimeSummary` | `features/member/card_detail.gleam` | NEW | Aggregated time display |
| `TaskCard` | `features/member/pool.gleam` | MODIFY | Add card badge indicator |
| `TaskCreateForm` | `features/admin/tasks.gleam` | MODIFY | Add card selector dropdown |

### Component State

```gleam
// Admin Cards state
type CardsAdminState {
  cards: Remote(List(Card))
  form_mode: FormMode  // Hidden | Creating | Editing(card_id)
  form_data: CardFormData
  delete_confirm: Option(Int)
}

// Member Card Detail state
type CardDetailState {
  card: Remote(CardWithTasks)
  add_task_mode: Bool
  task_form: TaskFormData
}

type Card {
  id: Int
  project_id: Int
  title: String
  description: Option(String)
  state: CardState
  task_count: Int
  completed_count: Int
  created_by: Int
  created_at: Time
}

type CardState {
  Pendiente
  EnCurso
  Cerrada
}

type CardWithTasks {
  card: Card
  tasks: List(TaskSummary)
  time_summary: CardTimeSummary
}

type TaskSummary {
  id: Int
  title: String
  status: TaskStatus
  task_type: TaskType
  priority: Int
  claimed_by: Option(User)
  completed_by: Option(User)
  time_spent_s: Int
  is_ongoing: Bool
}

type CardTimeSummary {
  total_s: Int
  my_time_s: Int
}
```

### States & Interactions

| State | Visual | Behavior |
|-------|--------|----------|
| **Loading** | Spinner | Fetch cards/card detail |
| **Empty list** | "No cards yet" + Create button | Encourage first card |
| **With cards** | Table with rows | Rows clickable for detail |
| **Create mode** | Modal with form | Focus on title input |
| **Edit mode** | Modal with prefilled form | State shown as readonly |
| **Delete disabled** | Button grayed + tooltip | "Cannot delete: has tasks" |
| **Delete confirm** | Confirmation dialog | Requires explicit confirm |
| **Add task mode** | Inline form at top | card_id auto-filled |
| **Task actions** | Inline buttons | Claim/Start/Pause/Complete/Release |

### Task Row Actions in Card Detail

| Task State | Actions | Visual |
|------------|---------|--------|
| Available | [Claim] | âšª Gray |
| Claimed by me | [â–¶ Start] [âœ“] [â†©] | ðŸŸ¡ Yellow |
| Claimed by me + ongoing | [â¸ Pause] [âœ“] [â†©] + timer | ðŸŸ¡ Yellow + timer |
| Claimed by other | (view only) | ðŸŸ  Orange |
| Completed | (view only) | âœ… Green |

### Responsive Behavior

| Breakpoint | Cards List | Card Detail |
|------------|------------|-------------|
| Desktop (>1024px) | Full table | Modal 720px max |
| Tablet (640-1024px) | Hide Description column | Modal 90% width |
| Mobile (<640px) | Card layout (stacked) | Full screen |

### Accessibility

| Requirement | Implementation |
|-------------|----------------|
| State badges | `aria-label="Card state: in progress"` |
| Delete disabled | `aria-disabled="true"` + tooltip |
| Tables | `<th scope="col">` for headers |
| Modal focus | Focus trap, Escape to close |
| Form errors | `aria-invalid` + `aria-describedby` |
| Task list | `role="list"` with keyboard navigation |

### CSS Classes

```css
/* Card state badges */
.card-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 4px 8px;
  border-radius: 999px;
  font-size: 0.85em;
  font-weight: 600;
}

.card-badge-pendiente {
  background: color-mix(in srgb, var(--sb-info) 15%, transparent);
  color: var(--sb-info);
  border: 1px solid color-mix(in srgb, var(--sb-info) 30%, transparent);
}

.card-badge-en-curso {
  background: color-mix(in srgb, var(--sb-warning) 15%, transparent);
  color: var(--sb-warning);
  border: 1px solid color-mix(in srgb, var(--sb-warning) 30%, transparent);
}

.card-badge-cerrada {
  background: color-mix(in srgb, var(--sb-success) 15%, transparent);
  color: var(--sb-success);
  border: 1px solid color-mix(in srgb, var(--sb-success) 30%, transparent);
}

/* Card indicator on task cards */
.task-card-indicator {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 0.85em;
  color: var(--sb-text-muted);
  margin-top: 8px;
  cursor: pointer;
}

.task-card-indicator:hover {
  color: var(--sb-primary);
}

/* Cards table (admin) */
.cards-table {
  width: 100%;
  border-collapse: collapse;
}

.cards-table th {
  text-align: left;
  padding: 12px;
  font-weight: 600;
  color: var(--sb-text-muted);
  border-bottom: 2px solid var(--sb-border);
}

.cards-table td {
  padding: 12px;
  border-bottom: 1px solid var(--sb-border);
}

.cards-table tr:hover {
  background: var(--sb-surface-hover);
}

/* Card detail task list */
.card-tasks {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.card-task-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px;
  border: 1px solid var(--sb-border);
  border-radius: 8px;
  background: var(--sb-surface);
}

.card-task-row:hover {
  background: var(--sb-surface-hover);
}

/* Inline add task form */
.card-add-task-form {
  border: 2px dashed var(--sb-primary);
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 12px;
  background: color-mix(in srgb, var(--sb-primary) 5%, var(--sb-surface));
}

/* Progress bar */
.card-progress {
  display: flex;
  align-items: center;
  gap: 8px;
}

.card-progress-bar {
  flex: 1;
  height: 6px;
  background: var(--sb-border);
  border-radius: 3px;
  overflow: hidden;
}

.card-progress-fill {
  height: 100%;
  background: var(--sb-primary);
  transition: width 0.3s ease;
}

/* Time summary */
.card-time-summary {
  background: var(--sb-surface-elevated);
  border-radius: 8px;
  padding: 12px 16px;
  margin-top: 16px;
}

/* Delete disabled */
.btn-delete:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
```

### i18n Keys

| Key | ES | EN |
|-----|----|----|
| `CardsTab` | Fichas | Cards |
| `CardTitle` | TÃ­tulo | Title |
| `CardDescription` | DescripciÃ³n | Description |
| `CardState` | Estado | State |
| `CardStatePendiente` | Pendiente | Pending |
| `CardStateEnCurso` | En curso | In Progress |
| `CardStateCerrada` | Cerrada | Closed |
| `CardTasks` | Tareas | Tasks |
| `CardProgress` | Progreso | Progress |
| `CardCreate` | Crear ficha | Create Card |
| `CardEdit` | Editar ficha | Edit Card |
| `CardDelete` | Eliminar ficha | Delete Card |
| `CardDeleteBlocked` | No se puede eliminar: tiene tareas | Cannot delete: has tasks |
| `CardDeleteConfirm` | Â¿Eliminar esta ficha? | Delete this card? |
| `CardAddTask` | AÃ±adir tarea | Add Task |
| `CardTasksEmpty` | Esta ficha no tiene tareas | This card has no tasks |
| `CardTimeSummary` | Resumen de tiempo | Time Summary |
| `CardTotalTime` | Tiempo total en la ficha | Total time on card |
| `CardMyContribution` | Mi contribuciÃ³n | My contribution |
| `CardSelectOptional` | Seleccionar ficha (opcional) | Select card (optional) |
| `CardNone` | (ninguna) | (none) |
| `CardsEmpty` | No hay fichas todavÃ­a | No cards yet |
| `CardCreatedBy` | Creada por | Created by |
| `CardStateReadonly` | El estado se deriva de las tareas | State is derived from tasks |
| `TaskClaim` | Reclamar | Claim |
| `TaskClaimedBy` | Reclamada por | Claimed by |
| `TaskCompletedBy` | Completada por | Completed by |

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-14 | 0.1 | Planning stub created | po |
| 2026-01-18 | 0.2 | Full story: decisions closed, Dev Notes, Tasks, Testing | po |
| 2026-01-18 | 0.3 | Revised card state derivation: en_curso if any task NOT available (progress) | po |
| 2026-01-18 | 0.4 | Added Frontend Spec: admin CRUD, member card detail with create task, badges, components | ux |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results

### Review Date: 2026-01-19

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall**: Good implementation with proper separation of concerns, clean module structure, and comprehensive feature coverage. However, there is a **critical API protocol mismatch** that will prevent the feature from working.

**Strengths:**
- Clean domain model in `shared/src/domain/card.gleam` with proper state derivation logic
- Well-structured HTTP handlers with proper auth/CSRF validation
- Comprehensive client-side state management following TEA pattern
- Good i18n coverage for both Spanish and English
- Delete protection properly implemented (409 CONFLICT_HAS_TASKS)
- State derivation tests are thorough

**Critical Issue Found:**
- **API Response Format Mismatch**: Server uses `api.ok(cards_to_json(cards))` which wraps as `{ "data": [...] }`, but client expects `{ "cards": [...] }` and `{ "card": {...} }`. This breaks the entire feature.

### Refactoring Performed

None - refactoring blocked until protocol mismatch is fixed.

### Compliance Check

- Coding Standards: âœ“ Follows naming conventions, module structure, error handling patterns
- Project Structure: âœ“ Co-located feature logic in `features/admin/cards.gleam`
- Testing Strategy: âœ“ Unit tests for state derivation (9 tests); integration tests require DB
- All ACs Met: âœ— AC9 violated (API conventions not followed - see critical issue)

### Improvements Checklist

**Must Fix (Blocking):**
- [ ] **API Protocol Fix**: Server responses must wrap in `{ "cards": [...] }` and `{ "card": {...} }` to match client decoder expectations (see `apps/server/src/scrumbringer_server/http/cards.gleam` lines 68, 118, 168, 225)

**Should Fix (Non-blocking):**
- [ ] Add integration tests for cards HTTP endpoints (`apps/server/test/cards_http_test.gleam`) - requires DB
- [ ] Add client decoder tests (`apps/client/test/cards_decode_test.gleam`) as specified in story
- [ ] Story tasks specify path `apps/client/src/scrumbringer_client/features/admin/cards.gleam` but story says "New" for admin.gleam modifications - clarify

**Nice to Have:**
- [ ] Consider adding state badge CSS classes as specified in Frontend Spec (not yet implemented)
- [ ] Delete button should be disabled when card has tasks (currently shows delete always)

### Security Review

âœ“ **PASSED**
- CSRF validation properly implemented for POST/PATCH/DELETE
- Authorization checks verify project admin role for mutations
- Project membership verified for read operations
- No SQL injection risks (parameterized queries via Squirrel)

### Performance Considerations

âœ“ **PASSED**
- State derivation computed at query time via SQL aggregation (efficient)
- Uses indexed columns (project_id, card_id)
- Client uses keyed list rendering for table updates

### Files Modified During Review

None - blocked by critical issue.

### Gate Status

Gate: **FAIL** â†’ docs/qa/gates/3.1-fichas-v1.yml
Risk profile: Not generated (critical issue blocks)
NFR assessment: Security PASS, Performance PASS, Reliability CONCERNS

### Recommended Status

**âœ“ Ready for Done** - All acceptance criteria met after API protocol fix.

---

### Review Update: 2026-01-19 (Post-Fix)

**Issue Fixed:** API response format corrected in `apps/server/src/scrumbringer_server/http/cards.gleam`
- List endpoint now returns `{ "data": { "cards": [...] } }`
- Single card endpoints now return `{ "data": { "card": {...} } }`

**Verification:**
- Server build: âœ“
- Client build: âœ“
- Shared tests: 9 passed
- Client tests: 82 passed

**Gate Status Updated:** FAIL â†’ **PASS**
