# Story 1.1: Bootstrap + Auth

## Status
Ready for Done

## Story
**As a** new organization admin,
**I want** to register and authenticate securely (bootstrap on first registration),
**so that** I can access ScrumBringer and start inviting my team.

## Acceptance Criteria
1. **Bootstrap registration (first ever user)**: If no organization exists yet, `POST /api/v1/auth/register` with body `{ email, password, org_name }`:
   - creates the single organization,
   - creates a default project named `Default`,
   - creates the user with `org_role = "admin"`,
   - adds the user to the `Default` project as project admin,
   - responds `200` with `{ data: { user } }`.
2. **Invite-only registration (after bootstrap)**: If the organization already exists, `POST /api/v1/auth/register` with body `{ email, password, invite_code }`:
   - requires `invite_code` (missing invite is rejected with error code `INVITE_REQUIRED`),
   - rejects invalid/expired/used invite codes with error codes `INVITE_INVALID`, `INVITE_EXPIRED`, `INVITE_USED` respectively,
   - on success responds `200` with `{ data: { user } }`.
3. **Login sets cookies**: `POST /api/v1/auth/login` with body `{ email, password }` responds `200` with `{ data: { user } }` and sets cookies:
   - `sb_session` (JWT): `HttpOnly; Secure; SameSite=Strict; Path=/`
   - `sb_csrf`: **not** HttpOnly; `Secure; SameSite=Strict; Path=/`
4. **Register sets cookies**: A successful `POST /api/v1/auth/register` sets the same `sb_session` and `sb_csrf` cookies as login.
5. **Me endpoint**: `GET /api/v1/auth/me`:
   - when authenticated returns `200` `{ data: { user } }`,
   - when not authenticated returns `401` with error code `AUTH_REQUIRED`.
6. **Logout**: `POST /api/v1/auth/logout`:
   - requires authentication,
   - returns `204` and clears auth cookies.
7. **CSRF double-submit for authenticated mutations**: For any authenticated mutating request (`POST`, `PUT`, `PATCH`, `DELETE`) the server validates the double-submit token:
   - header `X-CSRF` must equal cookie `sb_csrf`,
   - if missing/mismatch, the request is rejected (non-2xx) and the mutation does not occur.
8. **No email verification (MVP)**: There is no email verification flow in MVP.

## Tasks / Subtasks
- [x] Implement bootstrap + invite-only registration logic (AC: 1, 2, 4)
  - [x] Detect “no org exists yet” condition and bootstrap org + `Default` project atomically (AC: 1)
  - [x] Enforce invite required/invalid/expired/used for non-bootstrap registration (AC: 2)
- [x] Implement session cookies and auth endpoints (AC: 3, 4, 5, 6)
  - [x] `POST /api/v1/auth/login` sets cookies and returns `{ data: { user } }` (AC: 3)
  - [x] `POST /api/v1/auth/register` sets cookies and returns `{ data: { user } }` (AC: 4)
  - [x] `GET /api/v1/auth/me` uses `sb_session` and returns `AUTH_REQUIRED` on missing/invalid session (AC: 5)
  - [x] `POST /api/v1/auth/logout` clears cookies (AC: 6)
- [x] Implement CSRF validation middleware for authenticated mutating endpoints (AC: 7)
  - [x] Validate `X-CSRF` header equals `sb_csrf` cookie (AC: 7)
  - [x] Add at least one protected mutating endpoint test to prove CSRF rejection prevents mutation (AC: 7)
- [x] Add tests for auth flows and error codes (AC: 1, 2, 3, 5, 6, 7)
  - [x] Bootstrap happy path creates org + `Default` project + memberships (AC: 1)
  - [x] Register after bootstrap rejects missing invite (`INVITE_REQUIRED`) (AC: 2)
  - [x] Register rejects invalid/expired/used invites with corresponding `INVITE_*` codes (AC: 2)
  - [x] Login sets both cookies with expected flags (AC: 3)
  - [x] Logout clears cookies (AC: 6)

## Dev Notes
Source of truth:
- API contract (endpoints, cookies, CSRF): `docs/architecture/api-contract.md` (see “Auth & Security”, “Auth”, “Bootstrap rules”) 
- Data model (tables): `docs/architecture/data-model.md` (see “Organization”, “User”, “Project”, “ProjectMember”, “OrgInvite”)
- Architecture (stack + hashing choice): `docs/architecture.md` (see “Key Decisions → Auth”) 

Bootstrap rules (MVP):
- The system has a **single organization**.
- The **first registered user** bootstraps the org and becomes **org admin**.
- On bootstrap, create a default project named `Default` and add the user as project admin. 
  [Source: `docs/architecture/api-contract.md` “Bootstrap rules (MVP)”]

Auth cookies + CSRF (MVP):
- Cookies:
  - `sb_session` (JWT): `HttpOnly; Secure; SameSite=Strict; Path=/`
  - `sb_csrf`: not HttpOnly; `Secure; SameSite=Strict; Path=/`
  [Source: `docs/architecture/api-contract.md` “Cookies”]
- CSRF double-submit for mutating requests: compare `sb_csrf` cookie with `X-CSRF` header.
  [Source: `docs/architecture/api-contract.md` “CSRF (Double-submit)” ]

Data model reminders:
- `users.password_hash` is stored in DB. `org_role` is `member|admin`.
  [Source: `docs/architecture/data-model.md` “User”]
- Invites live in `org_invites` and are single-use in MVP.
  [Source: `docs/architecture/data-model.md` “OrgInvite”]

### Testing
- Use `gleeunit` and follow conventions in `docs/architecture/coding-standards.md` (see “Testing”).
- Focus:
  - unit tests for auth validation and error code mapping,
  - handler/integration tests for `register/login/me/logout` including cookie + CSRF behaviors.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-12 | 1.0 | Initial draft | architect |
| 2026-01-12 | 1.1 | Refined story statement, acceptance criteria, tasks, dev notes, and testing focus aligned to API contract + data model | sm |
| 2026-01-12 | 1.2 | Implemented Gleam server auth + bootstrap, JWT+CSRF cookies, and test suite | dev |

## Dev Agent Record

### Agent Model Used
- GPT-5.2 (Codex CLI)

### Debug Log References
- `apps/server`: `../..//.tools/gleam-1.14.0/gleam update`
- `apps/server`: `../..//.tools/gleam-1.14.0/gleam test`

### Completion Notes List
- Implemented `/api/v1/auth/register`, `/api/v1/auth/login`, `/api/v1/auth/me`, `/api/v1/auth/logout` with JSON envelopes and error codes per `docs/architecture/api-contract.md`.
- Implemented bootstrap registration (org + `Default` project + org admin + project admin membership) and invite-only behavior after bootstrap.
- Implemented JWT HS256 session cookie (`sb_session`) and CSRF cookie (`sb_csrf`) with SameSite=Strict.
- Added CSRF double-submit validation on logout and test coverage for auth flows and error cases.
- Normalized server module layout under `apps/server/src/scrumbringer_server/` and updated tests to use `wisp/simulate`.

### File List
- `.tools/gleam-1.14.0/gleam`
- `apps/server/gleam.toml`
- `apps/server/manifest.toml`
- `apps/server/src/main.gleam`
- `apps/server/src/scrumbringer_server.gleam`
- `apps/server/src/scrumbringer_server/http/api.gleam`
- `apps/server/src/scrumbringer_server/http/auth.gleam`
- `apps/server/src/scrumbringer_server/http/csrf.gleam`
- `apps/server/src/scrumbringer_server/services/auth_logic.gleam`
- `apps/server/src/scrumbringer_server/services/jwt.gleam`
- `apps/server/src/scrumbringer_server/services/password.gleam`
- `apps/server/src/scrumbringer_server/services/store.gleam`
- `apps/server/src/scrumbringer_server/services/store_state.gleam`
- `apps/server/src/scrumbringer_server/services/time.gleam`
- `apps/server/test/auth_http_test.gleam`
- `packages/domain/gleam.toml`
- `packages/domain/src/scrumbringer_domain/org_role.gleam`
- `packages/domain/src/scrumbringer_domain/user.gleam`

## QA Results

### Review Date: 2026-01-12

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Implementation matches the story’s API contract and behaviors: bootstrap vs invite-only registration, JWT + CSRF cookies, `/me` auth gating, and CSRF validation on the authenticated mutation (`/logout`).

### Refactoring Performed

- `apps/server/src/scrumbringer_server/services/auth_logic.gleam`
  - Removed redundant record-update fields and an unused imported type.
- `apps/server/src/scrumbringer_server.gleam`
  - Removed an unused imported type.
- `apps/server/test/auth_http_test.gleam`
  - Added test coverage for register setting both auth cookies.

### Compliance Check

- Coding Standards: ✓ (tests green; warnings cleaned)
- Testing Strategy: ✓ (handler tests for auth + cookie/CSRF behaviors)
- All ACs Met: ✓

### Improvements Checklist

- [x] Add explicit test that `POST /api/v1/auth/register` sets `sb_session` and `sb_csrf` cookies (AC4).
- [x] Clean up minor Gleam warnings that could hide future issues.

### Security Review

- Session cookie uses `HttpOnly; Secure; SameSite=Strict; Path=/` and CSRF uses double-submit for the authenticated mutation.
- Password hashing uses Argon2.

### Files Modified During Review

- `apps/server/src/scrumbringer_server/services/auth_logic.gleam`
- `apps/server/src/scrumbringer_server.gleam`
- `apps/server/test/auth_http_test.gleam`

### Gate Status

Gate: PASS → docs/qa/gates/1.1-bootstrap-auth.yml

### Recommended Status

✓ Ready for Done

---

### Review Date: 2026-01-13

### Reviewed By: Quinn (Test Architect)

### Re-Verification
- Re-ran project tests using `make test` (server: 39 passed).
- Note: running `gleam test` directly in `apps/server` without `DATABASE_URL` can produce misleading failures; `make test` is the canonical command.

### Gate Status
Gate: PASS → docs/qa/gates/1.1-bootstrap-auth.yml
