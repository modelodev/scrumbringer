# Story 2.8: Now Working (estado personal + cronómetro + UX mobile sin Pool)

## Status: Done

## Story
**As a** user,
**I want** to mark exactly one of my claimed tasks as “Now Working” and see elapsed time,
**so that** I always know what I’m doing and how long I’ve been on it (across devices) without affecting the shared pool.

## Acceptance Criteria
1. **Estado personal, no global**: “Now Working” es estado personal del usuario y **no cambia** `tasks.status` ni afecta lo que ven otros usuarios.
2. **Una tarea activa global**: Un usuario puede tener **0 o 1** tarea activa (global, no por proyecto).
3. **Persistencia en servidor**: El estado se persiste en la DB y se recupera tras refresh y en otros dispositivos.
4. **Start / Pause (semántica simple)**:
   - `start/resume`: empieza una sesión activa para una tarea **claimed por el usuario**.
   - `pause`: termina la sesión activa y **limpia** la tarea activa (no hay “paused state” persistente).
5. **Reemplazo al cambiar**: Si el usuario hace `start` en otra tarea, la anterior deja de estar activa y la nueva pasa a activa.
6. **Cambio de proyecto limpia active**: Si el usuario cambia el proyecto activo en la UI, la sesión activa se limpia (equivalente a `pause`).
7. **Integración con Release/Complete**:
   - Si el usuario hace `release` o `complete` sobre la tarea activa, se limpia primero el estado personal y luego se ejecuta la acción.
8. **UI Desktop mínima**:
   - En la UI Member existe un HUD/panel “Now Working” visible (ubicación flexible) que muestra: título, cronómetro y acciones (start/pause, complete, release).
   - My Bar sigue siendo la vista completa para “mis tareas claimed” (lista).
9. **UX Mobile específica (sin Pool)**:
   - En pantallas pequeñas, **no se muestra el Pool**.
   - Si se navega a `/app/pool` en mobile, se redirige (replaceState) a `/app/my-bar`.
   - La UI mobile se centra en My Bar + Now Working: ver mis tareas claimed y ejecutar start/pause/complete/release.
10. **API nueva (contrato mínimo)**:
   - `GET /api/v1/me/active-task` → `200 { data: { active_task: ActiveTask | null, as_of: ISO8601 } }`
   - `POST /api/v1/me/active-task/start` (body: `{ task_id: Int }`) → `200` con el mismo payload.
   - `POST /api/v1/me/active-task/pause` → `200` con el mismo payload (`active_task: null`).
   - Si `task_id` no está claimed por el usuario, devolver `409` con `CONFLICT_CLAIMED` (alineado con `docs/architecture/api-contract.md`).
11. **Tests**:
   - Server: start/pause/reemplazo, persistencia, y “pause-before-release/complete”.
   - Client: decode del payload + wiring de requests (incluyendo CSRF en POSTs).

## Tasks / Subtasks
- [x] Task 1: Modelo y migración DB (AC: 2, 3)
  - [x] Añadir tabla para estado personal (p.ej. `user_now_working`) con:
    - [x] `user_id` (unique)
    - [x] `task_id` (nullable)
    - [x] `project_id` (nullable)
    - [x] `started_at` (nullable)
    - [x] `updated_at`
- [x] Task 2: Servicios DB + lógica (AC: 2–7)
  - [x] `get_active_task(user_id)`
  - [x] `start_task(user_id, task_id)` (reemplaza cualquier active anterior)
  - [x] `pause_active(user_id)` (limpia `task_id/project_id/started_at`)
  - [x] Helper: `pause_if_active_task_matches(user_id, task_id)` para release/complete
- [x] Task 3: Endpoints HTTP (AC: 10)
  - [x] `GET /api/v1/me/active-task` (incluye `as_of`)
  - [x] `POST /api/v1/me/active-task/start`
  - [x] `POST /api/v1/me/active-task/pause`
- [x] Task 4: Integración con release/complete (AC: 7)
  - [x] Antes de release/complete, limpiar si la tarea es la activa.
- [x] Task 5: UI Desktop (AC: 8)
  - [x] Mostrar panel “Now Working” en UI Member (p.ej. en topbar o como panel colapsable).
  - [x] En My Bar, añadir acción “Start” por tarea claimed.
  - [x] Mostrar cronómetro como `as_of - started_at`.
  - [x] Al cambiar de proyecto en UI, ejecutar `pause` automáticamente.
- [x] Task 6: UX Mobile (AC: 9)
  - [x] En viewport pequeño, ocultar Pool y priorizar My Bar.
  - [x] Si se navega a `/app/pool` en mobile, redirigir a `/app/my-bar`.
  - [x] Asegurar que acciones de ejecución son accesibles sin overflow.
- [x] Task 7: Tests (AC: 11)
  - [x] Server: start/pause/reemplazo, persistencia, pause-before-release/complete, y `409 CONFLICT_CLAIMED` cuando no corresponde.
  - [x] Client: decode + requests wiring (mínimo) y redirección `/app/pool`→`/app/my-bar` en mobile.

## Dev Notes
### Source of truth
- Reglas MVP (Pool solo available, My Bar personal, mobile sin pool, Now Working persistido): `docs/brief.md`.

### Notes
- Now Working es deliberadamente **personal** y no se publica en el Pool.
- En mobile evitamos el canvas para mantener interacción simple y rápida.

## Testing
- Server: `make test`
- Client: `apps/client: gleam test`

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-14 | 1.0 | Initial draft | po |
| 2026-01-15 | 1.1 | Implement Now Working end-to-end | dev |
| 2026-01-15 | 1.2 | QA fixes: server-time timer + AC6 test + tick gating | dev |

## Dev Agent Record

### Agent Model Used
- OpenCode/Codex CLI (model provided by platform)

### Debug Log References
- `DATABASE_URL=postgres://scrumbringer:scrumbringer@localhost:5432/scrumbringer_test?sslmode=disable make verify`
- `cd apps/client && gleam test`
- `cd apps/server && gleam check`
- `cd apps/client && gleam run -m lustre/dev build`
- Smoke script: `scripts/smoke-active-task.sh`

### Completion Notes
- Added DB persistence for per-user active task (`user_now_working`) and server endpoints `GET/POST /api/v1/me/active-task*`.
- Enforced “pause-before-release/complete” cleanup for the active task.
- Added UI “Now Working” panel + Start/Pause in My Bar, plus mobile redirect `/app/pool` → `/app/my-bar`.
- QA fixes:
  - Timer uses server `as_of` baseline (offset from local clock) instead of raw device clock.
  - Tick runs only while needed (starts when a task becomes active; reschedules only while an active task exists).
  - Added unit test covering “project change triggers pause” decision logic.
  - Added server assertion that `as_of` is ISO8601 UTC.
- Added smoke script for manual API verification (`scripts/smoke-active-task.sh`).

### File List
- Modified: `apps/server/src/scrumbringer_server.gleam`
- Modified: `apps/server/src/scrumbringer_server/services/tasks_db.gleam`
- Added: `apps/server/src/scrumbringer_server/services/now_working_db.gleam`
- Added: `apps/server/src/scrumbringer_server/http/me_active_task.gleam`
- Modified: `apps/server/test/tasks_http_test.gleam`
- Added: `apps/client/test/now_working_project_change_test.gleam`
- Added: `db/migrations/20260114231500_create_user_now_working.sql`
- Modified: `apps/client/src/scrumbringer_client/router.gleam`
- Modified: `apps/client/src/scrumbringer_client/api.gleam`
- Modified: `apps/client/src/scrumbringer_client/hydration.gleam`
- Modified: `apps/client/src/scrumbringer_client.gleam`
- Modified: `apps/client/src/scrumbringer_client/styles.gleam`
- Modified: `apps/client/src/scrumbringer_client/client_ffi.gleam`
- Added: `apps/client/test/api_decode_active_task_test.gleam`
- Added: `scripts/smoke-active-task.sh`
- Modified: `apps/client/test/router_test.gleam`
- Modified: `apps/client/test/hydration_test.gleam`

## QA Results

### Review Date: 2026-01-15

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

- Backend change is well-scoped: dedicated persistence module (`apps/server/src/scrumbringer_server/services/now_working_db.gleam`) + dedicated HTTP handler (`apps/server/src/scrumbringer_server/http/me_active_task.gleam`).
- Client implementation is functional, but adds a lot of responsibility to `apps/client/src/scrumbringer_client.gleam` (state, effects, timer rendering, and mobile routing rules).

### Requirements Traceability (High Level)

- Server test coverage added for start/pause/replacement/409 + clear-before-release/complete in `apps/server/test/tasks_http_test.gleam`.
- Client coverage added for decoding the active-task payload in `apps/client/test/api_decode_active_task_test.gleam` and mobile redirect logic in `apps/client/test/router_test.gleam`.
- Coverage gaps remain for AC6 and most UI-level behaviors (see trace report).

### Notable Findings

1. **Timer baseline uses client clock rather than server `as_of`**
   - Why it matters: elapsed time can drift if device clock is skewed, even though the API provides server time.
   - Story alignment: AC8 explicitly notes timer as `as_of - started_at`.
   - Recommendation: compute baseline using `as_of` at fetch time, then tick forward from that baseline.

2. **Always-on 1-second tick effect**
   - The client schedules `NowWorkingTicked` continuously, even when there is no active task.
   - Recommendation: only schedule the tick while an active task exists (and/or only while on Member page).

3. **AC6 test gap (project change clears active)**
   - The code initiates `pause` on project change, but I didn’t find an automated test asserting this behavior.

### Compliance Check

- Coding Standards: ✓ (no obvious red flags spotted in reviewed files)
- Project Structure: ✓ (server/client changes land in expected locations)
- Testing Strategy: ⚠️ (good functional tests on server; some ACs still rely on manual verification)
- All ACs Met: ⚠️ (timer semantics + AC6 verification need follow-up or explicit waiver)

### Tests Re-run (QA)

- `make verify` (PASS)
- `apps/client: gleam test` (PASS)

### Refactoring Performed

- None.

### Files Modified During Review

- None.

### Gate Status

Gate: CONCERNS → docs/qa/gates/2.8-now-working-estado-personal-cronometro-ux-mobile-sin-pool.yml
Risk profile: docs/qa/assessments/2.8-risk-20260115.md
NFR assessment: docs/qa/assessments/2.8-nfr-20260115.md
Trace matrix: docs/qa/assessments/2.8-trace-20260115.md

### Recommended Status

✗ Changes Required - address timer baseline semantics (`as_of`) and add coverage for AC6 (or explicitly waive).

### Review Date: 2026-01-15

### Reviewed By: Quinn (Test Architect)

### Delta Since Last Gate

- ✅ Timer baseline now derives from server `as_of` via computed offset (`now_working_server_offset_ms`) and computes elapsed as server-time (`as_of`) minus `started_at`.
- ✅ Tick rescheduling is now gated: it only reschedules while an `active_task` exists.
- ✅ Added AC6 coverage for the project-change pause decision via `apps/client/test/now_working_project_change_test.gleam` and helper `scrumbringer_client.should_pause_active_task_on_project_change`.
- ✅ Added server test assertion that `as_of` is ISO8601 UTC in `apps/server/test/tasks_http_test.gleam`.

### Code Quality Assessment (Re-review)

- The previously flagged timer semantics (REQ-001) and `as_of` contract assertion (TEST-002) are resolved in code + tests.
- The AC6 behavioral intent is now protected by a focused unit test (decision logic), which meaningfully reduces regression risk.

### Remaining Finding (Recommended Follow-up)

- **Timer tick may not start when transitioning from no active task → active task**
  - Current behavior: a single 1s `NowWorkingTicked` is scheduled on Member page init; rescheduling only happens if an `active_task` exists at tick time.
  - Risk: if the user starts “Now Working” after the initial tick has already run while no task was active, the timer may not continue ticking until another message/event occurs.
  - Suggested fix: when `MemberActiveTaskStarted(Ok(...))` (and optionally `MemberActiveTaskFetched(Ok(...))` with `active_task: Some(_)`) transitions to active, schedule `now_working_tick_effect()` to ensure the tick loop begins.

### Compliance Check (Re-review)

- Coding Standards: ✓
- Project Structure: ✓
- Testing Strategy: ✓ (notably improved vs previous gate)
- All ACs Met: ⚠️ (see timer tick note above)

### Gate Status

Gate: CONCERNS → docs/qa/gates/2.8-now-working-estado-personal-cronometro-ux-mobile-sin-pool.yml

### Recommended Status

✗ Changes Required - small follow-up recommended on tick start behavior.

### Review Date: 2026-01-15

### Reviewed By: Quinn (Test Architect)

### Delta Since Last Gate

- ✅ Tick loop now starts when `active_task` transitions to `Some(_)` via `start_now_working_tick_if_needed`, and stops when cleared.
- ✅ Removed unconditional tick scheduling from init; tick is scheduled on `MemberActiveTaskFetched/Started` and rescheduled only while active.

### Tests Re-run (Reported)

- `make verify` (PASS)
- `apps/client: gleam test` (PASS)

### Code Quality Assessment (Re-review)

- The previously reported reliability/performance concern around the timer tick lifecycle is addressed with a clearer “start when active / stop when inactive” model.

### Refactoring Performed

- None.

### Files Modified During Review

- None.

### Gate Status

Gate: PASS → docs/qa/gates/2.8-now-working-estado-personal-cronometro-ux-mobile-sin-pool.yml

### Recommended Status

✓ Ready for Done

### Review Date: 2026-01-15

### Reviewed By: Quinn (Test Architect)

### Verification Performed

- Re-ran: `make verify` (PASS) and `apps/client: gleam test` (PASS).
- Reviewed current gate + key test evidence to confirm PASS still warranted.

### Requirements Traceability (Spot Check)

- AC2/3/4/5/7/10 (server API + semantics): `apps/server/test/tasks_http_test.gleam` (
  - `me_active_task_start_pause_and_persist_test`
  - `me_active_task_replaces_previous_on_start_test`
  - `me_active_task_start_returns_409_when_not_claimed_test`
  - `me_active_task_clears_before_release_and_complete_test`
  )
- AC6 (project change clears active): `apps/client/test/now_working_project_change_test.gleam`
- AC9 (mobile redirect /app/pool → /app/my-bar): `apps/client/test/router_test.gleam::mobile_redirects_pool_to_my_bar_test`
- AC10 (client decode contract for ActiveTaskPayload): `apps/client/test/api_decode_active_task_test.gleam`
- Remaining partial coverage (not blocking for MVP):
  - AC1: No explicit assertion that `tasks.status` is unchanged by start/pause.
  - AC8: UI panel behaviors are not asserted at UI level.

### NFR Assessment (Current)

- Security: PASS (auth required; CSRF enforced on POST; 409 when start on non-claimed task).
- Performance: PASS (tick loop runs only while an `active_task` exists).
- Reliability: PASS (`pause` before release/complete covered; `as_of` ISO8601 UTC asserted).
- Maintainability: PASS (follow-up modularization is optional; no critical complexity hotspots found beyond expected client orchestration).

### Verification Performed (Re-review)

- `make verify` (PASS)
- `cd apps/client && gleam test` (PASS)
- `npx playwright test tests/2.9-pool-visual-sweep.spec.ts --project=chromium` (PASS) — spot-check for Member UI regressions

### Gate Status

Gate: PASS → docs/qa/gates/2.8-now-working-estado-personal-cronometro-ux-mobile-sin-pool.yml

### Recommended Status

✓ Ready for Done
