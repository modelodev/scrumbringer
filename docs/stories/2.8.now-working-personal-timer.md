# Story 2.8: Now Working (estado personal + cronómetro + UX mobile sin Pool)

## Status: Draft

## Story
**As a** user,
**I want** to mark exactly one of my claimed tasks as “Now Working” and see elapsed time,
**so that** I always know what I’m doing and how long I’ve been on it (across devices) without affecting the shared pool.

## Acceptance Criteria
1. **Estado personal, no global**: “Now Working” es estado personal del usuario y **no cambia** `tasks.status` ni afecta lo que ven otros usuarios.
2. **Una tarea activa global**: Un usuario puede tener **0 o 1** tarea activa (global, no por proyecto).
3. **Persistencia en servidor**: El estado (tarea activa + tiempos) se persiste en la DB y se recupera tras refresh y en otros dispositivos.
4. **Start/Pause**:
   - El usuario puede `start/resume` una tarea claimed.
   - El usuario puede `pause` la tarea activa.
5. **Auto-pause al cambiar**: Si el usuario hace `start` en otra tarea, la activa anterior se pausa automáticamente (acumulando tiempo) y la nueva pasa a activa.
6. **Integración con Release/Complete**:
   - Si el usuario hace `release` o `complete` sobre la tarea activa, se pausa primero (persistiendo tiempo) y luego se ejecuta la acción.
7. **UI Desktop mínima**:
   - En la UI Member existe un HUD/panel “Now Working” visible (ubicación flexible) que muestra: título, cronómetro y acciones (start/pause, complete, release).
   - My Bar sigue siendo la vista completa para “mis tareas claimed” (lista).
8. **UX Mobile específica (sin Pool)**:
   - En pantallas pequeñas, **no se muestra el Pool**.
   - La UI mobile se centra en My Bar + Now Working: ver mis tareas claimed y ejecutar start/pause/complete/release.
9. **API nueva (contrato mínimo)**: existen endpoints autenticados para:
   - `GET /api/v1/me/active-task`
   - `POST /api/v1/me/active-task/start` (body: `{ task_id: Int }`)
   - `POST /api/v1/me/active-task/pause`
10. **Tests**:
   - Server: tests unit/integration para start/pause/autopause y persistencia.
   - Client: tests básicos de decode/render del estado (si aplica), y que las acciones disparan los requests correctos.

## Tasks / Subtasks
- [ ] Task 1: Modelo y migración DB (AC: 2, 3)
  - [ ] Añadir tabla para estado personal (p.ej. `user_active_task`) con:
    - [ ] `user_id` (unique)
    - [ ] `task_id` (nullable)
    - [ ] `started_at` (nullable)
    - [ ] `accumulated_seconds` (int, default 0)
    - [ ] `updated_at`
- [ ] Task 2: Servicios DB + lógica (AC: 2–6)
  - [ ] `get_active_task(user_id)`
  - [ ] `start_task(user_id, task_id)` (auto-pause anterior)
  - [ ] `pause_active(user_id)`
  - [ ] Helpers: `pause_if_active_task_matches(user_id, task_id)` para release/complete
- [ ] Task 3: Endpoints HTTP (AC: 9)
  - [ ] `GET /api/v1/me/active-task`
  - [ ] `POST /api/v1/me/active-task/start`
  - [ ] `POST /api/v1/me/active-task/pause`
- [ ] Task 4: Integración con release/complete (AC: 6)
  - [ ] Antes de release/complete, pausar si la tarea es la activa.
- [ ] Task 5: UI Desktop (AC: 7)
  - [ ] Mostrar panel “Now Working” en UI Member (p.ej. en topbar o como panel colapsable).
  - [ ] En My Bar, añadir acción “Start/Resume” por tarea claimed.
  - [ ] Mostrar cronómetro (derivado: `accumulated + (now-started_at)` si está running).
- [ ] Task 6: UX Mobile (AC: 8)
  - [ ] En viewport pequeño, ocultar Pool y priorizar My Bar.
  - [ ] Asegurar que acciones de ejecución son accesibles sin overflow.
- [ ] Task 7: Tests (AC: 10)
  - [ ] Server: start/pause/autopause, pause-before-release/complete.
  - [ ] Client: decode + requests wiring (mínimo).

## Dev Notes
### Source of truth
- Reglas MVP (Pool solo available, My Bar personal, mobile sin pool, Now Working persistido): `docs/brief.md`.

### Notes
- Now Working es deliberadamente **personal** y no se publica en el Pool.
- En mobile evitamos el canvas para mantener interacción simple y rápida.

## Testing
- Server: `make test`
- Client: `apps/client: gleam test`

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-14 | 1.0 | Initial draft | po |

## Dev Agent Record

## QA Results
