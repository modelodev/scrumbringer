# Story 2.8: Now Working (estado personal + cronómetro + UX mobile sin Pool)

## Status: Ready

## Story
**As a** user,
**I want** to mark exactly one of my claimed tasks as “Now Working” and see elapsed time,
**so that** I always know what I’m doing and how long I’ve been on it (across devices) without affecting the shared pool.

## Acceptance Criteria
1. **Estado personal, no global**: “Now Working” es estado personal del usuario y **no cambia** `tasks.status` ni afecta lo que ven otros usuarios.
2. **Una tarea activa global**: Un usuario puede tener **0 o 1** tarea activa (global, no por proyecto).
3. **Persistencia en servidor**: El estado se persiste en la DB y se recupera tras refresh y en otros dispositivos.
4. **Start / Pause (semántica simple)**:
   - `start/resume`: empieza una sesión activa para una tarea **claimed por el usuario**.
   - `pause`: termina la sesión activa y **limpia** la tarea activa (no hay “paused state” persistente).
5. **Reemplazo al cambiar**: Si el usuario hace `start` en otra tarea, la anterior deja de estar activa y la nueva pasa a activa.
6. **Cambio de proyecto limpia active**: Si el usuario cambia el proyecto activo en la UI, la sesión activa se limpia (equivalente a `pause`).
7. **Integración con Release/Complete**:
   - Si el usuario hace `release` o `complete` sobre la tarea activa, se limpia primero el estado personal y luego se ejecuta la acción.
8. **UI Desktop mínima**:
   - En la UI Member existe un HUD/panel “Now Working” visible (ubicación flexible) que muestra: título, cronómetro y acciones (start/pause, complete, release).
   - My Bar sigue siendo la vista completa para “mis tareas claimed” (lista).
9. **UX Mobile específica (sin Pool)**:
   - En pantallas pequeñas, **no se muestra el Pool**.
   - Si se navega a `/app/pool` en mobile, se redirige (replaceState) a `/app/my-bar`.
   - La UI mobile se centra en My Bar + Now Working: ver mis tareas claimed y ejecutar start/pause/complete/release.
10. **API nueva (contrato mínimo)**:
   - `GET /api/v1/me/active-task` → `200 { data: { active_task: ActiveTask | null, as_of: ISO8601 } }`
   - `POST /api/v1/me/active-task/start` (body: `{ task_id: Int }`) → `200` con el mismo payload.
   - `POST /api/v1/me/active-task/pause` → `200` con el mismo payload (`active_task: null`).
   - Si `task_id` no está claimed por el usuario, devolver `409` con `CONFLICT_CLAIMED` (alineado con `docs/architecture/api-contract.md`).
11. **Tests**:
   - Server: start/pause/reemplazo, persistencia, y “pause-before-release/complete”.
   - Client: decode del payload + wiring de requests (incluyendo CSRF en POSTs).

## Tasks / Subtasks
- [ ] Task 1: Modelo y migración DB (AC: 2, 3)
  - [ ] Añadir tabla para estado personal (p.ej. `user_now_working`) con:
    - [ ] `user_id` (unique)
    - [ ] `task_id` (nullable)
    - [ ] `project_id` (nullable)
    - [ ] `started_at` (nullable)
    - [ ] `updated_at`
- [ ] Task 2: Servicios DB + lógica (AC: 2–7)
  - [ ] `get_active_task(user_id)`
  - [ ] `start_task(user_id, task_id)` (reemplaza cualquier active anterior)
  - [ ] `pause_active(user_id)` (limpia `task_id/project_id/started_at`)
  - [ ] Helper: `pause_if_active_task_matches(user_id, task_id)` para release/complete
- [ ] Task 3: Endpoints HTTP (AC: 10)
  - [ ] `GET /api/v1/me/active-task` (incluye `as_of`)
  - [ ] `POST /api/v1/me/active-task/start`
  - [ ] `POST /api/v1/me/active-task/pause`
- [ ] Task 4: Integración con release/complete (AC: 7)
  - [ ] Antes de release/complete, limpiar si la tarea es la activa.
- [ ] Task 5: UI Desktop (AC: 8)
  - [ ] Mostrar panel “Now Working” en UI Member (p.ej. en topbar o como panel colapsable).
  - [ ] En My Bar, añadir acción “Start” por tarea claimed.
  - [ ] Mostrar cronómetro como `as_of - started_at`.
  - [ ] Al cambiar de proyecto en UI, ejecutar `pause` automáticamente.
- [ ] Task 6: UX Mobile (AC: 9)
  - [ ] En viewport pequeño, ocultar Pool y priorizar My Bar.
  - [ ] Si se navega a `/app/pool` en mobile, redirigir a `/app/my-bar`.
  - [ ] Asegurar que acciones de ejecución son accesibles sin overflow.
- [ ] Task 7: Tests (AC: 11)
  - [ ] Server: start/pause/reemplazo, persistencia, pause-before-release/complete, y `409 CONFLICT_CLAIMED` cuando no corresponde.
  - [ ] Client: decode + requests wiring (mínimo) y redirección `/app/pool`→`/app/my-bar` en mobile.

## Dev Notes
### Source of truth
- Reglas MVP (Pool solo available, My Bar personal, mobile sin pool, Now Working persistido): `docs/brief.md`.

### Notes
- Now Working es deliberadamente **personal** y no se publica en el Pool.
- En mobile evitamos el canvas para mantener interacción simple y rápida.

## Testing
- Server: `make test`
- Client: `apps/client: gleam test`

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-14 | 1.0 | Initial draft | po |

## Dev Agent Record

## QA Results
