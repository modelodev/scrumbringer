# Requirements Traceability Matrix

## Story: 2.1 - Invites por link (crear/listar/regenerar por email)

### Coverage Summary

- Total ACs: 12
- Fully Covered: 11
- Partially Covered: 1
- Not Covered: 0

### Mappings

#### AC1: Create invite link (POST /api/v1/org/invite-links)

- **Server**: `apps/server/test/org_invite_links_http_test.gleam::create_invalidates_previous_active_token_for_email_test`
  - Given: Authenticated org admin with valid CSRF
  - When: POST invite-links with email
  - Then: 200 and record created
- **Server**: `apps/server/test/org_invite_links_http_test.gleam::missing_csrf_is_rejected_for_create_and_regenerate_test`
  - Then: 403 when CSRF missing
- **Server**: `apps/server/test/org_invite_links_http_test.gleam::invalid_email_returns_422_test`
  - Then: 422 for invalid email

#### AC2: List invite links (GET /api/v1/org/invite-links) sorted by email

- **Server**: `apps/server/test/org_invite_links_http_test.gleam::list_sorted_by_email_asc_test`
  - Then: returned list is `email ASC`

#### AC3: Regenerate invite link (POST /api/v1/org/invite-links/regenerate)

- **Server**: `apps/server/test/org_invite_links_http_test.gleam::missing_csrf_is_rejected_for_create_and_regenerate_test`
  - Then: 403 when CSRF missing
- **Server**: `apps/server/test/org_invite_links_http_test.gleam::regenerate_creates_new_token_and_invalidates_previous_test`
  - Then: new token issued + previous invalidated

#### AC4: Single active token per email

- **Server**: `apps/server/test/org_invite_links_http_test.gleam::create_invalidates_previous_active_token_for_email_test`
- **Server**: `apps/server/test/org_invite_links_http_test.gleam::regenerate_creates_new_token_and_invalidates_previous_test`

#### AC5: No time expiry

- **Server**: `apps/server/test/org_invite_links_http_test.gleam::no_time_expiry_links_stay_active_test`

#### AC6: Observable token state (active|used|invalidated)

- **Server**: state field validated indirectly by response scanning and invalidation scenario
  - Partial: We assert invalidated is present in list but do not assert used state here.

#### AC7: No SMTP; return token + url_path; client composes usable link

- **Client decoder**: `apps/client/test/api_decode_invite_links_test.gleam`
- **UI behavior**: `apps/client/src/scrumbringer_client.gleam` composes `origin + url_path`.

#### AC8: URL format fixed (/accept-invite?token=...)

- **Code**: `apps/server/src/scrumbringer_server/services/org_invite_links_db.gleam::url_path`

#### AC9: Email normalization trim+lowercase

- **Code**: `apps/server/src/scrumbringer_server/http/org_invite_links.gleam::normalize_email`
- **Server test**: `apps/server/test/org_invite_links_http_test.gleam::create_invalidates_previous_active_token_for_email_test` queries normalized email.

#### AC10: Listing scope includes all states

- **Server**: `apps/server/test/org_invite_links_http_test.gleam::list_includes_invalidated_links_test`
  - Then: list includes invalidated links (partial coverage for used state).

#### AC11: Regenerate creates even if none exists

- Covered by implementation logic (same upsert path), but not explicitly tested.

#### AC12: Response conventions follow api-contract envelope

- All tests parse/scan for enveloped `data` fields and error codes.

### Coverage Gaps

- AC6/AC10: No test that `used` state is returned (consumption happens in Story 2.2).
- AC11: No explicit test for regenerate when no prior link exists.

Trace matrix: `docs/qa/assessments/2.1-trace-20260114.md`
