# Requirements Traceability Matrix

## Story: 2.4 - Reset password por link (sin email real)

### Coverage Summary

- Total ACs: 11
- Fully Covered: 8 (73%)
- Partially Covered: 3
- Not Covered: 0

### Requirement Mappings

#### AC1: Request reset token (public)

- **Integration Test**: `apps/server/test/password_resets_http_test.gleam::request_reset_does_not_leak_unknown_email_test`
  - Given: Known user email / unknown email
  - When: POST reset request
  - Then: 200 in both cases; unknown token not persisted

#### AC2: Single active token per email

- **Integration Test**: `apps/server/test/password_resets_http_test.gleam::request_reset_invalidates_previous_active_token_test`
  - Given: Existing active token
  - When: Request a new token for same email
  - Then: First token validates as `RESET_TOKEN_INVALID`, second validates

#### AC3: Tokens are single-use

- **Integration Test**: `apps/server/test/password_resets_http_test.gleam::reset_token_is_single_use_test`
  - Given: Active token
  - When: Consume once and then validate/consume again
  - Then: Subsequent calls return `RESET_TOKEN_USED`

#### AC4: Validate reset token (public)

- **Integration Test**: `apps/server/test/password_resets_http_test.gleam::request_reset_does_not_leak_unknown_email_test`
  - Given: Valid token
  - When: GET validate
  - Then: 200 and returns email

#### AC5: Consume reset token (public)

- **Integration Test**: `apps/server/test/password_resets_http_test.gleam::reset_token_is_single_use_test`
  - Given: Active token + valid password
  - When: POST consume
  - Then: 204 and token becomes used

#### AC6: Unknown email does not leak

- **Integration Test**: `apps/server/test/password_resets_http_test.gleam::request_reset_does_not_leak_unknown_email_test`
  - Given: Unknown email
  - When: POST request
  - Then: 200 but token not persisted; validate returns `RESET_TOKEN_INVALID`

#### AC7: Token TTL (24h)

- **Integration Test**: `apps/server/test/password_resets_http_test.gleam::validate_rejects_expired_tokens_test`
  - Given: Token with created_at older than 24h
  - When: GET validate
  - Then: `RESET_TOKEN_INVALID`

#### AC8: Error codes are consistent

- **Integration Test**: `apps/server/test/password_resets_http_test.gleam` (asserts presence of `RESET_TOKEN_INVALID` / `RESET_TOKEN_USED`)

#### AC9: Password policy (minimum 12)

- **Unit Test (client state machine)**: `apps/client/test/reset_password_test.gleam` (rejects <12 before calling consume)
- **Server enforcement exists** (422 on short password) but **missing direct server test** (partial coverage).

#### AC10: Client UX

- **Unit Test (client state machine)**: `apps/client/test/reset_password_test.gleam`
- **UI/Integration (manual)**: Login has “Forgot password?” toggle + link copy; `/reset-password?token=...` validates and submits.

#### AC11: No SMTP/email integration

- **Code inspection**: Server returns `url_path` only; client composes full URL. No mailer integration present.

Trace matrix: docs/qa/assessments/2.4-trace-20260114.md
